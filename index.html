<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Epstein Island ‚Äî Escape Game</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            height: 100dvh;
            font-family: 'Share Tech Mono', 'Courier New', monospace;
            overflow: hidden;
            cursor: none;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }

        #gameContainer {
            position: relative;
            width: 100vw;
            height: 100vh;
            height: 100dvh;
        }

        canvas { display: block; width: 100%; height: 100%; }

        /* ============== CUSTOM CURSOR ============== */
        #customCursor {
            position: fixed;
            width: 24px; height: 24px;
            pointer-events: none;
            z-index: 9999;
            mix-blend-mode: difference;
        }
        #customCursor::before {
            content: '';
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 6px; height: 6px;
            border: 2px solid #fff;
            border-radius: 50%;
        }
        #customCursor::after {
            content: '';
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 20px; height: 20px;
            border: 1px solid rgba(255,255,255,0.4);
            border-radius: 50%;
            animation: cursorPulse 1.5s ease-in-out infinite;
        }
        @keyframes cursorPulse {
            0%, 100% { transform: translate(-50%,-50%) scale(1); opacity: 0.4; }
            50% { transform: translate(-50%,-50%) scale(1.3); opacity: 0.1; }
        }

        /* ============== HUD ============== */
        #ui {
            position: absolute;
            top: 0; left: 0; right: 0;
            padding: 15px 20px;
            color: #fff;
            font-size: 13px;
            pointer-events: none;
            z-index: 5;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        #hudLeft { display: flex; flex-direction: column; gap: 6px; }
        #hudRight { display: flex; flex-direction: column; align-items: flex-end; gap: 6px; }

        .hud-bar {
            display: flex; align-items: center; gap: 8px;
            font-size: 11px; letter-spacing: 1px; text-transform: uppercase;
        }
        .hud-bar-label { width: 65px; text-align: right; color: #aaa; }
        .hud-bar-track {
            width: 160px; height: 10px;
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 2px;
            overflow: hidden;
            position: relative;
        }
        .hud-bar-fill {
            height: 100%;
            border-radius: 1px;
            transition: width 0.3s ease, background 0.3s ease;
            position: relative;
        }
        .hud-bar-fill::after {
            content: '';
            position: absolute;
            top: 0; right: 0;
            width: 4px; height: 100%;
            background: rgba(255,255,255,0.4);
            filter: blur(2px);
        }
        #healthFill { background: linear-gradient(90deg, #ff1744, #ff5252); }
        #healthFill.low { background: linear-gradient(90deg, #ff0000, #ff1744); animation: healthPulse 0.5s ease infinite; }
        #staminaFill { background: linear-gradient(90deg, #2979ff, #448aff); }
        #staminaFill.low { background: linear-gradient(90deg, #ff9100, #ffab40); }

        @keyframes healthPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .hud-bar-value {
            width: 35px; font-size: 11px; color: #fff;
            font-family: 'Orbitron', monospace; font-weight: 700;
        }

        #filesCount {
            font-family: 'Orbitron', monospace;
            font-size: 14px;
            letter-spacing: 2px;
            color: #ffd740;
            text-shadow: 0 0 10px rgba(255,215,64,0.5);
        }
        #status {
            font-size: 12px;
            color: #aaa;
            letter-spacing: 1px;
        }
        #timer {
            font-family: 'Orbitron', monospace;
            font-size: 18px;
            color: rgba(255,255,255,0.6);
            letter-spacing: 3px;
        }

        /* ============== DAMAGE VIGNETTE ============== */
        #damageOverlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none;
            z-index: 4;
            opacity: 0;
            background: radial-gradient(ellipse at center, transparent 50%, rgba(255,0,0,0.6) 100%);
            transition: opacity 0.15s ease;
        }

        /* ============== SCANLINES ============== */
        #scanlines {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none;
            z-index: 6;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                rgba(0,0,0,0.03) 2px,
                rgba(0,0,0,0.03) 4px
            );
        }

        /* ============== NOTIFICATION TOAST ============== */
        #toastContainer {
            position: absolute;
            top: 60px; left: 50%;
            transform: translateX(-50%);
            z-index: 8;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            pointer-events: none;
        }
        .toast {
            background: rgba(0,0,0,0.85);
            border: 1px solid rgba(255,215,64,0.4);
            border-left: 3px solid #ffd740;
            color: #ffd740;
            padding: 10px 24px;
            font-family: 'Orbitron', monospace;
            font-size: 13px;
            letter-spacing: 2px;
            border-radius: 4px;
            animation: toastIn 0.4s cubic-bezier(0.175,0.885,0.32,1.275) forwards,
                       toastOut 0.4s ease 2.5s forwards;
            text-shadow: 0 0 10px rgba(255,215,64,0.5);
            backdrop-filter: blur(10px);
        }
        @keyframes toastIn {
            from { transform: translateY(-30px) scale(0.8); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }
        @keyframes toastOut {
            to { transform: translateY(-20px) scale(0.9); opacity: 0; }
        }

        /* ============== SCREENS ============== */
        .game-screen {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
            overflow: hidden;
        }
        .game-screen.active { display: flex; }

        /* ============== TITLE SCREEN ============== */
        #titleScreen {
            background: #000;
        }
        #titleBgCanvas {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
        }
        #titleOverlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: radial-gradient(ellipse at 50% 80%, transparent 30%, rgba(0,0,0,0.7) 100%);
            z-index: 1;
        }
        #titleContent {
            position: relative;
            z-index: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .title-classified {
            font-family: 'Orbitron', monospace;
            font-size: 12px;
            letter-spacing: 8px;
            color: #ff1744;
            border: 2px solid #ff1744;
            padding: 5px 20px;
            animation: classifiedPulse 2s ease infinite;
            margin-bottom: 10px;
        }
        @keyframes classifiedPulse {
            0%, 100% { opacity: 1; box-shadow: 0 0 10px rgba(255,23,68,0.3); }
            50% { opacity: 0.6; box-shadow: 0 0 25px rgba(255,23,68,0.6); }
        }

        .title-main {
            font-family: 'Orbitron', monospace;
            font-size: clamp(36px, 7vw, 72px);
            font-weight: 900;
            color: #fff;
            text-shadow: 0 0 40px rgba(255,23,68,0.4), 0 0 80px rgba(255,23,68,0.2);
            letter-spacing: 8px;
            position: relative;
            animation: titleGlitch 5s ease infinite;
        }
        @keyframes titleGlitch {
            0%, 92%, 94%, 96%, 98%, 100% { transform: translate(0); filter: none; }
            93% { transform: translate(-3px, 1px); filter: hue-rotate(90deg); }
            95% { transform: translate(2px, -1px); filter: hue-rotate(-90deg); }
            97% { transform: translate(-1px, 2px); filter: hue-rotate(45deg); }
        }
        .title-main::before {
            content: 'EPSTEIN ISLAND';
            position: absolute;
            top: 0; left: 0;
            color: #ff1744;
            clip-path: inset(0 100% 0 0);
            animation: glitchClip 4s linear infinite alternate;
        }
        @keyframes glitchClip {
            0% { clip-path: inset(0 100% 0 0); }
            5% { clip-path: inset(20% 0 60% 0); }
            6% { clip-path: inset(0 100% 0 0); }
            15% { clip-path: inset(50% 0 30% 0); }
            16% { clip-path: inset(0 100% 0 0); }
            50% { clip-path: inset(0 100% 0 0); }
            55% { clip-path: inset(10% 0 70% 0); }
            56% { clip-path: inset(0 100% 0 0); }
            80% { clip-path: inset(0 100% 0 0); }
            85% { clip-path: inset(65% 0 10% 0); }
            86% { clip-path: inset(0 100% 0 0); }
            100% { clip-path: inset(0 100% 0 0); }
        }

        .title-sub {
            font-family: 'Share Tech Mono', monospace;
            font-size: clamp(12px, 2vw, 18px);
            color: #ffd740;
            letter-spacing: 6px;
            margin-top: -4px;
        }

        .title-year {
            font-family: 'Orbitron', monospace;
            font-size: 11px;
            color: rgba(255,255,255,0.3);
            letter-spacing: 12px;
            margin-top: 8px;
        }

        .title-divider {
            width: 300px;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,23,68,0.5), transparent);
            margin: 20px 0;
        }

        .title-description {
            max-width: 500px;
            text-align: center;
            line-height: 1.8;
            font-size: 13px;
            color: rgba(255,255,255,0.6);
            letter-spacing: 0.5px;
        }
        .title-description strong {
            color: #ff5252;
        }

        .title-controls {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            font-size: 11px;
            color: rgba(255,255,255,0.4);
            letter-spacing: 1px;
        }
        .title-controls .key-badge {
            display: inline-block;
            padding: 2px 8px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 3px;
            color: #ffd740;
            font-size: 10px;
            margin: 0 2px;
        }

        .title-warning {
            color: #ff1744;
            font-size: 12px;
            letter-spacing: 2px;
            margin-top: 8px;
            animation: warningBlink 1.5s ease infinite;
        }
        @keyframes warningBlink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        /* ============== BUTTONS ============== */
        .btn {
            margin-top: 20px;
            padding: 14px 50px;
            font-size: 15px;
            font-family: 'Orbitron', monospace;
            font-weight: 700;
            background: transparent;
            color: #fff;
            border: 2px solid #ff1744;
            border-radius: 0;
            cursor: none;
            text-transform: uppercase;
            letter-spacing: 4px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        .btn::before {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,23,68,0.2), transparent);
            transition: left 0.5s ease;
        }
        .btn:hover::before { left: 100%; }
        .btn:hover {
            background: rgba(255,23,68,0.15);
            box-shadow: 0 0 30px rgba(255,23,68,0.3), inset 0 0 30px rgba(255,23,68,0.1);
            text-shadow: 0 0 10px rgba(255,23,68,0.5);
        }
        .btn:active {
            transform: scale(0.97);
        }
        .btn-green { border-color: #00e676; color: #00e676; }
        .btn-green:hover {
            background: rgba(0,230,118,0.15);
            box-shadow: 0 0 30px rgba(0,230,118,0.3), inset 0 0 30px rgba(0,230,118,0.1);
            text-shadow: 0 0 10px rgba(0,230,118,0.5);
        }
        .btn-small {
            padding: 10px 30px;
            font-size: 12px;
            letter-spacing: 3px;
        }

        /* ============== SETTINGS SCREEN ============== */
        #settingsScreen {
            background: rgba(0,0,0,0.95);
            backdrop-filter: blur(20px);
        }
        .settings-container {
            width: 90%;
            max-width: 500px;
        }
        .settings-title {
            font-family: 'Orbitron', monospace;
            font-size: 28px;
            font-weight: 900;
            color: #fff;
            letter-spacing: 6px;
            text-align: center;
            margin-bottom: 30px;
        }
        .settings-group {
            margin-bottom: 24px;
        }
        .settings-label {
            font-size: 11px;
            color: #ffd740;
            letter-spacing: 3px;
            text-transform: uppercase;
            margin-bottom: 10px;
        }
        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.06);
        }
        .settings-row-label {
            color: rgba(255,255,255,0.7);
            font-size: 13px;
            letter-spacing: 1px;
        }

        /* Toggle Switch */
        .toggle {
            width: 44px; height: 22px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 11px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .toggle.on {
            background: rgba(255,23,68,0.3);
            border-color: #ff1744;
        }
        .toggle::after {
            content: '';
            position: absolute;
            width: 16px; height: 16px;
            background: #666;
            border-radius: 50%;
            top: 2px; left: 2px;
            transition: all 0.3s ease;
        }
        .toggle.on::after {
            left: 24px;
            background: #ff1744;
            box-shadow: 0 0 8px rgba(255,23,68,0.5);
        }

        /* Difficulty Selector */
        .difficulty-selector {
            display: flex;
            gap: 8px;
        }
        .diff-btn {
            flex: 1;
            padding: 8px;
            text-align: center;
            font-family: 'Orbitron', monospace;
            font-size: 10px;
            letter-spacing: 2px;
            color: rgba(255,255,255,0.5);
            border: 1px solid rgba(255,255,255,0.1);
            background: transparent;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .diff-btn.active {
            border-color: #ff1744;
            color: #ff1744;
            background: rgba(255,23,68,0.1);
            box-shadow: 0 0 15px rgba(255,23,68,0.2);
        }
        .diff-btn:hover:not(.active) {
            border-color: rgba(255,255,255,0.3);
            color: rgba(255,255,255,0.8);
        }

        /* Slider */
        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .slider {
            -webkit-appearance: none;
            width: 150px;
            height: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
            outline: none;
        }
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px; height: 14px;
            background: #ff1744;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 8px rgba(255,23,68,0.5);
        }
        .slider-value {
            font-family: 'Orbitron', monospace;
            font-size: 11px;
            color: #ff1744;
            width: 35px;
            text-align: right;
        }

        /* ============== WIN/LOSE SCREENS ============== */
        #winScreen {
            background: rgba(0,0,0,0.9);
            backdrop-filter: blur(10px);
        }
        #winScreen .screen-title {
            font-family: 'Orbitron', monospace;
            font-size: 42px;
            font-weight: 900;
            color: #00e676;
            text-shadow: 0 0 40px rgba(0,230,118,0.4);
            letter-spacing: 6px;
            animation: winPulse 2s ease infinite;
        }
        @keyframes winPulse {
            0%, 100% { text-shadow: 0 0 40px rgba(0,230,118,0.4); }
            50% { text-shadow: 0 0 60px rgba(0,230,118,0.7), 0 0 100px rgba(0,230,118,0.3); }
        }

        /* ============== NAME INPUT MODAL ============== */
        #nameModal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 50;
            backdrop-filter: blur(8px);
        }
        #nameModal.active { display: flex; }
        .name-modal-box {
            background: rgba(10,10,10,0.95);
            border: 1px solid rgba(0,230,118,0.3);
            padding: 30px 40px;
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        .name-modal-box h2 {
            font-family: 'Orbitron', monospace;
            font-size: 18px;
            color: #00e676;
            letter-spacing: 4px;
            margin-bottom: 8px;
        }
        .name-modal-box p {
            color: rgba(255,255,255,0.5);
            font-size: 12px;
            margin-bottom: 16px;
        }
        #nameInput {
            width: 100%;
            padding: 12px 16px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(0,230,118,0.3);
            color: #fff;
            font-family: 'Share Tech Mono', monospace;
            font-size: 16px;
            letter-spacing: 2px;
            text-align: center;
            outline: none;
            text-transform: uppercase;
        }
        #nameInput:focus { border-color: #00e676; }
        #nameInput::placeholder { color: rgba(255,255,255,0.2); }
        #submitNameBtn {
            margin-top: 14px;
            padding: 10px 40px;
            background: none;
            border: 1px solid #00e676;
            color: #00e676;
            font-family: 'Orbitron', monospace;
            font-size: 13px;
            letter-spacing: 3px;
            cursor: pointer;
            transition: all 0.2s;
        }
        #submitNameBtn:hover { background: rgba(0,230,118,0.15); }

        /* ============== LEADERBOARD ============== */
        #leaderboardScreen {
            background: rgba(0,0,0,0.92);
            backdrop-filter: blur(12px);
        }
        .lb-title {
            font-family: 'Orbitron', monospace;
            font-size: 24px;
            font-weight: 900;
            color: #ffd740;
            letter-spacing: 6px;
            margin-bottom: 6px;
        }
        .lb-sub {
            font-size: 10px;
            color: rgba(255,255,255,0.3);
            letter-spacing: 3px;
            margin-bottom: 18px;
        }
        .lb-table {
            width: 90%;
            max-width: 500px;
            max-height: 50vh;
            overflow-y: auto;
        }
        .lb-row {
            display: flex;
            padding: 8px 12px;
            border-bottom: 1px solid rgba(255,255,255,0.06);
            align-items: center;
            font-size: 13px;
        }
        .lb-row.header {
            color: rgba(255,255,255,0.4);
            font-size: 10px;
            letter-spacing: 2px;
            text-transform: uppercase;
            border-bottom: 1px solid rgba(255,255,255,0.15);
        }
        .lb-row.you { background: rgba(0,230,118,0.08); }
        .lb-rank { width: 40px; color: #ffd740; font-weight: bold; }
        .lb-row.header .lb-rank { color: rgba(255,255,255,0.4); font-weight: normal; }
        .lb-name { flex: 1; color: #fff; letter-spacing: 1px; }
        .lb-diff { width: 70px; text-align: center; font-size: 10px; letter-spacing: 1px; }
        .lb-diff.easy { color: #69f0ae; }
        .lb-diff.normal { color: #ffd740; }
        .lb-diff.hard { color: #ff5252; }
        .lb-diff.insane { color: #e040fb; }
        .lb-time { width: 80px; text-align: right; color: #00e676; font-family: 'Share Tech Mono', monospace; }
        .lb-row:nth-child(2) .lb-rank { color: #ffd700; font-size: 16px; }
        .lb-row:nth-child(3) .lb-rank { color: #c0c0c0; }
        .lb-row:nth-child(4) .lb-rank { color: #cd7f32; }
        .lb-live {
            font-size: 9px;
            color: #ff1744;
            letter-spacing: 2px;
            margin-bottom: 12px;
            animation: livePulse 1.5s ease infinite;
        }
        @keyframes livePulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        .lb-buttons {
            margin-top: 18px;
            display: flex;
            gap: 10px;
        }
        #loseScreen {
            background: rgba(0,0,0,0.9);
            backdrop-filter: blur(10px);
        }
        #loseScreen .screen-title {
            font-family: 'Orbitron', monospace;
            font-size: 42px;
            font-weight: 900;
            color: #ff1744;
            text-shadow: 0 0 40px rgba(255,23,68,0.4);
            letter-spacing: 6px;
            animation: titleGlitch 3s ease infinite;
        }
        .screen-text {
            color: rgba(255,255,255,0.6);
            font-size: 14px;
            text-align: center;
            max-width: 460px;
            line-height: 1.7;
            letter-spacing: 0.5px;
            margin: 4px 0;
        }
        .screen-highlight {
            color: #ffd740;
            font-family: 'Orbitron', monospace;
            font-size: 13px;
            letter-spacing: 2px;
            margin: 12px 0;
        }
        .screen-stat {
            font-family: 'Orbitron', monospace;
            font-size: 16px;
            letter-spacing: 3px;
        }

        /* ============== PAUSE OVERLAY ============== */
        #pauseOverlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(8px);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9;
        }
        #pauseOverlay.active { display: flex; }
        .pause-title {
            font-family: 'Orbitron', monospace;
            font-size: 36px;
            font-weight: 900;
            color: #fff;
            letter-spacing: 10px;
            margin-bottom: 30px;
        }

        /* ============== SCREEN TRANSITIONS ============== */
        #screenTransition {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: #000;
            z-index: 20;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        #screenTransition.active { opacity: 1; pointer-events: all; }

        /* ============== TOUCH CONTROLS ============== */
        #touchControls {
            display: none;
            position: absolute;
            bottom: 0;
            left: 0; right: 0;
            pointer-events: none;
            z-index: 5;
        }
        #joystickZone {
            position: absolute;
            bottom: 80px; left: 20px;
            width: 150px; height: 150px;
            pointer-events: auto;
            touch-action: none;
        }
        #joystickBase {
            position: absolute;
            width: 120px; height: 120px;
            left: 15px; top: 15px;
            background: rgba(255,255,255,0.06);
            border: 2px solid rgba(255,255,255,0.15);
            border-radius: 50%;
            backdrop-filter: blur(4px);
        }
        #joystickThumb {
            position: absolute;
            width: 50px; height: 50px;
            left: 50px; top: 50px;
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.4);
            border-radius: 50%;
            transition: none;
        }
        #joystickThumb.active {
            background: rgba(255,255,255,0.35);
            border-color: rgba(255,255,255,0.6);
        }
        #btn-sprint {
            position: absolute;
            bottom: 110px; right: 25px;
            width: 70px; height: 70px;
            background: rgba(255,23,68,0.15);
            border: 1px solid rgba(255,23,68,0.4);
            border-radius: 50%;
            color: #ff1744;
            font-size: 11px;
            font-family: 'Orbitron', monospace;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
            pointer-events: auto;
            letter-spacing: 1px;
        }
        #btn-sprint.active {
            background: rgba(255,23,68,0.4);
            border-color: rgba(255,23,68,0.7);
            color: #fff;
        }
        @media (pointer: coarse), (max-width: 1024px) {
            #touchControls { display: block; }
            body { cursor: auto; }
            #customCursor { display: none; }
        }

        /* iPad / tablet scaling */
        @media (pointer: coarse) and (min-width: 700px) {
            #joystickZone {
                width: 200px; height: 200px;
                bottom: 100px; left: 30px;
            }
            #joystickBase {
                width: 160px; height: 160px;
                left: 20px; top: 20px;
            }
            #joystickThumb {
                width: 66px; height: 66px;
                left: 67px; top: 67px;
            }
            #btn-sprint {
                width: 90px; height: 90px;
                bottom: 130px; right: 35px;
                font-size: 13px;
            }
            #ui { padding: 20px 28px; font-size: 15px; }
            .hud-bar-track { width: 200px; height: 13px; }
            .hud-bar-label { width: 80px; font-size: 13px; }
        }

        /* ============== LOADING SCREEN ============== */
        #loadingScreen {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: #000;
            z-index: 100;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 20px;
            transition: opacity 0.8s ease;
        }
        #loadingScreen.fade-out { opacity: 0; pointer-events: none; }
        .loading-bar-track {
            width: 300px; height: 3px;
            background: rgba(255,255,255,0.05);
            border-radius: 2px;
            overflow: hidden;
        }
        .loading-bar-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #ff1744, #ffd740);
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        .loading-text {
            font-family: 'Orbitron', monospace;
            font-size: 10px;
            color: rgba(255,255,255,0.3);
            letter-spacing: 6px;
        }
    </style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SPLASH SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="splashScreen">
  <img src="Untitled%20design.png" alt="Logo" id="splashLogo">
</div>
<style>
  #splashScreen {
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    background: #000; display: flex; align-items: center; justify-content: center;
    z-index: 99999;
  }
  #splashLogo {
    max-width: 90vw; max-height: 90vh; width: auto; height: auto;
    object-fit: contain;
    opacity: 0;
    animation: splashFadeIn 1s ease-in-out forwards;
  }
  @keyframes splashFadeIn {
    from { opacity: 0; } to { opacity: 1; }
  }
  @keyframes splashFadeOut {
    from { opacity: 1; } to { opacity: 0; }
  }
  #splashScreen.fade-out {
    animation: splashFadeOut 1s ease-in-out forwards;
  }
</style>
<script>
(function() {
  var ov = document.documentElement.style.overflow;
  document.documentElement.style.overflow = 'hidden';
  var sp = document.getElementById('splashScreen');
  setTimeout(function() {
    sp.classList.add('fade-out');
    setTimeout(function() {
      sp.style.display = 'none';
      sp.style.pointerEvents = 'none';
      document.documentElement.style.overflow = ov || '';
    }, 1000);
  }, 2500);
})();
</script>

    <div id="customCursor"></div>

    <div id="gameContainer">
        <canvas id="game"></canvas>

        <!-- Damage Vignette -->
        <div id="damageOverlay"></div>

        <!-- Scanlines -->
        <div id="scanlines"></div>

        <!-- HUD -->
        <div id="ui" style="display:none">
            <div id="hudLeft">
                <div id="filesCount">FILES: 0 / 7</div>
                <div class="hud-bar">
                    <span class="hud-bar-label">Health</span>
                    <div class="hud-bar-track"><div class="hud-bar-fill" id="healthFill" style="width:100%"></div></div>
                    <span class="hud-bar-value" id="healthVal">100</span>
                </div>
                <div class="hud-bar">
                    <span class="hud-bar-label">Stamina</span>
                    <div class="hud-bar-track"><div class="hud-bar-fill" id="staminaFill" style="width:100%"></div></div>
                    <span class="hud-bar-value" id="staminaVal">100</span>
                </div>
                <div id="status">Find the Epstein Files!</div>
            </div>
            <div id="hudRight">
                <div id="timer">00:00</div>
            </div>
        </div>

        <!-- Toast Notifications -->
        <div id="toastContainer"></div>

        <!-- Screen Transition -->
        <div id="screenTransition"></div>

        <!-- Loading Screen -->
        <div id="loadingScreen">
            <div class="loading-text">LOADING</div>
            <div class="loading-bar-track"><div class="loading-bar-fill" id="loadingFill"></div></div>
        </div>

        <!-- ========= TITLE SCREEN ========= -->
        <div id="titleScreen" class="game-screen active">
            <canvas id="titleBgCanvas"></canvas>
            <div id="titleOverlay"></div>
            <div id="titleContent">
                <div class="title-classified">‚ñ™ CLASSIFIED ‚ñ™</div>
                <div class="title-main">EPSTEIN ISLAND</div>
                <div class="title-sub">LITTLE ST. JAMES ‚Äî ESCAPE</div>
                <div class="title-year">‚Äî 2 0 1 9 ‚Äî</div>
                <div class="title-divider"></div>
                <p class="title-description">
                    Jeffrey Epstein's private island hides the truth. The FBI is closing in, 
                    but the files are about to be destroyed. You're a whistleblower who snuck onto 
                    <strong>Little St. James</strong> by boat. Collect all <span style="color:#ffd740">7 files</span> and escape.
                </p>
                <div class="title-controls">
                    <span><span class="key-badge">WASD</span> Move</span>
                    <span><span class="key-badge">SHIFT</span> Sprint</span>
                    <span><span class="key-badge">ESC</span> Pause</span>
                </div>
                <div class="title-warning">‚ö† GUARDS ARE EVERYWHERE ‚ö†</div>
                <button class="btn" id="startBtn">INFILTRATE</button>
                <button class="btn btn-small" id="leaderboardBtnTitle" style="margin-top:8px; border-color:rgba(255,215,64,0.4); color:#ffd740">LEADERBOARD</button>
                <button class="btn btn-small" id="settingsBtn" style="margin-top:10px; border-color: rgba(255,255,255,0.3); color: rgba(255,255,255,0.5);">SETTINGS</button>
            </div>
        </div>

        <!-- ========= SETTINGS SCREEN ========= -->
        <div id="settingsScreen" class="game-screen">
            <div class="settings-container">
                <div class="settings-title">SETTINGS</div>

                <div class="settings-group">
                    <div class="settings-label">DIFFICULTY</div>
                    <div class="difficulty-selector">
                        <div class="diff-btn" data-diff="easy">EASY</div>
                        <div class="diff-btn active" data-diff="normal">NORMAL</div>
                        <div class="diff-btn" data-diff="hard">HARD</div>
                        <div class="diff-btn" data-diff="insane">INSANE</div>
                    </div>
                </div>

                <div class="settings-group">
                    <div class="settings-label">VISUALS</div>
                    <div class="settings-row">
                        <span class="settings-row-label">Scanlines</span>
                        <div class="toggle on" data-setting="scanlines"></div>
                    </div>
                    <div class="settings-row">
                        <span class="settings-row-label">Screen Shake</span>
                        <div class="toggle on" data-setting="screenShake"></div>
                    </div>
                    <div class="settings-row">
                        <span class="settings-row-label">Particles</span>
                        <div class="toggle on" data-setting="particles"></div>
                    </div>
                    <div class="settings-row">
                        <span class="settings-row-label">Rain Effects</span>
                        <div class="toggle on" data-setting="rain"></div>
                    </div>
                    <div class="settings-row">
                        <span class="settings-row-label">Fog of War</span>
                        <div class="toggle on" data-setting="fogOfWar"></div>
                    </div>
                </div>

                <div class="settings-group">
                    <div class="settings-label">AUDIO</div>
                    <div class="settings-row">
                        <span class="settings-row-label">Sound Effects</span>
                        <div class="toggle on" data-setting="sound"></div>
                    </div>
                    <div class="settings-row">
                        <span class="settings-row-label">Music Volume</span>
                        <div class="slider-container">
                            <input type="range" class="slider" id="musicVolume" min="0" max="100" value="50">
                            <span class="slider-value" id="musicVolVal">50</span>
                        </div>
                    </div>
                </div>

                <div style="text-align:center">
                    <button class="btn btn-small" id="settingsBackBtn">BACK</button>
                </div>
            </div>
        </div>

        <!-- ========= WIN SCREEN ========= -->
        <div id="winScreen" class="game-screen">
            <div class="screen-title">THE FILES ARE OUT</div>
            <div class="title-divider" style="margin:16px 0"></div>
            <p class="screen-text">You escaped Little St. James with all the Epstein Files.</p>
            <p class="screen-text">The names are public. Justice is coming.</p>
            <p class="screen-highlight">"The truth doesn't stay buried forever."</p>
            <p class="screen-stat" id="winTime" style="color:#00e676"></p>
            <button class="btn btn-green" id="restartWinBtn">PLAY AGAIN</button>
            <button class="btn btn-small" id="leaderboardBtnWin" style="margin-top:8px; border-color:rgba(255,215,64,0.4); color:#ffd740">LEADERBOARD</button>
        </div>

        <!-- ========= NAME INPUT MODAL ========= -->
        <div id="nameModal">
            <div class="name-modal-box">
                <h2>YOU ESCAPED</h2>
                <p>Enter your name for the leaderboard</p>
                <input type="text" id="nameInput" placeholder="YOUR NAME" maxlength="16" autocomplete="off" inputmode="text" enterkeyhint="done" autocorrect="off" autocapitalize="characters" spellcheck="false">
                <br>
                <button id="submitNameBtn">SUBMIT</button>
            </div>
        </div>

        <!-- ========= LEADERBOARD SCREEN ========= -->
        <div id="leaderboardScreen" class="game-screen">
            <div class="lb-title">LEADERBOARD</div>
            <div class="lb-live">‚óè LIVE</div>
            <div class="lb-sub">FASTEST ESCAPES</div>
            <div class="lb-table">
                <div class="lb-row header">
                    <div class="lb-rank">#</div>
                    <div class="lb-name">NAME</div>
                    <div class="lb-diff">DIFF</div>
                    <div class="lb-time">TIME</div>
                </div>
                <div id="lbRows"></div>
            </div>
            <div class="lb-buttons">
                <button class="btn btn-small" id="lbPlayBtn">PLAY AGAIN</button>
                <button class="btn btn-small" id="lbMenuBtn" style="border-color:rgba(255,255,255,0.3); color:rgba(255,255,255,0.5)">MENU</button>
            </div>
        </div>

        <!-- ========= LOSE SCREEN ========= -->
        <div id="loseScreen" class="game-screen">
            <div class="screen-title">CAUGHT</div>
            <div class="title-divider" style="margin:16px 0; background: linear-gradient(90deg, transparent, rgba(255,23,68,0.5), transparent);"></div>
            <p class="screen-text">You were taken down by <strong style="color:#ff5252" id="killerName">a guard</strong>.</p>
            <p class="screen-text">The files will be destroyed. The cover-up continues.</p>
            <p class="screen-highlight" style="color:#ff5252">"Epstein didn't kill himself."</p>
            <button class="btn" id="restartLoseBtn">RETRY</button>
            <button class="btn" id="menuLoseBtn" style="margin-top:8px; border-color:rgba(255,255,255,0.3); color:rgba(255,255,255,0.5)">MENU</button>
        </div>

        <!-- ========= PAUSE OVERLAY ========= -->
        <div id="pauseOverlay">
            <div class="pause-title">PAUSED</div>
            <button class="btn btn-small" id="resumeBtn">RESUME</button>
            <button class="btn btn-small" id="pauseSettingsBtn" style="margin-top:8px; border-color:rgba(255,255,255,0.3); color:rgba(255,255,255,0.5)">SETTINGS</button>
            <button class="btn btn-small" id="pauseQuitBtn" style="margin-top:8px; border-color:rgba(255,255,255,0.2); color:rgba(255,255,255,0.3)">QUIT</button>
        </div>

        <!-- Touch Controls -->
        <div id="touchControls">
            <div id="joystickZone">
                <div id="joystickBase"></div>
                <div id="joystickThumb"></div>
            </div>
            <div id="btn-sprint">RUN</div>
        </div>
    </div>

<script>
// ============================================================
// EPSTEIN ISLAND ‚Äî FULLY UPGRADED
// ============================================================

const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');

// ============== SETTINGS ==============
const settings = {
    difficulty: 'normal',
    scanlines: true,
    screenShake: true,
    particles: true,
    rain: true,
    fogOfWar: true,
    sound: true,
    musicVolume: 50
};
window.settings = settings;

const difficultyMods = {
    easy:   { guardSpeed: 0.6, detectRange: 70,  chaseRange: 100, damage: 0.6, guardCount: 6, staminaDrain: 0.15, staminaRegen: 0.25 },
    normal: { guardSpeed: 1.0, detectRange: 100, chaseRange: 150, damage: 1.2, guardCount: 6, staminaDrain: 0.25, staminaRegen: 0.15 },
    hard:   { guardSpeed: 1.3, detectRange: 130, chaseRange: 180, damage: 1.8, guardCount: 7, staminaDrain: 0.35, staminaRegen: 0.10 },
    insane: { guardSpeed: 1.6, detectRange: 160, chaseRange: 220, damage: 2.5, guardCount: 10, staminaDrain: 0.45, staminaRegen: 0.08 }
};

// ============== AUDIO SYSTEM ==============
let audioCtx = null;
function initAudio() {
    if (audioCtx) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
}

function playTone(freq, duration, type = 'sine', volume = 0.1) {
    if (!settings.sound || !audioCtx) return;
    const vol = (settings.musicVolume / 100) * volume;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = type;
    osc.frequency.value = freq;
    gain.gain.setValueAtTime(vol, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.start();
    osc.stop(audioCtx.currentTime + duration);
}

function playCollect() {
    playTone(523, 0.1, 'sine', 0.15);
    setTimeout(() => playTone(659, 0.1, 'sine', 0.15), 80);
    setTimeout(() => playTone(784, 0.15, 'sine', 0.15), 160);
    setTimeout(() => playTone(1047, 0.2, 'sine', 0.12), 260);
}
function playAlert() {
    playTone(200, 0.15, 'sawtooth', 0.08);
    setTimeout(() => playTone(250, 0.15, 'sawtooth', 0.08), 120);
}
function playHit() {
    playTone(80, 0.2, 'sawtooth', 0.12);
    playTone(60, 0.3, 'square', 0.06);
}
function playWin() {
    [523,659,784,1047,1319].forEach((f,i) => setTimeout(() => playTone(f, 0.3, 'sine', 0.12), i*120));
}
function playLose() {
    [400,350,300,200].forEach((f,i) => setTimeout(() => playTone(f, 0.4, 'sawtooth', 0.08), i*200));
}
function playClick() { playTone(800, 0.05, 'sine', 0.08); }
function playStep() {
    if (Math.random() > 0.7) return;
    playTone(60 + Math.random() * 30, 0.05, 'triangle', 0.03);
}

// ============== AMBIENT SOUND ==============
let ambientInterval = null;
function startAmbient() {
    if (ambientInterval) return;
    ambientInterval = setInterval(() => {
        if (!settings.sound || !audioCtx || gameState !== 'playing') return;
        const vol = (settings.musicVolume / 100) * 0.015;
        // Ocean
        const noise = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        noise.type = 'sine';
        noise.frequency.value = 80 + Math.random() * 40;
        gain.gain.setValueAtTime(vol, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 2);
        noise.connect(gain);
        gain.connect(audioCtx.destination);
        noise.start();
        noise.stop(audioCtx.currentTime + 2);
    }, 2000);
}

// ============== SCREEN SHAKE ==============
let shakeAmount = 0;
let shakeDuration = 0;
function triggerShake(amount = 5, duration = 10) {
    if (!settings.screenShake) return;
    shakeAmount = amount;
    shakeDuration = duration;
}

// ============== BASE DIMENSIONS ==============
const BASE_W = 900, BASE_H = 600;
const W = BASE_W, H = BASE_H;
const T = 30;
const COLS = W / T, ROWS = H / T;

function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
resizeCanvas();
window.addEventListener('resize', resizeCanvas);
window.addEventListener('orientationchange', () => setTimeout(resizeCanvas, 200));

// ============== MAP ==============
const MAP = [
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,1,1,1,1,1,2,2,2,2,2,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,1,1,1,1],
    [1,1,1,1,2,2,2,0,0,0,2,2,2,2,2,2,2,2,2,2,0,0,3,0,0,2,2,1,1,1],
    [1,1,1,2,2,0,0,3,0,0,0,10,10,10,10,10,10,0,0,0,0,8,8,8,0,0,2,1,1,1],
    [1,1,2,2,0,7,7,7,0,0,10,0,0,0,0,0,0,10,0,0,0,8,8,8,0,3,2,1,1,1],
    [1,1,2,0,0,7,7,7,0,0,10,0,3,0,0,3,0,10,0,0,0,8,8,8,0,0,2,1,1,1],
    [1,1,2,0,0,7,7,7,0,0,10,0,0,0,0,0,0,10,0,0,0,0,0,0,0,0,2,1,1,1],
    [1,1,2,0,3,0,0,0,0,0,10,0,0,11,0,0,0,10,0,5,5,10,5,5,0,0,2,1,1,1],
    [1,1,2,0,0,0,0,0,3,0,10,0,0,0,0,0,0,10,0,5,4,4,4,5,0,3,2,1,1,1],
    [1,6,6,2,0,0,0,0,0,0,10,10,10,10,10,10,10,10,0,5,4,4,4,5,0,0,2,1,1,1],
    [1,6,6,2,0,0,3,0,0,0,10,0,0,0,0,0,0,0,0,5,4,4,4,5,0,0,2,1,1,1],
    [1,1,2,0,0,0,0,5,10,5,10,0,0,9,9,9,0,0,0,5,5,5,5,5,0,0,2,1,1,1],
    [1,1,2,0,0,3,0,5,4,5,10,0,0,9,9,9,0,0,0,0,0,0,0,0,0,2,2,1,1,1],
    [1,1,2,0,0,0,0,5,4,5,10,0,0,9,9,9,0,0,3,0,0,0,3,0,0,2,1,1,1,1],
    [1,1,2,2,0,0,0,5,5,5,10,0,0,0,0,0,0,0,0,0,3,0,0,0,2,2,1,1,1,1],
    [1,1,1,2,0,3,0,0,0,0,10,10,10,0,0,0,3,0,0,0,0,0,3,2,2,1,1,1,1],
    [1,1,1,2,2,2,2,2,2,2,2,0,0,0,0,2,2,2,2,2,2,2,2,2,1,1,1,1,1,1],
    [1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
];

// ============== GAME STATE ==============
let player, guards, files, boat, keys, gameState, startTime, stamina, health;
let lastWinTime = 0;
let particles, rainDrops, killedBy, camera, stepTimer = 0;
let frameCount = 0;

// Guard images
const guardImages = ['TheBigE.png','mrstephen.png','guard3_new.png','guard4_new.png','guard5_new.png','guard6_new.png','trump5.png','TheBigE.png','mrstephen.png','goldenstephen.png'].map(src => {
    const img = new Image(); img.src = src; return img;
});
const playerImg = new Image();
playerImg.src = 'girl.png';

function isWalkable(col, row) {
    if (col < 0 || col >= COLS || row < 0 || row >= ROWS) return false;
    const tile = MAP[row][col];
    return [0,2,6,10,4,7,8,9,11].includes(tile);
}

// ============== RAIN SYSTEM ==============
function initRain() {
    rainDrops = [];
    for (let i = 0; i < 200; i++) {
        rainDrops.push({
            x: Math.random() * W,
            y: Math.random() * H,
            speed: 3 + Math.random() * 4,
            len: 8 + Math.random() * 12,
            opacity: 0.1 + Math.random() * 0.2
        });
    }
}

function updateRain() {
    if (!settings.rain) return;
    rainDrops.forEach(d => {
        d.y += d.speed;
        d.x += 1.5;
        if (d.y > H) { d.y = -d.len; d.x = Math.random() * W; }
        if (d.x > W) d.x = 0;
    });
}

// ============== CAMERA ==============
function initCamera() {
    camera = { x: 0, y: 0, targetX: 0, targetY: 0 };
}

function updateCamera() {
    camera.targetX = player.x - W / 2;
    camera.targetY = player.y - H / 2;
    // Clamp
    camera.targetX = Math.max(0, Math.min(camera.targetX, 0));
    camera.targetY = Math.max(0, Math.min(camera.targetY, 0));
    // Smooth follow
    camera.x += (camera.targetX - camera.x) * 0.08;
    camera.y += (camera.targetY - camera.y) * 0.08;
}

// ============== INIT ==============
function init() {
    keys = {};
    gameState = 'playing';
    startTime = Date.now();
    stamina = 60;
    health = 100;
    particles = [];
    killedBy = null;
    frameCount = 0;

    player = { x: 3*T + T/2, y: 11*T + T/2, speed: 3.0, size: 10, dir: 0, trail: [] };

    files = [
        { x: 6*T, y: 6*T, collected: false, label: "Temple File", icon: "üèõÔ∏è" },
        { x: 21.5*T, y: 11*T, collected: false, label: "Mansion File", icon: "üè†" },
        { x: 22*T, y: 5*T, collected: false, label: "Helipad File", icon: "üöÅ" },
        { x: 14*T, y: 14*T, collected: false, label: "Pool File", icon: "üèä" },
        { x: 8.5*T, y: 13.5*T, collected: false, label: "Guest House File", icon: "üè®" },
        { x: 13*T, y: 8*T, collected: false, label: "Sundial File", icon: "‚òÄÔ∏è" },
        { x: 10*T, y: 16*T, collected: false, label: "Beach File", icon: "üèñÔ∏è" },
    ];

    boat = { x: 2*T, y: 10.5*T };

    const diff = difficultyMods[settings.difficulty];
    guards = [
        { name:'Epstein', x:10*T, y:5*T, speed:0.9*diff.guardSpeed, patrolPoints:[{x:10*T,y:4*T},{x:10*T,y:10*T}], patrolIdx:0, alertTimer:0, size:14, mansionTimer:600, goingToMansion:false, speechTimer:0, stopped:false },
        { name:'Steven Hawking', x:17*T, y:10*T, speed:0.85*diff.guardSpeed, patrolPoints:[{x:17*T,y:5*T},{x:17*T,y:12*T},{x:10*T,y:12*T}], patrolIdx:0, alertTimer:0, size:14 },
        { name:'Bill Clinton', x:13*T, y:14*T, speed:0.95*diff.guardSpeed, patrolPoints:[{x:10*T,y:15*T},{x:16*T,y:12*T},{x:10*T,y:10*T}], patrolIdx:0, alertTimer:0, size:14 },
        { name:'Elon Musk', x:20*T, y:5*T, speed:0.8*diff.guardSpeed, patrolPoints:[{x:24*T,y:4*T},{x:24*T,y:7*T},{x:20*T,y:7*T}], patrolIdx:0, alertTimer:0, size:14 },
        { name:'Ghislaine', x:14*T, y:15*T, speed:1.0*diff.guardSpeed, patrolPoints:[{x:12*T,y:14*T},{x:15*T,y:16*T},{x:10*T,y:16*T}], patrolIdx:0, alertTimer:0, size:14 },
        { name:'Prince Andrew', x:18*T, y:7*T, speed:1.1*diff.guardSpeed, patrolPoints:[{x:18*T,y:5*T},{x:22*T,y:10*T},{x:18*T,y:13*T}], patrolIdx:0, alertTimer:0, size:14 },
    ];

    // Extra guards for hard/insane
    if (diff.guardCount >= 7) {
        guards.push({ name:'Donald Trump', x:12*T, y:8*T, speed:1.2*diff.guardSpeed, patrolPoints:[{x:10*T,y:6*T},{x:16*T,y:10*T},{x:12*T,y:14*T}], patrolIdx:0, alertTimer:0, size:14 });
    }
    if (diff.guardCount >= 8) {
        guards.push({ name:'Epstein\'s Double', x:15*T, y:16*T, speed:1.3*diff.guardSpeed, patrolPoints:[{x:12*T,y:15*T},{x:17*T,y:14*T},{x:14*T,y:17*T}], patrolIdx:0, alertTimer:0, size:14 });
    }
    if (diff.guardCount >= 9) {
        guards.push({ name:'Hawking\'s Ghost', x:8*T, y:6*T, speed:1.1*diff.guardSpeed, patrolPoints:[{x:6*T,y:5*T},{x:12*T,y:8*T},{x:8*T,y:12*T}], patrolIdx:0, alertTimer:0, size:14 });
    }
    if (diff.guardCount >= 10) {
        guards.push({ name:'Golden Hawking', x:20*T, y:14*T, speed:1.4*diff.guardSpeed, patrolPoints:[{x:18*T,y:12*T},{x:21*T,y:16*T},{x:16*T,y:14*T},{x:20*T,y:10*T}], patrolIdx:0, alertTimer:0, size:14 });
    }

    initCamera();
    initRain();
    startAmbient();
    document.getElementById('damageOverlay').style.opacity = 0;
    updateUI();

    document.getElementById('ui').style.display = 'flex';
}

// ============== TOAST ==============
function showToast(text) {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.textContent = text;
    container.appendChild(toast);
    setTimeout(() => toast.remove(), 3200);
}

// ============== PARTICLES ==============
function addParticles(x, y, color, count, opts = {}) {
    if (!settings.particles) return;
    for (let i = 0; i < count; i++) {
        particles.push({
            x, y,
            vx: (Math.random() - 0.5) * (opts.spread || 6),
            vy: (Math.random() - 0.5) * (opts.spread || 6) + (opts.gravity || 0),
            life: (opts.life || 40) + Math.random() * 20,
            maxLife: (opts.life || 40) + 20,
            color,
            size: (opts.size || 2) + Math.random() * (opts.sizeVar || 3),
            type: opts.type || 'square'
        });
    }
}

function addExplosion(x, y) {
    addParticles(x, y, '#ffd740', 30, { spread: 10, life: 50, size: 2 });
    addParticles(x, y, '#ff9100', 20, { spread: 8, life: 40, size: 3 });
    addParticles(x, y, '#fff', 10, { spread: 12, life: 30, size: 1 });
}

// ============== UI ==============
function updateUI() {
    const collected = files.filter(f => f.collected).length;
    document.getElementById('filesCount').textContent = `FILES: ${collected} / ${files.length}`;

    const hpPct = Math.max(0, health);
    document.getElementById('healthFill').style.width = hpPct + '%';
    document.getElementById('healthVal').textContent = Math.round(hpPct);
    document.getElementById('healthFill').className = 'hud-bar-fill' + (hpPct < 30 ? ' low' : '');

    const stPct = (stamina / 60) * 100;
    document.getElementById('staminaFill').style.width = stPct + '%';
    document.getElementById('staminaVal').textContent = Math.round(stPct);
    document.getElementById('staminaFill').className = 'hud-bar-fill' + (stPct < 30 ? ' low' : '');

    if (collected === files.length) {
        document.getElementById('status').innerHTML = '<span style="color:#00e676; letter-spacing:2px">‚ñ∏ ALL FILES ‚Äî GET TO THE BOAT ‚óÇ</span>';
    } else {
        document.getElementById('status').textContent = 'Find the Epstein Files!';
    }

    // Timer
    if (gameState === 'playing') {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        const mins = String(Math.floor(elapsed / 60)).padStart(2, '0');
        const secs = String(elapsed % 60).padStart(2, '0');
        document.getElementById('timer').textContent = `${mins}:${secs}`;
    }
}

function dist(a, b) { return Math.hypot(a.x - b.x, a.y - b.y); }

// ============== A* PATHFINDING ==============
function findPath(sx, sy, ex, ey) {
    const sc = Math.floor(sx / T), sr = Math.floor(sy / T);
    const ec = Math.floor(ex / T), er = Math.floor(ey / T);
    if (sc === ec && sr === er) return null;
    if (!isWalkable(ec, er)) return null;

    const key = (c, r) => c + ',' + r;
    const open = [{ c: sc, r: sr, g: 0, f: 0, parent: null }];
    const closed = new Set();
    closed.add(key(sc, sr));

    const dirs = [
        { dc: 0, dr: -1 }, { dc: 0, dr: 1 }, { dc: -1, dr: 0 }, { dc: 1, dr: 0 },
        { dc: -1, dr: -1 }, { dc: 1, dr: -1 }, { dc: -1, dr: 1 }, { dc: 1, dr: 1 }
    ];

    let iters = 0;
    while (open.length > 0 && iters < 800) {
        iters++;
        // Find lowest f
        let bestIdx = 0;
        for (let i = 1; i < open.length; i++) {
            if (open[i].f < open[bestIdx].f) bestIdx = i;
        }
        const cur = open.splice(bestIdx, 1)[0];

        if (cur.c === ec && cur.r === er) {
            // Reconstruct path
            const path = [];
            let node = cur;
            while (node.parent) { path.unshift({ x: node.c * T + T / 2, y: node.r * T + T / 2 }); node = node.parent; }
            return path;
        }

        for (const dir of dirs) {
            const nc = cur.c + dir.dc, nr = cur.r + dir.dr;
            if (!isWalkable(nc, nr)) continue;
            // Diagonal: check both adjacent cells to prevent corner cutting
            if (dir.dc !== 0 && dir.dr !== 0) {
                if (!isWalkable(cur.c + dir.dc, cur.r) || !isWalkable(cur.c, cur.r + dir.dr)) continue;
            }
            const k = key(nc, nr);
            if (closed.has(k)) continue;
            closed.add(k);
            const g = cur.g + (dir.dc !== 0 && dir.dr !== 0 ? 1.414 : 1);
            const h = Math.abs(nc - ec) + Math.abs(nr - er);
            open.push({ c: nc, r: nr, g: g, f: g + h, parent: cur });
        }
    }
    return null; // No path found
}

// Cache paths to avoid recalculating every frame
function getGuardPath(g, tx, ty) {
    const now = Date.now();
    const tc = Math.floor(tx / T), tr = Math.floor(ty / T);
    // Recalculate if target changed or every 500ms
    if (!g._path || !g._pathTarget || g._pathTarget.c !== tc || g._pathTarget.r !== tr || now - (g._pathTime || 0) > 500) {
        g._path = findPath(g.x, g.y, tx, ty);
        g._pathIdx = 0;
        g._pathTarget = { c: tc, r: tr };
        g._pathTime = now;
        // If no path found, try to get unstuck by finding nearest walkable tile
        if (!g._path) {
            g._stuckCount = (g._stuckCount || 0) + 1;
            if (g._stuckCount > 15) {
                // Skip to next patrol point if stuck too long
                if (g.patrolPoints && g.patrolPoints.length > 1) {
                    g.patrolIdx = (g.patrolIdx + 1) % g.patrolPoints.length;
                }
                g._stuckCount = 0;
            }
        } else {
            g._stuckCount = 0;
        }
    }
    return g._path;
}

function moveToward(entity, tx, ty, speed) {
    const dx = tx - entity.x, dy = ty - entity.y;
    const d = Math.hypot(dx, dy);
    if (d < speed) {
        const tc = Math.floor(tx / T), tr = Math.floor(ty / T);
        if (isWalkable(tc, tr)) { entity.x = tx; entity.y = ty; }
        entity._path = null;
        return true;
    }

    // Try pathfinding
    const path = getGuardPath(entity, tx, ty);
    if (path && path.length > 0) {
        // Find current waypoint
        let idx = entity._pathIdx || 0;
        if (idx >= path.length) idx = path.length - 1;

        const wp = path[idx];
        const wdx = wp.x - entity.x, wdy = wp.y - entity.y;
        const wd = Math.hypot(wdx, wdy);

        if (wd < speed * 2) {
            // Reached waypoint, advance
            entity._pathIdx = idx + 1;
            if (entity._pathIdx >= path.length) {
                entity._path = null;
            }
        }

        // Move toward current waypoint
        if (wd > 0.5) {
            const mx = (wdx / wd) * speed;
            const my = (wdy / wd) * speed;
            const margin = 6;
            const nx = entity.x + mx;
            if (isWalkable(Math.floor((nx - margin) / T), Math.floor((entity.y - margin) / T)) &&
                isWalkable(Math.floor((nx + margin) / T), Math.floor((entity.y - margin) / T)) &&
                isWalkable(Math.floor((nx - margin) / T), Math.floor((entity.y + margin) / T)) &&
                isWalkable(Math.floor((nx + margin) / T), Math.floor((entity.y + margin) / T))) {
                entity.x = nx;
            }
            const ny = entity.y + my;
            if (isWalkable(Math.floor((entity.x - margin) / T), Math.floor((ny - margin) / T)) &&
                isWalkable(Math.floor((entity.x + margin) / T), Math.floor((ny - margin) / T)) &&
                isWalkable(Math.floor((entity.x - margin) / T), Math.floor((ny + margin) / T)) &&
                isWalkable(Math.floor((entity.x + margin) / T), Math.floor((ny + margin) / T))) {
                entity.y = ny;
            }
        }
    } else {
        // Fallback: direct move with wall sliding
        const mx = (dx / d) * speed;
        const my = (dy / d) * speed;
        const margin = 6;
        const nx = entity.x + mx;
        if (isWalkable(Math.floor((nx - margin) / T), Math.floor((entity.y - margin) / T)) &&
            isWalkable(Math.floor((nx + margin) / T), Math.floor((entity.y - margin) / T)) &&
            isWalkable(Math.floor((nx - margin) / T), Math.floor((entity.y + margin) / T)) &&
            isWalkable(Math.floor((nx + margin) / T), Math.floor((entity.y + margin) / T))) {
            entity.x = nx;
        }
        const ny = entity.y + my;
        if (isWalkable(Math.floor((entity.x - margin) / T), Math.floor((ny - margin) / T)) &&
            isWalkable(Math.floor((entity.x + margin) / T), Math.floor((ny - margin) / T)) &&
            isWalkable(Math.floor((entity.x - margin) / T), Math.floor((ny + margin) / T)) &&
            isWalkable(Math.floor((entity.x + margin) / T), Math.floor((ny + margin) / T))) {
            entity.y = ny;
        }
    }
    return false;
}

// ============== UPDATE ==============
function update() {
    if (gameState !== 'playing') return;
    frameCount++;

    const diff = difficultyMods[settings.difficulty];

    // Player movement
    let dx = 0, dy = 0;
    if (keys['ArrowLeft'] || keys['KeyA']) dx -= 1;
    if (keys['ArrowRight'] || keys['KeyD']) dx += 1;
    if (keys['ArrowUp'] || keys['KeyW']) dy -= 1;
    if (keys['ArrowDown'] || keys['KeyS']) dy += 1;

    let speed = player.speed;
    const sprinting = keys['ShiftLeft'] || keys['ShiftRight'];
    if (sprinting && stamina > 0 && (dx !== 0 || dy !== 0)) {
        speed = player.speed * 1.8;
        stamina = Math.max(0, stamina - diff.staminaDrain);
    } else if (!sprinting) {
        stamina = Math.min(60, stamina + diff.staminaRegen);
    }
    if (stamina <= 0) speed = player.speed * 0.7;

    if (dx !== 0 && dy !== 0) { dx *= 0.707; dy *= 0.707; }
    if (dx !== 0 || dy !== 0) player.dir = Math.atan2(dy, dx);

    const newX = player.x + dx * speed;
    const newY = player.y + dy * speed;
    const margin = player.size * 0.7;

    if (isWalkable(Math.floor((newX-margin)/T), Math.floor((player.y-margin)/T)) &&
        isWalkable(Math.floor((newX+margin)/T), Math.floor((player.y-margin)/T)) &&
        isWalkable(Math.floor((newX-margin)/T), Math.floor((player.y+margin)/T)) &&
        isWalkable(Math.floor((newX+margin)/T), Math.floor((player.y+margin)/T))) {
        player.x = newX;
    }
    if (isWalkable(Math.floor((player.x-margin)/T), Math.floor((newY-margin)/T)) &&
        isWalkable(Math.floor((player.x+margin)/T), Math.floor((newY-margin)/T)) &&
        isWalkable(Math.floor((player.x-margin)/T), Math.floor((newY+margin)/T)) &&
        isWalkable(Math.floor((player.x+margin)/T), Math.floor((newY+margin)/T))) {
        player.y = newY;
    }

    // Player trail
    if (dx !== 0 || dy !== 0) {
        player.trail.push({ x: player.x, y: player.y, life: 15 });
        if (player.trail.length > 20) player.trail.shift();
        // Footstep dust
        if (frameCount % 8 === 0 && settings.particles) {
            addParticles(player.x, player.y + 8, 'rgba(180,160,120,0.4)', 2, { spread: 2, life: 15, size: 1, sizeVar: 2 });
        }
        // Step sound
        stepTimer++;
        if (stepTimer % 12 === 0) playStep();
    }

    // Collect files
    files.forEach(f => {
        if (!f.collected && dist(player, f) < 22) {
            f.collected = true;
            addExplosion(f.x, f.y);
            showToast(`${f.icon}  ${f.label} COLLECTED!`);
            playCollect();
            triggerShake(3, 8);
            updateUI();
        }
    });

    // Guard AI
    guards.forEach(g => {
        const playerDist = dist(player, g);
        const detectRange = diff.detectRange;

        // Epstein mansion behavior
        if (g.mansionTimer !== undefined) {
            if (g.stopped) {
                g.speechTimer--;
                if (g.speechTimer <= 0) { g.stopped = false; g.goingToMansion = false; }
                g.y += Math.sin(Date.now() * 0.01) * 0.3;
            } else if (g.goingToMansion) {
                if (moveToward(g, 21.5*T, 9.5*T, g.speed * 0.8)) {
                    g.stopped = true; g.speechTimer = 600;
                }
            } else if (playerDist < detectRange) {
                if (g.alertTimer === 0) playAlert();
                g.alertTimer = 120;
                moveToward(g, player.x, player.y, g.speed * 1.2);
                g.mansionTimer = 900;
            } else if (g.alertTimer > 0) {
                g.alertTimer--;
                moveToward(g, player.x, player.y, g.speed);
            } else {
                g.mansionTimer--;
                if (g.mansionTimer <= 0) { g.goingToMansion = true; g.mansionTimer = 900; }
                else {
                    const target = g.patrolPoints[g.patrolIdx];
                    if (moveToward(g, target.x, target.y, g.speed))
                        g.patrolIdx = (g.patrolIdx + 1) % g.patrolPoints.length;
                }
            }
        } else if (playerDist < detectRange) {
            if (g.alertTimer === 0) playAlert();
            g.alertTimer = 120;
            moveToward(g, player.x, player.y, g.speed * 1.2);
        } else if (g.alertTimer > 0) {
            g.alertTimer--;
            moveToward(g, player.x, player.y, g.speed);
            if (g.alertTimer === 0) {
                g._path = null;
                g._stuckCount = 0;
                g._directStuck = 0;
            }
        } else {
            const target = g.patrolPoints[g.patrolIdx];
            if (moveToward(g, target.x, target.y, g.speed))
                g.patrolIdx = (g.patrolIdx + 1) % g.patrolPoints.length;
        }

        // Collision
        if (playerDist < 18) {
            health -= diff.damage;
            killedBy = g.name;
            addParticles(player.x, player.y, '#ff1744', 5, { spread: 4, life: 25 });
            triggerShake(6, 12);
            playHit();
            // Push away (with wall check to prevent clipping)
            const angle = Math.atan2(player.y - g.y, player.x - g.x);
            const pushX = player.x + Math.cos(angle) * 3;
            const pushY = player.y + Math.sin(angle) * 3;
            const pm = player.size * 0.7;
            if (isWalkable(Math.floor((pushX - pm) / T), Math.floor((player.y - pm) / T)) &&
                isWalkable(Math.floor((pushX + pm) / T), Math.floor((player.y - pm) / T)) &&
                isWalkable(Math.floor((pushX - pm) / T), Math.floor((player.y + pm) / T)) &&
                isWalkable(Math.floor((pushX + pm) / T), Math.floor((player.y + pm) / T))) {
                player.x = pushX;
            }
            if (isWalkable(Math.floor((player.x - pm) / T), Math.floor((pushY - pm) / T)) &&
                isWalkable(Math.floor((player.x + pm) / T), Math.floor((pushY - pm) / T)) &&
                isWalkable(Math.floor((player.x - pm) / T), Math.floor((pushY + pm) / T)) &&
                isWalkable(Math.floor((player.x + pm) / T), Math.floor((pushY + pm) / T))) {
                player.y = pushY;
            }
            // Damage vignette
            document.getElementById('damageOverlay').style.opacity = Math.min(1, (100 - health) / 60);
        }
    });

    // Update particles
    particles = particles.filter(p => {
        p.x += p.vx; p.y += p.vy;
        p.life--; p.vx *= 0.94; p.vy *= 0.94;
        return p.life > 0;
    });

    // Trail fade
    player.trail = player.trail.filter(t => { t.life--; return t.life > 0; });

    // Shake decay
    if (shakeDuration > 0) shakeDuration--;
    else shakeAmount = 0;

    // Rain
    updateRain();

    // Health low heartbeat
    if (health < 30 && health > 0 && frameCount % 40 === 0) {
        playTone(50, 0.15, 'sine', 0.06);
    }

    // Death
    if (health <= 0) {
        gameState = 'lost';
        document.getElementById('killerName').textContent = killedBy || 'a guard';
        playLose();
        transitionTo(() => {
            document.getElementById('ui').style.display = 'none';
            document.getElementById('loseScreen').classList.add('active');
        });
    }

    // Win
    if (files.every(f => f.collected) && dist(player, boat) < 25) {
        gameState = 'won';
        const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
        document.getElementById('winTime').textContent = `ESCAPE TIME: ${elapsed}s`;
        lastWinTime = parseFloat(elapsed);
        window.lastWinTime = lastWinTime;
        playWin();
        transitionTo(() => {
            document.getElementById('ui').style.display = 'none';
            if (window.showNameModal) window.showNameModal();
            else document.getElementById('winScreen').classList.add('active');
        });
    }

    updateUI();
}

// ============== DRAW TILE ==============
function drawTile(col, row) {
    const x = col * T, y = row * T;
    const tile = MAP[row][col];
    const time = Date.now();

    switch(tile) {
        case 0: // grass
            ctx.fillStyle = '#2d5a1e';
            ctx.fillRect(x, y, T, T);
            // Detail variation
            const gv = ((col * 17 + row * 31) % 7);
            ctx.fillStyle = gv < 3 ? '#326520' : gv < 5 ? '#287218' : '#2d5a1e';
            ctx.fillRect(x + (gv*3)%T, y + (gv*5)%T, 6, 6);
            // Grass blades
            ctx.strokeStyle = '#3a7528';
            ctx.lineWidth = 1;
            if ((col + row) % 3 === 0) {
                const sway = Math.sin(time/1000 + col) * 2;
                ctx.beginPath(); ctx.moveTo(x+8, y+T); ctx.lineTo(x+8+sway, y+T-10); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(x+20, y+T); ctx.lineTo(x+20+sway, y+T-8); ctx.stroke();
            }
            break;
        case 1: // water
            const wBase = 0.15 + Math.sin(time/2000 + col*0.3 + row*0.5) * 0.05;
            ctx.fillStyle = `rgb(${20+Math.sin(time/3000+col)*5}, ${50+Math.sin(time/2500+row)*8}, ${80+Math.sin(time/2000+col+row)*10})`;
            ctx.fillRect(x, y, T, T);
            // Animated waves
            ctx.strokeStyle = `rgba(100,180,255,${wBase})`;
            ctx.lineWidth = 1;
            for (let w = 0; w < 3; w++) {
                ctx.beginPath();
                for (let wx = 0; wx <= T; wx += 3) {
                    const wy = y + 5 + w*9 + Math.sin(time/600 + (x+wx)*0.05 + w) * 3;
                    wx === 0 ? ctx.moveTo(x+wx, wy) : ctx.lineTo(x+wx, wy);
                }
                ctx.stroke();
            }
            // Sparkle
            if ((col * 13 + row * 7) % 11 === Math.floor(time / 400) % 11) {
                ctx.fillStyle = 'rgba(200,230,255,0.6)';
                ctx.fillRect(x + (col*7)%25, y + (row*11)%25, 2, 2);
            }
            break;
        case 2: // sand
            ctx.fillStyle = '#c2a644';
            ctx.fillRect(x, y, T, T);
            ctx.fillStyle = '#b89a3a';
            if ((col*7+row*3)%5===0) ctx.fillRect(x+8,y+8,4,4);
            ctx.fillStyle = '#d4b84e';
            if ((col*3+row*7)%9===0) ctx.fillRect(x+3,y+18,3,3);
            break;
        case 3: // tree
            ctx.fillStyle = '#2d5a1e';
            ctx.fillRect(x, y, T, T);
            // Trunk
            ctx.fillStyle = '#5a3a1a';
            ctx.fillRect(x+12, y+18, 6, 12);
            // Shadow
            ctx.fillStyle = 'rgba(0,0,0,0.15)';
            ctx.beginPath(); ctx.ellipse(x+15, y+28, 10, 4, 0, 0, Math.PI*2); ctx.fill();
            // Canopy with sway
            const sway = Math.sin(time/1500 + col * 2) * 1.5;
            ctx.fillStyle = '#1a7a1a';
            ctx.beginPath(); ctx.arc(x+15+sway, y+13, 11, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = '#22881a';
            ctx.beginPath(); ctx.arc(x+13+sway*0.8, y+10, 7, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = '#2d9922';
            ctx.beginPath(); ctx.arc(x+18+sway*1.2, y+11, 5, 0, Math.PI*2); ctx.fill();
            break;
        case 4: // building
            ctx.fillStyle = '#555';
            ctx.fillRect(x, y, T, T);
            ctx.fillStyle = '#4a4a4a';
            ctx.fillRect(x+1, y+1, T-2, T-2);
            // Floor pattern
            ctx.strokeStyle = 'rgba(255,255,255,0.04)';
            ctx.lineWidth = 1;
            ctx.strokeRect(x+4, y+4, T-8, T-8);
            break;
        case 5: // wall
            ctx.fillStyle = '#888';
            ctx.fillRect(x, y, T, T);
            ctx.fillStyle = '#777';
            ctx.fillRect(x+2, y+2, T-4, T-4);
            // Brick lines
            ctx.strokeStyle = 'rgba(0,0,0,0.2)';
            ctx.lineWidth = 0.5;
            ctx.beginPath(); ctx.moveTo(x, y+T/2); ctx.lineTo(x+T, y+T/2); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(x+T/2, y); ctx.lineTo(x+T/2, y+T/2); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(x+T/4, y+T/2); ctx.lineTo(x+T/4, y+T); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(x+T*3/4, y+T/2); ctx.lineTo(x+T*3/4, y+T); ctx.stroke();
            break;
        case 6: // dock
            ctx.fillStyle = '#1a3a5c';
            ctx.fillRect(x, y, T, T);
            ctx.fillStyle = '#6a4a2a';
            ctx.fillRect(x+2, y, T-4, T);
            ctx.fillStyle = '#7a5a3a';
            for (let p = 2; p < T; p += 10) ctx.fillRect(x+4, y+p, T-8, 4);
            // Wood grain
            ctx.strokeStyle = 'rgba(0,0,0,0.15)';
            ctx.lineWidth = 0.5;
            ctx.beginPath(); ctx.moveTo(x+6, y); ctx.lineTo(x+6, y+T); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(x+T-6, y); ctx.lineTo(x+T-6, y+T); ctx.stroke();
            break;
        case 7: // temple
            ctx.fillStyle = '#2d5a1e';
            ctx.fillRect(x, y, T, T);
            ctx.fillStyle = '#ddd8c4';
            ctx.fillRect(x+2, y+2, T-4, T-4);
            for (let s = 0; s < 4; s++) {
                ctx.fillStyle = s%2===0 ? '#4488cc' : '#fff';
                ctx.fillRect(x+3, y+3+s*6, T-6, 6);
            }
            ctx.fillStyle = '#daa520';
            ctx.fillRect(x+10, y+1, 10, 3);
            // Shimmer
            const tShim = Math.sin(time/800 + col) * 0.15 + 0.85;
            ctx.fillStyle = `rgba(218,165,32,${tShim * 0.3})`;
            ctx.fillRect(x+2, y+2, T-4, T-4);
            break;
        case 8: // helipad
            ctx.fillStyle = '#555';
            ctx.fillRect(x, y, T, T);
            ctx.fillStyle = '#444';
            ctx.fillRect(x+1, y+1, T-2, T-2);
            ctx.fillStyle = '#ffcc00';
            ctx.fillRect(x+8, y+6, 3, 18);
            ctx.fillRect(x+19, y+6, 3, 18);
            ctx.fillRect(x+8, y+13, 14, 3);
            // Blinking light
            if (Math.floor(time/500) % 2) {
                ctx.fillStyle = 'rgba(255,0,0,0.6)';
                ctx.beginPath(); ctx.arc(x+T/2, y+T/2, 2, 0, Math.PI*2); ctx.fill();
            }
            break;
        case 9: // pool
            ctx.fillStyle = '#2d5a1e';
            ctx.fillRect(x, y, T, T);
            ctx.fillStyle = '#88cccc';
            ctx.fillRect(x+1, y+1, T-2, T-2);
            ctx.fillStyle = '#66bbdd';
            ctx.fillRect(x+3, y+3, T-6, T-6);
            const shimmer = Math.sin(time/500 + col + row);
            ctx.fillStyle = `rgba(150,220,255,${0.3 + shimmer * 0.15})`;
            ctx.fillRect(x+5, y+5, T-10, T-10);
            // Caustics
            ctx.strokeStyle = `rgba(200,240,255,${0.15 + shimmer * 0.1})`;
            ctx.lineWidth = 0.5;
            ctx.beginPath();
            ctx.arc(x+10+Math.sin(time/700)*3, y+10+Math.cos(time/900)*3, 5, 0, Math.PI*2);
            ctx.stroke();
            break;
        case 10: // path
            ctx.fillStyle = '#8a7a5a';
            ctx.fillRect(x, y, T, T);
            ctx.fillStyle = '#7a6a4a';
            ctx.fillRect(x+1, y+1, T-2, T-2);
            ctx.fillStyle = '#9a8a6a';
            if ((col+row)%2===0) { ctx.fillRect(x+5,y+7,2,2); ctx.fillRect(x+18,y+20,2,2); }
            else { ctx.fillRect(x+12,y+4,2,2); ctx.fillRect(x+8,y+22,2,2); }
            break;
        case 11: // sundial
            ctx.fillStyle = '#2d5a1e';
            ctx.fillRect(x, y, T, T);
            ctx.fillStyle = '#ccbbaa';
            ctx.beginPath(); ctx.arc(x+T/2, y+T/2, 12, 0, Math.PI*2); ctx.fill();
            ctx.strokeStyle = '#666'; ctx.lineWidth = 1;
            for (let a = 0; a < 12; a++) {
                const angle = (a/12)*Math.PI*2;
                ctx.beginPath();
                ctx.moveTo(x+T/2+Math.cos(angle)*8, y+T/2+Math.sin(angle)*8);
                ctx.lineTo(x+T/2+Math.cos(angle)*11, y+T/2+Math.sin(angle)*11);
                ctx.stroke();
            }
            // Animated shadow
            const shadowAngle = time / 5000;
            ctx.strokeStyle = '#333'; ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(x+T/2, y+T/2);
            ctx.lineTo(x+T/2+Math.cos(shadowAngle)*7, y+T/2+Math.sin(shadowAngle)*7);
            ctx.stroke();
            break;
    }
}

// ============== DRAW ==============
function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    const scaleX = canvas.width / W;
    const scaleY = canvas.height / H;
    const scale = Math.max(scaleX, scaleY);
    const offsetX = (canvas.width - W * scale) / 2;
    const offsetY = (canvas.height - H * scale) / 2;

    ctx.save();

    // Screen shake
    let shakeX = 0, shakeY = 0;
    if (shakeDuration > 0) {
        shakeX = (Math.random() - 0.5) * shakeAmount * 2;
        shakeY = (Math.random() - 0.5) * shakeAmount * 2;
    }

    ctx.translate(offsetX + shakeX * scale, offsetY + shakeY * scale);
    ctx.scale(scale, scale);

    // Water fill
    ctx.fillStyle = '#1a3a5c';
    ctx.fillRect(-offsetX/scale, -offsetY/scale, canvas.width/scale, canvas.height/scale);

    // Draw map
    for (let r = 0; r < ROWS; r++)
        for (let c = 0; c < COLS; c++)
            drawTile(c, r);

    // ===== Draw boat =====
    const allCollected = files.every(f => f.collected);
    ctx.save();
    ctx.translate(boat.x, boat.y);
    // Bobbing animation
    const bob = Math.sin(Date.now()/800) * 2;
    ctx.translate(0, bob);

    ctx.fillStyle = allCollected ? '#00e676' : '#6a4a2a';
    ctx.beginPath(); ctx.moveTo(-15,5); ctx.lineTo(15,5); ctx.lineTo(12,12); ctx.lineTo(-12,12); ctx.closePath(); ctx.fill();
    ctx.fillStyle = '#8a6a4a'; ctx.fillRect(-1,-15,2,20);
    ctx.fillStyle = allCollected ? '#a5ffc8' : '#ddd';
    ctx.beginPath(); ctx.moveTo(0,-14); ctx.lineTo(10,-3); ctx.lineTo(0,-1); ctx.closePath(); ctx.fill();

    if (allCollected) {
        // Pulsing glow
        const gPulse = Math.sin(Date.now()/300) * 0.3 + 0.7;
        ctx.shadowColor = '#00e676';
        ctx.shadowBlur = 20 * gPulse;
        ctx.strokeStyle = `rgba(0,230,118,${gPulse})`;
        ctx.lineWidth = 2;
        ctx.beginPath(); ctx.arc(0, 0, 20, 0, Math.PI*2); ctx.stroke();
        ctx.shadowBlur = 0;
        // Arrow indicator
        const arrowY = -30 + Math.sin(Date.now()/400) * 4;
        ctx.fillStyle = '#00e676';
        ctx.beginPath(); ctx.moveTo(-5, arrowY); ctx.lineTo(5, arrowY); ctx.lineTo(0, arrowY+8); ctx.closePath(); ctx.fill();
    }
    ctx.restore();

    // ===== Draw files =====
    files.forEach(f => {
        if (f.collected) return;
        ctx.save();
        ctx.translate(f.x, f.y);
        const hover = Math.sin(Date.now()/400) * 3;
        ctx.translate(0, hover);

        // Outer glow ring
        const glow = Math.sin(Date.now()/300) * 0.3 + 0.7;
        ctx.shadowColor = '#ffd740';
        ctx.shadowBlur = 15 * glow;

        // Folder
        ctx.fillStyle = `rgba(255,200,0,${glow})`;
        ctx.fillRect(-9, -7, 18, 16);
        ctx.fillStyle = '#ff9100';
        ctx.fillRect(-9, -9, 11, 4);
        // Lines
        ctx.fillStyle = '#aa6600';
        ctx.fillRect(-6, -3, 12, 1.5);
        ctx.fillRect(-6, 1, 12, 1.5);
        ctx.fillRect(-6, 5, 12, 1.5);
        ctx.shadowBlur = 0;

        // Rotating glow ring
        ctx.strokeStyle = `rgba(255,215,64,${glow * 0.4})`;
        ctx.lineWidth = 1;
        const rotAngle = Date.now() / 1000;
        ctx.beginPath();
        ctx.ellipse(0, 0, 14, 14, rotAngle, 0, Math.PI * 1.5);
        ctx.stroke();

        // SECRET stamp
        ctx.fillStyle = '#ff1744';
        ctx.font = 'bold 6px Orbitron, monospace';
        ctx.textAlign = 'center';
        ctx.fillText('SECRET', 0, -12);

        ctx.restore();
    });

    // ===== Player trail =====
    player.trail.forEach(t => {
        ctx.globalAlpha = t.life / 20;
        ctx.fillStyle = 'rgba(34,136,255,0.3)';
        ctx.beginPath();
        ctx.arc(t.x, t.y, 3, 0, Math.PI * 2);
        ctx.fill();
    });
    ctx.globalAlpha = 1;

    // ===== Draw guards =====
    guards.forEach((g, gIdx) => {
        ctx.save();
        ctx.translate(g.x, g.y);
        const alert = g.alertTimer > 0;

        // Detection range (faded)
        if (alert) {
            const aPulse = Math.sin(Date.now()/200) * 0.05 + 0.1;
            ctx.strokeStyle = `rgba(255,23,68,${aPulse})`;
            ctx.lineWidth = 1;
            ctx.setLineDash([4, 4]);
            ctx.beginPath(); ctx.arc(0, 0, 80, 0, Math.PI*2); ctx.stroke();
            ctx.setLineDash([]);
        }

        // Guard shadow
        ctx.fillStyle = 'rgba(0,0,0,0.2)';
        ctx.beginPath(); ctx.ellipse(0, 14, 10, 4, 0, 0, Math.PI*2); ctx.fill();

        // Guard image
        const imgSize = 36;
        const gImg = guardImages[gIdx % guardImages.length];
        if (gImg.complete && gImg.naturalWidth > 0) {
            const aspect = gImg.naturalWidth / gImg.naturalHeight;
            let dw, dh;
            if (aspect >= 1) {
                dw = imgSize;
                dh = imgSize / aspect;
            } else {
                dh = imgSize;
                dw = imgSize * aspect;
            }
            ctx.drawImage(gImg, -dw/2, -dh/2, dw, dh);
        } else {
            ctx.fillStyle = alert ? '#cc0000' : '#333';
            ctx.beginPath(); ctx.arc(0, 0, g.size, 0, Math.PI*2); ctx.fill();
        }

        // Alert exclamation
        if (alert) {
            const bounce = Math.abs(Math.sin(Date.now()/150)) * 4;
            ctx.fillStyle = '#ff1744';
            ctx.font = 'bold 18px Orbitron, monospace';
            ctx.textAlign = 'center';
            ctx.shadowColor = '#ff1744';
            ctx.shadowBlur = 10;
            ctx.fillText('!', 0, -22 - bounce);
            ctx.shadowBlur = 0;
        }

        // Epstein speech bubble
        if (g.speechTimer > 0 && g.stopped) {
            const mansionFile = files.find(f => f.label === 'Mansion File');
            if (mansionFile && !mansionFile.collected) {
                const pullProgress = Math.min(1, (600 - g.speechTimer) / 180);
                const folderX = 20, folderY = -5;
                ctx.fillStyle = '#c8a84e';
                ctx.fillRect(folderX-10, folderY-8, 20, 16);
                ctx.fillStyle = '#b08a30';
                ctx.fillRect(folderX-10, folderY-8, 10, 4);
                if (pullProgress > 0.1) {
                    const slideOut = Math.min(1, (pullProgress-0.1)/0.6);
                    const imgY = folderY - 4 - slideOut*6;
                    ctx.save();
                    if (slideOut < 1) { ctx.beginPath(); ctx.rect(folderX-10, folderY-30, 22, 30-8+slideOut*18); ctx.clip(); }
                    if (playerImg.complete && playerImg.naturalWidth > 0) ctx.drawImage(playerImg, folderX-8, imgY-8, 16, 16);
                    ctx.restore();
                }
            }
            // Speech bubble
            const txt = 'im omning it';
            ctx.font = 'bold 9px Share Tech Mono, monospace';
            const tw = ctx.measureText(txt).width + 12;
            const bx = -tw/2, by = -42;
            ctx.fillStyle = '#fff'; ctx.strokeStyle = '#333'; ctx.lineWidth = 1.5;
            ctx.beginPath();
            ctx.roundRect(bx, by, tw, 20, 4);
            ctx.fill(); ctx.stroke();
            // Tail
            ctx.beginPath(); ctx.moveTo(-3, by+20); ctx.lineTo(0, by+26); ctx.lineTo(3, by+20); ctx.closePath(); ctx.fill(); ctx.stroke();
            ctx.fillStyle = '#333'; ctx.textAlign = 'center';
            ctx.fillText(txt, 0, by+14);
        }

        // Name label
        ctx.fillStyle = alert ? '#ff5252' : '#fff';
        ctx.strokeStyle = 'rgba(0,0,0,0.9)';
        ctx.lineWidth = 2.5;
        ctx.font = 'bold 8px Orbitron, monospace';
        ctx.textAlign = 'center';
        ctx.strokeText(g.name, 0, 24);
        ctx.fillText(g.name, 0, 24);

        ctx.restore();
    });

    // ===== Draw player =====
    ctx.save();
    ctx.translate(player.x, player.y);

    // Player shadow
    ctx.fillStyle = 'rgba(0,0,0,0.25)';
    ctx.beginPath(); ctx.ellipse(0, 10, 10, 4, 0, 0, Math.PI*2); ctx.fill();

    // Glow when sprinting
    if (keys['ShiftLeft'] || keys['ShiftRight']) {
        ctx.shadowColor = '#2979ff';
        ctx.shadowBlur = 15;
    }

    const pH = 36;
    const pW = pH * (playerImg.naturalWidth / (playerImg.naturalHeight || 1)) || 24;
    if (playerImg.complete && playerImg.naturalWidth > 0) {
        ctx.drawImage(playerImg, -pW/2, -pH + player.size, pW, pH);
    } else {
        ctx.fillStyle = '#2288ff';
        ctx.beginPath(); ctx.arc(0, 0, player.size, 0, Math.PI*2); ctx.fill();
    }
    ctx.shadowBlur = 0;
    ctx.restore();

    // ===== Particles =====
    particles.forEach(p => {
        ctx.globalAlpha = (p.life / p.maxLife) * 0.8;
        ctx.fillStyle = p.color;
        if (p.type === 'circle') {
            ctx.beginPath(); ctx.arc(p.x, p.y, p.size/2, 0, Math.PI*2); ctx.fill();
        } else {
            ctx.fillRect(p.x - p.size/2, p.y - p.size/2, p.size, p.size);
        }
    });
    ctx.globalAlpha = 1;

    // ===== Rain =====
    if (settings.rain && rainDrops) {
        ctx.strokeStyle = 'rgba(180,200,220,0.2)';
        ctx.lineWidth = 0.5;
        rainDrops.forEach(d => {
            ctx.globalAlpha = d.opacity;
            ctx.beginPath();
            ctx.moveTo(d.x, d.y);
            ctx.lineTo(d.x + 2, d.y + d.len);
            ctx.stroke();
        });
        ctx.globalAlpha = 1;
    }

    // ===== Fog of War =====
    if (settings.fogOfWar) {
        const fogGrad = ctx.createRadialGradient(player.x, player.y, 60, player.x, player.y, 180);
        fogGrad.addColorStop(0, 'rgba(0,0,0,0)');
        fogGrad.addColorStop(0.6, 'rgba(0,0,0,0)');
        fogGrad.addColorStop(1, 'rgba(0,0,0,0.5)');
        ctx.fillStyle = fogGrad;
        ctx.fillRect(0, 0, W, H);
    }

    // ===== Location labels =====
    ctx.font = 'bold 8px Orbitron, monospace';
    ctx.textAlign = 'center';
    const labels = [
        { text:'TEMPLE', x:6*T, y:4.3*T }, { text:'MANSION', x:21.5*T, y:8*T },
        { text:'HELIPAD', x:22*T, y:3.5*T }, { text:'POOL', x:14*T, y:12*T },
        { text:'GUEST HOUSE', x:8.5*T, y:11.8*T }, { text:'SUNDIAL', x:13*T, y:7.5*T },
        { text:'DOCK', x:2*T, y:9.5*T },
    ];
    labels.forEach(l => {
        const distToPlayer = Math.hypot(l.x - player.x, l.y - player.y);
        const alpha = Math.min(1, Math.max(0.15, 1 - distToPlayer / 200));
        ctx.fillStyle = `rgba(255,255,255,${alpha * 0.7})`;
        ctx.strokeStyle = `rgba(0,0,0,${alpha * 0.8})`;
        ctx.lineWidth = 2;
        ctx.strokeText(l.text, l.x, l.y);
        ctx.fillText(l.text, l.x, l.y);
    });

    // ===== Mini-map =====
    const mmS = 4;
    const mmX = W - COLS*mmS - 12, mmY = 12;
    // BG
    ctx.fillStyle = 'rgba(0,0,0,0.7)';
    ctx.fillRect(mmX-4, mmY-4, COLS*mmS+8, ROWS*mmS+8);
    ctx.strokeStyle = 'rgba(255,255,255,0.1)';
    ctx.lineWidth = 1;
    ctx.strokeRect(mmX-4, mmY-4, COLS*mmS+8, ROWS*mmS+8);

    for (let r = 0; r < ROWS; r++) {
        for (let c = 0; c < COLS; c++) {
            const tile = MAP[r][c];
            ctx.fillStyle = tile===1?'#1a3a5c':tile===2?'#c2a644':tile===3?'#1a7a1a':
                tile===4?'#555':tile===5?'#888':tile===6?'#6a4a2a':tile===7?'#4488cc':
                tile===8?'#555':tile===9?'#66bbdd':tile===10?'#8a7a5a':tile===11?'#ccbbaa':'#2d5a1e';
            ctx.fillRect(mmX+c*mmS, mmY+r*mmS, mmS, mmS);
        }
    }
    // Player blip (pulsing)
    const blipSize = 2 + Math.sin(Date.now()/300) * 0.5;
    ctx.fillStyle = '#2979ff';
    ctx.beginPath(); ctx.arc(mmX+(player.x/T)*mmS, mmY+(player.y/T)*mmS, blipSize, 0, Math.PI*2); ctx.fill();
    // Files
    files.forEach(f => {
        if (!f.collected) {
            ctx.fillStyle = '#ffd740';
            ctx.fillRect(mmX+(f.x/T)*mmS-1, mmY+(f.y/T)*mmS-1, 2, 2);
        }
    });
    // Guards
    guards.forEach(g => {
        ctx.fillStyle = g.alertTimer > 0 ? '#ff1744' : '#ff6666';
        ctx.fillRect(mmX+(g.x/T)*mmS-1, mmY+(g.y/T)*mmS-1, 2, 2);
    });
    // Boat
    ctx.fillStyle = allCollected ? '#00e676' : '#6a4a2a';
    ctx.fillRect(mmX+(boat.x/T)*mmS-1, mmY+(boat.y/T)*mmS-1, 3, 3);

    ctx.restore();
}

// ============== GAME LOOP ==============
function gameLoop() {
    update();
    draw();
    requestAnimationFrame(gameLoop);
}

// ============== SCREEN TRANSITIONS ==============
function transitionTo(callback) {
    const trans = document.getElementById('screenTransition');
    trans.classList.add('active');
    setTimeout(() => {
        callback();
        setTimeout(() => trans.classList.remove('active'), 50);
    }, 500);
}

// ============== INPUT ==============
document.addEventListener('keydown', e => {
    // Don't block typing in input fields
    if (document.activeElement && document.activeElement.tagName === 'INPUT') return;
    keys[e.code] = true;
    if (e.code === 'Escape' && gameState === 'playing') {
        gameState = 'paused';
        document.getElementById('pauseOverlay').classList.add('active');
    }
    e.preventDefault();
});
document.addEventListener('keyup', e => { keys[e.code] = false; });

// Custom cursor
document.addEventListener('mousemove', e => {
    const cursor = document.getElementById('customCursor');
    cursor.style.left = e.clientX - 12 + 'px';
    cursor.style.top = e.clientY - 12 + 'px';
});

// Touch controls ‚Äî Joystick
let joystickActive = false;
let joystickTouchId = null;
let joystickX = 0, joystickY = 0; // -1 to 1
let sprintToggled = false;

const joystickZone = document.getElementById('joystickZone');
const joystickThumb = document.getElementById('joystickThumb');
const sprintBtn = document.getElementById('btn-sprint');

function getJoystickCenter() {
    const rect = joystickZone.getBoundingClientRect();
    return { x: rect.left + rect.width / 2, y: rect.top + rect.height / 2 };
}

joystickZone.addEventListener('touchstart', e => {
    e.preventDefault();
    const touch = e.changedTouches[0];
    joystickTouchId = touch.identifier;
    joystickActive = true;
    joystickThumb.classList.add('active');
    updateJoystick(touch);
}, {passive: false});

joystickZone.addEventListener('touchmove', e => {
    e.preventDefault();
    for (let t of e.changedTouches) {
        if (t.identifier === joystickTouchId) {
            updateJoystick(t);
            break;
        }
    }
}, {passive: false});

function endJoystick() {
    joystickActive = false;
    joystickTouchId = null;
    joystickX = 0;
    joystickY = 0;
    joystickThumb.style.transform = 'translate(0px, 0px)';
    joystickThumb.classList.remove('active');
    keys['ArrowUp'] = false;
    keys['ArrowDown'] = false;
    keys['ArrowLeft'] = false;
    keys['ArrowRight'] = false;
}

joystickZone.addEventListener('touchend', e => {
    for (let t of e.changedTouches) {
        if (t.identifier === joystickTouchId) { endJoystick(); break; }
    }
}, {passive: false});
joystickZone.addEventListener('touchcancel', endJoystick);

function updateJoystick(touch) {
    const center = getJoystickCenter();
    const maxDist = 45;
    let dx = touch.clientX - center.x;
    let dy = touch.clientY - center.y;
    const dist = Math.sqrt(dx * dx + dy * dy);
    if (dist > maxDist) {
        dx = dx / dist * maxDist;
        dy = dy / dist * maxDist;
    }
    joystickThumb.style.transform = `translate(${dx}px, ${dy}px)`;
    joystickX = dx / maxDist;
    joystickY = dy / maxDist;

    const deadzone = 0.3;
    keys['ArrowUp'] = joystickY < -deadzone;
    keys['ArrowDown'] = joystickY > deadzone;
    keys['ArrowLeft'] = joystickX < -deadzone;
    keys['ArrowRight'] = joystickX > deadzone;
}

// Sprint toggle
sprintBtn.addEventListener('touchstart', e => {
    e.preventDefault();
    sprintToggled = !sprintToggled;
    keys['ShiftLeft'] = sprintToggled;
    sprintBtn.classList.toggle('active', sprintToggled);
}, {passive: false});

canvas.addEventListener('touchstart', e => e.preventDefault(), {passive:false});
canvas.addEventListener('touchmove', e => e.preventDefault(), {passive:false});

// ============== SETTINGS UI ==============
document.querySelectorAll('.toggle').forEach(toggle => {
    toggle.addEventListener('click', () => {
        const setting = toggle.dataset.setting;
        toggle.classList.toggle('on');
        settings[setting] = toggle.classList.contains('on');
        playClick();

        if (setting === 'scanlines') {
            document.getElementById('scanlines').style.display = settings.scanlines ? 'block' : 'none';
        }
    });
});

document.querySelectorAll('.diff-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.diff-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        settings.difficulty = btn.dataset.diff;
        playClick();
    });
});

document.getElementById('musicVolume').addEventListener('input', e => {
    settings.musicVolume = parseInt(e.target.value);
    document.getElementById('musicVolVal').textContent = settings.musicVolume;
});

// ============== BUTTONS ==============
function hideAllScreens() {
    document.querySelectorAll('.game-screen').forEach(s => s.classList.remove('active'));
    document.getElementById('pauseOverlay').classList.remove('active');
    document.getElementById('nameModal').classList.remove('active');
}

document.getElementById('startBtn').addEventListener('click', () => {
    initAudio();
    playClick();
    transitionTo(() => {
        hideAllScreens();
        init();
    });
});

document.getElementById('settingsBtn').addEventListener('click', () => {
    playClick();
    hideAllScreens();
    document.getElementById('settingsScreen').classList.add('active');
});

document.getElementById('settingsBackBtn').addEventListener('click', () => {
    playClick();
    hideAllScreens();
    if (gameState === 'paused') {
        document.getElementById('pauseOverlay').classList.add('active');
        document.getElementById('ui').style.display = 'flex';
    } else {
        document.getElementById('titleScreen').classList.add('active');
    }
});

document.getElementById('resumeBtn').addEventListener('click', () => {
    playClick();
    document.getElementById('pauseOverlay').classList.remove('active');
    gameState = 'playing';
});

document.getElementById('pauseSettingsBtn').addEventListener('click', () => {
    playClick();
    document.getElementById('pauseOverlay').classList.remove('active');
    document.getElementById('settingsScreen').classList.add('active');
});

document.getElementById('pauseQuitBtn').addEventListener('click', () => {
    playClick();
    transitionTo(() => {
        hideAllScreens();
        document.getElementById('ui').style.display = 'none';
        document.getElementById('titleScreen').classList.add('active');
        gameState = 'menu';
    });
});

document.getElementById('restartWinBtn').addEventListener('click', () => {
    playClick();
    if (window.stopLeaderboardListener) window.stopLeaderboardListener();
    transitionTo(() => {
        hideAllScreens();
        init();
    });
});

document.getElementById('restartLoseBtn').addEventListener('click', () => {
    playClick();
    transitionTo(() => {
        hideAllScreens();
        init();
    });
});

document.getElementById('menuLoseBtn').addEventListener('click', () => {
    playClick();
    transitionTo(() => {
        hideAllScreens();
        document.getElementById('ui').style.display = 'none';
        document.getElementById('titleScreen').classList.add('active');
        gameState = 'menu';
    });
});

// Leaderboard buttons
document.getElementById('leaderboardBtnWin').addEventListener('click', () => {
    playClick();
    hideAllScreens();
    document.getElementById('leaderboardScreen').classList.add('active');
    if (window.startLeaderboardListener) window.startLeaderboardListener();
});

document.getElementById('leaderboardBtnTitle').addEventListener('click', () => {
    playClick();
    hideAllScreens();
    document.getElementById('leaderboardScreen').classList.add('active');
    if (window.startLeaderboardListener) window.startLeaderboardListener();
});

document.getElementById('lbPlayBtn').addEventListener('click', () => {
    playClick();
    if (window.stopLeaderboardListener) window.stopLeaderboardListener();
    transitionTo(() => {
        hideAllScreens();
        init();
    });
});

document.getElementById('lbMenuBtn').addEventListener('click', () => {
    playClick();
    if (window.stopLeaderboardListener) window.stopLeaderboardListener();
    hideAllScreens();
    document.getElementById('titleScreen').classList.add('active');
    gameState = 'menu';
});

// ============== TITLE SCREEN BACKGROUND ==============
const titleCanvas = document.getElementById('titleBgCanvas');
const tCtx = titleCanvas.getContext('2d');
let titleParticles = [];

function resizeTitleCanvas() {
    titleCanvas.width = window.innerWidth;
    titleCanvas.height = window.innerHeight;
}
resizeTitleCanvas();
window.addEventListener('resize', resizeTitleCanvas);

// Initialize title particles
for (let i = 0; i < 150; i++) {
    titleParticles.push({
        x: Math.random() * window.innerWidth,
        y: Math.random() * window.innerHeight,
        vx: (Math.random() - 0.5) * 0.5,
        vy: -Math.random() * 0.8 - 0.2,
        size: Math.random() * 2 + 0.5,
        opacity: Math.random() * 0.5 + 0.1,
        color: Math.random() > 0.7 ? '#ff1744' : Math.random() > 0.5 ? '#ffd740' : '#fff'
    });
}

function drawTitleBg() {
    tCtx.clearRect(0, 0, titleCanvas.width, titleCanvas.height);

    // Dark gradient bg
    const grad = tCtx.createRadialGradient(
        titleCanvas.width/2, titleCanvas.height * 0.7, 0,
        titleCanvas.width/2, titleCanvas.height * 0.7, titleCanvas.height * 0.8
    );
    grad.addColorStop(0, '#0d1117');
    grad.addColorStop(0.5, '#0a0e14');
    grad.addColorStop(1, '#000');
    tCtx.fillStyle = grad;
    tCtx.fillRect(0, 0, titleCanvas.width, titleCanvas.height);

    // Ocean at the bottom
    const oceanY = titleCanvas.height * 0.7;
    const oceanGrad = tCtx.createLinearGradient(0, oceanY, 0, titleCanvas.height);
    oceanGrad.addColorStop(0, 'rgba(20,40,70,0.8)');
    oceanGrad.addColorStop(1, 'rgba(10,20,40,0.9)');
    tCtx.fillStyle = oceanGrad;
    tCtx.fillRect(0, oceanY, titleCanvas.width, titleCanvas.height - oceanY);

    // Waves
    const time = Date.now() / 1000;
    for (let w = 0; w < 5; w++) {
        tCtx.strokeStyle = `rgba(60,100,160,${0.08 - w*0.015})`;
        tCtx.lineWidth = 1;
        tCtx.beginPath();
        for (let x = 0; x <= titleCanvas.width; x += 5) {
            const y = oceanY + w * 15 + Math.sin(time * 0.8 + x * 0.008 + w) * (6 - w);
            x === 0 ? tCtx.moveTo(x, y) : tCtx.lineTo(x, y);
        }
        tCtx.stroke();
    }

    // Island silhouette
    const cx = titleCanvas.width / 2;
    tCtx.fillStyle = 'rgba(15,25,15,0.9)';
    tCtx.beginPath();
    tCtx.moveTo(cx - 200, oceanY);
    tCtx.quadraticCurveTo(cx - 150, oceanY - 60, cx - 80, oceanY - 40);
    tCtx.quadraticCurveTo(cx - 30, oceanY - 70, cx, oceanY - 55);
    tCtx.quadraticCurveTo(cx + 40, oceanY - 80, cx + 100, oceanY - 35);
    tCtx.quadraticCurveTo(cx + 160, oceanY - 50, cx + 200, oceanY);
    tCtx.closePath();
    tCtx.fill();

    // Trees on island
    [cx-120, cx-60, cx-20, cx+30, cx+80, cx+140].forEach((tx, i) => {
        const ty = oceanY - 25 - Math.sin(i*2.1)*20 - 10;
        const sway = Math.sin(time + i) * 2;
        tCtx.fillStyle = '#0a1a0a';
        tCtx.fillRect(tx-1, ty+5, 3, 12);
        tCtx.beginPath(); tCtx.arc(tx+sway, ty, 8+i%3, 0, Math.PI*2); tCtx.fill();
    });

    // Temple on island
    tCtx.fillStyle = 'rgba(40,60,90,0.8)';
    tCtx.fillRect(cx-15, oceanY-65, 30, 30);
    tCtx.fillStyle = 'rgba(60,100,150,0.6)';
    tCtx.fillRect(cx-15, oceanY-65, 30, 5);
    tCtx.fillRect(cx-15, oceanY-55, 30, 5);
    // Gold dome
    tCtx.fillStyle = 'rgba(180,140,40,0.7)';
    tCtx.beginPath(); tCtx.arc(cx, oceanY-65, 8, Math.PI, 0); tCtx.fill();

    // Particles
    titleParticles.forEach(p => {
        p.x += p.vx;
        p.y += p.vy;
        if (p.y < -10) { p.y = titleCanvas.height + 10; p.x = Math.random() * titleCanvas.width; }
        if (p.x < -10) p.x = titleCanvas.width + 10;
        if (p.x > titleCanvas.width + 10) p.x = -10;

        tCtx.globalAlpha = p.opacity;
        tCtx.fillStyle = p.color;
        tCtx.beginPath();
        tCtx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
        tCtx.fill();
    });
    tCtx.globalAlpha = 1;

    // Subtle light flicker at top
    const flickerGrad = tCtx.createRadialGradient(cx, 0, 0, cx, 0, titleCanvas.width * 0.5);
    flickerGrad.addColorStop(0, `rgba(255,23,68,${0.02 + Math.sin(time*2)*0.01})`);
    flickerGrad.addColorStop(1, 'transparent');
    tCtx.fillStyle = flickerGrad;
    tCtx.fillRect(0, 0, titleCanvas.width, titleCanvas.height * 0.4);

    requestAnimationFrame(drawTitleBg);
}
drawTitleBg();

// ============== LOADING ==============
let loadProgress = 0;
function simulateLoading() {
    const fill = document.getElementById('loadingFill');
    const interval = setInterval(() => {
        loadProgress += Math.random() * 15 + 5;
        if (loadProgress >= 100) {
            loadProgress = 100;
            fill.style.width = '100%';
            clearInterval(interval);
            setTimeout(() => {
                document.getElementById('loadingScreen').classList.add('fade-out');
                setTimeout(() => document.getElementById('loadingScreen').remove(), 800);
            }, 300);
        } else {
            fill.style.width = loadProgress + '%';
        }
    }, 100);
}
simulateLoading();

// ============== START ==============
init();
gameState = 'menu';
gameLoop();

</script>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getDatabase, ref, push, set, get, onValue, query, orderByChild, equalTo, limitToLast } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyBtPpc6BBMXUgHY5nLYNvIneX3a2U8fj9U",
    authDomain: "island-7defd.firebaseapp.com",
    databaseURL: "https://island-7defd-default-rtdb.firebaseio.com",
    projectId: "island-7defd",
    storageBucket: "island-7defd.firebasestorage.app",
    messagingSenderId: "1014639030990",
    appId: "1:1014639030990:web:1f08a7f020d75dcf6f569f",
    measurementId: "G-V4Y0X9G642"
};

const fbApp = initializeApp(firebaseConfig);
const db = getDatabase(fbApp);

// Expose to global scope for the game script
let lastWinTime = 0;
let lastSubmittedKey = null;
let lbUnsubscribe = null;

window.lastWinTime = 0;

function showNameModal() {
    document.getElementById('nameModal').classList.add('active');
    const input = document.getElementById('nameInput');
    input.value = localStorage.getItem('epstein_player_name') || '';
    // Use longer delay for iPad Safari keyboard activation
    setTimeout(() => { input.focus(); input.click(); }, 300);
}
window.showNameModal = showNameModal;

async function submitScore(name, time, difficulty) {
    const cleanName = name.toUpperCase().substring(0, 16);
    const scoresRef = ref(db, 'leaderboard');
    // Check if this player already has an entry for this difficulty
    const existing = await get(query(scoresRef, orderByChild('name'), equalTo(cleanName)));
    let bestKey = null;
    let bestTime = Infinity;
    if (existing.exists()) {
        existing.forEach(child => {
            const val = child.val();
            if ((val.difficulty || 'normal') === difficulty) {
                if (val.time < bestTime) {
                    bestTime = val.time;
                    bestKey = child.key;
                } else {
                    // Remove duplicate worse entries for same name+difficulty
                    set(ref(db, 'leaderboard/' + child.key), null);
                }
            }
        });
    }
    if (bestKey && time >= bestTime) {
        // Existing score is better or equal, keep it
        return { key: bestKey };
    }
    if (bestKey) {
        // Overwrite existing with better time
        await set(ref(db, 'leaderboard/' + bestKey), {
            name: cleanName,
            time: time,
            difficulty: difficulty,
            timestamp: Date.now()
        });
        return { key: bestKey };
    }
    // No existing entry, create new
    return push(scoresRef, {
        name: cleanName,
        time: time,
        difficulty: difficulty,
        timestamp: Date.now()
    });
}

function formatTime(secs) {
    const m = Math.floor(secs / 60);
    const s = (secs % 60).toFixed(1);
    return m > 0 ? `${m}:${s.padStart(4, '0')}` : `${s}s`;
}

function startLeaderboardListener() {
    stopLeaderboardListener();
    const scoresRef = query(ref(db, 'leaderboard'), orderByChild('time'), limitToLast(50));
    lbUnsubscribe = onValue(scoresRef, (snapshot) => {
        const rows = document.getElementById('lbRows');
        if (!rows) return;
        const entries = [];
        snapshot.forEach(child => {
            entries.push({ key: child.key, ...child.val() });
        });
        // Sort ascending (fastest first) ‚Äî limitToLast + orderByChild gives ascending
        entries.sort((a, b) => a.time - b.time);

        rows.innerHTML = '';
        entries.forEach((entry, i) => {
            const row = document.createElement('div');
            row.className = 'lb-row' + (entry.key === lastSubmittedKey ? ' you' : '');
            row.innerHTML = `
                <div class="lb-rank">${i + 1}</div>
                <div class="lb-name">${escHtml(entry.name)}</div>
                <div class="lb-diff ${entry.difficulty || 'normal'}">${(entry.difficulty || 'normal').toUpperCase()}</div>
                <div class="lb-time">${formatTime(entry.time)}</div>
            `;
            rows.appendChild(row);
        });

        if (entries.length === 0) {
            rows.innerHTML = '<div style="color:rgba(255,255,255,0.3); padding:20px; text-align:center; font-size:12px;">No scores yet. Be the first!</div>';
        }
    });
}
window.startLeaderboardListener = startLeaderboardListener;

function stopLeaderboardListener() {
    if (lbUnsubscribe) {
        lbUnsubscribe();
        lbUnsubscribe = null;
    }
}
window.stopLeaderboardListener = stopLeaderboardListener;

function escHtml(s) {
    const d = document.createElement('div');
    d.textContent = s;
    return d.innerHTML;
}

// Name submit
document.getElementById('submitNameBtn').addEventListener('click', () => {
    const input = document.getElementById('nameInput');
    let name = input.value.trim();
    if (!name) name = 'ANON';
    localStorage.setItem('epstein_player_name', name);

    const time = window.lastWinTime || 0;
    const difficulty = window.settings ? window.settings.difficulty : 'normal';

    submitScore(name, time, difficulty).then((result) => {
        lastSubmittedKey = result.key;
        document.getElementById('nameModal').classList.remove('active');
        document.getElementById('winScreen').classList.add('active');
    }).catch(() => {
        document.getElementById('nameModal').classList.remove('active');
        document.getElementById('winScreen').classList.add('active');
    });
});

document.getElementById('nameInput').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') document.getElementById('submitNameBtn').click();
});

</script>
</body>
</html>
