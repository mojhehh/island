<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>CASINO ROYALE</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='80' font-size='80'>🎰</text></svg>" type="image/svg+xml">
<script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.20.0/matter.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@300;400;600;700&display=swap');
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
button,select,input,[onclick]{touch-action:manipulation;cursor:pointer;}
:root{
  --bg:#0a0a1a;--surface:#111128;--surface2:#1a1a3e;--border:#2a2a5e;
  --gold:#ffd700;--neon:#00f0ff;--neon2:#ff00e5;--green:#00ff88;--red:#ff3355;
  --text:#e8e8ff;--text2:#8888aa;
}
html,body{height:100%;height:100dvh;overflow:hidden;overflow-x:hidden;background:var(--bg);color:var(--text);font-family:'Inter',sans-serif;width:100%;max-width:100vw;}
.catalog-card {
  width: 140px;
  height: 160px;
  background: var(--surface2);
  border-radius: 16px;
  border: 2px solid var(--border);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  font-family: 'Orbitron', sans-serif;
  font-size: 18px;
  font-weight: 700;
  color: var(--text2);
  cursor: pointer;
  transition: all .2s;
  box-shadow: 0 4px 24px rgba(0,240,255,.08);
  gap: 8px;
}
.catalog-card .icon {
  font-size: 48px;
  margin-bottom: 8px;
}
.catalog-card:hover {
  border-color: var(--neon);
  color: var(--neon);
  background: var(--surface);
  transform: translateY(-6px) scale(1.04);
  b.catalog-card{position:relative;overflow:visible;}
.cup-slot{display:flex;flex-direction:column;align-items:center;cursor:pointer;user-select:none;width:80px;}
.cup-slot:hover{filter:brightness(1.2);}
.cup-inner{display:flex;flex-direction:column;align-items:center;position:relative;}
.cup{font-size:72px;transition:transform .3s ease;user-select:none;}
.cup.lifted{transform:translateY(-40px);}
.cup-ball{font-size:28px;margin-top:-8px;opacity:0;transition:opacity .2s;}
.cup-slot.disabled{pointer-events:none;opacity:.7;}

#topNav{position:fixed;top:0;left:0;right:0;height:50px;background:linear-gradient(180deg,#15153a,#0d0d25);
  border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 10px;z-index:1000;gap:2px;}
#topNav .logo{font-family:'Orbitron';font-weight:900;font-size:16px;
  background:linear-gradient(135deg,var(--gold),var(--neon));-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;margin-right:6px;white-space:nowrap;flex-shrink:0;cursor:pointer;}
.nav-cat{position:relative;flex-shrink:0;}
.nav-cat-btn{padding:6px 10px;border:none;border-radius:6px;cursor:pointer;font-size:11px;font-weight:700;
  background:transparent;color:var(--text2);transition:all .2s;font-family:'Inter',sans-serif;white-space:nowrap;display:flex;align-items:center;gap:4px;}
.nav-cat-btn:hover,.nav-cat.open .nav-cat-btn{background:var(--surface2);color:var(--text);}
.nav-cat-btn .cat-icon{font-size:13px;}
.nav-cat-btn .cat-arrow{font-size:8px;opacity:.5;transition:transform .2s;}
.nav-cat.open .cat-arrow{transform:rotate(180deg);}
.nav-cat-btn.has-active{color:var(--neon);}
.nav-dropdown{display:none;position:absolute;top:100%;left:0;min-width:160px;background:linear-gradient(180deg,#1a1a40,#111130);
  border:1px solid var(--border);border-radius:8px;padding:4px;z-index:1001;box-shadow:0 8px 32px rgba(0,0,0,.6);margin-top:4px;}
.nav-cat.open .nav-dropdown{display:block;}
.nav-btn{padding:6px 10px;border:none;border-radius:6px;cursor:pointer;font-size:11px;font-weight:600;
  background:transparent;color:var(--text2);transition:all .15s;font-family:'Inter',sans-serif;white-space:nowrap;display:block;width:100%;text-align:left;}
.nav-btn:hover{background:var(--surface2);color:var(--text);}
.nav-btn.active{background:linear-gradient(135deg,#1a1a5e,#2a1a4e);color:var(--neon);
  box-shadow:0 0 15px rgba(0,240,255,.15);border:1px solid rgba(0,240,255,.3);}
.nav-btn .icon{font-size:13px;margin-right:5px;}
.nav-btn-inline{padding:6px 10px;border:none;border-radius:6px;cursor:pointer;font-size:11px;font-weight:600;
  background:transparent;color:var(--text2);transition:all .15s;font-family:'Inter',sans-serif;white-space:nowrap;flex-shrink:0;}
.nav-btn-inline:hover{background:var(--surface2);color:var(--text);}
.nav-btn-inline.active{background:linear-gradient(135deg,#1a1a5e,#2a1a4e);color:var(--neon);
  box-shadow:0 0 15px rgba(0,240,255,.15);border:1px solid rgba(0,240,255,.3);}
.nav-btn-inline .icon{font-size:13px;margin-right:3px;}
.nav-label{display:inline;}

.games-category{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px;overflow:hidden;}
.games-category-title{font-family:'Orbitron';font-size:14px;font-weight:900;color:var(--neon);letter-spacing:1px;margin-bottom:12px;display:flex;align-items:center;gap:8px;}
.games-category-title .icon{font-size:20px;}
.games-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:8px;}
.game-btn{padding:12px;border:1px solid var(--border);border-radius:8px;background:var(--bg);color:var(--text2);cursor:pointer;font-size:11px;font-weight:700;font-family:'Orbitron';transition:all .2s;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;white-space:nowrap;text-align:center;}
.game-btn .game-icon{font-size:24px;}
.game-btn:hover{border-color:var(--neon);background:var(--surface);color:var(--text);box-shadow:0 0 12px rgba(0,240,255,.2);transform:translateY(-2px);}
.game-btn:active{transform:scale(0.98);}

#balanceDisplay{margin-left:auto;display:flex;align-items:center;gap:8px;flex-shrink:0;}
#balanceDisplay .bal{font-family:'Orbitron';font-size:16px;color:var(--gold);text-shadow:0 0 10px rgba(255,215,0,.4);}
#balanceDisplay .add-btn{padding:5px 10px;border:none;border-radius:6px;cursor:pointer;
  background:linear-gradient(135deg,#1a5a1a,#0a3a0a);color:var(--green);font-weight:700;font-size:12px;
  border:1px solid rgba(0,255,136,.3);transition:all .2s;font-family:'Inter',sans-serif;}
#balanceDisplay .add-btn:hover{background:linear-gradient(135deg,#2a7a2a,#1a5a1a);box-shadow:0 0 15px rgba(0,255,136,.2);}

.htp-box{background:linear-gradient(135deg,rgba(0,240,255,.05),rgba(255,0,229,.03));border:1px solid rgba(0,240,255,.15);
  border-radius:10px;padding:0;margin:6px 0;max-width:420px;overflow:hidden;font-size:12px;line-height:1.5;transition:all .3s;}
.htp-toggle{display:flex;align-items:center;gap:6px;padding:8px 12px;cursor:pointer;color:var(--neon);font-weight:600;font-size:11px;
  font-family:'Orbitron';letter-spacing:1px;background:transparent;border:none;width:100%;text-align:left;}
.htp-toggle:hover{background:rgba(0,240,255,.05);}
.htp-toggle .htp-arrow{transition:transform .2s;font-size:10px;}
.htp-box.open .htp-arrow{transform:rotate(90deg);}
.htp-content{display:none;padding:0 12px 10px 12px;color:var(--text2);}
.htp-box.open .htp-content{display:block;}
.htp-content ul{margin:4px 0 4px 16px;padding:0;}
.htp-content li{margin:2px 0;}
.htp-content strong{color:var(--text);}

.game-panel{position:fixed;top:50px;left:0;right:0;bottom:0;display:none;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;padding:16px;padding-bottom:calc(16px + env(safe-area-inset-bottom,0px));}
.game-panel.active{display:flex;flex-direction:column;align-items:center;gap:12px;}

.bet-controls{display:flex;align-items:center;gap:10px;padding:12px 16px;background:var(--surface);
  border-radius:12px;border:1px solid var(--border);}
.bet-input{width:120px;padding:8px 12px;border-radius:8px;border:1px solid var(--border);
  background:var(--bg);color:var(--gold);font-family:'Orbitron';font-size:14px;text-align:right;outline:none;}
.bet-input:focus{border-color:var(--neon);box-shadow:0 0 10px rgba(0,240,255,.2);}
.bet-btn{padding:8px 14px;border:none;border-radius:6px;cursor:pointer;font-weight:700;font-size:12px;
  transition:all .15s;font-family:'Inter',sans-serif;}
.bet-half{background:#2a2a5e;color:var(--text);}
.bet-double{background:#2a2a5e;color:var(--text);}
.bet-half:hover,.bet-double:hover{background:#3a3a7e;}
.action-btn{padding:12px 32px;border:none;border-radius:10px;cursor:pointer;font-weight:700;font-size:15px;
  font-family:'Orbitron';transition:all .2s;text-transform:uppercase;letter-spacing:1px;}
.action-btn.primary{background:linear-gradient(135deg,#00cc66,#009944);color:#fff;
  box-shadow:0 4px 20px rgba(0,204,102,.3);}
.action-btn.primary:hover{transform:translateY(-2px);box-shadow:0 6px 25px rgba(0,204,102,.4);}
.action-btn.primary:active{transform:translateY(0);}
.action-btn:disabled{opacity:.4;cursor:not-allowed;transform:none!important;}
.action-btn.danger{background:linear-gradient(135deg,#cc3355,#991133);color:#fff;
  box-shadow:0 4px 20px rgba(204,51,85,.3);}

#slotsPanel{flex-direction:column;align-items:center;justify-content:center;gap:24px;
  background:radial-gradient(ellipse at center,#15153a 0%,#0a0a1a 70%);}
.slots-machine{position:relative;background:linear-gradient(180deg,#1a1a4e,#111138);
  border-radius:20px;border:2px solid var(--border);padding:30px;
  box-shadow:0 0 60px rgba(0,240,255,.08),inset 0 0 60px rgba(0,0,0,.5);}
.slots-header{text-align:center;font-family:'Orbitron';font-size:28px;font-weight:900;
  background:linear-gradient(135deg,var(--gold),#ff8800);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;
  margin-bottom:20px;text-shadow:0 0 20px rgba(255,215,0,.3);}
.reels-container{display:flex;gap:8px;justify-content:center;margin-bottom:20px;position:relative;}
.reel-window{width:100px;height:280px;overflow:hidden;border-radius:12px;
  background:#08081a;border:2px solid var(--border);position:relative;}
.reel-window::before,.reel-window::after{content:'';position:absolute;left:0;right:0;height:40%;z-index:2;pointer-events:none;}
.reel-window::before{top:0;background:linear-gradient(180deg,rgba(8,8,26,.95),transparent);}
.reel-window::after{bottom:0;background:linear-gradient(0deg,rgba(8,8,26,.95),transparent);}
.reel-strip{display:flex;flex-direction:column;transition:transform .5s cubic-bezier(.2,.8,.3,1);}
.reel-symbol{width:100px;height:93px;display:flex;align-items:center;justify-content:center;font-size:48px;}
.payline-indicator{position:absolute;left:-8px;right:-8px;top:50%;transform:translateY(-50%);
  height:3px;background:var(--gold);box-shadow:0 0 10px var(--gold);z-index:3;border-radius:2px;}
.slots-info{text-align:center;color:var(--text2);font-size:13px;margin-top:8px;}

#crashPanel{flex-direction:column;align-items:center;justify-content:center;gap:20px;
  background:radial-gradient(ellipse at bottom,#0a1a2a 0%,#0a0a1a 70%);}
.crash-container{position:relative;width:min(700px,90vw);height:min(400px,50vh);
  background:var(--surface);border-radius:16px;border:1px solid var(--border);overflow:hidden;}
.crash-canvas{width:100%;height:100%;}
.crash-multiplier{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
  font-family:'Orbitron';font-weight:900;font-size:72px;color:#fff;text-shadow:0 0 40px rgba(0,240,255,.5);
  pointer-events:none;transition:color .3s;}
.crash-multiplier.crashed{color:var(--red);text-shadow:0 0 40px rgba(255,51,85,.5);animation:crashShake .3s ease;}
.crash-status{font-family:'Orbitron';font-size:14px;color:var(--text2);text-align:center;}
@keyframes crashShake{0%,100%{transform:translate(-50%,-50%)}25%{transform:translate(-48%,-52%)}75%{transform:translate(-52%,-48%)}}

#roulettePanel{flex-direction:column;align-items:center;justify-content:center;gap:20px;
  background:radial-gradient(ellipse at center,#1a0a1a 0%,#0a0a1a 70%);}
.roulette-wrapper{position:relative;}
.roulette-canvas{border-radius:50%;box-shadow:0 0 60px rgba(255,0,229,.15),0 0 120px rgba(255,0,229,.05);}
.roulette-pointer{position:absolute;top:-18px;left:50%;transform:translateX(-50%);
  width:0;height:0;border-left:14px solid transparent;border-right:14px solid transparent;
  border-top:24px solid var(--gold);filter:drop-shadow(0 0 8px rgba(255,215,0,.6));z-index:5;}
.roulette-result{font-family:'Orbitron';font-size:24px;font-weight:700;text-align:center;min-height:36px;}
.roulette-bets{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;max-width:500px;}
.roul-bet-btn{padding:10px 20px;border:2px solid var(--border);border-radius:8px;cursor:pointer;
  font-weight:700;font-size:14px;transition:all .2s;background:var(--surface);color:var(--text);font-family:'Inter',sans-serif;}
.roul-bet-btn:hover{border-color:var(--neon);box-shadow:0 0 15px rgba(0,240,255,.15);}
.roul-bet-btn.selected{border-color:var(--neon);background:rgba(0,240,255,.1);color:var(--neon);}
.roul-bet-btn.red-btn{border-color:#cc3333;}
.roul-bet-btn.red-btn.selected{background:rgba(204,51,51,.2);color:#ff5555;border-color:#ff5555;}
.roul-bet-btn.black-btn{border-color:#444;}
.roul-bet-btn.black-btn.selected{background:rgba(255,255,255,.1);color:#fff;border-color:#888;}
.roul-bet-btn.green-btn{border-color:#00aa44;}
.roul-bet-btn.green-btn.selected{background:rgba(0,170,68,.2);color:var(--green);border-color:var(--green);}

#casesPanel{flex-direction:column;align-items:flex-start;justify-content:flex-start;gap:14px;
  background:radial-gradient(ellipse at top,#1a1a0a 0%,#0a0a1a 70%);overflow-y:auto;padding:70px 16px 20px!important;}
.case-selector{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;max-height:320px;overflow-y:auto;
  padding:8px 4px;border:1px solid var(--border);border-radius:12px;background:rgba(0,0,0,.3);width:100%;
  scrollbar-width:thin;scrollbar-color:var(--neon) transparent;}
.case-selector::-webkit-scrollbar{width:6px;}
.case-selector::-webkit-scrollbar-thumb{background:var(--neon);border-radius:3px;}
.case-selector::after{content:'↕ Scroll for more cases';display:block;width:100%;text-align:center;
  font-size:10px;color:var(--text2);padding:4px 0;flex-shrink:0;}
.case-card{width:120px;padding:12px 8px;border-radius:12px;border:2px solid var(--border);
  background:var(--surface);cursor:pointer;text-align:center;transition:all .2s;}
.case-card:hover{transform:translateY(-4px);border-color:var(--gold);}
.case-card.selected{border-color:var(--gold);box-shadow:0 0 20px rgba(255,215,0,.2);}
.case-card .case-icon{font-size:32px;margin-bottom:4px;}
.case-card .case-name{font-weight:700;font-size:12px;margin-bottom:2px;}
.case-card .case-price{color:var(--gold);font-family:'Orbitron';font-size:11px;}
.case-card.limited{border-color:#ff4500;background:linear-gradient(135deg,rgba(255,69,0,.12),rgba(255,215,0,.08));position:relative;overflow:hidden;}
.case-card.limited::before{content:'LIMITED';position:absolute;top:4px;right:-18px;background:linear-gradient(90deg,#ff4500,#ff8c00);color:#fff;font-size:7px;font-weight:900;padding:1px 20px;transform:rotate(30deg);font-family:'Orbitron';letter-spacing:0.5px;}
.case-card.limited:hover{border-color:#ff8c00;box-shadow:0 0 20px rgba(255,69,0,.3);}
.case-card.limited.selected{border-color:#ff4500;box-shadow:0 0 25px rgba(255,69,0,.4);}
.case-card.limited .case-name{color:#ff8c00;}
.case-opener{position:relative;width:min(700px,92vw);height:120px;background:var(--surface);
  border-radius:12px;border:1px solid var(--border);overflow:hidden;}
.case-strip{display:flex;position:absolute;top:0;height:100%;transition:transform 4s cubic-bezier(.08,.82,.17,1);}
.case-item{width:120px;height:120px;display:flex;flex-direction:column;align-items:center;justify-content:center;
  flex-shrink:0;border-right:1px solid var(--border);font-size:11px;font-weight:700;gap:2px;position:relative;}
.case-item .item-icon{font-size:36px;}
.case-item .item-rarity{position:absolute;bottom:0;left:0;right:0;height:3px;}
.case-pointer{position:absolute;top:0;bottom:0;left:50%;transform:translateX(-50%);
  width:3px;background:var(--gold);box-shadow:0 0 10px var(--gold);z-index:5;}
.case-won{font-family:'Orbitron';font-size:18px;font-weight:700;text-align:center;min-height:32px;}
.case-won-detail{font-size:11px;color:var(--text2);text-align:center;}

.case-opener{position:relative;width:min(700px,92vw);height:120px;background:var(--surface);
  border-radius:12px;border:1px solid var(--border);overflow:hidden;transition:border-color 0.5s,box-shadow 0.5s;}
.case-opener.rare-reveal{border-color:#8847ff;box-shadow:0 0 30px rgba(136,71,255,.4);}
.case-opener.legendary-reveal{border-color:#ffd700;box-shadow:0 0 40px rgba(255,215,0,.5),0 0 80px rgba(255,215,0,.2);animation:legendaryPulse 0.5s ease 3;}
@keyframes legendaryPulse{0%,100%{box-shadow:0 0 40px rgba(255,215,0,.5)}50%{box-shadow:0 0 60px rgba(255,215,0,.8),0 0 120px rgba(255,215,0,.3)}}
.case-item.highlighted{animation:itemHighlight 0.5s ease;z-index:2;}
@keyframes itemHighlight{0%{transform:scale(1)}50%{transform:scale(1.08)}100%{transform:scale(1)}}
.case-recent-item{flex-shrink:0;padding:4px 8px;border-radius:6px;background:var(--surface);border:1px solid var(--border);
  font-size:10px;display:flex;align-items:center;gap:4px;white-space:nowrap;animation:recentSlide 0.3s ease;}
@keyframes recentSlide{from{opacity:0;transform:translateX(-10px)}to{opacity:1;transform:translateX(0)}}

.rarity-consumer{color:#b0c3d9!important;}
.rarity-industrial{color:#5e98d9!important;}
.rarity-milspec{color:#4b69ff!important;}
.rarity-restricted{color:#8847ff!important;}
.rarity-classified{color:#d32ce6!important;}
.rarity-covert{color:#eb4b4b!important;}
.rarity-legendary{color:#ffd700!important;}

#inventoryOverlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.85);
  z-index:2000;display:none;flex-direction:column;align-items:center;padding:20px;overflow-y:auto;}
#inventoryOverlay.show{display:flex;}
.inv-header{display:flex;align-items:center;justify-content:space-between;width:100%;max-width:900px;
  margin-bottom:16px;}
.inv-title{font-family:'Orbitron';font-size:22px;font-weight:900;
  background:linear-gradient(135deg,var(--gold),var(--neon));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.inv-close{padding:8px 20px;border:1px solid var(--border);border-radius:8px;background:var(--surface);
  color:var(--text);cursor:pointer;font-weight:700;font-size:14px;transition:all .2s;}
.inv-close:hover{border-color:var(--red);color:var(--red);}
.inv-tabs{display:flex;gap:8px;margin-bottom:16px;}
.inv-tab{padding:8px 18px;border:1px solid var(--border);border-radius:8px;background:var(--surface);
  color:var(--text2);cursor:pointer;font-weight:600;font-size:13px;transition:all .2s;}
.inv-tab.active{border-color:var(--neon);color:var(--neon);background:rgba(0,240,255,.08);}
.inv-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px;
  width:100%;max-width:900px;}
.inv-item{background:var(--surface);border:1px solid var(--border);border-radius:10px;
  padding:12px;text-align:center;cursor:pointer;transition:all .2s;position:relative;}
.inv-item:hover{border-color:var(--gold);transform:translateY(-2px);}
.inv-item .ii-icon{font-size:32px;margin-bottom:4px;}
.inv-item .ii-name{font-size:11px;font-weight:700;margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.inv-item .ii-value{font-family:'Orbitron';font-size:12px;color:var(--gold);}
.inv-item .ii-demand{font-size:9px;margin-top:2px;}
.inv-item .ii-rarity-bar{position:absolute;bottom:0;left:0;right:0;height:3px;border-radius:0 0 10px 10px;}
.inv-sell-btn{margin-top:6px;padding:4px 12px;border:none;border-radius:4px;font-size:10px;
  font-weight:700;cursor:pointer;background:var(--red);color:#fff;transition:all .15s;}
.inv-sell-btn:hover{background:#ff4466;}
.inv-empty{grid-column:1/-1;text-align:center;padding:40px;color:var(--text2);font-size:14px;}

.market-stats{display:flex;gap:16px;align-items:center;justify-content:center;width:100%;max-width:900px;
  margin-bottom:12px;padding:10px;background:var(--surface);border-radius:10px;border:1px solid var(--border);}
.market-stat{text-align:center;}
.market-stat .ms-label{font-size:9px;color:var(--text2);text-transform:uppercase;letter-spacing:1px;}
.market-stat .ms-val{font-family:'Orbitron';font-size:14px;font-weight:700;}

#plinkoPanel{flex-direction:row;background:radial-gradient(ellipse at center,#0a1a2a 0%,#0a0a1a 70%);}

@media (max-width:1024px){
  #topNav{overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;gap:1px;flex-wrap:nowrap;padding:0 6px;}
  #topNav::-webkit-scrollbar{display:none;}
  .nav-label{display:none;}
  .nav-btn-inline{font-size:0;padding:6px 8px;}
  .nav-btn-inline .icon{font-size:15px;margin-right:0;}
  #balanceDisplay{gap:3px;margin-left:auto;flex-shrink:1;min-width:0;}
  #balanceDisplay .bal{font-size:12px;white-space:nowrap;}
  #balanceDisplay .add-btn{display:none;}
  .daily-bonus-btn{font-size:8px!important;padding:2px 6px!important;white-space:nowrap;}
  .user-name{display:none;}
  .user-info{gap:3px;margin-left:2px;}
  .user-avatar{width:30px!important;height:30px!important;}
  .logout-btn{width:26px;height:26px;font-size:12px;}
  #muteBtn{padding:3px 5px!important;font-size:11px!important;}
  .game-panel{padding:12px;justify-content:flex-start!important;}
  #plinkoPanel{flex-direction:column;}
  #luckPanel{overflow:hidden!important;padding:0!important;}
  #casesPanel{padding-top:12px!important;}
  #gameCatalog{padding-top:16px;padding-bottom:calc(80px + env(safe-area-inset-bottom,0px));}
  .plinko-sidebar{width:100%;order:2;padding:12px}
  .plinko-canvas-wrap{max-width:calc(100vw - 40px);width:100%;height:min(420px,50vh)}
  .catalog-card{width:110px;height:120px}
  .user-avatar{width:36px;height:36px;font-size:18px}
  .pyl-lobby{padding-top:40px;}
  .pyl-modes{grid-template-columns:repeat(2,1fr);}
  .pyl-title{font-size:22px;}
  .bet-controls{flex-wrap:wrap;gap:6px;padding:8px 10px;}
  .bet-input{width:80px;font-size:12px;padding:6px 8px;}
  .action-btn{padding:10px 20px;font-size:13px;}
  .crash-container{max-height:40vh;width:min(700px,95vw);}
  .crash-multiplier{font-size:48px!important;}
  .slots-machine{padding:12px;}
  .reel-window{width:70px;height:180px;}
  .reel-symbol{width:70px;height:60px;font-size:32px;}
  .roulette-canvas{width:min(300px,70vw)!important;height:min(300px,70vw)!important;}
  .case-selector{gap:6px;}
  .case-card{width:90px;padding:8px 4px;}
  .case-card .case-icon{font-size:24px;}
  .case-card .case-name{font-size:10px;}
  .case-opener{height:100px;}
  .case-item{width:100px;height:100px;}
  .htp-box{max-width:100%;margin:4px 0;}
  .tower-cell{width:60px!important;height:50px!important;}
  .mine-cell{width:50px!important;height:50px!important;}
  .keno-num{width:42px!important;height:42px!important;font-size:11px!important;}
  .scratch-cell{width:72px!important;height:72px!important;font-size:28px!important;}
  .stock-chart-wrap{height:200px!important;}
  .horse-track{max-width:95vw;}
  #chatPanel{right:8px;width:min(340px, calc(100vw - 16px));max-height:min(460px, 70vh);}
  #chatToggleBtn{right:10px;bottom:10px;}
  .nav-dropdown{max-width:calc(100vw - 20px);}
}
@media (max-width:480px){
  #topNav .logo{font-size:12px;margin-right:2px;}
  #balanceDisplay .bal{font-size:11px;}
  #balanceDisplay .add-btn{font-size:9px;padding:2px 5px;}
  #chatPanel{right:4px;left:4px;width:auto;bottom:66px;}
  #gamesMenuOverlay{padding-top:50px;}
  .games-grid{grid-template-columns:repeat(auto-fill,minmax(80px,1fr));gap:6px;}
  .game-btn{padding:10px;font-size:10px;}
  .game-btn .game-icon{font-size:20px;}
  .game-panel{padding:8px;}
  .bet-controls{padding:6px 8px;}
  .bet-input{width:60px;font-size:11px;padding:4px 6px;}
  .action-btn{padding:8px 14px;font-size:12px;}
  .catalog-card{width:90px;height:100px;font-size:14px;}
  .catalog-card .icon{font-size:32px;margin-bottom:4px;}
}

.user-avatar{border-radius:50% !important;overflow:hidden !important;box-sizing:border-box !important;touch-action:manipulation;-webkit-tap-highlight-color:transparent}
.user-avatar, .user-avatar *{border-radius:50% !important;overflow:hidden !important}
.user-avatar img{width:100%;height:100%;object-fit:cover;display:block}
#gameCatalog{ -webkit-overflow-scrolling: touch; }

.plinko-sidebar{width:280px;padding:20px;display:flex;flex-direction:column;gap:16px;
  background:var(--surface);border-right:1px solid var(--border);overflow-y:auto;}
.plinko-sidebar label{font-size:13px;font-weight:600;color:var(--text2);margin-bottom:4px;display:block;}
.plinko-sidebar select,.plinko-sidebar input[type="number"]{width:100%;padding:8px 12px;border-radius:8px;
  border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:14px;outline:none;font-family:'Inter',sans-serif;}
.plinko-sidebar select:focus,.plinko-sidebar input:focus{border-color:var(--neon);}
.plinko-main{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative;}
.plinko-canvas-wrap{position:relative;width:760px;max-width:calc(100vw - 320px);height:570px;}
#plinkoCanvas{border-radius:12px;display:block;}
.plinko-bins{display:flex;gap:1%;justify-content:center;margin:4px auto 0;}
.plinko-bin{flex:1;text-align:center;padding:4px 0;border-radius:4px;font-size:11px;font-weight:700;
  color:#111;transition:transform .2s;min-width:0;}
.plinko-bin.bounce{animation:binBounce .3s ease;}
@keyframes binBounce{0%{transform:translateY(0)}50%{transform:translateY(30%)}100%{transform:translateY(0)}}
.plinko-last-wins{position:absolute;right:16px;top:50%;transform:translateY(-50%);
  display:flex;flex-direction:column;gap:0;width:48px;overflow:hidden;border-radius:6px;}
.plinko-last-win{width:48px;height:48px;display:flex;align-items:center;justify-content:center;
  font-size:12px;font-weight:700;color:#111;}

#luckPanel{flex-direction:column;align-items:center;justify-content:flex-start;gap:0;
  background:#000;padding:0!important;overflow:hidden;}
#luckPanel iframe{border:none;position:absolute;top:0;left:0;right:0;bottom:0;width:100%;height:100%;z-index:1;}

.pyl-lobby{position:absolute;top:0;left:0;right:0;bottom:0;z-index:10;
  background:radial-gradient(ellipse at top,#1a0a2e 0%,#0a0a1a 60%,#000 100%);
  display:flex;flex-direction:column;align-items:center;padding:80px 20px 20px;overflow-y:auto;}
.pyl-lobby.hidden{display:none;}
.pyl-title{font-family:'Orbitron';font-size:28px;font-weight:900;text-align:center;
  background:linear-gradient(135deg,#ff6b6b,#ffd93d,#6bcb77,#4d96ff);
  -webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:6px;}
.pyl-subtitle{color:var(--text2);font-size:13px;margin-bottom:24px;text-align:center;}
.pyl-modes{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;
  width:100%;max-width:660px;margin-bottom:20px;}
.pyl-mode{background:var(--surface);border:2px solid var(--border);border-radius:14px;
  padding:18px;cursor:pointer;transition:all .25s;text-align:center;}
.pyl-mode:hover{border-color:var(--neon);transform:translateY(-3px);
  box-shadow:0 8px 30px rgba(0,240,255,.15);}
.pyl-mode .pm-icon{font-size:36px;margin-bottom:6px;}
.pyl-mode .pm-name{font-family:'Orbitron';font-size:14px;font-weight:700;margin-bottom:4px;}
.pyl-mode .pm-desc{font-size:11px;color:var(--text2);line-height:1.4;}
.pyl-mode .pm-badge{display:inline-block;margin-top:6px;padding:3px 10px;border-radius:20px;
  font-size:10px;font-weight:700;background:rgba(0,240,255,.1);color:var(--neon);border:1px solid var(--neon);}

.pyl-overlay{position:absolute;top:60px;right:10px;z-index:15;display:flex;flex-direction:column;gap:6px;
  pointer-events:none;}
.pyl-overlay.hidden{display:none;}
.pyl-score-card{background:rgba(10,10,26,.9);border:1px solid var(--border);border-radius:10px;
  padding:10px 14px;pointer-events:auto;min-width:160px;}
.pyl-score-card .psc-label{font-size:9px;color:var(--text2);text-transform:uppercase;letter-spacing:1px;}
.pyl-score-card .psc-val{font-family:'Orbitron';font-size:16px;font-weight:700;}
.pyl-back-btn{pointer-events:auto;padding:8px 16px;border:1px solid var(--border);border-radius:8px;
  background:rgba(10,10,26,.9);color:var(--text);cursor:pointer;font-weight:600;font-size:12px;
  transition:all .2s;text-align:center;}
.pyl-back-btn:hover{border-color:var(--red);color:var(--red);}

.pyl-leaderboard{width:100%;max-width:660px;}
.pyl-lb-title{font-family:'Orbitron';font-size:16px;font-weight:700;color:var(--gold);margin-bottom:10px;}
.pyl-lb-row{display:flex;align-items:center;gap:10px;padding:8px 12px;background:var(--surface);
  border:1px solid var(--border);border-radius:8px;margin-bottom:4px;font-size:13px;}
.pyl-lb-row .lb-rank{font-family:'Orbitron';font-weight:900;width:30px;text-align:center;color:var(--gold);}
.pyl-lb-row .lb-name{flex:1;font-weight:600;}
.pyl-lb-row .lb-score{font-family:'Orbitron';font-weight:700;color:var(--neon);}
.pyl-lb-row .lb-wager{font-size:11px;color:var(--gold);}

.pyl-room{width:100%;max-width:500px;background:var(--surface);border:1px solid var(--border);
  border-radius:14px;padding:20px;text-align:center;}
.pyl-room .pr-title{font-family:'Orbitron';font-size:18px;font-weight:700;margin-bottom:12px;}
.pyl-room .pr-code{font-family:'Orbitron';font-size:28px;font-weight:900;color:var(--neon);
  letter-spacing:6px;margin:10px 0;padding:12px;background:rgba(0,240,255,.05);
  border:1px dashed var(--neon);border-radius:8px;}
.pyl-room .pr-status{color:var(--text2);font-size:13px;margin:8px 0;}
.pyl-room .pr-players{display:flex;gap:16px;justify-content:center;margin:12px 0;}
.pyl-room .pr-player{padding:8px 16px;border:1px solid var(--border);border-radius:8px;
  background:rgba(255,255,255,.03);font-weight:600;}
.pyl-room .pr-player.ready{border-color:var(--green);color:var(--green);}
.pyl-vs{font-family:'Orbitron';font-weight:900;font-size:20px;color:var(--red);}

#stocksPanel{flex-direction:column;align-items:center;gap:0;overflow-y:auto;
  padding:70px 16px 20px!important;background:radial-gradient(ellipse at top,#0f1923 0%,#080c10 70%);}
#cryptoPanel{flex-direction:column;align-items:center;gap:0;overflow-y:auto;
  padding:70px 16px 20px!important;}
.stock-hero{text-align:center;margin-bottom:6px;}
.stock-hero .sh-ticker{font-family:'Orbitron';font-size:14px;font-weight:700;color:#58a6ff;
  letter-spacing:3px;text-transform:uppercase;}
.stock-hero .sh-price{font-family:'Orbitron';font-size:42px;font-weight:900;color:#e6edf3;
  text-shadow:0 0 30px rgba(88,166,255,.15);margin:4px 0;line-height:1;}
.stock-hero .sh-change{font-size:14px;font-weight:700;}
.stock-hero .sh-change.up{color:#3fb950;}
.stock-hero .sh-change.down{color:#f85149;}
.stock-chart-wrap{width:100%;max-width:600px;height:220px;position:relative;border-radius:12px;
  overflow:hidden;background:#0d1117;border:1px solid #1e2933;margin:8px 0;}
#stockChart{width:100%;height:100%;display:block;}
.stock-portfolio{display:flex;gap:20px;align-items:center;justify-content:center;
  width:100%;max-width:600px;padding:12px 0;}
.stock-portfolio .sp-stat{text-align:center;}
.stock-portfolio .sp-label{font-size:10px;color:#8b949e;text-transform:uppercase;letter-spacing:1px;margin-bottom:2px;}
.stock-portfolio .sp-val{font-family:'Orbitron';font-size:16px;font-weight:700;color:#e6edf3;}
.stock-actions-row{display:flex;gap:10px;align-items:center;justify-content:center;
  width:100%;max-width:600px;margin-top:4px;}
.stock-actions-row .sa-btn{flex:1;padding:14px 8px;border:none;border-radius:12px;cursor:pointer;
  font-weight:900;font-size:15px;font-family:'Orbitron';transition:all .2s;text-transform:uppercase;
  letter-spacing:1px;max-width:180px;}
.sa-buy{background:linear-gradient(180deg,#2ea043,#1a7f37);color:#fff;
  box-shadow:0 4px 20px rgba(46,160,67,.3);}
.sa-buy:hover{transform:translateY(-2px);box-shadow:0 6px 25px rgba(46,160,67,.5);}
.sa-sell{background:linear-gradient(180deg,#f85149,#da3633);color:#fff;
  box-shadow:0 4px 20px rgba(248,81,73,.3);}
.sa-sell:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 6px 25px rgba(248,81,73,.5);}
.sa-sell:disabled{opacity:.25;cursor:not-allowed;transform:none!important;}
.stock-amt-row{display:flex;align-items:center;gap:8px;justify-content:center;margin-top:8px;}
.stock-live-dot{display:inline-block;width:8px;height:8px;border-radius:50%;background:#3fb950;
  animation:stockPulse 1.5s infinite;margin-right:6px;vertical-align:middle;}
@keyframes stockPulse{0%,100%{opacity:1;box-shadow:0 0 4px #3fb950}50%{opacity:.4;box-shadow:0 0 8px #3fb950}}

#particles{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:999;}

.win-toast{position:fixed;top:80px;left:50%;transform:translateX(-50%) translateY(-20px);
  background:linear-gradient(135deg,#1a3a1a,#0a2a0a);border:1px solid var(--green);
  border-radius:12px;padding:16px 32px;font-family:'Orbitron';font-size:20px;color:var(--green);
  box-shadow:0 0 30px rgba(0,255,136,.3);opacity:0;transition:all .4s;z-index:10000;pointer-events:none;white-space:nowrap;}
.win-toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
.win-toast.loss{background:linear-gradient(135deg,#3a1a1a,#2a0a0a);border-color:var(--red);color:var(--red);
  box-shadow:0 0 30px rgba(255,51,85,.3);}

@media(max-width:600px){
  .catalog-card{width:90px;height:100px;font-size:14px;}
  .catalog-card .icon{font-size:32px;margin-bottom:4px;}
  #topNav .logo{font-size:13px;margin-right:3px;}
  .game-panel{padding:6px 4px;}
  .pyl-modes{grid-template-columns:1fr;}
  .win-toast{font-size:15px;padding:10px 20px;}
  .bet-controls{flex-wrap:wrap;gap:4px;padding:6px 4px;}
  .bet-input{width:70px;font-size:11px;padding:5px 6px;}
  .action-btn{padding:8px 14px;font-size:12px;}
  .htp-box{font-size:11px;padding:6px;}
  .case-card{width:70px;padding:6px 2px;}
  .case-card .case-icon{font-size:18px;}
  .case-card .case-name{font-size:8px;}
  .case-card .case-price{font-size:9px;}
  .case-opener{height:80px;}
  .case-item{width:80px;height:80px;font-size:9px;}
  .case-item .item-icon{font-size:24px;}
  .case-won{font-size:14px;}
  .crash-multiplier{font-size:36px!important;}
  .crash-container{max-height:35vh;}
  .slots-machine{padding:8px;}
  .reel-window{width:55px;height:150px;}
  .reel-symbol{width:55px;height:50px;font-size:26px;}
  .roulette-canvas{width:min(220px,60vw)!important;height:min(220px,60vw)!important;}
  .tower-cell{width:48px!important;height:40px!important;font-size:16px!important;}
  .mine-cell{width:42px!important;height:42px!important;font-size:16px!important;}
  .keno-num{width:34px!important;height:34px!important;font-size:10px!important;}
  .scratch-cell{width:56px!important;height:56px!important;font-size:22px!important;}
  .scratch-card{width:200px;padding:10px;}
  .hilo-card{width:100px!important;height:140px!important;font-size:28px!important;}
  .hilo-act-btn{padding:8px 12px!important;font-size:11px!important;}
  .lb-data-row{padding:8px 10px;}
  .lb-col-rank{width:30px;font-size:12px;}
  .lb-col-name{font-size:11px;}
  .lb-col-val{font-size:10px;min-width:70px;}
  .plinko-canvas-wrap{height:min(300px,40vh);}
  .horse-track{max-width:98vw;}
  #chatPanel{right:4px;left:4px;width:auto;bottom:60px;max-height:350px;}
  .user-avatar{width:32px;height:32px;font-size:16px;}
  .user-name{font-size:10px;}
  #balanceDisplay .bal{font-size:11px;}
  #profileAvatar{width:64px!important;height:64px!important;}
}

::-webkit-scrollbar{width:6px;}
::-webkit-scrollbar-track{background:var(--bg);}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}

#dbResetOverlay{position:fixed;top:0;left:0;right:0;bottom:0;z-index:999999;display:flex;align-items:center;justify-content:center;
  background:rgba(0,0,0,.85);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);animation:dbResetFadeIn .4s ease;}
@keyframes dbResetFadeIn{from{opacity:0}to{opacity:1}}
.db-reset-box{position:relative;z-index:1;width:380px;padding:40px 36px;
  background:linear-gradient(180deg,rgba(20,20,60,.97),rgba(12,12,30,.99));
  border:1px solid rgba(255,215,0,.3);border-radius:20px;
  box-shadow:0 0 80px rgba(255,215,0,.15),0 0 200px rgba(0,240,255,.08);text-align:center;
  animation:dbResetBoxIn .5s ease;}
@keyframes dbResetBoxIn{from{transform:scale(.8) translateY(30px);opacity:0}to{transform:scale(1) translateY(0);opacity:1}}
.db-reset-box .db-reset-icon{font-size:56px;margin-bottom:12px;animation:dbResetPulse 2s ease infinite;}
@keyframes dbResetPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
.db-reset-box .db-reset-title{font-family:'Orbitron';font-weight:900;font-size:22px;
  background:linear-gradient(135deg,#ffd700,#ff8c00);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;
  margin-bottom:16px;letter-spacing:2px;}
.db-reset-box .db-reset-msg{font-size:15px;color:rgba(255,255,255,.85);line-height:1.6;margin-bottom:24px;font-family:'Inter',sans-serif;}
.db-reset-box .db-reset-btn{width:100%;padding:14px;border:none;border-radius:10px;cursor:pointer;
  font-family:'Orbitron';font-weight:700;font-size:15px;letter-spacing:2px;
  background:linear-gradient(135deg,#ffd700,#ff8c00);color:#0a0a1a;
  box-shadow:0 4px 20px rgba(255,215,0,.3);transition:all .25s;}
.db-reset-box .db-reset-btn:hover{transform:translateY(-2px);box-shadow:0 6px 30px rgba(255,215,0,.5);}

#loginScreen{position:fixed;top:0;left:0;right:0;bottom:0;z-index:99999;display:flex;align-items:center;justify-content:center;
  background:linear-gradient(135deg,#0a0a2e 0%,#1a0a3e 40%,#0a0a1a 100%);overflow:hidden;}
#loginScreen .login-bg-particles{position:absolute;top:0;left:0;right:0;bottom:0;overflow:hidden;pointer-events:none;}
#loginScreen .login-bg-particles div{position:absolute;width:3px;height:3px;background:var(--gold);
  border-radius:50%;animation:loginFloat linear infinite;opacity:.4;}
@keyframes loginFloat{0%{transform:translateY(100vh) scale(0)}50%{opacity:1}100%{transform:translateY(-100px) scale(1);opacity:0;}}
.login-box{position:relative;z-index:1;width:380px;padding:40px 36px;
  background:linear-gradient(180deg,rgba(20,20,60,.95),rgba(12,12,30,.98));
  border:1px solid var(--border);border-radius:20px;
  box-shadow:0 0 80px rgba(255,215,0,.08),0 0 200px rgba(0,240,255,.05);text-align:center;}
.login-logo{font-family:'Orbitron';font-weight:900;font-size:36px;
  background:linear-gradient(135deg,var(--gold),var(--neon));-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;
  margin-bottom:4px;letter-spacing:3px;}
.login-subtitle{font-size:13px;color:var(--text2);margin-bottom:28px;letter-spacing:1px;}
.login-input{width:100%;padding:14px 16px;border-radius:10px;border:1px solid var(--border);
  background:rgba(10,10,30,.8);color:var(--text);font-family:'Inter',sans-serif;font-size:15px;
  outline:none;transition:all .2s;margin-bottom:12px;}
.login-input:focus{border-color:var(--neon);box-shadow:0 0 15px rgba(0,240,255,.15);}
.login-input::placeholder{color:#555;}
.login-btn{width:100%;padding:14px;border:none;border-radius:10px;cursor:pointer;
  font-family:'Orbitron';font-weight:700;font-size:15px;letter-spacing:2px;
  transition:all .25s;margin-top:4px;}
.login-btn.primary{background:linear-gradient(135deg,#ffd700,#ff8c00);color:#0a0a1a;
  box-shadow:0 4px 20px rgba(255,215,0,.3);}
.login-btn.primary:hover{transform:translateY(-2px);box-shadow:0 6px 30px rgba(255,215,0,.5);}
.login-btn.secondary{background:transparent;border:1px solid var(--border);color:var(--text2);margin-top:8px;}
.login-btn.secondary:hover{border-color:var(--neon);color:var(--neon);}
.login-error{color:var(--red);font-size:12px;margin-top:8px;min-height:16px;}
.login-toggle{margin-top:16px;font-size:13px;color:var(--text2);}
.login-toggle a{color:var(--neon);cursor:pointer;text-decoration:none;font-weight:600;}
.login-toggle a:hover{text-decoration:underline;}

.user-info{display:flex;align-items:center;gap:8px;margin-left:8px;}
.user-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: linear-gradient(135deg,var(--neon),var(--neon2));
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 900;
  font-size: 22px;
  color: #fff;
  border: 2px solid rgba(0,240,255,.3);
  text-transform: uppercase;
  box-shadow: 0 2px 8px rgba(0,240,255,.08);
  overflow: hidden;
}
#profileAvatar{width:96px;height:96px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--neon),var(--neon2));color:#fff;font-size:40px;font-weight:900;border:3px solid rgba(0,240,255,.08);box-shadow:0 8px 40px rgba(0,0,0,.35);overflow:hidden;}
.user-avatar svg, #profileAvatar svg{width:100%;height:100%;display:block;border-radius:50% !important;clip-path:circle(50% at 50% 50%) !important;-webkit-clip-path:circle(50% at 50% 50%) !important;mask-image:radial-gradient(circle,#000 100%);-webkit-mask-image:radial-gradient(circle,#000 100%);}
.user-avatar, #profileAvatar, .user-avatar * { border-radius:50% !important; overflow:hidden !important; box-sizing:border-box !important; clip-path:circle(50% at 50% 50%) !important; -webkit-clip-path:circle(50% at 50% 50%) !important; }
.user-avatar img, #profileAvatar img { width:100%; height:100%; object-fit:cover; display:block; border-radius:50% !important; clip-path:circle(50% at 50% 50%) !important; -webkit-clip-path:circle(50% at 50% 50%) !important; }
.user-name{font-family:'Orbitron';font-size:12px;color:var(--neon);font-weight:700;}
.logout-btn{width:36px;height:36px;padding:0;border:1px solid rgba(255,51,85,.18);border-radius:50%;
  background:transparent;color:var(--red);cursor:pointer;font-size:14px;font-weight:700;display:flex;align-items:center;justify-content:center;
  transition:all .18s;font-family:'Inter',sans-serif;}
.logout-btn:hover{background:rgba(255,51,85,.08);border-color:var(--red);transform:translateY(-1px);}

#leaderboardPanel{flex-direction:column;align-items:center;gap:16px;overflow-y:auto;
  padding:80px 20px 20px;background:radial-gradient(ellipse at top,#1a1a40 0%,#0a0a1a 70%);}
.lb-container{width:100%;max-width:700px;}
.lb-tabs{display:flex;gap:3px;margin-bottom:16px;flex-wrap:wrap;justify-content:center;}
.lb-tab{padding:6px 10px;border:1px solid var(--border);border-radius:8px;background:transparent;
  color:var(--text2);cursor:pointer;font-weight:600;font-size:11px;transition:all .2s;
  font-family:'Inter',sans-serif;}
.lb-tab:hover{border-color:var(--neon);color:var(--text);}
.lb-tab.active{background:linear-gradient(135deg,#1a1a5e,#2a1a4e);color:var(--gold);
  border-color:rgba(255,215,0,.4);box-shadow:0 0 12px rgba(255,215,0,.1);}
.lb-table{width:100%;}
.lb-header-row{display:flex;padding:10px 16px;font-size:11px;font-weight:700;color:var(--text2);
  text-transform:uppercase;letter-spacing:1px;border-bottom:1px solid var(--border);}
.lb-data-row{display:flex;align-items:center;padding:12px 16px;background:var(--surface);
  border:1px solid var(--border);border-radius:10px;margin-bottom:4px;transition:all .2s;}
.lb-data-row:hover{border-color:var(--neon);background:rgba(0,240,255,.03);}
.lb-data-row.me{border-color:var(--gold);background:rgba(255,215,0,.05);}
.lb-col-rank{width:40px;font-family:'Orbitron';font-weight:900;font-size:14px;color:var(--gold);}
.lb-col-name{flex:1;font-weight:600;font-size:14px;}
.lb-col-val{min-width:90px;max-width:180px;text-align:right;font-family:'Orbitron';font-weight:700;font-size:12px;color:var(--neon);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.lb-col-extra{width:100px;text-align:right;font-size:12px;color:var(--text2);}
.lb-empty{text-align:center;padding:30px;color:var(--text2);font-size:13px;}

.daily-bonus-btn{padding:6px 12px;border:none;border-radius:6px;cursor:pointer;
  background:linear-gradient(135deg,#ffd700,#ff8c00);color:#0a0a1a;font-weight:800;font-size:12px;
  font-family:'Orbitron';animation:dailyPulse 2s infinite;transition:all .2s;}
.daily-bonus-btn:hover{transform:scale(1.05);}
.daily-bonus-btn:disabled{opacity:.4;animation:none;cursor:not-allowed;transform:none!important;
  background:var(--surface2);color:var(--text2);}
@keyframes dailyPulse{0%,100%{box-shadow:0 0 10px rgba(255,215,0,.3)}50%{box-shadow:0 0 25px rgba(255,215,0,.6)}}

#blackjackPanel{flex-direction:column;align-items:center;justify-content:center;gap:14px;background:radial-gradient(ellipse at top,#0a2a0a 0%,#0a0a1a 70%);}
.bj-table{width:min(560px,90vw);min-height:260px;background:linear-gradient(180deg,#0d4a0d,#0a380a);border-radius:18px;border:3px solid #1a6a1a;padding:18px;box-shadow:inset 0 0 40px rgba(0,0,0,.5);}
.bj-area{min-height:85px;display:flex;flex-wrap:wrap;gap:5px;align-items:center;justify-content:center;padding:5px;}
.bj-label{font-family:'Orbitron';font-size:11px;color:rgba(255,255,255,.5);margin-bottom:2px;}
.bj-score{font-family:'Orbitron';font-size:15px;font-weight:700;display:inline;margin-left:6px;}
.bj-card{width:52px;height:74px;border-radius:7px;background:#fff;color:#111;display:inline-flex;flex-direction:column;align-items:center;justify-content:center;font-size:15px;font-weight:900;box-shadow:0 2px 8px rgba(0,0,0,.3);border:1px solid #ddd;}
.bj-card.red{color:#cc2233;}
.bj-card.hidden{background:linear-gradient(135deg,#1a1a8e,#2a1a6e);color:transparent;background-image:repeating-linear-gradient(45deg,transparent,transparent 5px,rgba(255,255,255,.05) 5px,rgba(255,255,255,.05) 10px);}
#bjResult{font-family:'Orbitron';font-size:15px;font-weight:700;min-height:22px;text-align:center;}

#minesPanel{flex-direction:column;align-items:center;justify-content:center;gap:14px;background:radial-gradient(ellipse at center,#1a1a0a 0%,#0a0a1a 70%);}
.mines-wrap{display:flex;gap:14px;align-items:flex-start;}
.mines-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:4px;}
.mine-cell{width:58px;height:58px;border-radius:8px;border:2px solid var(--border);background:var(--surface);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:24px;transition:all .15s;}
.mine-cell:hover:not(.revealed){background:var(--surface2);border-color:var(--neon);transform:scale(1.05);}
.mine-cell.revealed.safe{background:#0a2a0a;border-color:var(--green);}
.mine-cell.revealed.mine{background:#2a0a0a;border-color:var(--red);}
.mines-side{width:170px;display:flex;flex-direction:column;gap:8px;padding:12px;background:var(--surface);border-radius:10px;border:1px solid var(--border);}
.mines-side label{font-size:11px;color:var(--text2);font-weight:600;}
.mines-side select,.mines-side input{width:100%;padding:6px;border-radius:6px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:12px;}
#minesMultiplier{font-family:'Orbitron';font-size:15px;font-weight:700;text-align:center;}
#minesProfit{font-size:11px;text-align:center;color:var(--text2);}

#dicePanel{flex-direction:column;align-items:center;justify-content:center;gap:14px;background:radial-gradient(ellipse at top,#1a0a2a 0%,#0a0a1a 70%);}
.dice-roll-display{font-family:'Orbitron';font-size:60px;font-weight:900;min-height:74px;text-shadow:0 0 30px rgba(0,240,255,.4);}
.dice-slider-wrap{width:min(480px,85vw);}
.dice-slider{width:100%;-webkit-appearance:none;appearance:none;height:8px;border-radius:4px;outline:none;}
.dice-slider::-webkit-slider-thumb{-webkit-appearance:none;width:22px;height:22px;border-radius:50%;background:var(--gold);cursor:pointer;box-shadow:0 0 10px rgba(255,215,0,.5);}
.dice-info{display:flex;justify-content:space-between;width:min(480px,85vw);font-size:12px;color:var(--text2);}
.dice-info span{font-family:'Orbitron';font-weight:700;}
.dice-mode-btns{display:flex;gap:6px;}
.dice-mode-btn{padding:5px 12px;border:1px solid var(--border);border-radius:6px;background:var(--surface);color:var(--text2);cursor:pointer;font-weight:700;font-size:11px;transition:all .2s;}
.dice-mode-btn.active{border-color:var(--neon);color:var(--neon);background:rgba(0,240,255,.08);}

#towerPanel{flex-direction:column;align-items:center;justify-content:center;gap:10px;background:radial-gradient(ellipse at bottom,#1a1a2e 0%,#0a0a1a 70%);}
.tower-grid{display:flex;flex-direction:column-reverse;gap:3px;padding:8px;background:var(--surface);border-radius:10px;border:1px solid var(--border);}
.tower-row{display:flex;gap:3px;}
.tower-cell{width:66px;height:38px;border-radius:6px;border:2px solid var(--border);background:var(--surface2);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;transition:all .15s;}
.tower-cell:hover:not(.revealed):not(.locked){border-color:var(--neon);}
.tower-cell.revealed.safe{background:#0a2a0a;border-color:var(--green);}
.tower-cell.revealed.trap{background:#2a0a0a;border-color:var(--red);}
.tower-cell.locked{opacity:.3;cursor:default;}
.tower-cell.current-row{border-color:var(--neon);opacity:1;}
#towerInfo{font-family:'Orbitron';font-size:13px;text-align:center;}

#coinflipPanel{flex-direction:column;align-items:center;justify-content:center;gap:18px;background:radial-gradient(ellipse at center,#1a1a2e 0%,#0a0a1a 70%);}
.coin{width:120px;height:120px;border-radius:50%;font-size:52px;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#ffd700,#ff8c00);color:#333;box-shadow:0 0 40px rgba(255,215,0,.3);font-weight:900;}
.coin.flip{animation:coinSpin .8s ease-out;}@keyframes coinSpin{0%{transform:rotateY(0)}100%{transform:rotateY(1800deg)}}
.coin-choices{display:flex;gap:10px;}
.coin-choice{padding:10px 24px;border:2px solid var(--border);border-radius:10px;background:var(--surface);color:var(--text);cursor:pointer;font-size:15px;font-weight:700;transition:all .2s;}
.coin-choice:hover{border-color:var(--gold);}
.coin-choice.selected{border-color:var(--gold);background:rgba(255,215,0,.12);color:var(--gold);}
#coinResult{font-family:'Orbitron';font-size:16px;font-weight:700;min-height:24px;}

#kenoPanel{flex-direction:column;align-items:center;justify-content:center;gap:10px;background:radial-gradient(ellipse at top,#0a1a2a 0%,#0a0a1a 70%);}
.keno-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:3px;}
.keno-num{width:46px;height:38px;border-radius:5px;border:1px solid var(--border);background:var(--surface);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;transition:all .15s;}
.keno-num:hover:not(.drawn){background:var(--surface2);}
.keno-num.selected{background:rgba(0,240,255,.12);border-color:var(--neon);color:var(--neon);}
.keno-num.drawn{border-color:var(--gold);color:var(--gold);}
.keno-num.hit{background:#0a2a0a!important;border-color:var(--green)!important;color:var(--green)!important;}
.keno-num.miss{opacity:.35;}
#kenoInfo{font-size:11px;color:var(--text2);text-align:center;}
#kenoResult{font-family:'Orbitron';font-size:15px;font-weight:700;min-height:22px;text-align:center;}

#limboPanel{flex-direction:column;align-items:center;justify-content:center;gap:18px;background:radial-gradient(ellipse at center,#0a0a2a 0%,#0a0a1a 70%);}
#limboResult{font-family:'Orbitron';font-size:60px;font-weight:900;min-height:74px;transition:color .3s;text-shadow:0 0 30px rgba(0,240,255,.3);}
.limbo-target-wrap{display:flex;align-items:center;gap:10px;}
.limbo-target-wrap label{font-size:12px;color:var(--text2);font-weight:600;}
#limboTarget{width:85px;padding:7px;border-radius:7px;border:1px solid var(--border);background:var(--bg);color:var(--neon);font-family:'Orbitron';font-size:15px;text-align:center;}
#limboPayout{font-size:12px;color:var(--text2);}

#pokerPanel{flex-direction:column;align-items:center;justify-content:center;gap:12px;background:radial-gradient(ellipse at top,#0a1a0a 0%,#0a0a1a 70%);}
.poker-hand{display:flex;gap:6px;justify-content:center;flex-wrap:wrap;}
.poker-card{width:72px;height:100px;border-radius:9px;background:#fff;color:#111;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:17px;font-weight:900;cursor:pointer;transition:all .2s;box-shadow:0 4px 12px rgba(0,0,0,.3);border:2px solid transparent;position:relative;}
.poker-card.red{color:#cc2233;}
.poker-card.held{border-color:var(--gold);transform:translateY(-10px);box-shadow:0 8px 20px rgba(255,215,0,.3);}
.poker-card .held-tag{position:absolute;top:-8px;font-size:8px;font-weight:700;color:var(--gold);font-family:'Orbitron';background:var(--bg);padding:1px 4px;border-radius:3px;border:1px solid var(--gold);}
.poker-paytable{display:grid;grid-template-columns:auto auto;gap:1px 10px;font-size:10px;background:var(--surface);padding:6px 10px;border-radius:7px;border:1px solid var(--border);}
.poker-paytable .pt-h{color:var(--text2);}
.poker-paytable .pt-v{color:var(--gold);font-family:'Orbitron';text-align:right;}
#pokerResult{font-family:'Orbitron';font-size:15px;font-weight:700;min-height:22px;text-align:center;}

#horsesPanel{flex-direction:column;align-items:center;justify-content:flex-start;gap:10px;background:radial-gradient(ellipse at bottom,#1a0a0a 0%,#0a0a1a 70%);overflow-y:auto;padding-bottom:30px;}
#hrContent{width:100%;max-width:720px;display:flex;flex-direction:column;gap:10px;align-items:center;}
.horse-track{width:min(680px,95vw);background:var(--surface);border-radius:10px;border:1px solid var(--border);padding:10px;}
.horse-lane{display:flex;align-items:center;gap:6px;padding:3px 0;border-bottom:1px solid rgba(255,255,255,.05);}
.horse-lane:last-child{border-bottom:none;}
.horse-name{width:80px;font-size:10px;font-weight:700;white-space:nowrap;overflow:hidden;}
.horse-bar{flex:1;height:22px;background:var(--bg);border-radius:5px;position:relative;overflow:hidden;}
.horse-progress{height:100%;border-radius:5px;transition:width .05s linear;position:absolute;left:0;top:0;}
.horse-emoji{position:absolute;right:-2px;top:-3px;font-size:20px;transition:left .05s linear;}

.hr-conditions{display:flex;flex-wrap:wrap;gap:6px;justify-content:center;width:100%;max-width:680px;background:rgba(0,0,0,.3);border:1px solid var(--border);border-radius:10px;padding:10px 14px;}
.hr-cond-item{display:flex;flex-direction:column;align-items:center;gap:2px;min-width:70px;}
.hr-cond-label{font-size:8px;letter-spacing:2px;color:var(--text2);font-weight:700;}
.hr-cond-val{font-family:'Orbitron';font-size:11px;font-weight:700;color:var(--text);}
.hr-track-desc{font-size:10px;color:var(--text2);text-align:center;max-width:600px;line-height:1.4;}

.hr-card{width:100%;max-width:680px;background:var(--surface);border:1px solid var(--border);border-radius:10px;overflow:hidden;}
.hr-card-header{display:grid;grid-template-columns:28px 1fr 1fr 70px 40px 75px 50px;gap:4px;padding:8px 10px;background:rgba(255,215,0,.05);border-bottom:1px solid var(--border);font-size:9px;font-weight:700;letter-spacing:1px;color:var(--text2);}
.hr-card-row{display:grid;grid-template-columns:28px 1fr 1fr 70px 40px 75px 50px;gap:4px;padding:7px 10px;border-bottom:1px solid rgba(255,255,255,.03);cursor:pointer;transition:all .15s;align-items:center;font-size:11px;}
.hr-card-row:hover{background:rgba(255,255,255,.03);}
.hr-card-row.hr-row-sel{background:rgba(255,215,0,.08);border-left:3px solid var(--gold);}
.hr-col-gate{font-family:'Orbitron';font-size:10px;color:var(--text2);text-align:center;}
.hr-col-name{font-weight:700;font-size:11px;display:flex;align-items:center;gap:4px;}
.hr-temperament{font-size:8px;padding:1px 4px;background:rgba(255,255,255,.08);border-radius:3px;color:var(--text2);}
.hr-col-jockey{display:flex;flex-direction:column;gap:1px;}
.hr-jockey-name{font-size:10px;color:var(--text);}
.hr-jockey-style{font-size:8px;color:var(--text2);}
.hr-col-stats{font-family:'Orbitron';font-size:9px;color:var(--text2);}
.hr-col-surface{font-family:'Orbitron';font-size:11px;font-weight:700;text-align:center;}
.hr-surf-great{color:#44ff44;}
.hr-surf-good{color:#88cc44;}
.hr-surf-ok{color:#ffaa00;}
.hr-surf-bad{color:#ff4444;}
.hr-col-form{display:flex;gap:2px;align-items:center;}
.hr-form-dot{display:inline-block;width:14px;height:14px;border-radius:3px;font-size:9px;font-weight:700;text-align:center;line-height:14px;}
.hr-form-dot.win{background:rgba(0,255,136,.2);color:var(--green);}
.hr-form-dot.mid{background:rgba(255,170,0,.15);color:#ffaa00;}
.hr-form-dot.lose{background:rgba(255,50,50,.15);color:#ff4444;}
.hr-col-odds{font-family:'Orbitron';font-size:12px;font-weight:900;color:var(--gold);text-align:right;}

.hr-mode-toggle{display:flex;gap:4px;justify-content:center;background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:4px;width:fit-content;margin:0 auto;}
.hr-mode-btn{padding:8px 18px;border:none;border-radius:8px;font-size:11px;font-weight:700;cursor:pointer;background:transparent;color:var(--text2);transition:all .15s;font-family:'Orbitron';letter-spacing:1px;}
.hr-mode-btn.active{background:var(--gold);color:#000;box-shadow:0 0 12px rgba(255,215,0,.3);}
.hr-mode-btn:not(.active):hover{background:rgba(255,255,255,.05);color:var(--text);}

.hr-normal-header{grid-template-columns:28px 1fr 120px 50px !important;}
.hr-normal-row{grid-template-columns:28px 1fr 120px 50px !important;padding:10px !important;}
.hr-col-rating{font-size:12px;display:flex;gap:1px;align-items:center;}

.hr-detail{width:100%;max-width:680px;min-height:0;transition:all .2s;}
.hr-detail-inner{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px;}
.hr-det-title{font-family:'Orbitron';font-size:14px;font-weight:700;margin-bottom:10px;}
.hr-det-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px 16px;margin-bottom:10px;}
.hr-det-stat{display:flex;align-items:center;gap:6px;}
.hr-det-label{font-size:10px;color:var(--text2);width:75px;flex-shrink:0;}
.hr-stat-bar{flex:1;height:8px;background:var(--bg);border-radius:4px;overflow:hidden;}
.hr-stat-fill{height:100%;border-radius:4px;transition:width .3s;}
.hr-det-val{font-family:'Orbitron';font-size:10px;width:55px;text-align:right;flex-shrink:0;}
.hr-det-jockey{font-size:10px;color:var(--text2);margin-bottom:4px;}
.hr-det-form{font-size:10px;color:var(--text2);}

.hr-finish-order{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px;justify-content:center;}
.hr-finish-item{font-size:11px;font-weight:700;}

.hr-legend{width:100%;max-width:680px;background:rgba(0,0,0,.2);border:1px solid var(--border);border-radius:8px;padding:10px 14px;}
.hr-leg-item{font-size:9px;color:var(--text2);line-height:1.5;}

@media(max-width:600px){
  .hr-card-header,.hr-card-row{grid-template-columns:22px 1fr 60px 38px 50px;font-size:9px;}
  .hr-col-jockey,.hr-col-stats{display:none;}
  .hr-det-grid{grid-template-columns:1fr;}
  .hr-conditions{gap:4px;padding:8px;}
  .hr-cond-item{min-width:55px;}
}
#horseResult{font-family:'Orbitron';font-size:13px;font-weight:700;min-height:22px;text-align:center;}

#scratchPanel{flex-direction:column;align-items:center;justify-content:center;gap:12px;background:radial-gradient(ellipse at center,#1a1a0a 0%,#0a0a1a 70%);}
.scratch-card{width:260px;padding:14px;background:linear-gradient(135deg,#2a2a5e,#1a1a3e);border-radius:12px;border:2px solid var(--gold);box-shadow:0 0 30px rgba(255,215,0,.1);}
.scratch-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:5px;margin-bottom:8px;}
.scratch-cell{width:64px;height:64px;border-radius:8px;background:linear-gradient(135deg,#666,#999);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:24px;color:transparent;user-select:none;border:1px solid #aaa;transition:all .3s;}
.scratch-cell.revealed{background:var(--surface);border-color:var(--border);color:var(--text);}
#scratchResult{font-family:'Orbitron';font-size:13px;font-weight:700;text-align:center;min-height:20px;}
.scratch-tiers{display:flex;gap:5px;justify-content:center;flex-wrap:wrap;}
.scratch-tier{padding:4px 10px;border:1px solid var(--border);border-radius:6px;font-size:10px;background:var(--surface);cursor:pointer;transition:all .2s;}
.scratch-tier:hover{border-color:var(--gold);}
.scratch-tier.selected{border-color:var(--gold);background:rgba(255,215,0,.1);}

#wheelPanel{flex-direction:column;align-items:center;justify-content:center;gap:12px;background:radial-gradient(ellipse at center,#1a0a2e 0%,#0a0a1a 70%);}
.wheel-wrap{position:relative;}
.wheel-ptr{position:absolute;top:-14px;left:50%;transform:translateX(-50%);width:0;height:0;border-left:11px solid transparent;border-right:11px solid transparent;border-top:20px solid var(--neon);filter:drop-shadow(0 0 6px rgba(0,240,255,.6));z-index:5;}
#wheelResult{font-family:'Orbitron';font-size:18px;font-weight:700;min-height:26px;}

#baccaratPanel{flex-direction:column;align-items:center;justify-content:center;gap:12px;background:radial-gradient(ellipse at top,#1a0a0a 0%,#0a0a1a 70%);}
.bacc-table{width:min(520px,90vw);background:linear-gradient(180deg,#1a0a0a,#150808);border-radius:16px;border:2px solid #4a2020;padding:18px;}
.bacc-hands{display:flex;justify-content:space-around;gap:16px;}
.bacc-hand{text-align:center;min-width:110px;}
.bacc-hand-label{font-family:'Orbitron';font-size:11px;color:var(--text2);margin-bottom:5px;}
.bacc-hand-score{font-family:'Orbitron';font-size:20px;font-weight:900;margin-top:5px;}
.bacc-cards{display:flex;gap:3px;justify-content:center;min-height:74px;align-items:center;}
.bacc-bets{display:flex;gap:6px;justify-content:center;}
.bacc-bet{padding:9px 18px;border:2px solid var(--border);border-radius:9px;background:var(--surface);color:var(--text);cursor:pointer;font-weight:700;font-size:12px;transition:all .2s;}
.bacc-bet:hover{border-color:var(--neon);}
.bacc-bet.selected{border-color:var(--gold);background:rgba(255,215,0,.1);color:var(--gold);}
#baccResult{font-family:'Orbitron';font-size:15px;font-weight:700;min-height:22px;text-align:center;}

#hiloPanel{flex-direction:column;align-items:center;justify-content:center;gap:12px;background:radial-gradient(ellipse at center,#0a1a2a 0%,#0a0a1a 70%);}
.hilo-card{width:100px;height:140px;border-radius:12px;background:#fff;color:#111;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:26px;font-weight:900;box-shadow:0 8px 30px rgba(0,0,0,.4);border:2px solid #ddd;}
.hilo-card.red{color:#cc2233;}
.hilo-actions{display:flex;gap:8px;}
.hilo-act-btn{padding:10px 22px;border:none;border-radius:9px;cursor:pointer;font-weight:700;font-size:13px;font-family:'Orbitron';transition:all .2s;}
.hilo-act-btn.higher{background:linear-gradient(135deg,#00cc66,#009944);color:#fff;}
.hilo-act-btn.lower{background:linear-gradient(135deg,#cc3355,#991133);color:#fff;}
.hilo-act-btn.skip-btn{background:var(--surface2);color:var(--text);border:1px solid var(--border);}
#hiloStreak{font-family:'Orbitron';font-size:12px;color:var(--text2);}
#hiloCashout{font-family:'Orbitron';font-size:14px;color:var(--gold);}
.last-results{display:flex;gap:4px;flex-wrap:wrap;justify-content:center;max-width:320px;min-height:18px;}
.result-dot{display:inline-block;padding:2px 6px;border-radius:4px;font-size:10px;font-family:'Orbitron';font-weight:700;color:#fff;animation:dotIn .2s ease;}
@keyframes dotIn{from{opacity:0;transform:scale(.5);}to{opacity:1;transform:scale(1);}}

#chatToggleBtn{position:fixed;bottom:16px;right:16px;z-index:1100;width:48px;height:48px;border-radius:50%;
  border:2px solid var(--neon);background:linear-gradient(135deg,#15153a,#0d0d25);color:var(--neon);
  font-size:22px;cursor:pointer;box-shadow:0 4px 20px rgba(0,240,255,.25);transition:all .2s;display:flex;align-items:center;justify-content:center;}
#chatToggleBtn:hover{transform:scale(1.1);box-shadow:0 6px 30px rgba(0,240,255,.4);}
#chatToggleBtn .chat-badge{position:absolute;top:-4px;right:-4px;background:var(--red);color:#fff;font-size:10px;
  font-weight:900;width:18px;height:18px;border-radius:50%;display:none;align-items:center;justify-content:center;font-family:'Inter';}
#chatPanel{position:fixed;bottom:76px;right:16px;width:340px;max-height:460px;z-index:1100;
  background:linear-gradient(180deg,#15153a,#0d0d25);border:1px solid var(--border);border-radius:14px;
  display:none;flex-direction:column;overflow:hidden;box-shadow:0 8px 40px rgba(0,0,0,.7);
  animation:chatSlideIn .2s ease;}
#chatPanel.open{display:flex;}
@keyframes chatSlideIn{from{opacity:0;transform:translateY(20px);}to{opacity:1;transform:translateY(0);}}
.chat-header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;
  border-bottom:1px solid var(--border);background:rgba(0,0,0,.2);}
.chat-header-title{font-family:'Orbitron';font-size:13px;font-weight:700;color:var(--neon);display:flex;align-items:center;gap:6px;}
.chat-header-title .online-dot{width:8px;height:8px;border-radius:50%;background:var(--green);animation:onlinePulse 2s infinite;}
@keyframes onlinePulse{0%,100%{opacity:1;}50%{opacity:.4;}}
.chat-close{background:none;border:none;color:var(--text2);font-size:16px;cursor:pointer;padding:4px;}
.chat-close:hover{color:var(--red);}
.chat-messages{flex:1;overflow-y:auto;padding:10px 14px;display:flex;flex-direction:column;gap:6px;min-height:200px;max-height:320px;
  scrollbar-width:thin;scrollbar-color:var(--border) transparent;}
.chat-messages::-webkit-scrollbar{width:5px;}
.chat-messages::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px;}
.chat-msg{display:flex;gap:8px;padding:6px 0;animation:chatMsgIn .15s ease;}
@keyframes chatMsgIn{from{opacity:0;transform:translateY(6px);}to{opacity:1;transform:translateY(0);}}
.chat-msg-avatar{width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,var(--neon),var(--neon2));
  display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:900;color:#fff;flex-shrink:0;}
.chat-msg-body{flex:1;min-width:0;}
.chat-msg-name{font-size:11px;font-weight:700;color:var(--neon);margin-bottom:2px;}
.chat-msg-name.guest-name{color:var(--text2);}
.role-badge-owner{display:inline-block;font-size:8px;padding:1px 5px;border-radius:6px;margin-left:4px;background:linear-gradient(135deg,#ff3300,#ff6600);color:#fff;font-weight:900;letter-spacing:.5px;vertical-align:middle;}
.role-badge-coowner{display:inline-block;font-size:8px;padding:1px 5px;border-radius:6px;margin-left:4px;background:linear-gradient(135deg,#9b59b6,#8e44ad);color:#fff;font-weight:900;letter-spacing:.5px;vertical-align:middle;}
.role-badge-admin{display:inline-block;font-size:8px;padding:1px 5px;border-radius:6px;margin-left:4px;background:linear-gradient(135deg,#ff4444,#cc0000);color:#fff;font-weight:900;letter-spacing:.5px;vertical-align:middle;}
.role-badge-bugtester{display:inline-block;font-size:8px;padding:1px 5px;border-radius:6px;margin-left:4px;background:linear-gradient(135deg,#00cc88,#00aa66);color:#fff;font-weight:900;letter-spacing:.5px;vertical-align:middle;}
.chat-msg-text{font-size:12px;color:var(--text);line-height:1.4;word-break:break-word;}
.chat-msg-time{font-size:9px;color:var(--text2);margin-top:2px;}
.chat-msg-system{text-align:center;color:var(--text2);font-size:11px;font-style:italic;padding:4px 0;}
.chat-msg-win{background:linear-gradient(90deg,rgba(0,255,136,.06),transparent);border-left:3px solid var(--green);
  padding:6px 10px;border-radius:0 8px 8px 0;margin:2px 0;}
.chat-msg-win .win-text{color:var(--green);font-weight:700;font-size:11px;}
.chat-input-wrap{display:flex;gap:6px;padding:10px 14px;border-top:1px solid var(--border);background:rgba(0,0,0,.15);}
.chat-input{flex:1;padding:8px 12px;background:var(--bg);border:1px solid var(--border);border-radius:8px;
  color:var(--text);font-size:13px;outline:none;font-family:'Inter',sans-serif;}
.chat-input:focus{border-color:var(--neon);}
.chat-input::placeholder{color:var(--text2);}
.chat-send-btn{padding:8px 14px;background:linear-gradient(135deg,var(--neon),#0088cc);border:none;border-radius:8px;
  color:#fff;font-weight:700;font-size:12px;cursor:pointer;transition:all .15s;font-family:'Inter';}
.chat-send-btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,240,255,.3);}
.chat-send-btn:disabled{opacity:.4;cursor:not-allowed;transform:none!important;}
.chat-online-count{font-size:10px;color:var(--text2);font-weight:400;}
@media(max-width:500px){#chatPanel{right:8px;left:8px;width:auto;bottom:70px;max-height:380px;}}

@keyframes screenShake{
  0%,100%{transform:translate(0,0)}
  10%{transform:translate(-4px,-2px)}
  20%{transform:translate(4px,2px)}
  30%{transform:translate(-3px,3px)}
  40%{transform:translate(3px,-3px)}
  50%{transform:translate(-2px,2px)}
  60%{transform:translate(2px,-1px)}
  70%{transform:translate(-1px,1px)}
  80%{transform:translate(1px,-1px)}
  90%{transform:translate(0,1px)}
}
@keyframes bigWinBounce{
  0%{transform:scale(0) translateY(30px);opacity:0;}
  60%{transform:scale(1.15) translateY(-5px);opacity:1;}
  100%{transform:scale(1) translateY(0);opacity:1;}
}
@keyframes fadeInOut{
  0%{opacity:0;}10%{opacity:1;}75%{opacity:1;}100%{opacity:0;}
}

.prestige-badge{display:inline-block;font-size:9px;padding:1px 5px;border-radius:4px;font-weight:700;letter-spacing:1px;margin-left:4px;vertical-align:middle;font-family:'Orbitron',sans-serif;}
.prestige-1{background:linear-gradient(135deg,#cd7f32,#8b4513);color:#fff;text-shadow:0 1px 2px rgba(0,0,0,.5);}
.prestige-2{background:linear-gradient(135deg,#c0c0c0,#808080);color:#fff;text-shadow:0 1px 2px rgba(0,0,0,.5);}
.prestige-3{background:linear-gradient(135deg,#ffd700,#ff8c00);color:#1a1a2e;text-shadow:0 1px 2px rgba(255,255,255,.3);}
.prestige-4{background:linear-gradient(135deg,#00f0ff,#0066ff);color:#fff;text-shadow:0 0 6px rgba(0,240,255,.5);}
.prestige-5{background:linear-gradient(135deg,#ff00ff,#6b2fd9);color:#fff;text-shadow:0 0 8px rgba(255,0,255,.5);animation:prestigeGlow 2s ease-in-out infinite;}
@keyframes prestigeGlow{0%,100%{box-shadow:0 0 4px rgba(255,0,255,.4);}50%{box-shadow:0 0 12px rgba(255,0,255,.8);}}
.prestige-btn{background:linear-gradient(135deg,var(--gold),#ff8800);color:#1a1a2e;border:none;border-radius:8px;padding:10px 20px;font-family:'Orbitron',sans-serif;font-weight:900;font-size:13px;cursor:pointer;letter-spacing:2px;transition:all .2s;display:flex;align-items:center;gap:8px;margin:12px auto;}
.prestige-btn:hover{transform:scale(1.05);box-shadow:0 0 20px rgba(255,215,0,.5);}
.prestige-btn:disabled{opacity:.4;cursor:not-allowed;transform:none;}
.prestige-confirm-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.85);z-index:10002;display:flex;align-items:center;justify-content:center;}
.prestige-confirm-box{background:var(--surface);border:2px solid var(--gold);border-radius:16px;padding:24px;max-width:400px;width:90vw;text-align:center;}

#duelsPanel .duel-lobby{max-width:600px;margin:0 auto;padding:16px;}
.duel-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:10px;display:flex;align-items:center;justify-content:space-between;transition:all .2s;}
.duel-card:hover{border-color:var(--gold);box-shadow:0 0 10px rgba(255,215,0,.15);}
.duel-card .duel-host{font-family:'Orbitron',sans-serif;font-size:13px;color:var(--text);}
.duel-card .duel-wager{font-family:'Orbitron',sans-serif;font-size:16px;color:var(--gold);font-weight:900;}
.duel-card .duel-join{background:linear-gradient(135deg,var(--green),#00cc88);color:#fff;border:none;border-radius:8px;padding:8px 16px;font-family:'Orbitron',sans-serif;font-size:11px;cursor:pointer;font-weight:700;letter-spacing:1px;transition:all .2s;}
.duel-card .duel-join:hover{transform:scale(1.05);box-shadow:0 0 12px rgba(0,230,118,.4);}
.duel-create-box{background:var(--surface);border:2px solid var(--gold);border-radius:12px;padding:20px;margin-bottom:16px;text-align:center;}
.duel-create-box input{width:140px;text-align:center;background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:8px;color:var(--text);font-family:'Orbitron',sans-serif;font-size:14px;}
.duel-create-btn{background:linear-gradient(135deg,var(--gold),#ff8800);color:#1a1a2e;border:none;border-radius:8px;padding:10px 24px;font-family:'Orbitron',sans-serif;font-size:13px;cursor:pointer;font-weight:900;letter-spacing:2px;margin-top:10px;transition:all .2s;}
.duel-create-btn:hover{transform:scale(1.05);box-shadow:0 0 16px rgba(255,215,0,.5);}
.duel-vs{font-family:'Orbitron',sans-serif;font-size:36px;color:var(--gold);text-shadow:0 0 20px rgba(255,215,0,.5);margin:12px 0;letter-spacing:6px;}
.duel-player{text-align:center;flex:1;}
.duel-player-name{font-family:'Orbitron',sans-serif;font-size:16px;color:var(--text);margin-bottom:4px;transition:all .5s;}
.duel-player-bet{font-family:'Orbitron',sans-serif;font-size:12px;color:var(--gold);}
.duel-result{font-family:'Orbitron',sans-serif;font-size:28px;font-weight:900;letter-spacing:3px;margin:12px 0;}
.duel-coin-wrapper{perspective:600px;display:inline-block;}
.duel-coin{width:120px;height:120px;border-radius:50%;position:relative;transform-style:preserve-3d;display:flex;align-items:center;justify-content:center;font-size:48px;font-weight:900;font-family:'Orbitron',sans-serif;}
.duel-coin .coin-face{position:absolute;width:100%;height:100%;border-radius:50%;display:flex;align-items:center;justify-content:center;backface-visibility:hidden;}
.duel-coin .coin-heads{background:linear-gradient(135deg,#ffd700,#ffaa00,#ffd700);color:#1a1a2e;border:4px solid #cc8800;box-shadow:0 0 30px rgba(255,215,0,.5),inset 0 0 20px rgba(255,255,255,.3);}
.duel-coin .coin-tails{background:linear-gradient(135deg,#2a2a3e,#1a1a2e,#2a2a3e);color:#8888aa;border:4px solid #444;box-shadow:0 0 30px rgba(100,100,200,.3),inset 0 0 20px rgba(0,0,0,.5);transform:rotateY(180deg);}
@keyframes duelCoinSpin{0%{transform:rotateY(0deg);}100%{transform:rotateY(360deg);}}
@keyframes duelCoinSlowDown{0%{transform:rotateY(0deg);}100%{transform:rotateY(1800deg);}}
@keyframes duelCoinRevealHeads{0%{transform:rotateY(0deg);}100%{transform:rotateY(0deg);}}
@keyframes duelCoinRevealTails{0%{transform:rotateY(0deg);}100%{transform:rotateY(180deg);}}
.duel-countdown{font-family:'Orbitron',sans-serif;font-size:72px;font-weight:900;color:var(--gold);text-shadow:0 0 40px rgba(255,215,0,.8),0 0 80px rgba(255,215,0,.4);animation:duelCountPulse .5s ease-out;}
@keyframes duelCountPulse{0%{transform:scale(2);opacity:0;}50%{transform:scale(1.1);opacity:1;}100%{transform:scale(1);opacity:1;}}
.duel-flash{position:fixed;inset:0;z-index:10004;pointer-events:none;opacity:0;}
@keyframes duelFlashBang{0%{opacity:.8;}100%{opacity:0;}}
@keyframes duelShake{0%,100%{transform:translate(0,0);}10%{transform:translate(-8px,4px);}20%{transform:translate(8px,-4px);}30%{transform:translate(-6px,6px);}40%{transform:translate(6px,-6px);}50%{transform:translate(-4px,2px);}60%{transform:translate(4px,-2px);}70%{transform:translate(-2px,4px);}80%{transform:translate(2px,-4px);}90%{transform:translate(-1px,1px);}}
.duel-overlay-shake{animation:duelShake .5s ease-out;}
.duel-win-glow{animation:duelWinGlow 1.5s ease-in-out infinite;}
@keyframes duelWinGlow{0%,100%{text-shadow:0 0 10px currentColor,0 0 20px currentColor;}50%{text-shadow:0 0 30px currentColor,0 0 60px currentColor,0 0 90px currentColor;}}
.duel-result-reveal{animation:duelResultSlam .6s cubic-bezier(.17,.67,.29,1.5);}
@keyframes duelResultSlam{0%{transform:scale(3) rotateZ(-10deg);opacity:0;}60%{transform:scale(1.1) rotateZ(2deg);opacity:1;}100%{transform:scale(1) rotateZ(0deg);opacity:1;}}
.duel-tension-bar{width:80%;max-width:300px;height:6px;background:var(--surface2);border-radius:3px;margin:12px auto;overflow:hidden;}
.duel-tension-fill{height:100%;border-radius:3px;background:linear-gradient(90deg,var(--gold),#ff4444);transition:width .1s linear;}
.duel-history{margin-top:16px;}
.duel-history-item{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:var(--surface);border:1px solid var(--border);border-radius:8px;margin-bottom:4px;font-size:11px;}

#rusroulettePanel{padding-top:60px!important;}
.bsr-title{font-family:'Orbitron';font-size:28px;font-weight:900;text-align:center;
  background:linear-gradient(135deg,#ff4444,#ff8800,#ffd700);-webkit-background-clip:text;-webkit-text-fill-color:transparent;
  margin-bottom:4px;letter-spacing:2px;}
.bsr-subtitle{font-size:12px;color:var(--text2);text-align:center;margin-bottom:18px;}

.bsr-lobby{max-width:480px;width:100%;margin:0 auto;text-align:center;}
.bsr-lobby .bsr-difficulty{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin:16px 0;}
.bsr-diff-card{background:var(--surface);border:2px solid var(--border);border-radius:14px;padding:16px 10px;cursor:pointer;transition:all .25s;}
.bsr-diff-card:hover,.bsr-diff-card.selected{border-color:var(--neon);background:rgba(0,240,255,.06);transform:translateY(-2px);}
.bsr-diff-card .diff-icon{font-size:28px;margin-bottom:6px;}
.bsr-diff-card .diff-name{font-family:'Orbitron';font-size:13px;font-weight:700;color:var(--text);margin-bottom:4px;}
.bsr-diff-card .diff-desc{font-size:10px;color:var(--text2);line-height:1.4;}
.bsr-diff-card .diff-mult{font-family:'Orbitron';font-size:14px;font-weight:900;color:var(--gold);margin-top:6px;}

.bsr-game{max-width:560px;width:100%;margin:0 auto;}
.bsr-top-bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;
  padding:10px 14px;background:var(--surface);border:1px solid var(--border);border-radius:12px;}
.bsr-round-badge{font-family:'Orbitron';font-size:14px;color:var(--neon);font-weight:800;letter-spacing:2px;}
.bsr-multiplier{font-family:'Orbitron';font-size:16px;color:var(--gold);font-weight:900;}
.bsr-shell-count{font-size:12px;color:var(--text2);}

.bsr-table{position:relative;background:linear-gradient(180deg,rgba(40,20,10,.5),rgba(20,10,5,.7));
  border:2px solid rgba(255,140,50,.2);border-radius:20px;padding:24px 16px;margin-bottom:14px;
  box-shadow:inset 0 0 60px rgba(0,0,0,.3),0 0 30px rgba(255,100,0,.08);}
.bsr-shotgun{display:flex;justify-content:center;align-items:center;margin:16px 0;min-height:60px;}
.bsr-shotgun-img{font-size:56px;transition:transform .3s;filter:drop-shadow(0 4px 12px rgba(255,100,0,.4));}
.bsr-shotgun-img.shake{animation:bsrShake .4s ease-in-out;}
.bsr-shotgun-img.recoil-left{animation:bsrRecoilLeft .5s ease-out;}
.bsr-shotgun-img.recoil-right{animation:bsrRecoilRight .5s ease-out;}
@keyframes bsrShake{0%,100%{transform:rotate(0)}25%{transform:rotate(-3deg) translateX(-4px)}50%{transform:rotate(2deg) translateX(3px)}75%{transform:rotate(-1deg)}}
@keyframes bsrRecoilLeft{0%{transform:rotate(0) translateX(0)}30%{transform:rotate(-15deg) translateX(-20px) scale(1.1)}100%{transform:rotate(0) translateX(0)}}
@keyframes bsrRecoilRight{0%{transform:rotate(0) translateX(0)}30%{transform:rotate(15deg) translateX(20px) scale(1.1)}100%{transform:rotate(0) translateX(0)}}

.bsr-rack{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-bottom:14px;}
.bsr-shell{width:32px;height:44px;border-radius:6px;display:flex;align-items:center;justify-content:center;
  font-size:12px;font-weight:700;transition:all .3s;position:relative;}
.bsr-shell.used{background:var(--surface2);opacity:0.25;}
.bsr-shell.used.was-live{border:1px solid rgba(255,68,68,.3);}
.bsr-shell.used.was-blank{border:1px solid rgba(68,136,255,.3);}
.bsr-shell.current{background:linear-gradient(135deg,var(--gold),#ff8800);box-shadow:0 0 14px rgba(255,200,0,.5);
  animation:bsrPulse 1.5s ease-in-out infinite;font-size:16px;}
.bsr-shell.unknown{background:var(--surface2);border:1px solid var(--border);}
.bsr-shell.reveal-live{background:linear-gradient(135deg,#ff4444,#cc0000);border-color:#ff4444;
  animation:bsrReveal .4s ease-out;}
.bsr-shell.reveal-blank{background:linear-gradient(135deg,#4488ff,#2255cc);border-color:#4488ff;
  animation:bsrReveal .4s ease-out;}
@keyframes bsrPulse{0%,100%{box-shadow:0 0 14px rgba(255,200,0,.5)}50%{box-shadow:0 0 24px rgba(255,200,0,.8)}}
@keyframes bsrReveal{0%{transform:scale(0.5);opacity:0}100%{transform:scale(1);opacity:1}}

.bsr-combatants{display:grid;grid-template-columns:1fr auto 1fr;gap:0;margin-bottom:16px;}
.bsr-fighter{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:16px;text-align:center;transition:all .3s;}
.bsr-fighter.hit{animation:bsrHit .4s ease-out;border-color:var(--red);}
@keyframes bsrHit{0%{background:rgba(255,68,68,.3)}100%{background:var(--surface)}}
.bsr-fighter-label{font-family:'Orbitron';font-size:11px;font-weight:700;letter-spacing:2px;margin-bottom:8px;}
.bsr-hp-text{font-family:'Orbitron';font-size:26px;font-weight:900;margin-bottom:6px;}
.bsr-hp-bar{height:8px;background:var(--surface2);border-radius:4px;overflow:hidden;margin-bottom:6px;}
.bsr-hp-fill{height:100%;border-radius:4px;transition:width .5s ease-out;}
.bsr-hearts{font-size:14px;letter-spacing:2px;}
.bsr-vs{display:flex;align-items:center;justify-content:center;padding:0 10px;
  font-family:'Orbitron';font-size:16px;color:var(--red);font-weight:900;}

.bsr-items-section{margin-bottom:14px;}
.bsr-items-label{font-family:'Orbitron';font-size:10px;color:var(--text2);letter-spacing:2px;margin-bottom:8px;text-align:center;}
.bsr-items{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;}
.bsr-item-btn{padding:8px 12px;border-radius:10px;background:var(--surface);border:1px solid var(--border);
  cursor:pointer;color:var(--text);font-size:12px;transition:all .2s;display:flex;align-items:center;gap:8px;text-align:left;}
.bsr-item-btn:hover:not(:disabled){border-color:var(--neon);background:rgba(0,240,255,.06);transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,240,255,.1);}
.bsr-item-btn:active:not(:disabled){transform:translateY(0);}
.bsr-item-btn:disabled,.bsr-item-btn.disabled{opacity:0.35;cursor:default;pointer-events:none;border-color:var(--border)!important;}
.bsr-item-btn .item-icon{font-size:20px;flex-shrink:0;}
.bsr-item-btn .item-info{display:flex;flex-direction:column;gap:1px;}
.bsr-item-btn .item-name{font-size:12px;font-weight:700;color:var(--text);line-height:1.2;}
.bsr-item-btn .item-desc{font-size:10px;color:var(--text2);line-height:1.3;}
.bsr-dealer-items{display:flex;gap:6px;justify-content:center;flex-wrap:wrap;margin-top:8px;}
.bsr-dealer-item{padding:4px 8px;border-radius:6px;background:rgba(255,68,68,.08);border:1px solid rgba(255,68,68,.15);
  font-size:11px;color:var(--text2);}

.bsr-status{text-align:center;font-size:15px;color:var(--gold);min-height:28px;margin-bottom:12px;
  font-weight:700;font-family:'Orbitron';letter-spacing:1px;}

.bsr-actions{display:flex;gap:12px;justify-content:center;margin-bottom:14px;}
.bsr-shoot-btn{padding:14px 32px;font-size:15px;font-weight:800;border-radius:12px;border:2px solid;
  cursor:pointer;transition:all .25s;font-family:'Orbitron';letter-spacing:1px;}
.bsr-shoot-btn:disabled{opacity:0.3;cursor:default;transform:none!important;}
.bsr-shoot-dealer{background:linear-gradient(135deg,rgba(255,68,68,.15),rgba(255,68,68,.05));
  border-color:rgba(255,68,68,.5);color:#ff4444;}
.bsr-shoot-dealer:hover:not(:disabled){background:linear-gradient(135deg,rgba(255,68,68,.3),rgba(255,68,68,.1));transform:translateY(-2px);}
.bsr-shoot-self{background:linear-gradient(135deg,rgba(0,240,255,.1),rgba(0,240,255,.03));
  border-color:rgba(0,240,255,.4);color:#00f0ff;}
.bsr-shoot-self:hover:not(:disabled){background:linear-gradient(135deg,rgba(0,240,255,.2),rgba(0,240,255,.06));transform:translateY(-2px);}

.bsr-log{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:12px;
  max-height:150px;overflow-y:auto;font-size:12px;color:var(--text2);line-height:1.6;}
.bsr-log-entry{padding:3px 0;border-bottom:1px solid rgba(255,255,255,.04);}
.bsr-log-entry:last-child{border-bottom:none;}
.bsr-log-line{padding:3px 0;border-bottom:1px solid rgba(255,255,255,.04);}
.bsr-log-line:last-child{border-bottom:none;}

.bsr-gameover{display:none;position:fixed;inset:0;background:rgba(4,8,20,.97);z-index:10003;
  align-items:center;justify-content:center;flex-direction:column;}
.bsr-gameover-box{text-align:center;max-width:480px;width:92vw;animation:bsrFadeIn .5s ease-out;}
@keyframes bsrFadeIn{0%{opacity:0;transform:translateY(30px)}100%{opacity:1;transform:translateY(0)}}

.bsr-round-splash{position:fixed;inset:0;background:rgba(4,8,20,.95);z-index:10004;
  display:flex;align-items:center;justify-content:center;transition:opacity .4s ease;}
.bsr-round-splash-text{font-family:'Orbitron';font-size:36px;font-weight:900;color:var(--gold);
  text-shadow:0 0 30px rgba(255,215,0,.5);animation:bsrPulse 1s ease-in-out infinite;}

#modBanOverlay,#modWarnOverlay{position:fixed;inset:0;z-index:100000;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.85);}
#modBanOverlay .mod-popup{background:var(--surface);border:3px solid #ff3333;border-radius:18px;padding:32px 28px;max-width:380px;width:90%;text-align:center;box-shadow:0 0 60px rgba(255,0,0,.4);animation:modShake .5s ease;}
#modWarnOverlay .mod-popup{background:var(--surface);border:3px solid #ffaa00;border-radius:18px;padding:32px 28px;max-width:380px;width:90%;text-align:center;box-shadow:0 0 60px rgba(255,170,0,.3);animation:modShake .5s ease;}
@keyframes modShake{0%,100%{transform:translateX(0)}15%{transform:translateX(-8px)}30%{transform:translateX(8px)}45%{transform:translateX(-5px)}60%{transform:translateX(5px)}75%{transform:translateX(-2px)}90%{transform:translateX(2px)}}
.mod-popup-icon{font-size:52px;margin-bottom:10px;}
.mod-popup-title{font-family:'Orbitron';font-size:18px;font-weight:900;letter-spacing:2px;margin-bottom:10px;}
.mod-popup-reason{font-size:13px;color:var(--text2);margin-bottom:14px;line-height:1.5;}
.mod-popup-timer{font-family:'Orbitron';font-size:22px;font-weight:700;color:var(--red);margin-bottom:8px;}
.mod-popup-sub{font-size:11px;color:var(--text2);}
#modMuteBanner{display:none;background:linear-gradient(90deg,rgba(255,100,0,.12),rgba(255,0,0,.08));border:1px solid rgba(255,100,0,.3);border-radius:8px;padding:6px 12px;margin:0 14px 6px;font-size:11px;color:#ff8844;text-align:center;}
.mod-warn-check{display:flex;align-items:center;gap:8px;justify-content:center;margin:14px 0 10px;cursor:pointer;font-size:12px;color:var(--text);}
.mod-warn-check input[type=checkbox]{width:16px;height:16px;accent-color:var(--gold);}
#modReasonModal{position:fixed;inset:0;z-index:100001;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.8);}
#modReasonModal .mod-reason-box{background:var(--surface);border:2px solid var(--border);border-radius:16px;padding:24px;max-width:360px;width:90%;box-shadow:0 0 40px rgba(0,0,0,.5);}
#modReasonModal .mod-reason-title{font-family:'Orbitron';font-size:14px;color:var(--gold);margin-bottom:14px;text-align:center;letter-spacing:1px;}
.mod-reason-btn{display:block;width:100%;padding:10px;margin-bottom:6px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:12px;cursor:pointer;transition:all .15s;text-align:left;}
.mod-reason-btn:hover{border-color:var(--neon);background:rgba(0,240,255,.05);}
.mod-reason-input{width:100%;padding:10px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:12px;margin-bottom:8px;outline:none;box-sizing:border-box;}
.mod-reason-input:focus{border-color:var(--neon);}
.mod-dur-row{display:flex;gap:6px;margin:10px 0;flex-wrap:wrap;}
.mod-dur-btn{flex:1;min-width:60px;padding:8px 4px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:11px;cursor:pointer;text-align:center;transition:all .15s;}
.mod-dur-btn:hover,.mod-dur-btn.active{border-color:var(--neon);color:var(--neon);background:rgba(0,240,255,.08);}
.mod-dur-cancel{padding:8px 16px;background:transparent;border:1px solid var(--border);border-radius:8px;color:var(--text2);font-size:11px;cursor:pointer;margin-top:6px;}
.mod-dur-cancel:hover{border-color:var(--red);color:var(--red);}
#modPanel{position:fixed;inset:0;z-index:99999;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.85);}
#modPanel .mod-panel-box{background:var(--surface);border:2px solid var(--gold);border-radius:16px;padding:0;max-width:520px;width:94%;max-height:80vh;overflow:hidden;box-shadow:0 0 50px rgba(0,0,0,.5);}
.mod-panel-header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid var(--border);background:linear-gradient(135deg,rgba(255,0,0,.06),rgba(255,136,0,.06));}
.mod-panel-title{font-family:'Orbitron';font-size:15px;color:var(--gold);letter-spacing:2px;}
.mod-panel-close{padding:6px 14px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);cursor:pointer;font-size:12px;}
.mod-panel-close:hover{border-color:var(--red);color:var(--red);}
.mod-panel-tabs{display:flex;border-bottom:1px solid var(--border);background:rgba(0,0,0,.1);}
.mod-panel-tab{flex:1;padding:10px;text-align:center;font-size:11px;font-weight:700;letter-spacing:1px;color:var(--text2);cursor:pointer;border-bottom:2px solid transparent;transition:all .15s;}
.mod-panel-tab:hover{color:var(--text);}
.mod-panel-tab.active{color:var(--neon);border-bottom-color:var(--neon);}
.mod-panel-content{padding:16px;overflow-y:auto;max-height:calc(80vh - 120px);}
.mod-panel-item{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:var(--bg);border:1px solid var(--border);border-radius:10px;margin-bottom:8px;}
.mod-panel-item-info{flex:1;min-width:0;}
.mod-panel-item-name{font-weight:700;font-size:13px;color:var(--text);}
.mod-panel-item-detail{font-size:10px;color:var(--text2);margin-top:2px;}
.mod-panel-item-actions{display:flex;gap:6px;}
.mod-panel-action{padding:5px 10px;border-radius:6px;border:none;font-size:10px;font-weight:700;cursor:pointer;transition:all .15s;}
.mod-panel-action.red{background:rgba(255,50,50,.15);color:#ff4444;border:1px solid rgba(255,50,50,.3);}
.mod-panel-action.red:hover{background:rgba(255,50,50,.3);}
.mod-panel-action.green{background:rgba(0,255,136,.1);color:var(--green);border:1px solid rgba(0,255,136,.2);}
.mod-panel-action.green:hover{background:rgba(0,255,136,.2);}
.mod-panel-action.blue{background:rgba(0,150,255,.1);color:#44aaff;border:1px solid rgba(0,150,255,.2);}
.mod-panel-action.blue:hover{background:rgba(0,150,255,.2);}
.mod-panel-empty{text-align:center;color:var(--text2);padding:30px;font-size:13px;}
.mod-panel-search{width:100%;padding:8px 12px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:12px;outline:none;margin-bottom:12px;box-sizing:border-box;}
.mod-panel-search:focus{border-color:var(--neon);}
.mod-chat-admin-btn{position:absolute;top:4px;right:4px;width:20px;height:20px;background:rgba(255,50,50,.7);border:none;border-radius:50%;color:#fff;font-size:10px;cursor:pointer;display:none;align-items:center;justify-content:center;z-index:2;transition:all .15s;}
.mod-chat-admin-btn:hover{background:rgba(255,50,50,1);transform:scale(1.1);}
.chat-msg{position:relative;}
.chat-msg:hover .mod-chat-admin-btn{display:flex;}

#adminAnnounceBanner{display:none;position:fixed;top:0;left:0;right:0;z-index:100003;background:linear-gradient(135deg,#ff0044,#ff6600,#ffd700);padding:0;overflow:hidden;box-shadow:0 4px 30px rgba(255,0,68,.5);animation:announceBannerSlide .5s ease-out;}
@keyframes announceBannerSlide{from{transform:translateY(-100%)}to{transform:translateY(0)}}
.announce-inner{display:flex;align-items:center;justify-content:center;gap:12px;padding:14px 20px;position:relative;}
.announce-icon{font-size:28px;animation:announcePulse 1s infinite;}
@keyframes announcePulse{0%,100%{transform:scale(1)}50%{transform:scale(1.2)}}
.announce-text{font-family:'Orbitron',sans-serif;font-size:14px;color:#fff;font-weight:900;letter-spacing:2px;text-shadow:0 2px 8px rgba(0,0,0,.4);text-align:center;flex:1;}
.announce-close{background:rgba(0,0,0,.3);border:none;color:#fff;font-size:16px;width:30px;height:30px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;}
.announce-close:hover{background:rgba(0,0,0,.5);}

#adminPollOverlay{display:none;position:fixed;inset:0;z-index:100001;background:rgba(0,0,0,.85);backdrop-filter:blur(8px);align-items:center;justify-content:center;}
.poll-box{background:linear-gradient(135deg,rgba(15,20,35,.98),rgba(25,30,50,.98));border:2px solid var(--gold);border-radius:20px;padding:28px;max-width:460px;width:92vw;text-align:center;animation:pollPop .5s cubic-bezier(.17,.67,.35,1.2);box-shadow:0 0 60px rgba(255,215,0,.15),0 20px 60px rgba(0,0,0,.5);}
@keyframes pollPop{from{transform:scale(.5) translateY(40px);opacity:0}to{transform:scale(1) translateY(0);opacity:1}}
.poll-title{font-family:'Orbitron';font-size:18px;color:var(--gold);letter-spacing:3px;margin-bottom:6px;text-shadow:0 0 20px rgba(255,215,0,.3);}
.poll-question{font-size:16px;color:var(--text);margin:16px 0;line-height:1.5;font-weight:500;}
.poll-option{display:flex;align-items:center;gap:12px;padding:14px 18px;background:rgba(255,255,255,.03);border:2px solid var(--border);border-radius:12px;margin-bottom:10px;cursor:pointer;transition:all .25s cubic-bezier(.4,0,.2,1);position:relative;overflow:hidden;}
.poll-option::before{content:'';position:absolute;inset:0;background:linear-gradient(90deg,rgba(0,255,136,.08),transparent);transform:translateX(-100%);transition:transform .3s;}
.poll-option:hover{border-color:var(--neon);background:rgba(0,255,136,.06);transform:translateX(4px);box-shadow:0 0 20px rgba(0,255,136,.1);}
.poll-option:hover::before{transform:translateX(0);}
.poll-option.voted{border-color:var(--green);background:rgba(0,255,136,.12);pointer-events:none;box-shadow:0 0 25px rgba(0,255,136,.15);}
.poll-option-text{flex:1;font-size:14px;font-weight:600;color:var(--text);text-align:left;z-index:1;}
.poll-option-bar{height:8px;background:rgba(255,255,255,.05);border-radius:4px;flex:1;overflow:hidden;display:none;}
.poll-option-bar-fill{height:100%;background:linear-gradient(90deg,var(--green),var(--neon),#00ffaa);border-radius:4px;transition:width .8s cubic-bezier(.4,0,.2,1);box-shadow:0 0 10px rgba(0,255,136,.4);}
.poll-option-pct{font-family:'Orbitron';font-size:12px;color:var(--neon);min-width:50px;text-align:right;display:none;font-weight:700;}
.poll-option.show-results .poll-option-bar{display:block;}
.poll-option.show-results .poll-option-pct{display:block;}
.poll-total{font-size:12px;color:var(--text2);margin-top:12px;font-weight:500;}
.poll-close-btn{margin-top:16px;padding:10px 28px;background:var(--surface2);border:1px solid var(--border);border-radius:10px;color:var(--text);cursor:pointer;font-size:12px;font-weight:600;transition:all .2s;}
.poll-close-btn:hover{border-color:var(--gold);background:rgba(255,215,0,.05);}

#adminAbuseOverlay{display:none;position:fixed;inset:0;z-index:100002;align-items:center;justify-content:center;flex-direction:column;overflow:hidden;transition:opacity .6s ease;}
.abuse-bg{position:absolute;inset:0;background:#000;z-index:0;transition:background .5s;}
.abuse-bg::before{content:'';position:absolute;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(255,0,0,.03) 2px,rgba(255,0,0,.03) 4px);z-index:1;pointer-events:none;animation:abuseScanlines 0.1s linear infinite;}
.abuse-bg::after{content:'';position:absolute;inset:0;z-index:2;animation:abuseFlash .15s linear infinite;pointer-events:none;}
@keyframes abuseScanlines{0%{transform:translateY(0)}100%{transform:translateY(4px)}}
@keyframes abuseFlash{0%{background:rgba(255,0,0,.15)}25%{background:rgba(0,0,0,.9)}50%{background:rgba(255,60,0,.12)}75%{background:rgba(0,0,0,.85)}100%{background:rgba(255,0,0,.1)}}
@keyframes abuseViolentShake{0%,100%{transform:translate(0)}5%{transform:translate(-15px,8px) rotate(-1deg)}10%{transform:translate(12px,-6px) rotate(1deg)}15%{transform:translate(-8px,12px) rotate(-2deg)}20%{transform:translate(15px,-4px) rotate(1.5deg)}25%{transform:translate(-12px,6px) rotate(-1deg)}30%{transform:translate(8px,-12px)}35%{transform:translate(-15px,8px) rotate(2deg)}40%{transform:translate(12px,-10px) rotate(-1.5deg)}45%{transform:translate(-6px,15px)}50%{transform:translate(0)}}
@keyframes abuseGlitch{0%{clip-path:inset(40% -6px 20% 0);transform:translate(-3px,2px)}5%{clip-path:inset(10% -6px 75% 0);transform:translate(3px,-1px)}10%{clip-path:inset(60% -6px 5% 0);transform:translate(-2px,3px)}15%{clip-path:inset(25% -6px 50% 0);transform:translate(4px,-2px)}20%{clip-path:inset(80% -6px 0% 0);transform:translate(-1px,1px)}25%{clip-path:inset(5% -6px 70% 0);transform:translate(2px,-3px)}30%{clip-path:inset(45% -6px 30% 0);transform:translate(-3px,2px)}35%{clip-path:inset(15% -6px 60% 0);transform:translate(1px,-1px)}40%{clip-path:inset(70% -6px 10% 0);transform:translate(-2px,3px)}50%{clip-path:inset(0);transform:translate(0)}100%{clip-path:inset(0);transform:translate(0)}}
@keyframes abusePulseGlow{0%{text-shadow:0 0 30px #ff0000,0 0 60px #ff0000,0 0 120px #ff0000;filter:brightness(1)}25%{text-shadow:0 0 60px #ff6600,0 0 120px #ff4400,0 0 200px #ff0000;filter:brightness(1.5)}50%{text-shadow:0 0 40px #ff0000,0 0 80px #ff0000,0 0 160px #ff0000;filter:brightness(1)}75%{text-shadow:0 0 80px #ff3300,0 0 160px #ff6600,0 0 240px #ff0000;filter:brightness(1.8)}100%{text-shadow:0 0 30px #ff0000,0 0 60px #ff0000,0 0 120px #ff0000;filter:brightness(1)}}
@keyframes abuseTextReveal{0%{opacity:0;transform:scale(3) rotate(-5deg);filter:blur(20px)}40%{opacity:1;transform:scale(1.1) rotate(2deg);filter:blur(0)}60%{transform:scale(.95) rotate(-1deg)}80%{transform:scale(1.02)}100%{transform:scale(1);filter:blur(0)}}
@keyframes abuseScreenTear{0%{clip-path:inset(0);transform:translateX(0)}8%{clip-path:polygon(0 0,100% 0,100% 30%,95% 30%,95% 32%,100% 32%,100% 100%,0 100%);transform:translateX(-5px)}16%{clip-path:polygon(0 0,100% 0,100% 55%,105% 55%,105% 57%,100% 57%,100% 100%,0 100%);transform:translateX(5px)}24%{clip-path:inset(0);transform:translateX(0)}}
@keyframes abuseRingExpand{0%{width:0;height:0;opacity:1;border-width:4px}60%{opacity:.5}100%{width:min(180vw,180vh);height:min(180vw,180vh);opacity:0;border-width:1px}}
@keyframes abuseEmojiDrop{0%{transform:translateY(0) rotate(0deg) scale(1);opacity:1}75%{opacity:1}100%{transform:translateY(110vh) rotate(var(--erot,720deg)) scale(.3);opacity:0}}
@keyframes abuseDangerSlide{0%{background-position:0 0}100%{background-position:60px 0}}
@keyframes abuseWarningFlicker{0%,18%{opacity:1}20%{opacity:0}22%,48%{opacity:1}50%{opacity:0}52%,100%{opacity:1}}
@keyframes abuseInvertFlash{0%{opacity:0}8%{opacity:.8}16%{opacity:0}28%{opacity:.6}36%{opacity:0}50%{opacity:.9}58%{opacity:0}100%{opacity:0}}
@keyframes abuseBorderPulse{0%{box-shadow:inset 0 0 60px rgba(255,0,0,.3),0 0 60px rgba(255,0,0,.2)}50%{box-shadow:inset 0 0 120px rgba(255,0,0,.6),0 0 120px rgba(255,0,0,.4)}100%{box-shadow:inset 0 0 60px rgba(255,0,0,.3),0 0 60px rgba(255,0,0,.2)}}
.abuse-content{position:relative;z-index:10;display:flex;flex-direction:column;align-items:center;justify-content:center;animation:abuseViolentShake .4s ease-in-out 3;}
.abuse-glitch-text{font-family:'Orbitron';font-size:clamp(32px,10vw,90px);color:#ff0000;font-weight:900;letter-spacing:clamp(4px,1vw,12px);text-align:center;line-height:1.1;animation:abusePulseGlow .5s ease-in-out infinite,abuseTextReveal .6s cubic-bezier(.2,.8,.2,1),abuseScreenTear .3s linear 2;position:relative;transition:font-size .4s cubic-bezier(.4,0,.2,1),letter-spacing .4s ease;}
.abuse-glitch-text::before,.abuse-glitch-text::after{content:attr(data-text);position:absolute;inset:0;font-family:inherit;font-size:inherit;font-weight:inherit;letter-spacing:inherit;}
.abuse-glitch-text::before{color:#0ff;animation:abuseGlitch .8s linear infinite;mix-blend-mode:screen;}
.abuse-glitch-text::after{color:#f0f;animation:abuseGlitch .8s linear infinite reverse;mix-blend-mode:screen;}
.abuse-warning-text{font-family:'Orbitron';font-size:clamp(10px,2vw,16px);color:#ff4400;letter-spacing:clamp(4px,1vw,14px);text-transform:uppercase;margin-bottom:14px;opacity:0;transition:opacity .3s;animation:abuseWarningFlicker .25s linear infinite;text-shadow:0 0 15px rgba(255,68,0,.7),0 0 30px rgba(255,0,0,.3);}
.abuse-subtitle{font-family:'Orbitron';font-size:clamp(11px,2.5vw,18px);color:#ff4400;letter-spacing:clamp(2px,0.5vw,6px);margin-top:16px;animation:abusePulseGlow .8s ease-in-out infinite .2s;text-align:center;text-transform:uppercase;opacity:0;transition:opacity .3s;}
.abuse-emoji-row{font-size:clamp(28px,6vw,56px);animation:abusePulseGlow .3s infinite;margin:12px 0;display:flex;gap:clamp(4px,1.2vw,12px);opacity:0;transition:opacity .3s;}
.abuse-siren{position:absolute;border-radius:50%;filter:blur(80px);animation:abuseSiren 0.3s ease-in-out infinite alternate;pointer-events:none;transition:all .6s ease;}
@keyframes abuseSiren{0%{opacity:.4;transform:scale(1)}100%{opacity:.8;transform:scale(1.2)}}
.abuse-siren-left{left:-10%;top:20%;width:300px;height:300px;background:#ff0000;}
.abuse-siren-right{right:-10%;top:20%;width:300px;height:300px;background:#0000ff;animation-delay:.15s;}
.abuse-bar{position:absolute;width:100%;height:4px;background:linear-gradient(90deg,transparent,#ff0000,#ff4400,#ff0000,transparent);animation:abuseBarScan 1s linear infinite;pointer-events:none;z-index:5;transition:height .3s,box-shadow .3s;}
@keyframes abuseBarScan{0%{top:-5%}100%{top:105%}}
.abuse-corner{position:absolute;width:40px;height:40px;border:3px solid #ff0000;animation:abusePulseGlow .5s infinite;z-index:5;transition:all .5s ease;}
.abuse-corner-tl{top:20px;left:20px;border-right:none;border-bottom:none;}
.abuse-corner-tr{top:20px;right:20px;border-left:none;border-bottom:none;}
.abuse-corner-bl{bottom:20px;left:20px;border-right:none;border-top:none;}
.abuse-corner-br{bottom:20px;right:20px;border-left:none;border-top:none;}
.abuse-particles{position:absolute;inset:0;pointer-events:none;z-index:3;}
.abuse-particle{position:absolute;background:#ff0000;border-radius:50%;animation:abuseParticleFly linear forwards;}
@keyframes abuseParticleFly{0%{opacity:1;transform:translate(0,0) scale(1)}100%{opacity:0;transform:translate(var(--dx),var(--dy)) scale(0)}}
.abuse-rings{position:absolute;inset:0;pointer-events:none;z-index:4;display:flex;align-items:center;justify-content:center;}
.abuse-ring{position:absolute;border-radius:50%;border:3px solid;animation:abuseRingExpand 1.4s ease-out forwards;box-shadow:0 0 20px currentColor,inset 0 0 20px currentColor;}
.abuse-emoji-rain{position:absolute;inset:0;pointer-events:none;z-index:6;overflow:hidden;}
.abuse-emoji-drop{position:absolute;top:-60px;font-size:clamp(18px,3.5vw,36px);animation:abuseEmojiDrop linear forwards;filter:drop-shadow(0 0 8px rgba(255,0,0,.5));}
.abuse-danger-stripe{position:absolute;left:0;right:0;height:clamp(22px,3.5vh,38px);background:repeating-linear-gradient(45deg,#000 0px,#000 10px,#ff0000 10px,#ff0000 20px,#000 20px,#000 30px);z-index:8;animation:abuseDangerSlide .3s linear infinite;box-shadow:0 0 30px rgba(255,0,0,.6);opacity:0;transition:opacity .4s;}
.abuse-danger-top{top:0;}.abuse-danger-bottom{bottom:0;}
.abuse-invert-flash{position:absolute;inset:0;background:#fff;mix-blend-mode:difference;pointer-events:none;z-index:9;animation:abuseInvertFlash .7s ease-out forwards;}
.abuse-vignette{position:absolute;inset:0;pointer-events:none;z-index:7;background:radial-gradient(ellipse at center,transparent 40%,rgba(255,0,0,.15) 70%,rgba(200,0,0,.4) 100%);animation:abuseBorderPulse .8s ease-in-out infinite;transition:all .5s;}
#adminAbuseOverlay.abuse-phase-2 .abuse-bg::after{animation-duration:.1s;}
#adminAbuseOverlay.abuse-phase-2 .abuse-siren{filter:blur(60px);}
#adminAbuseOverlay.abuse-phase-2 .abuse-siren-left{width:450px;height:450px;}
#adminAbuseOverlay.abuse-phase-2 .abuse-siren-right{width:450px;height:450px;background:#4400ff;}
#adminAbuseOverlay.abuse-phase-2 .abuse-bar{height:6px;box-shadow:0 0 20px rgba(255,0,0,.5);}
#adminAbuseOverlay.abuse-phase-2 .abuse-corner{width:60px;height:60px;border-color:#ff4400;}
#adminAbuseOverlay.abuse-phase-2 .abuse-vignette{background:radial-gradient(ellipse at center,transparent 30%,rgba(255,0,0,.2) 60%,rgba(200,0,0,.5) 100%);}
#adminAbuseOverlay.abuse-phase-3 .abuse-bg::after{animation-duration:.06s;}
#adminAbuseOverlay.abuse-phase-3 .abuse-siren{filter:blur(120px);}
#adminAbuseOverlay.abuse-phase-3 .abuse-siren-left{width:700px;height:700px;left:-15%;background:#ff2200;}
#adminAbuseOverlay.abuse-phase-3 .abuse-siren-right{width:700px;height:700px;right:-15%;background:#ff0044;}
#adminAbuseOverlay.abuse-phase-3 .abuse-bar{height:8px;box-shadow:0 0 40px rgba(255,0,0,.7);}
#adminAbuseOverlay.abuse-phase-3 .abuse-corner{width:100px;height:100px;border-width:5px;border-color:#ff6600;}
#adminAbuseOverlay.abuse-phase-3 .abuse-vignette{background:radial-gradient(ellipse at center,transparent 20%,rgba(255,0,0,.3) 50%,rgba(200,0,0,.7) 100%);}
#adminAbuseOverlay.abuse-phase-3 .abuse-danger-stripe{background:repeating-linear-gradient(45deg,#000 0px,#000 10px,#ff4400 10px,#ff4400 20px,#000 20px,#000 30px);height:clamp(28px,4.5vh,48px);}
#adminAbuseOverlay.abuse-fade .abuse-bg{opacity:.3;}

#adminEventOverlay{display:none;position:fixed;inset:0;z-index:99998;background:rgba(4,8,20,.98);flex-direction:column;backdrop-filter:blur(4px);}
.event-header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;background:linear-gradient(135deg,rgba(255,215,0,.08),rgba(255,0,68,.06));border-bottom:2px solid rgba(255,215,0,.3);flex-shrink:0;}
.event-title{font-family:'Orbitron';font-size:18px;color:var(--gold);letter-spacing:3px;text-shadow:0 0 20px rgba(255,215,0,.2);}
.event-close-btn{padding:8px 16px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);cursor:pointer;font-family:'Orbitron';font-size:11px;transition:all .2s;}
.event-close-btn:hover{border-color:var(--red);color:var(--red);}
.event-body{flex:1;display:flex;overflow:hidden;}
.event-chat-area{flex:1;display:flex;flex-direction:column;border-right:2px solid var(--border);}
.event-chat-msgs{flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:6px;}
.event-chat-input-wrap{display:flex;gap:8px;padding:12px;border-top:1px solid var(--border);background:var(--surface);}
.event-chat-input{flex:1;padding:10px 14px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px;outline:none;transition:border-color .2s;}
.event-chat-input:focus{border-color:var(--neon);box-shadow:0 0 10px rgba(0,255,136,.1);}
.event-chat-send{padding:10px 20px;background:linear-gradient(135deg,var(--green),#00cc88);border:none;border-radius:8px;color:#000;font-weight:700;cursor:pointer;font-size:12px;transition:all .2s;}
.event-chat-send:hover{transform:scale(1.05);box-shadow:0 0 15px rgba(0,255,136,.3);}
.event-chat-msg{display:flex;gap:8px;align-items:flex-start;animation:chatMsgIn .3s ease-out;}
@keyframes chatMsgIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.event-chat-msg.admin-msg{background:linear-gradient(135deg,rgba(255,215,0,.1),rgba(255,0,68,.06));border:1px solid rgba(255,215,0,.3);border-radius:12px;padding:12px 16px;box-shadow:0 0 15px rgba(255,215,0,.08);}
.event-chat-msg.admin-msg .ecm-user{font-size:14px;}
.event-chat-msg.admin-msg .ecm-text{font-size:16px;font-weight:600;}
.event-chat-msg.system-msg{background:linear-gradient(135deg,rgba(0,255,136,.05),rgba(0,200,255,.05));border:1px solid rgba(0,255,136,.2);border-radius:10px;padding:10px 14px;}
.event-chat-msg .ecm-user{font-weight:700;font-size:12px;color:var(--gold);}
.event-chat-msg .ecm-text{font-size:13px;color:var(--text);line-height:1.4;}
.event-chat-msg .ecm-time{font-size:9px;color:var(--text2);}
.event-admin-panel{width:340px;display:flex;flex-direction:column;background:linear-gradient(180deg,var(--surface),rgba(15,20,35,.98));overflow-y:auto;flex-shrink:0;}
.event-admin-title{font-family:'Orbitron';font-size:12px;color:var(--red);letter-spacing:2px;padding:14px 16px;border-bottom:1px solid var(--border);text-align:center;text-shadow:0 0 15px rgba(255,0,0,.2);}
.event-action-btn{display:flex;align-items:center;gap:12px;padding:14px 16px;background:rgba(255,255,255,.02);border:1px solid var(--border);border-radius:12px;margin:5px 10px;cursor:pointer;transition:all .25s cubic-bezier(.4,0,.2,1);color:var(--text);font-size:12px;font-weight:600;}
.event-action-btn:hover{border-color:var(--gold);background:rgba(255,215,0,.06);transform:translateX(4px);box-shadow:0 0 20px rgba(255,215,0,.05);}
.event-action-btn:active{transform:scale(.97);}
.event-action-btn .ea-icon{font-size:24px;}
.event-action-btn .ea-label{flex:1;}
.event-action-btn .ea-desc{font-size:9px;color:var(--text2);font-weight:400;margin-top:2px;}
.event-status{padding:12px 16px;font-size:11px;color:var(--text2);text-align:center;border-top:1px solid var(--border);margin-top:auto;}

@keyframes moneyFall{0%{transform:translateY(-10vh) rotate(0deg);opacity:1}80%{opacity:1}100%{transform:translateY(110vh) rotate(var(--rot,720deg));opacity:0}}
.money-rain{position:fixed;inset:0;pointer-events:none;z-index:100000;overflow:hidden;}
.money-bill{position:absolute;font-size:28px;animation:moneyFall linear forwards;filter:drop-shadow(0 0 6px rgba(255,215,0,.4));}
.money-rain-label{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:100000;pointer-events:none;font-family:'Orbitron';font-size:clamp(28px,8vw,64px);font-weight:900;color:#00ff88;text-shadow:0 0 40px rgba(0,255,136,.5),0 0 80px rgba(0,255,136,.3);animation:rainLabelPop 3s ease-out forwards;}
@keyframes rainLabelPop{0%{opacity:0;transform:translate(-50%,-50%) scale(.3)}15%{opacity:1;transform:translate(-50%,-50%) scale(1.1)}25%{transform:translate(-50%,-50%) scale(1)}80%{opacity:1}100%{opacity:0;transform:translate(-50%,-50%) scale(1) translateY(-30px)}}

@keyframes doubleExplode{0%{opacity:0;transform:scale(.1) rotate(-10deg);filter:blur(15px)}20%{opacity:1;transform:scale(1.3) rotate(3deg);filter:blur(0)}35%{transform:scale(.9) rotate(-1deg)}45%{transform:scale(1.05)}55%{transform:scale(1)}80%{opacity:1}100%{opacity:0;transform:scale(1.8);filter:blur(4px)}}
@keyframes doubleRing{0%{transform:translate(-50%,-50%) scale(0);opacity:1;border-width:8px}100%{transform:translate(-50%,-50%) scale(3);opacity:0;border-width:1px}}
.double-money-overlay{position:fixed;inset:0;z-index:100000;display:flex;align-items:center;justify-content:center;flex-direction:column;pointer-events:none;background:radial-gradient(circle,rgba(255,215,0,.1) 0%,transparent 70%);}
.double-money-text{font-family:'Orbitron';font-size:clamp(40px,12vw,100px);font-weight:900;color:#ffd700;text-shadow:0 0 40px rgba(255,215,0,.8),0 0 80px rgba(255,215,0,.4),0 0 120px rgba(255,215,0,.2);animation:doubleExplode 3s cubic-bezier(.2,.8,.2,1) forwards;}
.double-money-sub{font-family:'Orbitron';font-size:clamp(14px,4vw,28px);color:#fff;letter-spacing:6px;margin-top:8px;animation:doubleExplode 3s cubic-bezier(.2,.8,.2,1) .2s forwards;opacity:0;text-shadow:0 0 20px rgba(255,255,255,.3);}
.double-ring{position:absolute;top:50%;left:50%;width:100px;height:100px;border-radius:50%;border:6px solid rgba(255,215,0,.6);animation:doubleRing 1.5s ease-out forwards;pointer-events:none;}

@keyframes resetFlash{0%{opacity:0}10%{opacity:.3;background:#ff0000}20%{opacity:0}30%{opacity:.2;background:#ff0000}40%{opacity:0}100%{opacity:0}}
.reset-overlay{position:fixed;inset:0;z-index:100000;pointer-events:none;display:flex;align-items:center;justify-content:center;flex-direction:column;animation:resetFlash 2s ease-out forwards;}
.reset-text{font-family:'Orbitron';font-size:clamp(24px,6vw,60px);font-weight:900;color:#ff4444;text-shadow:0 0 40px rgba(255,0,0,.6);animation:doubleExplode 2.5s ease-out forwards;letter-spacing:4px;}

.fakereset-overlay{position:fixed;inset:0;z-index:100002;display:flex;align-items:center;justify-content:center;flex-direction:column;background:rgba(0,0,0,.95);pointer-events:all;}
.fakereset-title{font-family:'Orbitron';font-size:clamp(18px,4vw,36px);font-weight:900;color:#ff0000;text-shadow:0 0 30px rgba(255,0,0,.8),0 0 60px rgba(255,0,0,.4);letter-spacing:4px;margin-bottom:20px;animation:abusePulseGlow 1s ease-in-out infinite;}
.fakereset-countdown{font-family:'Orbitron';font-size:clamp(60px,15vw,140px);font-weight:900;color:#ff4444;text-shadow:0 0 60px rgba(255,0,0,.8),0 0 120px rgba(255,0,0,.4);transition:all .3s;animation:fakeResetPulse .5s ease-in-out infinite;}
.fakereset-jk{font-family:'Orbitron';font-size:clamp(48px,12vw,120px);font-weight:900;color:#00ff88;text-shadow:0 0 60px rgba(0,255,136,.8),0 0 120px rgba(0,255,136,.4);animation:fakeResetJk 1s ease-out forwards;letter-spacing:8px;}
.fakereset-sub{font-family:'Orbitron';font-size:clamp(14px,3vw,24px);color:#ffd700;margin-top:10px;opacity:0;animation:fakeResetSub .5s ease-out .3s forwards;}
@keyframes fakeResetPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
@keyframes fakeResetJk{0%{transform:scale(0) rotate(-20deg);opacity:0}50%{transform:scale(1.3) rotate(5deg);opacity:1}100%{transform:scale(1) rotate(0deg);opacity:1}}
@keyframes fakeResetSub{0%{opacity:0;transform:translateY(20px)}100%{opacity:1;transform:translateY(0)}}

@keyframes jackpotSpin{0%{transform:rotate(0deg)}100%{transform:rotate(1800deg)}}
@keyframes jackpotGlow{0%,100%{box-shadow:0 0 30px rgba(255,215,0,.4)}50%{box-shadow:0 0 80px rgba(255,215,0,.8),0 0 120px rgba(255,215,0,.3)}}
.jackpot-overlay{position:fixed;inset:0;z-index:100000;display:flex;align-items:center;justify-content:center;flex-direction:column;pointer-events:none;background:radial-gradient(circle,rgba(255,215,0,.08) 0%,transparent 60%);}
.jackpot-wheel{width:clamp(120px,30vw,200px);height:clamp(120px,30vw,200px);border-radius:50%;border:6px solid var(--gold);background:conic-gradient(#ff0044,#ff6600,#ffd700,#00ff88,#4488ff,#aa44ff,#ff0044);animation:jackpotSpin 3s cubic-bezier(.2,.8,.3,1) forwards,jackpotGlow .3s ease-in-out infinite;}
.jackpot-result{font-family:'Orbitron';font-size:clamp(28px,8vw,72px);font-weight:900;color:#ffd700;text-shadow:0 0 40px rgba(255,215,0,.6),0 0 80px rgba(255,215,0,.3);margin-top:20px;animation:doubleExplode 3s ease-out 3s forwards;opacity:0;}
.jackpot-label{font-family:'Orbitron';font-size:clamp(12px,3vw,20px);color:#fff;letter-spacing:4px;margin-top:8px;animation:doubleExplode 3s ease-out 3.2s forwards;opacity:0;}

@keyframes taxDrain{0%{opacity:0;transform:scale(.5)}20%{opacity:1;transform:scale(1.1)}40%{transform:scale(1)}80%{opacity:1}100%{opacity:0;transform:scale(1) translateY(-20px)}}
.tax-overlay{position:fixed;inset:0;z-index:100000;display:flex;align-items:center;justify-content:center;flex-direction:column;pointer-events:none;background:radial-gradient(circle,rgba(255,0,0,.08) 0%,transparent 60%);}
.tax-text{font-family:'Orbitron';font-size:clamp(32px,8vw,80px);font-weight:900;color:#ff4444;text-shadow:0 0 40px rgba(255,0,0,.5);animation:taxDrain 3s ease-out forwards;}
.tax-sub{font-family:'Orbitron';font-size:clamp(12px,3vw,22px);color:#ff8888;letter-spacing:4px;margin-top:8px;animation:taxDrain 3s ease-out .2s forwards;opacity:0;}

@keyframes coinFlipSpin{0%{transform:rotateY(0deg) scale(1)}50%{transform:rotateY(1800deg) scale(1.3)}100%{transform:rotateY(3600deg) scale(1)}}
.coinflip-overlay{position:fixed;inset:0;z-index:100000;display:flex;align-items:center;justify-content:center;flex-direction:column;pointer-events:none;perspective:600px;}
.coinflip-coin{width:clamp(80px,20vw,160px);height:clamp(80px,20vw,160px);border-radius:50%;background:linear-gradient(135deg,#ffd700,#ffaa00);border:4px solid #cc8800;display:flex;align-items:center;justify-content:center;font-size:clamp(40px,10vw,80px);animation:coinFlipSpin 3s cubic-bezier(.2,.8,.3,1) forwards;box-shadow:0 0 40px rgba(255,215,0,.4);}
.coinflip-result{font-family:'Orbitron';font-size:clamp(24px,6vw,56px);font-weight:900;margin-top:20px;letter-spacing:3px;animation:doubleExplode 3s ease-out 3s forwards;opacity:0;}

@keyframes prestigeReveal{0%{opacity:0;transform:scale(0) rotate(-15deg);filter:blur(15px)}40%{opacity:1;transform:scale(1.2) rotate(3deg);filter:blur(0)}60%{transform:scale(.9) rotate(-1deg)}80%{transform:scale(1.05)}100%{transform:scale(1)}}
@keyframes prestigeShine{0%{background-position:-200% center}100%{background-position:200% center}}
.prestige-anim-overlay{position:fixed;inset:0;z-index:100000;display:flex;align-items:center;justify-content:center;flex-direction:column;pointer-events:none;background:radial-gradient(circle,rgba(255,215,0,.1) 0%,transparent 60%);}
.prestige-anim-crown{font-size:clamp(60px,15vw,120px);animation:prestigeReveal .8s cubic-bezier(.2,.8,.2,1);filter:drop-shadow(0 0 30px rgba(255,215,0,.6));}
.prestige-anim-text{font-family:'Orbitron';font-size:clamp(28px,7vw,64px);font-weight:900;color:#ffd700;text-shadow:0 0 40px rgba(255,215,0,.6),0 0 80px rgba(255,215,0,.3);margin-top:16px;animation:prestigeReveal .8s cubic-bezier(.2,.8,.2,1) .3s both;letter-spacing:4px;}
.prestige-anim-level{font-family:'Orbitron';font-size:clamp(14px,3vw,24px);font-weight:700;margin-top:10px;letter-spacing:6px;background:linear-gradient(90deg,#ffd700,#fff,#ffd700);background-size:200% auto;-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;animation:prestigeReveal .8s cubic-bezier(.2,.8,.2,1) .5s both,prestigeShine 2s linear infinite .8s;}

.clickchallenge-overlay{position:fixed;inset:0;z-index:100003;display:flex;align-items:center;justify-content:center;flex-direction:column;background:rgba(0,0,0,.97);pointer-events:all;font-family:'Orbitron';user-select:none;-webkit-user-select:none;}
.cc-countdown-num{font-size:clamp(80px,20vw,180px);font-weight:900;color:#00ffcc;text-shadow:0 0 60px rgba(0,255,204,.8),0 0 120px rgba(0,255,204,.4);animation:ccPulse .5s ease-in-out infinite;}
.cc-explain{font-size:clamp(12px,3vw,22px);color:#fff;text-align:center;max-width:90%;line-height:1.6;letter-spacing:2px;margin-bottom:24px;}
.cc-explain strong{color:#00ffcc;}
.cc-click-area{width:clamp(200px,60vw,400px);height:clamp(200px,60vw,400px);border-radius:50%;background:radial-gradient(circle,#00ffcc 0%,#006655 60%,#002222 100%);display:flex;align-items:center;justify-content:center;flex-direction:column;cursor:pointer;box-shadow:0 0 60px rgba(0,255,204,.4),0 0 120px rgba(0,255,204,.2);transition:transform .05s,box-shadow .1s;position:relative;touch-action:none;-webkit-touch-callout:none;overflow:hidden;}
.cc-click-area:active{transform:scale(.95);box-shadow:0 0 80px rgba(0,255,204,.7),0 0 160px rgba(0,255,204,.4);}
.cc-click-count{font-size:clamp(48px,14vw,120px);font-weight:900;color:#fff;text-shadow:0 0 20px rgba(255,255,255,.5);pointer-events:none;}
.cc-click-label{font-size:clamp(10px,2.5vw,16px);color:rgba(255,255,255,.7);letter-spacing:3px;pointer-events:none;margin-top:4px;}
.cc-timer-bar{width:80%;max-width:400px;height:12px;border-radius:6px;background:rgba(255,255,255,.1);margin-top:24px;overflow:hidden;position:relative;}
.cc-timer-fill{height:100%;border-radius:6px;background:linear-gradient(90deg,#00ffcc,#00ff88);transition:width .05s linear;box-shadow:0 0 10px rgba(0,255,204,.6);}
.cc-timer-text{font-size:clamp(14px,3vw,22px);color:#00ffcc;margin-top:12px;letter-spacing:2px;}
.cc-target{font-size:clamp(10px,2vw,14px);color:rgba(255,255,255,.5);margin-top:8px;letter-spacing:1px;}
@keyframes ccPulse{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.08);opacity:.9}}
@keyframes ccWinExplode{0%{transform:scale(0) rotate(-20deg);opacity:0}50%{transform:scale(1.3) rotate(5deg);opacity:1}100%{transform:scale(1) rotate(0deg);opacity:1}}
@keyframes ccWinShine{0%{filter:hue-rotate(0deg) brightness(1)}50%{filter:hue-rotate(30deg) brightness(1.3)}100%{filter:hue-rotate(0deg) brightness(1)}}
@keyframes ccRainbow{0%{color:#ff0044}14%{color:#ff6600}28%{color:#ffd700}42%{color:#00ff88}57%{color:#00ccff}71%{color:#aa44ff}85%{color:#ff44aa}100%{color:#ff0044}}
@keyframes ccLoseFade{0%{opacity:0;transform:translateY(30px)}100%{opacity:1;transform:translateY(0)}}
.cc-ripple{position:absolute;border-radius:50%;border:2px solid rgba(0,255,204,.6);animation:ccRipple .6s ease-out forwards;pointer-events:none;}
@keyframes ccRipple{0%{width:0;height:0;opacity:1}100%{width:200px;height:200px;opacity:0;margin-left:-100px;margin-top:-100px;}}
.cc-win-particles{position:fixed;inset:0;pointer-events:none;z-index:100004;}
.cc-win-particle{position:absolute;width:8px;height:8px;border-radius:50%;animation:ccParticleFly 1.5s ease-out forwards;}
@keyframes ccParticleFly{0%{opacity:1;transform:translate(0,0) scale(1)}100%{opacity:0;transform:translate(var(--dx),var(--dy)) scale(0)}}

@media(max-width:600px){
  .event-body{flex-direction:column;}
  .event-admin-panel{width:100%;max-height:220px;border-right:none;border-top:2px solid var(--border);}
  .event-chat-area{border-right:none;}
}

</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
<noscript><div style="position:fixed;inset:0;background:#0a0a1a;color:#e8e8ff;display:flex;align-items:center;justify-content:center;font-family:sans-serif;font-size:18px;z-index:99999;text-align:center;padding:20px;">JavaScript is required to play Casino Royale. Please enable JavaScript in your browser settings.</div></noscript>
<script>window.addEventListener('error',function(e){console.warn('Global error:',e.message);});window.addEventListener('unhandledrejection',function(e){console.warn('Unhandled promise:',e.reason);});</script>

<div id="dbResetOverlay" style="display:none;"></div>
<script>

if (!localStorage.getItem('seen_db_switch_feb2026')) {
  const ov = document.getElementById('dbResetOverlay');
  ov.style.display = 'flex';
  ov.innerHTML = '<div class="db-reset-box"><div class="db-reset-icon">\ud83d\udd27</div><div class="db-reset-title">SERVER UPGRADE</div><div class="db-reset-msg">We had to switch to a new database \u2014 so many people were playing that the old one maxed out!<br><br>Everything has been reset. You\'ll need to <strong style=\"color:#ffd700;\">create a new account</strong> with your same username.<br><br>Sorry for the inconvenience! \ud83c\udfb0</div><button class="db-reset-btn" onclick="document.getElementById(\'dbResetOverlay\').style.display=\'none\';localStorage.setItem(\'seen_db_switch_feb2026\',\'1\');">GOT IT</button></div>';
}
</script>

<div id="updateChangelogOverlay" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;z-index:999998;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.85);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);animation:dbResetFadeIn .4s ease;"></div>
<script>
if (!localStorage.getItem('seen_update_v4')) {
  const ov = document.getElementById('updateChangelogOverlay');
  ov.style.display = 'flex';
  ov.innerHTML = '<div style="z-index:1;width:420px;max-height:80vh;overflow-y:auto;padding:32px 28px;background:linear-gradient(180deg,rgba(20,20,60,.97),rgba(12,12,30,.99));border:1px solid rgba(0,240,255,.3);border-radius:20px;box-shadow:0 0 80px rgba(0,240,255,.15),0 0 200px rgba(255,215,0,.08);text-align:center;animation:dbResetBoxIn .5s ease;">'
    + '<div style="font-size:48px;margin-bottom:8px;animation:dbResetPulse 2s ease infinite;">\ud83d\ude80</div>'
    + '<div style="font-family:Orbitron;font-weight:900;font-size:20px;background:linear-gradient(135deg,#00f0ff,#8847ff);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:6px;letter-spacing:2px;">NEW UPDATE!</div>'
    + '<div style="font-size:11px;color:rgba(255,255,255,.4);margin-bottom:16px;font-family:Orbitron;">v4.0 — PRESTIGE & CASES UPDATE</div>'
    + '<div style="text-align:left;font-size:13px;color:rgba(255,255,255,.85);line-height:1.8;margin-bottom:20px;">'
    + '<div style="font-family:Orbitron;font-size:12px;color:#ffd700;margin-bottom:6px;font-weight:700;">\ud83d\udc51 PRESTIGE BENEFITS</div>'
    + '<div style="padding-left:12px;margin-bottom:12px;">\u2022 Each prestige level now gives <b style=\"color:#4ade80;\">+5% win bonus</b> on ALL games!<br>\u2022 Level 5 = +25% bonus, Level 10 = +50% bonus, etc.<br>\u2022 Stacks with Lucky Potion boosts!</div>'
    + '<div style="font-family:Orbitron;font-size:12px;color:#ff8c00;margin-bottom:6px;font-weight:700;">\ud83c\udfb0 NEW CASES</div>'
    + '<div style="padding-left:12px;margin-bottom:12px;">\u2022 <b>Supernova Vault</b> ($1B) & <b>Omega Crate</b> ($25B) added<br>\u2022 All existing case prices rebalanced</div>'
    + '<div style="font-family:Orbitron;font-size:12px;color:#ff4500;margin-bottom:6px;font-weight:700;">\ud83d\udd25 LIMITED EDITION CASES</div>'
    + '<div style="padding-left:12px;margin-bottom:12px;">\u2022 <b style=\"color:#ff8c00;\">Inferno Box</b> ($500M), <b style=\"color:#ff8c00;\">Celestial Ark</b> ($10B), <b style=\"color:#ff8c00;\">God Box</b> ($100B)<br>\u2022 Exclusive items worth <b style=\"color:#ff4500;\">$500B — $5T!</b><br>\u2022 Way more valuable than any regular case!</div>'
    + '<div style="font-family:Orbitron;font-size:12px;color:#4ade80;margin-bottom:6px;font-weight:700;">\ud83d\udcb0 ITEM VALUE OVERHAUL</div>'
    + '<div style="padding-left:12px;margin-bottom:12px;">\u2022 All item base values massively increased (5-20x)<br>\u2022 Trading & selling actually worth it now!<br>\u2022 Mythic items worth up to <b style=\"color:#ffd700;\">$100B+</b></div>'
    + '</div>'
    + '<button onclick="document.getElementById(\'updateChangelogOverlay\').style.display=\'none\';localStorage.setItem(\'seen_update_v4\',\'1\');" style="padding:12px 32px;background:linear-gradient(135deg,#00f0ff,#8847ff);border:none;border-radius:10px;color:#fff;cursor:pointer;font-family:Orbitron;font-size:12px;font-weight:900;letter-spacing:1px;box-shadow:0 4px 20px rgba(0,240,255,.3);transition:all .2s;">AWESOME!</button>'
    + '</div>';
}
</script>

<div id="loginScreen">
  <div class="login-bg-particles" id="loginParticles"></div>
  <div class="login-box">
    <div class="login-logo">CASINO</div>
    <div class="login-subtitle">ROYALE</div>
    <div id="loginForm">
      <form onsubmit="event.preventDefault();authSubmit();" autocomplete="on">
      <input class="login-input" type="text" id="authUsername" placeholder="Username" autocomplete="username" maxlength="20">
      <input class="login-input" type="password" id="authPassword" placeholder="Password" autocomplete="current-password">
      <button type="submit" class="login-btn primary" id="authSubmitBtn">SIGN IN</button>
      </form>
      <button class="login-btn secondary" id="authToggleBtn" onclick="authToggleMode()">CREATE ACCOUNT</button>
      <button class="login-btn secondary" style="margin-top:4px;border-color:rgba(255,255,255,0.15);color:rgba(255,255,255,0.4);font-family:'Inter',sans-serif;font-size:13px;letter-spacing:0;" onclick="authGuestMode()">Sign in later</button>
      <div class="login-error" id="authError"></div>
      <div class="login-toggle" id="authToggleText">Don't have an account? <a onclick="authToggleMode()">Sign up</a></div>
    </div>
  </div>
</div>

<nav id="topNav" style="display:none;">
  <div class="logo" title="Home" style="cursor:pointer;">🏠 HOME</div>

  <button class="nav-btn-inline" onclick="openGamesMenu()" style="margin-left:3px;"><span class="icon">🎮</span><span class="nav-label">Games</span></button>

  <button class="nav-btn-inline" onclick="switchGame('leaderboard',this)"><span class="icon">🏆</span><span class="nav-label">Board</span></button>
  <button class="nav-btn-inline" onclick="switchGame('profile',this)"><span class="icon">👤</span><span class="nav-label">Profile</span></button>
  <button class="nav-btn-inline" onclick="showInventory()"><span class="icon">🎒</span><span class="nav-label">Inv</span></button>
  <button class="nav-btn-inline" onclick="openStoreOverlay()" style="border-color:rgba(255,215,0,.4);"><span class="icon">🏪</span><span class="nav-label">Store</span></button>
  <button class="nav-btn-inline" onclick="openShopOverlay()" style="border-color:rgba(0,200,255,.4);"><span class="icon">🛒</span><span class="nav-label">Shop</span></button>
  <button class="nav-btn-inline" onclick="openTradeOverlay()" style="border-color:rgba(0,230,118,.4);"><span class="icon">🔄</span><span class="nav-label">Trade</span></button>
  <button class="nav-btn-inline" onclick="showFriendsPanel()" style="position:relative;"><span class="icon">👥</span><span class="nav-label">Friends</span><span id="friendReqBadge" style="position:absolute;top:-2px;right:-2px;background:var(--red);color:#fff;font-size:8px;padding:1px 4px;border-radius:8px;display:none;"></span></button>
  <button class="nav-btn-inline" onclick="openSettingsPanel()" style="border-color:rgba(255,255,255,.2);"><span class="icon">⚙️</span><span class="nav-label">Settings</span></button>

  <div id="balanceDisplay">
    <button id="muteBtn" onclick="toggleMute()" style="padding:5px 8px;border:none;border-radius:6px;cursor:pointer;background:var(--surface2);color:var(--text);font-size:13px;transition:all .2s;" title="Toggle Sound">🔊</button>
    <button class="daily-bonus-btn" id="dailyBonusBtn" onclick="claimDailyBonus()" style="font-size:11px;padding:4px 10px;">🎁 DAILY</button>
    <div class="bal">$<span id="balText">1000.00</span></div>
    <button class="add-btn" onclick="addMoney(500)">💸 PITY $500</button>
    <div class="user-info">
      <div class="user-avatar" id="userAvatar"><svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false"><defs><linearGradient id="avG0" x1="0" x2="1"><stop offset="0" stop-color="#00f0ff"/><stop offset="1" stop-color="#6b2fd9"/></linearGradient></defs><circle cx="50" cy="50" r="48" fill="url(#avG0)"/><text x="50" y="58" font-family="Orbitron,Inter,sans-serif" font-weight="900" font-size="48" fill="#fff" text-anchor="middle">G</text></svg></div>
      <span class="user-name" id="userNameDisplay">...</span>
      <button class="logout-btn" onclick="authLogout()" title="Logout" aria-label="Logout">⏻</button>
    </div>
  </div>
</nav>

<div id="gamesMenuOverlay" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(4,8,20,.92);z-index:9998;padding-top:60px;overflow-y:auto;-webkit-overflow-scrolling:touch;">
  <div style="max-width:800px;margin:0 auto;padding:20px;position:relative;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;position:sticky;top:0;background:rgba(4,8,20,.95);padding:12px;border-radius:8px;z-index:1;">
      <span style="font-family:'Orbitron';font-size:24px;color:var(--neon);font-weight:900;letter-spacing:2px;">🎮 ALL GAMES</span>
      <button onclick="closeGamesMenu()" style="background:none;border:none;color:var(--text2);font-size:24px;cursor:pointer;padding:0;width:32px;height:32px;display:flex;align-items:center;justify-content:center;">✕</button>
    </div>

    <div id="gamesCategoriesContainer" style="display:grid;gap:20px;"></div>
  </div>
</div>

<div id="settingsOverlay" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(4,8,20,.94);z-index:9999;overflow-y:auto;-webkit-overflow-scrolling:touch;">
  <div style="max-width:500px;margin:60px auto 40px;padding:20px;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">
      <span style="font-family:'Orbitron';font-size:22px;color:var(--neon);font-weight:900;letter-spacing:2px;">⚙️ SETTINGS</span>
      <button onclick="closeSettingsPanel()" style="background:none;border:none;color:var(--text2);font-size:24px;cursor:pointer;">✕</button>
    </div>

    <div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:12px;">
      <div style="font-family:'Orbitron';font-size:12px;color:var(--gold);letter-spacing:2px;margin-bottom:12px;">🔊 SOUND</div>
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <span style="color:var(--text);font-size:13px;">Sound Effects</span>
        <label style="position:relative;display:inline-block;width:48px;height:26px;cursor:pointer;">
          <input type="checkbox" id="settingSound" onchange="settingToggle('sound',this.checked)" style="opacity:0;width:0;height:0;">
          <span style="position:absolute;inset:0;background:var(--surface2);border-radius:26px;transition:.3s;"></span>
          <span id="settingSoundKnob" style="position:absolute;top:3px;left:3px;width:20px;height:20px;background:var(--text2);border-radius:50%;transition:.3s;"></span>
        </label>
      </div>
    </div>

    <div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:12px;">
      <div style="font-family:'Orbitron';font-size:12px;color:var(--gold);letter-spacing:2px;margin-bottom:12px;">✨ VISUAL EFFECTS</div>
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
        <span style="color:var(--text);font-size:13px;">Particles</span>
        <label style="position:relative;display:inline-block;width:48px;height:26px;cursor:pointer;">
          <input type="checkbox" id="settingParticles" onchange="settingToggle('particles',this.checked)" style="opacity:0;width:0;height:0;">
          <span style="position:absolute;inset:0;background:var(--surface2);border-radius:26px;transition:.3s;"></span>
          <span id="settingParticlesKnob" style="position:absolute;top:3px;left:3px;width:20px;height:20px;background:var(--text2);border-radius:50%;transition:.3s;"></span>
        </label>
      </div>
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <span style="color:var(--text);font-size:13px;">Reduced Animations</span>
        <label style="position:relative;display:inline-block;width:48px;height:26px;cursor:pointer;">
          <input type="checkbox" id="settingReducedAnim" onchange="settingToggle('reducedAnim',this.checked)" style="opacity:0;width:0;height:0;">
          <span style="position:absolute;inset:0;background:var(--surface2);border-radius:26px;transition:.3s;"></span>
          <span id="settingReducedAnimKnob" style="position:absolute;top:3px;left:3px;width:20px;height:20px;background:var(--text2);border-radius:50%;transition:.3s;"></span>
        </label>
      </div>
    </div>

    <div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:12px;">
      <div style="font-family:'Orbitron';font-size:12px;color:var(--gold);letter-spacing:2px;margin-bottom:12px;">🎨 THEME</div>
      <div id="themeButtons" style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;">
        <button onclick="setTheme('dark')" class="theme-btn" data-theme="dark" style="padding:10px;border-radius:8px;border:2px solid var(--border);background:linear-gradient(135deg,#040814,#0a0f2e);color:#00f0ff;cursor:pointer;font-size:12px;font-weight:700;">🌑 Dark</button>
        <button onclick="setTheme('midnight')" class="theme-btn" data-theme="midnight" style="padding:10px;border-radius:8px;border:2px solid var(--border);background:linear-gradient(135deg,#0d0221,#1a0533);color:#d32ce6;cursor:pointer;font-size:12px;font-weight:700;">🌌 Midnight</button>
        <button onclick="setTheme('ocean')" class="theme-btn" data-theme="ocean" style="padding:10px;border-radius:8px;border:2px solid var(--border);background:linear-gradient(135deg,#001a33,#003366);color:#00bfff;cursor:pointer;font-size:12px;font-weight:700;">🌊 Ocean</button>
        <button onclick="setTheme('forest')" class="theme-btn" data-theme="forest" style="padding:10px;border-radius:8px;border:2px solid var(--border);background:linear-gradient(135deg,#0a1f0a,#183a18);color:#00e676;cursor:pointer;font-size:12px;font-weight:700;">🌲 Forest</button>
        <button onclick="setTheme('crimson')" class="theme-btn" data-theme="crimson" style="padding:10px;border-radius:8px;border:2px solid var(--border);background:linear-gradient(135deg,#1a0505,#330a0a);color:#ff4444;cursor:pointer;font-size:12px;font-weight:700;">🔥 Crimson</button>
        <button onclick="setTheme('gold')" class="theme-btn" data-theme="gold" style="padding:10px;border-radius:8px;border:2px solid var(--border);background:linear-gradient(135deg,#1a1500,#332a00);color:#ffd700;cursor:pointer;font-size:12px;font-weight:700;">👑 Gold</button>
      </div>
    </div>

    <div style="text-align:center;color:var(--text2);font-size:11px;margin-top:16px;">Casino v3.0 · Island</div>
  </div>
</div>

<div id="shopOverlay" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(4,8,20,.94);z-index:9999;overflow-y:auto;-webkit-overflow-scrolling:touch;">
  <div style="max-width:600px;margin:60px auto 40px;padding:20px;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">
      <span style="font-family:'Orbitron';font-size:22px;color:var(--gold);font-weight:900;letter-spacing:2px;">🛒 SHOP</span>
      <button onclick="closeShopOverlay()" style="background:none;border:none;color:var(--text2);font-size:24px;cursor:pointer;">✕</button>
    </div>
    <div style="color:var(--text2);font-size:12px;margin-bottom:16px;">Balance: $<span id="shopBalText">0</span></div>

    <div style="font-family:'Orbitron';font-size:13px;color:var(--neon);letter-spacing:2px;margin-bottom:12px;">🧪 POTIONS</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px;">

      <div style="background:var(--surface);border:1px solid rgba(255,215,0,.3);border-radius:12px;padding:16px;text-align:center;">
        <div style="font-size:36px;margin-bottom:6px;">🍀</div>
        <div style="font-weight:700;color:var(--gold);margin-bottom:4px;">Luck Potion</div>
        <div style="font-size:11px;color:var(--text2);margin-bottom:8px;">+5% better odds for 10 minutes. Stacks up to 5x!</div>
        <div style="font-size:11px;color:var(--neon);margin-bottom:8px;">Active: <span id="shopLuckCount">0</span>/5 stacks</div>
        <button onclick="shopBuyPotion('luck')" class="action-btn primary" style="padding:8px 16px;font-size:12px;">$2,000</button>
      </div>

      <div style="background:var(--surface);border:1px solid rgba(0,240,255,.3);border-radius:12px;padding:16px;text-align:center;">
        <div style="font-size:36px;margin-bottom:6px;">⚡</div>
        <div style="font-weight:700;color:var(--neon);margin-bottom:4px;">Speed Potion</div>
        <div style="font-size:11px;color:var(--text2);margin-bottom:8px;">2x faster game animations for 15 minutes.</div>
        <div style="font-size:11px;color:var(--neon);margin-bottom:8px;">Active: <span id="shopSpeedActive">OFF</span></div>
        <button onclick="shopBuyPotion('speed')" class="action-btn primary" style="padding:8px 16px;font-size:12px;">$3,000</button>
      </div>

      <div style="background:var(--surface);border:1px solid rgba(0,230,118,.3);border-radius:12px;padding:16px;text-align:center;">
        <div style="font-size:36px;margin-bottom:6px;">🛡️</div>
        <div style="font-weight:700;color:var(--green);margin-bottom:4px;">Shield Potion</div>
        <div style="font-size:11px;color:var(--text2);margin-bottom:8px;">Prevents loss of more than 50% of your bet for 5 mins.</div>
        <div style="font-size:11px;color:var(--neon);margin-bottom:8px;">Active: <span id="shopShieldActive">OFF</span></div>
        <button onclick="shopBuyPotion('shield')" class="action-btn primary" style="padding:8px 16px;font-size:12px;">$5,000</button>
      </div>

      <div style="background:var(--surface);border:1px solid rgba(138,43,226,.3);border-radius:12px;padding:16px;text-align:center;">
        <div style="font-size:36px;margin-bottom:6px;">📈</div>
        <div style="font-weight:700;color:#8a2be2;margin-bottom:4px;">XP Boost</div>
        <div style="font-size:11px;color:var(--text2);margin-bottom:8px;">2x stats tracking multiplier for 20 minutes.</div>
        <div style="font-size:11px;color:var(--neon);margin-bottom:8px;">Active: <span id="shopXPActive">OFF</span></div>
        <button onclick="shopBuyPotion('xp')" class="action-btn primary" style="padding:8px 16px;font-size:12px;">$4,000</button>
      </div>
    </div>

    <div style="font-family:'Orbitron';font-size:13px;color:var(--gold);letter-spacing:2px;margin-bottom:12px;">⏱️ ACTIVE EFFECTS</div>
    <div id="shopActiveEffects" style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:20px;min-height:40px;">
      <div style="color:var(--text2);font-size:12px;text-align:center;">No active effects</div>
    </div>
  </div>
</div>

<div id="gameCatalog" style="position:fixed;top:50px;left:0;right:0;bottom:0;display:flex;flex-wrap:wrap;justify-content:center;align-content:flex-start;gap:32px;padding:32px 16px 60px;background:var(--surface1);z-index:10;overflow-y:auto;-webkit-overflow-scrolling:touch;">
  <div class="catalog-card" onclick="switchGame('slots',this)"><span class="icon">🎰</span><div>Slots</div></div>
  <div class="catalog-card" onclick="switchGame('crash',this)"><span class="icon">📈</span><div>Crash</div></div>
  <div class="catalog-card" onclick="switchGame('mines',this)"><span class="icon">💣</span><div>Mines</div></div>
  <div class="catalog-card" onclick="switchGame('plinko',this)"><span class="icon">⚡</span><div>Plinko</div></div>
  <div class="catalog-card" onclick="switchGame('cases',this)"><span class="icon">📦</span><div>Cases</div></div>
  <div class="catalog-card" onclick="switchGame('blackjack',this)"><span class="icon">🃏</span><div>Blackjack</div></div>
  <div class="catalog-card" onclick="switchGame('poker',this)"><span class="icon">♠️</span><div>Video Poker</div></div>
  <div class="catalog-card" onclick="switchGame('baccarat',this)"><span class="icon">🎴</span><div>Baccarat</div></div>
  <div class="catalog-card" onclick="switchGame('hilo',this)"><span class="icon">↕️</span><div>Hi-Lo</div></div>
  <div class="catalog-card" onclick="switchGame('roulette',this)"><span class="icon">🎡</span><div>Roulette</div></div>
  <div class="catalog-card" onclick="switchGame('wheel',this)"><span class="icon">💫</span><div>Wheel</div></div>
  <div class="catalog-card" onclick="switchGame('keno',this)"><span class="icon">🔢</span><div>Keno</div></div>
  <div class="catalog-card" onclick="switchGame('horses',this)"><span class="icon">🏇</span><div>Horse Racing</div></div>
  <div class="catalog-card" onclick="switchGame('dice',this)"><span class="icon">🎯</span><div>Dice</div></div>
  <div class="catalog-card" onclick="switchGame('limbo',this)"><span class="icon">🚀</span><div>Limbo</div></div>
  <div class="catalog-card" onclick="switchGame('coinflip',this)"><span class="icon">🪙</span><div>Coin Flip</div></div>
  <div class="catalog-card" onclick="switchGame('tower',this)"><span class="icon">🗼</span><div>Tower</div></div>
  <div class="catalog-card" onclick="switchGame('scratch',this)"><span class="icon">🎫</span><div>Scratch Cards</div></div>
  <div class="catalog-card" onclick="switchGame('luck',this)"><span class="icon">🎲</span><div>Push Your Luck</div></div>
  <div class="catalog-card" onclick="switchGame('stocks',this)"><span class="icon">📊</span><div>Stocks</div></div>
  <div class="catalog-card" onclick="switchGame('rusroulette',this)"><span class="icon">🔫</span><div>Buckshot Roulette</div></div>
  <div class="catalog-card" onclick="switchGame('russianr',this)"><span class="icon">🎰</span><div>Russian Roulette</div></div>
  <div class="catalog-card" onclick="switchGame('mpbsr',this)"><span class="icon">💥</span><div>MP Buckshot</div></div>
  <div class="catalog-card" onclick="switchGame('crypto',this)"><span class="icon">₿</span><div>Crypto</div></div>
  <div class="catalog-card" onclick="switchGame('duels',this)"><span class="icon">⚔️</span><div>Duels</div></div>
  <div class="catalog-card" onclick="switchGame('cups',this)" style="border-color:rgba(224,64,251,.5);"><span class="icon">🏆</span><div>Cup Shuffle</div><span style="position:absolute;top:4px;right:4px;font-size:8px;background:linear-gradient(135deg,#e040fb,#7c4dff);color:#fff;padding:2px 6px;border-radius:4px;font-weight:900;">NEW</span></div>
</div>

<canvas id="particles"></canvas>

<div class="win-toast" id="winToast"></div>

<div class="game-panel" id="slotsPanel">
  <div class="htp-box"><button class="htp-toggle" onclick="htpToggle(this)"><span class="htp-arrow">▶</span> HOW TO PLAY</button><div class="htp-content"><ul><li>Set your <strong>bet amount</strong> using the bet controls.</li><li>Press <strong>SPIN</strong> to spin the reels.</li><li>Match <strong>3+ symbols</strong> in a row to win — multiplier depends on the symbol.</li><li>Special symbols like 💎 and 👑 pay the highest.</li><li>Wins are calculated as <strong>bet × symbol multiplier</strong>.</li></ul></div></div>
  <div class="slots-machine">
    <div class="slots-header">MEGA SLOTS</div>
    <div class="reels-container" id="reelsContainer">
      <div class="payline-indicator"></div>
    </div>
    <div class="slots-info">Match 3+ symbols on the payline to win!</div>
  </div>

  <div style="display:flex;align-items:center;gap:16px;margin-top:4px;">
    <div class="bet-controls">
      <span style="color:var(--text2);font-size:13px;font-weight:600;">BET</span>
      <button class="bet-btn bet-half" onclick="adjustBet('slotsBet',0.5)">½</button>
      <input class="bet-input" type="text" id="slotsBet" value="10" title="Bet amount">
      <button class="bet-btn bet-double" onclick="adjustBet('slotsBet',2)">2×</button>
      <button class="bet-btn" onclick="betAll('slotsBet')" style="background:var(--gold);color:#000;font-weight:900;font-size:10px;">MAX</button>
    </div>
    <button class="action-btn primary" id="spinBtn" onclick="spinSlots()">SPIN</button>
  </div>
</div>

<div class="game-panel" id="crashPanel">
  <div class="htp-box"><button class="htp-toggle" onclick="htpToggle(this)"><span class="htp-arrow">▶</span> HOW TO PLAY</button><div class="htp-content"><ul><li>Set your <strong>bet amount</strong> before the round starts.</li><li>Press <strong>START</strong> — the multiplier begins climbing from 1.00×.</li><li>Press <strong>CASH OUT</strong> before the rocket crashes to lock in your win.</li><li>If you don't cash out in time, you <strong>lose your bet</strong>.</li><li>The crash point is random — it could crash at 1.01× or go past 100×!</li></ul></div></div>
  <div class="crash-container">
    <canvas class="crash-canvas" id="crashCanvas"></canvas>
    <div class="crash-multiplier" id="crashMultiplier">1.00×</div>
  </div>
  <div class="crash-status" id="crashStatus">Place your bet and start the round</div>

  <div style="display:flex;align-items:center;gap:16px;">
    <div class="bet-controls">
      <span style="color:var(--text2);font-size:13px;font-weight:600;">BET</span>
      <button class="bet-btn bet-half" onclick="adjustBet('crashBet',0.5)">½</button>
      <input class="bet-input" type="text" id="crashBet" value="10">
      <button class="bet-btn bet-double" onclick="adjustBet('crashBet',2)">2×</button>
      <button class="bet-btn" onclick="betAll('crashBet')" style="background:var(--gold);color:#000;font-weight:900;font-size:10px;">MAX</button>
    </div>
    <button class="action-btn primary" id="crashStartBtn" onclick="startCrash()">START</button>
    <button class="action-btn danger" id="cashoutBtn" onclick="cashOut()" style="display:none">CASH OUT</button>
  </div>
</div>

<div class="game-panel" id="roulettePanel">
  <div class="htp-box"><button class="htp-toggle" onclick="htpToggle(this)"><span class="htp-arrow">▶</span> HOW TO PLAY</button><div class="htp-content"><ul><li>Place bets on <strong>numbers, colors, or sections</strong> of the wheel.</li><li>Choose Red (2×), Black (2×), Green (36×), or specific number ranges.</li><li>Press <strong>SPIN</strong> to spin the roulette wheel.</li><li>If the ball lands on your selection, you win <strong>bet × the multiplier</strong>.</li><li>Green (0) is the rarest outcome but pays the most.</li></ul></div></div>
  <div class="roulette-wrapper">
    <div class="roulette-pointer"></div>
    <canvas class="roulette-canvas" id="rouletteCanvas" width="360" height="360"></canvas>
  </div>
  <div class="roulette-result" id="rouletteResult"></div>
  <div class="roulette-bets" id="rouletteBetsDiv">
    <button class="roul-bet-btn red-btn" onclick="selectRoulBet('red',this)">🔴 Red</button>
    <button class="roul-bet-btn black-btn" onclick="selectRoulBet('black',this)">⚫ Black</button>
    <button class="roul-bet-btn green-btn" onclick="selectRoulBet('green',this)">💚 Green</button>
    <button class="roul-bet-btn" onclick="selectRoulBet('odd',this)">Odd</button>
    <button class="roul-bet-btn" onclick="selectRoulBet('even',this)">Even</button>
    <button class="roul-bet-btn" onclick="selectRoulBet('1-18',this)">1-18</button>
    <button class="roul-bet-btn" onclick="selectRoulBet('19-36',this)">19-36</button>
  </div>

  <div style="display:flex;align-items:center;gap:16px;">
    <div class="bet-controls">
      <span style="color:var(--text2);font-size:13px;font-weight:600;">BET</span>
      <button class="bet-btn bet-half" onclick="adjustBet('roulBetInput',0.5)">½</button>
      <input class="bet-input" type="text" id="roulBetInput" value="10">
      <button class="bet-btn bet-double" onclick="adjustBet('roulBetInput',2)">2×</button>
      <button class="bet-btn" onclick="betAll('roulBetInput')" style="background:var(--gold);color:#000;font-weight:900;font-size:10px;">MAX</button>
    </div>
    <button class="action-btn primary" id="roulSpinBtn" onclick="spinRoulette()">SPIN</button>
  </div>
</div>

<div class="game-panel" id="casesPanel">
  <div class="htp-box"><button class="htp-toggle" onclick="htpToggle(this)"><span class="htp-arrow">▶</span> HOW TO PLAY</button><div class="htp-content"><ul><li>Choose a <strong>case tier</strong> — higher tiers have rarer items!</li><li>Press <strong>OPEN CASE</strong> to spin and reveal your prize.</li><li>Items go to your <strong>inventory</strong> — sell or trade them!</li><li>Market prices change live based on <strong>global supply &amp; demand</strong>.</li><li>🔥 Hit a streak bonus by opening cases back-to-back!</li></ul></div></div>

  <div id="caseStatsBar" style="display:flex;gap:12px;align-items:center;justify-content:center;flex-wrap:wrap;">
    <div style="padding:6px 12px;background:var(--surface);border:1px solid var(--border);border-radius:8px;font-size:11px;">
      <span style="color:var(--text2);">Cases Opened:</span> <span id="caseOpenCount" style="color:var(--gold);font-family:'Orbitron';font-weight:700;">0</span>
    </div>
    <div style="padding:6px 12px;background:var(--surface);border:1px solid var(--border);border-radius:8px;font-size:11px;">
      <span style="color:var(--text2);">Streak:</span> <span id="caseStreak" style="color:var(--neon);font-family:'Orbitron';font-weight:700;">0</span>
      <span id="caseStreakBonus" style="color:var(--green);font-size:10px;font-weight:600;"></span>
    </div>
    <div style="padding:6px 12px;background:var(--surface);border:1px solid var(--border);border-radius:8px;font-size:11px;">
      <span style="color:var(--text2);">Best:</span> <span id="caseBestItem" style="color:var(--gold);font-size:10px;font-weight:600;">—</span>
    </div>
  </div>

  <div class="case-selector" id="caseSelector"></div>

  <div class="case-opener" id="caseOpener">
    <div class="case-pointer"></div>
    <div class="case-strip" id="caseStrip"></div>

    <div id="caseFlash" style="position:absolute;top:0;left:0;right:0;bottom:0;pointer-events:none;opacity:0;transition:opacity 0.3s;z-index:10;"></div>
  </div>

  <div class="case-won" id="caseWon"></div>
  <div class="case-won-detail" id="caseWonDetail"></div>

  <div style="display:flex;gap:8px;align-items:center;justify-content:center;flex-wrap:wrap;">
    <button class="action-btn primary" id="openCaseBtn" onclick="openCase()" style="min-width:160px;">🎰 OPEN CASE</button>
    <button class="action-btn primary" id="quickOpenBtn" onclick="quickOpenCase()" style="min-width:120px;background:linear-gradient(135deg,#8847ff,#6b2fd9);box-shadow:0 4px 20px rgba(136,71,255,.3);">⚡ QUICK OPEN</button>
  </div>

  <div id="caseRecentFeed" style="display:flex;gap:6px;overflow-x:auto;width:min(700px,92vw);padding:4px 0;margin-top:4px;"></div>

  <div style="margin-top:16px;width:min(700px,92vw);">
    <div style="font-family:'Orbitron';font-size:13px;color:var(--gold);letter-spacing:2px;margin-bottom:10px;">⏱️ LIMITED EDITION CASES</div>
    <div id="limitedCasesContainer" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px;"></div>
  </div>
</div>

<div class="game-panel" id="plinkoPanel">
  <div class="htp-box"><button class="htp-toggle" onclick="htpToggle(this)"><span class="htp-arrow">▶</span> HOW TO PLAY</button><div class="htp-content"><ul><li>Set your <strong>bet</strong> and choose <strong>risk level</strong> (Low/Medium/High).</li><li>Press <strong>DROP</strong> to release a ball from the top.</li><li>The ball bounces off pegs randomly as it falls down.</li><li>Higher risk = bigger potential wins but also more losing slots.</li><li>The slot the ball lands in determines your <strong>multiplier</strong>.</li></ul></div></div>
  <div class="plinko-sidebar">
    <div style="font-family:'Orbitron';font-size:18px;font-weight:700;color:var(--neon);margin-bottom:8px;">PLINKO</div>
    <div>
      <label>Bet Amount</label>
      <div style="display:flex;gap:6px;">
        <input type="text" id="plinkoBet" value="10" style="flex:1;">
        <button class="bet-btn bet-half" onclick="adjustBet('plinkoBet',0.5)" style="padding:6px 10px;">½</button>
        <button class="bet-btn bet-double" onclick="adjustBet('plinkoBet',2)" style="padding:6px 10px;">2×</button>
        <button class="bet-btn" onclick="betAll('plinkoBet')" style="padding:6px 10px;background:var(--gold);color:#000;font-weight:900;font-size:10px;">MAX</button>
      </div>
    </div>
    <div>
      <label>Risk</label>
      <select id="plinkoRisk">
        <option value="LOW">Low</option>
        <option value="MEDIUM" selected>Medium</option>
        <option value="HIGH">High</option>
      </select>
    </div>
    <div>
      <label>Rows</label>
      <select id="plinkoRows">
        <option value="8">8</option><option value="9">9</option><option value="10">10</option>
        <option value="11">11</option><option value="12">12</option><option value="13">13</option>
        <option value="14">14</option><option value="15">15</option><option value="16" selected>16</option>
      </select>
    </div>

    <div style="display:flex;gap:8px;margin-top:8px;">
      <button class="action-btn primary" onclick="dropPlinkoBall()" style="flex:1;">DROP BALL</button>
    </div>
    <button class="action-btn primary" id="autoDropBtn" onclick="toggleAutoDrop()" style="width:100%;background:linear-gradient(135deg,#3355cc,#2244aa);box-shadow:0 4px 20px rgba(51,85,204,.3);margin-top:8px;">AUTO DROP</button>

    <div class="plinko-live-stats" style="margin-top:12px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
        <div style="display:flex;align-items:center;gap:6px;"><span style="font-size:14px;">📈</span><span style="font-size:12px;font-weight:600;color:#fff;">Live Stats</span></div>
        <button class="action-btn" onclick="resetPlinkoStats()" style="padding:4px 10px;font-size:10px;" title="Reset Live Stats">↻ Reset</button>
      </div>

      <div style="display:flex;background:rgba(15,23,42,0.8);border-radius:8px;padding:10px 12px;font-size:12px;margin-bottom:8px;">
        <div style="flex:1;">
          <div style="color:var(--text2);font-weight:500;margin-bottom:2px;">Profit</div>
          <div id="plinkoProfit" style="font-weight:700;font-variant-numeric:tabular-nums;color:#4ade80;">$0.00</div>
        </div>
        <div style="width:1px;background:rgba(100,116,139,0.4);margin:0 12px;" aria-hidden></div>
        <div style="flex:1;">
          <div><div style="color:var(--text2);font-weight:500;margin-bottom:2px;">Wins</div><div id="plinkoWins" style="font-weight:700;font-variant-numeric:tabular-nums;color:#4ade80;">0</div></div>
          <div style="margin-top:6px;"><div style="color:var(--text2);font-weight:500;margin-bottom:2px;">Losses</div><div id="plinkoLosses" style="font-weight:700;font-variant-numeric:tabular-nums;color:#f87171;">0</div></div>
        </div>
      </div>

      <div style="background:rgba(15,23,42,0.8);border-radius:8px;padding:10px 12px;">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;">
          <div style="color:var(--text2);font-weight:500;font-size:12px;">Profit History</div>
          <div id="plinkoHoverValue" style="font-size:12px;font-weight:600;font-variant-numeric:tabular-nums;"></div>
        </div>
        <div style="height:120px;margin-top:8px;">
          <canvas id="plinkoProfitChart" style="width:100%;height:100%;display:block;"></canvas>
        </div>
      </div>
      <div style="margin-top:6px;font-size:11px;color:var(--text2);">Balls dropped: <span id="plinkoDropCount">0</span></div>
    </div>
  </div>
  <div class="plinko-main">
    <div class="plinko-canvas-wrap">
      <canvas id="plinkoCanvas"></canvas>
      <div class="plinko-bins" id="plinkoBins"></div>
    </div>
    <div class="plinko-last-wins" id="plinkoLastWins"></div>
  </div>
</div>

<div class="game-panel" id="luckPanel">
  <div class="htp-box"><button class="htp-toggle" onclick="htpToggle(this)"><span class="htp-arrow">▶</span> HOW TO PLAY</button><div class="htp-content"><ul><li>This is a <strong>multiplayer trivia game</strong>!</li><li>Answer questions correctly to earn points and avoid Whammy spaces.</li><li>Press your luck to keep going, or stop to keep your points.</li><li>Landing on a <strong>Whammy</strong> loses all your round points.</li><li>The player with the most points at the end wins!</li></ul></div></div>

  <div class="pyl-lobby" id="pylLobby">
    <div class="pyl-title">PUSH YOUR LUCK</div>
    <div class="pyl-subtitle">Choose your game mode</div>

    <div class="pyl-modes">
      <div class="pyl-mode" onclick="pylStartMode('solo')">
        <div class="pm-icon">🎲</div>
        <div class="pm-name">FREE PLAY</div>
        <div class="pm-desc">Practice mode. No wagers, just vibes.</div>
      </div>
      <div class="pyl-mode" onclick="pylShowWager('1v1')">
        <div class="pm-icon">⚔️</div>
        <div class="pm-name">1v1 WAGER</div>
        <div class="pm-desc">Create or join a room. Both play, highest score takes the pot.</div>
        <div class="pm-badge">COMPETITIVE</div>
      </div>
      <div class="pyl-mode" onclick="pylShowWager('highstakes')">
        <div class="pm-icon">💀</div>
        <div class="pm-name">HIGH STAKES</div>
        <div class="pm-desc">Solo play with massive multiplier wagers. Risk it all.</div>
        <div class="pm-badge">2x — 10x PAYOUT</div>
      </div>
      <div class="pyl-mode" onclick="pylStartMode('tournament')">
        <div class="pm-icon">🏆</div>
        <div class="pm-name">TOURNAMENT</div>
        <div class="pm-desc">Compete on the global leaderboard. Top scores win prizes.</div>
        <div class="pm-badge">LEADERBOARD</div>
      </div>
    </div>

    <div class="pyl-room" id="pylRoomUI" style="display:none;">
      <div class="pr-title" id="pylRoomTitle">1v1 WAGER MATCH</div>
      <div style="display:flex;gap:8px;justify-content:center;margin-bottom:12px;">
        <div class="bet-controls">
          <span style="color:var(--text2);font-size:12px;font-weight:600;">WAGER $</span>
          <input class="bet-input" type="number" id="pylWager" value="100" min="10" style="width:80px;">
        </div>
      </div>
      <div style="display:flex;gap:8px;justify-content:center;margin-bottom:12px;">
        <button class="action-btn primary" onclick="pylCreateRoom()" style="font-size:12px;padding:10px 20px;">CREATE ROOM</button>
        <div style="display:flex;gap:4px;">
          <input class="bet-input" type="text" id="pylJoinCode" placeholder="CODE" style="width:70px;text-transform:uppercase;text-align:center;">
          <button class="action-btn primary" onclick="pylJoinRoom()" style="font-size:12px;padding:10px 16px;background:linear-gradient(135deg,#8847ff,#6b2fd9);">JOIN</button>
        </div>
      </div>
      <div class="pr-status" id="pylRoomStatus">Create a room or enter a code to join</div>
      <div class="pr-players" id="pylRoomPlayers"></div>
      <button class="pyl-back-btn" onclick="pylBackToLobby()" style="margin-top:10px;">← Back to modes</button>
    </div>

    <div class="pyl-room" id="pylHighStakesUI" style="display:none;">
      <div class="pr-title">💀 HIGH STAKES</div>
      <div style="color:var(--text2);font-size:12px;margin-bottom:12px;">
        Set your target score. If you hit it, you win BIG. If you don't... you lose it all.
      </div>
      <div style="display:flex;gap:10px;justify-content:center;align-items:center;margin-bottom:12px;flex-wrap:wrap;">
        <div class="bet-controls">
          <span style="color:var(--text2);font-size:11px;font-weight:600;">WAGER $</span>
          <input class="bet-input" type="number" id="pylHSWager" value="500" min="50" style="width:80px;">
        </div>
        <div class="bet-controls">
          <span style="color:var(--text2);font-size:11px;font-weight:600;">TARGET</span>
          <select id="pylHSTarget" style="background:var(--bg);color:var(--text);border:1px solid var(--border);border-radius:6px;padding:6px;font-size:12px;">
            <option value="500" data-mult="2">500 pts (2x)</option>
            <option value="1000" data-mult="3">1000 pts (3x)</option>
            <option value="2000" data-mult="5">2000 pts (5x)</option>
            <option value="5000" data-mult="10">5000 pts (10x)</option>
          </select>
        </div>
      </div>
      <button class="action-btn primary" onclick="pylStartHighStakes()" style="font-size:14px;padding:12px 30px;">
        🔥 LOCK IT IN
      </button>
      <button class="pyl-back-btn" onclick="pylBackToLobby()" style="margin-top:10px;">← Back to modes</button>
    </div>

    <div class="pyl-leaderboard" id="pylLeaderboard">
      <div class="pyl-lb-title">🏆 TOP SCORES</div>
      <div id="pylLBRows"></div>
    </div>
  </div>

  <div class="pyl-overlay hidden" id="pylOverlay">
    <div class="pyl-score-card">
      <div class="psc-label" id="pylModeLabel">FREE PLAY</div>
      <div class="psc-val" style="color:var(--neon);" id="pylScoreDisplay">Score: —</div>
    </div>
    <div class="pyl-score-card" id="pylOpponentCard" style="display:none;">
      <div class="psc-label">⚔️ <span id="pylOpponentName">OPPONENT</span></div>
      <div class="psc-val" style="color:var(--red);" id="pylOpponentScore">—</div>
    </div>
    <div class="pyl-score-card" id="pylWagerCard" style="display:none;">
      <div class="psc-label">WAGER</div>
      <div class="psc-val" style="color:var(--gold);" id="pylWagerDisplay">$0</div>
    </div>
    <button class="pyl-back-btn" onclick="pylEndGame()">END GAME</button>
    <input type="hidden" id="pylScoreInput" value="0">
  </div>
</div>

<div class="game-panel" id="stocksPanel">
  <div class="htp-box"><button class="htp-toggle" onclick="htpToggle(this)"><span class="htp-arrow">▶</span> HOW TO PLAY</button><div class="htp-content"><ul><li>Pick a stock from the ticker bar below.</li><li><strong>Buy</strong> shares of any stock at the current market price.</li><li><strong>Sell All</strong> to cash out your position and lock in profit or cut losses.</li><li>All prices are <strong>synced live</strong> across all players (deterministic market).</li><li>Higher volatility = bigger swings. Watch the chart and time your trades!</li></ul></div></div>

  <div id="stockTickerBar" style="display:flex;gap:6px;padding:6px 8px;overflow-x:auto;width:100%;box-sizing:border-box;"></div>

  <div class="stock-hero">
    <div class="sh-ticker"><span class="stock-live-dot"></span><span id="stockTickerLabel">$GMBL</span> <span style="color:#8b949e;font-weight:400;" id="stockNameLabel">Gamble Corp</span></div>
    <div class="sh-price" id="stockPriceDisplay">$100.00</div>
    <div class="sh-change" id="stockChangeDisplay"></div>
  </div>

  <div class="stock-chart-wrap">
    <canvas id="stockChart"></canvas>
  </div>
  <div class="stock-portfolio">
    <div class="sp-stat"><div class="sp-label">Shares</div><div class="sp-val" id="stockShares">0</div></div>
    <div class="sp-stat"><div class="sp-label">Value</div><div class="sp-val" id="stockValue">$0</div></div>
    <div class="sp-stat"><div class="sp-label">P&L</div><div class="sp-val" id="stockPnl" style="color:#8b949e;">$0</div></div>
  </div>
  <div class="stock-actions-row">
    <button class="sa-btn sa-buy" onclick="buyStock(selectedStock)">BUY</button>
    <button class="sa-btn sa-sell" id="stockSellBtn" onclick="sellStock(selectedStock)" disabled>SELL ALL</button>
  </div>
  <div class="stock-amt-row">
    <div class="bet-controls">
      <span style="color:#8b949e;font-size:12px;font-weight:600;">$</span>
      <button class="bet-btn bet-half" onclick="adjustBet('stockBuyAmt',0.5)">½</button>
      <input class="bet-input" type="number" id="stockBuyAmt" value="100" min="1" style="width:80px;">
      <button class="bet-btn bet-double" onclick="adjustBet('stockBuyAmt',2)">2×</button>
    </div>
  </div>

  <div id="stockPortfolioOverview" style="width:100%;margin-top:8px;"></div>
</div>

<div class="game-panel" id="cryptoPanel">
  <div class="htp-box"><button class="htp-toggle" onclick="htpToggle(this)"><span class="htp-arrow">▶</span> HOW TO PLAY</button><div class="htp-content"><ul>
    <li>Buy and sell <strong>cryptocurrencies</strong> with your casino balance.</li>
    <li>Prices update every 3 seconds with realistic volatility.</li>
    <li>Enter a <strong>dollar amount</strong> and click BUY to acquire coins.</li>
    <li>SELL to sell a specific dollar amount, or <strong>SELL ALL</strong> to liquidate.</li>
    <li>Watch the sparkline charts for trends. Meme coins swing wildly!</li>
  </ul></div></div>
  <div style="text-align:center;margin-bottom:12px;">
    <span style="font-family:'Orbitron';font-size:24px;font-weight:900;background:linear-gradient(135deg,#f7931a,#ffd700);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">₿ CRYPTO TRADING</span>
    <div style="font-size:11px;color:var(--text2);margin-top:4px;">Buy, hold, and trade cryptocurrencies</div>
  </div>
  <div id="cryptoContent" style="max-height:600px;overflow-y:auto;"></div>
</div>

<div class="game-panel" id="blackjackPanel">
  <div class="htp-box"><button class="htp-toggle" onclick="htpToggle(this)"><span class="htp-arrow">▶</span> HOW TO PLAY</button><div class="htp-content"><ul><li>Set your <strong>bet</strong> and press <strong>DEAL</strong> to start.</li><li>Try to get your cards as close to <strong>21</strong> as possible without going over.</li><li><strong>HIT</strong> for another card, <strong>STAND</strong> to keep your hand.</li><li>Face cards = 10, Aces = 1 or 11. Beat the dealer to win <strong>2× your bet</strong>.</li><li>Blackjack (Ace + 10-value) pays <strong>2.5× your bet</strong>!</li></ul></div></div>
  <div class="bj-table">
    <div class="bj-label">DEALER <span class="bj-score" id="bjDealerScore">—</span></div>
    <div class="bj-area" id="bjDealerCards"></div>
    <hr style="border-color:rgba(255,255,255,.1);margin:8px 0;">
    <div class="bj-label">YOU <span class="bj-score" id="bjPlayerScore">—</span></div>
    <div class="bj-area" id="bjPlayerCards"></div>
  </div>
  <div id="bjResult"></div>

  <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:center;">
    <div class="bet-controls">
      <span style="color:var(--text2);font-size:12px;font-weight:600;">BET</span>
      <button class="bet-btn bet-half" onclick="adjustBet('bjBet',0.5)">½</button>
      <input class="bet-input" type="text" id="bjBet" value="10">
      <button class="bet-btn bet-double" onclick="adjustBet('bjBet',2)">2×</button>
      <button class="bet-btn" onclick="betAll('bjBet')" style="background:var(--gold);color:#000;font-weight:900;font-size:10px;">MAX</button>
    </div>
    <button class="action-btn primary" id="bjDealBtn" onclick="bjDeal()">DEAL</button>
    <button class="action-btn primary" id="bjHitBtn" onclick="bjHit()" disabled style="background:linear-gradient(135deg,#3355cc,#2244aa);">HIT</button>
    <button class="action-btn danger" id="bjStandBtn" onclick="bjStand()" disabled>STAND</button>
    <button class="action-btn primary" id="bjDoubleBtn" onclick="bjDouble()" disabled style="background:linear-gradient(135deg,#cc8800,#996600);">2×</button>
  </div>
</div>

<div class="game-panel" id="minesPanel">
  <div class="htp-box"><button class="htp-toggle" onclick="htpToggle(this)"><span class="htp-arrow">▶</span> HOW TO PLAY</button><div class="htp-content"><ul><li>Set your <strong>bet</strong> and choose the <strong>number of mines</strong> (1-24).</li><li>Click tiles to reveal gems 💎 — each safe tile increases your multiplier.</li><li>Hit a mine 💣 and you <strong>lose everything</strong>.</li><li>Press <strong>CASH OUT</strong> anytime to collect your current winnings.</li><li>More mines = higher risk but <strong>bigger multipliers</strong> per tile!</li></ul></div></div>
  <div class="mines-wrap">
    <div class="mines-side">
      <div style="font-family:'Orbitron';font-size:14px;font-weight:700;color:var(--neon);">💣 MINES</div>
      <label>Bet</label>
      <div style="display:flex;gap:4px;">
        <input type="text" id="minesBet" value="10" style="flex:1;">
        <button class="bet-btn bet-half" onclick="adjustBet('minesBet',0.5)" style="padding:4px 8px;">½</button>
        <button class="bet-btn bet-double" onclick="adjustBet('minesBet',2)" style="padding:4px 8px;">2×</button>
        <button class="bet-btn" onclick="betAll('minesBet')" style="padding:4px 8px;background:var(--gold);color:#000;font-weight:900;font-size:10px;">MAX</button>
      </div>
      <label>Mines</label>
      <select id="mineCount"><option value="1">1</option><option value="3" selected>3</option><option value="5">5</option><option value="10">10</option><option value="15">15</option><option value="24">24</option></select>

      <div id="minesMultiplier">1.00×</div>
      <div id="minesProfit">Next: $0.00</div>
      <button class="action-btn primary" id="minesStartBtn" onclick="minesStart()" style="width:100%;font-size:12px;padding:8px;">START</button>
      <button class="action-btn danger" id="minesCashoutBtn" onclick="minesCashout()" style="width:100%;display:none;font-size:12px;padding:8px;">CASH OUT</button>
    </div>
    <div class="mines-grid" id="minesGrid"></div>
  </div>
</div>

<div class="game-panel" id="dicePanel">
  <div class="htp-box"><button class="htp-toggle" onclick="htpToggle(this)"><span class="htp-arrow">▶</span> HOW TO PLAY</button><div class="htp-content"><ul><li>Choose <strong>Roll Over</strong> or <strong>Roll Under</strong> mode.</li><li>Use the slider to set your <strong>target number</strong> (2-98).</li><li>The closer to the edge, the higher the multiplier but lower the chance.</li><li>Press <strong>ROLL</strong> — if the dice result matches your prediction, you win!</li><li>Win chance and multiplier are shown before you roll.</li></ul></div></div>
  <div class="dice-roll-display" id="diceDisplay">—</div>
  <div class="dice-mode-btns">
    <button class="dice-mode-btn active" id="diceOverBtn" onclick="diceSetMode('over')">Roll Over</button>
    <button class="dice-mode-btn" id="diceUnderBtn" onclick="diceSetMode('under')">Roll Under</button>
  </div>
  <div class="dice-slider-wrap">
    <input type="range" class="dice-slider" id="diceSlider" min="2" max="98" value="50" oninput="diceUpdateSlider()">
  </div>

  <div class="dice-info">
    <span>Target: <span id="diceTarget">50.00</span></span>
    <span>Chance: <span id="diceChance">50.00%</span></span>
    <span>Payout: <span id="dicePayout">1.98×</span></span>
  </div>
  <div style="display:flex;align-items:center;gap:12px;">
    <div class="bet-controls">
      <span style="color:var(--text2);font-size:12px;font-weight:600;">BET</span>
      <button class="bet-btn bet-half" onclick="adjustBet('diceBet',0.5)">½</button>
      <input class="bet-input" type="text" id="diceBet" value="10">
      <button class="bet-btn bet-double" onclick="adjustBet('diceBet',2)">2×</button>
      <button class="bet-btn" onclick="betAll('diceBet')" style="background:var(--gold);color:#000;font-weight:900;font-size:10px;">MAX</button>
    </div>
    <button class="action-btn primary" onclick="diceRoll()">ROLL</button>
  </div>

</div>

<div class="game-panel" id="towerPanel">
  <div class="htp-box"><button class="htp-toggle" onclick="htpToggle(this)"><span class="htp-arrow">▶</span> HOW TO PLAY</button><div class="htp-content"><ul><li>Set your <strong>bet</strong> and choose <strong>difficulty</strong> (Easy to Insane).</li><li>Each row has safe tiles and trap tiles — click a tile to climb.</li><li>Each safe tile increases your <strong>multiplier</strong>.</li><li>Hit a trap 💀 and you <strong>lose your bet</strong>.</li><li>Press <strong>CASH OUT</strong> anytime to collect. Higher floors = bigger wins!</li></ul></div></div>
  <div id="towerInfo">Pick a difficulty and start climbing!</div>

  <div class="tower-grid" id="towerGrid"></div>
  <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:center;">
    <div class="bet-controls">
      <span style="color:var(--text2);font-size:12px;font-weight:600;">BET</span>
      <button class="bet-btn bet-half" onclick="adjustBet('towerBet',0.5)">½</button>
      <input class="bet-input" type="text" id="towerBet" value="10">
      <button class="bet-btn bet-double" onclick="adjustBet('towerBet',2)">2×</button>
      <button class="bet-btn" onclick="betAll('towerBet')" style="background:var(--gold);color:#000;font-weight:900;font-size:10px;">MAX</button>
    </div>
    <select id="towerDiff" style="padding:7px;border-radius:6px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:12px;">
      <option value="easy">Easy (4 cols)</option><option value="medium" selected>Medium (3 cols)</option><option value="hard">Hard (4 cols, 2 safe)</option><option value="insane">Insane (4 cols, 1 safe)</option>
    </select>
    <button class="action-btn primary" id="towerStartBtn" onclick="towerStart()">START</button>
    <button class="action-btn danger" id="towerCashoutBtn" onclick="towerCashout()" style="display:none;">CASH OUT</button>
  </div>
</div>

<div class="game-panel" id="coinflipPanel">
  <div class="htp-box"><button class="htp-toggle" onclick="htpToggle(this)"><span class="htp-arrow">▶</span> HOW TO PLAY</button><div class="htp-content"><ul><li>Set your <strong>bet amount</strong>.</li><li>Choose <strong>Heads</strong> or <strong>Tails</strong>.</li><li>The coin flips — if it matches your pick, you win <strong>2× your bet</strong>!</li><li>Simple 50/50 odds — pure luck!</li><li>Watch the result history strip to spot streaks.</li></ul></div></div>
  <div class="coin" id="coinDisplay">🪙</div>
  <div id="coinResult"></div>

  <div class="coin-choices">
    <button class="coin-choice selected" id="coinHeads" onclick="coinSelect('heads')">👑 Heads</button>
    <button class="coin-choice" id="coinTails" onclick="coinSelect('tails')">🦅 Tails</button>
  </div>
  <div style="display:flex;align-items:center;gap:12px;">
    <div class="bet-controls">
      <span style="color:var(--text2);font-size:12px;font-weight:600;">BET</span>
      <button class="bet-btn bet-half" onclick="adjustBet('coinBet',0.5)">½</button>
      <input class="bet-input" type="text" id="coinBet" value="10">
      <button class="bet-btn bet-double" onclick="adjustBet('coinBet',2)">2×</button>
      <button class="bet-btn" onclick="betAll('coinBet')" style="background:var(--gold);color:#000;font-weight:900;font-size:10px;">MAX</button>
    </div>
    <button class="action-btn primary" id="coinFlipBtn" onclick="coinFlip()">FLIP</button>
  </div>
</div>

<div class="game-panel" id="kenoPanel">
  <div class="htp-box"><button class="htp-toggle" onclick="htpToggle(this)"><span class="htp-arrow">▶</span> HOW TO PLAY</button><div class="htp-content"><ul><li>Click to select <strong>1-10 numbers</strong> on the board (1-40).</li><li>Set your <strong>bet</strong> and press <strong>DRAW</strong>.</li><li>10 numbers are drawn randomly — matches earn payouts.</li><li>More numbers selected = harder to hit but <strong>bigger payouts</strong>.</li><li>Hitting all your picks pays the <strong>jackpot multiplier</strong>!</li></ul></div></div>
  <div style="font-family:'Orbitron';font-size:16px;font-weight:700;color:var(--gold);">KENO</div>
  <div id="kenoInfo">Pick up to 10 numbers, then draw!</div>

  <div class="keno-grid" id="kenoGrid"></div>
  <div id="kenoResult"></div>
  <div style="display:flex;align-items:center;gap:10px;">
    <div class="bet-controls">
      <span style="color:var(--text2);font-size:12px;font-weight:600;">BET</span>
      <button class="bet-btn bet-half" onclick="adjustBet('kenoBet',0.5)">½</button>
      <input class="bet-input" type="text" id="kenoBet" value="10">
      <button class="bet-btn bet-double" onclick="adjustBet('kenoBet',2)">2×</button>
      <button class="bet-btn" onclick="betAll('kenoBet')" style="background:var(--gold);color:#000;font-weight:900;font-size:10px;">MAX</button>
    </div>
    <button class="action-btn primary" id="kenoDrawBtn" onclick="kenoDraw()">DRAW</button>
    <button class="bet-btn" onclick="kenoClear()" style="color:var(--red);">CLEAR</button>
  </div>

</div>

<div class="game-panel" id="limboPanel">
  <div class="htp-box"><button class="htp-toggle" onclick="htpToggle(this)"><span class="htp-arrow">▶</span> HOW TO PLAY</button><div class="htp-content"><ul><li>Set your <strong>bet</strong> and enter a <strong>target multiplier</strong>.</li><li>Press <strong>GO</strong> — the game generates a random multiplier.</li><li>If the result is <strong>≥ your target</strong>, you win at that multiplier!</li><li>Higher targets = lower chance but bigger payouts.</li><li>Minimum target is 1.01× (99% chance), max risk for max reward!</li></ul></div></div>
  <div id="limboResult">—</div>
  <div style="width:100%;max-width:400px;height:8px;background:var(--surface);border-radius:8px;overflow:hidden;border:1px solid var(--border);">
    <div id="limboBar" style="height:100%;width:0%;border-radius:8px;transition:width 0.3s ease;"></div>
  </div>
  <div class="limbo-target-wrap">
    <label>Target ×</label>
    <input type="number" id="limboTarget" value="2" min="1.01" max="1000" step="0.01">
  </div>

  <div id="limboPayout">Win chance: 49.50% — Payout: 2.00×</div>
  <div style="display:flex;align-items:center;gap:12px;">
    <div class="bet-controls">
      <span style="color:var(--text2);font-size:12px;font-weight:600;">BET</span>
      <button class="bet-btn bet-half" onclick="adjustBet('limboBet',0.5)">½</button>
      <input class="bet-input" type="text" id="limboBet" value="10">
      <button class="bet-btn bet-double" onclick="adjustBet('limboBet',2)">2×</button>
      <button class="bet-btn" onclick="betAll('limboBet')" style="background:var(--gold);color:#000;font-weight:900;font-size:10px;">MAX</button>
    </div>
    <button class="action-btn primary" id="limboGoBtn" onclick="limboGo()">BET</button>
  </div>
  <div class="last-results" id="limboHistory"></div>
</div>

<div class="game-panel" id="pokerPanel">
  <div class="htp-box"><button class="htp-toggle" onclick="htpToggle(this)"><span class="htp-arrow">▶</span> HOW TO PLAY</button><div class="htp-content"><ul><li>Set your <strong>bet</strong> and press <strong>DEAL</strong> to get 5 cards.</li><li>Click cards to <strong>hold</strong> the ones you want to keep.</li><li>Press <strong>DRAW</strong> to replace un-held cards.</li><li>Your final hand is evaluated — <strong>Jacks or Better</strong> wins.</li><li>Royal Flush pays <strong>250×</strong>, Straight Flush pays <strong>50×</strong>!</li></ul></div></div>
  <div class="poker-paytable">
    <span class="pt-h">Royal Flush</span><span class="pt-v">250×</span>
    <span class="pt-h">Straight Flush</span><span class="pt-v">50×</span>
    <span class="pt-h">4 of a Kind</span><span class="pt-v">25×</span>
    <span class="pt-h">Full House</span><span class="pt-v">9×</span>
    <span class="pt-h">Flush</span><span class="pt-v">6×</span>
    <span class="pt-h">Straight</span><span class="pt-v">4×</span>
    <span class="pt-h">3 of a Kind</span><span class="pt-v">3×</span>
    <span class="pt-h">Two Pair</span><span class="pt-v">2×</span>
    <span class="pt-h">Jacks+</span><span class="pt-v">1×</span>
  </div>
  <div class="poker-hand" id="pokerHand"></div>
  <div id="pokerResult"></div>
  <div style="display:flex;align-items:center;gap:10px;">
    <div class="bet-controls">
      <span style="color:var(--text2);font-size:12px;font-weight:600;">BET</span>
      <button class="bet-btn bet-half" onclick="adjustBet('pokerBet',0.5)">½</button>
      <input class="bet-input" type="text" id="pokerBet" value="10">

      <button class="bet-btn bet-double" onclick="adjustBet('pokerBet',2)">2×</button>
      <button class="bet-btn" onclick="betAll('pokerBet')" style="background:var(--gold);color:#000;font-weight:900;font-size:10px;">MAX</button>
    </div>
    <button class="action-btn primary" id="pokerDealBtn" onclick="pokerDeal()">DEAL</button>
    <button class="action-btn primary" id="pokerDrawBtn" onclick="pokerDrawCards()" style="display:none;background:linear-gradient(135deg,#cc8800,#996600);">DRAW</button>
  </div>
</div>

<div class="game-panel" id="horsesPanel">
  <div class="htp-box"><button class="htp-toggle" onclick="htpToggle(this)"><span class="htp-arrow">▶</span> HOW TO PLAY</button><div class="htp-content"><ul><li>Each race has a <strong>track</strong> (surface + distance), <strong>weather</strong>, and <strong>going</strong> condition.</li><li>Study each horse's <strong>stats</strong>: Speed, Stamina, Acceleration, Consistency.</li><li>Check their <strong>surface affinity</strong> — a horse with 90 Mud on a Storm day at Stormwood Bog is a monster.</li><li><strong>Jockey style</strong> matters: Closers save energy for the finish, Aggressives burn out early.</li><li><strong>Form</strong> tracks last 5 finishes — hot horses get a power boost, cold horses get penalized.</li><li><strong>Gate position</strong> affects short vs long races differently.</li><li><strong>Temperament</strong>: Hot horses hate storms, Cool horses love rain, Wild horses are chaos.</li><li>The <strong>odds</strong> aren't perfect — they have noise. If you spot a mismatch between the odds and a horse's TRUE power, that's your edge.</li><li>Smart bettors who study everything can massively outperform the house. Casual random picks will lose.</li></ul></div></div>
  <div style="font-family:'Orbitron';font-size:16px;font-weight:700;color:var(--gold);">🏇 HORSE RACING</div>
</div>

<div class="game-panel" id="scratchPanel">
  <div class="htp-box"><button class="htp-toggle" onclick="htpToggle(this)"><span class="htp-arrow">▶</span> HOW TO PLAY</button><div class="htp-content"><ul><li>Set your <strong>bet</strong> (card price) and press <strong>BUY CARD</strong>.</li><li>Scratch tiles by clicking them, or press <strong>SCRATCH ALL</strong> to reveal everything.</li><li>Match <strong>3 identical symbols</strong> to win that symbol's prize.</li><li>Match <strong>4 symbols</strong> for an even bigger payout!</li><li>Prizes range from 1× to 50× your bet depending on the symbol.</li></ul></div></div>
  <div style="font-family:'Orbitron';font-size:16px;font-weight:700;color:var(--gold);">🎫 SCRATCH CARDS</div>

  <div class="scratch-tiers">
    <div class="scratch-tier selected" onclick="scratchSelectTier(0,this)">$5 Basic</div>
    <div class="scratch-tier" onclick="scratchSelectTier(1,this)">$25 Silver</div>
    <div class="scratch-tier" onclick="scratchSelectTier(2,this)">$100 Gold</div>
    <div class="scratch-tier" onclick="scratchSelectTier(3,this)">$500 Diamond</div>
  </div>
  <div class="scratch-card"><div class="scratch-grid" id="scratchGrid"></div></div>
  <div id="scratchResult"></div>
  <button class="action-btn primary" id="scratchBuyBtn" onclick="scratchBuy()">BUY CARD — $5</button>
  <button class="action-btn primary" id="scratchRevealAllBtn" onclick="scratchRevealAll()" style="display:none;font-size:12px;padding:8px 16px;">SCRATCH ALL</button>
</div>

<div class="game-panel" id="wheelPanel">
  <div class="htp-box"><button class="htp-toggle" onclick="htpToggle(this)"><span class="htp-arrow">▶</span> HOW TO PLAY</button><div class="htp-content"><ul><li>Set your <strong>bet amount</strong>.</li><li>Press <strong>SPIN</strong> to spin the wheel.</li><li>The wheel has segments with different <strong>multipliers</strong>.</li><li>Where the wheel stops determines your payout.</li><li>Rare high-value segments can pay <strong>huge multipliers</strong>!</li></ul></div></div>
  <div class="wheel-wrap">
    <div class="wheel-ptr"></div>
    <canvas id="wheelCanvas" width="320" height="320"></canvas>
  </div>
  <div id="wheelResult"></div>

  <div style="display:flex;align-items:center;gap:12px;">
    <div class="bet-controls">
      <span style="color:var(--text2);font-size:12px;font-weight:600;">BET</span>
      <button class="bet-btn bet-half" onclick="adjustBet('wheelBet',0.5)">½</button>
      <input class="bet-input" type="text" id="wheelBet" value="10">
      <button class="bet-btn bet-double" onclick="adjustBet('wheelBet',2)">2×</button>
      <button class="bet-btn" onclick="betAll('wheelBet')" style="background:var(--gold);color:#000;font-weight:900;font-size:10px;">MAX</button>
    </div>
    <button class="action-btn primary" id="wheelSpinBtn" onclick="wheelSpin()">SPIN</button>
  </div>
</div>

<div class="game-panel" id="baccaratPanel">
  <div class="htp-box"><button class="htp-toggle" onclick="htpToggle(this)"><span class="htp-arrow">▶</span> HOW TO PLAY</button><div class="htp-content"><ul><li>Choose to bet on <strong>Player</strong>, <strong>Banker</strong>, or <strong>Tie</strong>.</li><li>Set your <strong>bet</strong> and press <strong>DEAL</strong>.</li><li>Cards are dealt automatically — closest to <strong>9</strong> wins.</li><li>Player pays <strong>2×</strong>, Banker pays <strong>1.95×</strong>, Tie pays <strong>8×</strong>.</li><li>Face cards and 10s count as 0. Only the last digit of the total matters.</li></ul></div></div>
  <div class="bacc-table">
    <div class="bacc-hands">
      <div class="bacc-hand"><div class="bacc-hand-label">PLAYER</div><div class="bacc-cards" id="baccPlayerCards"></div><div class="bacc-hand-score" id="baccPlayerScore">—</div></div>
      <div class="bacc-hand"><div class="bacc-hand-label">BANKER</div><div class="bacc-cards" id="baccBankerCards"></div><div class="bacc-hand-score" id="baccBankerScore">—</div></div>
    </div>
  </div>
  <div id="baccResult"></div>
  <div class="last-results" id="baccHistory"></div>

  <div class="bacc-bets">
    <button class="bacc-bet" onclick="baccSelect('player',this)">Player (2×)</button>
    <button class="bacc-bet" onclick="baccSelect('tie',this)">Tie (8×)</button>
  <button class="bacc-bet" onclick="baccSelect('banker',this)">Banker (1.95×)</button>
  </div>
  <div style="display:flex;align-items:center;gap:12px;">
    <div class="bet-controls">
      <span style="color:var(--text2);font-size:12px;font-weight:600;">BET</span>
      <button class="bet-btn bet-half" onclick="adjustBet('baccBet',0.5)">½</button>
      <input class="bet-input" type="text" id="baccBet" value="10">
      <button class="bet-btn bet-double" onclick="adjustBet('baccBet',2)">2×</button>
      <button class="bet-btn" onclick="betAll('baccBet')" style="background:var(--gold);color:#000;font-weight:900;font-size:10px;">MAX</button>
    </div>
    <button class="action-btn primary" onclick="baccDeal()">DEAL</button>
  </div>
</div>

<div class="game-panel" id="hiloPanel">
  <div class="htp-box"><button class="htp-toggle" onclick="htpToggle(this)"><span class="htp-arrow">▶</span> HOW TO PLAY</button><div class="htp-content"><ul><li>Press <strong>START</strong> — a card is revealed.</li><li>Guess if the next card will be <strong>Higher</strong> or <strong>Lower</strong>.</li><li><strong>Ties (same rank) count as WRONG</strong> — the next card must be strictly higher or lower!</li><li>Each correct guess multiplies your winnings by 1.88×.</li><li>Press <strong>SKIP</strong> to swap the current card — but each skip costs <strong>10% of your payout</strong>.</li><li>Max multiplier is capped at <strong>500×</strong>.</li><li>Press <strong>CASH OUT</strong> anytime to collect, or risk it for more!</li></ul></div></div>
  <div id="hiloStreak">Start a game to begin!</div>

  <div class="hilo-card" id="hiloCard" style="color:#888;">?<br>?</div>
  <div id="hiloCashout"></div>
  <div class="hilo-actions">
    <button class="hilo-act-btn higher" onclick="hiloGuess('higher')" id="hiloHigherBtn" disabled>▲ HIGHER</button>
    <button class="hilo-act-btn skip-btn" onclick="hiloGuess('skip')" id="hiloSkipBtn" disabled>= SKIP</button>
    <button class="hilo-act-btn lower" onclick="hiloGuess('lower')" id="hiloLowerBtn" disabled>▼ LOWER</button>
  </div>
  <div style="display:flex;align-items:center;gap:10px;">
    <div class="bet-controls">
      <span style="color:var(--text2);font-size:12px;font-weight:600;">BET</span>
      <button class="bet-btn bet-half" onclick="adjustBet('hiloBet',0.5)">½</button>
      <input class="bet-input" type="text" id="hiloBet" value="10">
      <button class="bet-btn bet-double" onclick="adjustBet('hiloBet',2)">2×</button>
      <button class="bet-btn" onclick="betAll('hiloBet')" style="background:var(--gold);color:#000;font-weight:900;font-size:10px;">MAX</button>
    </div>
    <button class="action-btn primary" id="hiloStartBtn" onclick="hiloStart()">START</button>
    <button class="action-btn danger" id="hiloCashoutBtn" onclick="hiloCashout()" style="display:none;">CASH OUT</button>
  </div>
</div>

<div class="game-panel" id="rusroulettePanel">
  <div class="htp-box"><button class="htp-toggle" onclick="htpToggle(this)"><span class="htp-arrow">▶</span> HOW TO PLAY</button><div class="htp-content"><ul>
    <li>Face the <strong>Dealer</strong> in a deadly shotgun standoff across multiple rounds.</li>
    <li>The shotgun is loaded with a mix of <strong style="color:#ff4444;">LIVE</strong> and <strong style="color:#4488ff;">BLANK</strong> shells — you can see the counts but not the order.</li>
    <li><strong>Shoot Dealer</strong>: LIVE = dealer takes damage, BLANK = turn passes.</li>
    <li><strong>Shoot Self</strong>: LIVE = you take damage, <strong style="color:#00e676;">BLANK = FREE EXTRA TURN!</strong></li>
    <li>Use <strong>items</strong> before shooting to gain an edge:<br>
      🔗 <em>Handcuffs</em> — Dealer skips next turn<br>
      🚬 <em>Cigarettes</em> — Heal +1 HP<br>
      🍬 <em>Rotten Gummy</em> — 40% chance +2 HP, 60% chance −1 HP<br>
      🪚 <em>Saw</em> — Next LIVE shell deals <strong>double damage</strong><br>
      📱 <em>Burner Phone</em> — Reveals a random upcoming shell<br>
      🔍 <em>Magnifying Glass</em> — Peek at the current shell
    </li>
    <li>Difficulty sets rounds, HP, items, and your <strong>payout multiplier</strong>.</li>
    <li>Beat all rounds to win <strong>Bet × Multiplier</strong>. Die and you lose your bet.</li>
  </ul></div></div>

  <div class="bsr-title">🔫 BUCKSHOT ROULETTE</div>
  <div class="bsr-subtitle">Man vs. Machine. One shotgun. Who walks away?</div>

  <div id="bsrLobby" class="bsr-lobby">

    <div style="font-family:'Orbitron';font-size:11px;color:var(--text2);letter-spacing:2px;margin-bottom:6px;">CHOOSE DIFFICULTY</div>
    <div class="bsr-difficulty">
      <div class="bsr-diff-card" onclick="bsrSelectDiff('easy',this)">
        <div class="diff-icon">😎</div>
        <div class="diff-name">EASY</div>
        <div class="diff-desc">2 rounds · 5 HP · 4 items</div>
        <div class="diff-mult">2.5×</div>
      </div>
      <div class="bsr-diff-card selected" onclick="bsrSelectDiff('normal',this)">
        <div class="diff-icon">💀</div>
        <div class="diff-name">NORMAL</div>
        <div class="diff-desc">3 rounds · 4 HP · 3 items</div>
        <div class="diff-mult">4×</div>
      </div>
      <div class="bsr-diff-card" onclick="bsrSelectDiff('hard',this)">
        <div class="diff-icon">☠️</div>
        <div class="diff-name">HARD</div>
        <div class="diff-desc">4 rounds · 3 HP · 2 items</div>
        <div class="diff-mult">7×</div>
      </div>
    </div>

    <div style="display:flex;gap:8px;align-items:center;justify-content:center;margin-top:16px;">
      <div class="bet-controls">
        <span style="color:var(--text2);font-size:12px;font-weight:600;">BET</span>
        <button class="bet-btn bet-half" onclick="adjustBet('bsrBet',0.5)">½</button>
        <input class="bet-input" type="text" id="bsrBet" value="100">
        <button class="bet-btn bet-double" onclick="adjustBet('bsrBet',2)">2×</button>
        <button class="bet-btn" onclick="betAll('bsrBet')" style="background:var(--gold);color:#000;font-weight:900;font-size:10px;">MAX</button>
      </div>
      <button class="action-btn primary" onclick="bsrStartGame()" style="padding:12px 28px;font-size:15px;font-family:'Orbitron';letter-spacing:1px;">⚔️ PLAY</button>
    </div>

    <div id="bsrStats" style="display:flex;gap:12px;justify-content:center;margin-top:14px;font-size:11px;color:var(--text2);">
      <span>Win rate: <span id="bsrStatWinRate" style="color:var(--green);font-weight:700;">--</span></span>
      <span>Biggest win: <span id="bsrStatBigWin" style="color:var(--gold);font-weight:700;">--</span></span>
      <span>Streak: <span id="bsrStatStreak" style="color:var(--neon);font-weight:700;">0</span></span>
    </div>
  </div>

  <div id="bsrGame" class="bsr-game" style="display:none;">

    <div class="bsr-top-bar">
      <div class="bsr-round-badge" id="bsrRoundInfo">ROUND 1/3</div>
      <div class="bsr-multiplier" id="bsrMultiplier">4× PAYOUT</div>
      <div class="bsr-shell-count" id="bsrShellInfo">5 shells</div>
    </div>

    <div class="bsr-rack" id="bsrShellRack"></div>

    <div class="bsr-table">

      <div class="bsr-combatants">
        <div class="bsr-fighter" id="bsrPlayerCard">
          <div class="bsr-fighter-label" style="color:var(--neon);">🧑 YOU</div>
          <div class="bsr-hp-text" id="bsrPlayerHP" style="color:var(--green);">4 HP</div>
          <div class="bsr-hp-bar"><div class="bsr-hp-fill" id="bsrPlayerHPBar" style="width:100%;background:linear-gradient(90deg,var(--green),#66ff99);"></div></div>
          <div class="bsr-hearts" id="bsrPlayerHearts">❤️❤️❤️❤️</div>
        </div>
        <div class="bsr-vs">VS</div>
        <div class="bsr-fighter" id="bsrDealerCard">
          <div class="bsr-fighter-label" style="color:var(--red);">🤖 DEALER</div>
          <div class="bsr-hp-text" id="bsrDealerHP" style="color:var(--red);">4 HP</div>
          <div class="bsr-hp-bar"><div class="bsr-hp-fill" id="bsrDealerHPBar" style="width:100%;background:linear-gradient(90deg,#ff4444,#ff8888);"></div></div>
          <div class="bsr-hearts" id="bsrDealerHearts">❤️❤️❤️❤️</div>
        </div>
      </div>

      <div class="bsr-shotgun">
        <div class="bsr-shotgun-img" id="bsrShotgun">🔫</div>
      </div>

      <div class="bsr-status" id="bsrStatus">Your turn — choose wisely.</div>

      <div class="bsr-actions">
        <button class="bsr-shoot-btn bsr-shoot-dealer" id="bsrShootDealer" onclick="bsrShoot('dealer')">🔫 SHOOT DEALER</button>
        <button class="bsr-shoot-btn bsr-shoot-self" id="bsrShootSelf" onclick="bsrShoot('self')">🫵 SHOOT SELF</button>
      </div>
    </div>

    <div class="bsr-items-section">
      <div class="bsr-items-label">YOUR ITEMS</div>
      <div class="bsr-items" id="bsrItems"></div>
      <div class="bsr-items-label" style="margin-top:10px;color:rgba(255,68,68,.5);">DEALER'S ITEMS</div>
      <div class="bsr-dealer-items" id="bsrDealerItemsDisplay"></div>
    </div>

    <div class="bsr-log" id="bsrLog"></div>
  </div>

  <div id="bsrRoundSplash" class="bsr-round-splash" style="display:none;">
    <div class="bsr-round-splash-text" id="bsrRoundSplashText">ROUND 2</div>
  </div>

  <div id="bsrGameOver" class="bsr-gameover">
    <div class="bsr-gameover-box" id="bsrGameOverContent"></div>
  </div>
</div>

<div class="game-panel" id="russianrPanel" style="padding-top:60px!important;">
  <div class="htp-box"><button class="htp-toggle" onclick="htpToggle(this)"><span class="htp-arrow">▶</span> HOW TO PLAY</button><div class="htp-content"><ul>
    <li>6-chamber revolver, <strong>1 bullet</strong>. Take turns pulling the trigger.</li>
    <li><strong>Pull Trigger</strong>: 1-in-6 chance (decreasing chambers) of death.</li>
    <li><strong>Spin Cylinder</strong>: Reset to 1-in-6 (uses your turn).</li>
    <li>Survive all rounds and the opponent dies? <strong>You win the pot!</strong></li>
    <li><strong>Bot mode</strong>: Play against the Dealer AI. <strong>PvP</strong>: Challenge a real player live.</li>
    <li>Higher difficulty = more rounds, bigger multiplier.</li>
  </ul></div></div>

  <div style="text-align:center;margin-bottom:14px;">
    <span style="font-family:'Orbitron';font-size:26px;font-weight:900;background:linear-gradient(135deg,#ff4444,#ff8800);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">🎰 RUSSIAN ROULETTE</span>
    <div style="font-size:11px;color:var(--text2);margin-top:4px;">One bullet. Six chambers. Who survives?</div>
  </div>

  <div style="display:flex;gap:6px;justify-content:center;margin-bottom:14px;">
    <button class="inv-tab active" id="rrBotTab" onclick="rrSwitchMode('bot',this)" style="border-color:rgba(255,68,68,.3);color:#ff4444;">🤖 vs Bot</button>
    <button class="inv-tab" id="rrPvpTab" onclick="rrSwitchMode('pvp',this)" style="border-color:rgba(0,240,255,.3);color:var(--neon);">👥 PvP</button>
  </div>

  <div id="rrBotLobby">
    <div style="display:flex;gap:8px;justify-content:center;margin-bottom:10px;">
      <div class="bsr-diff-card selected" onclick="rrSelectDiff('easy',this)" style="padding:10px 14px;min-width:90px;">
        <div class="diff-icon">😎</div><div class="diff-name">EASY</div><div class="diff-desc">3 rounds</div><div class="diff-mult">2×</div>
      </div>
      <div class="bsr-diff-card" onclick="rrSelectDiff('normal',this)" style="padding:10px 14px;min-width:90px;">
        <div class="diff-icon">💀</div><div class="diff-name">NORMAL</div><div class="diff-desc">5 rounds</div><div class="diff-mult">4×</div>
      </div>
      <div class="bsr-diff-card" onclick="rrSelectDiff('hard',this)" style="padding:10px 14px;min-width:90px;">
        <div class="diff-icon">☠️</div><div class="diff-name">HARD</div><div class="diff-desc">8 rounds</div><div class="diff-mult">8×</div>
      </div>
    </div>
    <div style="display:flex;gap:8px;align-items:center;justify-content:center;margin-top:10px;">
      <div class="bet-controls">
        <span style="color:var(--text2);font-size:12px;font-weight:600;">BET</span>
        <button class="bet-btn bet-half" onclick="adjustBet('rrBet',0.5)">½</button>
        <input class="bet-input" type="text" id="rrBet" value="100">
        <button class="bet-btn bet-double" onclick="adjustBet('rrBet',2)">2×</button>
        <button class="bet-btn" onclick="betAll('rrBet')" style="background:var(--gold);color:#000;font-weight:900;font-size:10px;">MAX</button>
      </div>
      <button class="action-btn primary" onclick="rrStartBot()" style="padding:12px 28px;font-size:15px;font-family:'Orbitron';">⚔️ PLAY</button>
    </div>
  </div>

  <div id="rrPvpLobby" style="display:none;text-align:center;">
    <div style="font-size:13px;color:var(--text2);margin-bottom:12px;">Challenge another player — loser loses their bet!</div>
    <div style="display:flex;gap:8px;align-items:center;justify-content:center;margin-bottom:12px;">
      <div class="bet-controls">
        <span style="color:var(--text2);font-size:12px;font-weight:600;">WAGER</span>
        <button class="bet-btn bet-half" onclick="adjustBet('rrPvpBet',0.5)">½</button>
        <input class="bet-input" type="text" id="rrPvpBet" value="100">
        <button class="bet-btn bet-double" onclick="adjustBet('rrPvpBet',2)">2×</button>
        <button class="bet-btn" onclick="betAll('rrPvpBet')" style="background:var(--gold);color:#000;font-weight:900;font-size:10px;">MAX</button>
      </div>
    </div>
    <input type="text" id="rrPvpOpponent" placeholder="Enter opponent username..." maxlength="16" autocomplete="off" style="width:90%;max-width:300px;padding:10px 14px;background:var(--bg);border:2px solid var(--border);border-radius:10px;color:var(--text);font-size:14px;text-align:center;margin-bottom:10px;">
    <br>
    <button class="action-btn primary" onclick="rrStartPvP()" style="padding:12px 28px;font-size:15px;font-family:'Orbitron';">🎯 CHALLENGE</button>
    <div id="rrPvpStatus" style="font-size:12px;color:var(--text2);margin-top:8px;min-height:20px;"></div>
  </div>

  <div id="rrGameArea" style="display:none;max-width:500px;margin:0 auto;">

    <div style="text-align:center;margin-bottom:16px;">
      <div id="rrRevolver" style="font-size:90px;transition:transform .3s;filter:drop-shadow(0 0 20px rgba(255,68,68,.3));">🔫</div>
      <div id="rrChamberInfo" style="font-family:'Orbitron';font-size:12px;color:var(--text2);margin-top:6px;letter-spacing:2px;"></div>
    </div>

    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
      <div id="rrRoundInfo" style="font-family:'Orbitron';font-size:14px;color:var(--gold);letter-spacing:1px;"></div>
      <div id="rrMultInfo" style="font-family:'Orbitron';font-size:14px;color:var(--green);"></div>
    </div>

    <div style="display:grid;grid-template-columns:1fr auto 1fr;gap:10px;align-items:center;margin-bottom:14px;">
      <div id="rrPlayerCard" style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:14px;text-align:center;transition:all .3s;">
        <div style="font-family:'Orbitron';font-size:11px;color:var(--neon);letter-spacing:2px;margin-bottom:6px;">🧑 YOU</div>
        <div id="rrPlayerStatus" style="font-size:22px;">😐</div>
        <div id="rrPlayerAlive" style="font-size:11px;color:var(--green);margin-top:4px;">ALIVE</div>
      </div>
      <div style="font-family:'Orbitron';font-size:16px;color:var(--text2);">VS</div>
      <div id="rrDealerCard" style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:14px;text-align:center;transition:all .3s;">
        <div style="font-family:'Orbitron';font-size:11px;color:var(--red);letter-spacing:2px;margin-bottom:6px;" id="rrOpponentLabel">🤖 DEALER</div>
        <div id="rrDealerStatus" style="font-size:22px;">😐</div>
        <div id="rrDealerAlive" style="font-size:11px;color:var(--green);margin-top:4px;">ALIVE</div>
      </div>
    </div>

    <div id="rrStatusMsg" style="text-align:center;font-size:15px;color:var(--gold);font-weight:700;min-height:24px;margin-bottom:12px;font-family:'Orbitron';"></div>

    <div id="rrActions" style="display:flex;gap:12px;justify-content:center;margin-bottom:14px;">
      <button class="bsr-shoot-btn bsr-shoot-dealer" id="rrPullBtn" onclick="rrPullTrigger()" style="flex:1;max-width:200px;">💀 PULL TRIGGER</button>
      <button class="bsr-shoot-btn bsr-shoot-self" id="rrSpinBtn" onclick="rrSpinCylinder()" style="flex:1;max-width:200px;">🔄 SPIN CYLINDER</button>
    </div>

    <div id="rrLog" class="bsr-log" style="max-height:120px;"></div>
  </div>

  <div id="rrGameOver" class="bsr-gameover">
    <div class="bsr-gameover-box" id="rrGameOverContent"></div>
  </div>
</div>
MULTIPLAYER BUCKSHOT ROULETTE ============ -->
<div class="game-panel" id="mpbsrPanel" style="padding-top:60px!important;">
  <div class="htp-box"><button class="htp-toggle" onclick="htpToggle(this)"><span class="htp-arrow">▶</span> HOW TO PLAY</button><div class="htp-content"><ul>
    <li>PvP Buckshot Roulette — challenge a real player!</li>
    <li>Both players start with <strong>4 HP</strong>. Shotgun loaded with LIVE & BLANK shells.</li>
    <li>On your turn: <strong>Shoot Opponent</strong> or <strong>Shoot Self</strong> (blank self = bonus turn).</li>
    <li>Use <strong>items</strong> strategically: Saw (2× damage), Magnifying Glass (peek shell), Cigarette (+1 HP), Handcuffs (skip turn).</li>
    <li>Winner takes the full pot (both bets)!</li>
  </ul></div></div>

  <div style="text-align:center;margin-bottom:14px;">
    <span style="font-family:'Orbitron';font-size:24px;font-weight:900;background:linear-gradient(135deg,#ff4444,#ff8800);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">💥 MULTIPLAYER BUCKSHOT</span>
    <div style="font-size:11px;color:var(--text2);margin-top:4px;">PvP Shotgun Standoff — Who walks away?</div>
  </div>

  <div id="mpbsrLobby">
    <div style="text-align:center;margin-bottom:12px;">
      <div style="font-size:13px;color:var(--text2);margin-bottom:12px;">Challenge another player to a live Buckshot Roulette match!</div>
      <div style="display:flex;gap:8px;align-items:center;justify-content:center;margin-bottom:12px;">
        <div class="bet-controls">
          <span style="color:var(--text2);font-size:12px;font-weight:600;">WAGER</span>
          <button class="bet-btn bet-half" onclick="adjustBet('mpbsrBet',0.5)">½</button>
          <input class="bet-input" type="text" id="mpbsrBet" value="100">
          <button class="bet-btn bet-double" onclick="adjustBet('mpbsrBet',2)">2×</button>
          <button class="bet-btn" onclick="betAll('mpbsrBet')" style="background:var(--gold);color:#000;font-weight:900;font-size:10px;">MAX</button>
        </div>
      </div>
      <input type="text" id="mpbsrOpponent" placeholder="Enter opponent username..." maxlength="16" autocomplete="off" style="width:90%;max-width:300px;padding:10px 14px;background:var(--bg);border:2px solid var(--border);border-radius:10px;color:var(--text);font-size:14px;text-align:center;margin-bottom:10px;">
      <br>
      <button class="action-btn primary" onclick="mpbsrChallenge()" style="padding:12px 28px;font-size:15px;font-family:'Orbitron';">⚔️ CHALLENGE</button>
      <div id="mpbsrStatus" style="font-size:12px;color:var(--text2);margin-top:8px;min-height:20px;"></div>
    </div>
  </div>

  <div id="mpbsrGameArea" style="display:none;max-width:500px;margin:0 auto;">

    <div class="bsr-top-bar">
      <div class="bsr-round-badge" id="mpbsrRoundInfo">ROUND 1</div>
      <div class="bsr-multiplier" id="mpbsrPotInfo">POT: $0</div>
      <div class="bsr-shell-count" id="mpbsrShellInfo">0 shells</div>
    </div>

    <div class="bsr-rack" id="mpbsrShellRack"></div>

    <div style="display:grid;grid-template-columns:1fr auto 1fr;gap:10px;align-items:start;margin:14px 0;">
      <div id="mpbsrMyCard" class="bsr-player-card">
        <div class="bsr-player-label" style="color:var(--neon);">YOU</div>
        <div class="bsr-hp" id="mpbsrMyHP"></div>
        <div class="bsr-items" id="mpbsrMyItems"></div>
      </div>
      <div style="font-family:'Orbitron';font-size:16px;color:var(--text2);align-self:center;">VS</div>
      <div id="mpbsrOpCard" class="bsr-player-card">
        <div class="bsr-player-label" style="color:var(--red);" id="mpbsrOpLabel">OPPONENT</div>
        <div class="bsr-hp" id="mpbsrOpHP"></div>
        <div class="bsr-items" id="mpbsrOpItems"></div>
      </div>
    </div>

    <div id="mpbsrStatusMsg" class="bsr-status"></div>

    <div id="mpbsrActions" style="display:flex;gap:10px;justify-content:center;margin:12px 0;">
      <button class="bsr-shoot-btn bsr-shoot-dealer" id="mpbsrShootOp" onclick="mpbsrShoot('opponent')">🔫 SHOOT OPPONENT</button>
      <button class="bsr-shoot-btn bsr-shoot-self" id="mpbsrShootSelf" onclick="mpbsrShoot('self')">🤕 SHOOT SELF</button>
    </div>

    <div id="mpbsrLog" class="bsr-log" style="max-height:120px;"></div>
  </div>

  <div id="mpbsrGameOver" class="bsr-gameover">
    <div class="bsr-gameover-box" id="mpbsrGameOverContent"></div>
  </div>
</div>

<div class="game-panel" id="duelsPanel">
  <div class="duel-lobby">
    <div style="text-align:center;margin-bottom:12px;">
      <span style="font-family:'Orbitron';font-size:24px;font-weight:900;background:linear-gradient(135deg,var(--gold),#ff4444);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">⚔️ COINFLIP DUELS</span>
      <div style="font-size:11px;color:var(--text2);margin-top:4px;">Challenge other players! Winner takes all.</div>
    </div>

    <div class="duel-create-box">
      <div style="font-family:'Orbitron';font-size:12px;color:var(--text2);letter-spacing:2px;margin-bottom:8px;">CREATE A DUEL</div>
      <input id="duelWagerInput" type="number" min="10" value="100" placeholder="Wager">
      <br>
      <button class="duel-create-btn" onclick="duelCreate()">⚔️ CREATE DUEL</button>
    </div>

    <div style="font-family:'Orbitron';font-size:12px;color:var(--text2);letter-spacing:2px;margin-bottom:8px;">OPEN DUELS</div>
    <div id="duelList" style="min-height:60px;">
      <div style="text-align:center;color:var(--text2);font-size:12px;padding:20px;">No open duels. Create one!</div>
    </div>

    <div class="duel-history">
      <div style="font-family:'Orbitron';font-size:12px;color:var(--text2);letter-spacing:2px;margin-bottom:8px;">RECENT DUELS</div>
      <div id="duelHistory"></div>
    </div>
  </div>

  <div id="duelGameOverlay" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(4,8,20,.97);z-index:10003;align-items:center;justify-content:center;">
    <div id="duelFlash" class="duel-flash"></div>
    <div id="duelInner" style="text-align:center;max-width:560px;width:92vw;">
      <div id="duelWagerText" style="font-family:'Orbitron';font-size:18px;color:var(--gold);margin-bottom:16px;letter-spacing:3px;"></div>
      <div style="display:flex;align-items:center;justify-content:center;gap:28px;margin-bottom:20px;">
        <div class="duel-player">
          <div style="font-size:40px;margin-bottom:4px;">🟡</div>
          <div class="duel-player-name" id="duelP1Name">Player 1</div>
          <div class="duel-player-bet">HEADS</div>
        </div>
        <div class="duel-vs" id="duelVsText">VS</div>
        <div class="duel-player">
          <div style="font-size:40px;margin-bottom:4px;">⚫</div>
          <div class="duel-player-name" id="duelP2Name">Player 2</div>
          <div class="duel-player-bet">TAILS</div>
        </div>
      </div>
      <div id="duelCoinArea" style="min-height:140px;margin:20px 0;display:flex;align-items:center;justify-content:center;">
        <div id="duelCountdown" class="duel-countdown" style="display:none;"></div>
        <div class="duel-coin-wrapper">
          <div class="duel-coin" id="duelCoin" style="display:none;">
            <div class="coin-face coin-heads">H</div>
            <div class="coin-face coin-tails">T</div>
          </div>
        </div>
      </div>
      <div class="duel-tension-bar" id="duelTensionBar" style="display:none;"><div class="duel-tension-fill" id="duelTensionFill" style="width:0%;"></div></div>
      <div id="duelStatusText" style="font-family:'Orbitron';font-size:11px;color:var(--text2);letter-spacing:2px;margin:8px 0;"></div>
      <div id="duelResultText" class="duel-result" style="display:none;"></div>
      <button id="duelCloseBtn" onclick="duelCloseOverlay()" style="display:none;padding:10px 24px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);cursor:pointer;font-family:'Orbitron';font-size:12px;margin-top:12px;">CLOSE</button>
    </div>
  </div>
</div>

<div class="game-panel" id="cupsPanel">
  <div class="htp-box"><button class="htp-toggle" onclick="htpToggle(this)"><span class="htp-arrow">▶</span> HOW TO PLAY</button><div class="htp-content"><ul><li>A ball is placed under one of <strong>3 cups</strong>.</li><li>The cups <strong>shuffle rapidly</strong> — try to track the ball!</li><li>After shuffling, <strong>pick the cup</strong> you think has the ball.</li><li>Correct guess wins <strong>1.9x</strong> your bet!</li><li>Higher difficulty = more shuffles = higher multiplier.</li></ul></div></div>
  <div style="text-align:center;margin-bottom:16px;">
    <span style="font-family:'Orbitron';font-size:28px;font-weight:900;background:linear-gradient(135deg,#e040fb,#7c4dff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:3px;">🏆 CUP SHUFFLE</span>
    <div style="font-size:11px;color:var(--text2);margin-top:4px;">Track the ball, pick the right cup!</div>
  </div>
  <div style="display:flex;justify-content:center;gap:12px;margin-bottom:16px;">
    <button class="action-btn" onclick="cupsSetDiff(1)" id="cupsDiff1" style="padding:8px 16px;font-size:12px;border-color:var(--green);background:rgba(0,230,118,.15);">Easy (×2.5)</button>
    <button class="action-btn" onclick="cupsSetDiff(2)" id="cupsDiff2" style="padding:8px 16px;font-size:12px;">Medium (×3.5)</button>
    <button class="action-btn" onclick="cupsSetDiff(3)" id="cupsDiff3" style="padding:8px 16px;font-size:12px;">Hard (×5)</button>
  </div>
  <div id="cupsArea" style="display:flex;justify-content:center;gap:40px;margin:24px 0;min-height:150px;align-items:flex-end;"></div>
  <div id="cupsStatus" style="text-align:center;font-family:'Orbitron';font-size:16px;color:var(--text);margin-bottom:12px;min-height:24px;">Place your bet and start!</div>
  <div style="display:flex;align-items:center;justify-content:center;gap:12px;flex-wrap:wrap;">
    <input type="text" id="cupsBet" value="100" style="width:120px;padding:10px;border-radius:8px;border:1px solid var(--border);background:var(--surface);color:var(--text);font-size:15px;text-align:center;">
    <button id="cupsStartBtn" onclick="cupsStart()" class="action-btn primary" style="padding:12px 28px;font-size:15px;font-family:'Orbitron';font-weight:700;">🔀 SHUFFLE</button>
  </div>
</div>

<div class="game-panel" id="leaderboardPanel">
  <div class="lb-container">
    <div style="text-align:center;margin-bottom:8px;">
      <span style="font-family:'Orbitron';font-size:24px;font-weight:900;background:linear-gradient(135deg,var(--gold),#ff8800);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">🏆 LEADERBOARDS</span>
    </div>
    <div class="lb-tabs" style="flex-wrap:wrap;">
      <button class="lb-tab active" onclick="switchLB('richest',this)">💰 Richest</button>
      <button class="lb-tab" onclick="switchLB('profit',this)">📊 Profit</button>
      <button class="lb-tab" onclick="switchLB('slots',this)">🎰 Slots</button>
      <button class="lb-tab" onclick="switchLB('crash',this)">📈 Crash</button>
      <button class="lb-tab" onclick="switchLB('roulette',this)">🎡 Roulette</button>
      <button class="lb-tab" onclick="switchLB('blackjack',this)">🃏 BJ</button>
      <button class="lb-tab" onclick="switchLB('cases',this)">📦 Cases</button>
      <button class="lb-tab" onclick="switchLB('plinko',this)">⚡ Plinko</button>
      <button class="lb-tab" onclick="switchLB('mines',this)">💣 Mines</button>
      <button class="lb-tab" onclick="switchLB('dice',this)">🎲 Dice</button>
      <button class="lb-tab" onclick="switchLB('tower',this)">🗼 Tower</button>
      <button class="lb-tab" onclick="switchLB('coinflip',this)">🪙 Flip</button>
      <button class="lb-tab" onclick="switchLB('keno',this)">🔢 Keno</button>
      <button class="lb-tab" onclick="switchLB('limbo',this)">🎯 Limbo</button>
      <button class="lb-tab" onclick="switchLB('poker',this)">♠️ Poker</button>
      <button class="lb-tab" onclick="switchLB('horses',this)">🐎 Horses</button>
      <button class="lb-tab" onclick="switchLB('scratch',this)">🎫 Scratch</button>
      <button class="lb-tab" onclick="switchLB('wheel',this)">🎡 Wheel</button>
      <button class="lb-tab" onclick="switchLB('baccarat',this)">🂡 Baccarat</button>
      <button class="lb-tab" onclick="switchLB('hilo',this)">⬆️ Hi-Lo</button>
      <button class="lb-tab" onclick="switchLB('pyl',this)">🍀 Luck</button>
      <button class="lb-tab" onclick="switchLB('duels',this)">⚔️ Duels</button>
      <button class="lb-tab" onclick="switchLB('prestige',this)">👑 Prestige</button>
    </div>
    <div class="lb-table" id="lbTable">
      <div class="lb-empty">Loading...</div>
    </div>
  </div>
</div>

<div class="game-panel" id="profilePanel">
  <div style="max-width:600px;margin:0 auto;padding:20px;">
    <div style="text-align:center;margin-bottom:16px;">
      <div style="font-size:48px;margin-bottom:8px;cursor:pointer;" id="profileAvatar" onclick="openPfpPicker()" title="Click to change avatar">👤</div>
      <button onclick="openPfpPicker()" style="background:transparent;border:1px solid var(--border);border-radius:6px;padding:4px 12px;color:var(--text2);font-size:10px;cursor:pointer;margin-bottom:6px;font-family:Inter,sans-serif;">✏️ Change Avatar</button>
      <input type="file" id="pfpFileInput" accept="image/*" style="display:none;" onchange="handlePfpUpload(this)">
      <div style="font-family:'Orbitron';font-size:22px;font-weight:900;color:var(--gold);letter-spacing:3px;" id="profileName">PLAYER</div>
      <div id="profilePrestigeBadge" style="margin-top:4px;"></div>
      <div style="font-size:11px;color:var(--text2);letter-spacing:2px;margin-top:4px;" id="profileJoined"></div>
    </div>

    <div id="pfpPickerOverlay" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);z-index:10001;align-items:center;justify-content:center;">
      <div style="background:var(--surface);border:2px solid var(--gold);border-radius:16px;padding:20px;max-width:380px;width:90vw;max-height:70vh;overflow-y:auto;">
```
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
          <span style="font-family:'Orbitron';font-size:14px;color:var(--gold);">CHOOSE AVATAR</span>
          <button onclick="closePfpPicker()" style="background:none;border:none;color:var(--text);font-size:18px;cursor:pointer;">✕</button>
        </div>
        <div id="pfpGrid" style="display:grid;grid-template-columns:repeat(5,1fr);gap:8px;"></div>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px;">
      <div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:12px;text-align:center;">
        <div style="font-size:10px;color:var(--text2);letter-spacing:2px;">BALANCE</div>
        <div style="font-family:'Orbitron';font-size:18px;color:var(--gold);margin-top:4px;" id="profBalance">$0</div>
      </div>
      <div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:12px;text-align:center;">
        <div style="font-size:10px;color:var(--text2);letter-spacing:2px;">GAMES</div>
        <div style="font-family:'Orbitron';font-size:18px;color:var(--text);margin-top:4px;" id="profGames">0</div>
      </div>
      <div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:12px;text-align:center;">
        <div style="font-size:10px;color:var(--text2);letter-spacing:2px;">PROFIT</div>
        <div style="font-family:'Orbitron';font-size:18px;margin-top:4px;" id="profProfit">$0</div>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:16px;">
      <div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:12px;text-align:center;">
        <div style="font-size:10px;color:var(--text2);letter-spacing:2px;">WAGERED</div>
        <div style="font-family:'Orbitron';font-size:14px;color:var(--text);margin-top:4px;" id="profWagered">$0</div>
      </div>
      <div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:12px;text-align:center;">
        <div style="font-size:10px;color:var(--text2);letter-spacing:2px;">BIGGEST WIN</div>
        <div style="font-family:'Orbitron';font-size:14px;color:var(--green);margin-top:4px;" id="profBiggest">$0</div>
      </div>
    </div>
    <div style="margin-bottom:16px;">
      <div style="font-family:'Orbitron';font-size:13px;color:var(--gold);letter-spacing:2px;margin-bottom:8px;">🏆 ACHIEVEMENTS <span id="casinoAchCount" style="color:var(--text2);font-size:10px;"></span></div>
      <div id="casinoAchGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:6px;"></div>
    </div>
    <div style="margin-bottom:16px;">
      <div style="font-family:'Orbitron';font-size:13px;color:var(--gold);letter-spacing:2px;margin-bottom:8px;">🎮 GAME STATS</div>
      <div id="profGameStats" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:6px;"></div>
    </div>
    <div style="margin-bottom:16px;">
      <div style="font-family:'Orbitron';font-size:13px;color:var(--gold);letter-spacing:2px;margin-bottom:8px;">📦 INVENTORY VALUE</div>
      <div id="profInvValue" style="font-family:'Orbitron';font-size:20px;color:var(--green);">$0</div>
    </div>

    <div style="margin-bottom:16px;padding:16px;background:linear-gradient(135deg,rgba(255,215,0,.05),rgba(255,136,0,.05));border:1px solid rgba(255,215,0,.2);border-radius:12px;text-align:center;">
      <div style="font-family:'Orbitron';font-size:13px;color:var(--gold);letter-spacing:2px;margin-bottom:8px;">👑 PRESTIGE</div>
      <div style="font-family:'Orbitron';font-size:28px;color:var(--gold);margin-bottom:4px;" id="profPrestigeLevel">0</div>
      <div style="font-size:10px;color:var(--text2);margin-bottom:8px;">Reset your balance to $1,000 and earn a prestige rank.<br>Higher prestige = exclusive badges in chat & leaderboards.</div>
      <div style="font-size:10px;color:var(--text2);margin-bottom:10px;" id="prestigeReqText"></div>
      <button class="prestige-btn" onclick="prestigeConfirm()" id="prestigeBtn">👑 PRESTIGE UP</button>
    </div>

    <div id="adminPanel" style="display:none;margin-top:16px;padding:16px;background:linear-gradient(135deg,rgba(255,0,0,.05),rgba(255,136,0,.05));border:2px solid rgba(255,0,0,.3);border-radius:12px;text-align:center;">
      <div style="font-family:'Orbitron';font-size:13px;color:var(--red);letter-spacing:2px;margin-bottom:12px;">⚙️ ADMIN PANEL</div>

      <div style="background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:8px;">
        <div style="font-size:10px;color:var(--text2);letter-spacing:1px;margin-bottom:8px;">GIVE MONEY TO PLAYER</div>
        <div style="display:flex;gap:6px;">
          <input type="text" id="adminUsername" placeholder="Username" style="flex:1;padding:8px 10px;background:var(--surface);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:11px;">
          <input type="text" id="adminAmount" placeholder="Amount (e.g. 1M)" style="width:120px;padding:8px 10px;background:var(--surface);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:11px;">
          <button onclick="adminGiveMoney()" style="padding:8px 12px;background:linear-gradient(135deg,#ff6600,#ff3300);border:none;border-radius:6px;color:#fff;cursor:pointer;font-weight:700;font-size:11px;">GIVE</button>
        </div>
      </div>

      <div style="background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:8px;">
        <div style="font-size:10px;color:var(--text2);letter-spacing:1px;margin-bottom:8px;">SET OWN BALANCE</div>
        <div style="display:flex;gap:6px;">
          <input type="number" id="adminSelfBalance" placeholder="New balance" style="flex:1;padding:8px 10px;background:var(--surface);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:11px;">
          <button onclick="adminSetSelfBalance()" style="padding:8px 12px;background:linear-gradient(135deg,#ff9900,#ff6600);border:none;border-radius:6px;color:#fff;cursor:pointer;font-weight:700;font-size:11px;">SET</button>
        </div>
      </div>

      <div style="background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:8px;">
        <div style="font-size:10px;color:var(--text2);letter-spacing:1px;margin-bottom:8px;">📢 ANNOUNCEMENT</div>
        <div style="display:flex;gap:6px;">
          <input type="text" id="adminAnnounceInput" placeholder="Announcement message..." style="flex:1;padding:8px 10px;background:var(--surface);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:11px;" maxlength="200">
          <button onclick="adminSendAnnouncement()" style="padding:8px 12px;background:linear-gradient(135deg,#ff0044,#ff6600);border:none;border-radius:6px;color:#fff;cursor:pointer;font-weight:700;font-size:11px;">SEND</button>
        </div>
      </div>

      <div style="background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:8px;">
        <div style="font-size:10px;color:var(--text2);letter-spacing:1px;margin-bottom:8px;">📊 CREATE POLL</div>
        <input type="text" id="adminPollQuestion" placeholder="Poll question..." style="width:100%;padding:8px 10px;background:var(--surface);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:11px;margin-bottom:6px;box-sizing:border-box;">
        <div id="adminPollOptions">
          <input type="text" class="admin-poll-opt" placeholder="Option 1" style="width:100%;padding:6px 10px;background:var(--surface);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:11px;margin-bottom:4px;box-sizing:border-box;">
          <input type="text" class="admin-poll-opt" placeholder="Option 2" style="width:100%;padding:6px 10px;background:var(--surface);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:11px;margin-bottom:4px;box-sizing:border-box;">
        </div>
        <div style="display:flex;gap:6px;margin-top:6px;">
          <button onclick="adminAddPollOption()" style="flex:1;padding:6px;background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--text2);cursor:pointer;font-size:10px;">+ ADD OPTION</button>
          <button onclick="adminSendPoll()" style="flex:1;padding:6px;background:linear-gradient(135deg,#4444ff,#6644ff);border:none;border-radius:6px;color:#fff;cursor:pointer;font-weight:700;font-size:10px;">SEND POLL</button>
          <button onclick="adminEndPoll()" style="flex:1;padding:6px;background:linear-gradient(135deg,#ff4444,#ff0000);border:none;border-radius:6px;color:#fff;cursor:pointer;font-weight:700;font-size:10px;">END POLL</button>
        </div>
      </div>

      <div id="adminAbuseStartBtn" style="margin-bottom:8px;">
        <button onclick="adminStartEvent()" style="width:100%;padding:14px;background:linear-gradient(135deg,#ff0000,#ff6600,#ffd700);border:none;border-radius:10px;color:#fff;cursor:pointer;font-weight:900;font-size:14px;font-family:'Orbitron';letter-spacing:2px;text-shadow:0 2px 8px rgba(0,0,0,.4);box-shadow:0 4px 20px rgba(255,100,0,.3);transition:all .2s;">⚡ START EVENT / ADMIN ABUSE ⚡</button>
      </div>

      <div id="adminAbuseQuickActions" style="background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:8px;">
        <div style="font-size:10px;color:var(--text2);letter-spacing:1px;margin-bottom:8px;">⚡ QUICK ACTIONS</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;">
          <button onclick="adminDoubleAll()" style="padding:8px;background:linear-gradient(135deg,#00cc88,#00ff88);border:none;border-radius:6px;color:#000;cursor:pointer;font-weight:700;font-size:10px;">💰 2X ALL MONEY</button>
          <button onclick="adminRainMoney(50)" style="padding:8px;background:linear-gradient(135deg,#44aaff,#0066ff);border:none;border-radius:6px;color:#fff;cursor:pointer;font-weight:700;font-size:10px;">🌧️ MONEY RAIN $50</button>
          <button onclick="adminRainMoney(500)" style="padding:8px;background:linear-gradient(135deg,#6644ff,#4400ff);border:none;border-radius:6px;color:#fff;cursor:pointer;font-weight:700;font-size:10px;">🌧️ MONEY RAIN $500</button>
          <button onclick="adminRainMoney(5000)" style="padding:8px;background:linear-gradient(135deg,#ff4444,#ff0000);border:none;border-radius:6px;color:#fff;cursor:pointer;font-weight:700;font-size:10px;">🌧️ RAIN $5K</button>
          <button onclick="adminRainMoney(25000)" style="padding:8px;background:linear-gradient(135deg,#ff00aa,#ff0066);border:none;border-radius:6px;color:#fff;cursor:pointer;font-weight:700;font-size:10px;">💎 RAIN $25K</button>
          <button onclick="adminRainMoney(100000)" style="padding:8px;background:linear-gradient(135deg,#ffd700,#ff8800);border:none;border-radius:6px;color:#000;cursor:pointer;font-weight:700;font-size:10px;">👑 RAIN $100K</button>
          <button onclick="adminRainMoney(1000000)" style="padding:8px;background:linear-gradient(135deg,#ffd700,#ff4400);border:none;border-radius:6px;color:#000;cursor:pointer;font-weight:700;font-size:10px;">🏆 RAIN $1M</button>
          <button onclick="adminRainMoney(1000000000)" style="padding:8px;background:linear-gradient(135deg,#ff44ff,#aa00ff);border:none;border-radius:6px;color:#fff;cursor:pointer;font-weight:700;font-size:10px;">💫 RAIN $1B</button>
          <button onclick="adminRainMoney(1000000000000)" style="padding:8px;background:linear-gradient(135deg,#ff00ff,#6600ff);border:none;border-radius:6px;color:#fff;cursor:pointer;font-weight:700;font-size:10px;">🔮 RAIN $1T</button>
          <button onclick="adminRainMoney(1000000000000000)" style="padding:8px;background:linear-gradient(135deg,#aa00ff,#4400ff);border:none;border-radius:6px;color:#fff;cursor:pointer;font-weight:700;font-size:10px;">🌌 RAIN $1Q</button>
          <button onclick="adminResetAll()" style="padding:8px;background:linear-gradient(135deg,#ff0000,#880000);border:none;border-radius:6px;color:#fff;cursor:pointer;font-weight:700;font-size:10px;">☢️ RESET ALL BAL</button>
          <button onclick="adminClearChat()" style="padding:8px;background:linear-gradient(135deg,#ff6600,#ff3300);border:none;border-radius:6px;color:#fff;cursor:pointer;font-weight:700;font-size:10px;">🧹 CLEAR CHAT</button>
        </div>
      </div>

      <div style="background:var(--bg);border:1px solid rgba(255,0,0,.3);border-radius:8px;padding:12px;margin-bottom:8px;">
        <div style="font-size:10px;color:#ff4444;letter-spacing:1px;margin-bottom:8px;">🎯 RESET SPECIFIC PLAYER</div>
        <div style="display:flex;gap:6px;margin-bottom:6px;">
          <input type="text" id="adminResetPlayerName" placeholder="Username..." style="flex:1;padding:8px 10px;background:var(--surface);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:11px;" maxlength="20">
          <button onclick="adminResetPlayer()" style="padding:8px 12px;background:linear-gradient(135deg,#ff0044,#cc0000);border:none;border-radius:6px;color:#fff;cursor:pointer;font-weight:700;font-size:10px;">RESET</button>
        </div>
        <div style="display:flex;gap:6px;">
          <button onclick="adminResetPlayer(true)" style="flex:1;padding:6px;background:linear-gradient(135deg,#880000,#440000);border:none;border-radius:6px;color:#fff;cursor:pointer;font-weight:700;font-size:9px;">🗑️ FULL WIPE (bal+stats+inv)</button>
        </div>
        <div id="adminResetPlayerResult" style="font-size:10px;color:var(--text2);margin-top:6px;"></div>
      </div>

      <div>
        <button onclick="modOpenPanel()" style="width:100%;padding:10px;background:linear-gradient(135deg,#ff0000,#ff6600);border:none;border-radius:8px;color:#fff;cursor:pointer;font-weight:900;font-size:12px;font-family:'Orbitron';letter-spacing:1px;">🛡️ MODERATION PANEL</button>
      </div>
    </div>

    <div id="bugReportPanel" style="display:none;margin-top:16px;padding:16px;background:linear-gradient(135deg,rgba(0,200,100,.05),rgba(0,180,80,.08));border:2px solid rgba(0,200,100,.3);border-radius:12px;">
      <div style="font-family:'Orbitron';font-size:13px;color:#00cc66;letter-spacing:2px;margin-bottom:12px;">🐛 BUG REPORT</div>
      <input type="text" id="bugReportTitle" placeholder="Bug title..." maxlength="60" style="width:100%;padding:8px 10px;background:var(--surface);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:11px;margin-bottom:6px;box-sizing:border-box;">
      <select id="bugReportGame" style="width:100%;padding:8px 10px;background:var(--surface);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:11px;margin-bottom:6px;box-sizing:border-box;">
        <option value="general">General / Not game-specific</option>
        <option value="slots">🎰 Slots</option>
        <option value="crash">📈 Crash</option>
        <option value="mines">💣 Mines</option>
        <option value="plinko">⚡ Plinko</option>
        <option value="cases">📦 Cases</option>
        <option value="blackjack">🃏 Blackjack</option>
        <option value="poker">♠️ Video Poker</option>
        <option value="baccarat">🎴 Baccarat</option>
        <option value="hilo">↕️ Hi-Lo</option>
        <option value="roulette">🎡 Roulette</option>
        <option value="wheel">💫 Wheel</option>
        <option value="keno">🔢 Keno</option>
        <option value="horses">🏇 Horse Racing</option>
        <option value="dice">🎯 Dice</option>
        <option value="limbo">🚀 Limbo</option>
        <option value="coinflip">🪙 Coin Flip</option>
        <option value="tower">🗼 Tower</option>
        <option value="scratch">🎫 Scratch Cards</option>
        <option value="pyl">🎲 Push Your Luck</option>
        <option value="stocks">📊 Stocks</option>
        <option value="rusroulette">🔫 Buckshot Roulette</option>
        <option value="russianr">🎰 Russian Roulette</option>
        <option value="mpbsr">💥 MP Buckshot</option>
        <option value="crypto">₿ Crypto</option>
        <option value="duels">⚔️ Duels</option>
        <option value="cups">🏆 Cup Shuffle</option>
        <option value="chat">💬 Chat</option>
        <option value="profile">👤 Profile</option>
        <option value="leaderboard">🏆 Leaderboard</option>
        <option value="inventory">🎒 Inventory</option>
        <option value="trading">🤝 Trading</option>
        <option value="prestige">⭐ Prestige</option>
      </select>
      <textarea id="bugReportDesc" placeholder="Describe the bug in detail... What happened? What did you expect?" maxlength="500" rows="4" style="width:100%;padding:8px 10px;background:var(--surface);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:11px;margin-bottom:8px;box-sizing:border-box;resize:vertical;font-family:inherit;"></textarea>
      <button onclick="bugReportSubmit()" style="width:100%;padding:10px;background:linear-gradient(135deg,#00cc66,#00aa44);border:none;border-radius:8px;color:#fff;cursor:pointer;font-weight:900;font-size:12px;font-family:'Orbitron';letter-spacing:1px;">📤 SUBMIT BUG REPORT</button>
      <div id="bugReportStatus" style="font-size:10px;color:var(--text2);margin-top:6px;text-align:center;"></div>
      <div id="bugReportMyList" style="margin-top:12px;"></div>
    </div>

    <div id="bugReportViewer" style="display:none;margin-top:16px;padding:16px;background:linear-gradient(135deg,rgba(0,200,100,.05),rgba(0,180,80,.08));border:2px solid rgba(0,200,100,.3);border-radius:12px;">
      <div style="font-family:'Orbitron';font-size:13px;color:#00cc66;letter-spacing:2px;margin-bottom:12px;">🐛 BUG REPORTS <span id="bugReportCount" style="font-size:10px;color:var(--text2);"></span></div>
      <div style="display:flex;gap:6px;margin-bottom:10px;">
        <select id="bugViewFilter" onchange="bugReportLoadAll()" style="flex:1;padding:6px 8px;background:var(--surface);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:10px;">
          <option value="all">All Reports</option>
          <option value="open">Open Only</option>
          <option value="resolved">Resolved Only</option>
        </select>
        <button onclick="bugReportLoadAll()" style="padding:6px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--text);cursor:pointer;font-size:10px;">🔄 Refresh</button>
      </div>
      <div id="bugReportList" style="max-height:400px;overflow-y:auto;"></div>
    </div>

  </div>
</div>

<div id="inventoryOverlay">
  <div class="inv-header">
    <div class="inv-title">INVENTORY</div>
    <div style="display:flex;gap:8px;align-items:center;">
      <div style="font-family:'Orbitron';font-size:14px;color:var(--gold);">Portfolio: $<span id="invTotalValue">0</span></div>
      <button class="inv-close" onclick="hideInventory()">CLOSE</button>
    </div>
  </div>
  <div class="market-stats">
    <div class="market-stat"><div class="ms-label">Items Owned</div><div class="ms-val" id="invCount">0</div></div>
    <div class="market-stat"><div class="ms-label">Rarest Item</div><div class="ms-val" id="invRarest">—</div></div>
    <div class="market-stat"><div class="ms-label">Market Trend</div><div class="ms-val" id="invTrend">—</div></div>
  </div>
  <div class="inv-tabs">
    <button class="inv-tab active" onclick="filterInventory('all',this)">All</button>
    <button class="inv-tab" onclick="filterInventory('legendary',this)">★ Legendary</button>
    <button class="inv-tab" onclick="filterInventory('covert',this)">Covert</button>
    <button class="inv-tab" onclick="filterInventory('classified',this)">Classified</button>
    <button class="inv-tab" onclick="filterInventory('restricted',this)">Restricted</button>
    <button class="inv-tab" onclick="hideInventory();openTradeOverlay()" style="border-color:rgba(0,230,118,0.3);color:#00e676;">🔄 Trade</button>
    <button class="inv-tab" onclick="hideInventory();openStoreOverlay()" style="border-color:rgba(255,215,0,0.3);color:#ffd700;">🏪 Store</button>
  </div>
  <div class="inv-grid" id="invGrid"></div>
</div>

<div id="tradeOverlay" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(4,8,20,.92);z-index:9999;overflow-y:auto;padding:20px;-webkit-overflow-scrolling:touch;">
  <div style="max-width:900px;margin:0 auto;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
      <div style="font-family:'Orbitron';font-size:18px;color:var(--green);letter-spacing:2px;">🔄 TRADING</div>
      <button onclick="closeTradeOverlay()" style="padding:8px 16px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);cursor:pointer;font-family:'Orbitron';font-size:12px;">CLOSE</button>
    </div>

  <div id="tradePanel" style="width:100%;">

    <div style="display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap;">
      <button class="inv-tab active" id="tradeSendTab" onclick="switchTradeTab('send',this)" style="border-color:rgba(0,230,118,0.3);color:#00e676;">📤 Send</button>
      <button class="inv-tab" id="tradeInboxTab" onclick="switchTradeTab('inbox',this)" style="border-color:rgba(255,184,107,0.3);color:#ffb86b;">📥 Inbox <span id="tradeInboxCount" style="font-size:9px;background:var(--red);color:#fff;padding:1px 5px;border-radius:8px;margin-left:4px;display:none;"></span></button>
      <button class="inv-tab" id="tradeHistoryTab" onclick="switchTradeTab('history',this)">📋 History</button>
      <button class="inv-tab" id="giftTabBtn" onclick="switchTradeTab('gift',this)" style="border-color:rgba(255,193,7,0.3);color:#ffc107;">🎁 Gift</button>
    </div>

    <div id="tradeSendView" style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px;">

      <div id="tradeStep1" style="text-align:center;">
        <div style="font-family:'Orbitron';font-size:16px;color:var(--gold);letter-spacing:2px;margin-bottom:16px;">🔄 START A TRADE</div>
        <div style="font-size:13px;color:var(--text2);margin-bottom:16px;">Enter the username of the player you want to trade with</div>
        <div style="max-width:360px;margin:0 auto;">
          <input type="text" id="tradeRecipient" placeholder="Enter username..." maxlength="16" autocomplete="off" style="width:100%;padding:12px 16px;background:var(--bg);border:2px solid var(--border);border-radius:10px;color:var(--text);font-family:'Inter',sans-serif;font-size:15px;text-align:center;transition:border-color .2s;">
          <div id="tradeUserStatus" style="font-size:11px;color:var(--text2);margin-top:8px;min-height:18px;"></div>
          <button id="tradeRequestBtn" onclick="tradeRequestSend()" style="width:100%;padding:14px;margin-top:8px;background:linear-gradient(135deg,#00cc66,#009944);border:none;border-radius:10px;color:#fff;cursor:pointer;font-family:'Orbitron';font-size:14px;font-weight:700;letter-spacing:2px;transition:all .2s;opacity:0.5;" disabled>SEND TRADE REQUEST</button>
        </div>
      </div>

      <div id="tradeStep2" style="display:none;text-align:center;">
        <div style="font-family:'Orbitron';font-size:16px;color:var(--neon);letter-spacing:2px;margin-bottom:16px;">⏳ WAITING FOR RESPONSE</div>
        <div style="font-size:42px;margin:12px 0;">🤝</div>
        <div style="font-size:14px;color:var(--text);">Trade request sent to <strong id="tradeWaitingFor" style="color:var(--neon);"></strong></div>
        <div style="font-size:12px;color:var(--text2);margin-top:8px;">Waiting for them to accept...</div>
        <div id="tradeWaitDots" style="font-size:24px;color:var(--neon);margin:12px 0;letter-spacing:6px;">...</div>
        <button onclick="tradeCancelRequest()" style="margin-top:16px;padding:10px 24px;background:transparent;border:1px solid var(--red);border-radius:8px;color:var(--red);cursor:pointer;font-size:12px;font-family:'Orbitron';">CANCEL</button>
      </div>

      <div id="tradeStep3" style="display:none;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;">
          <div style="font-family:'Orbitron';font-size:14px;color:var(--gold);letter-spacing:2px;">🔄 LIVE TRADE WITH <span id="tradePartnerName" style="color:var(--neon);"></span></div>
          <button onclick="tradeCancelSession()" style="padding:6px 14px;background:transparent;border:1px solid var(--red);border-radius:6px;color:var(--red);cursor:pointer;font-size:10px;">✕ CANCEL</button>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">

          <div style="background:rgba(0,240,255,.03);border:1px solid rgba(0,240,255,.15);border-radius:10px;padding:12px;">
            <div style="font-size:12px;font-weight:700;color:var(--neon);margin-bottom:8px;">🧑 YOUR OFFER</div>
            <select id="tradeItemSelect" onchange="liveTradeAddItem()" style="width:100%;padding:8px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:12px;margin-bottom:6px;"></select>
            <div id="liveTradeMyItems" style="min-height:40px;background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:8px;margin-bottom:8px;font-size:12px;color:var(--text2);">No items added</div>
            <div style="margin-bottom:6px;">
              <label style="font-size:11px;color:var(--text2);display:block;margin-bottom:4px;">+ Cash</label>
              <div style="display:flex;gap:4px;">
                <input type="text" id="tradeCashAmount" value="0" onchange="liveTradeUpdateCash()" oninput="liveTradeUpdateCash()" style="flex:1;padding:6px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--gold);font-family:'Orbitron';font-size:12px;text-align:right;">
                <button class="bet-btn" onclick="betAll('tradeCashAmount');liveTradeUpdateCash()" style="padding:4px 8px;background:var(--gold);color:#000;font-weight:900;font-size:9px;">MAX</button>
              </div>
            </div>
            <div id="liveTradeMyReady" style="text-align:center;margin-top:8px;">
              <button onclick="liveTradeToggleReady()" id="liveTradeReadyBtn" style="padding:10px 24px;background:linear-gradient(135deg,#00cc66,#009944);border:none;border-radius:8px;color:#fff;cursor:pointer;font-family:'Orbitron';font-size:12px;font-weight:700;">✅ LOCK IN</button>
            </div>
          </div>

          <div style="background:rgba(255,184,107,.03);border:1px solid rgba(255,184,107,.15);border-radius:10px;padding:12px;">
            <div style="font-size:12px;font-weight:700;color:#ffb86b;margin-bottom:8px;">👤 THEIR OFFER</div>
            <div id="liveTradeTheirItems" style="min-height:40px;background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:8px;margin-bottom:8px;font-size:12px;color:var(--text2);">Waiting...</div>
            <div id="liveTradeTheirCash" style="font-family:'Orbitron';font-size:14px;color:var(--gold);margin-bottom:8px;">$0</div>
            <div id="liveTradeTheirReadyStatus" style="text-align:center;font-size:12px;color:var(--text2);margin-top:8px;">⏳ Not locked in</div>
          </div>
        </div>
        <div id="liveTradeConfirmArea" style="display:none;text-align:center;margin-top:12px;">
          <div style="font-size:13px;color:var(--green);margin-bottom:8px;">✅ Both players locked in!</div>
          <button onclick="liveTradeExecute()" style="padding:12px 32px;background:linear-gradient(135deg,#ffc107,#ff9800);border:none;border-radius:10px;color:#000;cursor:pointer;font-family:'Orbitron';font-size:14px;font-weight:700;">🤝 CONFIRM TRADE</button>
        </div>
        <div id="tradeStatus" style="font-size:12px;color:var(--text2);margin-top:8px;text-align:center;"></div>
      </div>
    </div>

    <div id="tradeInboxView" style="display:none;background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px;">
      <div style="font-family:'Orbitron';font-size:14px;color:#ffb86b;letter-spacing:2px;margin-bottom:12px;">📥 INCOMING TRADES</div>
      <div id="incomingTrades" style="display:flex;flex-direction:column;gap:8px;">
        <div style="color:var(--text2);font-size:12px;text-align:center;padding:20px;">No pending trades</div>
      </div>
    </div>

    <div id="tradeHistoryView" style="display:none;background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px;">
      <div style="font-family:'Orbitron';font-size:14px;color:var(--text2);letter-spacing:2px;margin-bottom:12px;">📋 TRADE HISTORY</div>
      <div id="tradeHistoryList" style="display:flex;flex-direction:column;gap:6px;">
        <div style="color:var(--text2);font-size:12px;text-align:center;padding:20px;">No trade history yet</div>
      </div>
    </div>

    <div id="giftView" style="display:none;background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px;">
      <div style="font-family:'Orbitron';font-size:16px;color:var(--gold);letter-spacing:2px;margin-bottom:16px;text-align:center;">🎁 GIFT MONEY</div>
      <div style="max-width:400px;margin:0 auto;">
        <div style="margin-bottom:12px;">
          <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px;">Recipient Username</label>
          <input type="text" id="giftUsername" placeholder="Enter username..." maxlength="16" autocomplete="off" style="width:100%;padding:12px 14px;background:var(--bg);border:2px solid var(--border);border-radius:10px;color:var(--text);font-family:'Inter',sans-serif;font-size:14px;box-sizing:border-box;">
        </div>
        <div style="margin-bottom:12px;">
          <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px;">Amount ($)</label>
          <input type="text" id="giftAmount" placeholder="Enter amount..." style="width:100%;padding:12px 14px;background:var(--bg);border:2px solid var(--border);border-radius:10px;color:var(--gold);font-family:'Orbitron';font-size:14px;text-align:right;box-sizing:border-box;">
        </div>
        <div style="display:flex;gap:8px;margin-bottom:12px;">
          <button onclick="quickGiftAmount(100)" style="flex:1;padding:8px;background:rgba(212,175,55,.15);border:1px solid rgba(212,175,55,.3);border-radius:6px;color:var(--gold);cursor:pointer;font-size:11px;font-family:'Orbitron';font-weight:700;">$100</button>
          <button onclick="quickGiftAmount(1000)" style="flex:1;padding:8px;background:rgba(212,175,55,.15);border:1px solid rgba(212,175,55,.3);border-radius:6px;color:var(--gold);cursor:pointer;font-size:11px;font-family:'Orbitron';font-weight:700;">$1K</button>
          <button onclick="quickGiftAmount(10000)" style="flex:1;padding:8px;background:rgba(212,175,55,.15);border:1px solid rgba(212,175,55,.3);border-radius:6px;color:var(--gold);cursor:pointer;font-size:11px;font-family:'Orbitron';font-weight:700;">$10K</button>
        </div>
        <button onclick="sendGift()" style="width:100%;padding:14px;background:linear-gradient(135deg,#ffc107,#ff9800);border:none;border-radius:10px;color:#000;cursor:pointer;font-family:'Orbitron';font-size:14px;font-weight:700;letter-spacing:1px;transition:all .2s;">💝 SEND GIFT</button>
        <div id="giftStatus" style="font-size:12px;color:var(--text2);margin-top:8px;text-align:center;min-height:20px;"></div>
      </div>
    </div>
  </div>
  </div>
</div>

<div id="storeOverlay" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(4,8,20,.92);z-index:9999;overflow-y:auto;padding:20px;-webkit-overflow-scrolling:touch;">
  <div style="max-width:960px;margin:0 auto;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
      <div style="font-family:'Orbitron';font-size:18px;color:var(--gold);letter-spacing:2px;">🏪 MARKETPLACE</div>
      <button onclick="closeStoreOverlay()" style="padding:8px 16px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);cursor:pointer;font-family:'Orbitron';font-size:12px;">CLOSE</button>
    </div>

  <div id="storePanel" style="width:100%;">
    <div style="display:flex;gap:6px;margin-bottom:12px;">
      <button class="inv-tab active" id="storeBrowseTab" onclick="switchStoreTab('browse',this)" style="border-color:rgba(255,215,0,0.3);color:#ffd700;">🏪 Browse</button>
      <button class="inv-tab" id="storeListTab" onclick="switchStoreTab('list',this)" style="border-color:rgba(0,230,118,0.3);color:#00e676;">📦 List Item</button>
      <button class="inv-tab" id="storeMyTab" onclick="switchStoreTab('my',this)" style="border-color:rgba(0,240,255,0.3);color:var(--neon);">📋 My Listings</button>
      <button class="inv-tab" id="storeSalesTab" onclick="switchStoreTab('sales',this)">💰 Sales Log</button>
    </div>

    <div id="storeBrowseView" style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px;">
      <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:14px;">
        <div style="font-family:'Orbitron';font-size:14px;color:var(--gold);letter-spacing:2px;">🏪 MARKETPLACE</div>
        <div style="display:flex;gap:6px;align-items:center;">
          <select id="storeFilterRarity" onchange="renderStoreListings()" style="padding:6px 10px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:11px;">
            <option value="all">All Rarities</option>
            <option value="legendary">★ Legendary</option>
            <option value="covert">Covert</option>
            <option value="classified">Classified</option>
            <option value="restricted">Restricted</option>
            <option value="milspec">Mil-Spec</option>
            <option value="industrial">Industrial</option>
            <option value="consumer">Consumer</option>
          </select>
          <select id="storeSortBy" onchange="renderStoreListings()" style="padding:6px 10px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:11px;">
            <option value="newest">Newest</option>
            <option value="priceAsc">Price: Low → High</option>
            <option value="priceDesc">Price: High → Low</option>
            <option value="ending">Ending Soon</option>
          </select>
          <button onclick="loadStoreListings()" style="padding:6px 10px;background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--neon);cursor:pointer;font-size:11px;">🔄 Refresh</button>
        </div>
      </div>
      <div id="storeListingsGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px;max-height:500px;overflow-y:auto;padding:4px;">
        <div style="grid-column:1/-1;color:var(--text2);font-size:12px;text-align:center;padding:30px;">Loading marketplace...</div>
      </div>
    </div>

    <div id="storeListView" style="display:none;background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px;">
      <div style="font-family:'Orbitron';font-size:14px;color:var(--gold);letter-spacing:2px;margin-bottom:14px;">📦 LIST AN ITEM</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
        <div style="background:rgba(0,240,255,.03);border:1px solid rgba(0,240,255,.15);border-radius:10px;padding:14px;">
          <div style="font-size:12px;font-weight:700;color:var(--neon);margin-bottom:10px;">SELECT ITEM</div>
          <select id="storeListItemSelect" onchange="storeUpdateListPreview()" style="width:100%;padding:8px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:12px;margin-bottom:10px;"></select>
          <div id="storeListItemPreview" style="background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:12px;text-align:center;min-height:100px;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:4px;">
            <div style="color:var(--text2);font-size:12px;">Select an item from your inventory</div>
          </div>
        </div>
        <div style="background:rgba(255,215,0,.03);border:1px solid rgba(255,215,0,.15);border-radius:10px;padding:14px;">
          <div style="font-size:12px;font-weight:700;color:var(--gold);margin-bottom:10px;">LISTING TYPE</div>
          <div style="display:flex;gap:8px;margin-bottom:12px;">
            <button id="storeTypeFixed" onclick="storeSetType('fixed')" class="inv-tab active" style="flex:1;text-align:center;padding:8px;">💰 Fixed Price</button>
            <button id="storeTypeAuction" onclick="storeSetType('auction')" class="inv-tab" style="flex:1;text-align:center;padding:8px;">🔨 Auction</button>
          </div>

          <div id="storeFixedFields">
            <label style="font-size:11px;color:var(--text2);display:block;margin-bottom:4px;">Asking Price ($)</label>
            <input type="number" id="storeAskPrice" min="1" style="width:100%;padding:8px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--gold);font-family:'Orbitron';font-size:13px;">
            <div id="storeMarketRef" style="font-size:10px;color:var(--text2);margin-top:4px;">Market value: —</div>
          </div>

          <div id="storeAuctionFields" style="display:none;">
            <label style="font-size:11px;color:var(--text2);display:block;margin-bottom:4px;">Starting Bid ($)</label>
            <input type="text" id="storeStartBid" style="width:100%;padding:8px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--gold);font-family:'Orbitron';font-size:13px;margin-bottom:8px;">
            <label style="font-size:11px;color:var(--text2);display:block;margin-bottom:4px;">Duration</label>
            <select id="storeAuctionDuration" style="width:100%;padding:8px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:12px;">
              <option value="300000">5 minutes</option>
              <option value="900000">15 minutes</option>
              <option value="1800000" selected>30 minutes</option>
              <option value="3600000">1 hour</option>
              <option value="86400000">24 hours</option>
            </select>
          </div>
          <div style="margin-top:14px;">
            <button onclick="storeListItem()" style="width:100%;padding:12px;background:linear-gradient(135deg,#ffd700,#ff9900);border:none;border-radius:10px;color:#000;cursor:pointer;font-family:'Orbitron';font-size:13px;font-weight:700;letter-spacing:2px;">LIST ON STORE</button>
          </div>
          <div id="storeListStatus" style="font-size:11px;color:var(--text2);margin-top:8px;text-align:center;"></div>
        </div>
      </div>
    </div>

    <div id="storeMyView" style="display:none;background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px;">
      <div style="font-family:'Orbitron';font-size:14px;color:var(--neon);letter-spacing:2px;margin-bottom:12px;">📋 MY LISTINGS</div>
      <div id="storeMyListings" style="display:flex;flex-direction:column;gap:8px;">
        <div style="color:var(--text2);font-size:12px;text-align:center;padding:20px;">No active listings</div>
      </div>
    </div>

    <div id="storeSalesView" style="display:none;background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px;">
      <div style="font-family:'Orbitron';font-size:14px;color:var(--gold);letter-spacing:2px;margin-bottom:12px;">💰 RECENT SALES</div>
      <div style="font-size:11px;color:var(--text2);margin-bottom:10px;">See what items have sold for across the marketplace</div>
      <div id="storeSalesLog" style="display:flex;flex-direction:column;gap:6px;">
        <div style="color:var(--text2);font-size:12px;text-align:center;padding:20px;">No sales yet</div>
      </div>
    </div>
  </div>
  </div>
</div>

<div id="friendsOverlay" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(4,8,20,.92);z-index:9999;overflow-y:auto;padding:20px;-webkit-overflow-scrolling:touch;">
  <div style="max-width:700px;margin:0 auto;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
      <div style="font-family:'Orbitron';font-size:18px;color:var(--gold);letter-spacing:2px;">👥 FRIENDS</div>
      <button onclick="hideFriendsPanel()" style="padding:8px 16px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);cursor:pointer;font-family:'Orbitron';font-size:12px;">CLOSE</button>
    </div>
    <div style="display:flex;gap:6px;margin-bottom:14px;flex-wrap:wrap;">
      <button class="inv-tab active" id="frTabFriends" onclick="switchFriendsTab('friends',this)">👥 Friends</button>
      <button class="inv-tab" id="frTabRequests" onclick="switchFriendsTab('requests',this)">📩 Requests <span id="frReqCount" style="font-size:9px;background:var(--red);color:#fff;padding:1px 5px;border-radius:8px;margin-left:3px;display:none;"></span></button>
      <button class="inv-tab" id="frTabAdd" onclick="switchFriendsTab('add',this)">➕ Add</button>
      <button class="inv-tab" id="frTabBlocked" onclick="switchFriendsTab('blocked',this)">🚫 Blocked</button>
      <button class="inv-tab" id="frTabDM" onclick="switchFriendsTab('dm',this)">💬 Messages</button>
      <button class="inv-tab" id="frTabPrivacy" onclick="switchFriendsTab('privacy',this)">🔒 Privacy</button>
    </div>

    <div id="frViewFriends" style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px;">
      <div style="font-family:'Orbitron';font-size:13px;color:var(--neon);letter-spacing:1px;margin-bottom:12px;">YOUR FRIENDS <span id="frFriendCount" style="color:var(--text2);font-size:11px;"></span></div>
      <div id="frFriendsList" style="display:flex;flex-direction:column;gap:8px;">
        <div style="color:var(--text2);font-size:12px;text-align:center;padding:20px;">Loading...</div>
      </div>
    </div>

    <div id="frViewRequests" style="display:none;background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px;">
      <div style="font-family:'Orbitron';font-size:13px;color:#ffb86b;letter-spacing:1px;margin-bottom:12px;">FRIEND REQUESTS</div>
      <div id="frRequestsList" style="display:flex;flex-direction:column;gap:8px;">
        <div style="color:var(--text2);font-size:12px;text-align:center;padding:20px;">No pending requests</div>
      </div>
    </div>

    <div id="frViewAdd" style="display:none;background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px;text-align:center;">
      <div style="font-family:'Orbitron';font-size:13px;color:var(--green);letter-spacing:1px;margin-bottom:16px;">ADD A FRIEND</div>
      <div style="max-width:340px;margin:0 auto;">
        <input type="text" id="frAddInput" placeholder="Enter username..." maxlength="16" autocomplete="off" style="width:100%;padding:12px 16px;background:var(--bg);border:2px solid var(--border);border-radius:10px;color:var(--text);font-size:14px;text-align:center;">
        <button onclick="friendSendRequest()" style="width:100%;margin-top:10px;padding:12px;background:linear-gradient(135deg,#00cc66,#009944);border:none;border-radius:10px;color:#fff;cursor:pointer;font-family:'Orbitron';font-size:13px;font-weight:700;">SEND FRIEND REQUEST</button>
        <div id="frAddStatus" style="font-size:11px;color:var(--text2);margin-top:8px;"></div>
      </div>
      <div style="margin-top:20px;border-top:1px solid var(--border);padding-top:16px;">
        <div style="font-family:'Orbitron';font-size:12px;color:var(--red);letter-spacing:1px;margin-bottom:10px;">🚫 BLOCK A PLAYER</div>
        <div style="max-width:340px;margin:0 auto;">
          <input type="text" id="frBlockInput" placeholder="Username to block..." maxlength="16" autocomplete="off" style="width:100%;padding:10px 14px;background:var(--bg);border:2px solid rgba(255,55,95,.3);border-radius:10px;color:var(--text);font-size:13px;text-align:center;">
          <button onclick="friendBlockPlayer()" style="width:100%;margin-top:8px;padding:10px;background:transparent;border:2px solid var(--red);border-radius:10px;color:var(--red);cursor:pointer;font-family:'Orbitron';font-size:12px;font-weight:700;">BLOCK PLAYER</button>
          <div id="frBlockStatus" style="font-size:11px;color:var(--text2);margin-top:6px;"></div>
        </div>
      </div>
    </div>

    <div id="frViewBlocked" style="display:none;background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px;">
      <div style="font-family:'Orbitron';font-size:13px;color:var(--red);letter-spacing:1px;margin-bottom:12px;">🚫 BLOCKED PLAYERS</div>
      <div id="frBlockedList" style="display:flex;flex-direction:column;gap:8px;">
        <div style="color:var(--text2);font-size:12px;text-align:center;padding:20px;">No blocked players</div>
      </div>
    </div>

    <div id="frViewDm" style="display:none;background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px;">
      <div style="font-family:'Orbitron';font-size:13px;color:var(--neon);letter-spacing:1px;margin-bottom:12px;">💬 DIRECT MESSAGES</div>

      <div id="dmContactList" style="display:flex;flex-direction:column;gap:6px;">
        <div style="color:var(--text2);font-size:12px;text-align:center;padding:20px;">Add friends to message them</div>
      </div>

      <div id="dmChatView" style="display:none;margin-top:12px;">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
          <button onclick="dmBackToList()" style="padding:4px 10px;background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--text);cursor:pointer;font-size:11px;">← Back</button>
          <div id="dmChatPartner" style="font-weight:700;color:var(--neon);font-size:13px;"></div>
          <div id="dmPartnerStatus" style="font-size:10px;margin-left:auto;"></div>
        </div>
        <div id="dmMessages" style="background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:10px;height:280px;overflow-y:auto;display:flex;flex-direction:column;gap:6px;-webkit-overflow-scrolling:touch;"></div>
        <div style="display:flex;gap:6px;margin-top:8px;">
          <input type="text" id="dmInput" placeholder="Type a message..." maxlength="200" autocomplete="off" style="flex:1;padding:10px 14px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:12px;">
          <button onclick="dmSendMessage()" style="padding:10px 18px;background:linear-gradient(135deg,#00cc66,#009944);border:none;border-radius:8px;color:#fff;cursor:pointer;font-family:'Orbitron';font-size:11px;font-weight:700;">SEND</button>
        </div>
      </div>
    </div>

    <div id="frViewPrivacy" style="display:none;background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px;">
      <div style="font-family:'Orbitron';font-size:13px;color:var(--gold);letter-spacing:1px;margin-bottom:16px;">🔒 PRIVACY SETTINGS</div>
      <div style="display:flex;flex-direction:column;gap:14px;max-width:400px;">
        <div>
          <label style="font-size:12px;font-weight:700;color:var(--text);display:block;margin-bottom:6px;">Friend Requests</label>
          <select id="privFriendRequests" style="width:100%;padding:8px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:12px;">
            <option value="everyone">Everyone can send me requests</option>
            <option value="friends_only">Friends of friends only</option>
            <option value="nobody">Nobody</option>
          </select>
        </div>
        <div>
          <label style="font-size:12px;font-weight:700;color:var(--text);display:block;margin-bottom:6px;">Direct Messages</label>
          <select id="privDirectMessages" style="width:100%;padding:8px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:12px;">
            <option value="friends">Friends only</option>
            <option value="everyone">Everyone</option>
            <option value="nobody">Nobody</option>
          </select>
        </div>
        <div>
          <label style="font-size:12px;font-weight:700;color:var(--text);display:block;margin-bottom:6px;">Online Status</label>
          <select id="privOnlineStatus" style="width:100%;padding:8px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:12px;">
            <option value="everyone">Visible to everyone</option>
            <option value="friends">Friends only</option>
            <option value="hidden">Hidden (appear offline)</option>
          </select>
        </div>
        <div>
          <label style="font-size:12px;font-weight:700;color:var(--text);display:block;margin-bottom:6px;">Trade Requests</label>
          <select id="privTradeRequests" style="width:100%;padding:8px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:12px;">
            <option value="everyone">Everyone</option>
            <option value="friends">Friends only</option>
            <option value="nobody">Nobody</option>
          </select>
        </div>
        <button onclick="savePrivacySettings()" style="padding:12px;background:linear-gradient(135deg,#ffd700,#ff9900);border:none;border-radius:10px;color:#000;cursor:pointer;font-family:'Orbitron';font-size:13px;font-weight:700;letter-spacing:2px;">SAVE SETTINGS</button>
        <div id="privSaveStatus" style="font-size:11px;color:var(--text2);text-align:center;"></div>
      </div>
    </div>
  </div>
</div>

<button id="chatToggleBtn" onclick="toggleChat()" style="display:none;" title="Chat">💬<span class="chat-badge" id="chatBadge">0</span></button>
<div id="chatPanel">
  <div class="chat-header">
    <div class="chat-header-title"><span class="online-dot"></span> LOBBY CHAT <span class="chat-online-count" id="chatOnlineCount"></span></div>
    <button class="chat-close" onclick="toggleChat()">✕</button>
  </div>
  <div class="chat-messages" id="chatMessages">
    <div class="chat-msg-system">Welcome to Casino Royale chat! Be respectful.</div>
  </div>
  <div class="chat-input-wrap">
    <div id="modMuteBanner">🔇 You are muted: <span id="modMuteReason"></span> — <span id="modMuteTimer"></span></div>
    <input class="chat-input" id="chatInput" placeholder="Type a message..." maxlength="200" autocomplete="off">
    <button class="chat-send-btn" id="chatSendBtn" onclick="sendChatMessage()">Send</button>
  </div>
</div>

<script type="module">
import{initializeApp}from"https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
import{getDatabase,ref,set,get,onValue,push,update,remove,off,onDisconnect,query as fbQuery,limitToLast as fbLimitToLast}from"https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";
import{getAuth,createUserWithEmailAndPassword,signInWithEmailAndPassword,signOut,onAuthStateChanged}from"https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";

const firebaseConfig={
  apiKey:"AIzaSyC1mxE6gUBx2NM-H3129JvbZPLhxjWZoLc",
  authDomain:"even-better-gamble.firebaseapp.com",
  databaseURL:"https://even-better-gamble-default-rtdb.firebaseio.com",
  projectId:"even-better-gamble",
  storageBucket:"even-better-gamble.firebasestorage.app",
  messagingSenderId:"1017397016878",
  appId:"1:1017397016878:web:23b3c12adbcdca289722bf",
  measurementId:"G-9YDBLVLNKJ"
};
const app=initializeApp(firebaseConfig);
const db=getDatabase(app);
const auth=getAuth(app);

let currentUser = null;
let currentUsername = '';
let playerId = '';
let playerRef = null;

function usernameToEmail(username) {
  return username.toLowerCase().replace(/[^a-z0-9_]/g,'') + '@casinoroyale.gg';
}

function emailToUsername(email) {
  return email.replace('@casinoroyale.gg','');
}

window._authSubmit = async (username, password, isRegister) => {
  const email = usernameToEmail(username);
  if (username.length < 3) throw new Error('Username must be at least 3 characters');
  if (username.length > 16) throw new Error('Username max 16 characters');
  if (!/^[a-zA-Z0-9_]+$/.test(username)) throw new Error('Letters, numbers, and _ only');

  const _badWords = ['nigger','nigga','faggot','fag','retard','chink','spic','kike','beaner','tranny','coon','wetback','gook'];
  const _uLow = username.toLowerCase();
  for (const w of _badWords) { if (_uLow.includes(w)) throw new Error('Username contains inappropriate language'); }
  if (password.length < 6) throw new Error('Password must be at least 6 characters');

  if (isRegister) {

    const nameSnap = await get(ref(db, 'casino/usernames/' + username.toLowerCase()));
    if (nameSnap.exists()) throw new Error('Username already taken');
    const cred = await createUserWithEmailAndPassword(auth, email, password);

    await set(ref(db, 'casino/usernames/' + username.toLowerCase()), cred.user.uid);

    await set(ref(db, 'casino/players/' + cred.user.uid), {
      username: username,
      balance: 1000,
      created: Date.now(),
      lastPlayed: Date.now(),
      stats: { totalWagered: 0, totalWon: 0, totalProfit: 0, gamesPlayed: 0, biggestWin: 0 },
      gameStats: {
        slots: { played: 0, won: 0, biggestWin: 0 },
        crash: { played: 0, won: 0, biggestMultiplier: 0, biggestWin: 0 },
        roulette: { played: 0, won: 0, biggestWin: 0 },
        cases: { played: 0, opened: 0, bestItem: '' },
        plinko: { played: 0, won: 0, biggestWin: 0 },
        pyl: { played: 0, highScore: 0 }
      },
      dailyBonus: { lastClaimed: 0, streak: 0 },
      prestige: 0
    });
    return cred.user;
  } else {
    const cred = await signInWithEmailAndPassword(auth, email, password);
    return cred.user;
  }
};

window._authLogout = () => signOut(auth);

onAuthStateChanged(auth, async (user) => {
  if (user) {
    currentUser = user;
    playerId = user.uid;
    window._currentPlayerId = playerId;
    playerRef = ref(db, 'casino/players/' + playerId);

    const snap = await get(playerRef);
    if (snap.exists()) {
      const data = snap.val();
      currentUsername = data.username || emailToUsername(user.email);
      if (data.balance != null) window._syncBalFromServer(safeNum(data.balance));
      if (data.stocks) window._loadStocks(data.stocks);
      if (data.inventory) window._loadInventory(data.inventory);
      if (data.itemDemand) window._loadDemand(data.itemDemand);
      if (data.stats) window._loadStats(data.stats);
      if (data.gameStats) window._loadGameStats(data.gameStats);
      if (data.dailyBonus) window._loadDailyBonus(data.dailyBonus);
      if (data.achievements) window._loadAchievements(data.achievements);
      if (data.tradeHistory) window._loadTradeHistory(data.tradeHistory);
      if (data.prestige != null) window._loadPrestige(data.prestige);
      if (data.profilePicUrl) window._loadProfilePicUrl(data.profilePicUrl);
    } else {
      currentUsername = emailToUsername(user.email);
    }

    const banSnap = await get(ref(db, 'casino/bannedUsers/' + playerId));
    if (banSnap.exists()) {
      const banData = banSnap.val();
      const isPerm = !banData.until || banData.until >= 9999999999999;
      if (isPerm || banData.until > Date.now()) {

        window._modShowBan && window._modShowBan(banData);
        setTimeout(() => signOut(auth), 4000);
        return;
      } else {

        await set(ref(db, 'casino/bannedUsers/' + playerId), null);
      }
    }

    let pylSessionId = sessionStorage.getItem('pyl_session_id');
    if (!pylSessionId) {
      pylSessionId = playerId + '_' + Math.random().toString(36).substr(2, 4);
      sessionStorage.setItem('pyl_session_id', pylSessionId);
    }
    window._pylPlayerId = pylSessionId;
    window._currentPylSessionId = pylSessionId;
    window._currentUsername = currentUsername;
    window._currentPlayerId = playerId;

    if (typeof window._onAuthReady === 'function') window._onAuthReady(currentUsername, playerId);

    let _resetCooldownUntil = 0;
    window._setResetCooldown = () => { _resetCooldownUntil = Date.now() + 30000; };
    async function _syncBalance() {
      if (Date.now() < _resetCooldownUntil) return;
      if (typeof _anyGameActive === 'function' && _anyGameActive()) return;
      if (typeof _fbSaveDirty !== 'undefined' && _fbSaveDirty) return;
      if (typeof _fbSaveTimer !== 'undefined' && _fbSaveTimer) return;
      try {
        const balSnap = await get(ref(db, 'casino/players/' + playerId + '/balance'));
        if (balSnap.exists()) {
          const serverBal = safeNum(balSnap.val());
          if (Math.abs(serverBal - window.getBalance()) > 0.02) {
            window._syncBalFromServer(serverBal);
          }
        }
      } catch(e) {}
    }
    async function _fullSync() {
      if (Date.now() < _resetCooldownUntil) return;
      if (typeof _anyGameActive === 'function' && _anyGameActive()) return;
      if (typeof _fbSaveDirty !== 'undefined' && _fbSaveDirty) return;
      if (typeof _fbSaveTimer !== 'undefined' && _fbSaveTimer) return;
      try {
        const snap = await get(playerRef);
        if (!snap.exists()) return;
        const data = snap.val();
        if (data.balance != null) window._syncBalFromServer(safeNum(data.balance));
        if (data.inventory && window._loadInventory) window._loadInventory(data.inventory);
        if (data.stats && window._loadStats) window._loadStats(data.stats);
        if (data.gameStats && window._loadGameStats) window._loadGameStats(data.gameStats);
        if (data.prestige != null && window._loadPrestige) window._loadPrestige(data.prestige);
        if (data.achievements && window._loadAchievements) window._loadAchievements(data.achievements);
      } catch(e) {}
    }
    if (window._balanceUnsub) { clearInterval(window._balanceUnsub); window._balanceUnsub = null; }
    window._balanceUnsub = setInterval(_syncBalance, 30000);

    document.addEventListener('visibilitychange', () => {
      if (!document.hidden && playerId) _fullSync();
    });
  } else {
    if (window._balanceUnsub) { clearInterval(window._balanceUnsub); window._balanceUnsub = null; }
    currentUser = null;
    currentUsername = '';
    playerId = '';
    playerRef = null;
    if (typeof window._onAuthLoggedOut === 'function') window._onAuthLoggedOut();
  }
});

window._firebaseSave = () => {
  if (!playerRef) return;
  const curBal = safeNum(window.getBalance());

  const shadow = window._balGetShadow();
  if (shadow > 1 && curBal > shadow * 1e4 && curBal > 1e6) {
    console.warn('[anti-cheat] Suspicious balance blocked from saving');
    return;
  }
  const saveData = {
    username: currentUsername,
    balance: curBal,
    lastPlayed: Date.now(),
    stats: window._getStats ? window._getStats() : null,
    gameStats: window._getGameStats ? window._getGameStats() : null,
    achievements: window._getAchievements ? window._getAchievements() : null,
    prestige: window._getPrestige ? window._getPrestige() : null,
    profilePicUrl: window._getProfilePicUrl ? window._getProfilePicUrl() : null
  };

  Object.keys(saveData).forEach(k => { if (saveData[k] == null) delete saveData[k]; });
  update(playerRef, saveData).catch(() => {});

};

let _pendingStats = null;
let _statsTimer = null;

async function _flushStats() {
  if (!_pendingStats || !playerRef) return;
  const { game, wagered, won } = _pendingStats;
  _pendingStats = null;
  const statsRef = ref(db, 'casino/players/' + playerId + '/stats');
  try {
    const snap = await get(statsRef);
    const s = snap.exists() ? snap.val() : { totalWagered: 0, totalWon: 0, totalProfit: 0, gamesPlayed: 0, biggestWin: 0 };

    Object.assign(s, {
      totalWagered: playerStats.totalWagered,
      totalWon: playerStats.totalWon,
      totalProfit: playerStats.totalProfit,
      gamesPlayed: playerStats.gamesPlayed,
      biggestWin: playerStats.biggestWin
    });
    await set(statsRef, s);
    if (window._loadStats) window._loadStats(s);

  } catch(e) { console.warn('recordGameResult error:', e); }
}

window._recordGameResult = async (game, wagered, won) => {
  if (!playerRef) return;
  _pendingStats = { game, wagered, won };
  if (_statsTimer) clearTimeout(_statsTimer);
  _statsTimer = setTimeout(() => { _statsTimer = null; _flushStats(); }, 10000);
};

window._flushStatsNow = () => { if(_statsTimer){clearTimeout(_statsTimer);_statsTimer=null;_flushStats();} };

window._getLeaderboard = async (category) => {
  try {
    const snap = await get(ref(db, 'casino/players'));
    if (!snap.exists()) return [];
    const players = snap.val();
    const entries = Object.entries(players)
      .filter(([uid, p]) => p.username)
      .map(([uid, p]) => {
        let value = 0;
        if (category === 'richest') value = safeNum(p.balance || 0);
        else if (category === 'profit') value = safeNum((p.stats && p.stats.totalProfit) || 0);
        else if (category === 'prestige') value = (p.prestige || 0);
        else if (category === 'pyl') value = (p.gameStats && p.gameStats.pyl && p.gameStats.pyl.highScore) || 0;
        else value = (p.gameStats && p.gameStats[category] && p.gameStats[category].biggestWin) || 0;
        return { uid, name: p.username, value: safeNum(value), updated: p.lastPlayed || 0 };
      })
      .filter(e => e.value > 0 || category === 'richest');
    entries.sort((a, b) => b.value - a.value);
    return entries.slice(0, 25);
  } catch { return []; }
};

window._claimDailyBonus = async () => {
  if (!playerRef) return null;
  const bonusRef = ref(db, 'casino/players/' + playerId + '/dailyBonus');
  const now = Date.now();
  try {
    const snap = await get(bonusRef);
    const data = snap.exists() ? snap.val() : { lastClaimed: 0, streak: 0 };
    const lastDate = new Date(data.lastClaimed).toDateString();
    const todayDate = new Date(now).toDateString();
    if (lastDate === todayDate) return null;
    const yesterdayDate = new Date(now - 86400000).toDateString();
    const newStreak = (lastDate === yesterdayDate) ? (data.streak || 0) + 1 : 1;
    const bonus = Math.min(500 + (newStreak - 1) * 100, 2000);
    await set(bonusRef, { lastClaimed: now, streak: newStreak });
    return { amount: bonus, streak: newStreak };
  } catch(e) { console.warn('claimDailyBonus error:', e); return null; }
};

let _marketListener = null;
window._initGlobalMarket = () => {
  if (_marketListener) return;
  const marketRef = ref(db, 'casino/market');
  _marketListener = onValue(marketRef, (snap) => {
    if (!snap.exists()) return;
    const data = snap.val();

    if (window._onGlobalMarketUpdate) window._onGlobalMarketUpdate(data);
  });
};

window._updateGlobalMarketItem = async (itemId, action, price) => {
  const itemRef = ref(db, 'casino/market/' + itemId);
  try {
    const snap = await get(itemRef);
    const d = snap.exists() ? snap.val() : { globalSupply: 0, totalOpened: 0, lastTradePrice: 0, lastTradeTs: 0 };
    if (action === 'opened') {
      d.globalSupply = (d.globalSupply || 0) + 1;
      d.totalOpened = (d.totalOpened || 0) + 1;
    } else if (action === 'sold') {
      d.globalSupply = Math.max(0, (d.globalSupply || 0) - 1);
      d.lastTradePrice = price || 0;
      d.lastTradeTs = Date.now();
    } else if (action === 'traded') {
      d.lastTradePrice = price || 0;
      d.lastTradeTs = Date.now();
    }
    await set(itemRef, d);
  } catch(e) {}
};

window._sendTradeOffer = async (recipientUsername, item, cash, message) => {
  if (!playerId || !currentUsername) return { error: 'Not logged in' };
  const nameSnap = await get(ref(db, 'casino/usernames/' + recipientUsername));
  if (!nameSnap.exists()) return { error: 'Player not found' };
  const recipientUid = nameSnap.val();
  if (recipientUid === playerId) return { error: "Can't trade with yourself" };
  const itemDef = window.ITEM_CATALOG ? window.ITEM_CATALOG[item.itemId] : null;
  const itemName = itemDef ? itemDef.name : item.itemId;
  const tradeRef = push(ref(db, 'casino/trades/' + recipientUid));
  await set(tradeRef, {
    from: currentUsername,
    fromUid: playerId,
    itemId: item.itemId,
    itemName: itemName,
    cash: cash || 0,
    message: message || '',
    timestamp: Date.now()
  });
  return { success: true };
};

window._loadPendingTrades = async () => {
  if (!playerId) return [];
  const snap = await get(ref(db, 'casino/trades/' + playerId));
  if (!snap.exists()) return [];
  const trades = [];
  snap.forEach(child => {
    trades.push({ id: child.key, ...child.val() });
  });
  return trades;
};

window._acceptTradeOffer = async (tradeId) => {
  if (!playerId) return;

  const tradeSnap = await get(ref(db, 'casino/trades/' + playerId + '/' + tradeId));
  if (tradeSnap.exists()) {
    const trade = tradeSnap.val();

    const creditData = { item: trade.itemId || null, cash: trade.cash || 0, reason: 'trade_accepted', from: trade.from || 'Unknown', ts: Date.now() };
    const creditRef = push(ref(db, 'casino/pendingRefunds/' + playerId));
    await set(creditRef, creditData);
  }
  await remove(ref(db, 'casino/trades/' + playerId + '/' + tradeId));
};

window._declineTradeOffer = async (tradeId) => {
  if (!playerId) return { error: 'Not logged in' };
  const tradeSnap = await get(ref(db, 'casino/trades/' + playerId + '/' + tradeId));
  if (!tradeSnap.exists()) return { error: 'Trade not found' };
  const trade = tradeSnap.val();

  if (trade.fromUid) {
    const refundData = { item: trade.itemId || null, cash: trade.cash || 0, reason: 'trade_declined', from: currentUsername || 'Unknown', ts: Date.now() };
    const refundRef = push(ref(db, 'casino/pendingRefunds/' + trade.fromUid));
    await set(refundRef, refundData);
  }
  await remove(ref(db, 'casino/trades/' + playerId + '/' + tradeId));
  return { success: true };
};

window._checkPendingRefunds = async () => {
  if (!playerId) return [];
  const snap = await get(ref(db, 'casino/pendingRefunds/' + playerId));
  if (!snap.exists()) return [];
  const refunds = [];
  snap.forEach(child => { refunds.push({ id: child.key, ...child.val() }); });

  await remove(ref(db, 'casino/pendingRefunds/' + playerId));
  return refunds;
};

window._checkUsernameExists = async (username) => {
  const snap = await get(ref(db, 'casino/usernames/' + username));
  return snap.exists() ? snap.val() : null;
};

window._currentPlayerId = playerId;

window._sendTradeRequest = async (recipientUsername) => {
  if (!playerId || !currentUsername) return { error: 'Not logged in' };
  const nameSnap = await get(ref(db, 'casino/usernames/' + recipientUsername));
  if (!nameSnap.exists()) return { error: 'Player not found' };
  const recipientUid = nameSnap.val();
  if (recipientUid === playerId) return { error: "Can't trade with yourself" };
  const reqRef = push(ref(db, 'casino/tradeRequests/' + recipientUid));
  await set(reqRef, { from: currentUsername, fromUid: playerId, ts: Date.now() });
  return { success: true, requestId: reqRef.key, recipientUid };
};

window._listenTradeRequestResponse = (recipientUid, requestId, onAccept, onDecline) => {
  const respRef = ref(db, 'casino/tradeRequests/' + recipientUid + '/' + requestId + '/response');
  const unsub = onValue(respRef, (snap) => {
    if (snap.exists()) {
      const resp = snap.val();
      if (resp === 'accepted') onAccept();
      else onDecline();
      unsub();
      remove(ref(db, 'casino/tradeRequests/' + recipientUid + '/' + requestId));
    }
  });
  return unsub;
};

window._loadTradeRequests = async () => {
  if (!playerId) return [];
  const snap = await get(ref(db, 'casino/tradeRequests/' + playerId));
  if (!snap.exists()) return [];
  const reqs = [];
  snap.forEach(child => {
    const d = child.val();
    if (!d.response) reqs.push({ id: child.key, ...d });
  });
  return reqs;
};

window._respondTradeRequest = async (requestId, accepted) => {
  if (!playerId) return;
  await set(ref(db, 'casino/tradeRequests/' + playerId + '/' + requestId + '/response'), accepted ? 'accepted' : 'declined');

  setTimeout(() => { remove(ref(db, 'casino/tradeRequests/' + playerId + '/' + requestId)).catch(()=>{}); }, 10000);
};

window._createLiveTrade = async (partnerUid, partnerName) => {
  if (!playerId || !currentUsername) return null;
  const tradeId = Date.now().toString(36) + Math.random().toString(36).slice(2, 6);
  await set(ref(db, 'casino/liveTrades/' + tradeId), {
    host: playerId,
    hostName: currentUsername,
    guest: partnerUid,
    guestName: partnerName,
    hostOffer: { items: '', cash: 0 },
    guestOffer: { items: '', cash: 0 },
    hostReady: false,
    guestReady: false,
    status: 'active',
    created: Date.now()
  });
  return tradeId;
};

window._executeLiveTrade = async (tradeId) => {
  if (!playerId) return { error: 'Not logged in' };

  if (window._tradeExecuting) return { error: 'Trade already executing' };
  window._tradeExecuting = true;
  try {
  const snap = await get(ref(db, 'casino/liveTrades/' + tradeId));
  if (!snap.exists()) { window._tradeExecuting = false; return { error: 'Trade not found' }; }
  const t = snap.val();
  if (t.status !== 'active') { window._tradeExecuting = false; return { error: 'Trade already completed or cancelled' }; }
  if (!t.hostReady || !t.guestReady) { window._tradeExecuting = false; return { error: 'Both must confirm' }; }

  if (t.host !== playerId) {
    window._tradeExecuting = false;
    return { error: 'Waiting for host to finalize...' };
  }

  await update(ref(db, 'casino/liveTrades/' + tradeId), { status: 'executing' });

  const confirmSnap = await get(ref(db, 'casino/liveTrades/' + tradeId));
  if (!confirmSnap.exists() || confirmSnap.val().status !== 'executing') {
    window._tradeExecuting = false;
    return { error: 'Trade was completed by other player' };
  }

  const hostSnap = await get(ref(db, 'casino/players/' + t.host));
  const guestSnap = await get(ref(db, 'casino/players/' + t.guest));
  if (!hostSnap.exists() || !guestSnap.exists()) return { error: 'Player data missing' };

  const hostData = hostSnap.val();
  const guestData = guestSnap.val();
  const hostBal = safeNum(hostData.balance || 0);
  const guestBal = safeNum(guestData.balance || 0);

  const hostCash = safeNum(t.hostOffer?.cash || 0);
  const guestCash = safeNum(t.guestOffer?.cash || 0);

  if (hostBal < hostCash) return { error: 'Host cannot afford' };
  if (guestBal < guestCash) return { error: 'Guest cannot afford' };

  const updates = {};
  updates['players/' + t.host + '/balance'] = safeNum(hostBal - hostCash + guestCash);
  updates['players/' + t.guest + '/balance'] = safeNum(guestBal - guestCash + hostCash);

  const hostItems = (t.hostOffer?.items || '').split(',').filter(Boolean);
  const guestItems = (t.guestOffer?.items || '').split(',').filter(Boolean);

  for (const itemId of hostItems) {
    const refKey = Date.now().toString(36) + Math.random().toString(36).slice(2,4);
    updates['pendingRefunds/' + t.guest + '/' + refKey] = { item: itemId, cash: 0, reason: 'live_trade', from: t.hostName, ts: Date.now() };
  }
  for (const itemId of guestItems) {
    const refKey = Date.now().toString(36) + Math.random().toString(36).slice(2,4);
    updates['pendingRefunds/' + t.host + '/' + refKey] = { item: itemId, cash: 0, reason: 'live_trade', from: t.guestName, ts: Date.now() };
  }

  updates['liveTrades/' + tradeId + '/status'] = 'completed';

  try {
    await update(ref(db, 'casino'), updates);
    window._tradeExecuting = false;
    return { success: true, tradeId };
  } catch(e) {

    await update(ref(db, 'casino/liveTrades/' + tradeId), { status: 'active' }).catch(()=>{});
    window._tradeExecuting = false;
    return { error: 'Trade failed: ' + e.message };
  }
  } catch(outerErr) {
    window._tradeExecuting = false;
    return { error: 'Trade error: ' + (outerErr.message || 'Unknown') };
  }
};

window._giftMoney = async (recipientUsername, amount) => {
  if (!playerId || !currentUsername) return { error: 'Not logged in' };
  if (!recipientUsername || !amount || amount < 1) return { error: 'Invalid recipient or amount' };
  amount = Math.floor(safeNum(amount));
  if (amount < 1) return { error: 'Invalid amount' };

  const now = Date.now();
  if (window._lastGiftTime && now - window._lastGiftTime < 10000) {
    return { error: 'Gift cooldown! Wait ' + Math.ceil((10000 - (now - window._lastGiftTime)) / 1000) + 's' };
  }
  window._lastGiftTime = now;

  const nameSnap = await window._fbGet('casino/usernames/' + recipientUsername.toLowerCase());
  if (!nameSnap.val()) return { error: 'Player not found' };

  const recipientUid = nameSnap.val();
  if (recipientUid === playerId) return { error: "Can't gift to yourself" };

  const senderSnap = await window._fbGet('casino/players/' + playerId);
  const senderBal = safeNum(senderSnap.val()?.balance || 0);

  if (senderBal < amount) return { error: 'Insufficient balance (server verified: $' + Math.floor(senderBal) + ')' };

  const recipientSnap = await window._fbGet('casino/players/' + recipientUid);
  const recipientBal = recipientSnap.val()?.balance || 0;

  const newSenderBal = safeNum(senderBal - amount);
  const newRecipientBal = safeNum(recipientBal + amount);

  const updates = {};
  updates['players/' + playerId + '/balance'] = newSenderBal;
  updates['players/' + recipientUid + '/balance'] = newRecipientBal;

  try {
    await window._fbUpdate('casino', updates);
    console.log(`Gift sent: ${currentUsername} -> ${recipientUsername}: $${amount}`);
    return { success: true, newBalance: newSenderBal };
  } catch(err) {
    console.error('Gift error:', err);
    return { error: 'Transfer failed' };
  }
};

window._storeListItem = async (listing) => {
  if (!playerId || !currentUsername) return { error: 'Not logged in' };
  if (!listing.price || listing.price < 1) return { error: 'Invalid price' };
  if (!listing.itemId || !listing.itemName) return { error: 'Invalid item' };
  const listRef = push(ref(db, 'casino/store/listings'));
  const data = {
    seller: currentUsername,
    sellerUid: playerId,
    itemId: listing.itemId,
    itemName: listing.itemName,
    rarity: listing.rarity,
    type: listing.type,
    price: listing.price || 0,
    currentBid: listing.type === 'auction' ? (listing.price || 0) : 0,
    highBidder: '',
    highBidderUid: '',
    endsAt: listing.type === 'auction' ? (Date.now() + (listing.duration || 1800000)) : 0,
    listedAt: Date.now(),
    sold: false
  };
  await set(listRef, data);
  return { success: true, listingId: listRef.key };
};

window._storeGetListings = async () => {
  const snap = await get(ref(db, 'casino/store/listings'));
  if (!snap.exists()) return [];
  const arr = [];
  snap.forEach(child => {
    const d = child.val();
    if (!d.sold) arr.push({ id: child.key, ...d });
  });
  return arr;
};

window._storeBuyItem = async (listingId) => {
  if (!playerId || !currentUsername) return { error: 'Not logged in' };
  const listRef = ref(db, 'casino/store/listings/' + listingId);
  try {
    const snap = await get(listRef);
    if (!snap.exists()) return { error: 'Listing not found' };
    const d = snap.val();
    if (d.sold) return { error: 'Already sold' };
    if (d.sellerUid === playerId) return { error: "Can't buy your own item" };
    if (d.type === 'auction') return { error: 'This is an auction — place a bid instead' };

    await update(listRef, { sold: true, buyer: currentUsername, buyerUid: playerId, soldAt: Date.now() });

    if (d.sellerUid && d.price > 0) {
      const payRef = push(ref(db, 'casino/pendingRefunds/' + d.sellerUid));
      await set(payRef, { item: null, cash: d.price, reason: 'store_sale', from: currentUsername, itemName: d.itemName || d.itemId, ts: Date.now() });
    }

    const saleRef = push(ref(db, 'casino/store/sales'));
    await set(saleRef, { itemId: d.itemId, itemName: d.itemName, rarity: d.rarity, price: d.price, seller: d.seller, buyer: currentUsername, ts: Date.now() });
    return { success: true, item: d };
  } catch(e) { return { error: 'Purchase failed: ' + (e.message || 'unknown') }; }
};

window._storePlaceBid = async (listingId, bidAmount) => {
  if (!playerId || !currentUsername) return { error: 'Not logged in' };
  const listRef = ref(db, 'casino/store/listings/' + listingId);
  try {
    const snap = await get(listRef);
    if (!snap.exists()) return { error: 'Listing not found' };
    const d = snap.val();
    if (d.sold) return { error: 'Already sold' };
    if (d.sellerUid === playerId) return { error: "Can't bid on your own item" };
    if (d.type !== 'auction') return { error: 'Not an auction' };
    if (Date.now() > d.endsAt) return { error: 'Auction ended' };
    if (bidAmount <= (d.currentBid || 0)) return { error: 'Bid must be higher than $' + (d.currentBid || 0) + ' (someone outbid you)' };
    const oldBidderUid = d.highBidderUid || '';
    const oldBidAmount = d.currentBid || 0;
    const itemNameForRefund = d.itemName || d.itemId;

    await update(listRef, { currentBid: bidAmount, highBidder: currentUsername, highBidderUid: playerId });

    if (oldBidderUid && oldBidAmount > 0 && oldBidderUid !== playerId) {
      const refundRef = push(ref(db, 'casino/pendingRefunds/' + oldBidderUid));
      await set(refundRef, { item: null, cash: oldBidAmount, reason: 'outbid', from: currentUsername, itemName: itemNameForRefund, ts: Date.now() });
    }
    return { success: true, oldBidderUid: oldBidderUid, oldBid: oldBidAmount };
  } catch(e) { return { error: 'Bid failed: ' + (e.message || 'unknown') }; }
};

window._storeCancelListing = async (listingId) => {
  if (!playerId) return { error: 'Not logged in' };
  const listRef = ref(db, 'casino/store/listings/' + listingId);
  try {
    const snap = await get(listRef);
    if (!snap.exists()) return { error: 'Listing not found' };
    const d = snap.val();
    if (d.sellerUid !== playerId) return { error: 'Not your listing' };
    if (d.sold) return { error: 'Already sold' };

    if (d.type === 'auction' && d.highBidderUid && d.currentBid > 0) {
      const refundRef = push(ref(db, 'casino/pendingRefunds/' + d.highBidderUid));
      await set(refundRef, { item: null, cash: d.currentBid, reason: 'listing_cancelled', from: d.seller, itemName: d.itemName || d.itemId, ts: Date.now() });
    }

    await remove(listRef);
    return { success: true, item: d };
  } catch(e) { return { error: 'Cancel failed: ' + (e.message || 'unknown') }; }
};

window._storeGetSales = async () => {
  const snap = await get(ref(db, 'casino/store/sales'));
  if (!snap.exists()) return [];
  const arr = [];
  snap.forEach(child => { arr.push({ id: child.key, ...child.val() }); });
  arr.sort((a, b) => b.ts - a.ts);
  return arr.slice(0, 50);
};

window._storeClaimAuction = async (listingId) => {
  if (!playerId) return { error: 'Not logged in' };
  const listRef = ref(db, 'casino/store/listings/' + listingId);
  try {
    const snap = await get(listRef);
    if (!snap.exists()) return { error: 'Listing not found' };
    const d = snap.val();
    if (d.sold) return { error: 'Already claimed' };
    if (Date.now() < d.endsAt) return { error: 'Auction not ended yet' };

    if (!d.highBidderUid) {
      if (d.sellerUid !== playerId) return { error: 'Only the seller can reclaim unsold items' };
      await remove(listRef);
      return { success: true, noBids: true, item: d };
    }

    if (d.sellerUid !== playerId && d.highBidderUid !== playerId) return { error: 'Only the seller or winner can claim' };
    await update(listRef, { sold: true, buyer: d.highBidder, buyerUid: d.highBidderUid, soldAt: Date.now() });

    if (d.sellerUid && d.currentBid > 0) {
      const payRef = push(ref(db, 'casino/pendingRefunds/' + d.sellerUid));
      await set(payRef, { item: null, cash: d.currentBid, reason: 'auction_sold', from: d.highBidder, itemName: d.itemName || d.itemId, ts: Date.now() });
    }

    if (d.highBidderUid) {
      const itemRef = push(ref(db, 'casino/pendingRefunds/' + d.highBidderUid));
      await set(itemRef, { item: d.itemId, cash: 0, reason: 'auction_won', from: d.seller, itemName: d.itemName || d.itemId, ts: Date.now() });
    }
    const saleRef = push(ref(db, 'casino/store/sales'));
    await set(saleRef, { itemId: d.itemId, itemName: d.itemName, rarity: d.rarity, price: d.currentBid, seller: d.seller, buyer: d.highBidder, ts: Date.now(), auction: true });
    return { success: true, item: d };
  } catch(e) { return { error: 'Claim failed: ' + (e.message || 'unknown') }; }
};

window._setOnlineStatus = (online) => {
  if (!playerId) return;
  set(ref(db, 'casino/presence/' + playerId), { online, username: currentUsername, lastSeen: Date.now() });
};

window._sendFriendRequest = async (targetUsername) => {
  if (!playerId || !currentUsername) return { error: 'Not logged in' };
  const nameSnap = await get(ref(db, 'casino/usernames/' + targetUsername));
  if (!nameSnap.exists()) return { error: 'Player not found' };
  const targetUid = nameSnap.val();
  if (targetUid === playerId) return { error: "Can't add yourself" };

  const blockSnap = await get(ref(db, 'casino/social/' + playerId + '/blocked/' + targetUid));
  if (blockSnap.exists()) return { error: 'You have blocked this player' };
  const blockSnap2 = await get(ref(db, 'casino/social/' + targetUid + '/blocked/' + playerId));
  if (blockSnap2.exists()) return { error: 'This player has blocked you' };

  const frSnap = await get(ref(db, 'casino/social/' + playerId + '/friends/' + targetUid));
  if (frSnap.exists()) return { error: 'Already friends' };

  const pendSnap = await get(ref(db, 'casino/social/' + targetUid + '/requests/' + playerId));
  if (pendSnap.exists()) return { error: 'Request already sent' };

  const privSnap = await get(ref(db, 'casino/social/' + targetUid + '/privacy'));
  const priv = privSnap.exists() ? privSnap.val() : {};
  if (priv.friendRequests === 'nobody') return { error: 'This player is not accepting friend requests' };
  if (priv.friendRequests === 'friends_only') return { error: 'This player only accepts requests from mutual friends' };
  await set(ref(db, 'casino/social/' + targetUid + '/requests/' + playerId), { from: currentUsername, fromUid: playerId, ts: Date.now() });
  return { success: true };
};

window._loadFriendRequests = async () => {
  if (!playerId) return [];
  const snap = await get(ref(db, 'casino/social/' + playerId + '/requests'));
  if (!snap.exists()) return [];
  const arr = [];
  snap.forEach(child => { arr.push({ uid: child.key, ...child.val() }); });
  return arr;
};

window._acceptFriendRequest = async (fromUid, fromUsername) => {
  if (!playerId) return;
  await set(ref(db, 'casino/social/' + playerId + '/friends/' + fromUid), { username: fromUsername, since: Date.now() });
  await set(ref(db, 'casino/social/' + fromUid + '/friends/' + playerId), { username: currentUsername, since: Date.now() });
  await remove(ref(db, 'casino/social/' + playerId + '/requests/' + fromUid));
};

window._declineFriendRequest = async (fromUid) => {
  if (!playerId) return;
  await remove(ref(db, 'casino/social/' + playerId + '/requests/' + fromUid));
};

window._removeFriend = async (friendUid) => {
  if (!playerId) return;
  await remove(ref(db, 'casino/social/' + playerId + '/friends/' + friendUid));
  await remove(ref(db, 'casino/social/' + friendUid + '/friends/' + playerId));
};

window._blockPlayer = async (targetUsername) => {
  if (!playerId) return { error: 'Not logged in' };
  const nameSnap = await get(ref(db, 'casino/usernames/' + targetUsername));
  if (!nameSnap.exists()) return { error: 'Player not found' };
  const targetUid = nameSnap.val();
  if (targetUid === playerId) return { error: "Can't block yourself" };
  await set(ref(db, 'casino/social/' + playerId + '/blocked/' + targetUid), { username: targetUsername, ts: Date.now() });

  await remove(ref(db, 'casino/social/' + playerId + '/friends/' + targetUid));
  await remove(ref(db, 'casino/social/' + targetUid + '/friends/' + playerId));

  await remove(ref(db, 'casino/social/' + playerId + '/requests/' + targetUid));
  await remove(ref(db, 'casino/social/' + targetUid + '/requests/' + playerId));
  return { success: true };
};

window._unblockPlayer = async (targetUid) => {
  if (!playerId) return;
  await remove(ref(db, 'casino/social/' + playerId + '/blocked/' + targetUid));
};

window._loadFriendsList = async () => {
  if (!playerId) return [];
  const snap = await get(ref(db, 'casino/social/' + playerId + '/friends'));
  if (!snap.exists()) return [];
  const arr = [];
  snap.forEach(child => { arr.push({ uid: child.key, ...child.val() }); });
  return arr;
};

window._loadBlockedList = async () => {
  if (!playerId) return [];
  const snap = await get(ref(db, 'casino/social/' + playerId + '/blocked'));
  if (!snap.exists()) return [];
  const arr = [];
  snap.forEach(child => { arr.push({ uid: child.key, ...child.val() }); });
  return arr;
};

window._getPresence = async (uid) => {
  const snap = await get(ref(db, 'casino/presence/' + uid));
  return snap.exists() ? snap.val() : { online: false, lastSeen: 0 };
};

window._getPresenceBatch = async (uids) => {
  const results = {};
  for (const uid of uids) {
    const snap = await get(ref(db, 'casino/presence/' + uid));
    results[uid] = snap.exists() ? snap.val() : { online: false, lastSeen: 0 };
  }
  return results;
};

window._sendDirectMessage = async (toUid, toUsername, text) => {
  if (!playerId || !currentUsername) return { error: 'Not logged in' };
  const msgData = { from: currentUsername, fromUid: playerId, text, ts: Date.now(), read: false };
  const key1 = playerId < toUid ? playerId + '_' + toUid : toUid + '_' + playerId;
  await push(ref(db, 'casino/dms/' + key1), msgData);
  return { success: true };
};

window._loadDirectMessages = async (otherUid) => {
  if (!playerId) return [];
  const key1 = playerId < otherUid ? playerId + '_' + otherUid : otherUid + '_' + playerId;
  const snap = await get(ref(db, 'casino/dms/' + key1));
  if (!snap.exists()) return [];
  const arr = [];
  snap.forEach(child => { arr.push({ id: child.key, ...child.val() }); });
  arr.sort((a, b) => a.ts - b.ts);
  return arr;
};

window._listenDirectMessages = (otherUid, callback) => {
  const key1 = playerId < otherUid ? playerId + '_' + otherUid : otherUid + '_' + playerId;
  return onValue(ref(db, 'casino/dms/' + key1), (snap) => {
    const arr = [];
    if (snap.exists()) snap.forEach(child => { arr.push({ id: child.key, ...child.val() }); });
    arr.sort((a, b) => a.ts - b.ts);
    callback(arr);
  });
};

window._savePrivacySettings = async (settings) => {
  if (!playerId) return;
  await set(ref(db, 'casino/social/' + playerId + '/privacy'), settings);
};

window._loadPrivacySettings = async () => {
  if (!playerId) return {};
  const snap = await get(ref(db, 'casino/social/' + playerId + '/privacy'));
  return snap.exists() ? snap.val() : {};
};

window._getMutualFriends = async (otherUid) => {
  if (!playerId) return [];
  const mySnap = await get(ref(db, 'casino/social/' + playerId + '/friends'));
  const theirSnap = await get(ref(db, 'casino/social/' + otherUid + '/friends'));
  if (!mySnap.exists() || !theirSnap.exists()) return [];
  const myFriends = new Set();
  mySnap.forEach(c => myFriends.add(c.key));
  const mutual = [];
  theirSnap.forEach(c => { if (myFriends.has(c.key)) mutual.push({ uid: c.key, ...c.val() }); });
  return mutual;
};

window._pylCreateRoom = (roomCode, wager) => {
  const sid = window._currentPylSessionId;
  const name = window._currentUsername || sid.slice(-5);
  const roomRef = ref(db, 'casino/pylRooms/' + roomCode);
  return set(roomRef, {
    host: sid,
    wager: wager,
    status: 'waiting',
    created: Date.now(),
    players: { [sid]: { name: name, score: null, ready: true, online: true } }
  }).then(() => {
    const playerOnlineRef = ref(db, 'casino/pylRooms/' + roomCode + '/players/' + sid + '/online');
    onDisconnect(playerOnlineRef).set(false);
    onDisconnect(roomRef).remove();
  });
};

window._pylPeekRoom = async (roomCode) => {
  const roomRef = ref(db, 'casino/pylRooms/' + roomCode);
  const snap = await get(roomRef);
  if (!snap.exists()) return null;
  const data = snap.val();
  if (data.status !== 'waiting') return null;
  return data;
};

window._pylJoinRoom = async (roomCode) => {
  const sid = window._currentPylSessionId;
  const name = window._currentUsername || sid.slice(-5);
  const roomRef = ref(db, 'casino/pylRooms/' + roomCode);
  const snap = await get(roomRef);
  if (!snap.exists()) return null;
  const data = snap.val();
  if (data.status !== 'waiting') return null;
  if (data.host === sid) return null;
  await update(ref(db, 'casino/pylRooms/' + roomCode + '/players'), {
    [sid]: { name: name, score: null, ready: true, online: true }
  });
  await update(roomRef, { status: 'playing' });
  const playerOnlineRef = ref(db, 'casino/pylRooms/' + roomCode + '/players/' + sid + '/online');
  onDisconnect(playerOnlineRef).set(false);
  onDisconnect(roomRef).cancel();
  return data;
};

window._pylSubmitRoomScore = (roomCode, score) => {
  const sid = window._currentPylSessionId;
  return update(ref(db, 'casino/pylRooms/' + roomCode + '/players/' + sid), { score: score });
};

window._pylListenRoom = (roomCode, callback) => {
  const roomRef = ref(db, 'casino/pylRooms/' + roomCode);
  onValue(roomRef, snap => { callback(snap.val()); });
  return () => off(roomRef);
};

window._pylFinishRoom = (roomCode) => {
  return update(ref(db, 'casino/pylRooms/' + roomCode), { status: 'finished' });
};

window._pylDeleteRoom = (roomCode) => {
  return remove(ref(db, 'casino/pylRooms/' + roomCode));
};

window._pylCancelDisconnect = (roomCode) => {
  const sid = window._currentPylSessionId;
  const playerOnlineRef = ref(db, 'casino/pylRooms/' + roomCode + '/players/' + sid + '/online');
  onDisconnect(playerOnlineRef).cancel();
  const roomRef = ref(db, 'casino/pylRooms/' + roomCode);
  onDisconnect(roomRef).cancel();
};

window._pylMarkOffline = (roomCode) => {
  const sid = window._currentPylSessionId;
  return update(ref(db, 'casino/pylRooms/' + roomCode + '/players/' + sid), { online: false });
};

window._pylWriteChoice = (roomCode, round, choice) => {
  const sid = window._currentPylSessionId;
  return set(ref(db, 'casino/pylRooms/' + roomCode + '/choices/' + round + '/' + sid), choice);
};

let _pylChoiceUnsub = null;
window._pylListenChoice = (roomCode, round, opponentId, callback) => {
  if (_pylChoiceUnsub) { _pylChoiceUnsub(); _pylChoiceUnsub = null; }
  const choiceRef = ref(db, 'casino/pylRooms/' + roomCode + '/choices/' + round + '/' + opponentId);
  onValue(choiceRef, snap => {
    const val = snap.val();
    if (val !== null) {
      callback(val);
      if (_pylChoiceUnsub) { _pylChoiceUnsub(); _pylChoiceUnsub = null; }
    }
  });
  _pylChoiceUnsub = () => off(choiceRef);
};

window._pylGetLeaderboard = async () => {

  const snap = await get(ref(db, 'casino/players'));
  if (!snap.exists()) return [];
  const players = snap.val();
  return Object.entries(players)
    .filter(([uid, p]) => p.username && p.gameStats && p.gameStats.pyl && p.gameStats.pyl.highScore > 0)
    .map(([uid, p]) => ({ player: p.username, score: p.gameStats.pyl.highScore }))
    .sort((a, b) => b.score - a.score)
    .slice(0, 20);
};

window._pylSubmitLeaderboard = (score) => {

  return Promise.resolve();
};

window._fbRef = (path) => ref(db, path);
window._fbSet = (path, data) => {

  if (typeof path === 'string' && /casino\/players\/[^/]+\/balance$/.test(path)) {
    const isStaff = ['mojheh','terpez'].includes((window._currentUsername||'').toLowerCase());
    if (!isStaff) { console.warn('[anti-cheat] Direct balance write blocked'); return Promise.reject(new Error('Blocked')); }
  }

  if (typeof path === 'string' && /casino\/pendingRefunds/.test(path)) {
    if (!window._tradeInProgress && !window._storeInProgress) {
      console.warn('[anti-cheat] Fake pending refund blocked'); return Promise.reject(new Error('Blocked'));
    }
  }

  if (typeof path === 'string' && /casino\/bugReports\//.test(path)) {
    const isTester = ['youguyssuck','mojheh','terpez'].includes((window._currentUsername||'').toLowerCase());
    if (!isTester) { console.warn('[anti-cheat] Bug report write blocked'); return Promise.reject(new Error('Blocked')); }
    return set(ref(db, path), data);
  }

  if (typeof path === 'string' && /casino\/admin\//.test(path)) {
    const isStaff = ['mojheh','terpez','jiddy'].includes((window._currentUsername||'').toLowerCase());
    if (!isStaff) { console.warn('[anti-cheat] Admin write blocked'); return Promise.reject(new Error('Blocked')); }
  }

  if (typeof path === 'string' && /casino\/(bannedUsers|mutedUsers|warnings)/.test(path)) {
    const isStaff = ['mojheh','terpez','jiddy'].includes((window._currentUsername||'').toLowerCase());
    if (!isStaff) { console.warn('[anti-cheat] Mod action blocked'); return Promise.reject(new Error('Blocked')); }
  }
  return set(ref(db, path), data);
};
window._fbGet = (path) => get(ref(db, path));
window._fbUpdate = (path, data) => {
  const isStaff = ['mojheh','terpez','jiddy'].includes((window._currentUsername||'').toLowerCase());
  if (!isStaff && typeof data === 'object' && data !== null && typeof path === 'string') {
    const uid = window._currentPlayerId || '';

    if (path === 'casino') {
      const selfKey = 'players/' + uid + '/balance';
      const balKeys = Object.keys(data).filter(k => /^players\/[^/]+\/balance$/.test(k));
      const otherBalKeys = balKeys.filter(k => k !== selfKey);
      if (otherBalKeys.length > 0 && !balKeys.includes(selfKey)) {
        console.warn('[anti-cheat] Unbalanced cross-player balance write blocked');
        return Promise.reject(new Error('Blocked'));
      }
    }

    const pm = path.match(/^casino\/players\/([^/]+)$/);
    if (pm && pm[1] !== uid && data.balance !== undefined) {
      console.warn('[anti-cheat] Cross-player balance update blocked');
      return Promise.reject(new Error('Blocked'));
    }
  }
  return update(ref(db, path), data);
};
window._fbRemove = (path) => remove(ref(db, path));
window._fbOnValue = (path, cb) => { const r = ref(db, path); onValue(r, cb); return () => off(r); };
window._fbOnValueLimited = (path, limit, cb) => { const r = ref(db, path); const q = fbQuery(r, fbLimitToLast(limit)); onValue(q, cb); return () => off(q); };
window._fbOnDisconnect = (path) => onDisconnect(ref(db, path));

let chatListener = null;
let chatPresenceRef = null;

window._initChat = () => {
  if (chatListener) return;
  const chatRef = ref(db, 'casino/chat');

  const chatQuery = fbQuery(chatRef, fbLimitToLast(60));
  onValue(chatQuery, (snap) => {
    const msgs = [];
    snap.forEach(child => { msgs.push({ id: child.key, ...child.val() }); });
    window._onChatMessages(msgs);
  });
  chatListener = chatQuery;

  if (playerId) {
    chatPresenceRef = ref(db, 'casino/presence/' + playerId);
    set(chatPresenceRef, { online: true, username: currentUsername || 'Guest', lastSeen: Date.now() });
    onDisconnect(chatPresenceRef).set({ online: false, username: currentUsername || 'Guest', lastSeen: Date.now() });

    window._chatPresenceInterval = setInterval(() => {
      if (chatPresenceRef) set(chatPresenceRef, { online: true, username: currentUsername || 'Guest', lastSeen: Date.now() }).catch(()=>{});
    }, 120000);
  }

  async function _pollOnlineCount() {
    try {
      const snap = await get(ref(db, 'casino/presence'));
      let count = 0;
      const now = Date.now();
      snap.forEach(child => {
        const v = child.val();
        if (!v) return;
        const lastActive = v.lastSeen || v.ts || 0;
        if (v.online || (lastActive && (now - lastActive) < 120000)) count++;
      });
      window._onChatOnlineCount(count);
    } catch(e) {}
  }
  _pollOnlineCount();
  window._presenceCountInterval = setInterval(_pollOnlineCount, 30000);
};

window._sendChatMsg = async (text, username, type) => {
  if (!text || text.length === 0) return;
  const chatRef = ref(db, 'casino/chat');
  const msgRef = push(chatRef);
  const uname = (username || 'Guest').toLowerCase();
  let role = '';
  if (uname === 'mojheh') role = 'owner';
  else if (uname === 'terpez') role = 'co-owner';
  else if (uname === 'jiddy') role = 'admin';
  else if (uname === 'youguyssuck') role = 'bugtester';
  await set(msgRef, {
    user: username || 'Guest',
    text: text.slice(0, 200),
    type: type || 'msg',
    uid: playerId || '',
    ts: Date.now(),
    prestige: window._getPrestige ? window._getPrestige() : 0,
    role: role,
    profilePicUrl: window._getProfilePicUrl ? window._getProfilePicUrl() : null
  });

  const snap = await get(chatRef);
  const keys = [];
  snap.forEach(child => keys.push(child.key));
  if (keys.length > 100) {
    const toDelete = keys.slice(0, keys.length - 100);
    const updates = {};
    toDelete.forEach(k => { updates[k] = null; });
    update(chatRef, updates).catch(()=>{});
  }
};

window._broadcastWin = (() => {
  let _lastBroadcastTime = 0;
  return (username, game, amount) => {
    if (!username || amount < 500) return;

    if (username !== (window._currentUsername || '')) return;

    const now = Date.now();
    if (now - _lastBroadcastTime < 15000) return;
    _lastBroadcastTime = now;
    amount = safeNum(amount);
    const text = `${username} just won $${formatBalance(amount)} on ${game}! 🎉`;
    window._sendChatMsg(text, 'System', 'win').catch(()=>{});
  };
})();
</script>

<script>

const MAX_BALANCE = Infinity;
const MIN_BALANCE = 0;
function safeNum(v) {
  if (typeof v !== 'number' || !isFinite(v)) return 0;
  return Math.max(MIN_BALANCE, Math.round(v * 100) / 100);
}
let balance = 1000;

(function(){
  let h = 0, shadow = 1000;
  const bH = v => ((v*7919+13)^0xA5A5)>>>0;
  h = bH(1000);
  let _lastSyncTime = 0;
  let _syncCount = 0;
  let _firstSync = true;

  function mark(){
    if(shadow > 1 && balance > shadow * 1e4 && balance > 1e6){
      console.warn('[anti-cheat] Balance anomaly — reverting');
      balance = shadow;
    }
    h = bH(balance);
    shadow = balance;
  }

  function check(){ return h === bH(balance); }

  function syncFromServer(v){
    v = safeNum(v);
    const now = Date.now();
    if (!_firstSync) {
      if (now - _lastSyncTime < 2000) { console.warn('[anti-cheat] Sync rate limited'); return; }
      _syncCount++;
      if (_syncCount > 200) { console.warn('[anti-cheat] Sync flood blocked'); return; }
    }
    _firstSync = false;
    _lastSyncTime = now;
    shadow = v; balance = v; h = bH(v);
    if(typeof updateBalDisplay==='function')try{updateBalDisplay();}catch(e){}
  }

  Object.defineProperty(window,'_setBalanceInternal',{value:(v)=>{
    balance=safeNum(v); mark(); updateBalDisplay();
  },enumerable:false,configurable:false,writable:false});

  Object.defineProperty(window,'_syncBalFromServer',{value:syncFromServer,
    enumerable:false,configurable:false,writable:false});

  window._balCheck = check;
  window._balGetShadow = function(){ return shadow; };
  Object.defineProperty(window,'_balCheck',{enumerable:false,configurable:false,writable:false});
  Object.defineProperty(window,'_balGetShadow',{enumerable:false,configurable:false,writable:false});

  window._balMarkFn = mark;
  Object.defineProperty(window,'_balMarkFn',{enumerable:false,configurable:false,writable:false});
})();
window.getBalance=()=>balance;
window.setBalance=()=>{console.warn('[anti-cheat] Blocked');};

function _balMark(){ window._balMarkFn(); }

const _NUM_SUFFIXES=[
  {v:1e63,s:'Vg'},{v:1e60,s:'Nod'},{v:1e57,s:'Ocd'},{v:1e54,s:'Spd'},
  {v:1e51,s:'Sxd'},{v:1e48,s:'Qid'},{v:1e45,s:'Qad'},{v:1e42,s:'Td'},
  {v:1e39,s:'Dd'},{v:1e36,s:'Ud'},{v:1e33,s:'Dc'},{v:1e30,s:'No'},
  {v:1e27,s:'Oc'},{v:1e24,s:'Sp'},{v:1e21,s:'Sx'},{v:1e18,s:'Qi'},
  {v:1e15,s:'Q'},{v:1e12,s:'T'},{v:1e9,s:'B'},{v:1e6,s:'M'},{v:1e3,s:'K'}
];
const _PARSE_SUFFIXES={'k':1e3,'m':1e6,'b':1e9,'t':1e12,'q':1e15,'qi':1e18,'sx':1e21,'sp':1e24,'oc':1e27,'no':1e30,'dc':1e33,'ud':1e36,'dd':1e39,'td':1e42,'qad':1e45,'qid':1e48,'sxd':1e51,'spd':1e54,'ocd':1e57,'nod':1e60,'vg':1e63};

function parseBet(str){
  if(typeof str==='number')return safeNum(str);
  if(!str)return 0;
  str=String(str).trim().replace(/[$,\s]/g,'');
  const m=str.match(/^([+-]?\d+\.?\d*)\s*([a-zA-Z]*)\s*$/);
  if(!m)return 0;
  let num=parseFloat(m[1]);
  if(!isFinite(num))return 0;
  const suf=m[2].toLowerCase();
  if(suf&&_PARSE_SUFFIXES[suf])num*=_PARSE_SUFFIXES[suf];
  return safeNum(num);
}
function formatBetInput(v){
  v=safeNum(v);
  const abs=Math.abs(v);
  for(const s of _NUM_SUFFIXES){
    if(abs>=s.v)return (v/s.v).toFixed(abs>=s.v*10?1:2)+s.s.toLowerCase();
  }
  return String(Math.floor(v));
}
function formatBalance(v){
  if(typeof v!=='number'||!isFinite(v))return'$0.00';
  v=safeNum(v);
  const sign=v<0?'-':'';
  const abs=Math.abs(v);
  for(const s of _NUM_SUFFIXES){
    if(abs>=s.v)return sign+'$'+(abs/s.v).toFixed(2)+s.s;
  }
  return (sign?'-':'')+'$'+abs.toFixed(2);
}
function updateBalDisplay(){
  balance=safeNum(balance);
  _balMark();
  const el=document.getElementById('balText');
  el.textContent=formatBalance(balance);
  el.title='$'+balance.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
  el.style.transition='transform .15s';
  el.style.transform='scale(1.15)';
  setTimeout(()=>{el.style.transform='scale(1)';},150);

  if(balance<=0 && !window._pityOffered){
    window._pityOffered=true;

    if(balance<0){ balance=0; _balMark(); }
    setTimeout(()=>{
      if(balance<=0){
        balance+=100;
        updateBalDisplay();
        firebaseSave();
        showToast('💸 Pity bonus! Here\'s $100 to get back on your feet.',true);
      }
      window._pityOffered=false;
    },1500);
  }
}

let _lastAddMoney=0;
let _addMoneySessionTotal=0;
const _ADD_MONEY_SESSION_CAP=5000;
function addMoney(amt){if(amt<=0||amt>1000)return;if(_addMoneySessionTotal>=_ADD_MONEY_SESSION_CAP){showToast('Free money limit reached for this session!',false);return;}if(balance>100){showToast('Pity money is only for broke players!',false);return;}if(Date.now()-_lastAddMoney<10000){showToast('Cooldown! Wait 10s',false);return;}_lastAddMoney=Date.now();const give=Math.min(amt,_ADD_MONEY_SESSION_CAP-_addMoneySessionTotal);balance+=give;_addMoneySessionTotal+=give;updateBalDisplay();firebaseSave();showToast('+$'+give+' (pity money)',true);}
let _fbSaveTimer=null, _fbSaveDirty=false;
function _balIntegrityCheck(){

  if(!window._balCheck()){
    console.warn('[anti-cheat] Balance integrity mismatch — reverting');
    if(window._fbGet && window._currentPlayerId){
      window._fbGet('casino/players/' + window._currentPlayerId).then(snap=>{
        const sv=snap.val();if(sv && typeof sv.balance==='number'){window._syncBalFromServer(safeNum(sv.balance));updateBalDisplay();}
      }).catch(()=>{});
    }
    return false;
  }
  return true;
}
function firebaseSave(){
  if(!_balIntegrityCheck()) return;
  _fbSaveDirty=true;
  if(_fbSaveTimer)return;
  _fbSaveTimer=setTimeout(()=>{
    _fbSaveTimer=null;
    if(_fbSaveDirty && window._firebaseSave){ _fbSaveDirty=false; window._firebaseSave(); }
  },1500);
}
function firebaseSaveNow(){
  if(!_balIntegrityCheck()) return;
  if(_fbSaveTimer){clearTimeout(_fbSaveTimer);_fbSaveTimer=null;}
  _fbSaveDirty=false;
  if(window._firebaseSave) window._firebaseSave();
}

function firebaseSaveBet(betAmt){
  if(!navigator.onLine){
    if(betAmt>0){balance+=betAmt;updateBalDisplay();}
    showToast('You are offline! Bet blocked.',false); return false;
  }
  if(!_balIntegrityCheck()) return false;

  firebaseSaveNow();
  return true;
}

let authIsRegister = false;
let isGuestMode = false;

function authGuestMode() {
  isGuestMode = true;
  let guestId = localStorage.getItem('casino_guest_id');
  if (!guestId) {
    guestId = 'guest_' + Math.random().toString(36).substr(2, 8);
    localStorage.setItem('casino_guest_id', guestId);
  }

  const savedBal = localStorage.getItem('casino_guest_balance');
  if (savedBal != null) { balance = safeNum(parseFloat(savedBal)); _balMark(); }
  const savedStats = localStorage.getItem('casino_guest_stats');
  if (savedStats) try { playerStats = JSON.parse(savedStats); } catch(e) {}
  const savedGameStats = localStorage.getItem('casino_guest_gameStats');
  if (savedGameStats) try { gameStats = JSON.parse(savedGameStats); } catch(e) {}

  window._currentPlayerId = guestId;
  window._currentUsername = 'Guest';
  window._pylPlayerId = guestId;
  window._currentPylSessionId = guestId;

  window._firebaseSave = () => {
    localStorage.setItem('casino_guest_balance', balance.toString());
    localStorage.setItem('casino_guest_stats', JSON.stringify(playerStats));
    localStorage.setItem('casino_guest_gameStats', JSON.stringify(gameStats));
  };

  window._recordGameResult = () => {};
  window._claimDailyBonus = async () => null;
  window._sendChatMsg = async () => {};
  window._broadcastWin = () => {};
  window._updateGlobalMarketItem = async () => {};
  window._initGlobalMarket = () => {};

  window._onAuthReady('Guest', guestId);
}

(function initLoginParticles() {
  const c = document.getElementById('loginParticles');
  if (!c) return;
  for (let i = 0; i < 40; i++) {
    const d = document.createElement('div');
    d.style.left = Math.random() * 100 + '%';
    d.style.animationDuration = (3 + Math.random() * 6) + 's';
    d.style.animationDelay = (Math.random() * 5) + 's';
    d.style.width = d.style.height = (2 + Math.random() * 3) + 'px';
    c.appendChild(d);
  }
})();

function authToggleMode() {
  authIsRegister = !authIsRegister;
  document.getElementById('authSubmitBtn').textContent = authIsRegister ? 'CREATE ACCOUNT' : 'SIGN IN';
  document.getElementById('authToggleBtn').textContent = authIsRegister ? 'BACK TO SIGN IN' : 'CREATE ACCOUNT';
  document.getElementById('authToggleText').innerHTML = authIsRegister
    ? 'Already have an account? <a onclick="authToggleMode()">Sign in</a>'
    : 'Don\'t have an account? <a onclick="authToggleMode()">Sign up</a>';
  document.getElementById('authError').textContent = '';
}

async function authSubmit() {
  const username = document.getElementById('authUsername').value.trim();
  const password = document.getElementById('authPassword').value;
  const errEl = document.getElementById('authError');
  const btn = document.getElementById('authSubmitBtn');
  errEl.textContent = '';
  btn.disabled = true;
  btn.textContent = authIsRegister ? 'CREATING...' : 'SIGNING IN...';
  try {
    await window._authSubmit(username, password, authIsRegister);
  } catch (e) {
    let msg = e.message || 'Unknown error';
    if (msg.includes('auth/email-already-in-use')) msg = 'Username already taken';
    else if (msg.includes('auth/invalid-credential') || msg.includes('auth/wrong-password') || msg.includes('auth/user-not-found')) msg = 'Invalid username or password';
    else if (msg.includes('auth/too-many-requests')) msg = 'Too many attempts. Try again later';
    else if (msg.includes('auth/weak-password')) msg = 'Password must be at least 6 characters';
    errEl.textContent = msg;
  }
  btn.disabled = false;
  btn.textContent = authIsRegister ? 'CREATE ACCOUNT' : 'SIGN IN';
}

function authLogout() {
  firebaseSaveNow();
  isGuestMode = false;
  if (window._authLogout) window._authLogout();
  else window._onAuthLoggedOut();
}

async function checkPendingRefunds() {
  if (!window._checkPendingRefunds) return;
  try {
    const refunds = await window._checkPendingRefunds();
    if (!refunds || refunds.length === 0) return;
    let totalCash = 0;
    let itemsReceived = [];
    refunds.forEach(r => {
      if (r.cash > 0) { balance += r.cash; totalCash += r.cash; }
      if (r.item && r.item !== '_cash_' && r.item !== null) {
        addToInventory(r.item);
        const cat = ITEM_CATALOG[r.item];
        itemsReceived.push(cat ? cat.name : r.itemName || r.item);
      }
    });
    if (totalCash > 0 || itemsReceived.length > 0) {
      updateBalDisplay();
      renderInventory();
      firebaseSave();
      let msg = '📬 ';
      if (totalCash > 0) msg += '+$' + totalCash.toFixed(0);
      if (itemsReceived.length > 0) msg += (totalCash > 0 ? ' + ' : '') + itemsReceived.join(', ');
      const reasons = [...new Set(refunds.map(r => r.reason))];
      if (reasons.includes('trade_declined')) msg += ' (trade returned)';
      else if (reasons.includes('outbid')) msg += ' (outbid refund)';
      else if (reasons.includes('store_sale') || reasons.includes('auction_sold')) msg += ' (sale proceeds)';
      else if (reasons.includes('listing_cancelled')) msg += ' (listing cancelled)';
      else if (reasons.includes('auction_won')) msg += ' (auction won)';
      showToast(msg, true);
    }
  } catch(e) {  }
}

window._onAuthReady = function(username, uid) {
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('topNav').style.display = '';
  const uaInit = (username && username[0] || '?').toUpperCase();
  document.getElementById('userAvatar').innerHTML = `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false"><defs><linearGradient id="avG" x1="0" x2="1"><stop offset="0" stop-color="#00f0ff"/><stop offset="1" stop-color="#6b2fd9"/></linearGradient></defs><circle cx="50" cy="50" r="48" fill="url(#avG)"/><text x="50" y="58" font-family="Orbitron,Inter,sans-serif" font-weight="900" font-size="48" fill="#fff" text-anchor="middle">${uaInit}</text></svg>`;
  document.getElementById('userNameDisplay').textContent = username;

  if (typeof applyPfp === 'function' && selectedPfp) applyPfp();
  updateBalDisplay();
  checkDailyBonus();

  document.getElementById('chatToggleBtn').style.display = 'flex';

  if (!chatInitialized && window._initChat) {
    window._initChat();
    chatInitialized = true;
  }

  checkPendingRefunds();

  if (!window._refundInterval) {
    window._refundInterval = setInterval(checkPendingRefunds, 30000);
  }

  if (typeof rrListenForChallenges === 'function') rrListenForChallenges();

  if (typeof modStartWatchers === 'function') modStartWatchers();
};

window._onAuthLoggedOut = function() {
  if (isGuestMode) return;
  document.getElementById('loginScreen').style.display = '';
  document.getElementById('topNav').style.display = 'none';
  document.querySelectorAll('.game-panel').forEach(p => p.classList.remove('active'));

  if (window._refundInterval) { clearInterval(window._refundInterval); window._refundInterval = null; }
  if (window._onlineStatusInterval) { clearInterval(window._onlineStatusInterval); window._onlineStatusInterval = null; }
  if (window._chatPresenceInterval) { clearInterval(window._chatPresenceInterval); window._chatPresenceInterval = null; }
  if (window._presenceCountInterval) { clearInterval(window._presenceCountInterval); window._presenceCountInterval = null; }
  if (typeof stockTickInterval !== 'undefined' && stockTickInterval) { clearInterval(stockTickInterval); stockTickInterval = null; }

  try {
    if (typeof crashRunning !== 'undefined') crashRunning = false;
    if (typeof bjActive !== 'undefined') bjActive = false;
    if (typeof minesActive !== 'undefined') minesActive = false;
    if (typeof towerActive !== 'undefined') towerActive = false;
    if (typeof hiloActive !== 'undefined') hiloActive = false;
    if (typeof pylGameActive !== 'undefined') pylGameActive = false;
    if (typeof autoDropping !== 'undefined') autoDropping = false;
    if (typeof rouletteSpinning !== 'undefined') rouletteSpinning = false;
    if (typeof limboRolling !== 'undefined') limboRolling = false;
    if (typeof pokerPhase !== 'undefined') pokerPhase = 'idle';

    if (typeof balance !== 'undefined') balance = 1000;
    if (typeof inventory !== 'undefined') inventory = [];
    if (typeof tradeHistory !== 'undefined') tradeHistory = [];
    if (typeof chatInitialized !== 'undefined') chatInitialized = false;
    updateBalDisplay();
  } catch(e) {}
};

document.getElementById('authPassword').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') authSubmit();
});
document.getElementById('authUsername').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') document.getElementById('authPassword').focus();
});

let playerStats = { totalWagered: 0, totalWon: 0, totalProfit: 0, gamesPlayed: 0, biggestWin: 0 };
let gameStats = {
  slots: { played: 0, won: 0, biggestWin: 0 },
  crash: { played: 0, won: 0, biggestMultiplier: 0, biggestWin: 0 },
  roulette: { played: 0, won: 0, biggestWin: 0 },
  cases: { played: 0, opened: 0, bestItem: '' },
  plinko: { played: 0, won: 0, biggestWin: 0 },
  pyl: { played: 0, highScore: 0 },
  blackjack: { played: 0, won: 0, biggestWin: 0 },
  mines: { played: 0, won: 0, biggestWin: 0 },
  dice: { played: 0, won: 0, biggestWin: 0 },
  tower: { played: 0, won: 0, biggestWin: 0 },
  coinflip: { played: 0, won: 0, biggestWin: 0 },
  keno: { played: 0, won: 0, biggestWin: 0 },
  limbo: { played: 0, won: 0, biggestWin: 0 },
  poker: { played: 0, won: 0, biggestWin: 0 },
  horses: { played: 0, won: 0, biggestWin: 0 },
  scratch: { played: 0, won: 0, biggestWin: 0 },
  wheel: { played: 0, won: 0, biggestWin: 0 },
  baccarat: { played: 0, won: 0, biggestWin: 0 },
  hilo: { played: 0, won: 0, biggestWin: 0 },
  duels: { played: 0, won: 0, biggestWin: 0 },
  rusroulette: { played: 0, won: 0, biggestWin: 0 },
  mpbsr: { played: 0, won: 0, biggestWin: 0 },
  russianr: { played: 0, won: 0, biggestWin: 0 }
};
let dailyBonusData = { lastClaimed: 0, streak: 0 };

function checkMaxBet(bet, game) {
  if (!navigator.onLine) { showToast('You are offline! Connect to the internet to play.', false); return false; }
  if (bet > balance) { showToast('Max bet is your balance: $' + Math.floor(balance).toLocaleString(), false); return false; }
  return true;
}

window._loadStats = (s) => { if (s) { Object.keys(s).forEach(k => { if(typeof s[k]==='number') s[k]=safeNum(s[k]); }); playerStats = { ...playerStats, ...s }; } };
window._loadGameStats = (gs) => { if (!gs) return; Object.keys(gs).forEach(g => { gameStats[g] = { ...(gameStats[g]||{}), ...gs[g] }; }); };
window._loadDailyBonus = (db) => { if (db) dailyBonusData = { ...dailyBonusData, ...db }; checkDailyBonus(); };
window._getStats = () => playerStats;
window._getGameStats = () => gameStats;
window._getDailyBonus = () => dailyBonusData;

function recordGame(game, wagered, won) {
  wagered = safeNum(wagered); won = safeNum(won);
  const profit = won - wagered;
  playerStats.totalWagered = safeNum(playerStats.totalWagered + wagered);
  playerStats.totalWon = safeNum(playerStats.totalWon + won);
  playerStats.totalProfit = safeNum(playerStats.totalProfit + profit);
  playerStats.gamesPlayed++;
  if (won > playerStats.biggestWin) playerStats.biggestWin = won;
  if (gameStats[game]) {
    gameStats[game].played = (gameStats[game].played || 0) + 1;
    if (won > wagered) gameStats[game].won = (gameStats[game].won || 0) + 1;
    if (won > (gameStats[game].biggestWin || 0)) gameStats[game].biggestWin = won;
  }
  if (window._recordGameResult) window._recordGameResult(game, wagered, won);
  firebaseSave();

  checkCasinoAchievements(game, wagered, won);
}

function addResultDot(containerId,label,isWin){
  const c=document.getElementById(containerId);if(!c)return;
  const dot=document.createElement('span');dot.className='result-dot';
  dot.style.background=isWin?'var(--green)':'var(--red)';dot.textContent=label;
  c.appendChild(dot);if(c.children.length>20)c.removeChild(c.firstChild);
}

function checkDailyBonus() {
  const btn = document.getElementById('dailyBonusBtn');
  if (!btn) return;
  const lastDate = new Date(dailyBonusData.lastClaimed).toDateString();
  const todayDate = new Date().toDateString();
  if (lastDate === todayDate) {
    btn.disabled = true;
    btn.textContent = '✓ CLAIMED';
  } else {
    btn.disabled = false;
    btn.textContent = '🎁 DAILY';
  }
}

async function claimDailyBonus() {
  const btn = document.getElementById('dailyBonusBtn');
  btn.disabled = true;
  btn.textContent = '...';
  try {
    const result = await window._claimDailyBonus();
    if (result) {
      balance = safeNum(balance + result.amount); updateBalDisplay(); firebaseSave();
      dailyBonusData.lastClaimed = Date.now();
      dailyBonusData.streak = result.streak;
      showToast('🎁 Daily Bonus: $' + result.amount + ' (Day ' + result.streak + ' streak!)', true);
      btn.textContent = '✓ CLAIMED';
    } else {
      showToast('Already claimed today!', false);
      btn.textContent = '✓ CLAIMED';
    }
  } catch (e) {
    btn.disabled = false;
    btn.textContent = '🎁 DAILY';
    showToast('Error claiming bonus', false);
  }
}

let currentLBCategory = 'richest';
let lbAutoInterval = null;

function switchLB(category, btn) {
  currentLBCategory = category;
  document.querySelectorAll('.lb-tab').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  loadLeaderboard(category);

  startLBAutoRefresh();
}

function startLBAutoRefresh() {
  if (lbAutoInterval) clearInterval(lbAutoInterval);
  lbAutoInterval = setInterval(() => {
    const lbPanel = document.getElementById('leaderboardPanel');
    if (lbPanel && lbPanel.classList.contains('active')) {
      loadLeaderboard(currentLBCategory);
    } else {
      clearInterval(lbAutoInterval);
      lbAutoInterval = null;
    }
  }, 15000);
}

async function loadLeaderboard(category) {
  const container = document.getElementById('lbTable');
  container.innerHTML = '<div class="lb-empty">Loading...</div>';

  if (!window._getLeaderboard) {
    container.innerHTML = '<div class="lb-empty">Not connected</div>';
    return;
  }

  try {
    let entries = await window._getLeaderboard(category);
    entries = entries.filter(e => e.name && e.name.toLowerCase() !== 'progambler');
    if (entries.length === 0) {
      container.innerHTML = '<div class="lb-empty">No entries yet. Start playing to get on the board!</div>';
      return;
    }
const myId = window._currentPlayerId || '';
const fmtBig = (v) => {
      const abs = Math.abs(v);
      for(const s of _NUM_SUFFIXES){ if(abs>=s.v) return '$'+(v/s.v).toFixed(2)+s.s; }
      return '$' + v.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
    };
    const fmtProfit = (v) => {
      const sign = v >= 0 ? '+' : '-';
      const abs = Math.abs(v);
      for(const s of _NUM_SUFFIXES){ if(abs>=s.v) return sign+'$'+(abs/s.v).toFixed(2)+s.s; }
      return (v >= 0 ? '+$' : '-$') + abs.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
    };
    const labels = {
      richest: { col: 'Balance', fmt: fmtBig },
      slots: { col: 'Biggest Win', fmt: fmtBig },
      crash: { col: 'Biggest Win', fmt: fmtBig },
      roulette: { col: 'Biggest Win', fmt: fmtBig },
      blackjack: { col: 'Biggest Win', fmt: fmtBig },
      cases: { col: 'Biggest Win', fmt: fmtBig },
      plinko: { col: 'Biggest Win', fmt: fmtBig },
      mines: { col: 'Biggest Win', fmt: fmtBig },
      dice: { col: 'Biggest Win', fmt: fmtBig },
      tower: { col: 'Biggest Win', fmt: fmtBig },
      coinflip: { col: 'Biggest Win', fmt: fmtBig },
      keno: { col: 'Biggest Win', fmt: fmtBig },
      limbo: { col: 'Biggest Win', fmt: fmtBig },
      poker: { col: 'Biggest Win', fmt: fmtBig },
      horses: { col: 'Biggest Win', fmt: fmtBig },
      scratch: { col: 'Biggest Win', fmt: fmtBig },
      wheel: { col: 'Biggest Win', fmt: fmtBig },
      baccarat: { col: 'Biggest Win', fmt: fmtBig },
      hilo: { col: 'Biggest Win', fmt: fmtBig },
      pyl: { col: 'High Score', fmt: v => v.toLocaleString() + ' pts' },
      profit: { col: 'Total Profit', fmt: fmtProfit },
      duels: { col: 'Biggest Win', fmt: fmtBig },
      prestige: { col: 'Prestige Level', fmt: v => '👑 ' + v },
    };
    const cfg = labels[category] || labels.richest;

    container.innerHTML = entries.map((e, i) => {
      const medal = i === 0 ? '🥇' : i === 1 ? '🥈' : i === 2 ? '🥉' : (i + 1) + '.';
      const isMe = e.uid === myId;
      return '<div class="lb-data-row' + (isMe ? ' me' : '') + '">' +
        '<span class="lb-col-rank">' + medal + '</span>' +
        '<span class="lb-col-name">' + escapeHtml(e.name) + (isMe ? ' (you)' : '') + '</span>' +
        '<span class="lb-col-val">' + cfg.fmt(e.value) + '</span>' +
        '</div>';
    }).join('');
  } catch (e) {
    container.innerHTML = '<div class="lb-empty">Error loading leaderboard</div>';
  }
}

let navCatCloseTimer = null;
function openCat(el){
  if(navCatCloseTimer) { clearTimeout(navCatCloseTimer); navCatCloseTimer = null; }
  document.querySelectorAll('.nav-cat').forEach(c=>{if(c!==el)c.classList.remove('open');});
  el.classList.add('open');
}
function closeCat(el){
  navCatCloseTimer = setTimeout(()=>{
    el.classList.remove('open');
    navCatCloseTimer = null;
  }, 120);
}

function toggleCat(el){el.classList.toggle('open');document.querySelectorAll('.nav-cat').forEach(c=>{if(c!==el)c.classList.remove('open');});}

document.addEventListener('click',function(e){if(!e.target.closest('.nav-cat'))document.querySelectorAll('.nav-cat').forEach(c=>c.classList.remove('open'));});
document.addEventListener('touchstart',function(e){if(!e.target.closest('.nav-cat'))document.querySelectorAll('.nav-cat').forEach(c=>c.classList.remove('open'));},{passive:true});

const gamesData = [
  { cat: '🔥 NEW', games: [
    { name: 'Cup Shuffle', icon: '🏆', id: 'cups' }
  ]},
  { cat: '⭐ Classic', games: [
    { name: 'Plinko', icon: '⚡', id: 'plinko' },
    { name: 'Crash', icon: '📈', id: 'crash' },
    { name: 'Slots', icon: '🎰', id: 'slots' },
    { name: 'Mines', icon: '💣', id: 'mines' },
    { name: 'Roulette', icon: '🎡', id: 'roulette' }
  ]},
  { cat: '🃏 Card Games', games: [
    { name: 'Blackjack', icon: '🃏', id: 'blackjack' },
    { name: 'Video Poker', icon: '♠️', id: 'poker' },
    { name: 'Baccarat', icon: '🎴', id: 'baccarat' },
    { name: 'Hi-Lo', icon: '↕️', id: 'hilo' }
  ]},
  { cat: '🎡 Table Games', games: [
    { name: 'Wheel', icon: '💫', id: 'wheel' },
    { name: 'Keno', icon: '🔢', id: 'keno' },
    { name: 'Horse Racing', icon: '🏇', id: 'horses' },
    { name: 'Buckshot Roulette', icon: '🔫', id: 'rusroulette' },
    { name: 'MP Buckshot', icon: '💥', id: 'mpbsr' },
    { name: 'Russian Roulette', icon: '🎰', id: 'russianr' }
  ]},
  { cat: '⚡ Quick & Special', games: [
    { name: 'Dice', icon: '🎯', id: 'dice' },
    { name: 'Tower', icon: '🗼', id: 'tower' },
    { name: 'Scratch Cards', icon: '🎫', id: 'scratch' },
    { name: 'Limbo', icon: '🚀', id: 'limbo' },
    { name: 'Coin Flip', icon: '🪙', id: 'coinflip' },
    { name: 'Push Your Luck', icon: '🎲', id: 'luck' },
    { name: 'Cases', icon: '📦', id: 'cases' }
  ]},
  { cat: '💎 Pro Games', games: [
    { name: 'Stocks', icon: '📊', id: 'stocks' },
    { name: 'Crypto', icon: '₿', id: 'crypto' },
    { name: 'Duels', icon: '⚔️', id: 'duels' }
  ]}
];

function openGamesMenu(){
  const overlay = document.getElementById('gamesMenuOverlay');
  overlay.style.display = 'block';
  const container = document.getElementById('gamesCategoriesContainer');
  container.innerHTML = gamesData.map((cat, i) => {
    const games = cat.games.map(g => {
      return `<button class="game-btn" onclick="switchGame('${g.id}',this);closeGamesMenu();" style="border-color:var(--green);"><span class="game-icon">${g.icon}</span><div>${g.name}</div></button>`;
    }).join('');
    return `<div class="games-category"><div class="games-category-title"><span>${cat.cat}</span></div><div class="games-grid">${games}</div></div>`;
  }).join('');
  setTimeout(() => overlay.style.opacity = '1', 10);
}

function closeGamesMenu(){
  const overlay = document.getElementById('gamesMenuOverlay');
  overlay.style.display = 'none';
}

document.getElementById('gamesMenuOverlay')?.addEventListener('click', (e) => {
  if(e.target.id === 'gamesMenuOverlay') closeGamesMenu();
});

function htpToggle(el){el.closest('.htp-box').classList.toggle('open');}
function showToast(msg,isWin=true){
  const t=document.getElementById('winToast');
  t.textContent=msg;t.className='win-toast'+(isWin?'':' loss');
  setTimeout(()=>t.classList.add('show'),10);
  setTimeout(()=>t.classList.remove('show'),2500);
}

function showBigWin(amount) {
  if (amount < 500) return;

  const intensity = Math.min(amount / 1000, 8);
  document.body.style.animation = `screenShake ${0.3 + Math.min(amount/5000, 0.4)}s ease-out`;
  setTimeout(() => { document.body.style.animation = ''; }, 800);

  if (amount >= 2000) {
    const overlay = document.createElement('div');
    overlay.style.cssText = `position:fixed;top:0;left:0;right:0;bottom:0;z-index:999999;display:flex;flex-direction:column;align-items:center;justify-content:center;
      background:radial-gradient(circle,rgba(255,215,0,0.15),rgba(0,0,0,0.85));pointer-events:none;animation:fadeInOut 2.5s ease forwards;`;

    const tier = amount >= 50000 ? {label:'MEGA WIN',color:'#ff00e5',glow:'rgba(255,0,229,0.6)',icon:'👑'}
      : amount >= 10000 ? {label:'HUGE WIN',color:'#ffd700',glow:'rgba(255,215,0,0.6)',icon:'💎'}
      : amount >= 5000 ? {label:'BIG WIN',color:'#00f0ff',glow:'rgba(0,240,255,0.6)',icon:'🔥'}
      : {label:'NICE WIN',color:'#00ff88',glow:'rgba(0,255,136,0.5)',icon:'✨'};

    overlay.innerHTML = `
      <div style="font-size:60px;animation:bigWinBounce 0.6s ease-out;">${tier.icon}</div>
      <div style="font-family:'Orbitron';font-weight:900;font-size:${amount>=10000?'48':'36'}px;color:${tier.color};
        text-shadow:0 0 30px ${tier.glow},0 0 60px ${tier.glow};animation:bigWinBounce 0.6s ease-out 0.1s both;">${tier.label}</div>
      <div style="font-family:'Orbitron';font-weight:700;font-size:28px;color:#fff;margin-top:8px;
        animation:bigWinBounce 0.6s ease-out 0.2s both;">+$${amount.toFixed(2)}</div>
    `;
    document.body.appendChild(overlay);

    for (let i = 0; i < 5; i++) {
      setTimeout(() => spawnParticles(
        Math.random() * window.innerWidth,
        Math.random() * window.innerHeight,
        20 + Math.min(amount / 500, 40)
      ), i * 150);
    }

    setTimeout(() => { if (overlay.parentNode) overlay.parentNode.removeChild(overlay); }, 2600);
  }
}

function _getActiveGames(){
  const ag = [];
  if(typeof bjActive !== 'undefined' && bjActive) ag.push('Blackjack');
  if(typeof minesActive !== 'undefined' && minesActive) ag.push('Mines');
  if(typeof towerActive !== 'undefined' && towerActive) ag.push('Tower');
  if(typeof hiloActive !== 'undefined' && hiloActive) ag.push('Hi-Lo');
  if(typeof crashRunning !== 'undefined' && crashRunning && !crashCashedOut) ag.push('Crash');
  if(typeof bsrState !== 'undefined' && bsrState && bsrState.active) ag.push('Buckshot Roulette');
  if(typeof rrState !== 'undefined' && rrState && !rrState.gameOver) ag.push('Russian Roulette');
  if(typeof _cups !== 'undefined' && _cups && _cups.active) ag.push('Cup Shuffle');
  if(typeof pylGameActive !== 'undefined' && pylGameActive) ag.push('Push Your Luck');
  if(typeof pylWagerEscrowed !== 'undefined' && pylWagerEscrowed) ag.push('Push Your Luck (Escrowed)');
  if(typeof currentDuelRoom !== 'undefined' && currentDuelRoom) ag.push('Duels');
  if(typeof _liveTradeId !== 'undefined' && _liveTradeId) ag.push('Trading');

  if(typeof slotsSpinning !== 'undefined' && slotsSpinning) ag.push('Slots');
  if(typeof rouletteSpinning !== 'undefined' && rouletteSpinning) ag.push('Roulette');
  if(typeof coinFlipping !== 'undefined' && coinFlipping) ag.push('Coinflip');
  if(typeof diceRolling !== 'undefined' && diceRolling) ag.push('Dice');
  if(typeof limboRolling !== 'undefined' && limboRolling) ag.push('Limbo');
  if(typeof kenoPlaying !== 'undefined' && kenoPlaying) ag.push('Keno');
  if(typeof wheelSpinning !== 'undefined' && wheelSpinning) ag.push('Wheel');
  if(typeof scratchActive !== 'undefined' && scratchActive) ag.push('Scratch');
  if(typeof hrRacing !== 'undefined' && hrRacing) ag.push('Horses');
  if(typeof pokerPhase !== 'undefined' && pokerPhase !== 'idle') ag.push('Poker');
  if(typeof caseOpening !== 'undefined' && caseOpening) ag.push('Cases');
  if(typeof plinkoBallBets !== 'undefined' && Object.keys(plinkoBallBets).length > 0) ag.push('Plinko');
  return ag;
}
function _anyGameActive(){ return _getActiveGames().length > 0; }

function switchGame(game,btn){

  const activeGames = _getActiveGames();
  if(activeGames.length > 0) {
    showToast('Finish your ' + activeGames[0] + ' game first!', false);
    return;
  }
  document.querySelectorAll('.game-panel').forEach(p=>p.classList.remove('active'));
  const targetPanel = document.getElementById(game+'Panel');
  if(targetPanel) targetPanel.classList.add('active'); else return;

  const catalog = document.getElementById('gameCatalog'); if(catalog) catalog.style.display = 'none';
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  if(btn)btn.classList.add('active');
  if(game==='plinko'&&!plinkoInitialized)initPlinko();
  if(game==='roulette'&&!rouletteDrawn)drawRouletteWheel(0);
  if(game==='crash')resizeCrashCanvas();
  if(game==='profile')renderProfile();
  if(game==='stocks')renderStocks();
  if(game==='leaderboard'){loadLeaderboard(currentLBCategory);startLBAutoRefresh();}
  else if(lbAutoInterval){clearInterval(lbAutoInterval);lbAutoInterval=null;}
  if(game==='duels')duelLoadLobby();
  if(game==='wheel'&&!wheelDrawn)drawWheel(0);
  if(game==='keno')kenoInit();
  if(game==='horses')horseInit();
  if(game==='mines')minesRenderGrid();
  if(game==='dice')diceUpdateSlider();
  if(game==='rusroulette')initBuckshotRoulette();
  if(game==='mpbsr')initMPBSR();
  if(game==='russianr')initRussianRoulette();
  if(game==='crypto')initCrypto();
  if(game==='cups')cupsInit();
  if(game==='luck'){
    let iframe=document.getElementById('pylIframe');
    if(!iframe){

      iframe=document.createElement('iframe');
      iframe.id='pylIframe';
      iframe.allow='autoplay';
      document.getElementById('luckPanel').insertBefore(iframe,document.getElementById('luckPanel').firstChild);
    }
    if(!iframe.src||!iframe.src.includes('push-your-luck')){

      setTimeout(()=>{ iframe.src='push-your-luck/index.html'; }, 300);
    }
    pylLoadLeaderboard();
  }

}

function adjustBet(id,mult){
  const el=document.getElementById(id);
  let v=Math.max(1,Math.round(parseBet(el.value||'10')*mult));
  if(v>balance)v=Math.floor(balance);
  el.value=formatBetInput(v);
}
function betAll(id){
  const el=document.getElementById(id);
  el.value=formatBetInput(Math.max(1,Math.floor(balance)));
  playClickSound();
}

const pCanvas=document.getElementById('particles');
const pCtx=pCanvas.getContext('2d');
let particles=[];
function resizeParticles(){pCanvas.width=window.innerWidth;pCanvas.height=window.innerHeight;}
resizeParticles();window.addEventListener('resize',resizeParticles);

function spawnParticles(x,y,count=30,colors=['#ffd700','#ff8800','#00f0ff','#ff00e5','#00ff88']){

  const MAX_PARTICLES = 200;
  if(particles.length >= MAX_PARTICLES) return;
  count = Math.min(count, MAX_PARTICLES - particles.length);
  for(let i=0;i<count;i++){
    const angle=Math.random()*Math.PI*2;
    const speed=Math.random()*10+3;
    particles.push({x,y,vx:Math.cos(angle)*speed,vy:Math.sin(angle)*speed-3,
      life:1,decay:Math.random()*.015+.008,size:Math.random()*5+2,
      color:colors[Math.floor(Math.random()*colors.length)]});
  }

  if(particles.length===count) requestAnimationFrame(updateParticles);
}
function updateParticles(){
  pCtx.clearRect(0,0,pCanvas.width,pCanvas.height);
  particles=particles.filter(p=>{
    p.x+=p.vx;p.y+=p.vy;p.vy+=.12;p.life-=p.decay;p.vx*=.99;
    if(p.life<=0)return false;
    pCtx.globalAlpha=p.life;pCtx.fillStyle=p.color;
    pCtx.shadowColor=p.color;pCtx.shadowBlur=p.size*2;
    pCtx.beginPath();pCtx.arc(p.x,p.y,p.size*p.life,0,Math.PI*2);pCtx.fill();
    return true;
  });
  pCtx.globalAlpha=1;pCtx.shadowBlur=0;
  if(particles.length>0)requestAnimationFrame(updateParticles);
}
updateParticles();

let soundMuted = false;
function toggleMute() {
  soundMuted = !soundMuted;
  const btn = document.getElementById('muteBtn');
  if (btn) btn.textContent = soundMuted ? '🔇' : '🔊';
}
let audioCtx=null;
function ensureAudioCtx(){if(!audioCtx){audioCtx=new(window.AudioContext||window.webkitAudioContext)();}if(audioCtx.state==='suspended')audioCtx.resume();return audioCtx;}
document.addEventListener('click',ensureAudioCtx,{once:true});
document.addEventListener('keydown',ensureAudioCtx,{once:true});
function playSound(freq,type='sine',dur=0.15,vol=0.1){
  try{
    if(!audioCtx)return;
    const o=audioCtx.createOscillator();const g=audioCtx.createGain();
    o.connect(g);g.connect(audioCtx.destination);o.type=type;o.frequency.value=freq;
    g.gain.setValueAtTime(vol,audioCtx.currentTime);g.gain.exponentialRampToValueAtTime(.001,audioCtx.currentTime+dur);
    o.start();o.stop(audioCtx.currentTime+dur);
  }catch(e){}
}
function playWinSound(){playSound(523,'sine',.1,.12);setTimeout(()=>playSound(659,'sine',.1,.12),80);
  setTimeout(()=>playSound(784,'sine',.15,.12),160);setTimeout(()=>playSound(1047,'sine',.25,.1),240);}
function playLoseSound(){playSound(200,'sawtooth',.25,.06);setTimeout(()=>playSound(150,'sawtooth',.3,.05),100);}
function playClickSound(){playSound(800,'sine',.04,.06);}
let _achievementsCache = {};

try { _achievementsCache = JSON.parse(localStorage.getItem('casino_achievements') || '{}'); } catch(e) { _achievementsCache = {}; }

function getCasinoAch() {
  return _achievementsCache;
}
function saveCasinoAch(id) {
  if (_achievementsCache[id]) return false;
  _achievementsCache[id] = Date.now();

  try { localStorage.setItem('casino_achievements', JSON.stringify(_achievementsCache)); } catch(e) {}

  return true;
}

window._getAchievements = () => _achievementsCache;
window._loadAchievements = (data) => {
  if (data && typeof data === 'object') {

    Object.keys(data).forEach(k => {
      if (!_achievementsCache[k]) _achievementsCache[k] = data[k];
    });
    try { localStorage.setItem('casino_achievements', JSON.stringify(_achievementsCache)); } catch(e) {}
  }
};

const _origPlaySound = playSound;
playSound = function(freq, type, dur, vol) {
  if (soundMuted) return;
  _origPlaySound(freq, type, dur, vol);
};

const CASINO_ACHIEVEMENTS = [
  { id:'first_game', icon:'🎮', name:'FIRST SPIN', desc:'Play your first game' },
  { id:'first_win', icon:'🏆', name:'WINNER', desc:'Win your first bet' },
  { id:'high_roller', icon:'💰', name:'HIGH ROLLER', desc:'Wager $10,000 total' },
  { id:'whale', icon:'🐋', name:'WHALE', desc:'Wager $100,000 total' },
  { id:'big_win', icon:'💎', name:'BIG WIN', desc:'Win $5,000+ in a single bet' },
  { id:'mega_win', icon:'👑', name:'MEGA WIN', desc:'Win $50,000+ in a single bet' },
  { id:'broke', icon:'📉', name:'ROCK BOTTOM', desc:'Lose all your money (balance $0)' },
  { id:'comeback', icon:'🔥', name:'COMEBACK KID', desc:'Go from under $100 to over $10,000' },
  { id:'games_50', icon:'⭐', name:'REGULAR', desc:'Play 50 games' },
  { id:'games_500', icon:'🌟', name:'VETERAN', desc:'Play 500 games' },
  { id:'games_5000', icon:'✨', name:'LEGEND', desc:'Play 5,000 games' },
  { id:'slots_pro', icon:'🎰', name:'SLOTS PRO', desc:'Win 50 times at Slots' },
  { id:'crash_pro', icon:'📈', name:'CRASH MASTER', desc:'Win 50 times at Crash' },
  { id:'diversified', icon:'🎯', name:'DIVERSIFIED', desc:'Play 5+ different games' },
  { id:'collector', icon:'🎒', name:'COLLECTOR', desc:'Own 10+ inventory items' },
  { id:'daily_7', icon:'📅', name:'DEDICATED', desc:'Claim 7 daily bonuses (streak)' },
  { id:'profit_10k', icon:'📊', name:'PROFITABLE', desc:'Reach $10,000 total profit' },
  { id:'inv_value', icon:'💼', name:'PORTFOLIO', desc:'Inventory worth $10,000+' }
];

function checkCasinoAchievements(game, wagered, won) {
  const newAchs = [];
  function tryAward(id) {
    if (saveCasinoAch(id)) {
      const a = CASINO_ACHIEVEMENTS.find(x => x.id === id);
      if (a) { newAchs.push(a); showAchToast(a); }
    }
  }

  tryAward('first_game');

  if (won > 0) tryAward('first_win');

  if (won >= 5000) tryAward('big_win');
  if (won >= 50000) tryAward('mega_win');

  if (playerStats.totalWagered >= 10000) tryAward('high_roller');
  if (playerStats.totalWagered >= 100000) tryAward('whale');

  if (playerStats.gamesPlayed >= 50) tryAward('games_50');
  if (playerStats.gamesPlayed >= 500) tryAward('games_500');
  if (playerStats.gamesPlayed >= 5000) tryAward('games_5000');

  if (gameStats.slots && gameStats.slots.won >= 50) tryAward('slots_pro');
  if (gameStats.crash && gameStats.crash.won >= 50) tryAward('crash_pro');

  const gamesPlayed = Object.values(gameStats).filter(g => g.played > 0).length;
  if (gamesPlayed >= 5) tryAward('diversified');

  if (balance <= 0) tryAward('broke');

  if (playerStats.totalProfit >= 10000) tryAward('profit_10k');

  if (inventory.length >= 10) tryAward('collector');

  if (typeof getInventoryValue === 'function' && getInventoryValue() >= 10000) tryAward('inv_value');

  if (dailyBonusData.streak >= 7) tryAward('daily_7');

  if (balance >= 10000 && (getCasinoAch()['broke'])) tryAward('comeback');
  return newAchs;
}
function showAchToast(ach) {
  showToast(ach.icon + ' Achievement: ' + ach.name + ' — ' + ach.desc, true);
}

window._getTradeHistory = () => tradeHistory.slice(0, 50);
window._loadTradeHistory = (data) => {
  if (Array.isArray(data)) {
    const existing = new Set(tradeHistory.map(t => t.ts));
    data.forEach(t => { if (t.ts && !existing.has(t.ts)) tradeHistory.push(t); });
    tradeHistory.sort((a, b) => b.ts - a.ts);
    if (tradeHistory.length > 50) tradeHistory = tradeHistory.slice(0, 50);
    try { localStorage.setItem('casino_trade_history', JSON.stringify(tradeHistory)); } catch(e) {}
  }
};

const PFP_OPTIONS = [
  '👤','😎','🤑','🎰','🃏','👑','🔥','💎','⚡','🌟',
  '🐉','🦊','🐺','🦅','🐲','🦁','🐯','🦈','🐙','🦇',
  '💀','👻','🤖','👽','🎭','🥷','🧙','🧛','🧟','🏴‍☠️',
  '🎲','🎯','🎪','🏆','🎸','🎮','⚔️','🛡️','🗡️','💣',
  '🌊','🌋','❄️','☄️','🌙','☀️','🌈','🍀','💰','🏝️'
];
let selectedPfp = localStorage.getItem('casino_pfp') || '';
let customPfpUrl = localStorage.getItem('casino_pfp_url') || '';
const UPLOAD_WORKER_URL = 'https://chatra.modmojheh.workers.dev';

function openPfpPicker() {
  const overlay = document.getElementById('pfpPickerOverlay');
  overlay.style.display = 'flex';
  const grid = document.getElementById('pfpGrid');
  grid.innerHTML = '';

  const uploadDiv = document.createElement('div');
  uploadDiv.style.cssText = 'width:48px;height:48px;display:flex;align-items:center;justify-content:center;font-size:20px;border-radius:10px;cursor:pointer;border:2px dashed var(--neon);background:rgba(0,240,255,.05);transition:all .15s;';
  uploadDiv.innerHTML = '📷';
  uploadDiv.title = 'Upload custom image';
  uploadDiv.onmouseover = function(){ this.style.transform='scale(1.15)'; };
  uploadDiv.onmouseout = function(){ this.style.transform='scale(1)'; };
  uploadDiv.onclick = function(){ document.getElementById('pfpFileInput').click(); };
  grid.appendChild(uploadDiv);

  if (customPfpUrl) {
    const customDiv = document.createElement('div');
    customDiv.style.cssText = 'width:48px;height:48px;display:flex;align-items:center;justify-content:center;border-radius:10px;cursor:pointer;border:2px solid ' + (!selectedPfp && customPfpUrl ? 'var(--gold)' : 'var(--border)') + ';background:var(--bg);transition:all .15s;overflow:hidden;';
    customDiv.innerHTML = '<img src="' + customPfpUrl + '" style="width:100%;height:100%;object-fit:cover;border-radius:8px;">';
    customDiv.title = 'Your custom avatar';
    customDiv.onmouseover = function(){ this.style.transform='scale(1.15)'; };
    customDiv.onmouseout = function(){ this.style.transform='scale(1)'; };
    customDiv.onclick = function(){ selectCustomPfp(customPfpUrl); };
    grid.appendChild(customDiv);
  }

  PFP_OPTIONS.forEach((emoji) => {
    const isSelected = emoji === selectedPfp;
    const div = document.createElement('div');
    div.style.cssText = 'width:48px;height:48px;display:flex;align-items:center;justify-content:center;font-size:28px;border-radius:10px;cursor:pointer;border:2px solid ' + (isSelected ? 'var(--gold)' : 'var(--border)') + ';background:' + (isSelected ? 'rgba(255,215,0,.15)' : 'var(--bg)') + ';transition:all .15s;';
    div.textContent = emoji;
    div.onmouseover = function(){ this.style.transform='scale(1.15)'; };
    div.onmouseout = function(){ this.style.transform='scale(1)'; };
    div.onclick = function(){ selectPfp(emoji); };
    grid.appendChild(div);
  });
}
function closePfpPicker() { document.getElementById('pfpPickerOverlay').style.display = 'none'; }
function selectPfp(emoji) {
  selectedPfp = emoji;
  customPfpUrl = '';
  localStorage.setItem('casino_pfp', emoji);
  localStorage.removeItem('casino_pfp_url');
  if(window._firebaseSave) firebaseSave();
  applyPfp();
  closePfpPicker();
  showToast('Avatar updated! ' + emoji, true);
}

function selectCustomPfp(url) {
  selectedPfp = '';
  customPfpUrl = url;
  localStorage.setItem('casino_pfp_url', url);
  localStorage.setItem('casino_pfp', '');
  if(window._firebaseSave) firebaseSave();
  applyPfp();
  closePfpPicker();
  showToast('Custom avatar set!', true);
}

async function handlePfpUpload(input) {
  const file = input.files[0];
  if (!file) return;

  if (!file.type.startsWith('image/') && file.type !== 'image/gif') {
    showToast('❌ Please select an image or GIF file', false);
    return;
  }

  if (file.size > 5 * 1024 * 1024) {
    showToast('❌ Image too large (max 5MB)', false);
    return;
  }

  showToast('⏳ Uploading avatar...', true);
  closePfpPicker();

  try {
    const formData = new FormData();
    formData.append('file', file);

    const res = await fetch(UPLOAD_WORKER_URL + '/upload', {
      method: 'POST',
      body: formData
    });

    const data = await res.json();

    if (!res.ok || !data.url) {
      throw new Error(data.error || 'Upload failed');
    }

    customPfpUrl = data.url;
    selectedPfp = '';
    localStorage.setItem('casino_pfp_url', customPfpUrl);
    localStorage.setItem('casino_pfp', '');

    if (window._currentPlayerId) {
      await window._fbUpdate('casino/players/' + window._currentPlayerId, { profilePicUrl: customPfpUrl });
    }
    if(window._firebaseSave) firebaseSave();
    applyPfp();
    showToast('✅ Custom avatar uploaded!', true);
  } catch(err) {
    console.error('PFP upload error:', err);
    showToast('❌ Upload failed: ' + err.message, false);
  }

  input.value = '';
}
function applyPfp() {
  const name = window._currentUsername || 'Guest';
  const init = name.charAt(0).toUpperCase();
  if (customPfpUrl) {
    document.getElementById('userAvatar').innerHTML = '<img src="' + customPfpUrl + '" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">';
    document.getElementById('profileAvatar').innerHTML = '<img src="' + customPfpUrl + '" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">';
  } else if (selectedPfp) {
    document.getElementById('userAvatar').innerHTML = '<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:24px;">' + selectedPfp + '</div>';
    document.getElementById('profileAvatar').innerHTML = '<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:48px;">' + selectedPfp + '</div>';
  } else {
    document.getElementById('userAvatar').innerHTML = `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="avG" x1="0" x2="1"><stop offset="0" stop-color="#00f0ff"/><stop offset="1" stop-color="#6b2fd9"/></linearGradient></defs><circle cx="50" cy="50" r="48" fill="url(#avG)"/><text x="50" y="58" font-family="Orbitron,Inter,sans-serif" font-weight="900" font-size="48" fill="#fff" text-anchor="middle">${init}</text></svg>`;
    document.getElementById('profileAvatar').innerHTML = `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="profG" x1="0" x2="1"><stop offset="0" stop-color="#ffb86b"/><stop offset="1" stop-color="#ff6b6b"/></linearGradient></defs><circle cx="50" cy="50" r="48" fill="url(#profG)"/><text x="50" y="60" font-family="Orbitron,Inter,sans-serif" font-weight="900" font-size="42" fill="#071028" text-anchor="middle">${init}</text></svg>`;
  }
}

function renderProfile() {
  const name = document.getElementById('userNameDisplay').textContent || 'PLAYER';
  document.getElementById('profileName').textContent = name;
  applyPfp();
  document.getElementById('profBalance').textContent = '$' + formatBalance(balance);
  document.getElementById('profGames').textContent = playerStats.gamesPlayed.toLocaleString();
  const profit = playerStats.totalProfit;
  const profEl = document.getElementById('profProfit');
  profEl.textContent = (profit >= 0 ? '+$' : '-$') + formatBalance(Math.abs(profit));
  profEl.style.color = profit >= 0 ? 'var(--green)' : 'var(--red)';
  document.getElementById('profWagered').textContent = '$' + formatBalance(playerStats.totalWagered);
  document.getElementById('profBiggest').textContent = '$' + formatBalance(playerStats.biggestWin);
  if (typeof getInventoryValue === 'function') {
    document.getElementById('profInvValue').textContent = '$' + getInventoryValue().toFixed(2);
  }

  const achs = getCasinoAch();
  const count = Object.keys(achs).length;
  document.getElementById('casinoAchCount').textContent = '(' + count + '/' + CASINO_ACHIEVEMENTS.length + ')';
  document.getElementById('casinoAchGrid').innerHTML = CASINO_ACHIEVEMENTS.map(a => {
    const done = !!achs[a.id];
    return `<div style="display:flex;align-items:center;gap:8px;padding:8px;background:var(--surface);border:1px solid ${done?'var(--gold)':'var(--border)'};border-radius:6px;opacity:${done?1:0.35}">
      <span style="font-size:18px">${a.icon}</span>
      <div style="flex:1;min-width:0"><div style="font-size:11px;font-weight:bold;color:${done?'var(--gold)':'var(--text)'};letter-spacing:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${a.name}</div>
      <div style="font-size:9px;color:var(--text2)">${a.desc}</div></div>
      ${done ? '<span style="color:var(--green)">✓</span>' : ''}
    </div>`;
  }).join('');

  document.getElementById('profGameStats').innerHTML = Object.entries(gameStats).map(([name, s]) => {
    if (!s.played) return '';
    const wr = s.played > 0 ? Math.round((s.won / s.played) * 100) : 0;
    return `<div style="background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:8px;">
      <div style="font-size:10px;color:var(--text2);letter-spacing:1px;text-transform:uppercase">${name}</div>
      <div style="font-size:13px;color:var(--text);margin-top:2px">${s.played} played · ${wr}% WR</div>
      <div style="font-size:10px;color:var(--green)">Best: $${(s.biggestWin||0).toFixed(0)}</div>
    </div>`;
  }).filter(Boolean).join('');

  renderPrestige();

  const adminPanel = document.getElementById('adminPanel');
  const lowerName = name.toLowerCase();
  if (lowerName === 'mojheh' || lowerName === 'terpez' || lowerName === 'jiddy') {
    adminPanel.style.display = 'block';

    const abuseBtn = document.getElementById('adminAbuseStartBtn');
    const abuseActions = document.getElementById('adminAbuseQuickActions');
    if (lowerName === 'jiddy') {
      if (abuseBtn) abuseBtn.style.display = 'none';
      if (abuseActions) abuseActions.style.display = 'none';
    } else {
      if (abuseBtn) abuseBtn.style.display = '';
      if (abuseActions) abuseActions.style.display = '';
    }
  } else {
    adminPanel.style.display = 'none';
  }

  const bugPanel = document.getElementById('bugReportPanel');
  if (bugPanel) {
    if (lowerName === 'youguyssuck') {
      bugPanel.style.display = 'block';
      bugReportLoadMine();
    } else {
      bugPanel.style.display = 'none';
    }
  }

  const bugViewer = document.getElementById('bugReportViewer');
  if (bugViewer) {
    if (lowerName === 'mojheh' || lowerName === 'terpez') {
      bugViewer.style.display = 'block';
      bugReportLoadAll();
    } else {
      bugViewer.style.display = 'none';
    }
  }
}

async function bugReportSubmit() {
  const n = (window._currentUsername || '').toLowerCase();
  if (n !== 'youguyssuck') { showToast('Only bug testers can submit reports!', false); return; }
  const title = (document.getElementById('bugReportTitle').value || '').trim();
  const game = document.getElementById('bugReportGame').value || 'general';
  const desc = (document.getElementById('bugReportDesc').value || '').trim();
  if (!title) { showToast('Please enter a bug title!', false); return; }
  if (!desc) { showToast('Please describe the bug!', false); return; }
  const statusEl = document.getElementById('bugReportStatus');
  statusEl.textContent = 'Submitting...';
  try {
    const reportId = Date.now().toString(36) + Math.random().toString(36).slice(2, 6);
    await window._fbSet('casino/bugReports/' + reportId, {
      title: title,
      game: game,
      description: desc,
      reporter: window._currentUsername,
      reporterUid: window._currentPlayerId,
      time: Date.now(),
      status: 'open'
    });
    document.getElementById('bugReportTitle').value = '';
    document.getElementById('bugReportDesc').value = '';
    document.getElementById('bugReportGame').selectedIndex = 0;
    statusEl.innerHTML = '<span style="color:#00cc66;">✅ Report submitted!</span>';
    setTimeout(() => { statusEl.textContent = ''; }, 3000);
    bugReportLoadMine();
  } catch (e) {
    statusEl.innerHTML = '<span style="color:var(--red);">Failed to submit. Try again.</span>';
  }
}

async function bugReportLoadMine() {
  const listEl = document.getElementById('bugReportMyList');
  if (!listEl) return;
  try {
    const snap = await window._fbGet('casino/bugReports');
    const data = snap.val();
    if (!data) { listEl.innerHTML = '<div style="font-size:10px;color:var(--text2);text-align:center;">No reports yet.</div>'; return; }
    const reports = Object.entries(data)
      .filter(([, r]) => r.reporterUid === window._currentPlayerId)
      .sort((a, b) => (b[1].time || 0) - (a[1].time || 0));
    if (reports.length === 0) { listEl.innerHTML = '<div style="font-size:10px;color:var(--text2);text-align:center;">No reports yet.</div>'; return; }
    listEl.innerHTML = '<div style="font-size:10px;color:var(--text2);letter-spacing:1px;margin-bottom:6px;">YOUR REPORTS</div>' +
      reports.map(([id, r]) => {
        const status = r.status === 'resolved' ? '<span style="color:#00cc66;">RESOLVED</span>' : '<span style="color:#ffaa00;">OPEN</span>';
        const date = new Date(r.time).toLocaleDateString();
        const adminNote = r.adminNote ? '<div style="font-size:9px;color:#44aaff;margin-top:4px;">Admin: ' + _escHtml(r.adminNote) + '</div>' : '';
        return '<div style="background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:8px;margin-bottom:4px;">' +
          '<div style="display:flex;justify-content:space-between;align-items:center;">' +
          '<span style="font-size:11px;color:var(--text);font-weight:700;">' + _escHtml(r.title) + '</span>' +
          '<span style="font-size:9px;">' + status + '</span></div>' +
          '<div style="font-size:9px;color:var(--text2);margin-top:2px;">[' + _escHtml(r.game) + '] — ' + date + '</div>' +
          adminNote + '</div>';
      }).join('');
  } catch (e) { listEl.innerHTML = ''; }
}

async function bugReportLoadAll() {
  const listEl = document.getElementById('bugReportList');
  const countEl = document.getElementById('bugReportCount');
  if (!listEl) return;
  const filter = (document.getElementById('bugViewFilter') || {}).value || 'all';
  try {
    const snap = await window._fbGet('casino/bugReports');
    const data = snap.val();
    if (!data) { listEl.innerHTML = '<div style="font-size:11px;color:var(--text2);text-align:center;padding:20px;">No bug reports.</div>'; if (countEl) countEl.textContent = '(0)'; return; }
    let reports = Object.entries(data).sort((a, b) => (b[1].time || 0) - (a[1].time || 0));
    const total = reports.length;
    const openCount = reports.filter(([, r]) => r.status !== 'resolved').length;
    if (countEl) countEl.textContent = '(' + openCount + ' open / ' + total + ' total)';
    if (filter === 'open') reports = reports.filter(([, r]) => r.status !== 'resolved');
    else if (filter === 'resolved') reports = reports.filter(([, r]) => r.status === 'resolved');
    if (reports.length === 0) { listEl.innerHTML = '<div style="font-size:11px;color:var(--text2);text-align:center;padding:20px;">No reports match filter.</div>'; return; }
    listEl.innerHTML = reports.map(([id, r]) => {
      const isOpen = r.status !== 'resolved';
      const statusBadge = isOpen ? '<span style="background:#ffaa00;color:#000;padding:1px 6px;border-radius:3px;font-size:8px;font-weight:900;">OPEN</span>' : '<span style="background:#00cc66;color:#000;padding:1px 6px;border-radius:3px;font-size:8px;font-weight:900;">RESOLVED</span>';
      const date = new Date(r.time).toLocaleString();
      const toggleBtn = isOpen
        ? '<button onclick="bugReportResolve(\'' + id + '\')" style="padding:3px 8px;background:#00aa44;border:none;border-radius:4px;color:#fff;cursor:pointer;font-size:9px;font-weight:700;">✅ Resolve</button>'
        : '<button onclick="bugReportReopen(\'' + id + '\')" style="padding:3px 8px;background:#ff6600;border:none;border-radius:4px;color:#fff;cursor:pointer;font-size:9px;font-weight:700;">🔄 Reopen</button>';
      const noteHtml = r.adminNote ? '<div style="font-size:9px;color:#44aaff;margin-top:4px;padding:4px 6px;background:rgba(68,170,255,.08);border-radius:4px;">💬 ' + _escHtml(r.adminNote) + '</div>' : '';
      return '<div style="background:var(--surface);border:1px solid ' + (isOpen ? 'rgba(255,170,0,.3)' : 'rgba(0,200,100,.2)') + ';border-radius:8px;padding:10px;margin-bottom:6px;">' +
        '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">' +
        '<span style="font-size:12px;color:var(--text);font-weight:700;">' + _escHtml(r.title) + '</span>' + statusBadge + '</div>' +
        '<div style="font-size:9px;color:var(--text2);margin-bottom:4px;">By: ' + _escHtml(r.reporter || 'unknown') + ' — [' + _escHtml(r.game) + '] — ' + date + '</div>' +
        '<div style="font-size:10px;color:var(--text);line-height:1.4;padding:6px;background:var(--bg);border-radius:4px;margin-bottom:6px;">' + _escHtml(r.description) + '</div>' +
        noteHtml +
        '<div style="display:flex;gap:4px;align-items:center;">' + toggleBtn +
        '<button onclick="bugReportAddNote(\'' + id + '\')" style="padding:3px 8px;background:var(--surface2);border:1px solid var(--border);border-radius:4px;color:var(--text);cursor:pointer;font-size:9px;">💬 Note</button>' +
        '<button onclick="bugReportDelete(\'' + id + '\')" style="padding:3px 8px;background:#880000;border:none;border-radius:4px;color:#fff;cursor:pointer;font-size:9px;">🗑️</button>' +
        '</div></div>';
    }).join('');
  } catch (e) { listEl.innerHTML = '<div style="color:var(--red);font-size:10px;">Error loading reports.</div>'; }
}

async function bugReportResolve(id) {
  await window._fbUpdate('casino/bugReports/' + id, { status: 'resolved', resolvedBy: window._currentUsername, resolvedAt: Date.now() });
  showToast('Report resolved!', true);
  bugReportLoadAll();
}
async function bugReportReopen(id) {
  await window._fbUpdate('casino/bugReports/' + id, { status: 'open' });
  showToast('Report reopened', true);
  bugReportLoadAll();
}
async function bugReportAddNote(id) {
  const note = prompt('Add admin note:');
  if (note === null) return;
  await window._fbUpdate('casino/bugReports/' + id, { adminNote: note.trim() });
  showToast('Note added', true);
  bugReportLoadAll();
}
async function bugReportDelete(id) {
  if (!confirm('Delete this bug report?')) return;
  await window._fbRemove('casino/bugReports/' + id);
  showToast('Report deleted', true);
  bugReportLoadAll();
}

function _escHtml(s) { return typeof escapeHtml==='function' ? escapeHtml(s||'') : (s||''); }

let prestigeLevel = 0;
const PRESTIGE_REQS = [10000, 50000, 250000, 1000000, 10000000];
const PRESTIGE_NAMES = ['Bronze','Silver','Gold','Diamond','Legendary'];
const PRESTIGE_COLORS = ['prestige-1','prestige-2','prestige-3','prestige-4','prestige-5'];

window._loadPrestige = (val) => { prestigeLevel = val || 0; };
window._getPrestige = () => prestigeLevel;

window._loadProfilePicUrl = (url) => { customPfpUrl = url || ''; localStorage.setItem('casino_pfp_url', customPfpUrl); if (customPfpUrl) { selectedPfp = ''; localStorage.setItem('casino_pfp', ''); } applyPfp(); };
window._getProfilePicUrl = () => customPfpUrl || null;

function getPrestigeReq() {
  if (prestigeLevel >= PRESTIGE_REQS.length) return PRESTIGE_REQS[PRESTIGE_REQS.length - 1] * Math.pow(5, prestigeLevel - PRESTIGE_REQS.length + 1);
  return PRESTIGE_REQS[prestigeLevel];
}

async function adminGiveMoney() {
  const _aName = (window._currentUsername||'').toLowerCase();
  if (_aName !== 'mojheh' && _aName !== 'terpez') {
    showToast('Admin only!', false);
    return;
  }
  const username = document.getElementById('adminUsername').value.trim();
  const amount = parseBet(document.getElementById('adminAmount').value);
  if (!username || !amount || amount <= 0) {
    showToast('Invalid input!', false);
    return;
  }
  try {
    showToast('⏳ Processing...', true);

    const usersSnap = await window._fbGet('casino/usernames/' + username.toLowerCase());
    if (!usersSnap.exists()) {
      showToast('❌ User "' + username + '" not found!', false);
      return;
    }
    const userId = usersSnap.val();

    const playerSnap = await window._fbGet('casino/players/' + userId);
    const currentData = playerSnap.exists() ? playerSnap.val() : {};
    const currentBal = safeNum(parseFloat(currentData.balance || 0));
    const newBal = currentBal + amount;

    await window._fbUpdate('casino/players/' + userId, {
      balance: newBal
    });

    await window._fbSet('casino/admin/playerGift/' + userId, {
      amount: amount, newBal: newBal, from: window._currentUsername, time: Date.now()
    });

    showToast('✅ Gave $' + formatBalance(amount) + ' to ' + username + ' (now $' + formatBalance(newBal) + ')', true);
    document.getElementById('adminUsername').value = '';
    document.getElementById('adminAmount').value = '';
  } catch(e) {
    console.error('Admin give money error:', e);
    showToast('❌ Error: ' + (e.message || 'Unknown error'), false);
  }
}

function getPrestigeBadgeHTML(level) {
  if (!level || level <= 0) return '';
  const tier = Math.min(level, 5);
  const name = tier <= PRESTIGE_NAMES.length ? PRESTIGE_NAMES[tier - 1] : PRESTIGE_NAMES[PRESTIGE_NAMES.length - 1];
  const cls = tier <= PRESTIGE_COLORS.length ? PRESTIGE_COLORS[tier - 1] : PRESTIGE_COLORS[PRESTIGE_COLORS.length - 1];
  return `<span class="prestige-badge ${cls}">P${level} ${name}</span>`;
}

function renderPrestige() {
  const el = document.getElementById('profPrestigeLevel');
  if (el) el.textContent = prestigeLevel;
  const badge = document.getElementById('profilePrestigeBadge');
  if (badge) badge.innerHTML = prestigeLevel > 0 ? getPrestigeBadgeHTML(prestigeLevel) : '<span style="font-size:11px;color:var(--text2);">Not yet prestiged</span>';
  const req = getPrestigeReq();
  const reqEl = document.getElementById('prestigeReqText');
  if (reqEl) {
    const bonusPct = Math.round(prestigeLevel * 5);
    const nextPct = Math.round((prestigeLevel + 1) * 5);
    reqEl.innerHTML = 'Requires $' + formatBalance(req) + ' balance to prestige.' +
      (prestigeLevel > 0 ? '<br><span style="color:var(--green);font-size:11px;">Current bonus: +' + bonusPct + '% win payouts</span>' : '') +
      '<br><span style="color:var(--gold);font-size:11px;">Next level: +' + nextPct + '% win payouts</span>';
  }
  const btn = document.getElementById('prestigeBtn');
  if (btn) btn.disabled = balance < req;
}

function prestigeConfirm() {
  const req = getPrestigeReq();
  const currentBal = Number(balance) || 0;
  console.log('Prestige check - Current balance:', currentBal, 'Requirement:', req, 'Prestige level:', prestigeLevel);
  if (currentBal < req) {
    showToast('Need $' + formatBalance(req) + ' to prestige! You have $' + formatBalance(currentBal), false);
    return;
  }

  const overlay = document.createElement('div');
  overlay.className = 'prestige-confirm-overlay';
  overlay.innerHTML = `<div class="prestige-confirm-box">
    <div style="font-size:36px;margin-bottom:8px;">👑</div>
    <div style="font-family:'Orbitron';font-size:18px;color:var(--gold);margin-bottom:8px;">PRESTIGE UP?</div>
    <div style="font-size:12px;color:var(--text2);margin-bottom:12px;">
      Your balance will reset to <b style="color:var(--gold);">$1,000</b><br>
      You'll go from <b>Prestige ${prestigeLevel}</b> → <b style="color:var(--gold);">Prestige ${prestigeLevel + 1}</b><br>
      <div style="margin:8px 0;padding:6px 12px;background:rgba(74,222,128,0.1);border:1px solid rgba(74,222,128,0.3);border-radius:6px;">
        <span style="color:var(--green);font-size:12px;font-weight:bold;">Win Bonus: +${Math.round(prestigeLevel * 5)}% → +${Math.round((prestigeLevel + 1) * 5)}%</span><br>
        <span style="color:var(--text2);font-size:10px;">All game winnings boosted!</span>
      </div>
      <span style="color:var(--text2);font-size:10px;">Your inventory, stats and achievements are kept.</span>
    </div>
    <div style="display:flex;gap:8px;justify-content:center;">
      <button onclick="this.closest('.prestige-confirm-overlay').remove()" style="padding:10px 20px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);cursor:pointer;font-family:'Orbitron';font-size:11px;">CANCEL</button>
      <button onclick="prestigeExecute();this.closest('.prestige-confirm-overlay').remove()" style="padding:10px 20px;background:linear-gradient(135deg,var(--gold),#ff8800);border:none;border-radius:8px;color:#1a1a2e;cursor:pointer;font-family:'Orbitron';font-size:11px;font-weight:900;">👑 PRESTIGE</button>
    </div>
  </div>`;
  document.body.appendChild(overlay);
}

function prestigeExecute() {
  const req = getPrestigeReq();
  const currentBal = Number(balance) || 0;
  if (currentBal < req) {
    showToast('Not enough balance! Need $' + formatBalance(req) + ', have $' + formatBalance(currentBal), false);
    return;
  }
  try {
    prestigeLevel++;
    balance = 1000;
    updateBalDisplay();
    console.log('Prestige executed! New level:', prestigeLevel, 'New balance:', balance);
    showToast('👑 PRESTIGE ' + prestigeLevel + '! Welcome to ' + (PRESTIGE_NAMES[Math.min(prestigeLevel, PRESTIGE_NAMES.length) - 1] || 'Legendary') + '!');
    playWinSound();
    spawnParticles(window.innerWidth / 2, window.innerHeight / 2, 50);
    firebaseSave();
    renderProfile();
    renderPrestige();
  } catch(e) {
    console.error('Prestige execute error:', e);
    showToast('❌ Error: ' + (e.message || 'Unknown'), false);
  }
}

let duelRoomUnsub = null;
let duelLobbyUnsub = null;
let currentDuelRoom = null;
let duelHistory = [];
try { duelHistory = JSON.parse(localStorage.getItem('casino_duel_history') || '[]'); } catch(e) { duelHistory = []; }

function duelGenCode() { return 'D' + Math.random().toString(36).substr(2, 6).toUpperCase(); }

async function duelCreate() {
  if (!window._currentPlayerId) { showToast('Login required!', false); return; }
  const wager = parseBet(document.getElementById('duelWagerInput').value) || 100;
  if (wager < 10) { showToast('Minimum wager is $10', false); return; }
  if (wager > balance) { showToast('Not enough balance!', false); return; }
  const code = duelGenCode();
  balance -= wager;
  updateBalDisplay();
  firebaseSaveNow();
  try {
    await window._fbSet('casino/duelRooms/' + code, {
      host: window._currentPlayerId,
      hostName: window._currentUsername,
      hostPrestige: prestigeLevel,
      wager: wager,
      status: 'waiting',
      created: Date.now()
    });

    window._fbOnDisconnect('casino/duelRooms/' + code).remove();
    showToast('Duel created! Waiting for opponent...', true);
    playClickSound();
    duelWatchGame(code, wager);
  } catch(e) {
    balance += wager;
    updateBalDisplay();
    showToast('Failed to create duel: ' + (e.message || 'Unknown error'), false);
  }
}

async function duelJoin(code) {
  if (!window._currentPlayerId) { showToast('Login required!', false); return; }
  try {
    const snap = await window._fbGet('casino/duelRooms/' + code);
    if (!snap.exists()) { showToast('Duel not found!', false); return; }
    const room = snap.val();
    if (room.status !== 'waiting') { showToast('Duel already started!', false); return; }
    if (room.host === window._currentPlayerId) { showToast("Can't join your own duel!", false); return; }
    if (room.wager > balance) { showToast('Not enough balance!', false); return; }
    balance -= room.wager;
    updateBalDisplay();
    firebaseSaveNow();
    await window._fbUpdate('casino/duelRooms/' + code, {
      challenger: window._currentPlayerId,
      challengerName: window._currentUsername,
      challengerPrestige: prestigeLevel,
      status: 'playing'
    });
    playClickSound();

    duelWatchGame(code, room.wager);
  } catch(e) {
    balance += room.wager; updateBalDisplay();
    showToast('Failed to join duel: ' + (e.message || 'Unknown error'), false);
  }
}

let _duelAnimating = false;
let _duelResolved = false;

function duelPlayTick() { playSound(800, 'sine', .15, .04); }
function duelPlayBoom() { playSound(100, 'sawtooth', .5, .15); setTimeout(() => playSound(80, 'square', .4, .2), 80); }
function duelPlayDrum() { playSound(150, 'triangle', .3, .08); }
function duelPlaySuspense(i) {

  const freq = 300 + i * 60;
  playSound(freq, 'sine', .12, .06);
}

function duelWatchGame(code, wager) {
  currentDuelRoom = code;
  _duelAnimating = false;
  _duelResolved = false;
  const overlay = document.getElementById('duelGameOverlay');
  overlay.style.display = 'flex';
  document.getElementById('duelCloseBtn').style.display = 'none';
  document.getElementById('duelResultText').style.display = 'none';
  document.getElementById('duelCoin').style.display = 'none';
  document.getElementById('duelCoin').style.animation = 'none';
  document.getElementById('duelCountdown').style.display = 'none';
  document.getElementById('duelTensionBar').style.display = 'none';
  document.getElementById('duelStatusText').textContent = 'WAITING FOR OPPONENT...';
  document.getElementById('duelWagerText').textContent = '⚔️ $' + formatBalance(wager) + ' ON THE LINE ⚔️';
  document.getElementById('duelVsText').textContent = 'VS';
  document.getElementById('duelInner').classList.remove('duel-overlay-shake');

  if (duelRoomUnsub) { duelRoomUnsub(); duelRoomUnsub = null; }

  duelRoomUnsub = window._fbOnValue('casino/duelRooms/' + code, (snap) => {
    if (!snap.exists()) return;
    const room = snap.val();
    document.getElementById('duelP1Name').textContent = room.hostName || 'Host';
    document.getElementById('duelP2Name').textContent = room.challengerName || 'Waiting...';

    if (room.status === 'playing' && !room.result && !_duelAnimating) {
      _duelAnimating = true;
      document.getElementById('duelStatusText').textContent = 'OPPONENT FOUND!';

      if (room.host === window._currentPlayerId) {
        setTimeout(() => duelResolve(code), 7500);
      }

      if (room.challenger === window._currentPlayerId) {
        setTimeout(() => duelResolve(code), 12000);
      }

      setTimeout(async () => {
        const checkSnap = await window._fbGet('casino/duelRooms/' + code);
        if (checkSnap.exists() && !checkSnap.val().result) {

          duelResolve(code);

          setTimeout(async () => {
            if (currentDuelRoom !== code) return;
            const finalSnap = await window._fbGet('casino/duelRooms/' + code);
            if (finalSnap.exists() && !finalSnap.val().result) {
              balance += wager; updateBalDisplay();
              firebaseSaveNow();
              showToast('Duel timed out — wager refunded!', false);
              document.getElementById('duelGameOverlay').style.display = 'none';
              currentDuelRoom = null;
              if (duelRoomUnsub) { duelRoomUnsub(); duelRoomUnsub = null; }
              window._fbRemove('casino/duelRooms/' + code).catch(()=>{});
            }
          }, 3000);
        }
      }, 20000);

      duelDramaticSequence(room);
    }

    if (room.result && !_duelResolved) {
      _duelResolved = true;
      duelShowResult(room);
    }
  });
}

function duelDramaticSequence(room) {
  const countdownEl = document.getElementById('duelCountdown');
  const coinEl = document.getElementById('duelCoin');
  const statusEl = document.getElementById('duelStatusText');
  const tensionBar = document.getElementById('duelTensionBar');
  const tensionFill = document.getElementById('duelTensionFill');

  countdownEl.style.display = 'block';
  let count = 3;
  countdownEl.textContent = count;
  countdownEl.style.animation = 'none';
  void countdownEl.offsetWidth;
  countdownEl.style.animation = 'duelCountPulse .5s ease-out';
  duelPlayTick();

  const countInterval = setInterval(() => {
    count--;
    if (count > 0) {
      countdownEl.textContent = count;
      countdownEl.style.animation = 'none';
      void countdownEl.offsetWidth;
      countdownEl.style.animation = 'duelCountPulse .5s ease-out';
      duelPlayTick();
    } else if (count === 0) {
      countdownEl.textContent = '⚔️';
      countdownEl.style.animation = 'none';
      void countdownEl.offsetWidth;
      countdownEl.style.animation = 'duelCountPulse .5s ease-out';
      duelPlayBoom();

      const flash = document.getElementById('duelFlash');
      flash.style.background = 'white';
      flash.style.animation = 'duelFlashBang .4s ease-out forwards';
      setTimeout(() => { flash.style.animation = 'none'; }, 500);

      setTimeout(() => {
        countdownEl.style.display = 'none';
        coinEl.style.display = 'flex';
        coinEl.style.animation = 'duelCoinSpin .12s linear infinite';
        tensionBar.style.display = 'block';

        const gameOverlay = document.getElementById('duelGameOverlay');
        const fogTint = document.createElement('div');
        fogTint.style.position = 'absolute';
        fogTint.style.top = '0';
        fogTint.style.left = '0';
        fogTint.style.width = '100%';
        fogTint.style.height = '100%';
        fogTint.style.pointerEvents = 'none';
        fogTint.style.background = 'radial-gradient(ellipse at center, transparent 0%, rgba(30,58,138,0.3) 100%)';
        fogTint.style.opacity = '0';
        gameOverlay.appendChild(fogTint);

        duelPlayDrum();

        let tensionStep = 0;
        const tensionTotal = 40;
        const tensionInterval = setInterval(() => {
          tensionStep++;
          const pct = Math.min((tensionStep / tensionTotal) * 100, 100);
          tensionFill.style.width = pct + '%';

          const eased = (tensionStep / tensionTotal);
          const speed = 0.12 + eased * eased * 2.0;
          coinEl.style.animation = 'duelCoinSpin ' + speed.toFixed(3) + 's linear infinite';

          const glowIntensity = 8 + Math.sin(tensionStep / 8) * 6;
          coinEl.style.filter = 'drop-shadow(0 0 ' + glowIntensity + 'px rgba(255, 200, 0, 0.7)) saturate(1.2)';

          if (tensionStep < tensionTotal - 5) {
            const saturation = 0.9 + Math.sin(tensionStep / 4) * 0.15;
            gameOverlay.style.filter = 'saturate(' + saturation + ') brightness(1.05)';
          }

          fogTint.style.opacity = (pct / 100 * 0.6).toFixed(3);

          if (tensionStep % 3 === 0) duelPlaySuspense(tensionStep / 3);

          if (tensionStep >= tensionTotal - 7) {
            coinEl.style.animation = 'duelCoinSpin 3s linear infinite';
          }

          if (tensionStep >= tensionTotal) {
            clearInterval(tensionInterval);

            tensionBar.style.display = 'none';
            gameOverlay.style.filter = 'saturate(1) brightness(1)';
            fogTint.style.opacity = '0';
            setTimeout(()=>{ fogTint.remove(); }, 500);
          }
        }, 85);
      }, 600);

      clearInterval(countInterval);
    }
  }, 1000);
}

async function duelResolve(code) {
  const snap = await window._fbGet('casino/duelRooms/' + code);
  if (!snap.exists()) return;
  const room = snap.val();
  if (room.result) return;

  const flip = Math.random() < 0.5 ? 'heads' : 'tails';
  const winnerId = flip === 'heads' ? room.host : room.challenger;
  const winnerName = flip === 'heads' ? room.hostName : room.challengerName;
  const loserId = flip === 'heads' ? room.challenger : room.host;
  const loserName = flip === 'heads' ? room.challengerName : room.hostName;
  const pot = room.wager * 2;

  await window._fbUpdate('casino/duelRooms/' + code, {
    result: flip,
    winner: winnerId,
    winnerName: winnerName,
    loserId: loserId,
    loserName: loserName,
    pot: pot,
    status: 'finished',
    finishedAt: Date.now()
  });
}

function duelShowResult(room) {
  const coin = document.getElementById('duelCoin');
  const inner = document.getElementById('duelInner');
  const flash = document.getElementById('duelFlash');
  const statusEl = document.getElementById('duelStatusText');
  const resultEl = document.getElementById('duelResultText');
  const isWinner = room.winner === window._currentPlayerId;
  const isLoser = room.loserId === window._currentPlayerId;

  duelPlayBoom();
  inner.classList.remove('duel-overlay-shake');
  void inner.offsetWidth;
  inner.classList.add('duel-overlay-shake');

  flash.style.background = isWinner ? '#00e676' : isLoser ? '#ff1744' : '#ffd700';
  flash.style.animation = 'duelFlashBang .6s ease-out forwards';
  setTimeout(() => { flash.style.animation = 'none'; }, 700);

  coin.style.animation = room.result === 'heads' ? 'duelCoinRevealHeads .8s ease-out forwards' : 'duelCoinRevealTails .8s ease-out forwards';

  setTimeout(() => {
    resultEl.style.display = 'block';
    resultEl.className = 'duel-result duel-result-reveal';
    statusEl.textContent = room.result === 'heads' ? '🟡 HEADS! 🟡' : '⚫ TAILS! ⚫';

    if (isWinner) {
      resultEl.textContent = '💰 YOU WIN! 💰';
      resultEl.style.color = '#00e676';
      resultEl.classList.add('duel-win-glow');

      setTimeout(() => {
        playSound(200, 'square', .4, .1);
        setTimeout(() => playSound(300, 'square', .4, .1), 100);
        setTimeout(() => playSound(400, 'square', .4, .1), 200);
        setTimeout(() => playSound(600, 'square', .5, .15), 300);
        setTimeout(() => playSound(800, 'sine', .3, .2), 400);
      }, 100);

      balance += room.pot;
      updateBalDisplay();
      showBigWin(room.pot);
      spawnParticles(window.innerWidth / 2, window.innerHeight / 2, 60);
      setTimeout(() => spawnParticles(window.innerWidth / 3, window.innerHeight / 2, 30), 200);
      setTimeout(() => spawnParticles(window.innerWidth * 2 / 3, window.innerHeight / 2, 30), 400);
      showToast('🎉 +$' + formatBalance(room.pot) + ' from duel!');
      recordGame('duels', room.wager, room.pot);
      firebaseSaveNow();

      let flashCount = 0;
      const flashInterval = setInterval(() => {
        flash.style.background = '#00e676';
        flash.style.animation = 'duelFlashBang .3s ease-out forwards';
        setTimeout(() => { flash.style.animation = 'none'; }, 350);
        flashCount++;
        if (flashCount >= 3) clearInterval(flashInterval);
      }, 400);
    } else if (isLoser) {
      resultEl.textContent = '💀 YOU LOSE 💀';
      resultEl.style.color = '#ff1744';
      playLoseSound();
      recordGame('duels', room.wager, 0);
    } else {
      resultEl.textContent = room.winnerName + ' WINS!';
      resultEl.style.color = 'var(--gold)';
    }

    document.getElementById('duelWagerText').textContent = room.winnerName + ' takes $' + formatBalance(room.pot) + '!';
  }, 400);

  document.getElementById('duelCloseBtn').style.display = '';

  duelHistory.unshift({ winner: room.winnerName, loser: room.loserName, pot: room.pot, time: Date.now() });
  if (duelHistory.length > 20) duelHistory.length = 20;
  localStorage.setItem('casino_duel_history', JSON.stringify(duelHistory));

  if (isWinner && room.pot >= 500 && window._broadcastWin) {
    window._broadcastWin(window._currentUsername, 'Duel', room.pot);
  }

  if (room.host === window._currentPlayerId) {
    setTimeout(() => {
      window._fbRemove('casino/duelRooms/' + currentDuelRoom).catch(() => {});
    }, 10000);
  }

  if (duelRoomUnsub) { duelRoomUnsub(); duelRoomUnsub = null; }

  firebaseSaveNow();
}

function duelCloseOverlay() {
  document.getElementById('duelGameOverlay').style.display = 'none';
  currentDuelRoom = null;
  duelLoadLobby();
}

function duelLoadLobby() {

  if (duelLobbyUnsub) { clearInterval(duelLobbyUnsub); duelLobbyUnsub = null; }
  async function _pollDuels() {
    try {
      const snap = await window._fbGet('casino/duelRooms');
      const list = document.getElementById('duelList');
      if (!list) return;
      if (!snap.exists()) {
        list.innerHTML = '<div style="text-align:center;color:var(--text2);font-size:12px;padding:20px;">No open duels. Create one!</div>';
        return;
      }
      const rooms = snap.val();
      let html = '';
      let hasOpen = false;
      Object.entries(rooms).forEach(([code, room]) => {
        if (room.status !== 'waiting') return;
        if (Date.now() - room.created > 300000) return;
        hasOpen = true;
        const isHost = room.host === window._currentPlayerId;
        const badge = room.hostPrestige > 0 ? getPrestigeBadgeHTML(room.hostPrestige) : '';
        html += `<div class="duel-card">
          <div>
            <div class="duel-host">${escapeHtml(room.hostName || 'Unknown')} ${badge}</div>
            <div style="font-size:10px;color:var(--text2);">${isHost ? 'Your duel — waiting...' : 'Open duel'}</div>
          </div>
          <div class="duel-wager">$${formatBalance(room.wager)}</div>
          ${isHost
            ? `<button class="duel-join" style="background:var(--red);" onclick="duelCancel('${code}')">CANCEL</button>`
            : `<button class="duel-join" onclick="duelJoin('${code}')">JOIN ⚔️</button>`}
        </div>`;
      });
      if (!hasOpen) {
        html = '<div style="text-align:center;color:var(--text2);font-size:12px;padding:20px;">No open duels. Create one!</div>';
      }
      list.innerHTML = html;
    } catch(e) {}
  }
  _pollDuels();
  duelLobbyUnsub = setInterval(_pollDuels, 5000);

  renderDuelHistory();
}

async function duelCancel(code) {
  const snap = await window._fbGet('casino/duelRooms/' + code);
  if (snap.exists()) {
    const room = snap.val();
    if (room.host === window._currentPlayerId && room.status === 'waiting') {
      balance += room.wager;
      updateBalDisplay();
      await window._fbRemove('casino/duelRooms/' + code);
      if (duelRoomUnsub) { duelRoomUnsub(); duelRoomUnsub = null; }
      currentDuelRoom = null;
      firebaseSaveNow();
      showToast('Duel cancelled, wager refunded.', true);
    }
  }
}

function renderDuelHistory() {
  const el = document.getElementById('duelHistory');
  if (!el) return;
  if (duelHistory.length === 0) {
    el.innerHTML = '<div style="text-align:center;color:var(--text2);font-size:11px;padding:8px;">No duels yet.</div>';
    return;
  }
  el.innerHTML = duelHistory.slice(0, 10).map(d => {
    const ago = Math.floor((Date.now() - d.time) / 60000);
    const timeStr = ago < 1 ? 'just now' : ago + 'm ago';
    return `<div class="duel-history-item">
      <span style="color:var(--green);">${escapeHtml(d.winner)}</span>
      <span style="color:var(--text2);">beat</span>
      <span style="color:var(--red);">${escapeHtml(d.loser)}</span>
      <span style="color:var(--gold);font-family:'Orbitron';">$${formatBalance(d.pot)}</span>
      <span style="color:var(--text2);">${timeStr}</span>
    </div>`;
  }).join('');
}

let tradeHistory = [];
try { tradeHistory = JSON.parse(localStorage.getItem('casino_trade_history') || '[]'); } catch(e) { tradeHistory = []; }
let _tradeRequestUnsub = null;
let _tradePartner = '';

function openTradeOverlay() {
  playClickSound();
  document.getElementById('tradeOverlay').style.display = 'block';
  tradeGoToStep(1);
  loadIncomingTrades();
  loadTradeRequests();
}
function closeTradeOverlay() {
  document.getElementById('tradeOverlay').style.display = 'none';
  if (_tradeRequestUnsub) { _tradeRequestUnsub(); _tradeRequestUnsub = null; }
}

function showTradePanel() { openTradeOverlay(); }

function openStoreOverlay() {
  playClickSound();
  document.getElementById('storeOverlay').style.display = 'block';
  storePopulateListSelect();
  loadStoreListings();
}
function closeStoreOverlay() {
  document.getElementById('storeOverlay').style.display = 'none';
}
function showStorePanel() { openStoreOverlay(); }

function tradeGoToStep(n) {
  document.getElementById('tradeStep1').style.display = n === 1 ? 'block' : 'none';
  document.getElementById('tradeStep2').style.display = n === 2 ? 'block' : 'none';
  document.getElementById('tradeStep3').style.display = n === 3 ? 'block' : 'none';
  if (n === 1) {
    document.getElementById('tradeRecipient').value = '';
    document.getElementById('tradeUserStatus').textContent = '';
    document.getElementById('tradeRequestBtn').disabled = true;
    document.getElementById('tradeRequestBtn').style.opacity = '0.5';
    if (_tradeRequestUnsub) { _tradeRequestUnsub(); _tradeRequestUnsub = null; }
  }
}

(function() {
  const inp = document.getElementById('tradeRecipient');
  if (!inp) return;
  let debounce;
  inp.addEventListener('input', () => {
    const btn = document.getElementById('tradeRequestBtn');
    const st = document.getElementById('tradeUserStatus');
    clearTimeout(debounce);
    const u = inp.value.trim().toLowerCase();
    if (u.length < 2) { btn.disabled = true; btn.style.opacity = '0.5'; st.textContent = ''; return; }
    st.textContent = 'Checking...';
    st.style.color = 'var(--text2)';
    debounce = setTimeout(async () => {
      if (!window._sendTradeRequest) { st.textContent = 'Login first'; st.style.color = 'var(--red)'; return; }
      try {

        const nameSnap = await window._checkUsernameExists(u);
        if (nameSnap) {
          st.innerHTML = '✅ <strong style="color:var(--neon);">' + u + '</strong> found';
          st.style.color = 'var(--green)';
          btn.disabled = false;
          btn.style.opacity = '1';
        } else {
          st.textContent = '❌ Player not found';
          st.style.color = 'var(--red)';
          btn.disabled = true;
          btn.style.opacity = '0.5';
        }
      } catch(e) { st.textContent = 'Error checking'; st.style.color = 'var(--red)'; }
    }, 500);
  });
})();

async function tradeRequestSend() {
  const u = document.getElementById('tradeRecipient').value.trim().toLowerCase();
  const st = document.getElementById('tradeUserStatus');
  if (!u) return;
  if (!window._sendTradeRequest) { st.textContent = 'Login first'; st.style.color = 'var(--red)'; return; }
  st.textContent = '⏳ Sending request...';
  try {
    const res = await window._sendTradeRequest(u);
    if (res.error) { st.textContent = '❌ ' + res.error; st.style.color = 'var(--red)'; return; }
    _tradePartner = u;
    document.getElementById('tradeWaitingFor').textContent = u;
    tradeGoToStep(2);

    let dots = 0;
    const dotsEl = document.getElementById('tradeWaitDots');
    const dotsI = setInterval(() => { dots = (dots + 1) % 4; dotsEl.textContent = '.'.repeat(dots + 1); }, 600);

    _tradeRequestUnsub = window._listenTradeRequestResponse(res.recipientUid, res.requestId,
      async () => {
        clearInterval(dotsI);
        document.getElementById('tradePartnerName').textContent = u;

        const tradeId = await window._createLiveTrade(res.recipientUid, u);
        if (tradeId) {
          _liveTradeId = tradeId;
          _liveTradeIsHost = true;
          _liveTradePartner = u;
          tradeGoToStep(3);
          populateTradeSelect();
          startLiveTradeListener(tradeId);
        }
        showToast('🤝 ' + u + ' accepted! Live trade started!', true);
      },
      () => {
        clearInterval(dotsI);
        showToast('❌ ' + u + ' declined your trade request', false);
        tradeGoToStep(1);
      }
    );
  } catch(e) { st.textContent = '❌ Error'; st.style.color = 'var(--red)'; }
}

function tradeCancelRequest() {
  if (_tradeRequestUnsub) { _tradeRequestUnsub(); _tradeRequestUnsub = null; }
  tradeGoToStep(1);
  showToast('Trade request cancelled');
}

function tradeCancelSession() {
  if (_tradeRequestUnsub) { _tradeRequestUnsub(); _tradeRequestUnsub = null; }
  if (_liveTradeUnsub) { try { _liveTradeUnsub(); } catch(e) {} _liveTradeUnsub = null; }
  if (_liveTradeId) { window._fbUpdate('casino/liveTrades/' + _liveTradeId, { status: 'cancelled' }); }
  _liveTradeId = null;
  tradeGoToStep(1);
}

let _liveTradeId = null;
let _liveTradeIsHost = false;
let _liveTradePartner = '';
let _liveTradeUnsub = null;
let _liveTradeMyItems = [];
let _liveTradeReady = false;

function startLiveTradeListener(tradeId) {
  if (_liveTradeUnsub) { try { _liveTradeUnsub(); } catch(e) {} }
  _liveTradeMyItems = [];
  _liveTradeReady = false;

  _liveTradeUnsub = window._fbOnValue('casino/liveTrades/' + tradeId, snap => {
    const t = snap.val();
    if (!t) return;

    if (t.status === 'cancelled') {
      showToast('Trade was cancelled', false);
      if (_liveTradeUnsub) { try { _liveTradeUnsub(); } catch(e) {} _liveTradeUnsub = null; }
      tradeGoToStep(1);
      return;
    }

    if (t.status === 'completed') {
      showToast('🤝 Trade completed successfully!', true);
      if (_liveTradeUnsub) { try { _liveTradeUnsub(); } catch(e) {} _liveTradeUnsub = null; }

      if (typeof checkPendingRefunds === 'function') setTimeout(checkPendingRefunds, 1000);
      tradeGoToStep(1);
      return;
    }

    const isHost = _liveTradeIsHost;
    const theirOffer = isHost ? t.guestOffer : t.hostOffer;
    const theirReady = isHost ? t.guestReady : t.hostReady;
    const myReady = isHost ? t.hostReady : t.guestReady;

    const theirItemsEl = document.getElementById('liveTradeTheirItems');
    const theirItems = (theirOffer?.items || '').split(',').filter(Boolean);
    if (theirItems.length === 0) {
      theirItemsEl.textContent = 'No items offered';
    } else {
      theirItemsEl.innerHTML = theirItems.map(id => {
        const cat = (typeof ITEM_CATALOG !== 'undefined') ? ITEM_CATALOG[id] : null;
        return cat ? `<span style="margin-right:4px;">${cat.icon} ${cat.name}</span>` : id;
      }).join('<br>');
    }

    document.getElementById('liveTradeTheirCash').textContent = '$' + Math.floor(theirOffer?.cash || 0).toLocaleString();

    document.getElementById('liveTradeTheirReadyStatus').innerHTML = theirReady ?
      '<span style="color:var(--green);">✅ LOCKED IN</span>' :
      '<span style="color:var(--text2);">⏳ Not locked in</span>';

    if (myReady && theirReady) {
      document.getElementById('liveTradeConfirmArea').style.display = 'block';
      if (_liveTradeIsHost) {
        document.getElementById('liveTradeConfirmArea').innerHTML = '<button onclick="liveTradeExecute()" style="padding:12px 32px;background:linear-gradient(135deg,#ffc107,#ff9800);border:none;border-radius:10px;color:#000;cursor:pointer;font-family:\'Orbitron\';font-size:14px;font-weight:700;">🤝 CONFIRM TRADE</button>';
      } else {
        document.getElementById('liveTradeConfirmArea').innerHTML = '<div style="color:var(--neon);font-family:\'Orbitron\';font-size:12px;padding:12px;">⏳ Waiting for host to confirm...</div>';

      }
    } else {
      document.getElementById('liveTradeConfirmArea').style.display = 'none';
    }
  });
}

function liveTradeAddItem() {
  if (_liveTradeReady) return;
  const sel = document.getElementById('tradeItemSelect');
  const invId = parseInt(sel.value);
  if (!invId) return;

  const item = inventory.find(x => x.id === invId);
  if (!item) return;

  if (_liveTradeMyItems.includes(item.itemId)) {
    showToast('Item already in offer', false);
    return;
  }

  _liveTradeMyItems.push(item.itemId);
  sel.value = '';
  liveTradeUpdateMyDisplay();
  liveTradeSync();
}

function liveTradeRemoveItem(idx) {
  if (_liveTradeReady) return;
  _liveTradeMyItems.splice(idx, 1);
  liveTradeUpdateMyDisplay();
  liveTradeSync();
}

function liveTradeUpdateMyDisplay() {
  const el = document.getElementById('liveTradeMyItems');
  if (_liveTradeMyItems.length === 0) {
    el.textContent = 'No items added';
    return;
  }
  el.innerHTML = _liveTradeMyItems.map((id, i) => {
    const cat = (typeof ITEM_CATALOG !== 'undefined') ? ITEM_CATALOG[id] : null;
    const name = cat ? `${cat.icon} ${cat.name}` : id;
    return `<div style="display:flex;align-items:center;gap:6px;margin-bottom:2px;">${name} <button onclick="liveTradeRemoveItem(${i})" style="padding:1px 6px;background:var(--red);border:none;border-radius:4px;color:#fff;cursor:pointer;font-size:9px;">✕</button></div>`;
  }).join('');
}

function liveTradeUpdateCash() {
  if (_liveTradeReady) return;
  liveTradeSync();
}

async function liveTradeSync() {
  if (!_liveTradeId) return;
  const offerKey = _liveTradeIsHost ? 'hostOffer' : 'guestOffer';
  const cash = Math.max(0, parseBet(document.getElementById('tradeCashAmount').value) || 0);
  await window._fbUpdate('casino/liveTrades/' + _liveTradeId, {
    [offerKey]: {
      items: _liveTradeMyItems.join(','),
      cash: cash
    },
    [_liveTradeIsHost ? 'hostReady' : 'guestReady']: false
  });
  _liveTradeReady = false;
  document.getElementById('liveTradeReadyBtn').textContent = '✅ LOCK IN';
  document.getElementById('liveTradeReadyBtn').style.background = 'linear-gradient(135deg,#00cc66,#009944)';
}

async function liveTradeToggleReady() {
  if (!_liveTradeId) return;
  _liveTradeReady = !_liveTradeReady;
  const key = _liveTradeIsHost ? 'hostReady' : 'guestReady';
  await window._fbUpdate('casino/liveTrades/' + _liveTradeId, { [key]: _liveTradeReady });

  if (_liveTradeReady) {
    document.getElementById('liveTradeReadyBtn').textContent = '🔓 UNLOCK';
    document.getElementById('liveTradeReadyBtn').style.background = 'linear-gradient(135deg,#ff4444,#cc0000)';
  } else {
    document.getElementById('liveTradeReadyBtn').textContent = '✅ LOCK IN';
    document.getElementById('liveTradeReadyBtn').style.background = 'linear-gradient(135deg,#00cc66,#009944)';
  }
}

async function liveTradeExecute() {
  if (!_liveTradeId) return;
  const statusEl = document.getElementById('tradeStatus');
  statusEl.textContent = '⏳ Executing trade...';

  const cash = Math.max(0, parseBet(document.getElementById('tradeCashAmount').value) || 0);
  if (cash > balance) {
    statusEl.textContent = '❌ Not enough balance for $' + cash + ' cash offer!';
    statusEl.style.color = 'var(--red)';
    return;
  }

  const myItemsCopy = [..._liveTradeMyItems];
  for (const itemId of myItemsCopy) {
    const idx = inventory.findIndex(x => x.itemId === itemId);
    if (idx >= 0) inventory.splice(idx, 1);
  }

  if (cash > 0) { balance -= cash; updateBalDisplay(); }

  const res = await window._executeLiveTrade(_liveTradeId);
  if (res.error) {
    statusEl.textContent = '❌ ' + res.error;
    statusEl.style.color = 'var(--red)';

    for (const itemId of myItemsCopy) { addToInventory(itemId); }
    if (cash > 0) { balance += cash; updateBalDisplay(); }
    return;
  }

  statusEl.textContent = '✅ Trade completed!';
  statusEl.style.color = 'var(--green)';
  firebaseSaveNow();

}

async function loadTradeRequests() {
  if (!window._loadTradeRequests) return;
  try {
    const reqs = await window._loadTradeRequests();

    const div = document.getElementById('incomingTrades');
    if (reqs.length > 0) {
      const reqHtml = reqs.map((r, idx) => {
        const dataId = 'tradeReq_' + idx;
        window[dataId] = { requestId: r.id, fromName: r.from, fromUid: r.fromUid };
        return `<div style="background:var(--bg);border:1px solid rgba(0,230,118,.4);border-radius:10px;padding:12px;display:flex;align-items:center;gap:10px;">
          <div style="font-size:28px;">🤝</div>
          <div style="flex:1;min-width:0;">
            <div style="font-weight:700;font-size:13px;color:var(--green);">Trade Request</div>
            <div style="font-size:11px;color:var(--text2);">From <strong style="color:var(--neon);">${r.from}</strong></div>
            <div style="font-size:10px;color:var(--text2);margin-top:2px;">${new Date(r.ts).toLocaleString()}</div>
          </div>
          <div style="display:flex;flex-direction:column;gap:4px;">
            <button onclick="handleTradeResponse('${dataId}', true)" style="padding:6px 14px;background:linear-gradient(135deg,#00cc66,#009944);border:none;border-radius:6px;color:#fff;cursor:pointer;font-size:11px;font-weight:700;font-family:'Orbitron';">ACCEPT</button>
            <button onclick="handleTradeResponse('${dataId}', false)" style="padding:4px 12px;background:transparent;border:1px solid var(--red);border-radius:6px;color:var(--red);cursor:pointer;font-size:10px;">DECLINE</button>
          </div>
        </div>`;
      }).join('');

      const existing = div.innerHTML;
      if (existing.includes('No pending')) div.innerHTML = reqHtml;
      else div.innerHTML = reqHtml + existing;
    }
  } catch(e) {}
}

async function handleTradeResponse(dataId, accepted) {
  const data = window[dataId];
  if (!data) return;
  await respondTradeRequest(data.requestId, data.fromName, data.fromUid, accepted);
}

async function respondTradeRequest(reqId, fromName, fromUid, accepted) {
  if (!window._respondTradeRequest) return;
  await window._respondTradeRequest(reqId, accepted);
  if (accepted) {
    showToast('✅ Accepted! Starting live trade with ' + fromName, true);
    _liveTradePartner = fromName;
    _liveTradeIsHost = false;

    switchTradeTab('send', document.getElementById('tradeSendTab'));
    document.getElementById('tradePartnerName').textContent = fromName;
    tradeGoToStep(3);
    populateTradeSelect();

    let pollCount = 0;
    const pollForLive = setInterval(async () => {
      pollCount++;
      if (pollCount > 60) { clearInterval(pollForLive); showToast('Trade session timeout', false); tradeGoToStep(1); return; }
      try {
        const snap = await window._fbGet('casino/liveTrades');
        if (!snap.exists()) return;
        const trades = snap.val();
        for (const [tid, t] of Object.entries(trades)) {
          if (t.guest === window._currentPlayerId && t.host !== window._currentPlayerId && t.status === 'active' && Date.now() - t.created < 60000) {
            clearInterval(pollForLive);
            _liveTradeId = tid;
            startLiveTradeListener(tid);
            return;
          }
        }
      } catch(e) {}
    }, 1000);
  } else {
    showToast('Declined trade request from ' + fromName, false);
  }
  loadIncomingTrades();
  loadTradeRequests();
}

function switchTradeTab(tab, btn) {
  document.querySelectorAll('#tradePanel .inv-tab').forEach(b => b.classList.remove('active'));
  if(btn) btn.classList.add('active');
  document.getElementById('tradeSendView').style.display = tab === 'send' ? 'block' : 'none';
  document.getElementById('tradeInboxView').style.display = tab === 'inbox' ? 'block' : 'none';
  document.getElementById('tradeHistoryView').style.display = tab === 'history' ? 'block' : 'none';
  document.getElementById('giftView').style.display = tab === 'gift' ? 'block' : 'none';
  if (tab === 'send') tradeGoToStep(1);
  if (tab === 'inbox') { loadIncomingTrades(); loadTradeRequests(); }
  if (tab === 'history') renderTradeHistory();
  if (tab === 'gift') { document.getElementById('giftUsername').focus(); }
}

function quickGiftAmount(amt) {
  document.getElementById('giftAmount').value = amt;
}

async function sendGift() {
  const statusEl = document.getElementById('giftStatus');
  const usernameEl = document.getElementById('giftUsername');
  const amountEl = document.getElementById('giftAmount');

  const username = usernameEl.value.trim();
  const amount = parseBet(amountEl.value);

  if (!username) {
    statusEl.textContent = '❌ Please enter a username';
    statusEl.style.color = 'var(--red)';
    return;
  }

  if (!amount || amount < 1) {
    statusEl.textContent = '❌ Invalid amount (minimum $1)';
    statusEl.style.color = 'var(--red)';
    return;
  }

  statusEl.textContent = '⏳ Processing gift...';
  statusEl.style.color = 'var(--text2)';

  const result = await window._giftMoney(username, amount);

  if (result.error) {
    statusEl.textContent = '❌ ' + result.error;
    statusEl.style.color = 'var(--red)';
  } else {
    statusEl.textContent = '✅ Gift sent! Your balance: $' + Math.floor(result.newBalance);
    statusEl.style.color = 'var(--green)';
    usernameEl.value = '';
    amountEl.value = '';
    showToast('💝 Sent $' + Math.floor(amount) + ' to ' + username + '!', true);

    balance = result.newBalance; updateBalDisplay(); firebaseSave();
    setTimeout(() => {
      statusEl.textContent = '';
    }, 3000);
  }
}

function openLoanOverlay() { showToast('Loans have been removed!', false); }
function closeLoanOverlay() {}
function switchLoanTab() {}
function takeBankLoan() { showToast('Loans have been removed!', false); }
function enforceBankLoanRepayment() {}
function repayLoan() {}
function sendPlayerLoan() {}
function loadMyLoans() {}

function populateTradeSelect() {
  const sel = document.getElementById('tradeItemSelect');
  if (!sel) return;
  sel.innerHTML = '<option value="">Select an item...</option>';
  inventory.forEach(item => {
    const cat = ITEM_CATALOG ? ITEM_CATALOG[item.itemId] : null;
    const name = cat ? (cat.icon + ' ' + cat.name) : item.itemId;
    const val = typeof getItemMarketValue === 'function' ? getItemMarketValue(item.itemId) : 0;
    sel.innerHTML += '<option value="' + item.id + '">' + name + ' ($' + val.toFixed(0) + ')</option>';
  });
  sel.onchange = updateTradePreview;
}

function updateTradePreview() {
  const sel = document.getElementById('tradeItemSelect');
  const preview = document.getElementById('tradeItemPreview');
  const invId = parseInt(sel.value);
  if (!invId) { preview.innerHTML = '<div style="color:var(--text2);font-size:12px;">Select an item above</div>'; updateTradeSummary(); return; }
  const item = inventory.find(x => x.id === invId);
  if (!item) { preview.innerHTML = '<div style="color:var(--red);font-size:12px;">Item not found</div>'; return; }
  const cat = ITEM_CATALOG[item.itemId];
  if (!cat) { preview.innerHTML = '<div style="color:var(--text2);">Unknown</div>'; return; }
  const val = typeof getItemMarketValue === 'function' ? getItemMarketValue(item.itemId) : cat.baseValue;
  const rar = RARITY[cat.rarity];
  preview.innerHTML = '<div style="font-size:36px;">' + cat.icon + '</div>'
    + '<div style="font-weight:700;font-size:14px;color:' + rar.color + ';">' + cat.name + '</div>'
    + '<div style="font-size:10px;color:' + rar.color + ';letter-spacing:1px;">' + rar.label.toUpperCase() + '</div>'
    + '<div style="font-family:Orbitron;font-size:16px;color:var(--gold);margin-top:4px;">$' + val.toFixed(2) + '</div>'
    + '<div style="height:3px;width:100%;background:' + rar.color + ';border-radius:2px;margin-top:4px;opacity:.6;"></div>';
  updateTradeSummary();
}

function updateTradeSummary() {
  const summary = document.getElementById('tradeSummary');
  if (!summary) return;
  const invId = parseInt((document.getElementById('tradeItemSelect') || {}).value || '0');
  const cash = parseFloat((document.getElementById('tradeCashAmount') || {}).value || '0') || 0;
  if (!invId && cash <= 0) { summary.innerHTML = '<div style="color:var(--text2);font-size:11px;text-align:center;">Select items above</div>'; return; }
  let html = '<div style="font-size:11px;color:var(--text2);margin-bottom:6px;">TRADE SUMMARY</div>';
  if (invId) {
    const item = inventory.find(x => x.id === invId);
    const cat = item ? ITEM_CATALOG[item.itemId] : null;
    if (cat) {
      const val = typeof getItemMarketValue === 'function' ? getItemMarketValue(item.itemId) : cat.baseValue;
      html += '<div style="display:flex;align-items:center;gap:6px;margin-bottom:4px;"><span style="font-size:16px;">' + cat.icon + '</span><span style="font-size:12px;font-weight:600;">' + cat.name + '</span><span style="font-size:11px;color:var(--gold);margin-left:auto;">$' + val.toFixed(0) + '</span></div>';
    }
  }
  if (cash > 0) html += '<div style="display:flex;align-items:center;gap:6px;margin-bottom:4px;"><span style="font-size:16px;">💵</span><span style="font-size:12px;font-weight:600;">Cash</span><span style="font-size:11px;color:var(--gold);margin-left:auto;">$' + cash.toFixed(0) + '</span></div>';
  html += '<div style="font-size:11px;color:var(--text2);margin-top:6px;border-top:1px solid var(--border);padding-top:6px;">To: <strong style="color:var(--neon);">' + _tradePartner + '</strong></div>';
  summary.innerHTML = html;
}

setTimeout(() => {
  ['tradeCashAmount'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.addEventListener('input', updateTradeSummary);
  });
}, 100);

async function sendTrade() {
  const invId = parseInt(document.getElementById('tradeItemSelect').value);
  const cash = parseBet(document.getElementById('tradeCashAmount').value) || 0;
  const message = (document.getElementById('tradeMessage') || {}).value || '';
  const status = document.getElementById('tradeStatus');
  if (!_tradePartner) { status.textContent = '⚠ No trade partner'; status.style.color = 'var(--red)'; return; }
  if (!invId && cash <= 0) { status.textContent = '⚠ Select an item or add cash'; status.style.color = 'var(--red)'; return; }
  if (cash > balance) { status.textContent = '⚠ Not enough balance'; status.style.color = 'var(--red)'; return; }
  if (!window._sendTradeOffer) { status.textContent = '⚠ Not logged in'; status.style.color = 'var(--red)'; return; }
  status.textContent = '⏳ Sending...';
  try {
    const item = invId ? inventory.find(x => x.id === invId) : null;
    if (invId && !item) throw new Error('Item not found');
    const res = await window._sendTradeOffer(_tradePartner, item || { itemId: '_cash_' }, cash, message.trim());
    if (res.error) throw new Error(res.error);
    if (item) removeFromInventory(invId);
    if (cash > 0) { balance -= cash; updateBalDisplay(); }
    const cat = item ? ITEM_CATALOG[item.itemId] : null;
    tradeHistory.unshift({ type: 'sent', to: _tradePartner, itemName: cat ? cat.name : (cash > 0 ? 'Cash' : 'Unknown'), itemIcon: cat ? cat.icon : '💵', cash, message: message.trim(), ts: Date.now() });
    if (tradeHistory.length > 50) tradeHistory = tradeHistory.slice(0, 50);
    try { localStorage.setItem('casino_trade_history', JSON.stringify(tradeHistory)); } catch(e) {}
    renderInventory(); populateTradeSelect();
    status.textContent = '✅ Sent to ' + _tradePartner + '!';
    status.style.color = 'var(--green)';
    showToast('📦 Trade sent to ' + _tradePartner, true);
    firebaseSave();

    setTimeout(() => { tradeGoToStep(1); }, 2000);
  } catch(e) { status.textContent = '❌ ' + (e.message || 'Failed'); status.style.color = 'var(--red)'; }
}

async function loadIncomingTrades() {
  const div = document.getElementById('incomingTrades');
  const countBadge = document.getElementById('tradeInboxCount');
  if (!window._loadPendingTrades) { div.innerHTML = '<div style="color:var(--text2);font-size:12px;text-align:center;padding:20px;">Login to see trades</div>'; return; }
  try {
    const trades = await window._loadPendingTrades();
    if (!trades || trades.length === 0) {
      div.innerHTML = '<div style="color:var(--text2);font-size:12px;text-align:center;padding:20px;">No pending trades</div>';
      if (countBadge) countBadge.style.display = 'none';
      return;
    }
    if (countBadge) { countBadge.style.display = 'inline'; countBadge.textContent = trades.length; }
    div.innerHTML = trades.map(t => {
      const cat = ITEM_CATALOG[t.itemId];
      const icon = cat ? cat.icon : '📦';
      const itemName = cat ? cat.name : (t.itemName || t.itemId);
      const rar = cat ? RARITY[cat.rarity] : null;
      const val = cat && typeof getItemMarketValue === 'function' ? getItemMarketValue(t.itemId) : 0;
      const cashPart = t.cash ? ' + $' + t.cash.toFixed(0) + ' cash' : '';
      const safeName = escapeHtml(t.from || 'Unknown');
      const safeMsg = t.message ? escapeHtml(t.message) : '';
      return '<div style="background:var(--bg);border:1px solid ' + (rar ? rar.color : 'var(--border)') + ';border-radius:10px;padding:12px;display:flex;align-items:center;gap:10px;">'
        + '<div style="font-size:28px;">' + icon + '</div>'
        + '<div style="flex:1;min-width:0;"><div style="font-weight:700;font-size:13px;color:' + (rar ? rar.color : 'var(--text)') + ';">' + escapeHtml(itemName) + cashPart + '</div>'
        + '<div style="font-size:11px;color:var(--text2);">From <strong style="color:var(--neon);">' + safeName + '</strong></div>'
        + (safeMsg ? '<div style="font-size:10px;color:var(--text2);font-style:italic;margin-top:2px;">"' + safeMsg + '"</div>' : '')
        + '<div style="font-size:10px;color:var(--text2);margin-top:2px;">' + (val > 0 ? 'Value: $' + val.toFixed(0) : '') + ' · ' + new Date(t.timestamp).toLocaleString() + '</div></div>'
        + '<div style="display:flex;flex-direction:column;gap:4px;">'
        + '<button onclick="acceptTrade(\'' + t.id + '\',\'' + t.itemId + '\',' + (t.cash || 0) + ')" style="padding:6px 14px;background:linear-gradient(135deg,#00cc66,#009944);border:none;border-radius:6px;color:#fff;cursor:pointer;font-size:11px;font-weight:700;font-family:Orbitron;">ACCEPT</button>'
        + '<button onclick="declineTrade(\'' + t.id + '\')" style="padding:4px 12px;background:transparent;border:1px solid var(--red);border-radius:6px;color:var(--red);cursor:pointer;font-size:10px;">DECLINE</button></div></div>';
    }).join('');
  } catch(e) { div.innerHTML = '<div style="color:var(--red);font-size:12px;text-align:center;padding:20px;">Error loading trades</div>'; }
}

async function acceptTrade(tradeId, itemId, cash) {
  if (!window._acceptTradeOffer) return;
  try {
    await window._acceptTradeOffer(tradeId);
    if (itemId && itemId !== '_cash_') addToInventory(itemId);
    if (cash > 0) { balance += cash; updateBalDisplay(); }
    const cat = ITEM_CATALOG[itemId];
    tradeHistory.unshift({ type: 'received', itemName: cat ? cat.name : (cash > 0 ? 'Cash' : 'Unknown'), itemIcon: cat ? cat.icon : '💵', cash: cash || 0, ts: Date.now() });
    if (tradeHistory.length > 50) tradeHistory = tradeHistory.slice(0, 50);
    try { localStorage.setItem('casino_trade_history', JSON.stringify(tradeHistory)); } catch(e) {}
    renderInventory(); loadIncomingTrades();
    showToast('📦 Trade accepted!' + (cash > 0 ? ' +$' + cash.toFixed(0) : ''), true);
    firebaseSave();
  } catch(e) { showToast('Error accepting trade', false); }
}

async function declineTrade(tradeId) {
  if (!window._declineTradeOffer && !window._acceptTradeOffer) return;
  try {
    if (window._declineTradeOffer) {
      await window._declineTradeOffer(tradeId);
    } else {
      showToast('Decline function unavailable', false);
      return;
    }
    loadIncomingTrades();
    showToast('Trade declined — items returned to sender', false);
  } catch(e) { showToast('Error declining trade', false); }
}

function renderTradeHistory() {
  const div = document.getElementById('tradeHistoryList');
  if (!tradeHistory.length) { div.innerHTML = '<div style="color:var(--text2);font-size:12px;text-align:center;padding:20px;">No trade history yet</div>'; return; }
  div.innerHTML = tradeHistory.slice(0, 30).map(t => {
    const isSent = t.type === 'sent';
    return '<div style="display:flex;align-items:center;gap:8px;padding:8px;background:var(--bg);border:1px solid var(--border);border-radius:8px;">'
      + '<span style="font-size:16px;">' + (isSent ? '📤' : '📥') + '</span>'
      + '<span style="font-size:16px;">' + (t.itemIcon || '📦') + '</span>'
      + '<div style="flex:1;min-width:0;"><div style="font-size:12px;font-weight:600;">' + escapeHtml(t.itemName) + (t.cash > 0 ? ' + $' + t.cash.toFixed(0) : '') + '</div>'
      + '<div style="font-size:10px;color:var(--text2);">' + (isSent ? 'Sent to ' + escapeHtml(t.to || '?') : 'Received') + ' · ' + new Date(t.ts).toLocaleDateString() + '</div></div>'
      + '<span style="font-size:10px;color:' + (isSent ? 'var(--red)' : 'var(--green)') + ';font-weight:700;">' + (isSent ? 'SENT' : 'RECEIVED') + '</span></div>';
  }).join('');
}

let storeListType = 'fixed';

function switchStoreTab(tab, btn) {
  document.querySelectorAll('#storePanel .inv-tab').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  ['Browse', 'List', 'My', 'Sales'].forEach(v => {
    const el = document.getElementById('store' + v + 'View');
    if (el) el.style.display = 'none';
  });
  const target = document.getElementById('store' + tab.charAt(0).toUpperCase() + tab.slice(1) + 'View');
  if (target) target.style.display = 'block';
  if (tab === 'browse') loadStoreListings();
  if (tab === 'list') storePopulateListSelect();
  if (tab === 'my') loadMyListings();
  if (tab === 'sales') loadStoreSales();
}

function storeSetType(type) {
  storeListType = type;
  document.getElementById('storeTypeFixed').className = 'inv-tab' + (type === 'fixed' ? ' active' : '');
  document.getElementById('storeTypeAuction').className = 'inv-tab' + (type === 'auction' ? ' active' : '');
  document.getElementById('storeFixedFields').style.display = type === 'fixed' ? 'block' : 'none';
  document.getElementById('storeAuctionFields').style.display = type === 'auction' ? 'block' : 'none';
}

function storePopulateListSelect() {
  const sel = document.getElementById('storeListItemSelect');
  if (!sel) return;
  sel.innerHTML = '<option value="">Select an item...</option>';
  inventory.forEach(item => {
    const cat = ITEM_CATALOG ? ITEM_CATALOG[item.itemId] : null;
    const name = cat ? (cat.icon + ' ' + cat.name) : item.itemId;
    const val = typeof getItemMarketValue === 'function' ? getItemMarketValue(item.itemId) : 0;
    sel.innerHTML += '<option value="' + item.id + '">' + name + ' ($' + val.toFixed(0) + ')</option>';
  });
}

function storeUpdateListPreview() {
  const sel = document.getElementById('storeListItemSelect');
  const preview = document.getElementById('storeListItemPreview');
  const mRef = document.getElementById('storeMarketRef');
  const invId = parseInt(sel.value);
  if (!invId) { preview.innerHTML = '<div style="color:var(--text2);font-size:12px;">Select an item from your inventory</div>'; if (mRef) mRef.textContent = 'Market value: —'; return; }
  const item = inventory.find(x => x.id === invId);
  if (!item) return;
  const cat = ITEM_CATALOG[item.itemId];
  if (!cat) return;
  const val = typeof getItemMarketValue === 'function' ? getItemMarketValue(item.itemId) : cat.baseValue;
  const rar = RARITY[cat.rarity];
  preview.innerHTML = '<div style="font-size:40px;">' + cat.icon + '</div><div style="font-weight:700;font-size:14px;color:' + rar.color + ';">' + cat.name + '</div><div style="font-size:10px;color:' + rar.color + ';">' + rar.label + '</div><div style="font-family:Orbitron;font-size:14px;color:var(--gold);margin-top:4px;">$' + val.toFixed(0) + '</div>';
  if (mRef) mRef.textContent = 'Market value: $' + val.toFixed(0);
  document.getElementById('storeAskPrice').value = Math.round(val);
  document.getElementById('storeStartBid').value = Math.round(val * 0.7);
}

async function storeListItem() {
  const st = document.getElementById('storeListStatus');
  const invId = parseInt(document.getElementById('storeListItemSelect').value);
  if (!invId) { st.textContent = '⚠ Select an item'; st.style.color = 'var(--red)'; return; }
  const item = inventory.find(x => x.id === invId);
  if (!item) { st.textContent = '⚠ Item not found'; st.style.color = 'var(--red)'; return; }
  if (!window._storeListItem) { st.textContent = '⚠ Not logged in'; st.style.color = 'var(--red)'; return; }
  const cat = ITEM_CATALOG[item.itemId];
  const price = storeListType === 'fixed' ? parseBet(document.getElementById('storeAskPrice').value) : parseBet(document.getElementById('storeStartBid').value);
  if (!price || price < 1) { st.textContent = '⚠ Enter a valid price'; st.style.color = 'var(--red)'; return; }
  st.textContent = '⏳ Listing...';
  try {
    const duration = storeListType === 'auction' ? parseInt(document.getElementById('storeAuctionDuration').value) : 0;
    const res = await window._storeListItem({
      itemId: item.itemId,
      itemName: cat ? cat.name : item.itemId,
      rarity: cat ? cat.rarity : 'consumer',
      type: storeListType,
      price: price,
      duration: duration
    });
    if (res.error) throw new Error(res.error);
    removeFromInventory(invId);
    renderInventory(); storePopulateListSelect();
    st.textContent = '✅ Listed on store!';
    st.style.color = 'var(--green)';
    showToast('🏪 Item listed on store!', true);
    firebaseSave();
  } catch(e) { st.textContent = '❌ ' + (e.message || 'Failed'); st.style.color = 'var(--red)'; }
}

async function loadStoreListings() {
  const grid = document.getElementById('storeListingsGrid');
  if (!window._storeGetListings) { grid.innerHTML = '<div style="grid-column:1/-1;color:var(--text2);font-size:12px;text-align:center;padding:30px;">Login to browse</div>'; return; }
  grid.innerHTML = '<div style="grid-column:1/-1;color:var(--text2);font-size:12px;text-align:center;padding:30px;">Loading...</div>';
  try {
    let listings = await window._storeGetListings();

    const rarFilter = document.getElementById('storeFilterRarity').value;
    if (rarFilter !== 'all') listings = listings.filter(l => l.rarity === rarFilter);

    const sort = document.getElementById('storeSortBy').value;
    if (sort === 'newest') listings.sort((a, b) => b.listedAt - a.listedAt);
    else if (sort === 'priceAsc') listings.sort((a, b) => (a.type === 'auction' ? a.currentBid : a.price) - (b.type === 'auction' ? b.currentBid : b.price));
    else if (sort === 'priceDesc') listings.sort((a, b) => (b.type === 'auction' ? b.currentBid : b.price) - (a.type === 'auction' ? a.currentBid : a.price));
    else if (sort === 'ending') listings = listings.filter(l => l.type === 'auction').sort((a, b) => a.endsAt - b.endsAt);
    if (listings.length === 0) { grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;"><div style="font-size:48px;margin-bottom:12px;">🏪</div><div style="font-size:14px;font-weight:700;color:var(--text);margin-bottom:6px;">Marketplace is Empty</div><div style="font-size:12px;color:var(--text2);margin-bottom:16px;">No items listed yet. Be the first to sell something!</div><button onclick="switchStoreTab(\'list\',document.getElementById(\'storeListTab\'))" style="padding:10px 20px;background:linear-gradient(135deg,#00cc66,#009944);border:none;border-radius:8px;color:#fff;cursor:pointer;font-family:Orbitron;font-size:12px;font-weight:700;">📦 List an Item</button></div>'; return; }
    grid.innerHTML = listings.map(l => {
      const cat = ITEM_CATALOG[l.itemId];
      const rar = cat ? RARITY[cat.rarity] : null;
      const icon = cat ? cat.icon : '📦';
      const isAuction = l.type === 'auction';
      const displayPrice = isAuction ? l.currentBid : l.price;
      const timeLeft = isAuction ? Math.max(0, l.endsAt - Date.now()) : 0;
      const timeStr = isAuction ? (timeLeft > 0 ? Math.floor(timeLeft / 60000) + 'm left' : 'ENDED') : '';
      const ended = isAuction && timeLeft <= 0;
      return '<div style="background:var(--bg);border:1px solid ' + (rar ? rar.color : 'var(--border)') + ';border-radius:10px;padding:12px;display:flex;flex-direction:column;align-items:center;gap:6px;position:relative;">'
        + (isAuction ? '<div style="position:absolute;top:6px;right:6px;font-size:9px;padding:2px 6px;background:rgba(136,71,255,.25);border:1px solid rgba(136,71,255,.5);border-radius:4px;color:#8847ff;">🔨 AUCTION</div>' : '')
        + '<div style="font-size:32px;">' + icon + '</div>'
        + '<div style="font-weight:700;font-size:12px;color:' + (rar ? rar.color : 'var(--text)') + ';text-align:center;">' + escapeHtml(l.itemName || l.itemId) + '</div>'
        + (rar ? '<div style="font-size:9px;color:' + rar.color + ';">' + rar.label + '</div>' : '')
        + '<div style="font-family:Orbitron;font-size:14px;color:var(--gold);">$' + formatBalance(displayPrice) + '</div>'
        + '<div style="font-size:10px;color:var(--text2);">by ' + escapeHtml(l.seller) + '</div>'
        + (isAuction && l.highBidder ? '<div style="font-size:9px;color:var(--neon);">High bid: ' + l.highBidder + '</div>' : '')
        + (timeStr ? '<div style="font-size:9px;color:' + (ended ? 'var(--red)' : 'var(--green)') + ';">' + timeStr + '</div>' : '')
        + '<div style="width:100%;margin-top:4px;">'
        + (isAuction && !ended
          ? '<div style="display:flex;gap:4px;"><input type="text" id="bid_' + l.id + '" placeholder="Bid..." min="' + (displayPrice + 1) + '" style="flex:1;padding:6px;background:var(--surface);border:1px solid var(--border);border-radius:4px;color:var(--gold);font-size:11px;font-family:Orbitron;"><button onclick="storeBid(\'' + l.id + '\')" style="padding:6px 10px;background:linear-gradient(135deg,#8847ff,#6b2fd9);border:none;border-radius:4px;color:#fff;cursor:pointer;font-size:10px;font-weight:700;">BID</button></div>'
          : (isAuction && ended
            ? '<button onclick="storeClaim(\'' + l.id + '\')" style="width:100%;padding:8px;background:linear-gradient(135deg,#ffd700,#ff9900);border:none;border-radius:6px;color:#000;cursor:pointer;font-size:11px;font-weight:700;">CLAIM</button>'
            : '<button onclick="storeBuy(\'' + l.id + '\','+l.price+')" style="width:100%;padding:8px;background:linear-gradient(135deg,#00cc66,#009944);border:none;border-radius:6px;color:#fff;cursor:pointer;font-size:11px;font-weight:700;font-family:Orbitron;">BUY NOW</button>'))
        + '</div></div>';
    }).join('');
  } catch(e) {
    console.error('Store load error:', e);
    const isPermErr = (e.message || '').toLowerCase().includes('permission');
    grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:30px;">'
      + '<div style="font-size:36px;margin-bottom:8px;">' + (isPermErr ? '🔒' : '⚠️') + '</div>'
      + '<div style="color:var(--red);font-size:14px;font-weight:700;margin-bottom:8px;">' + (isPermErr ? 'Database Rules Need Updating' : 'Error Loading Marketplace') + '</div>'
      + '<div style="color:var(--text2);font-size:11px;margin-bottom:12px;">' + (e.message || 'Unknown error') + '</div>'
      + (isPermErr ? '<div style="text-align:left;background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:12px;margin:0 auto;max-width:400px;margin-bottom:12px;">'
        + '<div style="font-size:11px;font-weight:700;color:var(--gold);margin-bottom:6px;">Go to Firebase Console → Realtime Database → Rules</div>'
        + '<div style="font-size:11px;color:var(--text2);margin-bottom:6px;">Set your rules to:</div>'
        + '<pre style="background:#111;border:1px solid #333;border-radius:4px;padding:8px;color:#00e676;font-size:10px;overflow-x:auto;white-space:pre;">{\n  "rules": {\n    "casino": {\n      ".read": true,\n      ".write": "auth != null"\n    }\n  }\n}</pre>'
        + '<div style="font-size:10px;color:var(--text2);margin-top:4px;">This allows anyone to read game data, but only logged-in users can write.</div></div>' : '')
      + '<button onclick="loadStoreListings()" style="padding:8px 16px;background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--neon);cursor:pointer;font-size:11px;font-family:Orbitron;">🔄 Retry</button>'
      + '</div>';
  }
}
function renderStoreListings() { loadStoreListings(); }

async function storeBuy(listingId, price) {
  if (!confirm('Buy this item for $' + formatBalance(price) + '?')) return;
  if(price > balance){ showToast('Not enough balance!', false); return; }
  try {
    const res = await window._storeBuyItem(listingId);
    if (res.error) { showToast(res.error, false); return; }
    const actualPrice = res.item.price || price;
    balance -= actualPrice; updateBalDisplay();
    addToInventory(res.item.itemId);
    showToast('🛒 Purchased ' + (res.item.itemName || 'item') + '!', true);
    loadStoreListings(); renderInventory(); firebaseSave();
  } catch(e) { showToast('Purchase failed', false); }
}

async function storeBid(listingId) {
  const bidInput = document.getElementById('bid_' + listingId);
  const amount = parseBet(bidInput ? bidInput.value : 0);
  if (!amount || amount < 1) { showToast('Enter a valid bid', false); return; }
  if (amount > balance) { showToast('Not enough balance!', false); return; }
  try {
    const res = await window._storePlaceBid(listingId, amount);
    if (res.error) { showToast(res.error, false); return; }
    balance -= amount; updateBalDisplay();

    if (res.oldBid > 0 && res.oldBidderUid === (window._currentPlayerId || '')) {
      balance += res.oldBid; updateBalDisplay();
    }
    showToast('🔨 Bid placed: $' + amount.toLocaleString(), true);
    loadStoreListings(); firebaseSave();
  } catch(e) { showToast('Bid failed', false); }
}

async function storeClaim(listingId) {
  try {
    const res = await window._storeClaimAuction(listingId);
    if (res.error) { showToast(res.error, false); return; }
    if (res.noBids) {
      addToInventory(res.item.itemId);
      showToast('No bids — item returned to inventory', true);
    } else {

      if (res.item.sellerUid === (window._currentPlayerId || '')) {
        showToast('💰 Auction sold for $' + res.item.currentBid.toLocaleString() + '! Payment pending.', true);
      } else {
        showToast('🎉 Won auction: ' + (res.item.itemName || 'item') + '! Item pending.', true);
      }

      checkPendingRefunds();
    }
    loadStoreListings(); renderInventory(); firebaseSave();
  } catch(e) { showToast('Claim failed', false); }
}

async function loadMyListings() {
  const div = document.getElementById('storeMyListings');
  if (!window._storeGetListings) { div.innerHTML = '<div style="color:var(--text2);font-size:12px;text-align:center;padding:20px;">Login first</div>'; return; }
  try {
    const all = await window._storeGetListings();
    const mine = all.filter(l => l.sellerUid === (window._currentPlayerId || ''));
    if (mine.length === 0) { div.innerHTML = '<div style="color:var(--text2);font-size:12px;text-align:center;padding:20px;">No active listings</div>'; return; }
    div.innerHTML = mine.map(l => {
      const cat = ITEM_CATALOG[l.itemId];
      const rar = cat ? RARITY[cat.rarity] : null;
      const isAuction = l.type === 'auction';
      const ended = isAuction && Date.now() > l.endsAt;
      return '<div style="background:var(--bg);border:1px solid ' + (rar ? rar.color : 'var(--border)') + ';border-radius:10px;padding:12px;display:flex;align-items:center;gap:10px;">'
        + '<div style="font-size:28px;">' + (cat ? cat.icon : '📦') + '</div>'
        + '<div style="flex:1;min-width:0;"><div style="font-weight:700;font-size:13px;color:' + (rar ? rar.color : 'var(--text)') + ';">' + escapeHtml(l.itemName || l.itemId) + '</div>'
        + '<div style="font-size:11px;color:var(--text2);">' + (isAuction ? '🔨 Auction' : '💰 Fixed') + ' — $' + (isAuction ? l.currentBid : l.price) + '</div>'
        + (isAuction && l.highBidder ? '<div style="font-size:10px;color:var(--neon);">High bid: ' + l.highBidder + '</div>' : '')
        + (ended ? '<div style="font-size:10px;color:var(--gold);">Auction ended</div>' : '') + '</div>'
        + (ended && isAuction
          ? '<button onclick="storeClaim(\'' + l.id + '\')" style="padding:6px 14px;background:linear-gradient(135deg,#ffd700,#ff9900);border:none;border-radius:6px;color:#000;cursor:pointer;font-size:11px;font-weight:700;">CLAIM</button>'
          : '<button onclick="storeCancelListing(\'' + l.id + '\')" style="padding:6px 14px;background:transparent;border:1px solid var(--red);border-radius:6px;color:var(--red);cursor:pointer;font-size:10px;">CANCEL</button>')
        + '</div>';
    }).join('');
  } catch(e) { div.innerHTML = '<div style="color:var(--red);font-size:12px;text-align:center;padding:20px;">Error</div>'; }
}

async function storeCancelListing(listingId) {
  try {
    const res = await window._storeCancelListing(listingId);
    if (res.error) { showToast(res.error, false); return; }
    addToInventory(res.item.itemId);
    showToast('Listing cancelled — item returned', true);
    loadMyListings(); renderInventory(); firebaseSave();
  } catch(e) { showToast('Cancel failed', false); }
}

async function loadStoreSales() {
  const div = document.getElementById('storeSalesLog');
  if (!window._storeGetSales) { div.innerHTML = '<div style="color:var(--text2);font-size:12px;text-align:center;padding:20px;">Login first</div>'; return; }
  try {
    const sales = await window._storeGetSales();
    if (sales.length === 0) { div.innerHTML = '<div style="color:var(--text2);font-size:12px;text-align:center;padding:20px;">No sales yet</div>'; return; }
    div.innerHTML = sales.map(s => {
      const cat = ITEM_CATALOG[s.itemId];
      const rar = cat ? RARITY[cat.rarity] : null;
      return '<div style="display:flex;align-items:center;gap:8px;padding:8px;background:var(--bg);border:1px solid ' + (rar ? rar.color : 'var(--border)') + ';border-radius:8px;">'
        + '<span style="font-size:16px;">' + (cat ? cat.icon : '📦') + '</span>'
        + '<div style="flex:1;min-width:0;"><div style="font-size:12px;font-weight:600;color:' + (rar ? rar.color : 'var(--text)') +';">' + (s.itemName || s.itemId) + '</div>'
        + '<div style="font-size:10px;color:var(--text2);">' + s.seller + ' → ' + s.buyer + (s.auction ? ' (auction)' : '') + ' · ' + new Date(s.ts).toLocaleDateString() + '</div></div>'
        + '<div style="font-family:Orbitron;font-size:12px;color:var(--gold);">$' + formatBalance(s.price) + '</div></div>';
    }).join('');
  } catch(e) { div.innerHTML = '<div style="color:var(--red);font-size:12px;text-align:center;padding:20px;">Error</div>'; }
}

let _dmUnsub = null;
let _dmPartnerUid = '';
let _dmPartnerName = '';

function showFriendsPanel() {
  playClickSound();
  document.getElementById('friendsOverlay').style.display = 'block';
  loadFriendsList();
  loadFriendRequests();

  if (window._setOnlineStatus) window._setOnlineStatus(true);
}
function hideFriendsPanel() {
  document.getElementById('friendsOverlay').style.display = 'none';
  if (_dmUnsub) { _dmUnsub(); _dmUnsub = null; }
}

function switchFriendsTab(tab, btn) {
  document.querySelectorAll('#friendsOverlay .inv-tab').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  ['Friends','Requests','Add','Blocked','Dm','Privacy'].forEach(v => {
    const el = document.getElementById('frView' + v);
    if (el) el.style.display = 'none';
  });
  const target = document.getElementById('frView' + tab.charAt(0).toUpperCase() + tab.slice(1));
  if (target) target.style.display = 'block';
  if (tab === 'friends') loadFriendsList();
  if (tab === 'requests') loadFriendRequests();
  if (tab === 'blocked') loadBlockedList();
  if (tab === 'dm') loadDMContacts();
  if (tab === 'privacy') loadPrivacySettings();
}

async function loadFriendsList() {
  const div = document.getElementById('frFriendsList');
  const countEl = document.getElementById('frFriendCount');
  if (!window._loadFriendsList) { div.innerHTML = '<div style="color:var(--text2);font-size:12px;text-align:center;padding:20px;">Login to see friends</div>'; return; }
  try {
    const friends = await window._loadFriendsList();
    if (countEl) countEl.textContent = '(' + friends.length + ')';
    if (friends.length === 0) { div.innerHTML = '<div style="color:var(--text2);font-size:12px;text-align:center;padding:20px;">No friends yet — add some!</div>'; return; }

    const presences = await window._getPresenceBatch(friends.map(f => f.uid));
    div.innerHTML = friends.map(f => {
      const p = presences[f.uid] || { online: false, lastSeen: 0 };
      const online = p.online && (Date.now() - (p.lastSeen || 0) < 120000);
      const statusDot = '<span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:' + (online ? '#00e676' : '#555') + ';margin-right:6px;"></span>';
      const lastSeen = !online && p.lastSeen ? 'Last seen ' + timeAgo(p.lastSeen) : (online ? 'Online now' : 'Offline');
      return '<div style="background:var(--bg);border:1px solid ' + (online ? 'rgba(0,230,118,.3)' : 'var(--border)') + ';border-radius:10px;padding:10px 14px;display:flex;align-items:center;gap:10px;">'
        + '<div style="font-size:24px;">👤</div>'
        + '<div style="flex:1;min-width:0;"><div style="font-weight:700;font-size:13px;color:var(--text);">' + statusDot + escapeHtml(f.username) + '</div>'
        + '<div style="font-size:10px;color:' + (online ? 'var(--green)' : 'var(--text2)') + ';">' + lastSeen + '</div></div>'
        + '<div style="display:flex;gap:4px;">'
        + '<button onclick="dmOpenChat(\'' + f.uid + '\',\'' + f.username + '\')" style="padding:5px 10px;background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--neon);cursor:pointer;font-size:10px;" title="Message">💬</button>'
        + '<button onclick="friendGetMutuals(\'' + f.uid + '\',\'' + f.username + '\')" style="padding:5px 10px;background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--text);cursor:pointer;font-size:10px;" title="Mutual friends">👥</button>'
        + '<button onclick="friendRemove(\'' + f.uid + '\',\'' + f.username + '\')" style="padding:5px 10px;background:transparent;border:1px solid var(--red);border-radius:6px;color:var(--red);cursor:pointer;font-size:10px;" title="Remove">✕</button>'
        + '</div></div>';
    }).join('');
  } catch(e) { div.innerHTML = '<div style="color:var(--red);font-size:12px;text-align:center;padding:20px;">Error loading friends</div>'; }
}

function timeAgo(ts) {
  const diff = Date.now() - ts;
  if (diff < 60000) return 'just now';
  if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
  if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
  return Math.floor(diff / 86400000) + 'd ago';
}

async function loadFriendRequests() {
  const div = document.getElementById('frRequestsList');
  const badge = document.getElementById('friendReqBadge');
  const countEl = document.getElementById('frReqCount');
  if (!window._loadFriendRequests) { div.innerHTML = '<div style="color:var(--text2);font-size:12px;text-align:center;padding:20px;">Login first</div>'; return; }
  try {
    const reqs = await window._loadFriendRequests();
    if (badge) { if (reqs.length > 0) { badge.style.display = 'inline'; badge.textContent = reqs.length; } else badge.style.display = 'none'; }
    if (countEl) { if (reqs.length > 0) { countEl.style.display = 'inline'; countEl.textContent = reqs.length; } else countEl.style.display = 'none'; }
    if (reqs.length === 0) { div.innerHTML = '<div style="color:var(--text2);font-size:12px;text-align:center;padding:20px;">No pending requests</div>'; return; }
    div.innerHTML = reqs.map(r => {
      return '<div style="background:var(--bg);border:1px solid rgba(0,230,118,.3);border-radius:10px;padding:10px 14px;display:flex;align-items:center;gap:10px;">'
        + '<div style="font-size:24px;">📩</div>'
        + '<div style="flex:1;"><div style="font-weight:700;font-size:13px;color:var(--neon);">' + escapeHtml(r.from) + '</div>'
        + '<div style="font-size:10px;color:var(--text2);">' + new Date(r.ts).toLocaleString() + '</div></div>'
        + '<button onclick="friendAcceptReq(\'' + r.uid + '\',\'' + r.from + '\')" style="padding:6px 14px;background:linear-gradient(135deg,#00cc66,#009944);border:none;border-radius:6px;color:#fff;cursor:pointer;font-size:11px;font-weight:700;">ACCEPT</button>'
        + '<button onclick="friendDeclineReq(\'' + r.uid + '\')" style="padding:5px 10px;background:transparent;border:1px solid var(--red);border-radius:6px;color:var(--red);cursor:pointer;font-size:10px;">✕</button>'
        + '</div>';
    }).join('');
  } catch(e) { div.innerHTML = '<div style="color:var(--red);font-size:12px;text-align:center;padding:20px;">Error</div>'; }
}

async function friendAcceptReq(fromUid, fromName) {
  await window._acceptFriendRequest(fromUid, fromName);
  showToast('👥 Now friends with ' + fromName + '!', true);
  loadFriendRequests(); loadFriendsList();
}
async function friendDeclineReq(fromUid) {
  await window._declineFriendRequest(fromUid);
  showToast('Request declined');
  loadFriendRequests();
}

async function friendSendRequest() {
  const inp = document.getElementById('frAddInput');
  const st = document.getElementById('frAddStatus');
  const u = inp.value.trim().toLowerCase();
  if (!u) { st.textContent = 'Enter a username'; st.style.color = 'var(--red)'; return; }
  if (!window._sendFriendRequest) { st.textContent = 'Login first'; st.style.color = 'var(--red)'; return; }
  st.textContent = '⏳ Sending...';
  try {
    const res = await window._sendFriendRequest(u);
    if (res.error) { st.textContent = '❌ ' + res.error; st.style.color = 'var(--red)'; return; }
    st.textContent = '✅ Request sent to ' + u + '!';
    st.style.color = 'var(--green)';
    inp.value = '';
  } catch(e) { st.textContent = '❌ Error'; st.style.color = 'var(--red)'; }
}

async function friendBlockPlayer() {
  const inp = document.getElementById('frBlockInput');
  const st = document.getElementById('frBlockStatus');
  const u = inp.value.trim().toLowerCase();
  if (!u) { st.textContent = 'Enter a username'; st.style.color = 'var(--red)'; return; }
  if (!window._blockPlayer) { st.textContent = 'Login first'; st.style.color = 'var(--red)'; return; }
  if (!confirm('Block ' + u + '? This will also remove them as a friend.')) return;
  st.textContent = '⏳ Blocking...';
  try {
    const res = await window._blockPlayer(u);
    if (res.error) { st.textContent = '❌ ' + res.error; st.style.color = 'var(--red)'; return; }
    st.textContent = '✅ Blocked ' + u;
    st.style.color = 'var(--green)';
    inp.value = '';
    loadFriendsList();
  } catch(e) { st.textContent = '❌ Error'; st.style.color = 'var(--red)'; }
}

async function friendRemove(uid, name) {
  if (!confirm('Remove ' + name + ' from friends?')) return;
  await window._removeFriend(uid);
  showToast('Removed ' + name + ' from friends');
  loadFriendsList();
}

async function friendGetMutuals(uid, name) {
  if (!window._getMutualFriends) return;
  try {
    const mutuals = await window._getMutualFriends(uid);
    if (mutuals.length === 0) { showToast('No mutual friends with ' + name); return; }
    const names = mutuals.map(m => m.username).join(', ');
    showToast('👥 Mutual friends with ' + name + ': ' + names, true);
  } catch(e) { showToast('Error checking mutuals'); }
}

async function loadBlockedList() {
  const div = document.getElementById('frBlockedList');
  if (!window._loadBlockedList) { div.innerHTML = '<div style="color:var(--text2);font-size:12px;text-align:center;padding:20px;">Login first</div>'; return; }
  try {
    const blocked = await window._loadBlockedList();
    if (blocked.length === 0) { div.innerHTML = '<div style="color:var(--text2);font-size:12px;text-align:center;padding:20px;">No blocked players</div>'; return; }
    div.innerHTML = blocked.map(b => {
      return '<div style="background:var(--bg);border:1px solid rgba(255,55,95,.3);border-radius:10px;padding:10px 14px;display:flex;align-items:center;gap:10px;">'
        + '<div style="font-size:20px;">🚫</div>'
        + '<div style="flex:1;"><div style="font-weight:600;font-size:13px;color:var(--text);">' + b.username + '</div>'
        + '<div style="font-size:10px;color:var(--text2);">Blocked ' + new Date(b.ts).toLocaleDateString() + '</div></div>'
        + '<button onclick="friendUnblock(\'' + b.uid + '\',\'' + b.username + '\')" style="padding:5px 12px;background:transparent;border:1px solid var(--green);border-radius:6px;color:var(--green);cursor:pointer;font-size:10px;">Unblock</button>'
        + '</div>';
    }).join('');
  } catch(e) { div.innerHTML = '<div style="color:var(--red);font-size:12px;text-align:center;padding:20px;">Error</div>'; }
}

async function friendUnblock(uid, name) {
  await window._unblockPlayer(uid);
  showToast('Unblocked ' + name, true);
  loadBlockedList();
}

async function loadDMContacts() {
  const list = document.getElementById('dmContactList');
  const chatView = document.getElementById('dmChatView');
  chatView.style.display = 'none';
  list.style.display = 'flex';
  if (!window._loadFriendsList) { list.innerHTML = '<div style="color:var(--text2);font-size:12px;text-align:center;padding:20px;">Login first</div>'; return; }
  try {
    const friends = await window._loadFriendsList();
    if (friends.length === 0) { list.innerHTML = '<div style="color:var(--text2);font-size:12px;text-align:center;padding:20px;">Add friends to message them</div>'; return; }
    const presences = await window._getPresenceBatch(friends.map(f => f.uid));
    list.innerHTML = friends.map(f => {
      const p = presences[f.uid] || {};
      const online = p.online && (Date.now() - (p.lastSeen || 0) < 120000);
      return '<div onclick="dmOpenChat(\'' + f.uid + '\',\'' + f.username + '\')" style="background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:10px 14px;display:flex;align-items:center;gap:10px;cursor:pointer;transition:border-color .2s;" onmouseover="this.style.borderColor=\'var(--neon)\'" onmouseout="this.style.borderColor=\'var(--border)\'">'
        + '<span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:' + (online ? '#00e676' : '#555') + ';"></span>'
        + '<div style="font-weight:600;font-size:13px;color:var(--text);">' + escapeHtml(f.username) + '</div>'
        + '<div style="margin-left:auto;font-size:10px;color:var(--text2);">' + (online ? '🟢 Online' : 'Offline') + '</div>'
        + '<div style="font-size:14px;">💬</div>'
        + '</div>';
    }).join('');
  } catch(e) { list.innerHTML = '<div style="color:var(--red);font-size:12px;text-align:center;padding:20px;">Error</div>'; }
}

function dmOpenChat(uid, name) {
  _dmPartnerUid = uid;
  _dmPartnerName = name;

  const dmTab = document.getElementById('frTabDM');
  if (dmTab) switchFriendsTab('dm', dmTab);
  document.getElementById('dmContactList').style.display = 'none';
  document.getElementById('dmChatView').style.display = 'block';
  document.getElementById('dmChatPartner').textContent = name;
  document.getElementById('dmMessages').innerHTML = '<div style="color:var(--text2);font-size:12px;text-align:center;">Loading...</div>';

  if (window._getPresence) {
    window._getPresence(uid).then(p => {
      const online = p.online && (Date.now() - (p.lastSeen || 0) < 120000);
      document.getElementById('dmPartnerStatus').innerHTML = '<span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:' + (online ? '#00e676' : '#555') + ';margin-right:4px;"></span>' + (online ? 'Online' : 'Offline');
    });
  }

  if (_dmUnsub) _dmUnsub();
  if (window._listenDirectMessages) {
    _dmUnsub = window._listenDirectMessages(uid, (msgs) => {
      const div = document.getElementById('dmMessages');
      const myId = window._currentPlayerId || '';
      if (msgs.length === 0) { div.innerHTML = '<div style="color:var(--text2);font-size:12px;text-align:center;padding:20px;">No messages yet. Say hi!</div>'; return; }
      div.innerHTML = msgs.slice(-100).map(m => {
        const isMe = m.fromUid === myId;
        return '<div style="display:flex;justify-content:' + (isMe ? 'flex-end' : 'flex-start') + ';">'
          + '<div style="max-width:75%;padding:8px 12px;border-radius:' + (isMe ? '12px 12px 2px 12px' : '12px 12px 12px 2px') + ';background:' + (isMe ? 'linear-gradient(135deg,#00cc66,#009944)' : 'var(--surface2)') + ';color:' + (isMe ? '#fff' : 'var(--text)') + ';font-size:12px;">'
          + '<div>' + escapeHtml(m.text) + '</div>'
          + '<div style="font-size:9px;color:' + (isMe ? 'rgba(255,255,255,.6)' : 'var(--text2)') + ';margin-top:3px;">' + (isMe ? 'You' : escapeHtml(m.from)) + ' · ' + new Date(m.ts).toLocaleTimeString() + '</div>'
          + '</div></div>';
      }).join('');
      div.scrollTop = div.scrollHeight;
    });
  }

  const inp = document.getElementById('dmInput');
  inp.onkeydown = (e) => { if (e.key === 'Enter') dmSendMessage(); };
  inp.focus();
}

function dmBackToList() {
  if (_dmUnsub) { _dmUnsub(); _dmUnsub = null; }
  document.getElementById('dmChatView').style.display = 'none';
  document.getElementById('dmContactList').style.display = 'flex';
  loadDMContacts();
}

async function dmSendMessage() {
  const inp = document.getElementById('dmInput');
  const text = inp.value.trim();
  if (!text) return;
  if (!window._sendDirectMessage) { showToast('Not logged in', false); return; }
  inp.value = '';
  try {
    const res = await window._sendDirectMessage(_dmPartnerUid, _dmPartnerName, text);
    if (res.error) showToast(res.error, false);
  } catch(e) { showToast('Message failed', false); }
}

async function loadPrivacySettings() {
  if (!window._loadPrivacySettings) return;
  try {
    const p = await window._loadPrivacySettings();
    document.getElementById('privFriendRequests').value = p.friendRequests || 'everyone';
    document.getElementById('privDirectMessages').value = p.directMessages || 'friends';
    document.getElementById('privOnlineStatus').value = p.onlineStatus || 'everyone';
    document.getElementById('privTradeRequests').value = p.tradeRequests || 'everyone';
  } catch(e) {}
}

async function savePrivacySettings() {
  const st = document.getElementById('privSaveStatus');
  if (!window._savePrivacySettings) { st.textContent = 'Login first'; st.style.color = 'var(--red)'; return; }
  const settings = {
    friendRequests: document.getElementById('privFriendRequests').value,
    directMessages: document.getElementById('privDirectMessages').value,
    onlineStatus: document.getElementById('privOnlineStatus').value,
    tradeRequests: document.getElementById('privTradeRequests').value
  };
  try {
    await window._savePrivacySettings(settings);
    st.textContent = '✅ Settings saved!';
    st.style.color = 'var(--green)';
    showToast('🔒 Privacy settings saved', true);
  } catch(e) { st.textContent = '❌ Error saving'; st.style.color = 'var(--red)'; }
}

window.addEventListener('load', () => { if (window._setOnlineStatus) window._setOnlineStatus(true); });
window.addEventListener('beforeunload', () => { if (window._setOnlineStatus) window._setOnlineStatus(false); });

const SYMBOLS=['🍒','🍋','🔔','💎','7️⃣','🍀','⭐','👑'];
const SYMBOL_VALUES={'👑':100,'7️⃣':50,'💎':30,'⭐':20,'🔔':15,'🍀':10,'🍋':6,'🍒':4};

const REEL_WEIGHTS=[{sym:'🍒',w:25},{sym:'🍋',w:20},{sym:'🍀',w:16},{sym:'🔔',w:12},{sym:'⭐',w:8},{sym:'💎',w:5},{sym:'7️⃣',w:3},{sym:'👑',w:1}];
const REEL_TOTAL_W=REEL_WEIGHTS.reduce((s,r)=>s+r.w,0);
function weightedSymbol(){let rr=Math.random()*REEL_TOTAL_W;for(const{sym,w}of REEL_WEIGHTS){rr-=w;if(rr<=0)return sym;}return '🍒';}
const REEL_COUNT=5;
const SYM_H=93;
const VISIBLE=3;
let slotsSpinning=false;

function slotsJackpotAnimation(winAmount, symbol, bet) {

  const overlay = document.createElement('div');
  overlay.id = 'slotsJackpotOverlay';
  overlay.style.cssText = 'position:fixed;inset:0;z-index:99999;background:rgba(0,0,0,0);display:flex;align-items:center;justify-content:center;flex-direction:column;pointer-events:auto;transition:background 0.5s;';
  document.body.appendChild(overlay);
  requestAnimationFrame(() => { overlay.style.background = 'rgba(4,8,20,.95)'; });

  playSound(523, 'sine', 0.5, 0.2);
  setTimeout(() => playSound(659, 'sine', 0.5, 0.18), 150);
  setTimeout(() => playSound(784, 'sine', 0.5, 0.15), 300);
  setTimeout(() => playSound(1047, 'sine', 0.8, 0.2), 500);

  const symEl = document.createElement('div');
  symEl.textContent = symbol;
  symEl.style.cssText = 'font-size:20px;opacity:0;transition:all 0.8s cubic-bezier(.2,1,.3,1);transform:scale(0.1);filter:blur(10px);';
  overlay.appendChild(symEl);
  requestAnimationFrame(() => {
    symEl.style.fontSize = '120px';
    symEl.style.opacity = '1';
    symEl.style.transform = 'scale(1)';
    symEl.style.filter = 'blur(0) drop-shadow(0 0 40px rgba(255,215,0,.8))';
  });

  setTimeout(() => {
    const txt = document.createElement('div');
    txt.textContent = '★ JACKPOT ★';
    txt.style.cssText = 'font-family:Orbitron;font-size:0px;font-weight:900;background:linear-gradient(135deg,#ffd700,#ff8c00,#ffd700);-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-shadow:none;opacity:0;transition:all 0.6s cubic-bezier(.2,1,.3,1);letter-spacing:6px;';
    overlay.appendChild(txt);
    requestAnimationFrame(() => {
      txt.style.fontSize = '48px';
      txt.style.opacity = '1';
    });
  }, 1000);

  setTimeout(() => {
    const multEl = document.createElement('div');
    multEl.style.cssText = 'font-family:Orbitron;font-size:36px;font-weight:900;color:#ff4444;margin-top:8px;';
    overlay.appendChild(multEl);

    let count = 1;
    const target = 1000;
    const startT = Date.now();
    const dur = 2000;
    function tick() {
      const elapsed = Date.now() - startT;
      const prog = Math.min(elapsed / dur, 1);

      const eased = 1 - Math.pow(1 - prog, 3);
      count = Math.max(1, Math.floor(eased * target));
      multEl.textContent = count + '× YOUR BET';
      if (prog < 1) requestAnimationFrame(tick);
      else {
        multEl.textContent = '1000× YOUR BET';
        multEl.style.color = '#ffd700';
        multEl.style.textShadow = '0 0 20px rgba(255,215,0,.6)';

        playSound(200, 'sawtooth', 0.4, 0.25);
        setTimeout(() => playSound(150, 'square', 0.3, 0.15), 100);
      }
    }
    tick();
  }, 1500);

  setTimeout(() => {
    const winEl = document.createElement('div');
    winEl.style.cssText = 'font-family:Orbitron;font-size:42px;font-weight:900;color:var(--green);margin-top:16px;opacity:0;transform:scale(0.5);transition:all 0.5s cubic-bezier(.2,1,.3,1);';
    winEl.textContent = '+$' + winAmount.toLocaleString();
    overlay.appendChild(winEl);
    requestAnimationFrame(() => {
      winEl.style.opacity = '1';
      winEl.style.transform = 'scale(1)';
    });

    for (let i = 0; i < 8; i++) {
      setTimeout(() => {
        const x = window.innerWidth * (0.2 + Math.random() * 0.6);
        const y = window.innerHeight * (0.2 + Math.random() * 0.6);
        spawnParticles(x, y, 30);
      }, i * 200);
    }
  }, 3500);

  setTimeout(() => {
    const btn = document.createElement('button');
    btn.textContent = 'COLLECT WINNINGS';
    btn.style.cssText = 'margin-top:24px;padding:16px 40px;font-family:Orbitron;font-size:16px;font-weight:700;background:linear-gradient(135deg,#ffd700,#ff8c00);border:none;border-radius:12px;color:#000;cursor:pointer;letter-spacing:2px;transition:all .2s;opacity:0;transform:translateY(20px);';
    btn.onmouseenter = () => { btn.style.transform = 'scale(1.05)'; btn.style.boxShadow = '0 0 30px rgba(255,215,0,.5)'; };
    btn.onmouseleave = () => { btn.style.transform = 'scale(1)'; btn.style.boxShadow = 'none'; };
    btn.onclick = () => {
      overlay.style.opacity = '0';
      overlay.style.transition = 'opacity 0.3s';
      setTimeout(() => overlay.remove(), 300);
    };
    overlay.appendChild(btn);
    requestAnimationFrame(() => {
      btn.style.opacity = '1';
      btn.style.transform = 'translateY(0)';
    });
    playWinSound();
    showBigWin(winAmount);
  }, 5000);
}

function initSlots(){
  const container=document.getElementById('reelsContainer');
  for(let r=0;r<REEL_COUNT;r++){
    const win=document.createElement('div');win.className='reel-window';
    const strip=document.createElement('div');strip.className='reel-strip';strip.id='reel'+r;
    for(let i=0;i<60;i++){
      const sym=document.createElement('div');sym.className='reel-symbol';
      sym.textContent=weightedSymbol();
      strip.appendChild(sym);
    }
    win.appendChild(strip);container.appendChild(win);
    strip.style.transform='translateY(-'+(28*SYM_H)+'px)';
  }
}

function spinSlots(){
  if(slotsSpinning)return;
  const bet=parseBet(document.getElementById('slotsBet').value)||10;
  if(bet<=0)return;
  if(!checkMaxBet(bet,'Slots'))return;
  if(bet>balance){showToast('Not enough balance!',false);return;}
  slotsSpinning=true;

  const slotsShielded = typeof isShieldActive==='function' && isShieldActive();
  balance-=bet;updateBalDisplay();if(!firebaseSaveBet(bet)){slotsSpinning=false;return;}
  document.getElementById('spinBtn').disabled=true;
  playClickSound();

  const results=[];
  for(let r=0;r<REEL_COUNT;r++) results.push(weightedSymbol());

  for(let r=0;r<REEL_COUNT;r++){
    const strip=document.getElementById('reel'+r);
    const children=strip.children;

    for(let i=0;i<children.length;i++){
      children[i].textContent=weightedSymbol();
    }

    const targetIdx=42+r*2;
    children[targetIdx].textContent=results[r];

    setTimeout(()=>{

      strip.style.transition='none';
      strip.style.transform='translateY(0px)';
      void strip.offsetWidth;

      strip.style.transition='transform '+(1.2+r*0.25)+'s cubic-bezier(.15,.72,.12,1)';
      strip.style.transform='translateY(-'+((targetIdx-1)*SYM_H)+'px)';
      playSound(300+r*50,'square',.04,.03);
    },r*120);
  }

  const totalDuration=1200+REEL_COUNT*250+300;
  setTimeout(()=>{

    const counts={};
    results.forEach(s=>{counts[s]=(counts[s]||0)+1;});
    let maxCount=0,maxSym='';
    for(const[s,c]of Object.entries(counts)){if(c>maxCount){maxCount=c;maxSym=s;}}

    let winAmount=0;
    const isJackpot = maxCount===5;
    if(maxCount>=3){
      const mult=SYMBOL_VALUES[maxSym]||4;
      if(maxCount===3)winAmount=bet*mult;
      else if(maxCount===4)winAmount=bet*mult*5;
      else winAmount=bet*1000;

      winAmount*=getPrestigeMultiplier();

      if(typeof getLuckBonus==='function') winAmount*=getLuckBonus();
      winAmount=Math.round(winAmount*100)/100;
    }

    if(winAmount>0){
      balance+=winAmount;updateBalDisplay();
      if(isJackpot){
        slotsJackpotAnimation(winAmount, maxSym, bet);
      } else {
        showBigWin(winAmount);
        showToast('WIN $'+winAmount.toFixed(2)+'!');
        playWinSound();
        const rect=document.querySelector('.slots-machine').getBoundingClientRect();
        spawnParticles(rect.left+rect.width/2,rect.top+rect.height/2,40+winAmount/10);
      }
    }else{

      if(slotsShielded){ const refund=Math.floor(bet*0.5); balance+=refund; updateBalDisplay(); showToast('🛡️ Shield! -$'+(bet-refund).toFixed(2),false); }
      else{ showToast('-$'+bet.toFixed(2),false); }
      playLoseSound();
    }

    recordGame('slots', bet, winAmount);
    firebaseSaveNow();
    slotsSpinning=false;
    document.getElementById('spinBtn').disabled=false;

    setTimeout(()=>{
      for(let r=0;r<REEL_COUNT;r++){
        const strip=document.getElementById('reel'+r);
        for(let i=0;i<strip.children.length;i++){
          strip.children[i].textContent=weightedSymbol();
        }
        strip.style.transition='none';
        strip.style.transform='translateY(-'+(28*SYM_H)+'px)';
      }
    },400);
  },totalDuration);
}

let crashRunning=false,crashBetAmount=0,crashCashedOut=false;
let crashMultVal=1,crashPoint=0,crashStartTime=0,crashHistory=[];

function resizeCrashCanvas(){
  const c=document.getElementById('crashCanvas');
  if(!c)return;
  c.width=c.offsetWidth*2;c.height=c.offsetHeight*2;
  if(!crashRunning)drawCrashGraph();
}

function drawCrashGraph(){
  const c=document.getElementById('crashCanvas');if(!c)return;
  const ctx=c.getContext('2d');
  const w=c.width,h=c.height;
  ctx.clearRect(0,0,w,h);

  ctx.strokeStyle='rgba(255,255,255,.04)';ctx.lineWidth=1;
  for(let i=1;i<10;i++){
    const y=h*(1-i/10);
    ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(w,y);ctx.stroke();
  }

  if(crashHistory.length<2)return;

  const maxMult=Math.max(...crashHistory.map(p=>p.m),2);

  ctx.beginPath();
  crashHistory.forEach((p,i)=>{
    const x=(i/(crashHistory.length-1||1))*w;
    const y=h-((p.m-1)/Math.max(maxMult-1,.1))*(h*0.82)-h*0.06;
    if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);
  });
  const lastX=w,lastY=h-((crashHistory[crashHistory.length-1].m-1)/Math.max(maxMult-1,.1))*(h*0.82)-h*0.06;
  ctx.lineTo(lastX,h);ctx.lineTo(0,h);ctx.closePath();
  const grad=ctx.createLinearGradient(0,0,0,h);
  const col=crashRunning&&!crashCashedOut?'0,240,255':(crashCashedOut?'0,255,136':'255,51,85');
  grad.addColorStop(0,'rgba('+col+',.2)');grad.addColorStop(1,'rgba('+col+',0)');
  ctx.fillStyle=grad;ctx.fill();

  ctx.beginPath();
  const lineColor=crashRunning&&!crashCashedOut?'#00f0ff':(crashCashedOut?'#00ff88':'#ff3355');
  ctx.strokeStyle=lineColor;ctx.lineWidth=4;ctx.shadowColor=lineColor;ctx.shadowBlur=12;
  crashHistory.forEach((p,i)=>{
    const x=(i/(crashHistory.length-1||1))*w;
    const y=h-((p.m-1)/Math.max(maxMult-1,.1))*(h*0.82)-h*0.06;
    if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);
  });
  ctx.stroke();
  ctx.shadowBlur=0;

  if(crashHistory.length>1){
    const lp=crashHistory[crashHistory.length-1];
    const dx=(1)*w;
    const dy=h-((lp.m-1)/Math.max(maxMult-1,.1))*(h*0.82)-h*0.06;
    ctx.beginPath();ctx.arc(dx,dy,6,0,Math.PI*2);ctx.fillStyle=lineColor;ctx.fill();
    ctx.beginPath();ctx.arc(dx,dy,10,0,Math.PI*2);ctx.strokeStyle=lineColor;ctx.lineWidth=2;
    ctx.globalAlpha=.4;ctx.stroke();ctx.globalAlpha=1;
  }
}

function startCrash(){
  if(crashRunning)return;
  if(Date.now() - (window._lastCrashEnd||0) < 500){showToast('Cooldown! Wait...',false);return;}
  const bet=parseBet(document.getElementById('crashBet').value)||10;
  if(bet<=0)return;
  if(!checkMaxBet(bet,'Crash'))return;
  if(bet>balance){showToast('Not enough balance!',false);return;}
  crashBetAmount=bet;balance-=bet;updateBalDisplay();if(!firebaseSaveBet(bet))return;
  crashCashedOut=false;crashRunning=true;
  window._crashCashoutReady=false;
  setTimeout(()=>{window._crashCashoutReady=true;},200);
  crashMultVal=1;crashHistory=[{t:0,m:1}];

  let rnd = Math.random();
  if (rnd >= 0.99999) rnd = 0.99999;
  crashPoint=1+(0.92/(1-rnd))-0.92;

  if(typeof getLuckBonus==='function'){ const lb=getLuckBonus(); if(lb>1) crashPoint*=lb; }
  if(crashPoint<1.02)crashPoint=1.02;
  if(crashPoint>100)crashPoint=100;
  if(!isFinite(crashPoint))crashPoint=1.02;

  document.getElementById('crashStartBtn').style.display='none';
  document.getElementById('cashoutBtn').style.display='';
  document.getElementById('crashStatus').textContent='Multiplier rising...';
  document.getElementById('crashMultiplier').className='crash-multiplier';

  crashStartTime=performance.now();
  playClickSound();
  animateCrash();
}

function animateCrash(){
  if(!crashRunning)return;
  const elapsed=(performance.now()-crashStartTime)/1000;
  crashMultVal=Math.pow(Math.E,0.06*elapsed*elapsed+0.04*elapsed);
  crashMultVal=Math.round(crashMultVal*100)/100;
  if(crashMultVal<1)crashMultVal=1;
  crashHistory.push({t:elapsed,m:crashMultVal});
  if(crashHistory.length>500)crashHistory.splice(0,crashHistory.length-500);

  document.getElementById('crashMultiplier').textContent=crashMultVal.toFixed(2)+'×';
  drawCrashGraph();

  if(crashMultVal>=crashPoint){
    crashRunning=false;
    window._lastCrashEnd=Date.now();
    document.getElementById('crashMultiplier').textContent=crashPoint.toFixed(2)+'×';
    document.getElementById('crashMultiplier').className='crash-multiplier crashed';
    document.getElementById('crashStatus').textContent='CRASHED at '+crashPoint.toFixed(2)+'×';
    document.getElementById('crashStartBtn').style.display='';
    document.getElementById('cashoutBtn').style.display='none';

    if(!crashCashedOut){
      const crashShielded = typeof isShieldActive==='function' && isShieldActive();
      if(crashShielded){ const refund=Math.floor(crashBetAmount*0.5); balance+=refund; updateBalDisplay(); showToast('🛡️ Shield! -$'+(crashBetAmount-refund).toFixed(2),false); }
      else{ showToast('CRASHED! -$'+crashBetAmount.toFixed(2),false); }
      playLoseSound();
      recordGame('crash', crashBetAmount, 0);
    }
    drawCrashGraph();return;
  }
  requestAnimationFrame(animateCrash);
}

function cashOut(){
  if(!crashRunning||crashCashedOut)return;
  if(!window._crashCashoutReady){showToast('Wait...',false);return;}
  crashCashedOut=true;
  const winnings=Math.round(crashBetAmount*crashMultVal*getPrestigeMultiplier()*100)/100;
  balance+=winnings;updateBalDisplay();
  crashRunning=false;
  window._lastCrashEnd=Date.now();

  document.getElementById('crashStatus').textContent='Cashed out at '+crashMultVal.toFixed(2)+'× — Won $'+winnings.toFixed(2);
  document.getElementById('crashStartBtn').style.display='';
  document.getElementById('cashoutBtn').style.display='none';

  showBigWin(winnings);
  showToast('WIN $'+winnings.toFixed(2)+'!');
  playWinSound();
  spawnParticles(window.innerWidth/2,window.innerHeight/2,40);
  recordGame('crash', crashBetAmount, winnings);
  if (crashMultVal > (gameStats.crash.biggestMultiplier || 0)) gameStats.crash.biggestMultiplier = crashMultVal;
  drawCrashGraph();
  firebaseSaveNow();
}

const ROUL_NUMS=[0,32,15,19,4,21,2,25,17,34,6,27,13,36,11,30,8,23,10,5,24,16,33,1,20,14,31,9,22,18,29,7,28,12,35,3,26];
const RED_NUMS=new Set([1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36]);
let rouletteSpinning=false,rouletteAngle=0,selectedRoulBet=null,rouletteDrawn=false;

function selectRoulBet(type,btn){
  if(rouletteSpinning)return;
  selectedRoulBet=type;playClickSound();
  document.querySelectorAll('.roul-bet-btn').forEach(b=>b.classList.remove('selected'));
  if(btn)btn.classList.add('selected');
}

function drawRouletteWheel(angle){
  rouletteDrawn=true;
  const c=document.getElementById('rouletteCanvas');const ctx=c.getContext('2d');
  const cx=c.width/2,cy=c.height/2,r=c.width/2-10;
  ctx.clearRect(0,0,c.width,c.height);

  const n=ROUL_NUMS.length;
  const sliceAngle=Math.PI*2/n;

  ROUL_NUMS.forEach((num,i)=>{
    const start=angle+i*sliceAngle;const end=start+sliceAngle;
    ctx.beginPath();ctx.moveTo(cx,cy);ctx.arc(cx,cy,r,start,end);ctx.closePath();
    if(num===0)ctx.fillStyle='#00884a';
    else if(RED_NUMS.has(num))ctx.fillStyle='#cc2233';
    else ctx.fillStyle='#1a1a1a';
    ctx.fill();
    ctx.strokeStyle='rgba(255,255,255,.15)';ctx.lineWidth=1;ctx.stroke();

    const ta=start+sliceAngle/2;
    const tx=cx+Math.cos(ta)*(r*0.78);const ty=cy+Math.sin(ta)*(r*0.78);
    ctx.save();ctx.translate(tx,ty);ctx.rotate(ta+Math.PI/2);
    ctx.fillStyle='#fff';ctx.font='bold 11px Inter';ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.fillText(num.toString(),0,0);ctx.restore();
  });

  ctx.beginPath();ctx.arc(cx,cy,r*0.15,0,Math.PI*2);
  const cg=ctx.createRadialGradient(cx,cy,0,cx,cy,r*0.15);
  cg.addColorStop(0,'#2a2a5e');cg.addColorStop(1,'#15153a');
  ctx.fillStyle=cg;ctx.fill();
  ctx.strokeStyle='rgba(255,215,0,.5)';ctx.lineWidth=2;ctx.stroke();

  ctx.beginPath();ctx.arc(cx,cy,r+3,0,Math.PI*2);
  ctx.strokeStyle='rgba(255,215,0,.25)';ctx.lineWidth=5;ctx.stroke();
  ctx.beginPath();ctx.arc(cx,cy,r-1,0,Math.PI*2);
  ctx.strokeStyle='rgba(255,215,0,.15)';ctx.lineWidth=1;ctx.stroke();
}

function spinRoulette(){
  if(rouletteSpinning)return;
  if(!selectedRoulBet){showToast('Select a bet type first!',false);return;}
  const bet=parseBet(document.getElementById('roulBetInput').value)||10;
  if(bet<=0)return;
  if(!checkMaxBet(bet,'Roulette'))return;
  if(bet>balance){showToast('Not enough balance!',false);return;}

  rouletteSpinning=true;

  const lockedBet=selectedRoulBet;

  document.querySelectorAll('.roul-bet-btn').forEach(b=>{b.disabled=true;b.style.pointerEvents='none';});
  balance-=bet;updateBalDisplay();if(!firebaseSaveBet(bet)){rouletteSpinning=false;return;}
  document.getElementById('roulSpinBtn').disabled=true;
  document.getElementById('rouletteResult').textContent='';
  playClickSound();

  const n=ROUL_NUMS.length;
  const winIdx=Math.floor(Math.random()*n);
  const winNum=ROUL_NUMS[winIdx];

  const isActuallyRed=RED_NUMS.has(winNum);
  const isActuallyGreen=winNum===0;
  const sliceAngle=Math.PI*2/n;

  const targetCenter=winIdx*sliceAngle+sliceAngle/2;
  const targetAngle=-Math.PI/2-targetCenter+Math.PI*2*(6+Math.random()*3);
  const startAngle=rouletteAngle;
  const totalRot=targetAngle-startAngle;

  const duration=4500;const st=performance.now();
  let lastTickAngle=startAngle;

  function animWheel(now){
    const elapsed=now-st;const prog=Math.min(elapsed/duration,1);
    const eased=1-Math.pow(1-prog,4);
    const cur=startAngle+totalRot*eased;
    drawRouletteWheel(cur);

    const angleDiff=Math.abs(cur-lastTickAngle);
    if(angleDiff>sliceAngle){
      lastTickAngle=cur;
      if(prog<0.85)playSound(400+Math.random()*200,'sine',.02,.025);
    }

    if(prog<1){requestAnimationFrame(animWheel);}
    else{
      rouletteAngle=cur%(Math.PI*2);
      rouletteSpinning=false;
      document.getElementById('roulSpinBtn').disabled=false;

      document.querySelectorAll('.roul-bet-btn').forEach(b=>{b.disabled=false;b.style.pointerEvents='';});

      const colorLabel=isActuallyGreen?'💚 Green':(isActuallyRed?'🔴 Red':'⚫ Black');
      const colorCSS=isActuallyGreen?'var(--green)':(isActuallyRed?'#ff5555':'#ccc');
      document.getElementById('rouletteResult').innerHTML=
        '<span style="color:'+colorCSS+'">'+winNum+' — '+colorLabel+'</span>';

      let won=false;
      if(lockedBet==='red'&&isActuallyRed)won=true;
      if(lockedBet==='black'&&!isActuallyRed&&!isActuallyGreen)won=true;
      if(lockedBet==='green'&&isActuallyGreen)won=true;
      if(lockedBet==='odd'&&winNum>0&&winNum%2===1)won=true;
      if(lockedBet==='even'&&winNum>0&&winNum%2===0)won=true;
      if(lockedBet==='1-18'&&winNum>=1&&winNum<=18)won=true;
      if(lockedBet==='19-36'&&winNum>=19&&winNum<=36)won=true;

      if(won){
        let payout=lockedBet==='green'?bet*36:bet*2;
        payout=Math.round(payout*getPrestigeMultiplier()*100)/100;

        if(typeof getLuckBonus==='function') payout=Math.round(payout*getLuckBonus()*100)/100;
        balance+=payout;updateBalDisplay();
        showBigWin(payout);
        showToast('WIN $'+payout.toFixed(2)+'!');playWinSound();
        const rect=document.getElementById('rouletteCanvas').getBoundingClientRect();
        spawnParticles(rect.left+rect.width/2,rect.top+rect.height/2,40);
        recordGame('roulette', bet, payout);
        firebaseSaveNow();
      }else{
        const roulShielded = typeof isShieldActive==='function' && isShieldActive();
        if(roulShielded){ const refund=Math.floor(bet*0.5); balance+=refund; updateBalDisplay(); showToast('🛡️ Shield! -$'+(bet-refund).toFixed(2),false); }
        else{ showToast('-$'+bet.toFixed(2),false); }
        playLoseSound();
        recordGame('roulette', bet, 0);
      }
    }
  }
  requestAnimationFrame(animWheel);
}

const RARITY={
  consumer:  {label:'Consumer Grade', color:'#b0c3d9',cls:'rarity-consumer',  tier:0},
  industrial:{label:'Industrial Grade',color:'#5e98d9',cls:'rarity-industrial',tier:1},
  milspec:   {label:'Mil-Spec',       color:'#4b69ff',cls:'rarity-milspec',   tier:2},
  restricted:{label:'Restricted',     color:'#8847ff',cls:'rarity-restricted',tier:3},
  classified:{label:'Classified',     color:'#d32ce6',cls:'rarity-classified',tier:4},
  covert:    {label:'Covert',         color:'#eb4b4b',cls:'rarity-covert',    tier:5},
  legendary: {label:'★ Legendary',    color:'#ffd700',cls:'rarity-legendary', tier:6},
  mythic:    {label:'★★ Mythic',      color:'#ff4500',cls:'rarity-legendary', tier:7},
};

const ITEM_CATALOG={

  rustedCoin:      {id:'rustedCoin',      name:'Rusted Coin',        icon:'🪙', rarity:'consumer',  baseValue:50},
  brokenCompass:   {id:'brokenCompass',   name:'Broken Compass',     icon:'🧭', rarity:'consumer',  baseValue:75},
  driftwood:       {id:'driftwood',       name:'Driftwood Charm',    icon:'🪵', rarity:'consumer',  baseValue:40},
  seaGlass:        {id:'seaGlass',        name:'Sea Glass',          icon:'💠', rarity:'consumer',  baseValue:65},
  coconutShell:    {id:'coconutShell',    name:'Coconut Shell',      icon:'🥥', rarity:'consumer',  baseValue:30},

  bronzeMedallion: {id:'bronzeMedallion', name:'Bronze Medallion',   icon:'🏅', rarity:'industrial',baseValue:250},
  pearlFragment:   {id:'pearlFragment',   name:'Pearl Fragment',     icon:'⚪', rarity:'industrial',baseValue:350},
  corkedBottle:    {id:'corkedBottle',    name:'Corked Bottle',      icon:'🍾', rarity:'industrial',baseValue:300},
  ancientMap:      {id:'ancientMap',      name:'Ancient Map',        icon:'🗺️', rarity:'industrial', baseValue:400},

  silverDagger:    {id:'silverDagger',    name:'Silver Dagger',      icon:'🗡️', rarity:'milspec',   baseValue:1000},
  crystalOrb:      {id:'crystalOrb',      name:'Crystal Orb',        icon:'🔮', rarity:'milspec',   baseValue:1200},
  enchantedRing:   {id:'enchantedRing',   name:'Enchanted Ring',     icon:'💍', rarity:'milspec',   baseValue:1500},
  stormLantern:    {id:'stormLantern',    name:'Storm Lantern',      icon:'🏮', rarity:'milspec',   baseValue:900},

  goldenCompass:   {id:'goldenCompass',   name:'Golden Compass',     icon:'🧭', rarity:'restricted',baseValue:3000},
  dragonScale:     {id:'dragonScale',     name:'Dragon Scale',       icon:'🐉', rarity:'restricted',baseValue:4000},
  phoenixFeather:  {id:'phoenixFeather',  name:'Phoenix Feather',    icon:'🪶', rarity:'restricted',baseValue:3500},
  moonstone:       {id:'moonstone',       name:'Moonstone Gem',      icon:'🌙', rarity:'restricted',baseValue:3200},

  voidShard:       {id:'voidShard',       name:'Void Shard',         icon:'♠️', rarity:'classified',baseValue:8000},
  starforgedBlade: {id:'starforgedBlade', name:'Starforged Blade',   icon:'⚔️', rarity:'classified',baseValue:12000},
  abyssalPearl:    {id:'abyssalPearl',    name:'Abyssal Pearl',      icon:'⚫', rarity:'classified',baseValue:10000},

  dragonheart:     {id:'dragonheart',     name:'Dragonheart',        icon:'❤️‍🔥', rarity:'covert', baseValue:30000},
  etherealCrown:   {id:'etherealCrown',   name:'Ethereal Crown',     icon:'👑', rarity:'covert',    baseValue:40000},
  cosmicDust:      {id:'cosmicDust',      name:'Cosmic Dust',        icon:'✨', rarity:'covert',    baseValue:35000},

  infinityGem:     {id:'infinityGem',     name:'Infinity Gem',       icon:'💎', rarity:'legendary', baseValue:100000},
  islandRelic:     {id:'islandRelic',     name:'Island Relic',       icon:'🏝️', rarity:'legendary', baseValue:200000},
  casinoChip:      {id:'casinoChip',      name:'Casino Royale Chip', icon:'🎰', rarity:'legendary', baseValue:300000},

  obsidianCrown:   {id:'obsidianCrown',   name:'Obsidian Crown',     icon:'🖤', rarity:'legendary', baseValue:1000000},
  solarFlare:      {id:'solarFlare',      name:'Solar Flare',        icon:'☀️', rarity:'legendary', baseValue:3000000},
  voidEngine:      {id:'voidEngine',      name:'Void Engine',        icon:'⚙️', rarity:'legendary', baseValue:10000000},

  worldEater:      {id:'worldEater',      name:'World Eater',        icon:'🌍', rarity:'mythic',    baseValue:50000000},
  tidalForce:      {id:'tidalForce',      name:'Tidal Force',        icon:'🌊', rarity:'mythic',    baseValue:150000000},
  cosmicTear:      {id:'cosmicTear',      name:'Cosmic Tear',        icon:'💧', rarity:'mythic',    baseValue:500000000},
  galaxyHeart:     {id:'galaxyHeart',     name:'Galaxy Heart',       icon:'🫀', rarity:'mythic',    baseValue:2000000000},
  infinityCascade: {id:'infinityCascade', name:'Infinity Cascade',   icon:'♾️', rarity:'mythic',    baseValue:10000000000},
  bigBang:         {id:'bigBang',         name:'Big Bang',           icon:'💥', rarity:'mythic',    baseValue:100000000000},

  eternalFlame:    {id:'eternalFlame',    name:'Eternal Flame',      icon:'🔥', rarity:'mythic',    baseValue:500000000000},
  timeWarp:        {id:'timeWarp',        name:'Time Warp',          icon:'⏳', rarity:'mythic',    baseValue:1000000000000},
  omegaStar:       {id:'omegaStar',       name:'Omega Star',         icon:'⭐', rarity:'mythic',    baseValue:5000000000000},
};

const CASES = [
  { name:'Starter Crate', icon:'📦', price:100, items:[
    {id:'rustedCoin',w:20},{id:'brokenCompass',w:18},{id:'driftwood',w:18},{id:'seaGlass',w:16},
    {id:'coconutShell',w:18},{id:'bronzeMedallion',w:10},{id:'pearlFragment',w:8},{id:'corkedBottle',w:8},
    {id:'ancientMap',w:6},{id:'silverDagger',w:3},{id:'crystalOrb',w:2},{id:'enchantedRing',w:1}
  ]},
  { name:'Explorer Chest', icon:'🧰', price:500, items:[
    {id:'bronzeMedallion',w:15},{id:'pearlFragment',w:14},{id:'corkedBottle',w:14},{id:'ancientMap',w:12},
    {id:'silverDagger',w:10},{id:'crystalOrb',w:8},{id:'enchantedRing',w:7},{id:'stormLantern',w:7},
    {id:'goldenCompass',w:4},{id:'dragonScale',w:3},{id:'phoenixFeather',w:3},{id:'moonstone',w:3}
  ]},
  { name:'Mystic Vault', icon:'🔮', price:2000, items:[
    {id:'silverDagger',w:10},{id:'crystalOrb',w:10},{id:'enchantedRing',w:9},{id:'stormLantern',w:9},
    {id:'goldenCompass',w:8},{id:'dragonScale',w:7},{id:'phoenixFeather',w:7},{id:'moonstone',w:7},
    {id:'voidShard',w:4},{id:'starforgedBlade',w:3},{id:'abyssalPearl',w:3.5},
    {id:'dragonheart',w:1.2},{id:'etherealCrown',w:0.8},{id:'cosmicDust',w:1}
  ]},
  { name:'Legendary Trove', icon:'👑', price:10000, items:[
    {id:'goldenCompass',w:8},{id:'dragonScale',w:8},{id:'phoenixFeather',w:8},{id:'moonstone',w:8},
    {id:'voidShard',w:7},{id:'starforgedBlade',w:6},{id:'abyssalPearl',w:6},
    {id:'dragonheart',w:5},{id:'etherealCrown',w:4},{id:'cosmicDust',w:4.5},
    {id:'infinityGem',w:2},{id:'islandRelic',w:1.2},{id:'casinoChip',w:1}
  ]},
  { name:'Diamond Vault', icon:'💎', price:50000, items:[
    {id:'voidShard',w:10},{id:'starforgedBlade',w:9},{id:'abyssalPearl',w:9},
    {id:'dragonheart',w:8},{id:'etherealCrown',w:7},{id:'cosmicDust',w:7},
    {id:'infinityGem',w:6},{id:'islandRelic',w:4},{id:'casinoChip',w:4},
    {id:'obsidianCrown',w:2.5},{id:'solarFlare',w:1},{id:'voidEngine',w:0.4}
  ]},
  { name:'Whale Chest', icon:'🐋', price:500000, items:[
    {id:'infinityGem',w:10},{id:'islandRelic',w:8},{id:'casinoChip',w:8},
    {id:'obsidianCrown',w:7},{id:'solarFlare',w:5},{id:'voidEngine',w:3},
    {id:'worldEater',w:1.5},{id:'tidalForce',w:0.8},{id:'cosmicTear',w:0.3}
  ]},
  { name:'Cosmic Crate', icon:'🌌', price:5000000, items:[
    {id:'obsidianCrown',w:10},{id:'solarFlare',w:8},{id:'voidEngine',w:6},
    {id:'worldEater',w:5},{id:'tidalForce',w:3},{id:'cosmicTear',w:1.5},
    {id:'galaxyHeart',w:0.5},{id:'infinityCascade',w:0.15}
  ]},
  { name:'Big Bang Box', icon:'💥', price:100000000, items:[
    {id:'voidEngine',w:10},{id:'worldEater',w:8},{id:'tidalForce',w:6},
    {id:'cosmicTear',w:5},{id:'galaxyHeart',w:3},{id:'infinityCascade',w:1.5},
    {id:'bigBang',w:0.5}
  ]},
  { name:'Supernova Vault', icon:'🔆', price:1000000000, items:[
    {id:'worldEater',w:10},{id:'tidalForce',w:8},{id:'cosmicTear',w:7},
    {id:'galaxyHeart',w:5},{id:'infinityCascade',w:3},{id:'bigBang',w:2},
    {id:'eternalFlame',w:0.8},{id:'timeWarp',w:0.3}
  ]},
  { name:'Omega Crate', icon:'🌀', price:25000000000, items:[
    {id:'cosmicTear',w:8},{id:'galaxyHeart',w:7},{id:'infinityCascade',w:5},
    {id:'bigBang',w:4},{id:'eternalFlame',w:2},{id:'timeWarp',w:1.2},
    {id:'omegaStar',w:0.3}
  ]},

  { name:'🔒 LIMITED: Inferno Box', icon:'🌋', price:500000000, limited:true, items:[
    {id:'voidEngine',w:8},{id:'worldEater',w:7},{id:'tidalForce',w:6},{id:'cosmicTear',w:5},
    {id:'galaxyHeart',w:4},{id:'infinityCascade',w:3},{id:'bigBang',w:2},
    {id:'eternalFlame',w:1.5},{id:'timeWarp',w:0.5}
  ]},
  { name:'🔒 LIMITED: Celestial Ark', icon:'🛸', price:10000000000, limited:true, items:[
    {id:'cosmicTear',w:7},{id:'galaxyHeart',w:6},{id:'infinityCascade',w:5},
    {id:'bigBang',w:4},{id:'eternalFlame',w:3},{id:'timeWarp',w:2},
    {id:'omegaStar',w:0.8}
  ]},
  { name:'🔒 LIMITED: God Box', icon:'⚡', price:100000000000, limited:true, items:[
    {id:'galaxyHeart',w:6},{id:'infinityCascade',w:5},{id:'bigBang',w:5},
    {id:'eternalFlame',w:4},{id:'timeWarp',w:3},{id:'omegaStar',w:1.5}
  ]}
];

let inventory = [];
let invIdCounter = Date.now();

function addToInventory(itemId) {
  const cat = ITEM_CATALOG[itemId];
  if (!cat) return;
  invIdCounter++;
  const item = { id: invIdCounter, itemId: itemId, acquiredPrice: getItemMarketValue(itemId), acquiredAt: Date.now() };
  inventory.push(item);

  const d = itemDemand[itemId];
  if (d) { d.supply = (d.supply || 0) + 1; d.mult = Math.max(0.3, d.mult - 0.01); }

  if (window._updateGlobalMarketItem) window._updateGlobalMarketItem(itemId, 'opened', getItemMarketValue(itemId));
}

function removeFromInventory(invId) {
  const idx = inventory.findIndex(x => x.id === invId);
  if (idx === -1) return;
  const item = inventory[idx];
  const d = itemDemand[item.itemId];
  if (d) { d.supply = Math.max(0, d.supply - 1); d.mult = Math.min(3, d.mult + 0.015); }

  const val = getItemMarketValue(item.itemId);
  if (window._updateGlobalMarketItem) window._updateGlobalMarketItem(item.itemId, 'sold', val);
  inventory.splice(idx, 1);
}

function getInventoryValue() {
  return inventory.reduce((s, x) => s + getItemMarketValue(x.itemId), 0);
}

let itemDemand = {};
let globalMarketData = {};

function initDemand() {
  Object.keys(ITEM_CATALOG).forEach(id => {
    if (!itemDemand[id]) itemDemand[id] = { mult: 1, velocity: 0, supply: 0, globalSupply: 0 };
  });
  if (window._initGlobalMarket) window._initGlobalMarket();
}

window._onGlobalMarketUpdate = (data) => {
  globalMarketData = data || {};
  Object.keys(globalMarketData).forEach(id => {
    const gm = globalMarketData[id];
    const d = itemDemand[id];
    if (!d) return;
    d.globalSupply = gm.globalSupply || 0;
    const supplyFactor = Math.max(0.3, 1.5 - d.globalSupply * 0.08);
    d.mult = d.mult * 0.7 + supplyFactor * 0.3;
    d.mult = Math.max(0.3, Math.min(3, d.mult));
    if (gm.lastTradePrice && gm.lastTradeTs && Date.now() - gm.lastTradeTs < 300000) {
      const cat = ITEM_CATALOG[id];
      if (cat && cat.baseValue > 0) {
        const tradeMult = gm.lastTradePrice / cat.baseValue;
        d.mult = d.mult * 0.85 + Math.max(0.3, Math.min(3, tradeMult)) * 0.15;
      }
    }
  });
};

function getItemMarketValue(id) {
  const cat = ITEM_CATALOG[id]; if (!cat) return 0;
  const d = itemDemand[id] || { mult: 1 };
  return Math.round(cat.baseValue * d.mult);
}

function tickDemand() {
  const tick = Math.floor(Date.now() / 5000);
  Object.keys(itemDemand).forEach((id, idx) => {
    const d = itemDemand[id];

    const seed = ((tick * 2654435761) ^ (idx * 340573321)) >>> 0;
    const r = (seed % 1000) / 1000;
    const shift = (r - 0.5) * 0.02;
    d.velocity = d.velocity * 0.9 + shift * 0.1;
    d.mult += d.velocity;

    d.mult += (1 - d.mult) * 0.005;
    d.mult = Math.max(0.3, Math.min(3, d.mult));
  });
}
setInterval(tickDemand, 5000);

let caseStreak = 0, caseOpenTotal = 0, caseBestTier = -1, caseBestName = '—';
let caseRecentUnboxes = [];
let selectedCase = 0, caseOpening = false;

function initCases() {
  initDemand();
  const sel = document.getElementById('caseSelector');
  CASES.forEach((c, i) => {
    const card = document.createElement('div');
    card.className = 'case-card' + (i === 0 ? ' selected' : '') + (c.limited ? ' limited' : '');
    card.innerHTML = '<div class="case-icon">' + c.icon + '</div><div class="case-name">' + c.name + '</div><div class="case-price">$' + formatBalance(c.price) + '</div>';
    card.onclick = () => { selectedCase = i; document.querySelectorAll('.case-card').forEach(x => x.classList.remove('selected')); card.classList.add('selected'); playClickSound(); };
    sel.appendChild(card);
  });
}

function pickWeighted(items) {
  const total = items.reduce((s, i) => s + i.w, 0);
  let r = Math.random() * total;
  for (const item of items) { r -= item.w; if (r <= 0) return item; }
  return items[items.length - 1];
}

function hexToRgb(h) {
  if (!h || h[0] !== '#') return '200,200,200';
  const n = parseInt(h.slice(1), 16);
  return ((n >> 16) & 255) + ',' + ((n >> 8) & 255) + ',' + (n & 255);
}

function pickWeightedWithStreak(items) {
  const streakBonus = Math.min(caseStreak * 0.02, 0.2);
  const adjusted = items.map(it => {
    const cat = ITEM_CATALOG[it.id];
    const tier = cat ? RARITY[cat.rarity].tier : 0;
    const boost = 1 + (tier >= 3 ? streakBonus * tier * 0.3 : 0);
    return { ...it, w: it.w * boost };
  });
  return pickWeighted(adjusted);
}

function updateCaseStats(winCat, winRarity) {
  caseOpenTotal++;

  if (winRarity.tier <= 1) { caseStreak = 0; } else { caseStreak++; }
  const countEl = document.getElementById('caseOpenCount');
  if (countEl) countEl.textContent = caseOpenTotal;
  const streakEl = document.getElementById('caseStreak');
  if (streakEl) streakEl.textContent = caseStreak;
  const bonusEl = document.getElementById('caseStreakBonus');
  if (bonusEl) {
    if (caseStreak >= 3) {
      const bonusPct = Math.min(caseStreak * 2, 20);
      bonusEl.textContent = ' +' + bonusPct + '% luck';
    } else {
      bonusEl.textContent = '';
    }
  }
  if (winRarity.tier > caseBestTier) {
    caseBestTier = winRarity.tier;
    caseBestName = winCat.icon + ' ' + winCat.name;
    const bestEl = document.getElementById('caseBestItem');
    if (bestEl) { bestEl.textContent = caseBestName; bestEl.style.color = winRarity.color; }
  }
  addToCaseRecentFeed(winCat, winRarity);
}

function addToCaseRecentFeed(cat, rar) {
  caseRecentUnboxes.unshift({ icon: cat.icon, name: cat.name, color: rar.color });
  if (caseRecentUnboxes.length > 20) caseRecentUnboxes.pop();
  const feed = document.getElementById('caseRecentFeed');
  if (!feed) return;
  const el = document.createElement('div');
  el.className = 'case-recent-item';
  el.style.borderColor = rar.color;
  el.innerHTML = '<span style="font-size:14px;">' + cat.icon + '</span><span style="color:' + rar.color + ';">' + cat.name + '</span>';
  feed.insertBefore(el, feed.firstChild);
  if (feed.children.length > 15) feed.removeChild(feed.lastChild);
}

function openCase() {
  if (caseOpening) return;
  const c = CASES[selectedCase];
  if(c.price>balance){showToast('Not enough balance!',false);return;}
  caseOpening = true; balance -= c.price; updateBalDisplay();
  document.getElementById('openCaseBtn').disabled = true;
  const quickBtn = document.getElementById('quickOpenBtn');
  if (quickBtn) quickBtn.disabled = true;
  document.getElementById('caseWon').textContent = '';
  document.getElementById('caseWonDetail').textContent = '';
  playClickSound();

  const opener = document.getElementById('caseOpener');
  opener.classList.remove('rare-reveal', 'legendary-reveal');
  const flashEl = document.getElementById('caseFlash');
  if (flashEl) flashEl.style.opacity = '0';

  const strip = document.getElementById('caseStrip');
  strip.innerHTML = ''; strip.style.transition = 'none'; strip.style.transform = 'translateX(0)';

  const winRef = caseStreak >= 3 ? pickWeightedWithStreak(c.items) : pickWeighted(c.items);
  const winCat = ITEM_CATALOG[winRef.id];
  const winRarity = RARITY[winCat.rarity];
  const winPos = 35;
  const totalItems = 50;

  for (let i = 0; i < totalItems; i++) {
    let ref;
    if (i === winPos) {
      ref = winRef;
    } else if (Math.abs(i - winPos) <= 2 && winRarity.tier >= 3 && Math.random() < 0.4) {
      const rareItems = c.items.filter(it => { const ct = ITEM_CATALOG[it.id]; return ct && RARITY[ct.rarity].tier >= Math.max(2, winRarity.tier - 1); });
      ref = rareItems.length > 0 ? rareItems[Math.floor(Math.random() * rareItems.length)] : c.items[Math.floor(Math.random() * c.items.length)];
    } else {
      ref = c.items[Math.floor(Math.random() * c.items.length)];
    }
    const cat = ITEM_CATALOG[ref.id];
    const rar = RARITY[cat.rarity];
    const el = document.createElement('div'); el.className = 'case-item';
    if (i === winPos) el.id = 'caseWinnerItem';
    el.style.borderColor = rar.color;
    el.style.background = 'linear-gradient(180deg,rgba(' + hexToRgb(rar.color) + ',.15),transparent)';
    el.innerHTML = '<div class="item-icon">' + cat.icon + '</div><div class="' + rar.cls + '" style="font-size:10px;">' + cat.name + '</div>'
      + '<div class="item-rarity" style="background:' + rar.color + ';"></div>';
    strip.appendChild(el);
  }

  requestAnimationFrame(() => { requestAnimationFrame(() => {
    const openerW = strip.parentElement.offsetWidth;
    const offset = winPos * 120 - openerW / 2 + 60 + (Math.random() * 60 - 30);
    strip.style.transition = 'transform 4s cubic-bezier(.08,.82,.17,1)';
    strip.style.transform = 'translateX(-' + offset + 'px)';
  }); });

  let ticks = 0;
  const tickI = setInterval(() => {
    const slowdown = Math.max(0.3, 1 - ticks / 60);
    playSound(400 + Math.random() * 500, 'sine', 0.02 * slowdown, 0.04 * slowdown);
    ticks++;
    if (ticks > 55) clearInterval(tickI);
  }, 65);

  setTimeout(() => {
    if (winRarity.tier >= 4 && flashEl) {
      flashEl.style.background = winRarity.color;
      flashEl.style.opacity = '0.3';
      setTimeout(() => flashEl.style.opacity = '0', 300);
    }
  }, 3500);

  setTimeout(() => {
    clearInterval(tickI); caseOpening = false;
    document.getElementById('openCaseBtn').disabled = false;
    if (quickBtn) quickBtn.disabled = false;

    const winEl = document.getElementById('caseWinnerItem');
    if (winEl) winEl.classList.add('highlighted');
    if (winRarity.tier >= 6) opener.classList.add('legendary-reveal');
    else if (winRarity.tier >= 3) opener.classList.add('rare-reveal');

    addToInventory(winRef.id);
    const mktVal = getItemMarketValue(winRef.id);
    const profit = mktVal - c.price;
    const isW = profit >= 0;

    document.getElementById('caseWon').innerHTML =
      '<span class="' + winRarity.cls + '" style="text-shadow:0 0 15px ' + winRarity.color + ';">' + winCat.icon + ' ' + winCat.name + '</span>';
    document.getElementById('caseWonDetail').innerHTML =
      '<span style="color:' + winRarity.color + '">' + winRarity.label + '</span> — Market: <span style="color:var(--gold)">$' + mktVal.toLocaleString() + '</span>'
      + ' <span style="color:' + (isW ? 'var(--green)' : 'var(--red)') + '">(' + (isW ? '+' : '') + ('$' + profit.toLocaleString()) + ')</span>'
      + (caseStreak >= 3 ? ' <span style="color:var(--neon);font-size:10px;">🔥 ' + caseStreak + '× streak!</span>' : '');

    if (winRarity.tier >= 6) {
      showToast('👑 LEGENDARY: ' + winCat.name + '!');
      playWinSound();
      setTimeout(() => { playSound(1047, 'sine', .3, .15); }, 300);
      setTimeout(() => { playSound(1319, 'sine', .4, .12); }, 500);
      spawnParticles(window.innerWidth / 2, window.innerHeight / 2, 150);
      setTimeout(() => spawnParticles(window.innerWidth / 2, window.innerHeight / 3, 80), 300);
      setTimeout(() => spawnParticles(window.innerWidth / 2, window.innerHeight * 2 / 3, 80), 600);
    } else if (winRarity.tier >= 5) {
      showToast('🔥 ' + winRarity.label + ': ' + winCat.name + '!'); playWinSound();
      spawnParticles(window.innerWidth / 2, window.innerHeight / 2, 80 + winRarity.tier * 30);
    } else if (winRarity.tier >= 3) {
      showToast(winCat.icon + ' ' + winCat.name + '!'); playWinSound();
      spawnParticles(window.innerWidth / 2, window.innerHeight / 2, 30);
    } else {
      showToast(winCat.name + ' added to inventory', isW);
      if (!isW) playLoseSound(); else playWinSound();
    }

    updateCaseStats(winCat, winRarity);
    recordGame('cases', c.price, mktVal);
    firebaseSaveNow();
  }, 4300);
}

function quickOpenCase() {
  if (caseOpening) return;
  const c = CASES[selectedCase];
  if(c.price>balance){showToast('Not enough balance!',false);return;}
  caseOpening = true;
  balance -= c.price; updateBalDisplay();
  playClickSound();

  const winRef = caseStreak >= 3 ? pickWeightedWithStreak(c.items) : pickWeighted(c.items);
  const winCat = ITEM_CATALOG[winRef.id];
  const winRarity = RARITY[winCat.rarity];

  addToInventory(winRef.id);
  const mktVal = getItemMarketValue(winRef.id);
  const profit = mktVal - c.price;
  const isW = profit >= 0;

  document.getElementById('caseWon').innerHTML =
    '<span class="' + winRarity.cls + '" style="text-shadow:0 0 15px ' + winRarity.color + ';">' + winCat.icon + ' ' + winCat.name + '</span>';
  document.getElementById('caseWonDetail').innerHTML =
    '<span style="color:' + winRarity.color + '">' + winRarity.label + '</span> — Market: <span style="color:var(--gold)">$' + mktVal.toLocaleString() + '</span>'
    + ' <span style="color:' + (isW ? 'var(--green)' : 'var(--red)') + '">(' + (isW ? '+' : '') + ('$' + profit.toLocaleString()) + ')</span>';

  if (winRarity.tier >= 5) {
    showToast('🔥 ' + winRarity.label + ': ' + winCat.name + '!'); playWinSound();
    spawnParticles(window.innerWidth / 2, window.innerHeight / 2, 60);
  } else if (winRarity.tier >= 3) {
    showToast(winCat.icon + ' ' + winCat.name + '!'); playWinSound();
  } else {
    if (isW) playWinSound(); else playLoseSound();
  }

  updateCaseStats(winCat, winRarity);
  recordGame('cases', c.price, mktVal);
  firebaseSaveNow();
  setTimeout(() => { caseOpening = false; }, 50);
}

function showInventory(){playClickSound();document.getElementById('inventoryOverlay').classList.add('show');renderInventory();}
function hideInventory(){document.getElementById('inventoryOverlay').classList.remove('show');}
let invFilter='all';

function filterInventory(f,btn){
  invFilter=f;
  document.querySelectorAll('.inv-tab').forEach(t=>t.classList.remove('active'));
  if(btn)btn.classList.add('active');
  renderInventory();
}

function renderInventory(){
  const grid=document.getElementById('invGrid');
  grid.innerHTML='';
  const totalVal=getInventoryValue();
  document.getElementById('invTotalValue').textContent=totalVal.toLocaleString();
  document.getElementById('invCount').textContent=inventory.length;

  let rarestTier=-1,rarestName='—';
  inventory.forEach(x=>{
    const cat=ITEM_CATALOG[x.itemId];
    if(!cat)return;
    const rarDef=RARITY[cat.rarity];
    if(!rarDef)return;
    const t=rarDef.tier;
    if(t>rarestTier){rarestTier=t;rarestName=cat.icon+' '+cat.name;}
  });
  document.getElementById('invRarest').textContent=rarestName;

  const trends=Object.values(itemDemand).map(d=>d.velocity);
  const avg=trends.length?trends.reduce((a,b)=>a+b,0)/trends.length:0;
  document.getElementById('invTrend').innerHTML=avg>0.005?'<span style="color:var(--green)">📈 Bullish</span>'
    :avg<-0.005?'<span style="color:var(--red)">📉 Bearish</span>':'<span style="color:var(--text2)">➡️ Stable</span>';

  let filtered=inventory;
  if(invFilter!=='all'){
    filtered=inventory.filter(x=>{const c=ITEM_CATALOG[x.itemId];return c&&c.rarity===invFilter;});
  }

  filtered.sort((a,b)=>{
    const catA=ITEM_CATALOG[a.itemId], catB=ITEM_CATALOG[b.itemId];
    const ra=catA&&RARITY[catA.rarity]?RARITY[catA.rarity].tier:0;
    const rb=catB&&RARITY[catB.rarity]?RARITY[catB.rarity].tier:0;
    if(rb!==ra)return rb-ra;
    return getItemMarketValue(b.itemId)-getItemMarketValue(a.itemId);
  });

  if(filtered.length===0){
    grid.innerHTML='<div class="inv-empty">No items'+(invFilter!=='all'?' of this rarity':'')+'. Open some cases!</div>';
    return;
  }

  filtered.forEach(inv=>{
    const cat=ITEM_CATALOG[inv.itemId];
    if(!cat)return;
    const rar=RARITY[cat.rarity];
    if(!rar)return;
    const val=getItemMarketValue(inv.itemId);
    const pnl=val-(inv.acquiredPrice||0);
    const pnlPct=inv.acquiredPrice>0?((pnl/inv.acquiredPrice)*100).toFixed(1):0;
    const d=itemDemand[inv.itemId]||{mult:1};

    const el=document.createElement('div');el.className='inv-item';
    el.innerHTML=
      '<div class="ii-icon">'+cat.icon+'</div>'
      +'<div class="ii-name '+rar.cls+'">'+cat.name+'</div>'
      +'<div class="ii-value">$'+val.toLocaleString()+'</div>'
      +'<div class="ii-demand" style="color:'+(pnl>=0?'var(--green)':'var(--red)')+'">'+
        (pnl>=0?'▲':'▼')+' '+(pnl>=0?'+':'')+pnlPct+'% | x'+d.mult.toFixed(2)+'</div>'
      +'<button class="inv-sell-btn" data-inv="'+inv.id+'">SELL $'+val.toLocaleString()+'</button>'
      +'<div class="ii-rarity-bar" style="background:'+rar.color+';"></div>';
    grid.appendChild(el);
  });

  grid.querySelectorAll('.inv-sell-btn').forEach(btn=>{
    btn.onclick=(e)=>{
      e.stopPropagation();
      const invId=parseInt(btn.dataset.inv);
      const inv=inventory.find(x=>x.id===invId);
      if(!inv)return;
      const val=getItemMarketValue(inv.itemId);
      const cat=ITEM_CATALOG[inv.itemId];
      if(!cat){removeFromInventory(invId);renderInventory();return;}
      balance+=val;updateBalDisplay();
      removeFromInventory(invId);
      showToast('Sold '+cat.name+' for $'+val.toLocaleString()+'!');
      playWinSound();renderInventory();firebaseSave();
    };
  });
}

window._getInventoryData=()=>inventory;
window._loadInventory=(data)=>{if(Array.isArray(data)){inventory=data;invIdCounter=inventory.reduce((m,x)=>Math.max(m,x.id||0),Date.now());}};
window._getDemandData=()=>itemDemand;
window._loadDemand=(data)=>{if(data&&typeof data==='object'){Object.assign(itemDemand,data);}};

const PLINKO_PAYOUTS={
  8:{LOW:[5.6,2.1,1.1,1,.5,1,1.1,2.1,5.6],MEDIUM:[13,3,1.3,.7,.4,.7,1.3,3,13],HIGH:[29,4,1.5,.3,.2,.3,1.5,4,29]},
  9:{LOW:[5.6,2,1.6,1,.7,.7,1,1.6,2,5.6],MEDIUM:[18,4,1.7,.9,.5,.5,.9,1.7,4,18],HIGH:[43,7,2,.6,.2,.2,.6,2,7,43]},
  10:{LOW:[8.9,3,1.4,1.1,1,.5,1,1.1,1.4,3,8.9],MEDIUM:[22,5,2,1.4,.6,.4,.6,1.4,2,5,22],HIGH:[76,10,3,.9,.3,.2,.3,.9,3,10,76]},
  11:{LOW:[8.4,3,1.9,1.3,1,.7,.7,1,1.3,1.9,3,8.4],MEDIUM:[24,6,3,1.8,.7,.5,.5,.7,1.8,3,6,24],HIGH:[120,14,5.2,1.4,.4,.2,.2,.4,1.4,5.2,14,120]},
  12:{LOW:[10,3,1.6,1.4,1.1,1,.5,1,1.1,1.4,1.6,3,10],MEDIUM:[33,11,4,2,1.1,.6,.3,.6,1.1,2,4,11,33],HIGH:[170,24,8.1,2,.7,.2,.2,.2,.7,2,8.1,24,170]},
  13:{LOW:[8.1,4,3,1.9,1.2,.9,.7,.7,.9,1.2,1.9,3,4,8.1],MEDIUM:[43,13,6,3,1.3,.7,.4,.4,.7,1.3,3,6,13,43],HIGH:[260,37,11,4,1,.2,.2,.2,.2,1,4,11,37,260]},
  14:{LOW:[7.1,4,1.9,1.4,1.3,1.1,1,.5,1,1.1,1.3,1.4,1.9,4,7.1],MEDIUM:[58,15,7,4,1.9,1,.5,.2,.5,1,1.9,4,7,15,58],HIGH:[420,56,18,5,1.9,.3,.2,.2,.2,.3,1.9,5,18,56,420]},
  15:{LOW:[15,8,3,2,1.5,1.1,1,.7,.7,1,1.1,1.5,2,3,8,15],MEDIUM:[88,18,11,5,3,1.3,.5,.3,.3,.5,1.3,3,5,11,18,88],HIGH:[620,83,27,8,3,.5,.2,.2,.2,.2,.5,3,8,27,83,620]},
  16:{LOW:[16,9,2,1.4,1.4,1.2,1.1,1,.5,1,1.1,1.2,1.4,1.4,2,9,16],MEDIUM:[110,41,10,5,3,1.5,1,.5,.3,.5,1,1.5,3,5,10,41,110],HIGH:[1000,130,26,9,4,2,.2,.2,.2,.2,.2,2,4,9,26,130,1000]}
};
const BALL_FRICTIONS={8:.0395,9:.041,10:.038,11:.0355,12:.0414,13:.0437,14:.0401,15:.0418,16:.0364};

let plinkoInitialized=false,plinkoMatterEngine=null,plinkoMatterRender=null,plinkoMatterRunner=null;
let plinkoPins=[],plinkoWalls=[],plinkoSensor=null,plinkoBallBets={};
let plinkoDropCount=0,plinkoTotalProfit=0,plinkoLastWinsList=[];
let plinkoProfitHistory=[0];
let plinkoProfitChartInstance = null;
let plinkoWinCount=0, plinkoLossCount=0;
let autoDropInterval=null,autoDropping=false,plinkoDropLock=false;
let plinkoRowCount=16,plinkoRiskLevel='MEDIUM';
let plinkoLastRowXCoords=[];

const PW=760,PH=570,PPX=52,PPT=36,PPB=28;
const PIN_CAT=0x0001,BALL_CAT=0x0002;

function initPlinko(){
  if(plinkoInitialized)return;plinkoInitialized=true;
  const canvas=document.getElementById('plinkoCanvas');
  canvas.width=PW;canvas.height=PH;

  const engine=Matter.Engine.create({timing:{timeScale:1}});
  const dpr=window.devicePixelRatio||1;
  const render=Matter.Render.create({engine,canvas,options:{width:PW,height:PH,pixelRatio:dpr,background:'#0f1728',wireframes:false}});
  const runner=Matter.Runner.create();
  plinkoMatterEngine=engine;plinkoMatterRender=render;plinkoMatterRunner=runner;

  plinkoSensor=Matter.Bodies.rectangle(PW/2,PH,PW,10,{isSensor:true,isStatic:true,render:{visible:false}});
  Matter.Composite.add(engine.world,[plinkoSensor]);

  Matter.Events.on(engine,'collisionStart',({pairs})=>{
    pairs.forEach(({bodyA,bodyB})=>{
      if(bodyA===plinkoSensor)handlePlinkoHit(bodyB);
      else if(bodyB===plinkoSensor)handlePlinkoHit(bodyA);
    });
  });

  Matter.Events.on(engine,'collisionStart',({pairs})=>{
    pairs.forEach(({bodyA,bodyB})=>{
      const pin=(bodyA.collisionFilter.category===PIN_CAT)?bodyA:
                (bodyB.collisionFilter.category===PIN_CAT)?bodyB:null;
      if(pin){
        pin.render.fillStyle='#00f0ff';
        setTimeout(()=>{pin.render.fillStyle='#ffffff';},80);
        const pitch=350+(pin.position.x/PW)*300+(pin.position.y/PH)*80;
        playSound(pitch,'sine',.02,.008);
      }
    });
  });

  placePlinkoPins();
  updatePlinkoBins();
  Matter.Render.run(render);
  Matter.Runner.run(runner,engine);

  if(render && render.canvas){ render.canvas.style.width = document.querySelector('.plinko-canvas-wrap').clientWidth + 'px'; render.canvas.style.height = document.querySelector('.plinko-canvas-wrap').clientHeight + 'px'; }

  Matter.Events.on(render,'afterRender',()=>{
    const ctx=render.context;
    Matter.Composite.allBodies(engine.world).forEach(body=>{
      if(body.collisionFilter.category===BALL_CAT){
        const {x,y}=body.position;const r=body.circleRadius||6;
        ctx.save();
        const grd=ctx.createRadialGradient(x,y,r*.5,x,y,r*3);
        grd.addColorStop(0,'rgba(255,80,80,0.25)');grd.addColorStop(1,'rgba(255,40,40,0)');
        ctx.fillStyle=grd;ctx.beginPath();ctx.arc(x,y,r*3,0,Math.PI*2);ctx.fill();
        ctx.restore();
      }
    });
  });

  setInterval(()=>{
    Matter.Composite.allBodies(engine.world).forEach(body=>{
      if(body.collisionFilter.category===BALL_CAT&&(body.position.y>PH+60||body.position.x<-20||body.position.x>PW+20)){
        Matter.Composite.remove(engine.world,body);
        delete plinkoBallBets[body.id];
      }
    });
  },2000);

  document.getElementById('plinkoRows').addEventListener('change',e=>{

    const activeBalls=Object.keys(plinkoBallBets);
    if(activeBalls.length>0){
      let refundTotal=0;
      activeBalls.forEach(id=>{refundTotal+=plinkoBallBets[id].bet||0;});
      if(refundTotal>0){balance+=refundTotal;updateBalDisplay();showToast('Refunded $'+refundTotal.toFixed(2)+' for in-flight balls',true);}
    }
    plinkoRowCount=parseInt(e.target.value);
    removeAllPlinkoBalls();placePlinkoPins();updatePlinkoBins();
  });
  document.getElementById('plinkoRisk').addEventListener('change',e=>{
    plinkoRiskLevel=e.target.value;updatePlinkoBins();
  });
}

function getPinDistX(){return(PW-PPX*2)/(3+plinkoRowCount-1-1);}
function getPinR(){return(24-plinkoRowCount)/2;}

function placePlinkoPins(){
  if(plinkoPins.length)Matter.Composite.remove(plinkoMatterEngine.world,plinkoPins);
  if(plinkoWalls.length)Matter.Composite.remove(plinkoMatterEngine.world,plinkoWalls);
  plinkoPins=[];plinkoWalls=[];plinkoLastRowXCoords=[];

  const pinDist=getPinDistX();const pinR=getPinR();

  for(let row=0;row<plinkoRowCount;row++){
    const rowY=PPT+((PH-PPT-PPB)/(plinkoRowCount-1))*row;
    const rowPadX=PPX+((plinkoRowCount-1-row)*pinDist)/2;
    const cols=3+row;
    for(let col=0;col<cols;col++){
      const colX=cols>1?rowPadX+((PW-rowPadX*2)/(cols-1))*col:PW/2;
      const pin=Matter.Bodies.circle(colX,rowY,pinR,{
        isStatic:true,render:{fillStyle:'#ffffff'},
        collisionFilter:{category:PIN_CAT,mask:BALL_CAT}
      });
      plinkoPins.push(pin);
      if(row===plinkoRowCount-1)plinkoLastRowXCoords.push(colX);
    }
  }
  Matter.Composite.add(plinkoMatterEngine.world,plinkoPins);

  if(plinkoLastRowXCoords.length>1){
    const firstPinX=plinkoPins[0].position.x;
    const wallAngle=Math.atan2(firstPinX-plinkoLastRowXCoords[0],PH-PPT-PPB);
    const wallX=firstPinX-(firstPinX-plinkoLastRowXCoords[0])/2-pinDist*0.25;

    const lw=Matter.Bodies.rectangle(wallX,PH/2,10,PH,{isStatic:true,angle:wallAngle,render:{visible:false}});
    const rw=Matter.Bodies.rectangle(PW-wallX,PH/2,10,PH,{isStatic:true,angle:-wallAngle,render:{visible:false}});
    plinkoWalls=[lw,rw];
    Matter.Composite.add(plinkoMatterEngine.world,plinkoWalls);
  }
}

function updatePlinkoBins(){
  const binsEl=document.getElementById('plinkoBins');
  const payouts=PLINKO_PAYOUTS[plinkoRowCount][plinkoRiskLevel];
  const count=payouts.length;
  binsEl.innerHTML='';

  const half=Math.ceil(count/2);
  function lerpC(a,b,t){return Math.round(a+(b-a)*t);}
  function binBg(i){
    const t2=Math.abs(i-(count-1)/2)/((count-1)/2);
    return'rgb('+lerpC(255,255,t2)+','+lerpC(192,0,t2)+','+lerpC(0,63,t2)+')';
  }
  function binSh(i){
    const t2=Math.abs(i-(count-1)/2)/((count-1)/2);
    return'rgb('+lerpC(171,166,t2)+','+lerpC(121,0,t2)+','+lerpC(0,4,t2)+')';
  }
  for(let i=0;i<count;i++){
    const bin=document.createElement('div');bin.className='plinko-bin';
    bin.style.background=binBg(i);
    bin.style.boxShadow='0 3px 0 '+binSh(i);
    bin.textContent=payouts[i]+'×';
    bin.id='plinkoBin'+i;
    binsEl.appendChild(bin);
  }

  if(plinkoLastRowXCoords.length>1){
    const first=plinkoLastRowXCoords[0],last=plinkoLastRowXCoords[plinkoLastRowXCoords.length-1];
    const pct=((last-first)/PW)*100;
    binsEl.style.width=pct+'%';
  }
}

function handlePlinkoHit(ball){
  if(!plinkoLastRowXCoords.length)return;
  const coords=plinkoLastRowXCoords;
  const ballX=ball.position.x;

  let binIndex=-1;
  for(let i=coords.length-1;i>=0;i--){
    if(coords[i]<ballX){binIndex=i;break;}
  }

  Matter.Composite.remove(plinkoMatterEngine.world,ball);
  const ballData=plinkoBallBets[ball.id]||{bet:0,risk:plinkoRiskLevel,rows:plinkoRowCount};
  const betAmt=typeof ballData==='object'?ballData.bet:ballData;
  const ballRisk=typeof ballData==='object'?ballData.risk:plinkoRiskLevel;
  const ballRows=typeof ballData==='object'?ballData.rows:plinkoRowCount;
  delete plinkoBallBets[ball.id];

  if(binIndex<0){binIndex=0;}
  if(binIndex>=coords.length-1){binIndex=coords.length-2;}
  if(binIndex<0){return;}

  playSound(180+(binIndex/(coords.length-1))*120,'triangle',.06,.04);

  const payouts=PLINKO_PAYOUTS[ballRows][ballRisk];
  if(!payouts){return;}
  const multiplier=payouts[binIndex];
  const payout=betAmt*multiplier*getPrestigeMultiplier();
  const profit=payout-betAmt;

  balance+=payout;
  plinkoTotalProfit+=profit;

  if(profit>=0) plinkoWinCount++; else plinkoLossCount++;

  plinkoProfitHistory.push(plinkoTotalProfit); if(plinkoProfitHistory.length>500)plinkoProfitHistory.shift();

  try{ updatePlinkoProfitChart(); }catch(e){}
  plinkoDropCount++;
  updateBalDisplay();

  document.getElementById('plinkoDropCount').textContent=plinkoDropCount;

  const profitEl=document.getElementById('plinkoProfit');
  profitEl.textContent=(plinkoTotalProfit>=0?'+':'')+('$'+Math.abs(plinkoTotalProfit).toFixed(2));
  profitEl.style.color=plinkoTotalProfit>=0?'#4ade80':'#f87171';

  document.getElementById('plinkoWins').textContent=plinkoWinCount.toLocaleString();
  document.getElementById('plinkoLosses').textContent=plinkoLossCount.toLocaleString();

  const binEl=document.getElementById('plinkoBin'+binIndex);
  if(binEl){binEl.classList.remove('bounce');void binEl.offsetWidth;binEl.classList.add('bounce');}

  plinkoLastWinsList.push({multiplier,binIndex});
  if(plinkoLastWinsList.length>4)plinkoLastWinsList.shift();
  renderPlinkoLastWins();

  if(multiplier>=10){
    playWinSound();
    const rect=document.getElementById('plinkoCanvas').getBoundingClientRect();
    const bx=rect.left+rect.width*(ballX/PW);
    const by=rect.top+rect.height;
    spawnParticles(bx,by,20+Math.min(multiplier,100));
    showToast(multiplier+'× — $'+payout.toFixed(2)+'!');
  }else if(multiplier>=3){
    playSound(600,'sine',.08,.08);
  }else{
    playSound(300,'sine',.04,.04);
  }
  recordGame('plinko', betAmt, payout);
  if(payout > 0) firebaseSaveNow();
}

function renderPlinkoLastWins(){
  const container=document.getElementById('plinkoLastWins');
  container.innerHTML='';
  const payouts=PLINKO_PAYOUTS[plinkoRowCount][plinkoRiskLevel];
  const count=payouts.length;

  [...plinkoLastWinsList].reverse().forEach(w=>{
    const t=Math.abs(w.binIndex-(count-1)/2)/((count-1)/2);
    const el=document.createElement('div');el.className='plinko-last-win';
    el.style.background='rgb('+Math.round(255)+','+Math.round(192-192*t)+','+Math.round(63*t)+')';
    el.textContent=w.multiplier+'×';
    container.appendChild(el);
  });
}

const PLINKO_WIN_COLOR='rgb(74,222,128)', PLINKO_WIN_FILL='rgba(74,222,128,0.3)';
const PLINKO_LOSS_COLOR='rgb(248,113,113)', PLINKO_LOSS_FILL='rgba(248,113,113,0.3)';
const PLINKO_X_AXIS_COLOR='#1e293b', PLINKO_HOVER_COLOR='#fff';

function updatePlinkoProfitChart(){
  const canvas=document.getElementById('plinkoProfitChart'); if(!canvas) return;
  if(typeof Chart==='undefined') return;
  const data=plinkoProfitHistory.length? plinkoProfitHistory : [0];
  if(plinkoProfitChartInstance){
    plinkoProfitChartInstance.data.labels=Array(data.length).fill(0);
    plinkoProfitChartInstance.data.datasets[0].data=data;
    plinkoProfitChartInstance.update();
    return;
  }
  const ctx=canvas.getContext('2d');
  plinkoProfitChartInstance=new Chart(ctx,{
    type:'line',
    data:{labels:Array(data.length).fill(0),datasets:[{label:'Profit',data:data,
      fill:{target:'origin',above:PLINKO_WIN_FILL,below:PLINKO_LOSS_FILL},
      cubicInterpolationMode:'monotone',
      segment:{borderColor:(c)=>{
        const y0=c.p0.parsed.y, y1=c.p1.parsed.y;
        if(y1===0) return y0<0? PLINKO_LOSS_COLOR : PLINKO_WIN_COLOR;
        return y1<0? PLINKO_LOSS_COLOR : PLINKO_WIN_COLOR;
      }},
      pointRadius:0, pointHoverRadius:5,
      pointHoverBackgroundColor:PLINKO_HOVER_COLOR,
      pointHoverBorderColor:PLINKO_HOVER_COLOR
    }]},
    options:{
      responsive:true, maintainAspectRatio:false,
      animations:{y:{duration:0}},
      interaction:{intersect:false, mode:'index'},
      plugins:{legend:{display:false}, tooltip:{enabled:false}},
      scales:{
        x:{border:{display:false}, grid:{display:false}, ticks:{display:false}},
        y:{border:{display:false}, grid:{color:(c)=>(c.tick.value===0? PLINKO_X_AXIS_COLOR : undefined), lineWidth:2}, ticks:{display:false}, grace:'1%'}
      },
      onHover:(_,elements)=>{
        const hv=document.getElementById('plinkoHoverValue');
        if(elements.length){
          const idx=elements[0].index;
          const val=plinkoProfitHistory[idx];
          if(hv && val!==undefined){
            hv.textContent=(val>=0?'+':'')+('$'+Math.abs(val).toFixed(2));
            hv.style.color=val>=0?'#4ade80':'#f87171';
          }
        }
      }
    }
  });

  canvas.addEventListener('mouseleave',()=>{
    const hv=document.getElementById('plinkoHoverValue'); if(hv) hv.textContent='';
  });
}

function resetPlinkoStats(){
  plinkoDropCount=0; plinkoTotalProfit=0; plinkoWinCount=0; plinkoLossCount=0;
  plinkoProfitHistory=[0]; plinkoLastWinsList=[];

  if(plinkoProfitChartInstance){plinkoProfitChartInstance.destroy();plinkoProfitChartInstance=null;}

  document.getElementById('plinkoDropCount').textContent='0';
  const pe=document.getElementById('plinkoProfit'); pe.textContent='$0.00'; pe.style.color='#4ade80';
  document.getElementById('plinkoWins').textContent='0';
  document.getElementById('plinkoLosses').textContent='0';
  const hv=document.getElementById('plinkoHoverValue'); if(hv) hv.textContent='';
  renderPlinkoLastWins();

  updatePlinkoProfitChart();
}

function removeAllPlinkoBalls(){
  if(!plinkoMatterEngine)return;
  Matter.Composite.allBodies(plinkoMatterEngine.world).forEach(body=>{
    if(body.collisionFilter.category===BALL_CAT)Matter.Composite.remove(plinkoMatterEngine.world,body);
  });
  plinkoBallBets={};
}

function dropPlinkoBall(){
  if(plinkoDropLock)return;plinkoDropLock=true;
  if(!plinkoInitialized)initPlinko();
  const bet=parseBet(document.getElementById('plinkoBet').value)||10;
  if(bet>balance){showToast('Not enough balance!',false);if(autoDropping)toggleAutoDrop();plinkoDropLock=false;return;}
  if(bet<=0){plinkoDropLock=false;return;}

  balance-=bet;updateBalDisplay();if(!firebaseSaveBet(bet)){plinkoDropLock=false;return;}
  plinkoDropLock=false;
  playSound(500,'sine',.04,.05);

  const pinDist=getPinDistX();
  const ballR=getPinR()*2;
  const offsetRange=pinDist*0.8;

  const ball=Matter.Bodies.circle(
    PW/2+(Math.random()-.5)*offsetRange*2, 0, ballR,
    {restitution:0.8,friction:0.5,frictionAir:BALL_FRICTIONS[plinkoRowCount],
      collisionFilter:{category:BALL_CAT,mask:PIN_CAT},
      render:{fillStyle:'#ff0000'}}
  );
  Matter.Composite.add(plinkoMatterEngine.world,ball);
  plinkoBallBets[ball.id]={bet:bet,risk:plinkoRiskLevel,rows:plinkoRowCount};
}

function toggleAutoDrop(){
  if(autoDropping){
    clearInterval(autoDropInterval);autoDropInterval=null;autoDropping=false;
    document.getElementById('autoDropBtn').textContent='AUTO DROP';
    document.getElementById('autoDropBtn').style.background='linear-gradient(135deg,#3355cc,#2244aa)';
  }else{
    autoDropping=true;
    document.getElementById('autoDropBtn').textContent='STOP AUTO';
    document.getElementById('autoDropBtn').style.background='linear-gradient(135deg,#cc3355,#991133)';
    autoDropInterval=setInterval(()=>{
      const bet=parseBet(document.getElementById('plinkoBet').value)||10;
      if(bet>balance){toggleAutoDrop();return;}

      const activeBallCount=Object.keys(plinkoBallBets).length;
      if(activeBallCount>=50)return;
      dropPlinkoBall();
    },250);
  }
}

let pylCurrentMode = null;
let pylRoomCode = null;
let pylRoomUnsub = null;
let pylWagerAmount = 0;
let pylWagerEscrowed = false;
let pylHSTarget = 500;
let pylHSMultiplier = 2;
let pylGameActive = false;
let pylOpponentId = null;

window.addEventListener('message', function(evt) {
  if (evt.data && evt.data.type === 'pylScore' && pylGameActive) {
    const score = evt.data.score || 0;
    document.getElementById('pylScoreDisplay').textContent = 'Score: ' + score;
    document.getElementById('pylScoreInput').value = score;

    pylSubmitScore();
  }

  if (evt.data && evt.data.type === 'pylChoice' && pylCurrentMode === '1v1' && pylRoomCode && pylOpponentId) {
    const round = evt.data.round;
    const choice = evt.data.choice;

    if (window._pylWriteChoice) {
      window._pylWriteChoice(pylRoomCode, round, choice);
    }

    if (window._pylListenChoice) {
      window._pylListenChoice(pylRoomCode, round, pylOpponentId, function(opChoice) {

        const iframe = document.getElementById('pylIframe');
        if (iframe && iframe.contentWindow) {
          iframe.contentWindow.postMessage({ type: 'pylOpponentChoice', choice: opChoice, round: round }, '*');
        }
      });
    }
  }
});

function pylStartMode(mode) {
  pylCurrentMode = mode;
  playClickSound();

  if (mode === 'solo') {
    pylHideLobby();
    pylShowOverlay('FREE PLAY', 0);
    pylGameActive = true;
  } else if (mode === 'tournament') {
    pylHideLobby();
    pylShowOverlay('🏆 TOURNAMENT', 0);
    pylGameActive = true;
    pylLoadLeaderboard();
  }
}

function pylShowWager(mode) {
  playClickSound();
  pylCurrentMode = mode;

  document.querySelector('.pyl-modes').style.display = 'none';
  document.getElementById('pylLeaderboard').style.display = 'none';

  if (mode === '1v1') {
    document.getElementById('pylRoomUI').style.display = 'block';
    document.getElementById('pylHighStakesUI').style.display = 'none';
    document.getElementById('pylRoomStatus').textContent = 'Create a room or enter a code to join';
    document.getElementById('pylRoomPlayers').innerHTML = '';
  } else if (mode === 'highstakes') {
    document.getElementById('pylHighStakesUI').style.display = 'block';
    document.getElementById('pylRoomUI').style.display = 'none';
  }
}

function pylBackToLobby() {
  playClickSound();

  if (pylGameActive && pylCurrentMode === '1v1' && pylRoomCode) {
    showToast('Use END GAME to forfeit your 1v1 match!', false);
    return;
  }

  if (pylWagerEscrowed && pylWagerAmount > 0) {
    balance += pylWagerAmount;
    updateBalDisplay();
    showToast('Wager refunded ($' + pylWagerAmount + ')');
    pylWagerEscrowed = false;
    firebaseSaveNow();
  }

  if (pylRoomUnsub) { pylRoomUnsub(); pylRoomUnsub = null; }
  if (pylRoomCode && pylCurrentMode === '1v1') {

    if (window._pylCancelDisconnect) window._pylCancelDisconnect(pylRoomCode);

    if (window._pylDeleteRoom) window._pylDeleteRoom(pylRoomCode);

    const iframe = document.getElementById('pylIframe');
    if (iframe) iframe.src = '';
  }
  pylRoomCode = null;
  pylCurrentMode = null;
  pylGameActive = false;
  pylOpponentId = null;
  _pylDisconnectHandled = false;

  document.querySelector('.pyl-modes').style.display = '';
  document.getElementById('pylRoomUI').style.display = 'none';
  document.getElementById('pylHighStakesUI').style.display = 'none';
  document.getElementById('pylLobby').style.display = '';
  document.getElementById('pylOverlay').classList.add('hidden');
  document.getElementById('pylLeaderboard').style.display = '';
  pylLoadLeaderboard();
}

function pylHideLobby(opponentName, roomCode) {
  document.getElementById('pylLobby').style.display = 'none';

  let iframe = document.getElementById('pylIframe');
  if (!iframe) {
    iframe = document.createElement('iframe');
    iframe.id = 'pylIframe';
    iframe.allow = 'autoplay';
    const panel = document.getElementById('luckPanel');
    panel.insertBefore(iframe, panel.firstChild);
  }

  let url = 'push-your-luck/index.html';
  if (opponentName) {
    url += '?t=' + Date.now() + '#1v1=' + encodeURIComponent(opponentName) + '&room=' + (roomCode || 'default');
  }

  if (opponentName || !iframe.src || !iframe.src.includes('push-your-luck') || iframe.src.includes('#1v1=')) {
    iframe.src = url;
  }
}

function pylShowOverlay(label, wager) {
  const overlay = document.getElementById('pylOverlay');
  overlay.classList.remove('hidden');
  document.getElementById('pylModeLabel').textContent = label;
  document.getElementById('pylScoreDisplay').textContent = 'Score: —';
  document.getElementById('pylScoreInput').value = '';

  if (wager > 0) {
    document.getElementById('pylWagerCard').style.display = '';
    document.getElementById('pylWagerDisplay').textContent = '$' + wager.toLocaleString();
  } else {
    document.getElementById('pylWagerCard').style.display = 'none';
  }

  document.getElementById('pylOpponentCard').style.display = 'none';
}

function generateRoomCode() {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let code = '';
  for (let i = 0; i < 5; i++) code += chars[Math.floor(Math.random() * chars.length)];
  return code;
}

function pylCreateRoom() {
  const wager = parseBet(document.getElementById('pylWager').value) || 100;
  if (wager < 10) { showToast('Minimum wager is $10', false); return; }
  if (wager > balance) { showToast('Not enough balance!', false); return; }

  pylWagerAmount = wager;
  pylRoomCode = generateRoomCode();
  playClickSound();

  balance -= pylWagerAmount;
  updateBalDisplay();
  pylWagerEscrowed = true;
  firebaseSaveNow();

  document.getElementById('pylRoomStatus').innerHTML =
    'Room: <span style="color:var(--neon);font-size:18px;letter-spacing:3px;">' + pylRoomCode + '</span><br>' +
    '<span style="color:var(--text2);font-size:11px;">Share this code with your opponent</span>';
  document.getElementById('pylRoomPlayers').innerHTML =
    '<div style="color:var(--green);margin:4px 0;">✓ You (host) — $' + wager + ' wager</div>' +
    '<div style="color:var(--text2);margin:4px 0;">⏳ Waiting for opponent...</div>';

  if (window._pylCreateRoom) {
    window._pylCreateRoom(pylRoomCode, wager).then(() => {

      let pylGameStarted = false;
      pylRoomUnsub = window._pylListenRoom(pylRoomCode, (data) => {
        if (!data || pylGameStarted) return;
        const players = data.players || {};
        const playerKeys = Object.keys(players);

        if (playerKeys.length >= 2) {
          pylGameStarted = true;
          pylWagerEscrowed = false;
          showToast('⚔️ Opponent joined! Game on!');
          playWinSound();

          const opId = playerKeys.find(k => k !== window._pylPlayerId);
          const opData = opId ? players[opId] : null;
          const opName = opData && opData.name ? opData.name : (opId ? opId.slice(-5) : 'Opponent');
          pylOpponentId = opId;

          pylHideLobby(opName, pylRoomCode);
          document.getElementById('pylRoomUI').style.display = 'none';
          pylShowOverlay('⚔️ 1v1 WAGER — $' + (pylWagerAmount * 2), pylWagerAmount);
          document.getElementById('pylOpponentCard').style.display = '';
          document.getElementById('pylOpponentName').textContent = opName;
          document.getElementById('pylOpponentScore').textContent = 'Playing...';
          pylGameActive = true;

          pylRoomUnsub = window._pylListenRoom(pylRoomCode, (roomData) => {
            if (!roomData) {
              pylHandleOpponentDisconnect();
              return;
            }
            const ps = roomData.players || {};
            if (opId && ps[opId]) {
              if (ps[opId].score != null) {
                document.getElementById('pylOpponentScore').textContent = ps[opId].score + ' pts';
              }

              if (ps[opId].online === false && ps[opId].score == null && pylGameActive) {
                pylHandleOpponentDisconnect();
              }
            }
          });
        }
      });
    });
  }
}

function pylJoinRoom() {
  const code = (document.getElementById('pylJoinCode').value || '').toUpperCase().trim();
  if (!code) { showToast('Enter a room code!', false); return; }

  playClickSound();
  document.getElementById('pylRoomStatus').textContent = 'Checking room...';

  if (window._pylJoinRoom) {

    window._pylPeekRoom(code).then(data => {
      if (!data) {
        showToast('Room not found or already started!', false);
        document.getElementById('pylRoomStatus').textContent = 'Room not found. Try again.';
        return;
      }
      const wager = data.wager || 100;
      if (wager > balance) {
        showToast('Not enough balance for $' + wager + ' wager!', false);
        document.getElementById('pylRoomStatus').textContent = 'Insufficient balance ($' + wager + ' needed).';
        return;
      }

      document.getElementById('pylRoomStatus').textContent = 'Joining...';
      return window._pylJoinRoom(code);
    }).then(data => {
      if (!data) return;

      pylRoomCode = code;
      pylWagerAmount = data.wager || 100;

      if (pylWagerAmount > balance) {
        showToast('Not enough balance for $' + pylWagerAmount + ' wager!', false);
        if (window._pylDeleteRoom) window._pylDeleteRoom(code);
        return;
      }
      balance -= pylWagerAmount;
      updateBalDisplay();
      firebaseSaveNow();

      showToast('⚔️ Joined! Game on!');
      playWinSound();
      const players = data.players || {};
      const opId = Object.keys(players).find(k => k !== window._pylPlayerId);
      const opData = opId ? players[opId] : null;
      const opName = opData && opData.name ? opData.name : (opId ? opId.slice(-5) : 'Opponent');
      pylOpponentId = opId;

      pylHideLobby(opName, pylRoomCode);
      document.getElementById('pylRoomUI').style.display = 'none';
      pylShowOverlay('⚔️ 1v1 WAGER — $' + (pylWagerAmount * 2), pylWagerAmount);
      document.getElementById('pylOpponentCard').style.display = '';
      document.getElementById('pylOpponentName').textContent = opName;
      document.getElementById('pylOpponentScore').textContent = 'Playing...';
      pylGameActive = true;

      pylRoomUnsub = window._pylListenRoom(pylRoomCode, (roomData) => {
        if (!roomData) {
          pylHandleOpponentDisconnect();
          return;
        }
        const ps = roomData.players || {};
        if (opId && ps[opId]) {
          if (ps[opId].score != null) {
            document.getElementById('pylOpponentScore').textContent = ps[opId].score + ' pts';
          }

          if (ps[opId].online === false && ps[opId].score == null && pylGameActive) {
            pylHandleOpponentDisconnect();
          }
        }
      });
    });
  }
}

function pylStartHighStakes() {
  const wager = parseBet(document.getElementById('pylHSWager').value) || 500;
  if (wager > balance) { showToast('Not enough balance!', false); return; }
  if (wager < 50) { showToast('Minimum wager is $50', false); return; }

  const sel = document.getElementById('pylHSTarget');
  pylHSTarget = parseInt(sel.value);
  pylHSMultiplier = parseFloat(sel.options[sel.selectedIndex].dataset.mult);
  pylWagerAmount = wager;

  balance -= wager;
  updateBalDisplay();
  playClickSound();

  pylHideLobby();
  document.getElementById('pylHighStakesUI').style.display = 'none';
  pylShowOverlay('💀 HIGH STAKES — ' + pylHSTarget + 'pts for ' + pylHSMultiplier + 'x', wager);
  pylGameActive = true;

  showToast('💀 Hit ' + pylHSTarget + ' pts to win $' + (wager * pylHSMultiplier).toLocaleString() + '!');
}

function pylSubmitScore() {
  const scoreInput = document.getElementById('pylScoreInput');
  const score = parseInt(scoreInput.value);
  if (isNaN(score) || score < 0) { showToast('Enter a valid score!', false); return; }

  playClickSound();
  document.getElementById('pylScoreDisplay').textContent = 'Score: ' + score;
  scoreInput.value = '';
  pylGameActive = false;

  if (gameStats.pyl) {
    gameStats.pyl.played = (gameStats.pyl.played || 0) + 1;
    if (score > (gameStats.pyl.highScore || 0)) gameStats.pyl.highScore = score;
  }

  if (pylCurrentMode === 'solo') {
    showToast('Free play score: ' + score + ' pts!');
    firebaseSave();
  }

  else if (pylCurrentMode === '1v1') {

    if (window._pylSubmitRoomScore && pylRoomCode) {
      window._pylSubmitRoomScore(pylRoomCode, score).then(() => {
        document.getElementById('pylScoreDisplay').textContent = 'Your Score: ' + score + ' — Waiting for opponent...';

        const checkResult = () => {
          if (pylRoomUnsub) pylRoomUnsub();
          pylRoomUnsub = window._pylListenRoom(pylRoomCode, (data) => {
            if (!data) {

              if (!_pylDisconnectHandled) {
                _pylDisconnectHandled = true;
                pylGameActive = false;
                const refund = pylWagerAmount;
                balance += refund;
                updateBalDisplay();
                showToast('⚔️ Opponent disconnected — wager refunded! +$' + refund.toLocaleString());
                document.getElementById('pylScoreDisplay').innerHTML =
                  '<span style="color:var(--gold);">⚔️ OPPONENT DISCONNECTED</span> — Wager refunded $' + refund.toLocaleString();
                document.getElementById('pylOpponentScore').textContent = 'DISCONNECTED';
                if (pylRoomUnsub) { pylRoomUnsub(); pylRoomUnsub = null; }
                firebaseSaveNow();
                setTimeout(() => pylBackToLobby(), 4000);
              }
              return;
            }
            const ps = data.players || {};
            const myScore = score;
            const opId = Object.keys(ps).find(k => k !== window._pylPlayerId);

            if (opId && ps[opId] && ps[opId].online === false && ps[opId].score == null) {
              if (!_pylDisconnectHandled) {
                _pylDisconnectHandled = true;
                pylGameActive = false;
                if (pylRoomUnsub) { pylRoomUnsub(); pylRoomUnsub = null; }
                const refund = pylWagerAmount;
                balance += refund;
                updateBalDisplay();
                showToast('⚔️ Opponent disconnected — wager refunded! +$' + refund.toLocaleString());
                document.getElementById('pylScoreDisplay').innerHTML =
                  '<span style="color:var(--gold);">⚔️ OPPONENT DISCONNECTED</span> — Wager refunded $' + refund.toLocaleString();
                document.getElementById('pylOpponentScore').textContent = 'DISCONNECTED';
                firebaseSaveNow();
                setTimeout(() => { if (window._pylDeleteRoom) window._pylDeleteRoom(pylRoomCode); pylRoomCode = null; }, 4000);
              }
              return;
            }

            if (opId && ps[opId] && ps[opId].score != null) {
              const opScore = ps[opId].score;
              document.getElementById('pylOpponentScore').textContent = opScore + ' pts';

              if (pylRoomUnsub) { pylRoomUnsub(); pylRoomUnsub = null; }

              const pot = pylWagerAmount * 2;
              if (myScore > opScore) {
                balance += pot;
                updateBalDisplay();
                showToast('🏆 YOU WIN! +$' + pot.toLocaleString() + '!');
                playWinSound();
                spawnParticles(window.innerWidth / 2, window.innerHeight / 2, 60);
                document.getElementById('pylScoreDisplay').innerHTML =
                  '<span style="color:var(--green);">🏆 YOU WIN!</span> ' + myScore + ' vs ' + opScore + ' — +$' + pot.toLocaleString();
              } else if (myScore < opScore) {
                showToast('💀 You lost! -$' + pylWagerAmount, false);
                playLoseSound();
                document.getElementById('pylScoreDisplay').innerHTML =
                  '<span style="color:var(--red);">💀 YOU LOSE</span> ' + myScore + ' vs ' + opScore;
              } else {
                balance += pylWagerAmount;
                updateBalDisplay();
                showToast('🤝 Tie! Wager refunded.');
                document.getElementById('pylScoreDisplay').innerHTML =
                  '<span style="color:var(--gold);">🤝 TIE</span> ' + myScore + ' vs ' + opScore + ' — Refunded';
              }

              setTimeout(() => { if (window._pylDeleteRoom) window._pylDeleteRoom(pylRoomCode); pylRoomCode = null; }, 5000);
              firebaseSaveNow();
            }
          });
        };
        checkResult();
      });
    }
  }

  else if (pylCurrentMode === 'highstakes') {
    if (score >= pylHSTarget) {
      const payout = pylWagerAmount * pylHSMultiplier * getPrestigeMultiplier();
      balance += payout;
      updateBalDisplay();
      showToast('🔥 HIGH STAKES WIN! +$' + payout.toLocaleString() + '!');
      playWinSound();
      spawnParticles(window.innerWidth / 2, window.innerHeight / 2, 80);
      document.getElementById('pylScoreDisplay').innerHTML =
        '<span style="color:var(--green);">🔥 ' + pylHSMultiplier + 'x WIN!</span> ' + score + '/' + pylHSTarget +
        ' pts — +$' + payout.toLocaleString();
    } else {
      showToast('💀 Didn\'t hit target! -$' + pylWagerAmount, false);
      playLoseSound();
      document.getElementById('pylScoreDisplay').innerHTML =
        '<span style="color:var(--red);">💀 MISS</span> ' + score + '/' + pylHSTarget +
        ' pts — Lost $' + pylWagerAmount.toLocaleString();
    }
    firebaseSaveNow();
  }

  else if (pylCurrentMode === 'tournament') {
    if (window._pylSubmitLeaderboard) {
      window._pylSubmitLeaderboard(score).then(() => {
        showToast('🏆 Score submitted to leaderboard: ' + score + ' pts!');
        pylLoadLeaderboard();
      });
    }
    firebaseSave();
  }
}

let _pylDisconnectHandled = false;

function pylHandleOpponentDisconnect() {
  if (_pylDisconnectHandled || !pylGameActive) return;
  _pylDisconnectHandled = true;

  if (pylRoomUnsub) { pylRoomUnsub(); pylRoomUnsub = null; }
  pylGameActive = false;

  const refund = pylWagerAmount;
  balance += refund;
  updateBalDisplay();
  firebaseSaveNow();

  showToast('⚔️ Opponent disconnected — wager refunded! +$' + refund.toLocaleString());
  playWinSound();

  document.getElementById('pylScoreDisplay').innerHTML =
    '<span style="color:var(--gold);">⚔️ OPPONENT DISCONNECTED</span> — Wager refunded $' + refund.toLocaleString();
  document.getElementById('pylOpponentScore').textContent = 'DISCONNECTED';

  if (pylRoomCode && window._pylDeleteRoom) {
    window._pylDeleteRoom(pylRoomCode);
  }

  setTimeout(() => {
    pylBackToLobby();
  }, 4000);
}

function pylEndGame() {
  playClickSound();

  if (pylCurrentMode === '1v1' && pylGameActive && pylRoomCode) {
    if (!confirm('Forfeit your $' + pylWagerAmount.toLocaleString() + ' wager?')) return;
    showToast('Forfeited wager: -$' + pylWagerAmount, false);
    playLoseSound();
    if (window._pylSubmitRoomScore) window._pylSubmitRoomScore(pylRoomCode, 0);

    if (window._pylMarkOffline) window._pylMarkOffline(pylRoomCode);
    firebaseSaveNow();
  }

  pylGameActive = false;
  _pylDisconnectHandled = false;
  if (pylRoomUnsub) { pylRoomUnsub(); pylRoomUnsub = null; }
  pylBackToLobby();
}

function pylLoadLeaderboard() {
  const container = document.getElementById('pylLBRows');
  if (!container) return;

  if (window._pylGetLeaderboard) {
    window._pylGetLeaderboard().then(entries => {
      if (entries.length === 0) {
        container.innerHTML = '<div style="color:var(--text2);padding:8px;text-align:center;font-size:12px;">No scores yet. Be the first!</div>';
        return;
      }
      container.innerHTML = entries.map((e, i) => {
        const medal = i === 0 ? '🥇' : i === 1 ? '🥈' : i === 2 ? '🥉' : (i + 1) + '.';
        const isMe = e.player === (window._currentUsername || '');
        return '<div class="pyl-lb-row' + (isMe ? ' me' : '') + '">' +
          '<span class="lb-rank">' + medal + '</span>' +
          '<span class="lb-name">' + escapeHtml(e.player) + (isMe ? ' (you)' : '') + '</span>' +
          '<span class="lb-score">' + e.score.toLocaleString() + ' pts</span>' +
          '</div>';
      }).join('');
    }).catch(() => {
      container.innerHTML = '<div style="color:var(--text2);padding:8px;text-align:center;font-size:12px;">Could not load leaderboard</div>';
    });
  }
}

function mulberry32(seed) {
  let t = (seed >>> 0) + 0x6D2B79F5;
  t = Math.imul(t ^ (t >>> 15), t | 1);
  t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
  return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
}
function hashTicker(str) {
  let h = 5381;
  for (let i = 0; i < str.length; i++) h = ((h << 5) + h) + str.charCodeAt(i);
  return h >>> 0;
}

const STOCK_DEFS = [
  { ticker: 'GMBL', name: 'Gamble Corp', basePrice: 100, volatility: 0.025, drift: 0.00012 },
  { ticker: 'LUCK', name: 'Lucky Labs', basePrice: 42, volatility: 0.035, drift: -0.00005 },
  { ticker: 'NEON', name: 'Neon Digital', basePrice: 250, volatility: 0.018, drift: 0.0002 },
  { ticker: 'DICE', name: 'DiceTech Inc', basePrice: 15, volatility: 0.045, drift: 0.00008 },
  { ticker: 'MOON', name: 'Moonshot AI', basePrice: 500, volatility: 0.03, drift: 0.00025 },
];

const TICK_EPOCH = new Date('2025-01-01T00:00:00Z').getTime();
const TICK_MS = 3000;

function getCurrentTick() {
  return Math.floor((Date.now() - TICK_EPOCH) / TICK_MS);
}

function getTickRandom(tickerHash, tickNum) {
  return mulberry32(tickerHash ^ (tickNum * 2654435761));
}

let stockPrices = {};
let stockHoldings = {};
let stockPriceHistory = {};
let stocksInitialized = false;
let stockTickInterval = null;
let lastComputedTick = 0;

function initStocks() {
  if (stocksInitialized) return;
  stocksInitialized = true;

  STOCK_DEFS.forEach(s => {
    if (!stockPrices[s.ticker]) stockPrices[s.ticker] = s.basePrice;
    if (!stockPriceHistory[s.ticker]) stockPriceHistory[s.ticker] = [];
  });

  if (lastComputedTick === 0) {

    const now = getCurrentTick();
    lastComputedTick = Math.max(0, now - 500);

    STOCK_DEFS.forEach(s => { stockPrices[s.ticker] = s.basePrice; });
    advanceToTick(now);
  } else {

    advanceToTick(getCurrentTick());
  }

  startStockTicker();
}

function advanceToTick(targetTick) {
  if (targetTick <= lastComputedTick) return;

  const MAX_CATCHUP_TICKS = 5000;
  const MAX_COMPUTE_TICKS = 20000;
  const gap = targetTick - lastComputedTick;
  if (gap > MAX_CATCHUP_TICKS) {

    const skipTo = targetTick - MAX_CATCHUP_TICKS;
    const skipGap = skipTo - lastComputedTick;
    const step = Math.max(1, Math.ceil(skipGap / MAX_COMPUTE_TICKS));
    for (let t = lastComputedTick + step; t <= skipTo; t += step) {
      STOCK_DEFS.forEach(s => {
        const h = hashTicker(s.ticker);
        const r = getTickRandom(h, t);
        const price = stockPrices[s.ticker];
        const change = price * s.volatility * (r * 2 - 1) * step;
        const reversion = (s.basePrice - price) * 0.0015 * step;
        const driftAmt = price * s.drift * step;
        let newPrice = price + change + reversion + driftAmt;
        newPrice = Math.max(s.basePrice * 0.05, newPrice);
        stockPrices[s.ticker] = Math.round(newPrice * 10000) / 10000;
      });
    }
    lastComputedTick = skipTo;
    STOCK_DEFS.forEach(s => { stockPriceHistory[s.ticker] = []; });
  }

  const startTick = lastComputedTick;

  const oldPrices = {};
  STOCK_DEFS.forEach(s => { oldPrices[s.ticker] = stockPrices[s.ticker]; });

  for (let t = startTick + 1; t <= targetTick; t++) {
    STOCK_DEFS.forEach(s => {
      const h = hashTicker(s.ticker);
      const r = getTickRandom(h, t);
      const price = stockPrices[s.ticker];
      const change = price * s.volatility * (r * 2 - 1);
      const reversion = (s.basePrice - price) * 0.0015;
      const driftAmt = price * s.drift;
      let newPrice = price + change + reversion + driftAmt;
      newPrice = Math.max(s.basePrice * 0.05, newPrice);
      stockPrices[s.ticker] = Math.round(newPrice * 10000) / 10000;
    });

    const remaining = targetTick - t;
    if (remaining < 500 || t % 5 === 0) {
      STOCK_DEFS.forEach(s => {
        const hist = stockPriceHistory[s.ticker];
        hist.push(stockPrices[s.ticker]);
        if (hist.length > 500) hist.shift();
      });
    }
  }

  const ticksAdvanced = targetTick - startTick;
  lastComputedTick = targetTick;

  if (ticksAdvanced > 10) {
    const elapsed = ticksAdvanced * TICK_MS;
    const mins = Math.floor(elapsed / 60000);
    const hours = Math.floor(mins / 60);
    const days = Math.floor(hours / 24);
    let timeStr = '';
    if (days > 0) timeStr = days + 'd ' + (hours % 24) + 'h';
    else if (hours > 0) timeStr = hours + 'h ' + (mins % 60) + 'm';
    else timeStr = mins + 'm';

    let biggestMove = '', biggestPct = 0;
    STOCK_DEFS.forEach(s => {
      const pct = Math.abs((stockPrices[s.ticker] - oldPrices[s.ticker]) / oldPrices[s.ticker] * 100);
      if (pct > biggestPct) { biggestPct = pct; biggestMove = s.ticker; }
    });
    const moveDir = stockPrices[biggestMove] > oldPrices[biggestMove] ? '📈' : '📉';
    const msg = moveDir + ' ' + biggestMove + ' moved ' + biggestPct.toFixed(1) + '% while you were away';

    setTimeout(() => { showToast(msg, biggestPct > 0); }, 500);
  }
}

function startStockTicker() {
  if (stockTickInterval) return;
  stockTickInterval = setInterval(() => {
    const now = getCurrentTick();
    if (now > lastComputedTick) {
      advanceToTick(now);
      if (document.querySelector('#stocksPanel.active')) renderStocks();

    }
  }, 1000);
}

function buyStock(ticker) {
  const amt = parseBet(document.getElementById('stockBuyAmt').value) || 100;
  if (amt > balance) { showToast('Not enough balance!', false); return; }
  if (amt <= 0) return;

  const price = stockPrices[ticker];
  const shares = amt / price;

  balance -= amt;
  updateBalDisplay();

  if (!stockHoldings[ticker]) {
    stockHoldings[ticker] = { shares: 0, totalCost: 0 };
  }
  stockHoldings[ticker].shares += shares;
  stockHoldings[ticker].totalCost += amt;

  playClickSound();
  showToast('Bought ' + shares.toFixed(4) + ' ' + ticker + ' @ $' + formatStockPrice(price));
  renderStocks();
  firebaseSave();
}

function sellStock(ticker) {
  if (!stockHoldings[ticker] || stockHoldings[ticker].shares <= 0) return;

  const holding = stockHoldings[ticker];
  const price = stockPrices[ticker];
  const value = holding.shares * price;
  const profit = value - holding.totalCost;

  balance += value;
  updateBalDisplay();

  if (profit >= 0) {
    showToast('Sold ' + ticker + ' +$' + profit.toFixed(2) + '!');
    playWinSound();
    spawnParticles(window.innerWidth / 2, window.innerHeight / 2, 20 + Math.min(profit / 10, 60));
  } else {
    showToast('Sold ' + ticker + ' -$' + Math.abs(profit).toFixed(2), false);
    playLoseSound();
  }

  delete stockHoldings[ticker];
  renderStocks();
  firebaseSave();
}

let selectedStock = 'GMBL';

function selectStock(ticker) {
  selectedStock = ticker;
  renderStocks();
}

function renderStocks() {
  if (!stocksInitialized) initStocks();

  const tickerBar = document.getElementById('stockTickerBar');
  if (tickerBar) {
    tickerBar.innerHTML = STOCK_DEFS.map(s => {
      const price = stockPrices[s.ticker];
      const hist = stockPriceHistory[s.ticker] || [price];
      const prev = hist.length > 1 ? hist[hist.length - 2] : price;
      const isUp = price >= prev;
      const pct = prev ? ((price - prev) / prev * 100).toFixed(1) : '0.0';
      const active = s.ticker === selectedStock;
      const hasPos = stockHoldings[s.ticker] && stockHoldings[s.ticker].shares > 0;
      return `<div onclick="selectStock('${s.ticker}')" style="
        flex:0 0 auto;padding:6px 12px;border-radius:8px;cursor:pointer;text-align:center;font-family:'Orbitron';
        background:${active ? 'linear-gradient(135deg,rgba(0,255,136,0.15),rgba(0,255,136,0.05))' : 'var(--bg)'};
        border:1px solid ${active ? 'var(--neon)' : 'var(--border)'};transition:all 0.2s;position:relative;
      ">
        ${hasPos ? '<div style="position:absolute;top:2px;right:4px;width:6px;height:6px;background:var(--gold);border-radius:50%;"></div>' : ''}
        <div style="font-size:11px;font-weight:700;color:${active?'var(--neon)':'var(--text)'};">$${s.ticker}</div>
        <div style="font-size:9px;color:${isUp?'#3fb950':'#f85149'};">${isUp?'▲':'▼'}${pct}%</div>
      </div>`;
    }).join('');
  }

  const s = STOCK_DEFS.find(x => x.ticker === selectedStock) || STOCK_DEFS[0];
  const price = stockPrices[s.ticker];
  const hist = stockPriceHistory[s.ticker] || [price];
  const prev = hist.length > 1 ? hist[hist.length - 2] : price;
  const isUp = price >= prev;
  const changePct = prev ? ((price - prev) / prev * 100).toFixed(2) : '0.00';
  const holding = stockHoldings[s.ticker];
  const hasHolding = holding && holding.shares > 0;

  document.getElementById('stockTickerLabel').textContent = '$' + s.ticker;
  document.getElementById('stockNameLabel').textContent = s.name;
  document.getElementById('stockPriceDisplay').textContent = '$' + formatStockPrice(price);
  const changeEl = document.getElementById('stockChangeDisplay');
  const firstPrice = hist[0] || price;
  const totalChangePct = ((price - firstPrice) / firstPrice * 100).toFixed(2);
  const tickChangePct = changePct;
  changeEl.innerHTML = (isUp ? '▲' : '▼') + ' ' + tickChangePct + '% <span style="color:#8b949e;font-size:12px;">tick</span> &nbsp; ' +
    (price >= firstPrice ? '▲' : '▼') + ' ' + totalChangePct + '% <span style="color:#8b949e;font-size:12px;">session</span>';
  changeEl.className = 'sh-change ' + (isUp ? 'up' : 'down');

  if (hasHolding) {
    const curVal = holding.shares * price;
    const pnl = curVal - holding.totalCost;
    document.getElementById('stockShares').textContent = holding.shares.toFixed(4);
    document.getElementById('stockValue').textContent = '$' + curVal.toFixed(2);
    const pnlEl = document.getElementById('stockPnl');
    pnlEl.textContent = (pnl >= 0 ? '+' : '') + '$' + pnl.toFixed(2);
    pnlEl.style.color = pnl >= 0 ? '#3fb950' : '#f85149';
  } else {
    document.getElementById('stockShares').textContent = '0';
    document.getElementById('stockValue').textContent = '$0';
    const pnlEl = document.getElementById('stockPnl');
    pnlEl.textContent = '$0';
    pnlEl.style.color = '#8b949e';
  }
  document.getElementById('stockSellBtn').disabled = !hasHolding;

  drawStockChart(hist);

  const overviewDiv = document.getElementById('stockPortfolioOverview');
  if (overviewDiv) {
    const activePositions = STOCK_DEFS.filter(sd => stockHoldings[sd.ticker] && stockHoldings[sd.ticker].shares > 0);
    if (activePositions.length === 0) {
      overviewDiv.innerHTML = '<div style="text-align:center;font-size:11px;color:var(--text2);padding:8px;">No open positions</div>';
    } else {
      let totalValue = 0, totalCost = 0;
      const rows = activePositions.map(sd => {
        const h = stockHoldings[sd.ticker];
        const p = stockPrices[sd.ticker];
        const val = h.shares * p;
        const pnl = val - h.totalCost;
        totalValue += val;
        totalCost += h.totalCost;
        const pnlColor = pnl >= 0 ? '#3fb950' : '#f85149';
        return `<div style="display:flex;align-items:center;gap:8px;padding:6px 8px;background:var(--bg);border-radius:6px;border:1px solid var(--border);">
          <span style="font-family:'Orbitron';font-size:11px;font-weight:700;color:var(--neon);min-width:45px;">$${sd.ticker}</span>
          <span style="font-size:10px;color:var(--text2);flex:1;">${h.shares.toFixed(2)} shares</span>
          <span style="font-size:11px;color:var(--text);font-weight:600;">$${val.toFixed(0)}</span>
          <span style="font-size:10px;font-weight:700;color:${pnlColor};min-width:50px;text-align:right;">${pnl>=0?'+':''}$${pnl.toFixed(0)}</span>
        </div>`;
      }).join('');
      const totalPnl = totalValue - totalCost;
      overviewDiv.innerHTML = `
        <div style="font-size:10px;color:var(--text2);font-weight:600;letter-spacing:1px;margin-bottom:6px;">PORTFOLIO</div>
        <div style="display:flex;flex-direction:column;gap:4px;">${rows}</div>
        <div style="display:flex;justify-content:space-between;padding:6px 8px;margin-top:4px;background:rgba(0,255,136,0.05);border-radius:6px;border:1px solid var(--neon)20;">
          <span style="font-size:11px;font-weight:700;color:var(--text);">Total: $${totalValue.toFixed(0)}</span>
          <span style="font-size:11px;font-weight:700;color:${totalPnl>=0?'#3fb950':'#f85149'};">${totalPnl>=0?'+':''}$${totalPnl.toFixed(0)}</span>
        </div>`;
    }
  }
}

function drawStockChart(hist) {
  const canvas = document.getElementById('stockChart');
  const wrap = canvas.parentElement;
  const dpr = window.devicePixelRatio || 1;
  canvas.width = wrap.clientWidth * dpr;
  canvas.height = wrap.clientHeight * dpr;
  canvas.style.width = wrap.clientWidth + 'px';
  canvas.style.height = wrap.clientHeight + 'px';
  const ctx = canvas.getContext('2d');
  ctx.scale(dpr, dpr);
  const W = wrap.clientWidth;
  const H = wrap.clientHeight;

  ctx.clearRect(0, 0, W, H);

  if (hist.length < 2) return;

  const pMin = Math.min(...hist);
  const pMax = Math.max(...hist);
  const pRange = pMax - pMin || 1;
  const pad = { top: 12, bottom: 20, left: 50, right: 12 };
  const cW = W - pad.left - pad.right;
  const cH = H - pad.top - pad.bottom;

  const gridLines = 4;
  ctx.strokeStyle = '#1e2933';
  ctx.lineWidth = 1;
  ctx.fillStyle = '#8b949e';
  ctx.font = '11px Orbitron, monospace';
  ctx.textAlign = 'right';
  for (let i = 0; i <= gridLines; i++) {
    const y = pad.top + (cH / gridLines) * i;
    const priceAtLine = pMax - (pRange / gridLines) * i;
    ctx.beginPath();
    ctx.moveTo(pad.left, y);
    ctx.lineTo(W - pad.right, y);
    ctx.stroke();
    ctx.fillText('$' + formatStockPrice(priceAtLine), pad.left - 6, y + 4);
  }

  const points = [];
  for (let i = 0; i < hist.length; i++) {
    const x = pad.left + (i / (hist.length - 1)) * cW;
    const y = pad.top + (1 - (hist[i] - pMin) / pRange) * cH;
    points.push({ x, y });
  }

  const isUpOverall = hist[hist.length - 1] >= hist[0];
  const lineColor = isUpOverall ? '#3fb950' : '#f85149';
  const fillColor = isUpOverall ? 'rgba(63,185,80,' : 'rgba(248,81,73,';

  const grad = ctx.createLinearGradient(0, pad.top, 0, H - pad.bottom);
  grad.addColorStop(0, fillColor + '0.35)');
  grad.addColorStop(1, fillColor + '0.0)');

  ctx.beginPath();
  ctx.moveTo(points[0].x, H - pad.bottom);
  points.forEach(p => ctx.lineTo(p.x, p.y));
  ctx.lineTo(points[points.length - 1].x, H - pad.bottom);
  ctx.closePath();
  ctx.fillStyle = grad;
  ctx.fill();

  ctx.beginPath();
  points.forEach((p, i) => i === 0 ? ctx.moveTo(p.x, p.y) : ctx.lineTo(p.x, p.y));
  ctx.strokeStyle = lineColor;
  ctx.lineWidth = 2;
  ctx.lineJoin = 'round';
  ctx.stroke();

  const last = points[points.length - 1];
  ctx.beginPath();
  ctx.arc(last.x, last.y, 5, 0, Math.PI * 2);
  ctx.fillStyle = lineColor;
  ctx.fill();
  ctx.beginPath();
  ctx.arc(last.x, last.y, 8, 0, Math.PI * 2);
  ctx.strokeStyle = lineColor;
  ctx.lineWidth = 1.5;
  ctx.globalAlpha = 0.4;
  ctx.stroke();
  ctx.globalAlpha = 1;
}

function formatStockPrice(p) {
  if (p >= 1000) return p.toFixed(0);
  if (p >= 1) return p.toFixed(2);
  return p.toFixed(4);
}

window._getStocksData = () => {
  if (!stocksInitialized && Object.keys(stockHoldings).length === 0) return null;
  return {
    prices: stockPrices,
    holdings: stockHoldings,
    lastTick: lastComputedTick
  };
};

window._loadStocks = (data) => {
  if (!data) return;

  if (data.prices) {
    stockPrices = data.prices;
    STOCK_DEFS.forEach(s => {
      if (!stockPrices[s.ticker]) stockPrices[s.ticker] = s.basePrice;
      stockPriceHistory[s.ticker] = [stockPrices[s.ticker]];
    });
  }

  if (data.holdings) stockHoldings = data.holdings;

  if (data.lastTick) {
    lastComputedTick = data.lastTick;
  }

  stocksInitialized = true;

  advanceToTick(getCurrentTick());

  startStockTicker();
};

const CARD_SUITS=['♠','♥','♦','♣'];const CARD_RANKS=['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
function newDeck(){let d=[];CARD_SUITS.forEach(s=>CARD_RANKS.forEach(r=>d.push({r,s})));for(let i=d.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[d[i],d[j]]=[d[j],d[i]];}return d;}
function cardNumVal(c){if(c.r==='A')return 11;if('KQJ'.includes(c.r))return 10;return parseInt(c.r);}
function cardIsRed(c){return c.s==='♥'||c.s==='♦';}
function renderCard(c,hidden){if(hidden)return'<div class="bj-card hidden">?</div>';return'<div class="bj-card'+(cardIsRed(c)?' red':'')+'">'+c.r+'<br>'+c.s+'</div>';}
function cardRankIdx(c){return CARD_RANKS.indexOf(c.r);}

let bjDeck=[],bjPlayer=[],bjDealer=[],bjBetAmt=0,bjActive=false;
function bjDrawCard(){if(bjDeck.length<10)bjDeck=bjDeck.concat(newDeck());return bjDeck.pop();}
function bjHandVal(h){let v=0,a=0;h.forEach(c=>{v+=cardNumVal(c);if(c.r==='A')a++;});while(v>21&&a>0){v-=10;a--;}return v;}
function bjDeal(){
  if(bjActive)return;const bet=parseBet(document.getElementById('bjBet').value)||10;if(bet<=0)return;
  if(!checkMaxBet(bet,'Blackjack'))return;
  if(bet>balance){showToast('Not enough balance!',false);return;}
  bjBetAmt=bet;balance-=bet;updateBalDisplay();if(!firebaseSaveBet(bet))return;bjDeck=newDeck();bjPlayer=[bjDrawCard(),bjDrawCard()];bjDealer=[bjDrawCard(),bjDrawCard()];bjActive=true;bjRender();
  document.getElementById('bjResult').textContent='';
  if(bjHandVal(bjPlayer)===21)bjStand();playClickSound();
}
function bjHit(){if(!bjActive)return;bjPlayer.push(bjDrawCard());if(bjHandVal(bjPlayer)>21){bjActive=false;bjRender();bjFinish();}else if(bjHandVal(bjPlayer)===21)bjStand();else bjRender();}
function bjStand(){if(!bjActive)return;while(bjHandVal(bjDealer)<17)bjDealer.push(bjDrawCard());bjActive=false;bjRender();bjFinish();}
function bjDouble(){if(!bjActive||bjPlayer.length!==2)return;if(!checkMaxBet(bjBetAmt*2,'Blackjack'))return;if(bjBetAmt>balance){showToast('Not enough balance to double!',false);return;}const _dblAmt=bjBetAmt;balance-=_dblAmt;bjBetAmt*=2;updateBalDisplay();if(!firebaseSaveBet(_dblAmt)){bjBetAmt/=2;return;}bjPlayer.push(bjDrawCard());while(bjHandVal(bjDealer)<17)bjDealer.push(bjDrawCard());bjActive=false;bjRender();bjFinish();}
function bjFinish(){
  const pv=bjHandVal(bjPlayer),dv=bjHandVal(bjDealer);let w=0,msg='';
  const isNatural=bjPlayer.length===2&&pv===21;
  const dealerNatural=bjDealer.length===2&&dv===21;
  if(pv>21){msg='BUST!';showToast('-$'+bjBetAmt.toFixed(2),false);playLoseSound();}
  else if(isNatural&&!dealerNatural){w=Math.round(bjBetAmt*2.5*getPrestigeMultiplier()*100)/100;msg='BLACKJACK! +$'+w.toFixed(2);balance+=w;updateBalDisplay();showBigWin(w);showToast('BLACKJACK! +$'+w.toFixed(2));playWinSound();spawnParticles(window.innerWidth/2,window.innerHeight/2,40);}
  else if(dv>21||pv>dv){w=bjBetAmt*2*getPrestigeMultiplier();msg='WIN +$'+w.toFixed(2);balance+=w;updateBalDisplay();showBigWin(w);showToast('+$'+w.toFixed(2));playWinSound();spawnParticles(window.innerWidth/2,window.innerHeight/2,30);}
  else if(pv===dv){w=bjBetAmt;msg='PUSH';balance+=w;updateBalDisplay();showToast('Push');}
  else{msg='LOSE';showToast('-$'+bjBetAmt.toFixed(2),false);playLoseSound();}
  const r=document.getElementById('bjResult');r.textContent=msg;r.style.color=w>bjBetAmt?'var(--green)':w===bjBetAmt?'var(--gold)':'var(--red)';
  recordGame('blackjack',bjBetAmt,w);
  if(w>0) firebaseSaveNow();
}
function bjRender(){const s=!bjActive;document.getElementById('bjDealerCards').innerHTML=bjDealer.map((c,i)=>renderCard(c,!s&&i===1)).join('');document.getElementById('bjPlayerCards').innerHTML=bjPlayer.map(c=>renderCard(c)).join('');document.getElementById('bjDealerScore').textContent=s?bjHandVal(bjDealer):'?';document.getElementById('bjPlayerScore').textContent=bjHandVal(bjPlayer);document.getElementById('bjHitBtn').disabled=!bjActive;document.getElementById('bjStandBtn').disabled=!bjActive;document.getElementById('bjDoubleBtn').disabled=!bjActive||bjPlayer.length!==2;document.getElementById('bjDealBtn').disabled=bjActive;}

let _minesEnc=[],_minesKey=0,minesRevealed=0,minesBetAmt=0,minesActive=false,minesCount=3;
function _mB(i){if(!minesActive)return false;return((_minesEnc[i]||0)^_minesKey)===1;}
function minesMultiplier(){const t=25,m=minesCount,r=minesRevealed;if(r===0)return 1;let mult=1;for(let i=0;i<r;i++)mult*=(t-m-i)>0?(t-i)/(t-m-i):t;return Math.round(mult*97)/100;}
function minesStart(){
  if(minesActive)return;const bet=parseBet(document.getElementById('minesBet').value)||10;if(bet<=0)return;minesCount=parseInt(document.getElementById('mineCount').value);
  if(!minesCount||minesCount<1)minesCount=1;if(minesCount>24)minesCount=24;
  if(bet>balance){showToast('Not enough!',false);return;}
  if(!checkMaxBet(bet,'Mines'))return;
  minesBetAmt=bet;balance-=bet;updateBalDisplay();if(!firebaseSaveBet(bet))return;minesActive=true;minesRevealed=0;
  _minesKey=Math.floor(Math.random()*250)+2;_minesEnc=Array(25).fill(0^_minesKey);const pos=[];while(pos.length<minesCount){const p=Math.floor(Math.random()*25);if(!pos.includes(p))pos.push(p);}
  pos.forEach(p=>_minesEnc[p]=1^_minesKey);minesRenderGrid();
  document.getElementById('minesStartBtn').style.display='none';document.getElementById('minesCashoutBtn').style.display='';
  document.getElementById('minesMultiplier').textContent='1.00×';document.getElementById('minesProfit').textContent='Next: $'+minesBetAmt.toFixed(2);playClickSound();
}
function minesCashout(){if(!minesActive||minesRevealed===0)return;const payout=minesBetAmt*minesMultiplier()*getPrestigeMultiplier();balance+=payout;updateBalDisplay();
  showBigWin(payout);showToast('+$'+payout.toFixed(2));playWinSound();spawnParticles(window.innerWidth/2,window.innerHeight/2,30);
  minesActive=false;minesRevealAll();document.getElementById('minesStartBtn').style.display='';document.getElementById('minesCashoutBtn').style.display='none';
  recordGame('mines',minesBetAmt,payout);firebaseSaveNow();
}
function minesClick(i){if(!minesActive)return;const cells=document.querySelectorAll('.mine-cell');if(cells[i].classList.contains('revealed'))return;
  if(_mB(i)){cells[i].classList.add('revealed','mine');cells[i].textContent='💣';minesActive=false;
    showToast('-$'+minesBetAmt.toFixed(2),false);playLoseSound();minesRevealAll();
    document.getElementById('minesStartBtn').style.display='';document.getElementById('minesCashoutBtn').style.display='none';recordGame('mines',minesBetAmt,0);
  }else{cells[i].classList.add('revealed','safe');cells[i].textContent='💎';minesRevealed++;playSound(600+minesRevealed*40,'sine',.06,.06);
    const m=minesMultiplier();document.getElementById('minesMultiplier').textContent=m.toFixed(2)+'×';
    document.getElementById('minesProfit').textContent='Cash out: $'+(minesBetAmt*m).toFixed(2);if(minesRevealed===25-minesCount)minesCashout();
  }
}
function minesRevealAll(){const cells=document.querySelectorAll('.mine-cell');for(let i=0;i<25;i++){if(!cells[i].classList.contains('revealed')){const isMine=_mB(i);cells[i].classList.add('revealed',isMine?'mine':'safe');cells[i].textContent=isMine?'💣':'💎';}}}
function minesRenderGrid(){const g=document.getElementById('minesGrid');g.innerHTML='';for(let i=0;i<25;i++){const c=document.createElement('div');c.className='mine-cell';c.onclick=(()=>{const idx=i;return()=>minesClick(idx);})();g.appendChild(c);}}

let diceMode='over', diceRolling=false;
function diceSetMode(m){if(diceRolling)return;diceMode=m;document.getElementById('diceOverBtn').className='dice-mode-btn'+(m==='over'?' active':'');document.getElementById('diceUnderBtn').className='dice-mode-btn'+(m==='under'?' active':'');diceUpdateSlider();}
function diceUpdateSlider(){const v=Math.max(5,Math.min(95,parseFloat(document.getElementById('diceSlider').value)));document.getElementById('diceSlider').value=v;const chance=diceMode==='over'?(100-v):v;const payout=chance>0?Math.min(Math.floor(99/chance*100)/100,9900):0;document.getElementById('diceTarget').textContent=v.toFixed(2);document.getElementById('diceChance').textContent=chance.toFixed(2)+'%';document.getElementById('dicePayout').textContent=payout.toFixed(2)+'×';
  const sl=document.getElementById('diceSlider');sl.style.background='linear-gradient(90deg,'+(diceMode==='over'?'var(--red)':'var(--green)')+' 0%,'+(diceMode==='over'?'var(--red)':'var(--green)')+' '+v+'%,'+(diceMode==='over'?'var(--green)':'var(--red)')+' '+v+'%,'+(diceMode==='over'?'var(--green)':'var(--red)')+' 100%)';}
function diceRoll(){if(diceRolling)return;const bet=parseBet(document.getElementById('diceBet').value)||10;if(bet>balance){showToast('Not enough!',false);return;}if(bet<=0)return;
  if(!checkMaxBet(bet,'Dice'))return;
  diceRolling=true;

  document.getElementById('diceSlider').disabled=true;
  balance-=bet;updateBalDisplay();if(!firebaseSaveBet(bet))return;let target=parseFloat(document.getElementById('diceSlider').value);target=Math.max(5,Math.min(95,target));const chance=diceMode==='over'?(100-target):target;const payout=chance>0?Math.min(Math.floor(99/chance*100)/100,9900):0;
  const roll=Math.random()*100;const won=diceMode==='over'?roll>target:roll<target;const display=document.getElementById('diceDisplay');
  display.textContent=roll.toFixed(2);display.style.color=won?'var(--green)':'var(--red)';
  if(won){const w=bet*payout*getPrestigeMultiplier();balance+=w;updateBalDisplay();showBigWin(w);showToast('+$'+w.toFixed(2));playWinSound();spawnParticles(window.innerWidth/2,window.innerHeight/2,25);recordGame('dice',bet,w);firebaseSaveNow();}
  else{showToast('-$'+bet.toFixed(2),false);playLoseSound();recordGame('dice',bet,0);}playClickSound();

  setTimeout(()=>{diceRolling=false;document.getElementById('diceSlider').disabled=false;},400);
}

let _towerEnc=[],_towerKey=0,towerRow=0,towerBetAmt=0,towerActive=false,towerCols=3,towerRows=8,towerSafePerRow=2;
function _tB(r,c){if(!towerActive)return false;return((_towerEnc[r]&&_towerEnc[r][c]||0)^_towerKey)===1;}
function towerMultiplier(){if(towerRow===0)return 1;let m=1;for(let i=0;i<towerRow;i++)m*=towerCols/towerSafePerRow;return Math.round(m*97)/100;}
function towerStart(){
  if(towerActive)return;const bet=parseBet(document.getElementById('towerBet').value)||10;if(bet<=0)return;if(bet>balance){showToast('Not enough!',false);return;}
  if(!checkMaxBet(bet,'Tower'))return;
  const diff=document.getElementById('towerDiff').value;
  if(diff==='easy'){towerCols=4;towerSafePerRow=3;}else if(diff==='medium'){towerCols=3;towerSafePerRow=2;}else if(diff==='hard'){towerCols=4;towerSafePerRow=2;}else{towerCols=4;towerSafePerRow=1;}
  towerBetAmt=bet;balance-=bet;updateBalDisplay();if(!firebaseSaveBet(bet))return;towerActive=true;towerRow=0;towerRows=8;
  _towerKey=Math.floor(Math.random()*250)+2;_towerEnc=[];for(let r=0;r<towerRows;r++){const row=[];for(let c=0;c<towerCols;c++)row.push(1^_towerKey);const traps=towerCols-towerSafePerRow;const trapPos=[];while(trapPos.length<traps){const p=Math.floor(Math.random()*towerCols);if(!trapPos.includes(p))trapPos.push(p);}trapPos.forEach(p=>row[p]=0^_towerKey);_towerEnc.push(row);}
  towerRender();document.getElementById('towerStartBtn').style.display='none';document.getElementById('towerCashoutBtn').style.display='';
  document.getElementById('towerInfo').innerHTML='Floor <span style="color:var(--neon)">1</span> — Pick a tile!';playClickSound();
}
function towerCashout(){if(!towerActive||towerRow===0)return;const p=towerBetAmt*towerMultiplier()*getPrestigeMultiplier();balance+=p;updateBalDisplay();
  showBigWin(p);showToast('+$'+p.toFixed(2));playWinSound();spawnParticles(window.innerWidth/2,window.innerHeight/2,30);
  towerActive=false;towerRevealAll();document.getElementById('towerStartBtn').style.display='';document.getElementById('towerCashoutBtn').style.display='none';
  document.getElementById('towerInfo').textContent='Cashed out at '+towerMultiplier().toFixed(2)+'× — $'+p.toFixed(2);recordGame('tower',towerBetAmt,p);firebaseSaveNow();
}
function towerClick(r,c){if(!towerActive||r!==towerRow)return;
  const rowEl=document.querySelectorAll('.tower-row')[towerRows-1-r];
  if(_tB(r,c)){towerRow++;rowEl.children[c].classList.add('revealed','safe');rowEl.children[c].textContent='✅';
    playSound(400+towerRow*60,'sine',.08,.06);const m=towerMultiplier();
    document.getElementById('towerInfo').innerHTML='Floor <span style="color:var(--neon)">'+(towerRow+1)+'</span> — '+m.toFixed(2)+'× ($'+(towerBetAmt*m).toFixed(2)+')';
    if(towerRow>=towerRows)towerCashout();else towerRender();
  }else{rowEl.children[c].classList.add('revealed','trap');rowEl.children[c].textContent='💀';
    towerActive=false;showToast('-$'+towerBetAmt.toFixed(2),false);playLoseSound();towerRevealAll();
    document.getElementById('towerStartBtn').style.display='';document.getElementById('towerCashoutBtn').style.display='none';
    document.getElementById('towerInfo').textContent='Hit a trap! Lost $'+towerBetAmt.toFixed(2);recordGame('tower',towerBetAmt,0);
  }
}
function towerRevealAll(){document.querySelectorAll('.tower-row').forEach((row,ri)=>{const actualRow=towerRows-1-ri;[...row.children].forEach((c,ci)=>{if(!c.classList.contains('revealed')){const safe=_tB(actualRow,ci);c.classList.add('revealed',safe?'safe':'trap');c.textContent=safe?'✅':'💀';}});});}
function towerRender(){const g=document.getElementById('towerGrid');g.innerHTML='';for(let r=towerRows-1;r>=0;r--){const row=document.createElement('div');row.className='tower-row';for(let c=0;c<towerCols;c++){const cell=document.createElement('div');cell.className='tower-cell';if(r===towerRow&&towerActive)cell.classList.add('current-row');else if(r>towerRow)cell.classList.add('locked');cell.onclick=(()=>{const rr=r,cc=c;return()=>towerClick(rr,cc);})();row.appendChild(cell);}g.appendChild(row);}}

let coinChoice='heads',coinFlipping=false;
function coinSelect(c){if(coinFlipping)return;coinChoice=c;document.getElementById('coinHeads').className='coin-choice'+(c==='heads'?' selected':'');document.getElementById('coinTails').className='coin-choice'+(c==='tails'?' selected':'');playClickSound();}
function coinFlip(){if(coinFlipping)return;const bet=parseBet(document.getElementById('coinBet').value)||10;if(bet<=0)return;if(bet>balance){showToast('Not enough!',false);return;}
  if(!checkMaxBet(bet,'Coinflip'))return;
  coinFlipping=true;

  const lockedChoice=coinChoice;
  balance-=bet;updateBalDisplay();if(!firebaseSaveBet(bet)){coinFlipping=false;return;}document.getElementById('coinFlipBtn').disabled=true;document.getElementById('coinResult').textContent='';
  const coin=document.getElementById('coinDisplay');coin.classList.remove('flip');void coin.offsetWidth;coin.classList.add('flip');playClickSound();
  const result=Math.random()<0.5?'heads':'tails';
  setTimeout(()=>{coin.textContent=result==='heads'?'👑':'🦅';const won=result===lockedChoice;
    if(won){const w=bet*1.96*getPrestigeMultiplier();balance+=w;updateBalDisplay();showBigWin(w);showToast('+$'+w.toFixed(2));playWinSound();spawnParticles(window.innerWidth/2,window.innerHeight/2,25);
      document.getElementById('coinResult').innerHTML='<span style="color:var(--green)">'+result.toUpperCase()+' — WIN!</span>';recordGame('coinflip',bet,w);firebaseSaveNow();}
    else{showToast('-$'+bet.toFixed(2),false);playLoseSound();document.getElementById('coinResult').innerHTML='<span style="color:var(--red)">'+result.toUpperCase()+' — LOSE</span>';recordGame('coinflip',bet,0);}
    coinFlipping=false;document.getElementById('coinFlipBtn').disabled=false;},800);
}

let kenoSelected=new Set(),kenoPlaying=false;
const KENO_PAYOUTS={1:[0,3.5],2:[0,1.5,8],3:[0,0.5,3,35],4:[0,0,1.5,8,70],5:[0,0,1,4,20,150],6:[0,0,0.5,3,8,50,300],7:[0,0,0,1.5,5,15,80,500],8:[0,0,0,1,3,12,40,150,750],9:[0,0,0,0.5,2,8,25,80,350,1500],10:[0,0,0,0,1,5,15,50,200,750,3000]};
function kenoInit(){const g=document.getElementById('kenoGrid');if(!g)return;g.innerHTML='';for(let i=1;i<=40;i++){const c=document.createElement('div');c.className='keno-num';c.textContent=i;c.onclick=(()=>{const n=i;return()=>kenoToggle(n);})();g.appendChild(c);}}
function kenoToggle(n){if(kenoPlaying)return;const cells=document.querySelectorAll('.keno-num');if(kenoSelected.has(n)){kenoSelected.delete(n);cells[n-1].classList.remove('selected');}else{if(kenoSelected.size>=10){showToast('Max 10!',false);return;}kenoSelected.add(n);cells[n-1].classList.add('selected');}document.getElementById('kenoInfo').textContent=kenoSelected.size+'/10 selected';playClickSound();}
function kenoClear(){if(kenoPlaying)return;kenoSelected.clear();document.querySelectorAll('.keno-num').forEach(c=>{c.className='keno-num';});document.getElementById('kenoInfo').textContent='Pick up to 10 numbers';document.getElementById('kenoResult').textContent='';}
function kenoDraw(){if(kenoPlaying||kenoSelected.size===0)return;const bet=parseBet(document.getElementById('kenoBet').value)||10;if(bet<=0)return;if(bet>balance){showToast('Not enough!',false);return;}
  if(!checkMaxBet(bet,'Keno'))return;
  kenoPlaying=true;balance-=bet;updateBalDisplay();if(!firebaseSaveBet(bet)){kenoPlaying=false;return;}document.getElementById('kenoDrawBtn').disabled=true;
  const drawn=new Set();while(drawn.size<10){drawn.add(Math.floor(Math.random()*40)+1);}
  const cells=document.querySelectorAll('.keno-num');let hits=0;const drawnArr=[...drawn];let idx=0;
  const revealInterval=setInterval(()=>{if(idx>=drawnArr.length){clearInterval(revealInterval);
    const picks=kenoSelected.size;const payTable=KENO_PAYOUTS[picks];const mult=payTable&&payTable[hits]?payTable[hits]:0;const payout=bet*mult*getPrestigeMultiplier();
    cells.forEach((c,i)=>{if(!drawn.has(i+1)&&!kenoSelected.has(i+1))c.classList.add('miss');});
    if(payout>0){balance+=payout;updateBalDisplay();showBigWin(payout);showToast(hits+' hits! +$'+payout.toFixed(2));playWinSound();spawnParticles(window.innerWidth/2,window.innerHeight/2,20+hits*10);
      document.getElementById('kenoResult').innerHTML='<span style="color:var(--green)">'+hits+' HITS — '+mult+'× — +$'+payout.toFixed(2)+'</span>';}
    else{showToast(hits+' hits — no win',false);playLoseSound();document.getElementById('kenoResult').innerHTML='<span style="color:var(--red)">'+hits+' hits — no win</span>';}
    recordGame('keno',bet,payout);if(payout>0)firebaseSaveNow();kenoPlaying=false;document.getElementById('kenoDrawBtn').disabled=false;return;}
    const n=drawnArr[idx];cells[n-1].classList.add('drawn');if(kenoSelected.has(n)){cells[n-1].classList.add('hit');hits++;playSound(600+hits*80,'sine',.06,.06);}else{playSound(300,'sine',.03,.02);}idx++;
  },200);
}

let limboRolling=false;
function limboUpdateInfo(){const t=parseFloat(document.getElementById('limboTarget').value)||2;const chance=Math.min(99,(99/t));document.getElementById('limboPayout').textContent='Win chance: '+chance.toFixed(2)+'% — Payout: '+t.toFixed(2)+'×';}
function limboGo(){if(limboRolling)return;const bet=parseBet(document.getElementById('limboBet').value)||10;if(bet<=0)return;let target=parseFloat(document.getElementById('limboTarget').value)||2;target=Math.max(1.01,Math.min(1000,target));
  if(bet>balance){showToast('Not enough!',false);return;}if(target<1.01){showToast('Min target 1.01×',false);return;}
  if(!checkMaxBet(bet,'Limbo'))return;
  limboRolling=true;balance-=bet;updateBalDisplay();if(!firebaseSaveBet(bet)){limboRolling=false;return;}document.getElementById('limboGoBtn').disabled=true;
  const result=Math.min(10000,0.99/(1-Math.random()));const display=document.getElementById('limboResult');const limboBar=document.getElementById('limboBar');
  let cur=1;const step=Math.max(0.01,(result-1)/20);
  const anim=setInterval(()=>{cur+=step;if(cur>=result){cur=result;clearInterval(anim);
    display.textContent=Math.max(1,result).toFixed(2)+'×';const won=result>=target;
    display.style.color=won?'var(--green)':'var(--red)';
    if(limboBar){const pct=Math.min(100,(result/Math.max(target,2))*100);limboBar.style.width=pct+'%';limboBar.style.background=won?'var(--green)':'var(--red)';limboBar.style.boxShadow=won?'0 0 15px var(--green)':'0 0 15px var(--red)';}
    if(won){const w=bet*target*getPrestigeMultiplier();balance+=w;updateBalDisplay();showBigWin(w);showToast('+$'+w.toFixed(2));playWinSound();spawnParticles(window.innerWidth/2,window.innerHeight/2,25);recordGame('limbo',bet,w);addResultDot('limboHistory',target.toFixed(1)+'×',true);firebaseSaveNow();}
    else{showToast('-$'+bet.toFixed(2),false);playLoseSound();recordGame('limbo',bet,0);addResultDot('limboHistory',result.toFixed(1)+'×',false);}
    limboRolling=false;document.getElementById('limboGoBtn').disabled=false;}
  else{display.textContent=cur.toFixed(2)+'×';display.style.color='var(--neon)';if(limboBar){const pct=Math.min(100,(cur/Math.max(target,2))*100);limboBar.style.width=pct+'%';limboBar.style.background=cur>=target?'var(--green)':'var(--neon)';limboBar.style.transition='width 0.05s';}playSound(400+cur*30,'sine',.02,.015);}},50);
}

let pokerDeckArr=[],pokerHandArr=[],pokerHeld=[],pokerBetAmt=0,pokerPhase='idle';
function pokerDeal(){
  if(pokerPhase==='hold'){pokerDrawCards();return;}
  const bet=parseBet(document.getElementById('pokerBet').value)||10;if(bet<=0)return;if(bet>balance){showToast('Not enough!',false);return;}
  if(!checkMaxBet(bet,'Poker'))return;
  pokerBetAmt=bet;balance-=bet;updateBalDisplay();if(!firebaseSaveBet(bet))return;pokerDeckArr=newDeck();pokerHandArr=[];pokerHeld=Array(5).fill(false);
  for(let i=0;i<5;i++)pokerHandArr.push(pokerDeckArr.pop());pokerPhase='hold';pokerRender();
  document.getElementById('pokerDealBtn').textContent='DRAW';document.getElementById('pokerResult').textContent='Click cards to hold, then DRAW';playClickSound();
}
function pokerDrawCards(){for(let i=0;i<5;i++){if(!pokerHeld[i])pokerHandArr[i]=pokerDeckArr.pop();}pokerPhase='done';pokerRender();
  const result=pokerEvaluate();const mult=result.mult;const payout=pokerBetAmt*mult*getPrestigeMultiplier();
  if(payout>0){balance+=payout;updateBalDisplay();showBigWin(payout);showToast(result.name+' +$'+payout.toFixed(2));playWinSound();spawnParticles(window.innerWidth/2,window.innerHeight/2,20+mult*5);
    document.getElementById('pokerResult').innerHTML='<span style="color:var(--green)">'+result.name+' — '+mult+'× — +$'+payout.toFixed(2)+'</span>';}
  else{showToast('No win',false);playLoseSound();document.getElementById('pokerResult').innerHTML='<span style="color:var(--red)">No winning hand</span>';}
  recordGame('poker',pokerBetAmt,payout);if(payout>0)firebaseSaveNow();document.getElementById('pokerDealBtn').textContent='DEAL';pokerPhase='idle';
}
function pokerToggleHold(i){if(pokerPhase!=='hold')return;pokerHeld[i]=!pokerHeld[i];pokerRender();playClickSound();}
function pokerRender(){const h=document.getElementById('pokerHand');h.innerHTML='';pokerHandArr.forEach((c,i)=>{const el=document.createElement('div');el.className='poker-card'+(cardIsRed(c)?' red':'')+(pokerHeld[i]?' held':'');el.innerHTML=c.r+'<div class="card-suit" style="font-size:24px;margin-top:4px;">'+c.s+'</div>'+(pokerHeld[i]?'<div class="held-tag">HELD</div>':'');el.onclick=()=>pokerToggleHold(i);el.style.opacity='0';el.style.transform='translateY(20px) scale(0.8)';el.style.transition='all 0.3s ease '+(i*0.08)+'s';h.appendChild(el);requestAnimationFrame(()=>{el.style.opacity='1';el.style.transform=pokerHeld[i]?'translateY(-10px) scale(1)':'translateY(0) scale(1)';});});}
function pokerEvaluate(){const h=pokerHandArr;const ranks=h.map(c=>cardRankIdx(c)).sort((a,b)=>a-b);const suits=h.map(c=>c.s);
  const isFlush=suits.every(s=>s===suits[0]);const counts={};ranks.forEach(r=>{counts[r]=(counts[r]||0)+1;});const vals=Object.values(counts).sort((a,b)=>b-a);
  const isStraight=(ranks[4]-ranks[0]===4&&new Set(ranks).size===5)||(JSON.stringify(ranks)==='[0,9,10,11,12]');
  const isRoyal=isStraight&&isFlush&&ranks[0]===0&&ranks[1]===9;
  if(isRoyal)return{name:'Royal Flush',mult:250};if(isStraight&&isFlush)return{name:'Straight Flush',mult:50};
  if(vals[0]===4)return{name:'Four of a Kind',mult:25};if(vals[0]===3&&vals[1]===2)return{name:'Full House',mult:9};
  if(isFlush)return{name:'Flush',mult:6};if(isStraight)return{name:'Straight',mult:4};
  if(vals[0]===3)return{name:'Three of a Kind',mult:3};if(vals[0]===2&&vals[1]===2)return{name:'Two Pair',mult:2};
  if(vals[0]===2){const pairRank=parseInt(Object.keys(counts).find(k=>counts[k]===2));if(pairRank>=10||pairRank===0)return{name:'Jacks or Better',mult:1};}
  return{name:'No Win',mult:0};
}
function scratchRevealAll(){if(!scratchActive)return;const cells=document.querySelectorAll('.scratch-cell');let delay=0;cells.forEach((c,i)=>{if(!c.classList.contains('revealed')){setTimeout(()=>scratchReveal(i),delay);delay+=80;}});}

const HR_HORSES = [
  { name:'Thunder',    emoji:'🐎', color:'#ff4444', spd:82, stam:70, accel:88, consistency:65, mud:40, dirt:85, turf:60, sand:55, temperament:'Hot' },
  { name:'Lightning',  emoji:'🏇', color:'#ffaa00', spd:90, stam:55, accel:92, consistency:50, mud:30, dirt:70, turf:80, sand:45, temperament:'Hot' },
  { name:'Shadow',     emoji:'🐴', color:'#8844ff', spd:72, stam:90, accel:60, consistency:85, mud:75, dirt:65, turf:70, sand:80, temperament:'Cool' },
  { name:'Spirit',     emoji:'🦄', color:'#44aaff', spd:78, stam:82, accel:74, consistency:78, mud:60, dirt:72, turf:88, sand:50, temperament:'Steady' },
  { name:'Blaze',      emoji:'🐎', color:'#44ff44', spd:85, stam:60, accel:80, consistency:55, mud:45, dirt:90, turf:50, sand:70, temperament:'Hot' },
  { name:'Phantom',    emoji:'🏇', color:'#ff44ff', spd:70, stam:88, accel:65, consistency:90, mud:85, dirt:55, turf:75, sand:85, temperament:'Cool' },
  { name:'Cyclone',    emoji:'🐴', color:'#ff8844', spd:88, stam:50, accel:95, consistency:40, mud:50, dirt:80, turf:45, sand:60, temperament:'Wild' },
  { name:'Ironclad',   emoji:'🦄', color:'#aaaaaa', spd:68, stam:95, accel:55, consistency:92, mud:90, dirt:60, turf:65, sand:90, temperament:'Cool' }
];

const HR_TRACKS = [
  { name:'Dusty Speedway',  surface:'dirt',  distance:1200, icon:'🏜️',  gates:8, desc:'Short & fast — speed + accel dominate' },
  { name:'Emerald Meadow',  surface:'turf',  distance:1800, icon:'🌿',  gates:8, desc:'Medium turf — balanced, consistency matters' },
  { name:'Stormwood Bog',   surface:'mud',   distance:1600, icon:'🌧️',  gates:8, desc:'Heavy mud — stamina + mud affinity key' },
  { name:'Sunburn Dunes',   surface:'sand',  distance:2000, icon:'🏖️',  gates:8, desc:'Long sandy grind — stamina + sand affinity' },
  { name:'Iron Mile',       surface:'dirt',  distance:2200, icon:'⚙️',  gates:8, desc:'Long dirt — stamina crucial, speed less so' },
  { name:'Royal Garden',    surface:'turf',  distance:1400, icon:'👑',  gates:8, desc:'Short turf sprint — speed + turf affinity' }
];

const HR_WEATHER = [
  { name:'Sunny',      icon:'☀️',  surfaceBonus:{ turf:8, dirt:3, mud:-10, sand:5 }, staminaDrain:1.15, desc:'Dry & fast — turf shines, mud dries up' },
  { name:'Overcast',   icon:'☁️',  surfaceBonus:{ turf:2, dirt:2, mud:2, sand:2 },   staminaDrain:1.0,  desc:'Neutral conditions' },
  { name:'Rain',       icon:'🌧️', surfaceBonus:{ turf:-5, dirt:-3, mud:15, sand:-8 },staminaDrain:1.1,  desc:'Wet track — mud horses thrive, sand suffers' },
  { name:'Heatwave',   icon:'🔥', surfaceBonus:{ turf:-3, dirt:5, mud:-15, sand:10 },staminaDrain:1.25, desc:'Scorching — high stamina drain, sand boost' },
  { name:'Fog',        icon:'🌫️', surfaceBonus:{ turf:0, dirt:0, mud:5, sand:0 },    staminaDrain:1.05, desc:'Low visibility — consistency is king' },
  { name:'Storm',      icon:'⛈️',  surfaceBonus:{ turf:-8, dirt:-5, mud:20, sand:-12},staminaDrain:1.2,  desc:'Extreme — only mud + stamina horses survive' }
];

const HR_JOCKEYS = [
  { name:'D. Martinez', rating:95, style:'Aggressive',  accelBoost:8,  stamCost:1.15, desc:'Pushes early, burns stamina' },
  { name:'A. Kimura',   rating:90, style:'Closer',      accelBoost:-5, stamCost:0.85, desc:'Conserves energy, finishes strong' },
  { name:'R. Thompson', rating:82, style:'Steady',      accelBoost:2,  stamCost:1.0,  desc:'Balanced — no extremes' },
  { name:'L. Chen',     rating:88, style:'Tactical',    accelBoost:4,  stamCost:0.95, desc:'Adapts mid-race, good consistency' },
  { name:'J. O\'Brien', rating:75, style:'Whip-Happy',  accelBoost:10, stamCost:1.25, desc:'Massive accel but destroys stamina' },
  { name:'M. Santos',   rating:70, style:'Rookie',      accelBoost:0,  stamCost:1.1,  desc:'Unpredictable — high variance' },
  { name:'K. Patel',    rating:85, style:'Rail Rider',  accelBoost:3,  stamCost:0.9,  desc:'Hugs inside rail, saves ground' },
  { name:'S. Williams', rating:78, style:'Front Runner', accelBoost:6, stamCost:1.05, desc:'Fast start, average finish' }
];

const HR_CONDITIONS = ['Fast','Good','Yielding','Soft','Heavy'];

let hrSelected = -1, hrRacing = false;
let hrCurrentTrack = null, hrCurrentWeather = null, hrCurrentCondition = '';
let hrRaceHorses = [];
let hrRaceNum = 0;
let hrForm = {};
let hrMode = 'normal';

function horseInit() {

  HR_HORSES.forEach(h => { if (!hrForm[h.name]) hrForm[h.name] = []; });
  hrSelected = -1;
  hrRacing = false;
  hrGenerateRace();
}

function hrGenerateRace() {
  hrRaceNum++;

  hrCurrentTrack = HR_TRACKS[Math.floor(Math.random() * HR_TRACKS.length)];
  hrCurrentWeather = HR_WEATHER[Math.floor(Math.random() * HR_WEATHER.length)];

  const condIdx = hrCurrentWeather.name === 'Rain' || hrCurrentWeather.name === 'Storm'
    ? 2 + Math.floor(Math.random() * 3)
    : hrCurrentWeather.name === 'Heatwave'
      ? Math.floor(Math.random() * 2)
      : Math.floor(Math.random() * HR_CONDITIONS.length);
  hrCurrentCondition = HR_CONDITIONS[condIdx];

  const jockeyPool = HR_JOCKEYS.slice().sort(() => Math.random() - 0.5);

  hrRaceHorses = HR_HORSES.map((h, i) => {
    const jockey = jockeyPool[i % jockeyPool.length];
    const gate = i + 1;

    const power = hrCalcPower(h, hrCurrentTrack, hrCurrentWeather, hrCurrentCondition, jockey, gate);
    const formBonus = hrCalcFormBonus(h.name);

    return {
      ...h, idx: i, jockey, gate, power, formBonus,
      totalPower: power + formBonus,

      displayNoise: (Math.random() - 0.5) * 8
    };
  });

  const gates = hrRaceHorses.map((_, i) => i + 1).sort(() => Math.random() - 0.5);
  hrRaceHorses.forEach((h, i) => { h.gate = gates[i]; });

  hrRaceHorses.forEach(h => {
    h.power = hrCalcPower(HR_HORSES[h.idx], hrCurrentTrack, hrCurrentWeather, hrCurrentCondition, h.jockey, h.gate);
    h.totalPower = h.power + h.formBonus;
  });

  const powers = hrRaceHorses.map(h => h.totalPower);
  const maxP = Math.max(...powers);
  const exps = powers.map(p => Math.exp((p - maxP) / 12));
  const sumExp = exps.reduce((s, e) => s + e, 0);
  hrRaceHorses.forEach((h, i) => {
    h.trueWinProb = exps[i] / sumExp;
  });

  hrRaceHorses.forEach(h => {
    const noisyPower = h.totalPower + h.displayNoise;
    const noisyExps = hrRaceHorses.map(hh => Math.exp(((hh === h ? noisyPower : hh.totalPower + hh.displayNoise) - maxP) / 12));
    const noisySum = noisyExps.reduce((s, e) => s + e, 0);
    const noisyProb = noisyExps[hrRaceHorses.indexOf(h)] / noisySum;

    const rtp = hrMode === 'advanced' ? 0.88 : 0.78;
    h.displayOdds = Math.max(1.3, parseFloat((rtp / noisyProb).toFixed(1)));

    h.starRating = Math.max(1, Math.min(5, Math.round(h.trueWinProb * 20 + 1.5)));
  });

  hrSelected = -1;
  hrRenderRaceCard();
}

function hrCalcPower(horse, track, weather, condition, jockey, gate) {
  let power = 0;

  const distFactor = Math.max(0.3, 1.0 - (track.distance - 1200) / 2000);
  power += horse.spd * distFactor * 0.35;

  const stamFactor = Math.max(0.3, (track.distance - 1000) / 1500);
  power += horse.stam * stamFactor * 0.3;

  power += horse.accel * distFactor * 0.15;

  const surfaceAff = horse[track.surface] || 50;
  const weatherSurfBonus = weather.surfaceBonus[track.surface] || 0;
  power += (surfaceAff + weatherSurfBonus) * 0.25;

  power += horse.consistency * 0.08;

  const condMult = condition === 'Fast' ? 1.04
    : condition === 'Good' ? 1.0
    : condition === 'Yielding' ? 0.97
    : condition === 'Soft' ? 0.93
    : 0.88;

  const condResistance = 1.0 - (1.0 - condMult) * (1.0 - horse.stam / 200);
  power *= condResistance;

  power += jockey.rating * 0.1;
  power += jockey.accelBoost * distFactor * 0.08;

  const drainPenalty = (weather.staminaDrain - 1.0) * (100 - horse.stam) * 0.02;
  power -= drainPenalty;

  const gateBonus = track.distance < 1500
    ? (4 - gate) * 0.5
    : (gate - 4) * 0.3;
  power += gateBonus;

  if (horse.temperament === 'Hot') {
    power += weather.name === 'Heatwave' ? -3 : weather.name === 'Storm' ? -5 : 1;
  } else if (horse.temperament === 'Cool') {
    power += weather.name === 'Rain' || weather.name === 'Storm' ? 3 : weather.name === 'Heatwave' ? -2 : 0;
  } else if (horse.temperament === 'Wild') {
    power += (Math.random() - 0.3) * 8;
  }

  return power;
}

function hrCalcFormBonus(name) {
  const form = hrForm[name] || [];
  if (form.length === 0) return 0;
  let bonus = 0;
  const recent = form.slice(-5);
  recent.forEach((finish, i) => {
    const weight = 0.5 + (i / recent.length) * 0.5;
    if (finish === 1) bonus += 3 * weight;
    else if (finish === 2) bonus += 1.5 * weight;
    else if (finish === 3) bonus += 0.5 * weight;
    else if (finish >= 7) bonus -= 1.5 * weight;
    else if (finish >= 5) bonus -= 0.5 * weight;
  });
  return bonus;
}

function hrSetMode(mode) {
  hrMode = mode;

  hrGenerateRace();
}

function hrRenderRaceCard() {
  const panel = document.getElementById('horsesPanel');
  if (!panel) return;
  const isAdv = hrMode === 'advanced';

  const sorted = hrRaceHorses.slice().sort((a, b) => a.gate - b.gate);

  let html = '';

  html += '<div class="hr-mode-toggle">';
  html += '<button class="hr-mode-btn' + (!isAdv ? ' active' : '') + '" onclick="hrSetMode(\'normal\')">🐴 NORMAL</button>';
  html += '<button class="hr-mode-btn' + (isAdv ? ' active' : '') + '" onclick="hrSetMode(\'advanced\')">🧠 ADVANCED</button>';
  html += '</div>';

  if (isAdv) {

    html += '<div class="hr-conditions">';
    html += '<div class="hr-cond-item"><span class="hr-cond-label">TRACK</span><span class="hr-cond-val">' + hrCurrentTrack.icon + ' ' + hrCurrentTrack.name + '</span></div>';
    html += '<div class="hr-cond-item"><span class="hr-cond-label">SURFACE</span><span class="hr-cond-val" style="text-transform:uppercase;">' + hrCurrentTrack.surface + '</span></div>';
    html += '<div class="hr-cond-item"><span class="hr-cond-label">DISTANCE</span><span class="hr-cond-val">' + hrCurrentTrack.distance + 'm</span></div>';
    html += '<div class="hr-cond-item"><span class="hr-cond-label">WEATHER</span><span class="hr-cond-val">' + hrCurrentWeather.icon + ' ' + hrCurrentWeather.name + '</span></div>';
    html += '<div class="hr-cond-item"><span class="hr-cond-label">GOING</span><span class="hr-cond-val">' + hrCurrentCondition + '</span></div>';
    html += '<div class="hr-cond-item"><span class="hr-cond-label">RACE #</span><span class="hr-cond-val">' + hrRaceNum + '</span></div>';
    html += '</div>';
    html += '<div class="hr-track-desc">' + hrCurrentTrack.desc + ' · ' + hrCurrentWeather.desc + '</div>';

    html += '<div class="hr-card">';
    html += '<div class="hr-card-header"><span class="hr-col-gate">#</span><span class="hr-col-name">HORSE</span><span class="hr-col-jockey">JOCKEY</span><span class="hr-col-stats">SPD/STA/ACC</span><span class="hr-col-surface">SURF</span><span class="hr-col-form">FORM</span><span class="hr-col-odds">ODDS</span></div>';

    sorted.forEach(h => {
      const form = (hrForm[h.name] || []).slice(-5);
      const formStr = form.length > 0
        ? form.map(f => '<span class="hr-form-dot ' + (f <= 2 ? 'win' : f <= 4 ? 'mid' : 'lose') + '">' + f + '</span>').join('')
        : '<span style="color:var(--text2);font-size:9px;">NEW</span>';
      const surfAff = h[hrCurrentTrack.surface] || 50;
      const surfClass = surfAff >= 80 ? 'hr-surf-great' : surfAff >= 65 ? 'hr-surf-good' : surfAff >= 50 ? 'hr-surf-ok' : 'hr-surf-bad';
      const sel = h.idx === hrSelected ? ' hr-row-sel' : '';

      html += '<div class="hr-card-row' + sel + '" onclick="hrSelectHorse(' + h.idx + ')" data-idx="' + h.idx + '">';
      html += '<span class="hr-col-gate">' + h.gate + '</span>';
      html += '<span class="hr-col-name" style="color:' + h.color + ';">' + h.emoji + ' ' + h.name + ' <span class="hr-temperament">' + h.temperament[0] + '</span></span>';
      html += '<span class="hr-col-jockey"><span class="hr-jockey-name">' + h.jockey.name + '</span><span class="hr-jockey-style">' + h.jockey.style + ' (' + h.jockey.rating + ')</span></span>';
      html += '<span class="hr-col-stats">' + h.spd + '/' + h.stam + '/' + h.accel + '</span>';
      html += '<span class="hr-col-surface ' + surfClass + '">' + surfAff + '</span>';
      html += '<span class="hr-col-form">' + formStr + '</span>';
      html += '<span class="hr-col-odds">' + h.displayOdds + '×</span>';
      html += '</div>';
    });
    html += '</div>';

    html += '<div class="hr-detail" id="hrDetail"></div>';

  } else {

    html += '<div class="hr-conditions" style="gap:10px;">';
    html += '<div class="hr-cond-item"><span class="hr-cond-label">TRACK</span><span class="hr-cond-val">' + hrCurrentTrack.icon + ' ' + hrCurrentTrack.name + '</span></div>';
    html += '<div class="hr-cond-item"><span class="hr-cond-label">WEATHER</span><span class="hr-cond-val">' + hrCurrentWeather.icon + ' ' + hrCurrentWeather.name + '</span></div>';
    html += '<div class="hr-cond-item"><span class="hr-cond-label">RACE #</span><span class="hr-cond-val">' + hrRaceNum + '</span></div>';
    html += '</div>';

    html += '<div class="hr-card">';
    html += '<div class="hr-card-header hr-normal-header"><span class="hr-col-gate">#</span><span class="hr-col-name">HORSE</span><span class="hr-col-rating">RATING</span><span class="hr-col-odds">ODDS</span></div>';

    sorted.forEach(h => {
      const sel = h.idx === hrSelected ? ' hr-row-sel' : '';
      const stars = '⭐'.repeat(h.starRating) + '<span style="opacity:.2;">⭐</span>'.repeat(5 - h.starRating);

      html += '<div class="hr-card-row hr-normal-row' + sel + '" onclick="hrSelectHorse(' + h.idx + ')" data-idx="' + h.idx + '">';
      html += '<span class="hr-col-gate">' + h.gate + '</span>';
      html += '<span class="hr-col-name" style="color:' + h.color + ';">' + h.emoji + ' ' + h.name + '</span>';
      html += '<span class="hr-col-rating">' + stars + '</span>';
      html += '<span class="hr-col-odds">' + h.displayOdds + '×</span>';
      html += '</div>';
    });
    html += '</div>';

    html += '<div id="hrDetail"></div>';
  }

  html += '<div class="horse-track" id="horseTrack"></div>';
  html += '<div id="horseResult"></div>';

  html += '<div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;justify-content:center;">';
  html += '<div class="bet-controls"><span style="color:var(--text2);font-size:12px;font-weight:600;">BET</span>';
  html += '<button class="bet-btn bet-half" onclick="adjustBet(\'horseBet\',0.5)">½</button>';
  html += '<input class="bet-input" type="text" id="horseBet" value="10">';
  html += '<button class="bet-btn bet-double" onclick="adjustBet(\'horseBet\',2)">2×</button>';
  html += '<button class="bet-btn" onclick="betAll(\'horseBet\')" style="background:var(--gold);color:#000;font-weight:900;font-size:10px;">MAX</button>';
  html += '</div>';
  html += '<button class="action-btn primary" id="horseRaceBtn" onclick="horseRace()">🏇 RACE!</button>';
  html += '<button class="action-btn" onclick="hrGenerateRace()" style="font-size:10px;padding:8px 14px;background:var(--surface);border:1px solid var(--border);">🔄 NEW RACE</button>';
  html += '</div>';

  html += '<div class="hr-legend">';
  if (isAdv) {
    html += '<div class="hr-leg-item">SPD = Speed · STA = Stamina · ACC = Acceleration</div>';
    html += '<div class="hr-leg-item">SURF = Surface affinity (higher = better on this track)</div>';
    html += '<div class="hr-leg-item">FORM = Last 5 finishes (<span class="hr-form-dot win">1</span>=1st <span class="hr-form-dot mid">3</span>=3rd <span class="hr-form-dot lose">7</span>=7th)</div>';
    html += '<div class="hr-leg-item">Temperament: <b>H</b>ot (nervous in bad weather) · <b>C</b>ool (rain lover) · <b>W</b>ild (unpredictable) · <b>S</b>teady</div>';
    html += '<div class="hr-leg-item">Jockey style + rating affects acceleration and stamina drain</div>';
    html += '<div class="hr-leg-item">Going: Fast > Good > Yielding > Soft > Heavy — stamina horses love heavy going</div>';
    html += '<div class="hr-leg-item" style="color:var(--gold);">💡 The odds have noise — if you can read every stat and find a mispriced horse, that\'s free money. Study the matchup.</div>';
  } else {
    html += '<div class="hr-leg-item">⭐ Stars show how likely a horse is to win this race</div>';
    html += '<div class="hr-leg-item">More stars = more likely to win, but lower payout</div>';
    html += '<div class="hr-leg-item">Fewer stars = longshot, but pays way more if it wins</div>';
    html += '<div class="hr-leg-item" style="color:var(--neon);">💡 Want bigger payouts and deeper strategy? Switch to <b>ADVANCED</b> mode!</div>';
  }
  html += '</div>';

  const htpBox = panel.querySelector('.htp-box');
  const titleDiv = panel.querySelector(':scope > div:nth-child(2)');

  const children = Array.from(panel.children);
  children.forEach((c, i) => { if (i > 1) c.remove(); });

  const wrapper = document.createElement('div');
  wrapper.id = 'hrContent';
  wrapper.innerHTML = html;
  panel.appendChild(wrapper);
}

function hrSelectHorse(idx) {
  if (hrRacing) return;
  hrSelected = idx;
  playClickSound();

  document.querySelectorAll('.hr-card-row').forEach(r => {
    r.classList.toggle('hr-row-sel', parseInt(r.dataset.idx) === idx);
  });

  const h = hrRaceHorses.find(hh => hh.idx === idx);
  if (!h) return;
  const det = document.getElementById('hrDetail');
  if (!det) return;

  if (hrMode !== 'advanced') { det.innerHTML = ''; return; }

  const surfAff = h[hrCurrentTrack.surface] || 50;
  const weatherBonus = hrCurrentWeather.surfaceBonus[hrCurrentTrack.surface] || 0;
  const form = (hrForm[h.name] || []).slice(-5);

  det.innerHTML = `<div class="hr-detail-inner">
    <div class="hr-det-title" style="color:${h.color};">${h.emoji} ${h.name} <span style="font-size:10px;color:var(--text2);">Gate ${h.gate} · ${h.temperament}</span></div>
    <div class="hr-det-grid">
      <div class="hr-det-stat"><span class="hr-det-label">Speed</span><div class="hr-stat-bar"><div class="hr-stat-fill" style="width:${h.spd}%;background:#ff4444;"></div></div><span class="hr-det-val">${h.spd}</span></div>
      <div class="hr-det-stat"><span class="hr-det-label">Stamina</span><div class="hr-stat-bar"><div class="hr-stat-fill" style="width:${h.stam}%;background:#44aaff;"></div></div><span class="hr-det-val">${h.stam}</span></div>
      <div class="hr-det-stat"><span class="hr-det-label">Accel</span><div class="hr-stat-bar"><div class="hr-stat-fill" style="width:${h.accel}%;background:#44ff44;"></div></div><span class="hr-det-val">${h.accel}</span></div>
      <div class="hr-det-stat"><span class="hr-det-label">Consistency</span><div class="hr-stat-bar"><div class="hr-stat-fill" style="width:${h.consistency}%;background:#ff8844;"></div></div><span class="hr-det-val">${h.consistency}</span></div>
      <div class="hr-det-stat"><span class="hr-det-label">${hrCurrentTrack.surface.toUpperCase()} Affinity</span><div class="hr-stat-bar"><div class="hr-stat-fill" style="width:${surfAff}%;background:var(--gold);"></div></div><span class="hr-det-val">${surfAff}${weatherBonus !== 0 ? ' (' + (weatherBonus > 0 ? '+' : '') + weatherBonus + ' weather)' : ''}</span></div>
    </div>
    <div class="hr-det-jockey">Jockey: <b>${h.jockey.name}</b> (${h.jockey.rating}) — ${h.jockey.style} — ${h.jockey.desc}</div>
    <div class="hr-det-form">Form: ${form.length > 0 ? form.join('-') : 'No history'} ${h.formBonus !== 0 ? '(' + (h.formBonus > 0 ? '+' : '') + h.formBonus.toFixed(1) + ' power)' : ''}</div>
  </div>`;
}

function horseSelect(i) { hrSelectHorse(i); }

function horseRace() {
  if (hrRacing || hrSelected < 0) { if (hrSelected < 0) showToast('Pick a horse first!', false); return; }
  const bet = parseBet(document.getElementById('horseBet').value) || 10;
  if (bet <= 0) return;
  if (bet > balance) { showToast('Not enough!', false); return; }
  if (typeof checkMaxBet === 'function' && !checkMaxBet(bet, 'Horses')) return;

  hrRacing = true;
  const hrLockedSelection = hrSelected;
  balance -= bet;
  updateBalDisplay();if(!firebaseSaveBet(bet)){hrRacing=false;return;}
  document.getElementById('horseRaceBtn').disabled = true;
  document.getElementById('horseResult').textContent = '';
  playClickSound();

  const trackDiv = document.getElementById('horseTrack');
  trackDiv.innerHTML = '';
  const sortedByGate = hrRaceHorses.slice().sort((a, b) => a.gate - b.gate);
  sortedByGate.forEach(h => {
    trackDiv.innerHTML += '<div class="horse-lane"><div class="horse-name" style="color:' + h.color + '">' + h.emoji + ' ' + h.name + '</div><div class="horse-bar"><div class="horse-progress" id="hp' + h.idx + '" style="width:0%;background:' + h.color + ';opacity:.6;"></div><div class="horse-emoji" id="he' + h.idx + '" style="left:0%;">' + h.emoji + '</div></div></div>';
  });

  const progress = hrRaceHorses.map(() => 0);
  const energy = hrRaceHorses.map(h => h.stam);
  const dist = hrCurrentTrack.distance;
  const staminaDrain = hrCurrentWeather.staminaDrain;

  const raceInterval = setInterval(() => {
    let winner = -1;

    hrRaceHorses.forEach((h, i) => {
      if (progress[i] >= 100) return;

      let tick = h.totalPower * 0.018;

      if (progress[i] < 20) {
        tick *= 0.6 + (h.accel / 100) * 0.6 + (h.jockey.accelBoost / 100) * 0.3;
      }

      if (progress[i] >= 20 && progress[i] < 70) {
        const consistencyVar = (100 - h.consistency) / 100;
        tick *= 1.0 + (Math.random() - 0.5) * consistencyVar * 0.5;
      }

      if (progress[i] >= 70) {
        const energyRatio = Math.max(0.2, energy[i] / h.stam);
        tick *= 0.7 + energyRatio * 0.5;

        if (h.jockey.style === 'Closer') tick *= 1.12;
        if (h.jockey.style === 'Front Runner') tick *= 0.92;
      }

      energy[i] -= staminaDrain * h.jockey.stamCost * 0.3;
      if (energy[i] < 0) energy[i] = 0;

      const noise = h.temperament === 'Wild' ? (Math.random() - 0.4) * 1.2 : (Math.random() - 0.45) * 0.5;
      tick += noise;

      tick = Math.max(0.1, tick);
      progress[i] += tick;
      if (progress[i] >= 100) { progress[i] = 100; if (winner < 0) winner = i; }

      const el = document.getElementById('hp' + h.idx);
      const em = document.getElementById('he' + h.idx);
      if (el) el.style.width = progress[i] + '%';
      if (em) em.style.left = Math.min(progress[i], 95) + '%';
    });

    if (winner >= 0) {
      clearInterval(raceInterval);
      hrRacing = false;
      document.getElementById('horseRaceBtn').disabled = false;

      const winHorse = hrRaceHorses[winner];

      const finishOrder = hrRaceHorses.map((h, i) => ({ idx: i, progress: progress[i], name: h.name }))
        .sort((a, b) => b.progress - a.progress);
      finishOrder.forEach((f, pos) => {
        if (!hrForm[f.name]) hrForm[f.name] = [];
        hrForm[f.name].push(pos + 1);
        if (hrForm[f.name].length > 10) hrForm[f.name].shift();
      });

      const myHorse = hrRaceHorses.find(h => h.idx === hrLockedSelection);
      const myFinish = finishOrder.findIndex(f => f.idx === hrLockedSelection) + 1;
      const odds = myHorse.displayOdds;

      if (winner === hrLockedSelection) {
        const w = bet * odds * getPrestigeMultiplier();
        balance += w;
        updateBalDisplay();
        if (typeof showBigWin === 'function') showBigWin(w);
        showToast(winHorse.emoji + ' ' + winHorse.name + ' WINS! +$' + w.toFixed(2));
        playWinSound();
        if (typeof spawnParticles === 'function') spawnParticles(window.innerWidth / 2, window.innerHeight / 2, 40);
        document.getElementById('horseResult').innerHTML = '<span style="color:var(--green)">' + winHorse.emoji + ' ' + winHorse.name + ' WINS! +$' + w.toFixed(2) + ' (' + odds + '×)</span>';
        recordGame('horses', bet, w);
        firebaseSaveNow();
      } else {
        showToast(winHorse.name + ' wins — you finished #' + myFinish, false);
        playLoseSound();
        document.getElementById('horseResult').innerHTML = '<span style="color:var(--red)">' + winHorse.emoji + ' ' + winHorse.name + ' wins — ' + myHorse.emoji + ' ' + myHorse.name + ' finished #' + myFinish + '</span>';
        recordGame('horses', bet, 0);
      }

      let orderHtml = '<div class="hr-finish-order">';
      finishOrder.forEach((f, pos) => {
        const h = hrRaceHorses[f.idx];
        const medal = pos === 0 ? '🥇' : pos === 1 ? '🥈' : pos === 2 ? '🥉' : (pos + 1) + '.';
        orderHtml += '<span class="hr-finish-item" style="color:' + h.color + ';">' + medal + h.emoji + h.name + '</span>';
      });
      orderHtml += '</div>';
      document.getElementById('horseResult').innerHTML += orderHtml;

      setTimeout(() => { hrGenerateRace(); }, 4000);
    }
  }, 50);
}

function horseSetOdds() {  }

const SCRATCH_TIERS=[{name:'Basic',price:5,symbols:['🍒','🍋','🔔','💎','7️⃣','⭐'],maxWin:50},{name:'Silver',price:25,symbols:['💎','7️⃣','⭐','👑','💰','🏆'],maxWin:500},{name:'Gold',price:100,symbols:['👑','💰','🏆','💎','🔥','🌟'],maxWin:5000},{name:'Diamond',price:500,symbols:['💎','👑','🔥','🌟','💀','🌀'],maxWin:50000}];
let scratchTier=0,scratchCells=[],scratchRevealed=0,scratchActive=false;
function scratchSelectTier(t,btn){scratchTier=t;document.querySelectorAll('.scratch-tier').forEach(b=>b.classList.remove('selected'));if(btn)btn.classList.add('selected');document.getElementById('scratchBuyBtn').textContent='BUY CARD — $'+SCRATCH_TIERS[t].price;playClickSound();}
function scratchBuy(){if(scratchActive)return;const tier=SCRATCH_TIERS[scratchTier];
  if(tier.price>balance){showToast('Not enough balance!',false);return;}
  balance-=tier.price;updateBalDisplay();scratchActive=true;scratchRevealed=0;scratchCells=[];
  const r=Math.random();let winCount=0;if(r<0.05)winCount=4;else if(r<0.22)winCount=3;
  if(winCount>0){
    const winSym=tier.symbols[Math.floor(Math.random()*tier.symbols.length)];
    const others=tier.symbols.filter(s=>s!==winSym);
    for(let i=0;i<9;i++){if(i<winCount)scratchCells.push(winSym);else{

      let pick;do{pick=others[Math.floor(Math.random()*others.length)];}while(scratchCells.filter(s=>s===pick).length>=2);scratchCells.push(pick);
    }}
  } else {

    const syms=tier.symbols.slice();
    for(let i=0;i<9;i++){
      const valid=syms.filter(s=>scratchCells.filter(c=>c===s).length<2);
      scratchCells.push(valid[Math.floor(Math.random()*valid.length)]);
    }
  }
  for(let i=scratchCells.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[scratchCells[i],scratchCells[j]]=[scratchCells[j],scratchCells[i]];}
  document.getElementById('scratchResult').textContent='';const g=document.getElementById('scratchGrid');g.innerHTML='';
  scratchCells.forEach((_,i)=>{const c=document.createElement('div');c.className='scratch-cell';c.textContent='?';c.onclick=()=>scratchReveal(i);g.appendChild(c);});document.getElementById('scratchRevealAllBtn').style.display='inline-block';playClickSound();
}
function scratchReveal(i){if(!scratchActive)return;const cells=document.querySelectorAll('.scratch-cell');if(cells[i].classList.contains('revealed'))return;
  cells[i].classList.add('revealed');cells[i].textContent=scratchCells[i];scratchRevealed++;playSound(500+Math.random()*200,'sine',.04,.03);
  if(scratchRevealed===9){scratchActive=false;document.getElementById('scratchRevealAllBtn').style.display='none';const tier=SCRATCH_TIERS[scratchTier];const counts={};scratchCells.forEach(s=>{counts[s]=(counts[s]||0)+1;});
    let maxC=0;Object.values(counts).forEach(c=>{if(c>maxC)maxC=c;});let payout=0;
    if(maxC>=3){payout=tier.price*(maxC===3?3:maxC===4?10:50)*getPrestigeMultiplier();payout=Math.min(payout,tier.maxWin);}
    if(payout>0){balance+=payout;updateBalDisplay();showBigWin(payout);showToast(maxC+' matches! +$'+payout.toFixed(2));playWinSound();spawnParticles(window.innerWidth/2,window.innerHeight/2,30);
      document.getElementById('scratchResult').innerHTML='<span style="color:var(--green)">'+maxC+' MATCHES — +$'+payout+'!</span>';recordGame('scratch',tier.price,payout);firebaseSaveNow();}
    else{showToast('No matches',false);playLoseSound();document.getElementById('scratchResult').innerHTML='<span style="color:var(--red)">No matches</span>';recordGame('scratch',tier.price,0);}
  }
}

const WHEEL_SEGMENTS=[{label:'0×',mult:0,color:'#333',weight:8},{label:'0.5×',mult:0.5,color:'#444',weight:9},{label:'1×',mult:1,color:'#555',weight:7},{label:'1.5×',mult:1.5,color:'#1a5a1a',weight:4},{label:'2×',mult:2,color:'#2a7a2a',weight:2.5},{label:'3×',mult:3,color:'#1a1a8e',weight:1.2},{label:'5×',mult:5,color:'#6b2fd9',weight:0.5},{label:'10×',mult:10,color:'#cc2233',weight:0.15},{label:'50×',mult:50,color:'#ffd700',weight:0.02}];
let wheelAngle=0,wheelSpinning=false,wheelDrawn=false;
function drawWheel(angle){wheelDrawn=true;const c=document.getElementById('wheelCanvas');if(!c)return;const ctx=c.getContext('2d');const cx=c.width/2,cy=c.height/2,r=c.width/2-8;ctx.clearRect(0,0,c.width,c.height);
  const totalW=WHEEL_SEGMENTS.reduce((s,seg)=>s+seg.weight,0);let curAngle=angle;
  WHEEL_SEGMENTS.forEach(seg=>{const sliceAngle=(seg.weight/totalW)*Math.PI*2;ctx.beginPath();ctx.moveTo(cx,cy);ctx.arc(cx,cy,r,curAngle,curAngle+sliceAngle);ctx.closePath();ctx.fillStyle=seg.color;ctx.fill();ctx.strokeStyle='rgba(255,255,255,.15)';ctx.lineWidth=2;ctx.stroke();
    const ta=curAngle+sliceAngle/2;const tx=cx+Math.cos(ta)*(r*.62);const ty=cy+Math.sin(ta)*(r*.62);ctx.save();ctx.translate(tx,ty);ctx.rotate(ta+Math.PI/2);ctx.fillStyle='#fff';ctx.font='bold 11px Orbitron';ctx.textAlign='center';ctx.textBaseline='middle';ctx.globalAlpha=0.95;ctx.fillText(seg.label,0,0);ctx.restore();curAngle+=sliceAngle;});
  ctx.beginPath();ctx.arc(cx,cy,r*.12,0,Math.PI*2);ctx.fillStyle='#1a1a3e';ctx.fill();ctx.strokeStyle='rgba(255,215,0,.4)';ctx.lineWidth=2;ctx.stroke();
  ctx.beginPath();ctx.arc(cx,cy,r+2,0,Math.PI*2);ctx.strokeStyle='rgba(255,215,0,.2)';ctx.lineWidth=4;ctx.stroke();
}
function wheelSpin(){if(wheelSpinning)return;const bet=parseBet(document.getElementById('wheelBet').value)||10;if(bet<=0)return;if(bet>balance){showToast('Not enough!',false);return;}
  if(!checkMaxBet(bet,'Wheel'))return;
  wheelSpinning=true;balance-=bet;updateBalDisplay();if(!firebaseSaveBet(bet)){wheelSpinning=false;return;}document.getElementById('wheelSpinBtn').disabled=true;document.getElementById('wheelResult').textContent='';playClickSound();
  const totalW=WHEEL_SEGMENTS.reduce((s,seg)=>s+seg.weight,0);let rnd=Math.random()*totalW,winIdx=0;
  for(let i=0;i<WHEEL_SEGMENTS.length;i++){rnd-=WHEEL_SEGMENTS[i].weight;if(rnd<=0){winIdx=i;break;}}const seg=WHEEL_SEGMENTS[winIdx];
  let cumAngle=0;for(let i=0;i<winIdx;i++){cumAngle+=(WHEEL_SEGMENTS[i].weight/totalW)*Math.PI*2;}cumAngle+=(seg.weight/totalW)*Math.PI;
  const targetAngle=-Math.PI/2-cumAngle+Math.PI*2*(5+Math.random()*3);const startAngle=wheelAngle;const totalRot=targetAngle-startAngle;
  const dur=3500;const st=performance.now();
  let lastTickAngle=startAngle;const tickSize=(WHEEL_SEGMENTS[0].weight/totalW)*Math.PI*2;
  function anim(now){const elapsed=now-st;const prog=Math.min(elapsed/dur,1);const eased=1-Math.pow(1-prog,4);const cur=startAngle+totalRot*eased;drawWheel(cur);
    if(Math.abs(cur-lastTickAngle)>tickSize){lastTickAngle=cur;playSound(600+Math.random()*200,'sine',.015,.01);}
    if(prog<1)requestAnimationFrame(anim);
    else{wheelAngle=cur%(Math.PI*2);wheelSpinning=false;document.getElementById('wheelSpinBtn').disabled=false;

      const pm=getPrestigeMultiplier();
      const payout=bet*seg.mult*pm;
      const effMult=Math.round(seg.mult*pm*100)/100;
      const mLabel=seg.mult===0?'0×':(effMult%1===0?effMult+'×':effMult.toFixed(2)+'×');
      if(payout>0){balance+=payout;updateBalDisplay();showBigWin(payout);showToast(mLabel+' +$'+payout.toFixed(2));if(seg.mult>=2)playWinSound();else playClickSound();
        if(seg.mult>=5)spawnParticles(window.innerWidth/2,window.innerHeight/2,30+seg.mult*5);
        document.getElementById('wheelResult').innerHTML='<span style="color:var(--green)">'+mLabel+' — +$'+payout.toFixed(2)+'</span>';recordGame('wheel',bet,payout);firebaseSaveNow();}
      else{showToast(mLabel,false);playLoseSound();document.getElementById('wheelResult').innerHTML='<span style="color:var(--red)">'+mLabel+'</span>';recordGame('wheel',bet,0);}
    }
  }requestAnimationFrame(anim);
}

let baccBetType=null;
function baccSelect(type,btn){if(typeof _baccLocked!=='undefined'&&_baccLocked)return;baccBetType=type;document.querySelectorAll('.bacc-bet').forEach(b=>b.classList.remove('selected'));if(btn)btn.classList.add('selected');playClickSound();}
let _baccLocked=false;
function baccCardVal(c){const v=cardNumVal(c);return v===11?1:v>=10?0:v;}
function baccHandTotal(hand){return hand.reduce((s,c)=>s+baccCardVal(c),0)%10;}
function baccDeal(){if(!baccBetType){showToast('Select bet!',false);return;}if(_baccLocked){showToast('Wait for current hand!',false);return;}const bet=parseBet(document.getElementById('baccBet').value)||10;if(bet<=0)return;if(bet>balance){showToast('Not enough!',false);return;}
  if(!checkMaxBet(bet,'Baccarat'))return;

  const lockedBaccBet=baccBetType;
  _baccLocked=true;
  document.querySelectorAll('.bacc-bet').forEach(b=>{b.disabled=true;b.style.pointerEvents='none';});
  balance-=bet;updateBalDisplay();if(!firebaseSaveBet(bet)){_baccLocked=false;return;}const deck=newDeck();const player=[deck.pop(),deck.pop()],banker=[deck.pop(),deck.pop()];
  let pScore=baccHandTotal(player),bScore=baccHandTotal(banker);
  if(pScore<8&&bScore<8){let pThird=null;
    if(pScore<=5){pThird=deck.pop();player.push(pThird);pScore=baccHandTotal(player);}
    if(!pThird){if(bScore<=5)banker.push(deck.pop());}
    else{const pTV=baccCardVal(pThird);
      if(bScore<=2)banker.push(deck.pop());
      else if(bScore===3&&pTV!==8)banker.push(deck.pop());
      else if(bScore===4&&[2,3,4,5,6,7].includes(pTV))banker.push(deck.pop());
      else if(bScore===5&&[4,5,6,7].includes(pTV))banker.push(deck.pop());
      else if(bScore===6&&[6,7].includes(pTV))banker.push(deck.pop());
    }
  }
  pScore=baccHandTotal(player);bScore=baccHandTotal(banker);
  document.getElementById('baccPlayerCards').innerHTML='';
  document.getElementById('baccBankerCards').innerHTML='';
  document.getElementById('baccPlayerScore').textContent='?';
  document.getElementById('baccBankerScore').textContent='?';
  document.getElementById('baccResult').innerHTML='<span style="color:var(--text2)">Dealing...</span>';
  const allCards=[];
  allCards.push({side:'player',card:player[0]});allCards.push({side:'banker',card:banker[0]});
  allCards.push({side:'player',card:player[1]});allCards.push({side:'banker',card:banker[1]});
  if(player.length>2)allCards.push({side:'player',card:player[2]});
  if(banker.length>2)allCards.push({side:'banker',card:banker[2]});
  let ci=0;
  const dealInterval=setInterval(()=>{
    if(ci>=allCards.length){clearInterval(dealInterval);
      document.getElementById('baccPlayerScore').textContent=pScore;
      document.getElementById('baccBankerScore').textContent=bScore;
      let winner=pScore>bScore?'player':bScore>pScore?'banker':'tie';let payout=0;
      if(winner===lockedBaccBet){if(lockedBaccBet==='player')payout=bet*2*getPrestigeMultiplier();else if(lockedBaccBet==='banker')payout=bet*1.95*getPrestigeMultiplier();else payout=bet*9*getPrestigeMultiplier();}
      else if(winner==='tie'&&lockedBaccBet!=='tie'){payout=bet;}
      setTimeout(()=>{
        _baccLocked=false;
        document.querySelectorAll('.bacc-bet').forEach(b=>{b.disabled=false;b.style.pointerEvents='';});
        if(payout>bet){balance+=payout;updateBalDisplay();showBigWin(payout);showToast((winner==='tie'?'TIE':winner.toUpperCase())+' +$'+(payout-bet).toFixed(2));playWinSound();
          spawnParticles(window.innerWidth/2,window.innerHeight/2,25);document.getElementById('baccResult').innerHTML='<span style="color:var(--green)">'+winner.toUpperCase()+' WINS! +$'+payout.toFixed(2)+'</span>';recordGame('baccarat',bet,payout);addResultDot('baccHistory',winner[0].toUpperCase(),true);firebaseSaveNow();}
        else if(payout===bet){balance+=payout;updateBalDisplay();showToast('Push');document.getElementById('baccResult').innerHTML='<span style="color:var(--gold)">PUSH</span>';recordGame('baccarat',bet,bet);addResultDot('baccHistory','T',false);}
        else{showToast('-$'+bet.toFixed(2),false);playLoseSound();document.getElementById('baccResult').innerHTML='<span style="color:var(--red)">'+winner.toUpperCase()+' WINS</span>';recordGame('baccarat',bet,0);addResultDot('baccHistory',winner[0].toUpperCase(),false);}
      },400);
      return;
    }
    const {side,card}=allCards[ci];
    const container=document.getElementById(side==='player'?'baccPlayerCards':'baccBankerCards');
    const el=document.createElement('div');el.innerHTML=renderCard(card);const cardEl=el.firstChild;
    cardEl.style.opacity='0';cardEl.style.transform='translateY(-20px)';cardEl.style.transition='all 0.3s ease';
    container.appendChild(cardEl);
    requestAnimationFrame(()=>{cardEl.style.opacity='1';cardEl.style.transform='translateY(0)';});
    playSound(300+ci*80,'sine',.03,.02);ci++;
  },450);
  playClickSound();
}

let hiloDeck=[],hiloCard=null,hiloStreakCount=0,hiloBetAmt=0,hiloActive=false,hiloSkipCount=0;
const HILO_MAX_MULT=500;
const HILO_SKIP_PENALTY=0.10;
function hiloMultiplier(){
  if(hiloStreakCount===0)return 1;
  let m=1;for(let i=0;i<hiloStreakCount;i++)m*=1.55;

  for(let i=0;i<hiloSkipCount;i++)m*=(1-HILO_SKIP_PENALTY);
  m=Math.round(m*100)/100;
  return Math.min(m,HILO_MAX_MULT);
}
function hiloStart(){if(hiloActive)return;const bet=parseBet(document.getElementById('hiloBet').value)||10;if(bet<=0)return;
  if(!checkMaxBet(bet,'Hi-Lo'))return;
  if(bet>balance){showToast('Not enough balance!',false);return;}
  hiloBetAmt=bet;balance-=bet;updateBalDisplay();if(!firebaseSaveBet(bet))return;hiloActive=true;hiloStreakCount=0;hiloSkipCount=0;hiloDeck=newDeck();hiloCard=hiloDeck.pop();hiloRender();
  document.getElementById('hiloStartBtn').style.display='none';document.getElementById('hiloCashoutBtn').style.display='';playClickSound();
}
function hiloCashout(){if(!hiloActive||hiloStreakCount===0)return;const p=hiloBetAmt*hiloMultiplier()*getPrestigeMultiplier();balance+=p;updateBalDisplay();
  showBigWin(p);showToast('+$'+p.toFixed(2));playWinSound();spawnParticles(window.innerWidth/2,window.innerHeight/2,25);hiloActive=false;
  document.getElementById('hiloStartBtn').style.display='';document.getElementById('hiloCashoutBtn').style.display='none';
  document.getElementById('hiloStreak').textContent='Cashed out '+hiloMultiplier().toFixed(2)+'× — $'+p.toFixed(2);recordGame('hilo',hiloBetAmt,p);firebaseSaveNow();
}
function hiloGuess(guess){if(!hiloActive)return;
  if(!navigator.onLine){showToast('You are offline! Reconnect to continue.',false);return;}
  if(hiloDeck.length<2)hiloDeck=newDeck();
  const next=hiloDeck.pop();const curRank=cardRankIdx(hiloCard),nextRank=cardRankIdx(next);
  if(guess==='skip'){hiloSkipCount++;hiloCard=next;hiloRender();playSound(400,'sine',.04,.04);
    firebaseSaveNow();
    showToast('Skipped! (-10% payout penalty)',false);return;}
  let correct=false;
  const tied = nextRank===curRank;

  if(guess==='higher')correct=nextRank>curRank;else if(guess==='lower')correct=nextRank<curRank;
  hiloCard=next;
  if(tied){hiloRender();playSound(400,'sine',.06,.05);
    showToast('TIE! Same card — try again.',false);
    document.getElementById('hiloStreak').innerHTML='<span style="color:var(--gold)">TIE!</span> Card was '+next.r+next.s+' — guess again';return;}
  if(correct){hiloStreakCount++;playSound(500+hiloStreakCount*60,'sine',.08,.06);hiloRender();}
  else{hiloActive=false;hiloRender();showToast('-$'+hiloBetAmt.toFixed(2),false);playLoseSound();
    document.getElementById('hiloStartBtn').style.display='';document.getElementById('hiloCashoutBtn').style.display='none';
    document.getElementById('hiloStreak').innerHTML='<span style="color:var(--red)">WRONG!</span> Card was '+next.r+next.s;recordGame('hilo',hiloBetAmt,0);
  }
}
function hiloRender(){const c=hiloCard;document.getElementById('hiloCard').className='hilo-card'+(cardIsRed(c)?' red':'');document.getElementById('hiloCard').innerHTML=c.r+'<br>'+c.s;
  document.getElementById('hiloHigherBtn').disabled=!hiloActive;document.getElementById('hiloLowerBtn').disabled=!hiloActive;document.getElementById('hiloSkipBtn').disabled=!hiloActive;
  if(hiloActive){const m=hiloMultiplier();document.getElementById('hiloStreak').textContent='Streak: '+hiloStreakCount+' — '+m.toFixed(2)+'×'+(hiloSkipCount>0?' ('+hiloSkipCount+' skips, -'+Math.round(100*(1-Math.pow(0.9,hiloSkipCount)))+'%)':'');
    document.getElementById('hiloCashout').textContent=hiloStreakCount>0?'Cash out: $'+(hiloBetAmt*m).toFixed(2):'';}
}

let chatOpen = false;
let chatUnread = 0;
let chatInitialized = false;

function toggleChat() {
  chatOpen = !chatOpen;
  const panel = document.getElementById('chatPanel');
  panel.classList.toggle('open', chatOpen);
  if (chatOpen) {
    chatUnread = 0;
    updateChatBadge();
    if (!chatInitialized && window._initChat) {
      window._initChat();
      chatInitialized = true;
    }
    const input = document.getElementById('chatInput');
    setTimeout(() => input.focus(), 100);

    const msgs = document.getElementById('chatMessages');
    msgs.scrollTop = msgs.scrollHeight;
  }
}

function updateChatBadge() {
  const badge = document.getElementById('chatBadge');
  if (chatUnread > 0) {
    badge.style.display = 'flex';
    badge.textContent = chatUnread > 99 ? '99+' : chatUnread;
  } else {
    badge.style.display = 'none';
  }
}

window._onChatMessages = function(msgs) {
  const container = document.getElementById('chatMessages');
  const wasAtBottom = container.scrollTop >= container.scrollHeight - container.clientHeight - 30;
  container.innerHTML = '<div class="chat-msg-system">Welcome to Casino Royale chat! Be respectful.</div>';

  msgs.forEach(m => {
    if (m.type === 'win') {
      const el = document.createElement('div');
      el.className = 'chat-msg-win';
      el.innerHTML = '<div class="win-text">🎉 ' + escapeHtml(m.text) + '</div>';
      container.appendChild(el);
    } else if (m.type === 'system') {
      const el = document.createElement('div');
      el.className = 'chat-msg-system';
      el.textContent = m.text;
      container.appendChild(el);
    } else {
      const el = document.createElement('div');
      el.className = 'chat-msg';
      const initial = (m.user || '?')[0].toUpperCase();
      const isGuest = (m.user || '').toLowerCase() === 'guest';
      const timeStr = m.ts ? new Date(m.ts).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) : '';
      const pBadge = m.prestige > 0 ? getPrestigeBadgeHTML(m.prestige) : '';
      let roleBadge = '';
      if (m.role === 'owner') roleBadge = '<span class="role-badge-owner">OWNER</span>';
      else if (m.role === 'co-owner') roleBadge = '<span class="role-badge-coowner">CO-OWNER</span>';
      else if (m.role === 'admin') roleBadge = '<span class="role-badge-admin">ADMIN</span>';
      else if (m.role === 'bugtester') roleBadge = '<span class="role-badge-bugtester">BUG TESTER</span>';
      const avatarContent = m.profilePicUrl ? `<img src="${m.profilePicUrl}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">` : initial;
      let chatAdminHtml = '';
      if (modIsStaff()) {
        chatAdminHtml += '<button class="mod-chat-admin-btn" onclick="modDeleteChatMsg(\'' + m.id + '\')" title="Delete message">🗑</button>';
      }
      let modBtnHtml = '';
      if (modIsStaff() && m.uid && m.uid !== window._currentPlayerId) {
        modBtnHtml = ' <button style="font-size:9px;padding:1px 5px;background:rgba(255,50,50,.15);border:1px solid rgba(255,50,50,.3);border-radius:4px;color:#ff6644;cursor:pointer;margin-left:4px;" onclick="modOpenActionOnUser(\'' + m.uid + '\',\'' + escapeHtml(m.user||'Guest') + '\')">MOD</button>';
      }
      el.innerHTML = chatAdminHtml + '<div class="chat-msg-avatar">' + avatarContent + '</div>' +
        '<div class="chat-msg-body">' +
          '<div class="chat-msg-name' + (isGuest ? ' guest-name' : '') + '">' + escapeHtml(m.user||'Guest') + roleBadge + pBadge + ' <span class="chat-msg-time">' + timeStr + '</span>' + modBtnHtml + '</div>' +
          '<div class="chat-msg-text">' + escapeHtml(m.text) + '</div>' +
        '</div>';

      container.appendChild(el);
    }
  });

  if (wasAtBottom || !chatOpen) container.scrollTop = container.scrollHeight;
  if (!chatOpen && msgs.length > 0) {
    chatUnread = Math.min(chatUnread + 1, 99);
    updateChatBadge();
  }
};

window._onChatOnlineCount = function(count) {
  const el = document.getElementById('chatOnlineCount');
  if (el) el.textContent = count > 0 ? '(' + count + ' online)' : '';
};

function escapeHtml(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function sendChatMessage() {
  const input = document.getElementById('chatInput');
  let text = input.value.trim();
  if (!text) return;
  if (isGuestMode) { showToast('Sign in to chat', false); return; }
  if (window._modIsMuted) { showToast('🔇 You are muted!', false); return; }
  if (text.length > 200) text = text.slice(0, 200);
  const username = window._currentUsername || 'Guest';
  if (window._sendChatMsg) {
    window._sendChatMsg(text, username, 'msg').then(()=>{

      const msgs = document.getElementById('chatMessages');
      if(msgs) msgs.scrollTop = msgs.scrollHeight;
    }).catch((e)=>{ showToast('Message failed to send', false); console.error('Chat error:', e); });
  } else {
    showToast('Chat not available', false);
  }
  input.value = '';
}

document.getElementById('chatInput').addEventListener('keydown', function(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendChatMessage();
  }
});

let _lastBroadcast = 0;
const _origRecordGame = recordGame;
recordGame = function(game, wagered, won) {
  _origRecordGame(game, wagered, won);

  const now = Date.now();
  if (won >= 5000 && window._broadcastWin && (now - _lastBroadcast > 15000)) {
    _lastBroadcast = now;
    const username = window._currentUsername || 'Guest';
    const gameNames = {slots:'Slots',crash:'Crash',roulette:'Roulette',cases:'Cases',plinko:'Plinko',
      blackjack:'Blackjack',mines:'Mines',dice:'Dice',tower:'Tower',coinflip:'Coin Flip',
      keno:'Keno',limbo:'Limbo',poker:'Poker',horses:'Horses',scratch:'Scratch',
      wheel:'Wheel',baccarat:'Baccarat',hilo:'Hi-Lo'};
    window._broadcastWin(username, gameNames[game] || game, won);
  }
};

window.addEventListener('load',()=>{
  initSlots();
  initCases();
  resizeCrashCanvas();
  initStocks();
  minesRenderGrid();
  diceUpdateSlider();
  kenoInit();
  horseInit();
  drawWheel(0);

  try{ updatePlinkoProfitChart(); }catch(e){}
  document.getElementById('limboTarget').addEventListener('input',limboUpdateInfo);
  window.addEventListener('resize',()=>{resizeCrashCanvas();resizeParticles();
  try{const wrap=document.querySelector('.plinko-canvas-wrap');if(wrap&&plinkoInitialized&&plinkoMatterRender&&plinkoMatterRender.canvas){plinkoMatterRender.canvas.style.width = wrap.clientWidth + 'px';plinkoMatterRender.canvas.style.height = wrap.clientHeight + 'px';}}
  catch(e){}
  if(document.querySelector('#stocksPanel.active')&&typeof renderStocks==='function'){try{renderStocks();}catch(e){}}
  if(document.querySelector('#wheelPanel.active')&&typeof drawWheel==='function'){try{drawWheel(wheelAngle||0);}catch(e){}}
});

  if(window.visualViewport){document.documentElement.style.setProperty('--vh',window.visualViewport.height+'px');window.visualViewport.addEventListener('resize',()=>{document.documentElement.style.setProperty('--vh',window.visualViewport.height+'px');});}
  setInterval(firebaseSave,30000);

  let _lastTradeReqCount = 0;
  setInterval(async ()=>{
    if(!window._loadTradeRequests || !window._currentPlayerId) return;
    try {
      const reqs = await window._loadTradeRequests();
      if(reqs.length > 0 && reqs.length > _lastTradeReqCount){
        showToast('🤝 You have ' + reqs.length + ' trade request(s)! Check Trade → Inbox', true);
      }
      _lastTradeReqCount = reqs.length;
    } catch(e){}
  }, 10000);

  const logo = document.querySelector('.logo'); if(logo){ logo.addEventListener('click',()=>{ if(_anyGameActive()){showToast('Finish your game first!',false);return;} const catalog=document.getElementById('gameCatalog'); if(catalog) catalog.style.display='flex'; document.querySelectorAll('.game-panel').forEach(p=>p.classList.remove('active')); document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active')); }); }
});

window.addEventListener('beforeunload',()=>{ if(window._flushStatsNow) window._flushStatsNow(); firebaseSaveNow(); });
window.addEventListener('visibilitychange',()=>{ if(document.hidden) firebaseSave(); });

document.addEventListener('keydown',e=>{
  if(e.code==='Space'){

    const tag = (e.target.tagName||'').toUpperCase();
    if(tag==='INPUT'||tag==='TEXTAREA'||tag==='SELECT'||e.target.isContentEditable) return;
    e.preventDefault();
    const panel=document.querySelector('.game-panel.active');
    if(!panel)return;
    if(panel.id==='slotsPanel')spinSlots();
    else if(panel.id==='crashPanel'){if(crashRunning)cashOut();else startCrash();}
    else if(panel.id==='roulettePanel')spinRoulette();
    else if(panel.id==='casesPanel')openCase();
    else if(panel.id==='plinkoPanel')dropPlinkoBall();
    else if(panel.id==='blackjackPanel'){if(bjActive)bjHit();else bjDeal();}
    else if(panel.id==='minesPanel'){if(minesActive)minesCashout();else minesStart();}
    else if(panel.id==='dicePanel')diceRoll();
    else if(panel.id==='towerPanel'){if(towerActive)towerCashout();else towerStart();}
    else if(panel.id==='coinflipPanel')coinFlip();
    else if(panel.id==='kenoPanel')kenoDraw();
    else if(panel.id==='limboPanel')limboGo();
    else if(panel.id==='pokerPanel')pokerDeal();
    else if(panel.id==='horsesPanel')horseRace();
    else if(panel.id==='wheelPanel')wheelSpin();
    else if(panel.id==='baccaratPanel')baccDeal();
    else if(panel.id==='hiloPanel'){if(hiloActive)hiloCashout();else hiloStart();}
  }
});

let bsrState = null;
let bsrDifficulty = 'normal';
const BSR_DIFF = {
  easy:   { rounds:2, hp:5, items:4, mult:2.5, dealerHpScale:1, label:'EASY',   icon:'😎' },
  normal: { rounds:3, hp:4, items:3, mult:4,   dealerHpScale:1, label:'NORMAL', icon:'💀' },
  hard:   { rounds:4, hp:3, items:2, mult:7,   dealerHpScale:1, label:'HARD',   icon:'☠️' },
};
const BSR_ITEM_ICONS = { handcuffs:'🔗', cigarettes:'🚬', gummy:'🍬', saw:'🪚', phone:'📱', magnifying:'🔍' };
const BSR_ITEM_NAMES = { handcuffs:'Handcuffs', cigarettes:'Cigarettes', gummy:'Rotten Gummy', saw:'Saw', phone:'Burner Phone', magnifying:'Magnifying Glass' };
const BSR_ITEM_DESCS = { handcuffs:'Dealer skips next turn', cigarettes:'Heal +1 HP', gummy:'40% +2HP / 60% −1HP', saw:'Next live = 2 dmg', phone:'Reveal random shell', magnifying:'See current shell' };
const BSR_ALL_ITEMS = ['handcuffs','cigarettes','gummy','saw','phone','magnifying'];

let bsrStats = JSON.parse(localStorage.getItem('bsr_stats')) || { wins:0, losses:0, biggestWin:0, streak:0, bestStreak:0 };
function bsrSaveStats(){ localStorage.setItem('bsr_stats', JSON.stringify(bsrStats)); }

function bsrSelectDiff(diff, el) {
  bsrDifficulty = diff;
  document.querySelectorAll('.bsr-diff-card').forEach(c => c.classList.remove('selected'));
  if(el) el.classList.add('selected');
  playClickSound();
}

function initBuckshotRoulette() {
  if (!bsrState || !bsrState.active) {
    document.getElementById('bsrLobby').style.display = 'block';
    document.getElementById('bsrGame').style.display = 'none';
    document.getElementById('bsrGameOver').style.display = 'none';
    document.getElementById('bsrRoundSplash').style.display = 'none';
    bsrUpdateStats();
  }
}

function bsrUpdateStats() {
  const total = bsrStats.wins + bsrStats.losses;
  const wr = total > 0 ? Math.round(bsrStats.wins / total * 100) + '%' : '--';
  const bw = bsrStats.biggestWin > 0 ? '$' + bsrStats.biggestWin.toLocaleString() : '--';
  const el1 = document.getElementById('bsrStatWinRate');
  const el2 = document.getElementById('bsrStatBigWin');
  const el3 = document.getElementById('bsrStatStreak');
  if(el1) el1.textContent = wr;
  if(el2) el2.textContent = bw;
  if(el3) el3.textContent = bsrStats.streak;
}

function bsrStartGame() {
  const bet = parseBet(document.getElementById('bsrBet').value) || 100;
  if (bet <= 0) { showToast('Bet must be positive!', false); return; }
  if (bet > balance) { showToast('Not enough balance!', false); return; }
  balance -= bet; updateBalDisplay();if(!firebaseSaveBet(bet))return;
  playClickSound();

  const diff = BSR_DIFF[bsrDifficulty];
  bsrState = {
    active: true,
    bet: bet,
    diff: bsrDifficulty,
    mult: diff.mult,
    round: 1,
    maxRounds: diff.rounds,
    playerHP: diff.hp,
    playerMaxHP: diff.hp,
    dealerHP: diff.hp,
    dealerMaxHP: diff.hp,
    shells: [],
    shellIndex: 0,
    turn: 'player',
    sawActive: false,
    handcuffs: 0,
    playerHandcuffed: 0,
    maxItems: diff.items,
    items: [],
    dealerItems: [],
    log: [],
    animating: false,
    _dealerKnowsCurrent: null,
    _revealedShells: {},
  };

  document.getElementById('bsrLobby').style.display = 'none';
  document.getElementById('bsrGame').style.display = 'block';
  document.getElementById('bsrGameOver').style.display = 'none';
  document.getElementById('bsrLog').innerHTML = '';

  bsrShowRoundSplash(1, () => bsrNewRound());
}

function bsrShowRoundSplash(roundNum, callback) {
  const splash = document.getElementById('bsrRoundSplash');
  const txt = document.getElementById('bsrRoundSplashText');
  txt.textContent = 'ROUND ' + roundNum;
  splash.style.display = 'flex';
  splash.style.opacity = '0';
  requestAnimationFrame(() => {
    splash.style.transition = 'opacity 0.4s';
    splash.style.opacity = '1';
  });
  setTimeout(() => {
    splash.style.transition = 'opacity 0.5s';
    splash.style.opacity = '0';
    setTimeout(() => {
      splash.style.display = 'none';
      if(callback) callback();
    }, 500);
  }, 1600);
}

function bsrNewRound() {
  const s = bsrState;
  if(!s) return;
  s.animating = false;
  s._dealerKnowsCurrent = null;
  s._revealedShells = {};

  const totalShells = Math.floor(Math.random() * 4) + 4;
  let liveCount = Math.max(1, Math.floor(Math.random() * (totalShells - 1)) + 1);
  if(liveCount >= totalShells) liveCount = totalShells - 1;
  const blankCount = totalShells - liveCount;
  s.shells = [];
  for(let i = 0; i < liveCount; i++) s.shells.push('live');
  for(let i = 0; i < blankCount; i++) s.shells.push('blank');

  for(let i = s.shells.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [s.shells[i], s.shells[j]] = [s.shells[j], s.shells[i]];
  }
  s.shellIndex = 0;
  s.sawActive = false;
  s.handcuffs = 0;
  s.playerHandcuffed = 0;

  s.items = [];
  s.dealerItems = [];
  for(let i = 0; i < s.maxItems; i++) {
    s.items.push(BSR_ALL_ITEMS[Math.floor(Math.random() * BSR_ALL_ITEMS.length)]);
    s.dealerItems.push(BSR_ALL_ITEMS[Math.floor(Math.random() * BSR_ALL_ITEMS.length)]);
  }

  s.turn = s.round % 2 === 1 ? 'player' : 'dealer';

  bsrLog(`⚡ ROUND ${s.round} — Shotgun loaded: ${liveCount} LIVE 🔴, ${blankCount} BLANK 🔵`);
  bsrLog(`${s.items.length} items each. ${s.turn === 'player' ? 'Your' : "Dealer's"} turn first.`);

  bsrRender();
  bsrSetStatus(s.turn === 'player' ? 'Your turn — choose wisely.' : "Dealer's turn...");

  if(s.turn === 'dealer') {
    bsrDisableActions();
    setTimeout(() => bsrDealerTurn(), 2000);
  }
}

function bsrLog(msg) {
  if(!bsrState) return;
  bsrState.log.push(msg);
  const el = document.getElementById('bsrLog');
  if(!el) return;
  el.innerHTML = bsrState.log.map(m => '<div class="bsr-log-line">' + m + '</div>').join('');
  el.scrollTop = el.scrollHeight;
}

function bsrRender() {
  const s = bsrState;
  if(!s) return;

  document.getElementById('bsrRoundInfo').textContent = `ROUND ${s.round}/${s.maxRounds}`;
  document.getElementById('bsrMultiplier').textContent = `${s.mult}× PAYOUT`;

  const remaining = s.shells.length - s.shellIndex;
  const livesLeft = s.shells.slice(s.shellIndex).filter(x => x === 'live').length;
  const blanksLeft = remaining - livesLeft;
  document.getElementById('bsrShellInfo').innerHTML = `<span style="color:#ff4444;">${livesLeft} live</span> / <span style="color:#4488ff;">${blanksLeft} blank</span>`;

  const rack = document.getElementById('bsrShellRack');
  rack.innerHTML = s.shells.map((sh, i) => {
    let cls = 'bsr-shell';
    if(i < s.shellIndex) cls += ' used' + (sh === 'live' ? ' was-live' : ' was-blank');
    else if(i === s.shellIndex) cls += ' current';
    else cls += ' unknown';

    if(i >= s.shellIndex && s._revealedShells[i]) {
      cls += s._revealedShells[i] === 'live' ? ' reveal-live' : ' reveal-blank';
    }
    const label = i < s.shellIndex ? '✓' : (s._revealedShells[i] && i > s.shellIndex ? (s._revealedShells[i] === 'live' ? '🔴' : '🔵') : '?');
    return `<div class="${cls}">${label}</div>`;
  }).join('');

  const pPct = Math.max(0, s.playerHP / s.playerMaxHP * 100);
  const dPct = Math.max(0, s.dealerHP / s.dealerMaxHP * 100);
  const pHP = Math.max(0, s.playerHP);
  const dHP = Math.max(0, s.dealerHP);
  document.getElementById('bsrPlayerHP').textContent = pHP + ' HP';
  document.getElementById('bsrPlayerHPBar').style.width = pPct + '%';
  document.getElementById('bsrPlayerHearts').textContent = '❤️'.repeat(pHP) + '🖤'.repeat(Math.max(0, s.playerMaxHP - pHP));
  document.getElementById('bsrDealerHP').textContent = dHP + ' HP';
  document.getElementById('bsrDealerHPBar').style.width = dPct + '%';
  document.getElementById('bsrDealerHearts').textContent = '❤️'.repeat(dHP) + '🖤'.repeat(Math.max(0, s.dealerMaxHP - dHP));

  const pBar = document.getElementById('bsrPlayerHPBar');
  pBar.style.background = pPct > 50 ? 'linear-gradient(90deg,var(--green),#66ff99)' : pPct > 25 ? 'linear-gradient(90deg,#ff8800,#ffbb00)' : 'linear-gradient(90deg,#ff4444,#ff6666)';
  const dBar = document.getElementById('bsrDealerHPBar');
  dBar.style.background = dPct > 50 ? 'linear-gradient(90deg,#ff4444,#ff8888)' : dPct > 25 ? 'linear-gradient(90deg,#ff8800,#ffbb00)' : 'linear-gradient(90deg,#ff4444,#880000)';

  const itemsEl = document.getElementById('bsrItems');
  const canUse = s.turn === 'player' && !s.animating;
  itemsEl.innerHTML = s.items.map((it, i) =>
    `<button class="bsr-item-btn${canUse ? '' : ' disabled'}" onclick="bsrUseItem(${i})" ${canUse ? '' : 'disabled'}>` +
    `<span class="item-icon">${BSR_ITEM_ICONS[it]}</span>` +
    `<span class="item-info"><span class="item-name">${BSR_ITEM_NAMES[it]}</span><span class="item-desc">${BSR_ITEM_DESCS[it]}</span></span>` +
    `</button>`
  ).join('');

  const dealerItemsEl = document.getElementById('bsrDealerItemsDisplay');
  dealerItemsEl.innerHTML = s.dealerItems.map(it =>
    `<span style="display:inline-block;padding:3px 7px;border-radius:6px;background:rgba(255,68,68,.08);border:1px solid rgba(255,68,68,.15);font-size:11px;color:rgba(255,68,68,.6);">${BSR_ITEM_ICONS[it]}</span>`
  ).join(' ');

  const shotgunEl = document.getElementById('bsrShotgun');
  shotgunEl.textContent = s.sawActive ? '🪚🔫' : '🔫';
  if(s.sawActive) shotgunEl.style.filter = 'drop-shadow(0 0 8px rgba(255,136,0,.6))';
  else shotgunEl.style.filter = '';

  if(canUse) bsrEnableActions(); else bsrDisableActions();
}

function bsrEnableActions() {
  const d = document.getElementById('bsrShootDealer');
  const s = document.getElementById('bsrShootSelf');
  if(d){ d.disabled = false; d.style.opacity = '1'; d.style.pointerEvents = 'auto'; }
  if(s){ s.disabled = false; s.style.opacity = '1'; s.style.pointerEvents = 'auto'; }
}
function bsrDisableActions() {
  const d = document.getElementById('bsrShootDealer');
  const s = document.getElementById('bsrShootSelf');
  if(d){ d.disabled = true; d.style.opacity = '0.35'; d.style.pointerEvents = 'none'; }
  if(s){ s.disabled = true; s.style.opacity = '0.35'; s.style.pointerEvents = 'none'; }
}
function bsrSetStatus(msg) {
  const el = document.getElementById('bsrStatus');
  if(el) el.textContent = msg;
}

function bsrAnimateShotgun(direction, isLive) {

  const gun = document.getElementById('bsrShotgun');
  if(!gun) return;
  gun.classList.add('shake');
  setTimeout(() => {
    gun.classList.remove('shake');
    gun.classList.add(direction === 'left' ? 'recoil-left' : 'recoil-right');

    const shells = document.querySelectorAll('.bsr-shell.current');
    if(shells.length) {
      shells[0].classList.add(isLive ? 'reveal-live' : 'reveal-blank');
    }
    setTimeout(() => {
      gun.classList.remove('recoil-left', 'recoil-right');
    }, 400);
  }, 600);
}

function bsrAnimateHit(who) {

  const card = document.getElementById(who === 'player' ? 'bsrPlayerCard' : 'bsrDealerCard');
  if(!card) return;
  card.classList.add('hit');
  setTimeout(() => card.classList.remove('hit'), 500);
}

function bsrUseItem(index) {
  const s = bsrState;
  if(!s || !s.active || s.turn !== 'player' || s.animating) return;
  if(index < 0 || index >= s.items.length) return;

  const item = s.items[index];
  s.items.splice(index, 1);
  playClickSound();

  switch(item) {
    case 'handcuffs':
      s.handcuffs = Math.max(s.handcuffs, 1);
      bsrLog('🔗 You used Handcuffs! Dealer skips their next turn.');
      bsrSetStatus('Dealer is handcuffed!');
      break;
    case 'cigarettes':
      if(s.playerHP < s.playerMaxHP) {
        s.playerHP = Math.min(s.playerHP + 1, s.playerMaxHP);
        bsrLog('🚬 You smoked a Cigarette. +1 HP! (' + s.playerHP + '/' + s.playerMaxHP + ')');
        bsrSetStatus('+1 HP! Health: ' + s.playerHP + '/' + s.playerMaxHP);
      } else {
        bsrLog('🚬 Cigarette used but HP already full.');
        bsrSetStatus('Already at max HP!');
      }
      break;
    case 'gummy':
      if(Math.random() < 0.4) {
        const heal = Math.min(2, s.playerMaxHP + 1 - s.playerHP);
        s.playerHP += heal;
        bsrLog('🍬 Rotten Gummy worked! +' + heal + ' HP! (' + s.playerHP + ')');
        bsrSetStatus('Lucky! +' + heal + ' HP!');
      } else {
        s.playerHP -= 1;
        bsrLog('🍬 Rotten Gummy backfired! −1 HP (' + s.playerHP + ')');
        bsrSetStatus('Food poisoning! −1 HP');
        if(s.playerHP <= 0) {
          bsrRender();
          bsrAnimateHit('player');
          setTimeout(() => bsrEndGame(false), 1200);
          return;
        }
      }
      break;
    case 'saw':
      s.sawActive = true;
      bsrLog('🪚 Saw attached! Next LIVE shell deals double damage.');
      bsrSetStatus('Saw equipped — next live = 2 damage!');
      break;
    case 'phone': {
      const rem = s.shells.slice(s.shellIndex);
      if(rem.length > 1) {

        const futureIdx = Math.floor(Math.random() * (rem.length - 1)) + 1;
        const absIdx = s.shellIndex + futureIdx;
        const shellType = rem[futureIdx];
        s._revealedShells[absIdx] = shellType;
        bsrLog('📱 Phone call: "Shell #' + (absIdx + 1) + ' is ' + shellType.toUpperCase() + '"');
        bsrSetStatus('Shell #' + (absIdx+1) + ' is ' + shellType.toUpperCase() + (shellType === 'live' ? ' 🔴' : ' 🔵'));
      } else {
        bsrLog('📱 No future shells to reveal.');
        bsrSetStatus('No more shells ahead.');
      }
      break;
    }
    case 'magnifying': {
      const cur = s.shells[s.shellIndex];
      bsrLog('🔍 Current shell: ' + cur.toUpperCase() + (cur === 'live' ? ' 🔴' : ' 🔵'));
      bsrSetStatus('Current shell: ' + cur.toUpperCase() + (cur === 'live' ? ' 🔴' : ' 🔵'));
      break;
    }
  }
  bsrRender();
}

function bsrShoot(target) {
  const s = bsrState;
  if(!s || !s.active || s.animating || s.turn !== 'player') return;
  s.animating = true;
  bsrDisableActions();

  const shell = s.shells[s.shellIndex];
  s.shellIndex++;
  const damage = shell === 'live' ? (s.sawActive ? 2 : 1) : 0;
  if(shell === 'live') s.sawActive = false;

  bsrAnimateShotgun(target === 'dealer' ? 'left' : 'right', shell === 'live');
  bsrSetStatus('💥 ...');

  if(shell === 'live') {
    playSound(120, 'sawtooth', 0.35, 0.2);
    setTimeout(() => playSound(80, 'square', 0.2, 0.1), 100);
  } else {
    playSound(600, 'sine', 0.08, 0.06);
  }

  setTimeout(() => {
    if(target === 'dealer') {
      if(shell === 'live') {
        s.dealerHP -= damage;
        bsrAnimateHit('dealer');
        bsrLog(`🔫 You shot the Dealer — LIVE! ${damage > 1 ? '🪚 SAW: 2 dmg! ' : ''}Dealer: ${Math.max(0,s.dealerHP)} HP`);
        bsrSetStatus(`💥 LIVE! Dealer takes ${damage} damage!`);
      } else {
        bsrLog('🔫 You shot the Dealer — BLANK. No damage.');
        bsrSetStatus('*click* — BLANK. No damage.');
      }
      s.turn = 'dealer';
    } else {
      if(shell === 'live') {
        s.playerHP -= damage;
        bsrAnimateHit('player');
        bsrLog(`🫵 You shot yourself — LIVE! ${damage > 1 ? '🪚 SAW: 2 dmg! ' : ''}You: ${Math.max(0,s.playerHP)} HP`);
        bsrSetStatus(`💥 LIVE! You take ${damage} damage!`);
        s.turn = 'dealer';
      } else {
        bsrLog('🫵 You shot yourself — BLANK! Free extra turn!');
        bsrSetStatus('*click* — BLANK! You get another turn!');
        s.turn = 'player';
      }
    }

    s.animating = false;
    bsrRender();

    if(s.dealerHP <= 0) {
      setTimeout(() => bsrRoundWin(), 1200);
      return;
    }
    if(s.playerHP <= 0) {
      setTimeout(() => bsrEndGame(false), 1200);
      return;
    }
    if(s.shellIndex >= s.shells.length) {
      bsrLog('📦 All shells spent! Reloading...');
      setTimeout(() => {
        bsrShowRoundSplash(s.round, () => bsrNewRound());
      }, 1500);
      return;
    }

    if(target === 'self' && shell === 'blank') {
      bsrRender();
    } else {
      bsrResolveTurn();
    }
  }, 1100);
}

function bsrResolveTurn() {
  const s = bsrState;
  if(!s || !s.active) return;

  if(s.turn === 'dealer') {
    if(s.handcuffs > 0) {
      s.handcuffs--;
      bsrLog('🔗 Dealer is handcuffed! Skipping turn.');
      bsrSetStatus('Dealer is chained! Skipping...');
      s.turn = 'player';
      setTimeout(() => {

        if(s.playerHandcuffed > 0) {
          s.playerHandcuffed--;
          bsrLog('🔗 You are also handcuffed! Skipping turn.');
          bsrSetStatus('You are chained too! Skipping...');
          s.turn = 'dealer';
          bsrRender();
          setTimeout(() => bsrDealerTurn(), 1800);
        } else {
          bsrRender();
        }
      }, 1000);
    } else {
      setTimeout(() => bsrDealerTurn(), 1800);
    }
  } else {
    if(s.playerHandcuffed > 0) {
      s.playerHandcuffed--;
      bsrLog('🔗 You are handcuffed! Skipping turn.');
      bsrSetStatus('You are chained! Skipping...');
      s.turn = 'dealer';
      bsrRender();
      setTimeout(() => {
        if(s.handcuffs > 0) {
          s.handcuffs--;
          bsrLog('🔗 Dealer also handcuffed! Skipping turn.');
          s.turn = 'player';
          bsrRender();
        } else {
          bsrDealerTurn();
        }
      }, 1800);
    } else {
      bsrRender();
    }
  }
}

function bsrDealerTurn() {
  const s = bsrState;
  if(!s || !s.active) return;

  if(s.shellIndex >= s.shells.length) {
    bsrLog('📦 All shells spent! Reloading...');
    setTimeout(() => bsrShowRoundSplash(s.round, () => bsrNewRound()), 1000);
    return;
  }

  bsrSetStatus("🤖 Dealer is thinking...");
  s.animating = true;
  bsrDisableActions();
  bsrRender();

  setTimeout(() => bsrDealerItemLoop(() => bsrDealerShoot()), 1200);
}

function bsrDealerItemLoop(callback) {
  const s = bsrState;
  if(!s || !s.active || !s.dealerItems.length) { callback(); return; }

  let used = false;

  const mgIdx = s.dealerItems.indexOf('magnifying');
  if(mgIdx !== -1) {
    s.dealerItems.splice(mgIdx, 1);
    s._dealerKnowsCurrent = s.shells[s.shellIndex];
    bsrLog('🤖🔍 Dealer peers through a magnifying glass...');
    bsrRender();
    used = true;
    setTimeout(() => bsrDealerItemLoop(callback), 1100);
    return;
  }

  const sawIdx = s.dealerItems.indexOf('saw');
  if(sawIdx !== -1 && s._dealerKnowsCurrent === 'live') {
    s.dealerItems.splice(sawIdx, 1);
    s.sawActive = true;
    bsrLog('🤖🪚 Dealer saws the barrel! Next live = 2 damage.');
    bsrRender();
    used = true;
    setTimeout(() => bsrDealerItemLoop(callback), 1100);
    return;
  }

  const cigIdx = s.dealerItems.indexOf('cigarettes');
  if(cigIdx !== -1 && s.dealerHP < s.dealerMaxHP) {
    s.dealerItems.splice(cigIdx, 1);
    s.dealerHP = Math.min(s.dealerHP + 1, s.dealerMaxHP);
    bsrLog('🤖🚬 Dealer lights a cigarette. +1 HP (' + s.dealerHP + '/' + s.dealerMaxHP + ')');
    bsrRender();
    used = true;
    setTimeout(() => bsrDealerItemLoop(callback), 1100);
    return;
  }

  const hcIdx = s.dealerItems.indexOf('handcuffs');
  if(hcIdx !== -1 && s.playerHandcuffed <= 0 && Math.random() < 0.5) {
    s.dealerItems.splice(hcIdx, 1);
    s.playerHandcuffed = 1;
    bsrLog('🤖🔗 Dealer slaps handcuffs on you! Skip next turn.');
    bsrSetStatus('You are handcuffed!');
    bsrRender();
    used = true;
    setTimeout(() => bsrDealerItemLoop(callback), 1100);
    return;
  }

  const phoneIdx = s.dealerItems.indexOf('phone');
  if(phoneIdx !== -1 && Math.random() < 0.4) {
    s.dealerItems.splice(phoneIdx, 1);
    bsrLog('🤖📱 Dealer makes a phone call... (intel hidden)');

    const rem = s.shells.slice(s.shellIndex);
    if(rem.length > 1) {
      const fi = Math.floor(Math.random() * (rem.length - 1)) + 1;

    }
    bsrRender();
    used = true;
    setTimeout(() => bsrDealerItemLoop(callback), 1100);
    return;
  }

  const gummyIdx = s.dealerItems.indexOf('gummy');
  if(gummyIdx !== -1 && s.dealerHP < s.dealerMaxHP && Math.random() < 0.3) {
    s.dealerItems.splice(gummyIdx, 1);
    if(Math.random() < 0.4) {
      const heal = Math.min(2, s.dealerMaxHP + 1 - s.dealerHP);
      s.dealerHP += heal;
      bsrLog('🤖🍬 Dealer ate Rotten Gummy... +' + heal + ' HP!');
    } else {
      s.dealerHP -= 1;
      bsrLog('🤖🍬 Dealer ate Rotten Gummy... −1 HP (' + s.dealerHP + ')');
      if(s.dealerHP <= 0) {
        bsrRender();
        setTimeout(() => bsrRoundWin(), 1200);
        return;
      }
    }
    bsrRender();
    used = true;
    setTimeout(() => bsrDealerItemLoop(callback), 1100);
    return;
  }

  callback();
}

function bsrDealerShoot() {
  const s = bsrState;
  if(!s || !s.active) return;

  if(s.shellIndex >= s.shells.length) {
    bsrLog('📦 All shells spent! Reloading...');
    s.animating = false;
    setTimeout(() => bsrShowRoundSplash(s.round, () => bsrNewRound()), 1000);
    return;
  }

  const shell = s.shells[s.shellIndex];
  s.shellIndex++;
  s.animating = true;

  let target = 'player';
  if(s._dealerKnowsCurrent === 'blank') {
    target = 'self';
  } else if(s._dealerKnowsCurrent === 'live') {
    target = 'player';
  } else {

    const allRemaining = s.shells.slice(s.shellIndex - 1);
    const liveR = allRemaining.filter(x => x === 'live').length / allRemaining.length;
    target = liveR < 0.4 ? 'self' : 'player';
  }
  s._dealerKnowsCurrent = null;

  const damage = shell === 'live' ? (s.sawActive ? 2 : 1) : 0;
  if(shell === 'live') s.sawActive = false;

  bsrSetStatus('🤖 Dealer aims at ' + (target === 'player' ? 'YOU' : 'ITSELF') + '...');

  setTimeout(() => {

    bsrAnimateShotgun(target === 'player' ? 'left' : 'right', shell === 'live');
    if(shell === 'live') {
      playSound(120, 'sawtooth', 0.35, 0.18);
      setTimeout(() => playSound(80, 'square', 0.2, 0.08), 100);
    } else {
      playSound(600, 'sine', 0.08, 0.05);
    }

    setTimeout(() => {
      if(target === 'player') {
        if(shell === 'live') {
          s.playerHP -= damage;
          bsrAnimateHit('player');
          bsrLog(`🤖🔫 Dealer shot you — LIVE! ${damage > 1 ? '🪚 2 dmg! ' : ''}You: ${Math.max(0,s.playerHP)} HP`);
          bsrSetStatus(`💥 Dealer hits you for ${damage}!`);
        } else {
          bsrLog('🤖🔫 Dealer shot you — BLANK. No damage.');
          bsrSetStatus('*click* — Dealer missed. BLANK!');
        }
        s.turn = 'player';
      } else {
        if(shell === 'live') {
          s.dealerHP -= damage;
          bsrAnimateHit('dealer');
          bsrLog(`🤖🫵 Dealer shot itself — LIVE! ${damage > 1 ? '🪚 2 dmg! ' : ''}Dealer: ${Math.max(0,s.dealerHP)} HP`);
          bsrSetStatus('Dealer shot itself! LIVE!');
          s.turn = 'player';
        } else {
          bsrLog('🤖🫵 Dealer shot itself — BLANK! Extra turn.');
          bsrSetStatus('*click* — Dealer gets another turn.');
          s.turn = 'dealer';
        }
      }

      s.animating = false;
      bsrRender();

      if(s.playerHP <= 0) { setTimeout(() => bsrEndGame(false), 1200); return; }
      if(s.dealerHP <= 0) { setTimeout(() => bsrRoundWin(), 1200); return; }
      if(s.shellIndex >= s.shells.length) {
        bsrLog('📦 All shells spent! Reloading...');
        setTimeout(() => bsrShowRoundSplash(s.round, () => bsrNewRound()), 1500);
        return;
      }

      bsrResolveTurn();
    }, 1100);
  }, 800);
}

function bsrRoundWin() {
  const s = bsrState;
  if(!s || !s.active) return;
  if(s.round >= s.maxRounds) {
    bsrEndGame(true);
    return;
  }
  bsrLog(`✅ ROUND ${s.round} WON! The Dealer is down.`);
  s.round++;

  const diff = BSR_DIFF[s.diff];
  s.dealerHP = diff.hp + (s.round - 1);
  s.dealerMaxHP = diff.hp + (s.round - 1);

  s.playerHP = Math.min(s.playerHP + 2, s.playerMaxHP);

  bsrSetStatus('Round won! Advancing...');
  bsrRender();

  setTimeout(() => {
    bsrShowRoundSplash(s.round, () => bsrNewRound());
  }, 1200);
}

function bsrEndGame(won) {
  const s = bsrState;
  if(!s || !s.active) return;
  s.active = false;

  const overlay = document.getElementById('bsrGameOver');
  overlay.style.display = 'flex';

  if(won) {
    const winnings = Math.floor(s.bet * s.mult * getPrestigeMultiplier());
    balance += winnings;
    updateBalDisplay();
    recordGame('rusroulette', s.bet, winnings);
    firebaseSaveNow();
    bsrStats.wins++;
    bsrStats.streak++;
    if(bsrStats.streak > bsrStats.bestStreak) bsrStats.bestStreak = bsrStats.streak;
    if(winnings > bsrStats.biggestWin) bsrStats.biggestWin = winnings;
    bsrSaveStats();

    document.getElementById('bsrGameOverContent').innerHTML = `
      <div style="font-size:72px;margin-bottom:16px;">🏆</div>
      <div style="font-family:'Orbitron';font-size:30px;color:var(--green);font-weight:900;margin-bottom:8px;">YOU WIN!</div>
      <div style="font-size:13px;color:var(--text2);margin-bottom:4px;">Survived all ${s.maxRounds} rounds on ${BSR_DIFF[s.diff].label}</div>
      <div style="font-size:13px;color:var(--text2);margin-bottom:16px;">${s.mult}× multiplier</div>
      <div style="font-size:28px;color:var(--gold);font-weight:900;margin-bottom:6px;">+$${winnings.toLocaleString()}</div>
      <div style="font-size:12px;color:var(--text2);margin-bottom:20px;">Streak: ${bsrStats.streak} 🔥</div>
      <button onclick="bsrCloseGameOver()" class="action-btn primary" style="padding:14px 32px;font-size:15px;font-family:'Orbitron';">PLAY AGAIN</button>
    `;
  } else {
    recordGame('rusroulette', s.bet, 0);
    bsrStats.losses++;
    bsrStats.streak = 0;
    bsrSaveStats();

    document.getElementById('bsrGameOverContent').innerHTML = `
      <div style="font-size:72px;margin-bottom:16px;">💀</div>
      <div style="font-family:'Orbitron';font-size:30px;color:var(--red);font-weight:900;margin-bottom:8px;">YOU DIED</div>
      <div style="font-size:13px;color:var(--text2);margin-bottom:4px;">Eliminated in Round ${s.round}/${s.maxRounds} on ${BSR_DIFF[s.diff].label}</div>
      <div style="font-size:28px;color:var(--red);font-weight:900;margin-bottom:20px;">-$${s.bet.toLocaleString()}</div>
      <button onclick="bsrCloseGameOver()" class="action-btn primary" style="padding:14px 32px;font-size:15px;font-family:'Orbitron';">TRY AGAIN</button>
    `;
  }
}

function bsrCloseGameOver() {
  document.getElementById('bsrGameOver').style.display = 'none';
  bsrState = null;
  document.getElementById('bsrLobby').style.display = 'block';
  document.getElementById('bsrGame').style.display = 'none';
  document.getElementById('bsrRoundSplash').style.display = 'none';
  bsrUpdateStats();
}

let rrState = null;
const RR_DIFF = {
  easy:   { rounds: 3, mult: 2, label: 'EASY',   icon: '😎' },
  normal: { rounds: 5, mult: 4, label: 'NORMAL', icon: '💀' },
  hard:   { rounds: 8, mult: 8, label: 'HARD',   icon: '☠️' }
};
let rrDiff = 'easy';
let rrMode = 'bot';

function rrSwitchMode(mode, tab) {
  rrMode = mode;
  document.querySelectorAll('#russianrPanel .inv-tab').forEach(t => t.classList.remove('active'));
  tab.classList.add('active');
  document.getElementById('rrBotLobby').style.display = mode === 'bot' ? 'block' : 'none';
  document.getElementById('rrPvpLobby').style.display = mode === 'pvp' ? 'block' : 'none';
  document.getElementById('rrGameArea').style.display = 'none';
  document.getElementById('rrGameOver').style.display = 'none';
}

function rrSelectDiff(d, el) {
  rrDiff = d;
  document.querySelectorAll('#rrBotLobby .bsr-diff-card').forEach(c => c.classList.remove('selected'));
  el.classList.add('selected');
}

function initRussianRoulette() {
  document.getElementById('rrBotLobby').style.display = rrMode === 'bot' ? 'block' : 'none';
  document.getElementById('rrPvpLobby').style.display = rrMode === 'pvp' ? 'block' : 'none';
  document.getElementById('rrGameArea').style.display = 'none';
  document.getElementById('rrGameOver').style.display = 'none';
  rrUpdateStats();
}

function rrUpdateStats() {

}

function rrLog(msg, color) {
  const log = document.getElementById('rrLog');
  const d = document.createElement('div');
  d.style.cssText = 'padding:4px 8px;border-bottom:1px solid rgba(255,255,255,0.05);font-size:12px;';
  if (color) d.style.color = color;
  d.textContent = msg;
  log.prepend(d);
}

function rrNewCylinder() {

  const chambers = [0, 0, 0, 0, 0, 0];
  chambers[Math.floor(Math.random() * 6)] = 1;
  return { chambers, pos: 0, remaining: 6 };
}

function rrPullChamber(cyl) {
  const hit = cyl.chambers[cyl.pos] === 1;
  cyl.pos = (cyl.pos + 1) % 6;
  cyl.remaining--;
  return hit;
}

function rrSpinCylinderMech(cyl) {

  cyl.chambers = [0, 0, 0, 0, 0, 0];
  cyl.chambers[Math.floor(Math.random() * 6)] = 1;
  cyl.pos = 0;
  cyl.remaining = 6;
}

function rrBotDecision(cyl, roundNum, totalRounds) {

  const hitChance = 1 / Math.max(1, cyl.remaining);

  let spinThreshold;
  if (rrDiff === 'easy') spinThreshold = 0.65;
  else if (rrDiff === 'normal') spinThreshold = 0.45;
  else spinThreshold = 0.35;

  if (hitChance >= spinThreshold && Math.random() < 0.6) return 'spin';
  return 'pull';
}

function rrStartBot() {
  const betEl = document.getElementById('rrBet');
  const bet = parseBet(betEl.value);
  if (!bet || bet < 10) return showToast('Min bet is $10', false);
  if (!checkMaxBet(bet, 'russianr')) return;

  const diff = RR_DIFF[rrDiff];
  rrState = {
    mode: 'bot',
    bet,
    diff: rrDiff,
    totalRounds: diff.rounds,
    currentRound: 1,
    mult: diff.mult,
    cylinder: rrNewCylinder(),
    playerTurn: Math.random() < 0.5,
    playerAlive: true,
    dealerAlive: true,
    roundKills: 0,
    gameOver: false,
    paused: false
  };

  balance -= bet;
  updateBalDisplay();if(!firebaseSaveBet(bet))return;

  document.getElementById('rrBotLobby').style.display = 'none';
  document.getElementById('rrPvpLobby').style.display = 'none';
  document.getElementById('rrGameArea').style.display = 'block';
  document.getElementById('rrGameOver').style.display = 'none';
  document.getElementById('rrLog').innerHTML = '';
  document.getElementById('rrOpponentLabel').textContent = '🤖 DEALER';

  rrUpdateUI();
  rrLog(`Game started — ${diff.label} difficulty (${diff.rounds} rounds, ${diff.mult}× payout)`, 'var(--gold)');
  rrLog(`Round 1 — New cylinder loaded!`, 'var(--neon)');
  rrAnimateNewRound();

  if (!rrState.playerTurn) {
    rrLog('Dealer goes first...', 'var(--text2)');
    rrDisableActions();
    setTimeout(() => rrBotTurn(), 1500);
  } else {
    rrLog('You go first!', 'var(--green)');
    rrEnableActions();
  }
}

function rrUpdateUI() {
  if (!rrState) return;
  const s = rrState;
  document.getElementById('rrRoundInfo').textContent = `ROUND ${s.currentRound} / ${s.totalRounds}`;
  document.getElementById('rrMultInfo').textContent = `🏆 ${s.mult}× ($${Math.floor(s.bet * s.mult).toLocaleString()})`;

  const chamberDots = [];
  for (let i = 0; i < 6; i++) {
    if (i < s.cylinder.pos) chamberDots.push('⚫');
    else chamberDots.push('🔴');
  }
  document.getElementById('rrChamberInfo').textContent = chamberDots.join(' ') + ` (${s.cylinder.remaining} left)`;

  document.getElementById('rrPlayerStatus').textContent = s.playerAlive ? (s.playerTurn ? '😰' : '😐') : '💀';
  document.getElementById('rrPlayerAlive').textContent = s.playerAlive ? 'ALIVE' : 'DEAD';
  document.getElementById('rrPlayerAlive').style.color = s.playerAlive ? 'var(--green)' : 'var(--red)';
  document.getElementById('rrPlayerCard').style.borderColor = s.playerTurn && !s.gameOver ? 'var(--neon)' : 'var(--border)';
  document.getElementById('rrPlayerCard').style.boxShadow = s.playerTurn && !s.gameOver ? '0 0 20px rgba(0,240,255,.2)' : 'none';

  document.getElementById('rrDealerStatus').textContent = s.dealerAlive ? (!s.playerTurn ? '😈' : '😐') : '💀';
  document.getElementById('rrDealerAlive').textContent = s.dealerAlive ? 'ALIVE' : 'DEAD';
  document.getElementById('rrDealerAlive').style.color = s.dealerAlive ? 'var(--green)' : 'var(--red)';
  document.getElementById('rrDealerCard').style.borderColor = !s.playerTurn && !s.gameOver ? 'rgba(255,68,68,.5)' : 'var(--border)';
  document.getElementById('rrDealerCard').style.boxShadow = !s.playerTurn && !s.gameOver ? '0 0 20px rgba(255,68,68,.2)' : 'none';
}

function rrEnableActions() {
  document.getElementById('rrPullBtn').disabled = false;
  document.getElementById('rrSpinBtn').disabled = false;
  document.getElementById('rrPullBtn').style.opacity = '1';
  document.getElementById('rrSpinBtn').style.opacity = '1';
}

function rrDisableActions() {
  document.getElementById('rrPullBtn').disabled = true;
  document.getElementById('rrSpinBtn').disabled = true;
  document.getElementById('rrPullBtn').style.opacity = '0.4';
  document.getElementById('rrSpinBtn').style.opacity = '0.4';
}

function rrAnimateNewRound() {
  const rev = document.getElementById('rrRevolver');
  rev.style.transform = 'rotate(0deg)';
  setTimeout(() => { rev.style.transform = 'rotate(720deg)'; }, 50);
  setTimeout(() => { rev.style.transform = 'rotate(0deg)'; }, 600);
}

function rrAnimateShot(hit) {
  const rev = document.getElementById('rrRevolver');
  if (hit) {
    rev.style.transform = 'scale(1.3) rotate(-10deg)';
    setTimeout(() => { rev.style.transform = 'scale(1) rotate(0deg)'; }, 400);
  } else {
    rev.style.transform = 'rotate(15deg)';
    setTimeout(() => { rev.style.transform = 'rotate(0deg)'; }, 300);
  }
}

function rrShakeScreen() {
  const area = document.getElementById('rrGameArea');
  area.style.animation = 'none';
  area.offsetHeight;
  area.style.animation = 'bsr-shake .5s ease-out';
}

function rrPullTrigger() {
  if (!rrState || rrState.gameOver || !rrState.playerTurn || rrState.paused) return;
  rrDisableActions();
  rrState.paused = true;

  playSound(200, 'triangle', 0.1, 0.3);

  setTimeout(() => {
    const hit = rrPullChamber(rrState.cylinder);
    rrAnimateShot(hit);

    if (hit) {

      playSound(80, 'sawtooth', 0.4, 0.7);
      rrShakeScreen();
      rrState.playerAlive = false;
      rrState.playerTurn = false;
      rrLog('💥 BANG! The bullet fires — YOU\'RE HIT!', '#ff4444');
      rrUpdateUI();
      setTimeout(() => rrEndRound('dealer'), 1200);
    } else {

      playSound(600, 'sine', 0.08, 0.4);
      rrLog('🔘 *click* — Empty chamber. You survive!', 'var(--green)');
      rrState.playerTurn = false;
      rrUpdateUI();
      rrState.paused = false;

      setTimeout(() => rrBotTurn(), 1200);
    }
  }, 800);
}

function rrSpinCylinder() {
  if (!rrState || rrState.gameOver || !rrState.playerTurn || rrState.paused) return;
  rrDisableActions();
  rrState.paused = true;

  playSound(400, 'sine', 0.3, 0.3);
  rrAnimateNewRound();

  setTimeout(() => {
    rrSpinCylinderMech(rrState.cylinder);
    rrLog('🔄 You spin the cylinder — reset to 6 chambers!', 'var(--neon)');
    rrUpdateUI();
    rrState.playerTurn = false;
    rrState.paused = false;

    setTimeout(() => rrBotTurn(), 1200);
  }, 800);
}

function rrBotTurn() {
  if (!rrState || rrState.gameOver) return;
  rrDisableActions();
  rrState.paused = true;

  const decision = rrBotDecision(rrState.cylinder, rrState.currentRound, rrState.totalRounds);

  if (decision === 'spin') {
    rrLog('🤖 Dealer spins the cylinder...', 'var(--text2)');
    playSound(400, 'sine', 0.3, 0.3);
    rrAnimateNewRound();
    setTimeout(() => {
      rrSpinCylinderMech(rrState.cylinder);
      rrLog('🔄 Cylinder reset to 6 chambers!', 'var(--text2)');
      rrUpdateUI();
      rrState.playerTurn = true;
      rrState.paused = false;
      rrUpdateUI();
      rrEnableActions();
      rrLog('Your turn — pull the trigger or spin!', 'var(--gold)');
    }, 1000);
  } else {
    rrLog('🤖 Dealer grabs the gun... pulls the trigger...', 'var(--text2)');

    setTimeout(() => {
      const hit = rrPullChamber(rrState.cylinder);
      rrAnimateShot(hit);

      if (hit) {
        playSound(80, 'sawtooth', 0.4, 0.7);
        rrShakeScreen();
        rrState.dealerAlive = false;
        rrLog('💥 BANG! The dealer takes the bullet! 💀', '#ff4444');
        rrUpdateUI();
        setTimeout(() => rrEndRound('player'), 1200);
      } else {
        playSound(600, 'sine', 0.08, 0.4);
        rrLog('🔘 *click* — Dealer survives...', 'var(--text2)');
        rrState.playerTurn = true;
        rrUpdateUI();
        rrState.paused = false;
        rrEnableActions();
        rrLog('Your turn — pull the trigger or spin!', 'var(--gold)');
      }
    }, 1200);
  }
}

function rrEndRound(winner) {
  if (!rrState) return;
  const s = rrState;

  rrLog(`— Round ${s.currentRound} winner: ${winner === 'player' ? 'YOU' : 'DEALER'} —`, winner === 'player' ? 'var(--green)' : 'var(--red)');

  if (s.currentRound >= s.totalRounds) {
    rrEndGame(winner);
    return;
  }

  if (!s.playerAlive) {
    rrEndGame('dealer');
    return;
  }

  if (!s.dealerAlive) {

    s.currentRound++;
    s.dealerAlive = true;
    s.playerAlive = true;
    s.cylinder = rrNewCylinder();
    s.playerTurn = Math.random() < 0.5;

    rrLog(`Round ${s.currentRound} — New cylinder loaded!`, 'var(--neon)');
    rrAnimateNewRound();
    rrUpdateUI();

    setTimeout(() => {
      rrState.paused = false;
      if (s.playerTurn) {
        rrLog('You go first!', 'var(--green)');
        rrEnableActions();
      } else {
        rrLog('Dealer goes first...', 'var(--text2)');
        rrBotTurn();
      }
    }, 1000);
    return;
  }

  rrEndGame('dealer');
}

function rrEndGame(winner) {
  if (!rrState) return;
  rrState.gameOver = true;
  rrDisableActions();

  const s = rrState;
  const diff = RR_DIFF[s.diff];
  const won = winner === 'player';
  const winAmount = won ? Math.floor(s.bet * s.mult * getPrestigeMultiplier()) : 0;

  if (won) {
    balance += winAmount;
    updateBalDisplay();
    if (winAmount > gameStats.russianr.biggestWin) gameStats.russianr.biggestWin = winAmount;
    gameStats.russianr.won++;
  }
  gameStats.russianr.played++;
  recordGame('russianr', s.bet, winAmount);
  firebaseSaveNow();

  setTimeout(() => {
    const box = document.getElementById('rrGameOverContent');
    if (won) {
      playWinSound();
      box.innerHTML = `
        <div style="font-size:60px;margin-bottom:12px;">🏆</div>
        <div style="font-family:'Orbitron';font-size:22px;color:var(--green);margin-bottom:8px;">YOU SURVIVED!</div>
        <div style="font-size:14px;color:var(--text2);margin-bottom:8px;">The dealer takes the bullet. You walk away alive.</div>
        <div style="font-family:'Orbitron';font-size:28px;color:var(--gold);margin-bottom:6px;">+$${winAmount.toLocaleString()}</div>
        <div style="font-size:12px;color:var(--text2);margin-bottom:16px;">${diff.label} ${diff.icon} • ${diff.mult}× Multiplier</div>
        <button onclick="rrCloseGameOver()" class="action-btn primary" style="padding:14px 32px;font-size:15px;font-family:'Orbitron';">PLAY AGAIN</button>`;
      spawnParticles(window.innerWidth / 2, window.innerHeight / 2, 40);
      if (winAmount >= s.bet * 4) showBigWin(winAmount);
    } else {
      playLoseSound();
      box.innerHTML = `
        <div style="font-size:60px;margin-bottom:12px;">💀</div>
        <div style="font-family:'Orbitron';font-size:22px;color:var(--red);margin-bottom:8px;">YOU'RE DEAD</div>
        <div style="font-size:14px;color:var(--text2);margin-bottom:8px;">The bullet found you. Better luck next life.</div>
        <div style="font-family:'Orbitron';font-size:28px;color:var(--red);margin-bottom:6px;">-$${s.bet.toLocaleString()}</div>
        <div style="font-size:12px;color:var(--text2);margin-bottom:16px;">${diff.label} ${diff.icon} • Round ${s.currentRound}/${s.totalRounds}</div>
        <button onclick="rrCloseGameOver()" class="action-btn primary" style="padding:14px 32px;font-size:15px;font-family:'Orbitron';">TRY AGAIN</button>`;
    }
    document.getElementById('rrGameOver').style.display = 'flex';
  }, 800);
}

function rrCloseGameOver() {
  document.getElementById('rrGameOver').style.display = 'none';
  rrState = null;
  document.getElementById('rrBotLobby').style.display = rrMode === 'bot' ? 'block' : 'none';
  document.getElementById('rrPvpLobby').style.display = rrMode === 'pvp' ? 'block' : 'none';
  document.getElementById('rrGameArea').style.display = 'none';
}

let rrPvpListener = null;
let rrPvpUnsubscribe = null;

async function rrStartPvP() {
  const bet = parseBet(document.getElementById('rrPvpBet').value);
  if (!bet || bet < 10) return showToast('Min bet is $10', false);
  if (!checkMaxBet(bet, 'russianr')) return;

  const opName = document.getElementById('rrPvpOpponent').value.trim().toLowerCase();
  if (!opName) return showToast('Enter opponent username', false);
  if (opName === (window._currentUsername || '').toLowerCase()) return showToast('Cannot challenge yourself', false);

  const statusEl = document.getElementById('rrPvpStatus');
  statusEl.textContent = 'Sending challenge...';

  try {
    const nameSnap = await window._fbGet('casino/usernames/' + opName);
    if (!nameSnap.exists()) { statusEl.textContent = 'Player not found!'; return; }
    const opUid = nameSnap.val();
    if (opUid === window._currentPlayerId) { statusEl.textContent = 'Cannot challenge yourself'; return; }

    const gameId = Date.now().toString(36) + Math.random().toString(36).slice(2, 6);
    const gameData = {
      host: window._currentPlayerId,
      hostName: window._currentUsername,
      guest: opUid,
      guestName: opName,
      bet: bet,
      status: 'pending',
      cylinder: null,
      currentTurn: null,
      round: 1,
      totalRounds: 5,
      hostAlive: true,
      guestAlive: true,
      created: Date.now()
    };

    await window._fbSet('casino/rrGames/' + gameId, gameData);

    balance -= bet;
    updateBalDisplay();if(!firebaseSaveBet(bet))return;

    const notifKey = Date.now().toString(36) + Math.random().toString(36).slice(2, 4);
    await window._fbSet('casino/players/' + opUid + '/notifications/' + notifKey, {
      type: 'rr_challenge',
      from: window._currentUsername,
      fromUid: window._currentPlayerId,
      gameId: gameId,
      bet: bet,
      time: Date.now()
    });

    statusEl.innerHTML = `Challenge sent to <b>${opName}</b>! Waiting...<br><button class="action-btn" onclick="rrCancelPvP('${gameId}',${bet})" style="margin-top:8px;padding:6px 16px;font-size:11px;">Cancel</button>`;

    rrPvpUnsubscribe = window._fbOnValue('casino/rrGames/' + gameId, snap => {
      const g = snap.val();
      if (!g) return;
      if (g.status === 'active') rrJoinPvPGame(gameId);
      if (g.status === 'declined') {
        statusEl.textContent = 'Challenge declined.';
        balance += bet;
        updateBalDisplay();
        rrCleanupPvP();
      }
    });
  } catch(e) {
    statusEl.textContent = 'Error: ' + e.message;
  }
}

function rrCancelPvP(gameId, bet) {
  window._fbRemove('casino/rrGames/' + gameId);
  balance += bet || (rrState ? rrState.bet : parseBet(document.getElementById('rrPvpBet').value));
  updateBalDisplay();
  rrCleanupPvP();
  document.getElementById('rrPvpStatus').textContent = 'Challenge cancelled.';
}

async function rrAcceptPvPChallenge(gameId, bet) {
  if (!checkMaxBet(bet, 'russianr')) return;

  balance -= bet;
  updateBalDisplay();if(!firebaseSaveBet(bet))return;

  const chambers = [0, 0, 0, 0, 0, 0];
  chambers[Math.floor(Math.random() * 6)] = 1;
  const hostFirst = Math.random() < 0.5;

  await window._fbUpdate('casino/rrGames/' + gameId, {
    status: 'active',
    cylinder: chambers.join(','),
    cylinderPos: 0,
    currentTurn: hostFirst ? 'host' : 'guest',
    round: 1,
    hostAlive: true,
    guestAlive: true
  });

  switchGame('russianr');
  rrJoinPvPGame(gameId);
}

function rrJoinPvPGame(gameId) {
  document.getElementById('rrBotLobby').style.display = 'none';
  document.getElementById('rrPvpLobby').style.display = 'none';
  document.getElementById('rrGameArea').style.display = 'block';
  document.getElementById('rrGameOver').style.display = 'none';
  document.getElementById('rrLog').innerHTML = '';

  rrCleanupPvP();

  let endHandled = false;

  rrPvpUnsubscribe = window._fbOnValue('casino/rrGames/' + gameId, snap => {
    const g = snap.val();
    if (!g) return;

    const myId = window._currentPlayerId;
    const isHost = g.host === myId;
    const opName = isHost ? g.guestName : g.hostName;
    document.getElementById('rrOpponentLabel').textContent = '👤 ' + opName.toUpperCase();

    const myTurn = (g.currentTurn === 'host' && isHost) || (g.currentTurn === 'guest' && !isHost);
    const myAlive = isHost ? g.hostAlive : g.guestAlive;
    const opAlive = isHost ? g.guestAlive : g.hostAlive;

    rrState = {
      mode: 'pvp',
      bet: g.bet,
      diff: 'normal',
      totalRounds: g.totalRounds || 5,
      currentRound: g.round || 1,
      mult: 2,
      cylinder: { remaining: 6 - (g.cylinderPos || 0), pos: g.cylinderPos || 0 },
      playerTurn: myTurn,
      playerAlive: myAlive,
      dealerAlive: opAlive,
      gameOver: g.status === 'finished',
      pvpGameId: gameId,
      pvpIsHost: isHost
    };

    document.getElementById('rrRoundInfo').textContent = `ROUND ${g.round || 1} / ${g.totalRounds || 5}`;
    document.getElementById('rrMultInfo').textContent = `🏆 POT: $${(g.bet * 2).toLocaleString()}`;
    rrUpdateUI();

    if (myTurn && !rrState.gameOver && myAlive && opAlive) rrEnableActions();
    else rrDisableActions();

    if (g.lastAction) {
      const la = g.lastAction;
      if (la.type === 'pull') {
        if (la.hit) { rrAnimateShot(true); rrShakeScreen(); playSound(80, 'sawtooth', 0.4, 0.7); }
        else { rrAnimateShot(false); playSound(600, 'sine', 0.08, 0.4); }
      } else if (la.type === 'spin') { rrAnimateNewRound(); playSound(400, 'sine', 0.3, 0.3); }
    }

    if (g.log) {
      const logEl = document.getElementById('rrLog');
      logEl.innerHTML = '';
      Object.values(g.log).slice(-20).reverse().forEach(l => {
        const d = document.createElement('div');
        d.style.cssText = 'padding:4px 8px;border-bottom:1px solid rgba(255,255,255,0.05);font-size:12px;';
        if (l.color) d.style.color = l.color;
        d.textContent = l.msg;
        logEl.appendChild(d);
      });
    }

    if (g.status === 'finished' && g.winner && !endHandled) {
      endHandled = true;
      const iWon = (g.winner === 'host' && isHost) || (g.winner === 'guest' && !isHost);
      if (iWon) {
        balance += g.bet * 2;
        updateBalDisplay();
        gameStats.russianr.won++;
        if (g.bet * 2 > gameStats.russianr.biggestWin) gameStats.russianr.biggestWin = g.bet * 2;
      }
      gameStats.russianr.played++;
      recordGame('russianr', g.bet, iWon ? g.bet * 2 : 0);
      if(iWon) firebaseSaveNow();

      const box = document.getElementById('rrGameOverContent');
      if (iWon) {
        playWinSound();
        box.innerHTML = `<div style="font-size:60px;margin-bottom:12px;">🏆</div>
          <div style="font-family:'Orbitron';font-size:22px;color:var(--green);margin-bottom:8px;">YOU WIN!</div>
          <div style="font-size:14px;color:var(--text2);margin-bottom:8px;">${opName} took the bullet!</div>
          <div style="font-family:'Orbitron';font-size:28px;color:var(--gold);margin-bottom:16px;">+$${g.bet.toLocaleString()}</div>
          <button onclick="rrCloseGameOver();rrCleanupPvP();" class="action-btn primary" style="padding:14px 32px;">BACK TO LOBBY</button>`;
        spawnParticles(window.innerWidth / 2, window.innerHeight / 2, 30);
      } else {
        playLoseSound();
        box.innerHTML = `<div style="font-size:60px;margin-bottom:12px;">💀</div>
          <div style="font-family:'Orbitron';font-size:22px;color:var(--red);margin-bottom:8px;">YOU LOSE</div>
          <div style="font-size:14px;color:var(--text2);margin-bottom:8px;">The bullet found you...</div>
          <div style="font-family:'Orbitron';font-size:28px;color:var(--red);margin-bottom:16px;">-$${g.bet.toLocaleString()}</div>
          <button onclick="rrCloseGameOver();rrCleanupPvP();" class="action-btn primary" style="padding:14px 32px;">BACK TO LOBBY</button>`;
      }
      document.getElementById('rrGameOver').style.display = 'flex';
    }
  });
}

async function rrPvPAction(actionType) {
  if (!rrState || rrState.mode !== 'pvp' || !rrState.pvpGameId) return;
  const gameId = rrState.pvpGameId;
  const isHost = rrState.pvpIsHost;

  const snap = await window._fbGet('casino/rrGames/' + gameId);
  const g = snap.val();
  if (!g || g.status !== 'active') return;

  const myTurn = (g.currentTurn === 'host' && isHost) || (g.currentTurn === 'guest' && !isHost);
  if (!myTurn) return;

  const chambers = g.cylinder.split(',').map(Number);
  const pos = g.cylinderPos || 0;
  const myName = isHost ? g.hostName : g.guestName;
  const logKey = Date.now().toString(36) + Math.random().toString(36).slice(2, 4);

  if (actionType === 'spin') {
    const nc = [0, 0, 0, 0, 0, 0];
    nc[Math.floor(Math.random() * 6)] = 1;
    await window._fbSet('casino/rrGames/' + gameId + '/log/' + logKey, { msg: `🔄 ${myName} spins the cylinder!`, color: 'var(--neon)' });
    await window._fbUpdate('casino/rrGames/' + gameId, {
      cylinder: nc.join(','), cylinderPos: 0,
      currentTurn: isHost ? 'guest' : 'host',
      lastAction: { type: 'spin', by: myName }
    });
  } else {
    const hit = chambers[pos] === 1;
    const updates = { cylinderPos: pos + 1, currentTurn: isHost ? 'guest' : 'host', lastAction: { type: 'pull', by: myName, hit } };
    if (hit) {
      if (isHost) updates.hostAlive = false; else updates.guestAlive = false;
      await window._fbSet('casino/rrGames/' + gameId + '/log/' + logKey, { msg: `💥 BANG! ${myName} takes the bullet! 💀`, color: '#ff4444' });
      updates.status = 'finished';
      updates.winner = isHost ? 'guest' : 'host';
    } else {
      await window._fbSet('casino/rrGames/' + gameId + '/log/' + logKey, { msg: `🔘 *click* — ${myName} survives!`, color: 'var(--green)' });
    }
    await window._fbUpdate('casino/rrGames/' + gameId, updates);
  }
}

let mpbsrGameId = null;
let mpbsrIsHost = false;
let mpbsrChallengeInterval = null;
let mpbsrUnsub = null;

function mpbsrCleanup() {
  if (mpbsrUnsub && typeof mpbsrUnsub === 'function') {
    mpbsrUnsub();
    mpbsrUnsub = null;
  }
}

function mpbsrBackToLobby() {
  mpbsrCleanup();
  mpbsrGameId = null;
  mpbsrIsHost = false;
  document.getElementById('mpbsrLobby').style.display = 'block';
  document.getElementById('mpbsrGameArea').style.display = 'none';
  document.getElementById('mpbsrGameOver').style.display = 'none';
}

const MPBSR_ITEMS = [
  { id: 'saw', icon: '🪚', name: 'Saw', desc: 'Next LIVE deals 2× damage' },
  { id: 'mag', icon: '🔍', name: 'Magnifying Glass', desc: 'Peek at current shell' },
  { id: 'cig', icon: '🚬', name: 'Cigarette', desc: 'Heal +1 HP' },
  { id: 'cuff', icon: '🔗', name: 'Handcuffs', desc: 'Opponent skips next turn' },
  { id: 'phone', icon: '📱', name: 'Burner Phone', desc: 'Reveals a random shell' }
];

function initMPBSR() {
  document.getElementById('mpbsrLobby').style.display = 'block';
  document.getElementById('mpbsrGameArea').style.display = 'none';
  document.getElementById('mpbsrGameOver').style.display = 'none';
  mpbsrStartChallengeListener();
}

function mpbsrStartChallengeListener() {
  if (mpbsrChallengeInterval) clearInterval(mpbsrChallengeInterval);
  mpbsrChallengeInterval = setInterval(async () => {
    if (!window._currentPlayerId) return;
    try {
      const snap = await window._fbGet('casino/players/' + window._currentPlayerId + '/notifications');
      if (!snap.exists()) return;
      const notifs = snap.val();
      for (const [key, n] of Object.entries(notifs)) {
        if (n.type === 'mpbsr_challenge' && n.gameId) {
          window._fbRemove('casino/players/' + window._currentPlayerId + '/notifications/' + key);
          const toastDiv = document.createElement('div');
          toastDiv.style.cssText = 'position:fixed;top:20%;left:50%;transform:translateX(-50%);z-index:99999;background:var(--surface);border:2px solid var(--gold);border-radius:16px;padding:24px;text-align:center;min-width:280px;box-shadow:0 0 40px rgba(0,0,0,.5);';
          toastDiv.innerHTML = `
            <div style="font-size:30px;margin-bottom:8px;">💥</div>
            <div style="font-family:'Orbitron';font-size:16px;color:var(--gold);margin-bottom:8px;">BUCKSHOT ROULETTE CHALLENGE</div>
            <div style="font-size:14px;color:var(--text);margin-bottom:4px;"><b>${n.from}</b> challenges you!</div>
            <div style="font-size:13px;color:var(--text2);margin-bottom:14px;">Wager: <span style="color:var(--gold);">$${n.bet.toLocaleString()}</span></div>
            <div style="display:flex;gap:10px;justify-content:center;">
              <button class="action-btn primary" onclick="this.closest('div[style]').remove();mpbsrAccept('${n.gameId}',${n.bet});" style="padding:10px 20px;">✅ ACCEPT</button>
              <button class="action-btn" onclick="this.closest('div[style]').remove();mpbsrDecline('${n.gameId}');" style="padding:10px 20px;">❌ DECLINE</button>
            </div>`;
          document.body.appendChild(toastDiv);
          setTimeout(() => { if (toastDiv.parentNode) toastDiv.remove(); }, 30000);
        }
      }
    } catch(e) {}
  }, 5000);
}

function mpbsrGenerateRound(roundNum) {

  const shellCount = 4 + roundNum;
  const liveCount = 1 + Math.floor(Math.random() * Math.min(shellCount - 1, roundNum + 2));
  const blankCount = shellCount - liveCount;
  const shells = [];
  for (let i = 0; i < liveCount; i++) shells.push('live');
  for (let i = 0; i < blankCount; i++) shells.push('blank');

  for (let i = shells.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [shells[i], shells[j]] = [shells[j], shells[i]];
  }

  const itemCount = Math.min(2 + roundNum, 4);
  function randItems(n) {
    const items = [];
    for (let i = 0; i < n; i++) items.push(MPBSR_ITEMS[Math.floor(Math.random() * MPBSR_ITEMS.length)].id);
    return items;
  }
  return { shells, hostItems: randItems(itemCount), guestItems: randItems(itemCount), liveCount, blankCount };
}

async function mpbsrChallenge() {
  const bet = parseBet(document.getElementById('mpbsrBet').value);
  if (!bet || bet < 10) return showToast('Min bet is $10', false);
  if (!checkMaxBet(bet, 'mpbsr')) return;

  const opName = document.getElementById('mpbsrOpponent').value.trim().toLowerCase();
  if (!opName) return showToast('Enter opponent username', false);
  if (opName === (window._currentUsername || '').toLowerCase()) return showToast('Cannot challenge yourself', false);

  const statusEl = document.getElementById('mpbsrStatus');
  statusEl.textContent = 'Sending challenge...';

  try {
    const nameSnap = await window._fbGet('casino/usernames/' + opName);
    if (!nameSnap.exists()) { statusEl.textContent = 'Player not found!'; return; }
    const opUid = nameSnap.val();
    if (opUid === window._currentPlayerId) { statusEl.textContent = 'Cannot challenge yourself'; return; }

    const gameId = Date.now().toString(36) + Math.random().toString(36).slice(2, 6);
    const round1 = mpbsrGenerateRound(1);

    await window._fbSet('casino/bsrGames/' + gameId, {
      host: window._currentPlayerId,
      hostName: window._currentUsername,
      guest: opUid,
      guestName: opName,
      bet,
      status: 'pending',
      round: 1,
      shells: round1.shells.join(','),
      shellIdx: 0,
      liveCount: round1.liveCount,
      blankCount: round1.blankCount,
      hostHP: 4,
      guestHP: 4,
      hostItems: round1.hostItems.join(','),
      guestItems: round1.guestItems.join(','),
      currentTurn: Math.random() < 0.5 ? 'host' : 'guest',
      sawActive: false,
      cuffActive: false,
      created: Date.now()
    });

    balance -= bet;
    updateBalDisplay();if(!firebaseSaveBet(bet))return;

    const nk = Date.now().toString(36) + Math.random().toString(36).slice(2, 4);
    await window._fbSet('casino/players/' + opUid + '/notifications/' + nk, {
      type: 'mpbsr_challenge',
      from: window._currentUsername,
      fromUid: window._currentPlayerId,
      gameId,
      bet,
      time: Date.now()
    });

    statusEl.innerHTML = `Challenge sent to <b>${opName}</b>! Waiting...<br><button class="action-btn" onclick="mpbsrCancelChallenge('${gameId}',${bet})" style="margin-top:8px;padding:6px 16px;font-size:11px;">Cancel</button>`;

    mpbsrCleanup();
    mpbsrUnsub = window._fbOnValue('casino/bsrGames/' + gameId, snap => {
      const g = snap.val();
      if (!g) return;
      if (g.status === 'active') {
        mpbsrGameId = gameId;
        mpbsrIsHost = true;
        mpbsrJoinGame(gameId);
      }
      if (g.status === 'declined') {
        statusEl.textContent = 'Challenge declined.';
        balance += bet;
        updateBalDisplay();
        mpbsrCleanup();
      }
    });
  } catch(e) {
    statusEl.textContent = 'Error: ' + e.message;
  }
}

function mpbsrCancelChallenge(gameId, bet) {
  window._fbRemove('casino/bsrGames/' + gameId);
  balance += bet;
  updateBalDisplay();
  mpbsrCleanup();
  document.getElementById('mpbsrStatus').textContent = 'Cancelled.';
}

async function mpbsrAccept(gameId, bet) {
  if (!checkMaxBet(bet, 'mpbsr')) return;
  balance -= bet;
  updateBalDisplay();if(!firebaseSaveBet(bet))return;

  await window._fbUpdate('casino/bsrGames/' + gameId, { status: 'active' });

  mpbsrGameId = gameId;
  mpbsrIsHost = false;
  switchGame('mpbsr');
  mpbsrJoinGame(gameId);
}

function mpbsrDecline(gameId) {
  window._fbUpdate('casino/bsrGames/' + gameId, { status: 'declined' });
}

function mpbsrJoinGame(gameId) {
  document.getElementById('mpbsrLobby').style.display = 'none';
  document.getElementById('mpbsrGameArea').style.display = 'block';
  document.getElementById('mpbsrGameOver').style.display = 'none';
  document.getElementById('mpbsrLog').innerHTML = '';

  mpbsrCleanup();
  let endHandled = false;

  mpbsrUnsub = window._fbOnValue('casino/bsrGames/' + gameId, snap => {
    const g = snap.val();
    if (!g) return;

    const isHost = g.host === window._currentPlayerId;
    const opName = isHost ? g.guestName : g.hostName;
    document.getElementById('mpbsrOpLabel').textContent = opName.toUpperCase();

    const myHP = isHost ? g.hostHP : g.guestHP;
    const opHP = isHost ? g.guestHP : g.hostHP;
    const myItems = (isHost ? g.hostItems : g.guestItems) || '';
    const opItems = (isHost ? g.guestItems : g.hostItems) || '';
    const myTurn = (g.currentTurn === 'host' && isHost) || (g.currentTurn === 'guest' && !isHost);
    const shells = g.shells ? g.shells.split(',') : [];
    const shellIdx = g.shellIdx || 0;

    document.getElementById('mpbsrRoundInfo').textContent = 'ROUND ' + (g.round || 1);
    document.getElementById('mpbsrPotInfo').textContent = 'POT: $' + (g.bet * 2).toLocaleString();
    document.getElementById('mpbsrShellInfo').textContent = (shells.length - shellIdx) + ' shells left';

    const rack = document.getElementById('mpbsrShellRack');
    rack.innerHTML = '';
    const rLive = shells.slice(shellIdx).filter(s => s === 'live').length;
    const rBlank = shells.slice(shellIdx).filter(s => s === 'blank').length;
    for (let i = 0; i < rLive; i++) {
      const d = document.createElement('div');
      d.className = 'bsr-shell bsr-shell-live';
      d.textContent = '🔴';
      rack.appendChild(d);
    }
    for (let i = 0; i < rBlank; i++) {
      const d = document.createElement('div');
      d.className = 'bsr-shell bsr-shell-blank';
      d.textContent = '🔵';
      rack.appendChild(d);
    }

    document.getElementById('mpbsrMyHP').innerHTML = '❤️'.repeat(Math.max(0, myHP)) + '🖤'.repeat(Math.max(0, 4 - myHP));
    document.getElementById('mpbsrOpHP').innerHTML = '❤️'.repeat(Math.max(0, opHP)) + '🖤'.repeat(Math.max(0, 4 - opHP));

    function renderItems(itemStr, containerId, usable) {
      const el = document.getElementById(containerId);
      el.innerHTML = '';
      if (!itemStr) return;
      itemStr.split(',').filter(Boolean).forEach((id, i) => {
        const item = MPBSR_ITEMS.find(it => it.id === id);
        if (!item) return;
        const btn = document.createElement('button');
        btn.className = 'bsr-item';
        btn.title = item.name + ': ' + item.desc;
        btn.textContent = item.icon;
        btn.style.fontSize = '18px';
        btn.style.padding = '6px 8px';
        btn.style.margin = '2px';
        btn.style.cursor = usable ? 'pointer' : 'default';
        btn.style.opacity = usable ? '1' : '0.5';
        if (usable) btn.onclick = () => mpbsrUseItem(i);
        el.appendChild(btn);
      });
    }
    renderItems(myItems, 'mpbsrMyItems', myTurn && g.status === 'active');
    renderItems(opItems, 'mpbsrOpItems', false);

    const statusEl = document.getElementById('mpbsrStatusMsg');
    if (g.status === 'active') {
      statusEl.textContent = myTurn ? '🎯 YOUR TURN — Shoot or use an item!' : '⏳ Waiting for opponent...';
      statusEl.style.color = myTurn ? 'var(--gold)' : 'var(--text2)';
    }

    const canAct = myTurn && g.status === 'active' && myHP > 0 && opHP > 0;
    document.getElementById('mpbsrShootOp').disabled = !canAct;
    document.getElementById('mpbsrShootSelf').disabled = !canAct;
    document.getElementById('mpbsrShootOp').style.opacity = canAct ? '1' : '0.4';
    document.getElementById('mpbsrShootSelf').style.opacity = canAct ? '1' : '0.4';

    if (g.log) {
      const logEl = document.getElementById('mpbsrLog');
      logEl.innerHTML = '';
      Object.values(g.log).slice(-20).reverse().forEach(l => {
        const d = document.createElement('div');
        d.className = 'bsr-log-line';
        d.style.fontSize = '12px';
        if (l.color) d.style.color = l.color;
        d.textContent = l.msg;
        logEl.appendChild(d);
      });
    }

    if (g.status === 'finished' && g.winner && !endHandled) {
      endHandled = true;
      const iWon = (g.winner === 'host' && isHost) || (g.winner === 'guest' && !isHost);
      if (iWon) {
        balance += g.bet * 2;
        updateBalDisplay();
        gameStats.mpbsr.won++;
        if (g.bet * 2 > gameStats.mpbsr.biggestWin) gameStats.mpbsr.biggestWin = g.bet * 2;
      }
      gameStats.mpbsr.played++;
      recordGame('mpbsr', g.bet, iWon ? g.bet * 2 : 0);
      if (iWon) firebaseSaveNow();

      setTimeout(() => {
        const box = document.getElementById('mpbsrGameOverContent');
        if (iWon) {
          playWinSound();
          box.innerHTML = `<div style="font-size:60px;margin-bottom:12px;">🏆</div>
            <div style="font-family:'Orbitron';font-size:22px;color:var(--green);margin-bottom:8px;">YOU WIN!</div>
            <div style="font-size:14px;color:var(--text2);margin-bottom:8px;">${opName} is eliminated!</div>
            <div style="font-family:'Orbitron';font-size:28px;color:var(--gold);margin-bottom:16px;">+$${g.bet.toLocaleString()}</div>
            <button onclick="mpbsrBackToLobby()" class="action-btn primary" style="padding:14px 32px;">BACK TO LOBBY</button>`;
          spawnParticles(window.innerWidth / 2, window.innerHeight / 2, 30);
        } else {
          playLoseSound();
          box.innerHTML = `<div style="font-size:60px;margin-bottom:12px;">💀</div>
            <div style="font-family:'Orbitron';font-size:22px;color:var(--red);margin-bottom:8px;">YOU LOSE</div>
            <div style="font-size:14px;color:var(--text2);margin-bottom:8px;">You've been eliminated...</div>
            <div style="font-family:'Orbitron';font-size:28px;color:var(--red);margin-bottom:16px;">-$${g.bet.toLocaleString()}</div>
            <button onclick="mpbsrBackToLobby()" class="action-btn primary" style="padding:14px 32px;">BACK TO LOBBY</button>`;
        }
        document.getElementById('mpbsrGameOver').style.display = 'flex';
      }, 1000);
    }
  });
}

async function mpbsrShoot(target) {
  if (!mpbsrGameId) return;
  const gid = mpbsrGameId;
  const snap = await window._fbGet('casino/bsrGames/' + gid);
  const g = snap.val();
  if (!g || g.status !== 'active') return;

  const isHost = g.host === window._currentPlayerId;
  const myTurn = (g.currentTurn === 'host' && isHost) || (g.currentTurn === 'guest' && !isHost);
  if (!myTurn) return;

  const shells = g.shells.split(',');
  const idx = g.shellIdx || 0;
  if (idx >= shells.length) return;

  const shell = shells[idx];
  const isLive = shell === 'live';
  const myName = isHost ? g.hostName : g.guestName;
  const opName = isHost ? g.guestName : g.hostName;
  const lk = Date.now().toString(36) + Math.random().toString(36).slice(2, 4);

  const updates = { shellIdx: idx + 1 };
  let dmg = isLive ? (g.sawActive ? 2 : 1) : 0;

  if (g.sawActive) updates.sawActive = false;

  if (target === 'opponent') {
    if (isLive) {
      const hpKey = isHost ? 'guestHP' : 'hostHP';
      const newHP = Math.max(0, (isHost ? g.guestHP : g.hostHP) - dmg);
      updates[hpKey] = newHP;
      await window._fbSet('casino/bsrGames/' + gid + '/log/' + lk, {
        msg: `🔫 ${myName} shoots ${opName} — 💥 LIVE! -${dmg} HP`, color: '#ff4444'
      });
      if (newHP <= 0) {
        updates.status = 'finished';
        updates.winner = isHost ? 'host' : 'guest';
        const lk2 = lk + 'w';
        await window._fbSet('casino/bsrGames/' + gid + '/log/' + lk2, {
          msg: `☠️ ${opName} has been eliminated!`, color: '#ff4444'
        });
      } else {

        if (g.cuffActive) {
          updates.cuffActive = false;
          updates.currentTurn = g.currentTurn;
          const lk3 = lk + 'c';
          await window._fbSet('casino/bsrGames/' + gid + '/log/' + lk3, {
            msg: `🔗 ${opName} is handcuffed — skips their turn!`, color: 'var(--neon)'
          });
        } else {
          updates.currentTurn = isHost ? 'guest' : 'host';
        }
      }
    } else {
      await window._fbSet('casino/bsrGames/' + gid + '/log/' + lk, {
        msg: `🔫 ${myName} shoots ${opName} — 🔵 BLANK! Turn passes.`, color: 'var(--text2)'
      });
      if (g.cuffActive) {
        updates.cuffActive = false;
        updates.currentTurn = g.currentTurn;
      } else {
        updates.currentTurn = isHost ? 'guest' : 'host';
      }
    }
  } else {

    if (isLive) {
      const hpKey = isHost ? 'hostHP' : 'guestHP';
      const newHP = Math.max(0, (isHost ? g.hostHP : g.guestHP) - dmg);
      updates[hpKey] = newHP;
      await window._fbSet('casino/bsrGames/' + gid + '/log/' + lk, {
        msg: `🤕 ${myName} shoots self — 💥 LIVE! -${dmg} HP`, color: '#ff8800'
      });
      if (newHP <= 0) {
        updates.status = 'finished';
        updates.winner = isHost ? 'guest' : 'host';
      } else {
        if (g.cuffActive) {
          updates.cuffActive = false;
          updates.currentTurn = g.currentTurn;
        } else {
          updates.currentTurn = isHost ? 'guest' : 'host';
        }
      }
    } else {
      await window._fbSet('casino/bsrGames/' + gid + '/log/' + lk, {
        msg: `🤕 ${myName} shoots self — 🔵 BLANK! Bonus turn!`, color: 'var(--green)'
      });

      updates.currentTurn = g.currentTurn;
    }
  }

  if (!updates.status && updates.shellIdx >= shells.length) {
    const newRound = (g.round || 1) + 1;
    const rd = mpbsrGenerateRound(newRound);
    updates.round = newRound;
    updates.shells = rd.shells.join(',');
    updates.shellIdx = 0;
    updates.liveCount = rd.liveCount;
    updates.blankCount = rd.blankCount;
    updates.hostItems = rd.hostItems.join(',');
    updates.guestItems = rd.guestItems.join(',');
    updates.sawActive = false;
    updates.cuffActive = false;
    const lkr = lk + 'r';
    await window._fbSet('casino/bsrGames/' + gid + '/log/' + lkr, {
      msg: `📦 Round ${newRound} — New shells loaded!`, color: 'var(--neon)'
    });
  }

  await window._fbUpdate('casino/bsrGames/' + gid, updates);
}

async function mpbsrUseItem(itemIndex) {
  if (!mpbsrGameId) return;
  const gid = mpbsrGameId;
  const snap = await window._fbGet('casino/bsrGames/' + gid);
  const g = snap.val();
  if (!g || g.status !== 'active') return;

  const isHost = g.host === window._currentPlayerId;
  const myTurn = (g.currentTurn === 'host' && isHost) || (g.currentTurn === 'guest' && !isHost);
  if (!myTurn) return;

  const itemsKey = isHost ? 'hostItems' : 'guestItems';
  const items = (g[itemsKey] || '').split(',').filter(Boolean);
  if (itemIndex >= items.length) return;

  const itemId = items[itemIndex];
  const itemInfo = MPBSR_ITEMS.find(it => it.id === itemId);
  if (!itemInfo) return;

  const myName = isHost ? g.hostName : g.guestName;
  const opName = isHost ? g.guestName : g.hostName;
  const lk = Date.now().toString(36) + Math.random().toString(36).slice(2, 4);

  items.splice(itemIndex, 1);
  const updates = { [itemsKey]: items.join(',') };

  switch (itemId) {
    case 'saw':
      updates.sawActive = true;
      await window._fbSet('casino/bsrGames/' + gid + '/log/' + lk, {
        msg: `🪚 ${myName} uses Saw — next LIVE deals 2× damage!`, color: 'var(--gold)'
      });
      break;
    case 'mag': {
      const shells = g.shells.split(',');
      const cur = shells[g.shellIdx || 0] || '?';
      await window._fbSet('casino/bsrGames/' + gid + '/log/' + lk, {
        msg: `🔍 ${myName} uses Magnifying Glass...`, color: 'var(--neon)'
      });

      showToast(`Current shell: ${cur === 'live' ? '🔴 LIVE' : '🔵 BLANK'}`, cur === 'live' ? false : true);
      break;
    }
    case 'cig': {
      const hpKey = isHost ? 'hostHP' : 'guestHP';
      const curHP = isHost ? g.hostHP : g.guestHP;
      updates[hpKey] = Math.min(curHP + 1, 4);
      await window._fbSet('casino/bsrGames/' + gid + '/log/' + lk, {
        msg: `🚬 ${myName} uses Cigarette — +1 HP!`, color: 'var(--green)'
      });
      break;
    }
    case 'cuff':
      updates.cuffActive = true;
      await window._fbSet('casino/bsrGames/' + gid + '/log/' + lk, {
        msg: `🔗 ${myName} uses Handcuffs on ${opName}!`, color: 'var(--neon)'
      });
      break;
    case 'phone': {
      const shells = g.shells.split(',');
      const remaining = shells.slice(g.shellIdx || 0);
      if (remaining.length > 0) {
        const ri = Math.floor(Math.random() * remaining.length);
        const revealPos = (g.shellIdx || 0) + ri + 1;
        showToast(`Shell #${revealPos}: ${remaining[ri] === 'live' ? '🔴 LIVE' : '🔵 BLANK'}`, true);
      }
      const lk2 = Date.now().toString(36) + Math.random().toString(36).slice(2, 4);
      await window._fbSet('casino/bsrGames/' + gid + '/log/' + lk2, {
        msg: `📱 ${myName} uses Burner Phone — reveals a shell!`, color: 'var(--neon)'
      });
      break;
    }
  }

  await window._fbUpdate('casino/bsrGames/' + gid, updates);
}

document.getElementById('rrPullBtn').addEventListener('click', function(e) {
  if (rrState && rrState.mode === 'pvp') { e.stopImmediatePropagation(); rrPvPAction('pull'); }
});
document.getElementById('rrSpinBtn').addEventListener('click', function(e) {
  if (rrState && rrState.mode === 'pvp') { e.stopImmediatePropagation(); rrPvPAction('spin'); }
});

function rrCleanupPvP() {
  if (rrPvpUnsubscribe) {
    try { rrPvpUnsubscribe(); } catch(e) {}
  }
  rrPvpUnsubscribe = null;
}

let rrChallengeInterval = null;
function rrListenForChallenges() {
  if (!window._currentPlayerId) return;
  if (rrChallengeInterval) clearInterval(rrChallengeInterval);
  rrChallengeInterval = setInterval(async () => {
    try {
      const snap = await window._fbGet('casino/players/' + window._currentPlayerId + '/notifications');
      if (!snap.exists()) return;
      const notifs = snap.val();
      for (const [key, n] of Object.entries(notifs)) {
        if (n.type === 'rr_challenge' && n.gameId) {
          window._fbRemove('casino/players/' + window._currentPlayerId + '/notifications/' + key);
          const toastDiv = document.createElement('div');
          toastDiv.style.cssText = 'position:fixed;top:20%;left:50%;transform:translateX(-50%);z-index:99999;background:var(--surface);border:2px solid var(--gold);border-radius:16px;padding:24px;text-align:center;min-width:280px;box-shadow:0 0 40px rgba(0,0,0,.5);';
          toastDiv.innerHTML = `
            <div style="font-size:30px;margin-bottom:8px;">🔫</div>
            <div style="font-family:'Orbitron';font-size:16px;color:var(--gold);margin-bottom:8px;">RUSSIAN ROULETTE CHALLENGE</div>
            <div style="font-size:14px;color:var(--text);margin-bottom:4px;"><b>${n.from}</b> challenges you!</div>
            <div style="font-size:13px;color:var(--text2);margin-bottom:14px;">Wager: <span style="color:var(--gold);">$${n.bet.toLocaleString()}</span></div>
            <div style="display:flex;gap:10px;justify-content:center;">
              <button class="action-btn primary" onclick="this.closest('div[style]').remove();rrAcceptPvPChallenge('${n.gameId}',${n.bet});" style="padding:10px 20px;">✅ ACCEPT</button>
              <button class="action-btn" onclick="this.closest('div[style]').remove();rrDeclinePvPChallenge('${n.gameId}');" style="padding:10px 20px;">❌ DECLINE</button>
            </div>`;
          document.body.appendChild(toastDiv);
          setTimeout(() => { if (toastDiv.parentNode) toastDiv.remove(); }, 30000);
        }
      }
    } catch(e) {}
  }, 5000);
}

function rrDeclinePvPChallenge(gameId) {
  window._fbUpdate('casino/rrGames/' + gameId, { status: 'declined' });
}

const _cups={active:false,ballCup:0,slots:[0,1,2],bet:0,diff:1};
const CUPS_MULTS=[0,1.9,2.5,3.5];
const CUPS_SHUFFLES=[0,8,16,28];

function cupsInit(){
  _cups.slots=[0,1,2];
  _cups.active=false;
  const area=document.getElementById('cupsArea');
  if(!area)return;
  area.innerHTML='';
  for(let i=0;i<3;i++){
    const s=document.createElement('div');
    s.className='cup-slot';
    s.onclick=(function(pos){return function(){cupsPick(pos);};})(i);
    s.innerHTML='<div class="cup-inner"><div class="cup">🏆</div><div class="cup-ball">⚽</div></div>';
    area.appendChild(s);
  }
  document.getElementById('cupsStatus').textContent='Place your bet and start!';
}

function cupsSetDiff(d){
  _cups.diff=d;
  for(let i=1;i<=3;i++){
    const btn=document.getElementById('cupsDiff'+i);
    if(i===d){btn.style.borderColor='var(--green)';btn.style.background='rgba(0,230,118,.15)';}
    else{btn.style.borderColor='var(--border)';btn.style.background='transparent';}
  }
}

function _cupsSlots(){return Array.from(document.getElementById('cupsArea').children);}

function _cupsSwap(posA,posB){
  return new Promise(function(resolve){
    var slotEls=_cupsSlots();
    var elA=slotEls[posA],elB=slotEls[posB];
    if(!elA||!elB){resolve();return;}
    var innerA=elA.querySelector('.cup-inner');
    var innerB=elB.querySelector('.cup-inner');
    var rA=elA.getBoundingClientRect();
    var rB=elB.getBoundingClientRect();
    var dx=rB.left+rB.width/2-rA.left-rA.width/2;
    innerA.style.transition='transform 0.22s cubic-bezier(.4,0,.2,1)';
    innerB.style.transition='transform 0.22s cubic-bezier(.4,0,.2,1)';
    void innerA.offsetHeight;
    innerA.style.transform='translateX('+dx+'px)';
    innerB.style.transform='translateX('+(-dx)+'px)';
    setTimeout(function(){
      innerA.style.transition='none';
      innerB.style.transition='none';
      var ph=document.createComment('');
      elA.insertBefore(ph,innerA);
      elB.appendChild(innerA);
      elA.insertBefore(innerB,ph);
      ph.remove();
      innerA.style.transform='';
      innerB.style.transform='';
      var tmp=_cups.slots[posA];
      _cups.slots[posA]=_cups.slots[posB];
      _cups.slots[posB]=tmp;
      resolve();
    },240);
  });
}

async function _cupsDoShuffle(count){
  var speed = count > 20 ? 0.14 : count > 10 ? 0.18 : 0.22;
  for(var i=0;i<count;i++){
    var a=Math.floor(Math.random()*3),b;
    do{b=Math.floor(Math.random()*3);}while(b===a);

    var slotEls=_cupsSlots();
    slotEls.forEach(function(s){
      var inner=s.querySelector('.cup-inner');
      if(inner) inner.style.transition='transform '+speed+'s cubic-bezier(.4,0,.2,1)';
    });
    await _cupsSwap(a,b);
    var pause=Math.max(20,80-i*3);
    await new Promise(function(r){setTimeout(r,pause);});
  }
}

function cupsStart(){
  if(_cups.active)return;
  var bet=parseBet(document.getElementById('cupsBet').value)||100;
  if(bet<=0)return;
  if(bet>balance){showToast('Not enough!',false);return;}
  if(!checkMaxBet(bet))return;
  balance-=bet;_cups.bet=bet;_cups.active=true;
  _balMark();updateBalDisplay();if(!firebaseSaveBet(bet)){_cups.active=false;return;}
  var btn=document.getElementById('cupsStartBtn');
  btn.disabled=true;btn.style.opacity='0.5';
  cupsInit();
  _cups.active=true;
  _cups.ballCup=Math.floor(Math.random()*3);
  document.getElementById('cupsStatus').textContent='Watch carefully...';
  var slotEls=_cupsSlots();
  slotEls.forEach(function(s){s.style.pointerEvents='none';});
  setTimeout(function(){
    var els=_cupsSlots();
    els.forEach(function(s){s.querySelector('.cup').classList.add('lifted');});
    var ballPos=_cups.slots.indexOf(_cups.ballCup);
    els[ballPos].querySelector('.cup-ball').style.opacity='1';
  },400);
  setTimeout(function(){
    var els=_cupsSlots();
    els.forEach(function(s){
      s.querySelector('.cup').classList.remove('lifted');
      s.querySelector('.cup-ball').style.opacity='0';
    });
  },1800);
  setTimeout(async function(){
    document.getElementById('cupsStatus').textContent='Shuffling...';
    await _cupsDoShuffle(CUPS_SHUFFLES[_cups.diff]);
    document.getElementById('cupsStatus').textContent='Pick a cup!';
    _cupsSlots().forEach(function(s){s.style.pointerEvents='';});
  },2200);
}

function cupsPick(slotIdx){
  if(!_cups.active)return;
  _cups.active=false;
  var slotEls=_cupsSlots();
  slotEls.forEach(function(s){s.style.pointerEvents='none';});
  var pickedCup=_cups.slots[slotIdx];
  var correct=(pickedCup===_cups.ballCup);
  slotEls.forEach(function(s){s.querySelector('.cup').classList.add('lifted');});
  setTimeout(function(){
    var els=_cupsSlots();
    var ballPos=_cups.slots.indexOf(_cups.ballCup);
    els[ballPos].querySelector('.cup-ball').style.opacity='1';
    var picked=els[slotIdx];
    picked.style.outline=correct?'3px solid var(--green)':'3px solid var(--red)';
    picked.style.outlineOffset='4px';
    picked.style.borderRadius='12px';
    if(correct){
      var mult=CUPS_MULTS[_cups.diff];
      var win=Math.floor(_cups.bet*mult*getPrestigeMultiplier()*100)/100;
      balance+=win;_balMark();updateBalDisplay();firebaseSaveNow();
      playWinSound();
      document.getElementById('cupsStatus').innerHTML='🎉 CORRECT! Won <strong style="color:var(--gold);">'+formatBalance(win)+' (×'+mult+')</strong>';
      showToast('+'+formatBalance(win),true);
      if(window._broadcastWin&&win>=_cups.bet*3)window._broadcastWin(window._currentUsername,win,'cups');
      if(window._recordGameResult)window._recordGameResult('cups',_cups.bet,win);
    }else{
      playLoseSound();
      document.getElementById('cupsStatus').innerHTML='❌ Wrong cup! Lost <strong style="color:var(--red);">'+formatBalance(_cups.bet)+'</strong>';
      showToast('-'+formatBalance(_cups.bet),false);
      if(window._recordGameResult)window._recordGameResult('cups',_cups.bet,0);
    }
    setTimeout(function(){
      var b=document.getElementById('cupsStartBtn');
      b.disabled=false;b.style.opacity='';
      picked.style.outline='';picked.style.outlineOffset='';
    },1200);
  },500);
}
cupsInit();

const MOD_ADMINS = ['mojheh', 'terpez', 'jiddy'];

function modIsStaff() {
  const name = (window._currentUsername || '').toLowerCase();
  return MOD_ADMINS.includes(name);
}
function modGetStaffLevel() {
  const name = (window._currentUsername || '').toLowerCase();
  if (name === 'mojheh') return 'owner';
  if (name === 'terpez') return 'co-owner';
  if (name === 'jiddy') return 'admin';
  return null;
}

window._modShowBan = function(banData) {
  const overlay = document.getElementById('modBanOverlay');
  const reasonEl = document.getElementById('modBanReason');
  const timerEl = document.getElementById('modBanTimer');
  reasonEl.textContent = banData.reason || 'Violation of community rules.';
  const isPerm = !banData.until || banData.until >= 9999999999999;
  if (isPerm) {
    timerEl.textContent = 'PERMANENT';
    timerEl.style.color = '#ff3333';
  } else {
    const remaining = banData.until - Date.now();
    function updateBanTimer() {
      const left = banData.until - Date.now();
      if (left <= 0) { timerEl.textContent = 'Expired'; return; }
      const h = Math.floor(left / 3600000);
      const m = Math.floor((left % 3600000) / 60000);
      const s = Math.floor((left % 60000) / 1000);
      timerEl.textContent = `${h}h ${m}m ${s}s remaining`;
    }
    updateBanTimer();
    setInterval(updateBanTimer, 1000);
  }
  overlay.style.display = 'flex';
};

window._modIsMuted = false;
let _modMuteUnsub = null;
let _modBanUnsub = null;
let _modWarnUnsub = null;

function modStartWatchers() {
  const uid = window._currentPlayerId;
  if (!uid) return;

  if (_modBanUnsub) { try { _modBanUnsub(); } catch(e){} }
  _modBanUnsub = window._fbOnValue('casino/bannedUsers/' + uid, (snap) => {
    if (!snap.exists()) return;
    const d = snap.val();
    const isPerm = !d.until || d.until >= 9999999999999;
    if (isPerm || d.until > Date.now()) {
      window._modShowBan(d);
      setTimeout(() => { if (window._authLogout) window._authLogout(); }, 4000);
    }
  });

  if (_modMuteUnsub) { try { _modMuteUnsub(); } catch(e){} }
  _modMuteUnsub = window._fbOnValue('casino/mutedUsers/' + uid, (snap) => {
    if (!snap.exists()) {
      window._modIsMuted = false;
      document.getElementById('modMuteBanner').style.display = 'none';
      const ci = document.getElementById('chatInput');
      const cb = document.getElementById('chatSendBtn');
      if (ci) ci.disabled = false;
      if (cb) cb.disabled = false;
      return;
    }
    const d = snap.val();
    if (d.until && d.until <= Date.now()) {

      window._fbRemove('casino/mutedUsers/' + uid);
      window._modIsMuted = false;
      return;
    }
    window._modIsMuted = true;
    const banner = document.getElementById('modMuteBanner');
    document.getElementById('modMuteReason').textContent = d.reason || 'No reason given';
    banner.style.display = 'block';
    const ci = document.getElementById('chatInput');
    const cb = document.getElementById('chatSendBtn');
    if (ci) { ci.disabled = true; ci.placeholder = 'You are muted...'; }
    if (cb) cb.disabled = true;

    if (d.until) {
      const updateMuteTimer = () => {
        const left = d.until - Date.now();
        if (left <= 0) {
          window._fbRemove('casino/mutedUsers/' + uid);
          return;
        }
        const m = Math.floor(left / 60000);
        const s = Math.floor((left % 60000) / 1000);
        document.getElementById('modMuteTimer').textContent = `${m}m ${s}s left`;
      };
      updateMuteTimer();
      const iv = setInterval(() => {
        if (!window._modIsMuted) { clearInterval(iv); return; }
        updateMuteTimer();
      }, 1000);
    } else {
      document.getElementById('modMuteTimer').textContent = 'Permanent';
    }
  });

  if (_modWarnUnsub) { try { _modWarnUnsub(); } catch(e){} }
  _modWarnUnsub = window._fbOnValue('casino/warnings/' + uid, (snap) => {
    if (!snap.exists()) return;
    const d = snap.val();
    if (!d.active) return;
    const overlay = document.getElementById('modWarnOverlay');
    document.getElementById('modWarnReason').textContent = d.reason || 'Please follow the rules.';
    document.getElementById('modWarnAgree').checked = false;
    document.getElementById('modWarnCloseBtn').disabled = true;
    overlay.style.display = 'flex';
  });
}

function modDismissWarning() {
  document.getElementById('modWarnOverlay').style.display = 'none';
  const uid = window._currentPlayerId;
  if (uid) window._fbRemove('casino/warnings/' + uid);
}

let _modActionType = null;
let _modActionTargetUid = null;
let _modActionTargetName = null;
let _modSelectedDuration = 10080;

function modOpenActionOnUser(uid, username) {
  if (!modIsStaff()) { showToast('Staff only!', false); return; }

  const menu = document.createElement('div');
  menu.style.cssText = 'position:fixed;top:20%;left:50%;transform:translateX(-50%);z-index:100002;background:var(--surface);border:2px solid var(--gold);border-radius:16px;padding:20px;text-align:center;min-width:260px;box-shadow:0 0 40px rgba(0,0,0,.5);';
  menu.innerHTML = `
    <div style="font-family:'Orbitron';font-size:13px;color:var(--gold);margin-bottom:4px;">🛡️ MOD ACTIONS</div>
    <div style="font-size:12px;color:var(--text);margin-bottom:14px;">Target: <b>${username}</b></div>
    <div style="display:flex;flex-direction:column;gap:8px;">
      <button class="action-btn" style="padding:10px;font-size:12px;background:linear-gradient(135deg,#ff3333,#cc0000);" onclick="this.closest('div[style]').remove();modStartAction('ban','${uid}','${username}');">🚫 BAN</button>
      <button class="action-btn" style="padding:10px;font-size:12px;background:linear-gradient(135deg,#ff8800,#cc6600);" onclick="this.closest('div[style]').remove();modStartAction('mute','${uid}','${username}');">🔇 MUTE</button>
      <button class="action-btn" style="padding:10px;font-size:12px;background:linear-gradient(135deg,#ffaa00,#cc8800);" onclick="this.closest('div[style]').remove();modStartAction('warn','${uid}','${username}');">⚠️ WARN</button>
      <button style="padding:8px;background:transparent;border:1px solid var(--border);border-radius:8px;color:var(--text2);cursor:pointer;font-size:11px;" onclick="this.closest('div[style]').remove();">Cancel</button>
    </div>`;
  document.body.appendChild(menu);
  setTimeout(() => { if (menu.parentNode) menu.remove(); }, 30000);
}

function modStartAction(type, uid, username) {
  if (!modIsStaff()) return;
  _modActionType = type;
  _modActionTargetUid = uid;
  _modActionTargetName = username;
  _modSelectedDuration = 10080;

  const modal = document.getElementById('modReasonModal');
  const titleEl = document.getElementById('modReasonTitle');
  const durRow = document.getElementById('modDurationRow');
  document.getElementById('modReasonCustom').value = '';

  if (type === 'ban') {
    titleEl.textContent = '🚫 BAN — ' + username;
    durRow.style.display = 'flex';
  } else if (type === 'mute') {
    titleEl.textContent = '🔇 MUTE — ' + username;
    durRow.style.display = 'flex';
  } else {
    titleEl.textContent = '⚠️ WARN — ' + username;
    durRow.style.display = 'none';
  }

  durRow.querySelectorAll('.mod-dur-btn').forEach(b => b.classList.remove('active'));
  durRow.querySelector('.mod-dur-btn:nth-child(3)').classList.add('active');

  modal.style.display = 'flex';
}

function modPickReason(reason) {
  document.getElementById('modReasonCustom').value = reason;
}

function modPickDuration(mins) {
  _modSelectedDuration = mins;
  const durRow = document.getElementById('modDurationRow');
  durRow.querySelectorAll('.mod-dur-btn').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');
}

function modCancelReason() {
  document.getElementById('modReasonModal').style.display = 'none';
  _modActionType = null;
  _modActionTargetUid = null;
  _modActionTargetName = null;
}

async function modConfirmReason() {
  if (!modIsStaff()) return;
  const reason = document.getElementById('modReasonCustom').value.trim() || 'No reason specified';
  const uid = _modActionTargetUid;
  const username = _modActionTargetName;
  const type = _modActionType;

  if (!uid || !type) { modCancelReason(); return; }

  document.getElementById('modReasonModal').style.display = 'none';

  try {
    if (type === 'ban') {
      const until = _modSelectedDuration === 0 ? 9999999999999 : Date.now() + _modSelectedDuration * 60000;
      await window._fbSet('casino/bannedUsers/' + uid, {
        until: until,
        reason: reason,
        bannedBy: window._currentUsername || 'Admin',
        bannedAt: Date.now(),
        username: username
      });
      const durText = _modSelectedDuration === 0 ? 'PERMANENTLY' : `for ${formatDuration(_modSelectedDuration * 60000)}`;
      showToast(`🚫 Banned ${username} ${durText}`, true);
    } else if (type === 'mute') {
      const until = _modSelectedDuration === 0 ? 9999999999999 : Date.now() + _modSelectedDuration * 60000;
      await window._fbSet('casino/mutedUsers/' + uid, {
        until: until,
        reason: reason,
        mutedBy: window._currentUsername || 'Admin',
        mutedAt: Date.now(),
        username: username
      });
      const durText = _modSelectedDuration === 0 ? 'PERMANENTLY' : `for ${formatDuration(_modSelectedDuration * 60000)}`;
      showToast(`🔇 Muted ${username} ${durText}`, true);
    } else if (type === 'warn') {
      await window._fbSet('casino/warnings/' + uid, {
        active: true,
        reason: reason,
        warnedBy: window._currentUsername || 'Admin',
        warnedAt: Date.now(),
        username: username
      });
      showToast(`⚠️ Warning sent to ${username}`, true);
    }
  } catch(e) {
    console.error('Mod action error:', e);
    showToast('❌ Failed: ' + (e.message || 'Unknown error'), false);
  }

  _modActionType = null;
  _modActionTargetUid = null;
  _modActionTargetName = null;
}

function formatDuration(ms) {
  if (ms >= 86400000) return Math.floor(ms / 86400000) + 'd';
  if (ms >= 3600000) return Math.floor(ms / 3600000) + 'h';
  if (ms >= 60000) return Math.floor(ms / 60000) + 'm';
  return Math.floor(ms / 1000) + 's';
}

async function modDeleteChatMsg(key) {
  if (!modIsStaff()) return;
  try {
    await window._fbRemove('casino/chat/' + key);
    showToast('🗑 Message deleted', true);
  } catch(e) {
    showToast('❌ Failed to delete', false);
  }
}

let _modPanelTab = 'banned';

function modOpenPanel() {
  if (!modIsStaff()) { showToast('Staff only!', false); return; }
  document.getElementById('modPanel').style.display = 'flex';
  modSwitchTab('banned');
}

function modClosePanel() {
  document.getElementById('modPanel').style.display = 'none';
}

document.addEventListener('click', function(e) {
  const modPanel = document.getElementById('modPanel');
  if (modPanel && modPanel.style.display === 'flex' && e.target === modPanel) {
    modClosePanel();
  }
  const modReason = document.getElementById('modReasonModal');
  if (modReason && modReason.style.display === 'flex' && e.target === modReason) {
    modCancelReason();
  }
});

function modSwitchTab(tab) {
  _modPanelTab = tab;
  document.querySelectorAll('.mod-panel-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.mod-panel-tab').forEach(t => {
    if (t.textContent.trim().toLowerCase() === tab ||
        (tab === 'banned' && t.textContent.includes('BANNED')) ||
        (tab === 'muted' && t.textContent.includes('MUTED')) ||
        (tab === 'actions' && t.textContent.includes('ACTIONS'))) {
      t.classList.add('active');
    }
  });
  modRenderPanel();
}

async function modRenderPanel() {
  const container = document.getElementById('modPanelContent');
  container.innerHTML = '<div class="mod-panel-empty">Loading...</div>';

  try {
    if (_modPanelTab === 'banned') {
      const snap = await window._fbGet('casino/bannedUsers');
      if (!snap.exists()) { container.innerHTML = '<div class="mod-panel-empty">No banned users</div>'; return; }
      let html = '';
      const data = snap.val();
      for (const [uid, d] of Object.entries(data)) {
        const isPerm = !d.until || d.until >= 9999999999999;
        const expired = !isPerm && d.until <= Date.now();
        if (expired) { window._fbRemove('casino/bannedUsers/' + uid); continue; }
        const timeLeft = isPerm ? '<span style="color:#ff3333;">PERMANENT</span>' : formatDuration(d.until - Date.now()) + ' left';
        html += `<div class="mod-panel-item">
          <div class="mod-panel-item-info">
            <div class="mod-panel-item-name">${d.username || uid.slice(0,8)}</div>
            <div class="mod-panel-item-detail">Reason: ${d.reason || '—'} · ${timeLeft} · By: ${d.bannedBy || '?'}</div>
          </div>
          <div class="mod-panel-item-actions">
            <button class="mod-panel-action green" onclick="modUnbanUser('${uid}')">UNBAN</button>
          </div>
        </div>`;
      }
      container.innerHTML = html || '<div class="mod-panel-empty">No banned users</div>';
    } else if (_modPanelTab === 'muted') {
      const snap = await window._fbGet('casino/mutedUsers');
      if (!snap.exists()) { container.innerHTML = '<div class="mod-panel-empty">No muted users</div>'; return; }
      let html = '';
      const data = snap.val();
      for (const [uid, d] of Object.entries(data)) {
        const isPerm = !d.until || d.until >= 9999999999999;
        const expired = !isPerm && d.until <= Date.now();
        if (expired) { window._fbRemove('casino/mutedUsers/' + uid); continue; }
        const timeLeft = isPerm ? '<span style="color:#ff8800;">PERMANENT</span>' : formatDuration(d.until - Date.now()) + ' left';
        html += `<div class="mod-panel-item">
          <div class="mod-panel-item-info">
            <div class="mod-panel-item-name">${d.username || uid.slice(0,8)}</div>
            <div class="mod-panel-item-detail">Reason: ${d.reason || '—'} · ${timeLeft} · By: ${d.mutedBy || '?'}</div>
          </div>
          <div class="mod-panel-item-actions">
            <button class="mod-panel-action green" onclick="modUnmuteUser('${uid}')">UNMUTE</button>
          </div>
        </div>`;
      }
      container.innerHTML = html || '<div class="mod-panel-empty">No muted users</div>';
    } else if (_modPanelTab === 'actions') {
      container.innerHTML = `
        <div style="margin-bottom:16px;">
          <div style="font-size:11px;color:var(--text2);letter-spacing:1px;margin-bottom:8px;">QUICK ACTION BY USERNAME</div>
          <div style="display:flex;gap:6px;">
            <input type="text" id="modActionUsername" placeholder="Enter username..." class="mod-panel-search" style="margin-bottom:0;">
            <button class="mod-panel-action blue" style="white-space:nowrap;padding:8px 14px;" onclick="modLookupUser()">LOOKUP</button>
          </div>
        </div>
        <div id="modLookupResult"></div>
        <div style="margin-top:20px;border-top:1px solid var(--border);padding-top:16px;">
          <div style="font-size:11px;color:var(--text2);letter-spacing:1px;margin-bottom:8px;">BULK ACTIONS</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button class="mod-panel-action red" onclick="modUnbanAll()">UNBAN ALL</button>
            <button class="mod-panel-action red" onclick="modUnmuteAll()">UNMUTE ALL</button>
          </div>
        </div>`;
    }
  } catch(e) {
    container.innerHTML = '<div class="mod-panel-empty">Error: ' + (e.message || 'Unknown') + '</div>';
  }
}

async function modLookupUser() {
  const username = document.getElementById('modActionUsername').value.trim();
  if (!username) { showToast('Enter a username', false); return; }
  const resultDiv = document.getElementById('modLookupResult');
  resultDiv.innerHTML = '<div style="color:var(--text2);font-size:12px;">Looking up...</div>';
  try {
    const snap = await window._fbGet('casino/usernames/' + username.toLowerCase());
    if (!snap.exists()) { resultDiv.innerHTML = '<div style="color:var(--red);font-size:12px;">User not found</div>'; return; }
    const uid = snap.val();

    const [banSnap, muteSnap] = await Promise.all([
      window._fbGet('casino/bannedUsers/' + uid),
      window._fbGet('casino/mutedUsers/' + uid)
    ]);
    const isBanned = banSnap.exists();
    const isMuted = muteSnap.exists();
    resultDiv.innerHTML = `
      <div class="mod-panel-item" style="margin:0;">
        <div class="mod-panel-item-info">
          <div class="mod-panel-item-name">${username} <span style="font-size:10px;color:var(--text2);">${uid.slice(0,12)}...</span></div>
          <div class="mod-panel-item-detail">
            Status: ${isBanned ? '<span style="color:#ff3333;">BANNED</span>' : '<span style="color:var(--green);">Not banned</span>'} ·
            ${isMuted ? '<span style="color:#ff8800;">MUTED</span>' : '<span style="color:var(--green);">Not muted</span>'}
          </div>
        </div>
        <div class="mod-panel-item-actions" style="flex-wrap:wrap;">
          ${isBanned ? `<button class="mod-panel-action green" onclick="modUnbanUser('${uid}');modLookupUser();">UNBAN</button>` : `<button class="mod-panel-action red" onclick="modStartAction('ban','${uid}','${username}')">BAN</button>`}
          ${isMuted ? `<button class="mod-panel-action green" onclick="modUnmuteUser('${uid}');modLookupUser();">UNMUTE</button>` : `<button class="mod-panel-action red" onclick="modStartAction('mute','${uid}','${username}')">MUTE</button>`}
          <button class="mod-panel-action blue" onclick="modStartAction('warn','${uid}','${username}')">WARN</button>
          <button class="mod-panel-action red" style="background:rgba(255,136,0,.15);color:#ff8800;border:1px solid rgba(255,136,0,.3);" onclick="modSetBalance('${uid}','${username}')">SET BAL</button>
        </div>
      </div>`;
  } catch(e) {
    resultDiv.innerHTML = '<div style="color:var(--red);font-size:12px;">Error: ' + (e.message || 'Unknown') + '</div>';
  }
}

async function modSetBalance(uid, username) {
  if (!modIsStaff()) return;
  const input = prompt('Set balance for ' + username + ' to (e.g. 1000000000 for 1B):');
  if (input === null) return;
  const val = parseFloat(input);
  if (isNaN(val) || val < 0) { showToast('Invalid amount', false); return; }
  try {
    await window._fbSet('casino/players/' + uid + '/balance', val);

    showToast('✅ Set ' + username + ' balance to $' + val.toLocaleString(), true);
  } catch(e) { showToast('❌ Failed: ' + (e.message || 'Unknown'), false); }
}

async function modUnbanUser(uid) {
  if (!modIsStaff()) return;
  try {
    await window._fbRemove('casino/bannedUsers/' + uid);
    showToast('✅ User unbanned', true);
    if (_modPanelTab === 'banned') modRenderPanel();
  } catch(e) { showToast('❌ Failed', false); }
}

async function modUnmuteUser(uid) {
  if (!modIsStaff()) return;
  try {
    await window._fbRemove('casino/mutedUsers/' + uid);
    showToast('✅ User unmuted', true);
    if (_modPanelTab === 'muted') modRenderPanel();
  } catch(e) { showToast('❌ Failed', false); }
}

async function modUnbanAll() {
  if (!modIsStaff()) return;
  if (!confirm('Unban ALL users?')) return;
  try {
    await window._fbRemove('casino/bannedUsers');
    showToast('✅ All users unbanned', true);
    modRenderPanel();
  } catch(e) { showToast('❌ Failed', false); }
}

async function modUnmuteAll() {
  if (!modIsStaff()) return;
  if (!confirm('Unmute ALL users?')) return;
  try {
    await window._fbRemove('casino/mutedUsers');
    showToast('✅ All users unmuted', true);
    modRenderPanel();
  } catch(e) { showToast('❌ Failed', false); }
}

let casinoSettings = JSON.parse(localStorage.getItem('casino_settings')) || {
  sound: true,
  particles: true,
  reducedAnim: false,
  theme: 'dark'
};

function openSettingsPanel() {
  document.getElementById('settingsOverlay').style.display = 'block';

  const snd = document.getElementById('settingSound');
  const part = document.getElementById('settingParticles');
  const ra = document.getElementById('settingReducedAnim');
  if (snd) { snd.checked = casinoSettings.sound; updateToggleVisual('settingSound', casinoSettings.sound); }
  if (part) { part.checked = casinoSettings.particles; updateToggleVisual('settingParticles', casinoSettings.particles); }
  if (ra) { ra.checked = casinoSettings.reducedAnim; updateToggleVisual('settingReducedAnim', casinoSettings.reducedAnim); }

  document.querySelectorAll('.theme-btn').forEach(b => {
    b.style.borderColor = b.dataset.theme === casinoSettings.theme ? 'var(--neon)' : 'var(--border)';
  });
}

function closeSettingsPanel() {
  document.getElementById('settingsOverlay').style.display = 'none';
}

function updateToggleVisual(id, on) {
  const knob = document.getElementById(id + 'Knob');
  if (!knob) return;
  knob.style.left = on ? '25px' : '3px';
  knob.style.background = on ? 'var(--neon)' : 'var(--text2)';
  knob.parentElement.querySelector('span').style.background = on ? 'rgba(0,240,255,.3)' : 'var(--surface2)';
}

function settingToggle(key, val) {
  casinoSettings[key] = val;
  localStorage.setItem('casino_settings', JSON.stringify(casinoSettings));
  updateToggleVisual('setting' + key.charAt(0).toUpperCase() + key.slice(1), val);

  if (key === 'sound') {
    soundMuted = !val;
    const mb = document.getElementById('muteBtn');
    if (mb) mb.textContent = val ? '🔊' : '🔇';
  }
  if (key === 'particles') {
    const c = document.getElementById('particles');
    if (c) c.style.display = val ? 'block' : 'none';
  }
  if (key === 'reducedAnim') {
    document.body.style.setProperty('--anim-speed', val ? '0.1s' : '');
    if (val) document.body.classList.add('reduced-motion'); else document.body.classList.remove('reduced-motion');
  }
}

const THEMES = {
  dark: { bg:'#040814', surface1:'#0a0f2e', surface:'rgba(255,255,255,0.03)', surface2:'rgba(255,255,255,0.06)', border:'rgba(255,255,255,0.08)', text:'#e8eaed', text2:'rgba(255,255,255,0.5)', neon:'#00f0ff', gold:'#ffd700', green:'#00e676', red:'#ff4444' },
  midnight: { bg:'#0d0221', surface1:'#150330', surface:'rgba(211,44,230,0.04)', surface2:'rgba(211,44,230,0.08)', border:'rgba(211,44,230,0.15)', text:'#e8d5f5', text2:'rgba(255,255,255,0.5)', neon:'#d32ce6', gold:'#ffd700', green:'#00e676', red:'#ff4444' },
  ocean: { bg:'#001a33', surface1:'#002244', surface:'rgba(0,191,255,0.04)', surface2:'rgba(0,191,255,0.08)', border:'rgba(0,191,255,0.15)', text:'#d4efff', text2:'rgba(255,255,255,0.5)', neon:'#00bfff', gold:'#ffd700', green:'#00e676', red:'#ff4444' },
  forest: { bg:'#0a1f0a', surface1:'#122812', surface:'rgba(0,230,118,0.04)', surface2:'rgba(0,230,118,0.08)', border:'rgba(0,230,118,0.15)', text:'#d4f5d4', text2:'rgba(255,255,255,0.5)', neon:'#00e676', gold:'#ffd700', green:'#00e676', red:'#ff4444' },
  crimson: { bg:'#1a0505', surface1:'#260808', surface:'rgba(255,68,68,0.04)', surface2:'rgba(255,68,68,0.08)', border:'rgba(255,68,68,0.15)', text:'#f5d4d4', text2:'rgba(255,255,255,0.5)', neon:'#ff4444', gold:'#ffd700', green:'#00e676', red:'#ff4444' },
  gold: { bg:'#1a1500', surface1:'#262000', surface:'rgba(255,215,0,0.04)', surface2:'rgba(255,215,0,0.08)', border:'rgba(255,215,0,0.15)', text:'#f5eed4', text2:'rgba(255,255,255,0.5)', neon:'#ffd700', gold:'#ffd700', green:'#00e676', red:'#ff4444' },
};

function setTheme(name) {
  const t = THEMES[name];
  if (!t) return;
  casinoSettings.theme = name;
  localStorage.setItem('casino_settings', JSON.stringify(casinoSettings));
  const root = document.documentElement;
  Object.entries(t).forEach(([k, v]) => {
    root.style.setProperty('--' + k.replace(/([A-Z])/g, m => '-' + m.toLowerCase()), v);
  });

  document.querySelectorAll('.theme-btn').forEach(b => {
    b.style.borderColor = b.dataset.theme === name ? 'var(--neon)' : 'var(--border)';
  });
}

(function applySavedSettings() {
  if (!casinoSettings.sound) {
    soundMuted = true;
    setTimeout(() => {
      const mb = document.getElementById('muteBtn');
      if (mb) mb.textContent = '🔇';
    }, 100);
  }
  if (!casinoSettings.particles) {
    const c = document.getElementById('particles');
    if (c) c.style.display = 'none';
  }
  if (casinoSettings.reducedAnim) {
    document.body.classList.add('reduced-motion');
  }
  if (casinoSettings.theme && casinoSettings.theme !== 'dark') {
    setTheme(casinoSettings.theme);
  }
})();

let activePotions = JSON.parse(localStorage.getItem('casino_potions')) || {};

function openShopOverlay() {
  document.getElementById('shopOverlay').style.display = 'block';
  shopRefresh();
}

function closeShopOverlay() {
  document.getElementById('shopOverlay').style.display = 'none';
}

function shopRefresh() {
  document.getElementById('shopBalText').textContent = (typeof balance !== 'undefined' ? balance : 0).toLocaleString();

  const lp = activePotions.luck || { stacks: 0, expires: 0 };
  const luckActive = lp.stacks > 0 && lp.expires > Date.now();
  document.getElementById('shopLuckCount').textContent = luckActive ? lp.stacks : '0';

  const sp = activePotions.speed || { active: false, expires: 0 };
  document.getElementById('shopSpeedActive').textContent = sp.active && sp.expires > Date.now() ? 'ON' : 'OFF';
  document.getElementById('shopSpeedActive').style.color = sp.active && sp.expires > Date.now() ? 'var(--green)' : 'var(--text2)';

  const sh = activePotions.shield || { active: false, expires: 0 };
  document.getElementById('shopShieldActive').textContent = sh.active && sh.expires > Date.now() ? 'ON' : 'OFF';
  document.getElementById('shopShieldActive').style.color = sh.active && sh.expires > Date.now() ? 'var(--green)' : 'var(--text2)';

  const xp = activePotions.xp || { active: false, expires: 0 };
  document.getElementById('shopXPActive').textContent = xp.active && xp.expires > Date.now() ? 'ON' : 'OFF';
  document.getElementById('shopXPActive').style.color = xp.active && xp.expires > Date.now() ? 'var(--green)' : 'var(--text2)';

  const eff = [];
  if (luckActive) { const rem = Math.ceil((lp.expires - Date.now()) / 60000); eff.push(`<div style="padding:6px;border-radius:6px;background:rgba(255,215,0,.1);border:1px solid rgba(255,215,0,.2);"><span style="font-size:14px;">🍀</span> Luck ×${lp.stacks} — ${rem}m left</div>`); }
  if (sp.active && sp.expires > Date.now()) { const rem = Math.ceil((sp.expires - Date.now()) / 60000); eff.push(`<div style="padding:6px;border-radius:6px;background:rgba(0,240,255,.1);border:1px solid rgba(0,240,255,.2);"><span style="font-size:14px;">⚡</span> Speed 2× — ${rem}m left</div>`); }
  if (sh.active && sh.expires > Date.now()) { const rem = Math.ceil((sh.expires - Date.now()) / 60000); eff.push(`<div style="padding:6px;border-radius:6px;background:rgba(0,230,118,.1);border:1px solid rgba(0,230,118,.2);"><span style="font-size:14px;">🛡️</span> Shield — ${rem}m left</div>`); }
  if (xp.active && xp.expires > Date.now()) { const rem = Math.ceil((xp.expires - Date.now()) / 60000); eff.push(`<div style="padding:6px;border-radius:6px;background:rgba(138,43,226,.1);border:1px solid rgba(138,43,226,.2);"><span style="font-size:14px;">📈</span> XP 2× — ${rem}m left</div>`); }
  document.getElementById('shopActiveEffects').innerHTML = eff.length ? eff.join('') : '<div style="color:var(--text2);font-size:12px;text-align:center;">No active effects</div>';
}

function shopBuyPotion(type) {
  const prices = { luck: 2000, speed: 3000, shield: 5000, xp: 4000 };
  const price = prices[type];
  if (!price) return;
  if (balance < price) { showToast('Not enough balance! Need $' + price.toLocaleString(), false); return; }

  balance -= price;
  updateBalDisplay();
  playClickSound();

  if (type === 'luck') {
    if (!activePotions.luck) activePotions.luck = { stacks: 0, expires: 0 };
    if (activePotions.luck.stacks >= 5 && activePotions.luck.expires > Date.now()) {
      showToast('Max 5 luck stacks!', false);
      balance += price; updateBalDisplay(); return;
    }
    activePotions.luck.stacks = Math.min(5, (activePotions.luck.stacks || 0) + 1);
    activePotions.luck.expires = Date.now() + 10 * 60 * 1000;
    showToast('🍀 Luck Potion active! Stack: ' + activePotions.luck.stacks + '/5', true);
  } else if (type === 'speed') {
    activePotions.speed = { active: true, expires: Date.now() + 15 * 60 * 1000 };
    showToast('⚡ Speed Potion active! 2× speed for 15 min', true);
  } else if (type === 'shield') {
    activePotions.shield = { active: true, expires: Date.now() + 5 * 60 * 1000 };
    showToast('🛡️ Shield active! Loss protection for 5 min', true);
  } else if (type === 'xp') {
    activePotions.xp = { active: true, expires: Date.now() + 20 * 60 * 1000 };
    showToast('📈 XP Boost active! 2× stats for 20 min', true);
  }

  localStorage.setItem('casino_potions', JSON.stringify(activePotions));
  window._firebaseSave && firebaseSave();
  shopRefresh();
}

function getLuckBonus() {
  const lp = activePotions.luck || { stacks: 0, expires: 0 };
  let mult = getPrestigeMultiplier();
  if (lp.stacks > 0 && lp.expires > Date.now()) mult *= (1 + (lp.stacks * 0.05));
  return mult;
}

function getPrestigeMultiplier() {
  return 1 + (prestigeLevel * 0.05);
}

function isSpeedActive() {
  const sp = activePotions.speed || { active: false, expires: 0 };
  return sp.active && sp.expires > Date.now();
}

function isShieldActive() {
  const sh = activePotions.shield || { active: false, expires: 0 };
  return sh.active && sh.expires > Date.now();
}

let serialCounter = parseInt(localStorage.getItem('casino_serial_counter')) || 100000;

function generateSerial() {
  serialCounter++;
  localStorage.setItem('casino_serial_counter', serialCounter);

  const hex = serialCounter.toString(16).toUpperCase().padStart(9, '0');
  return 'SN-' + hex.slice(0, 5) + '-' + hex.slice(5);
}

const _origAddToInventory = addToInventory;
addToInventory = function(itemId) {
  _origAddToInventory(itemId);

  if (inventory.length > 0) {
    const lastItem = inventory[inventory.length - 1];
    if (!lastItem.serial) lastItem.serial = generateSerial();
  }
};

let limitedCases = [];
let limitedCaseTimer = null;

function initLimitedCases() {

  const saved = JSON.parse(localStorage.getItem('casino_limited_cases')) || [];
  limitedCases = saved.filter(c => c.expires > Date.now());
  if (limitedCases.length === 0) {
    spawnLimitedCase();
  }
  renderLimitedCases();

  if (limitedCaseTimer) clearInterval(limitedCaseTimer);
  limitedCaseTimer = setInterval(() => {
    limitedCases = limitedCases.filter(c => c.expires > Date.now());
    if (limitedCases.length === 0) spawnLimitedCase();
    renderLimitedCases();
    localStorage.setItem('casino_limited_cases', JSON.stringify(limitedCases));
  }, 60000);
}

function spawnLimitedCase() {
  const names = ['Neon Surge', 'Void Eclipse', 'Golden Rush', 'Crimson Tide', 'Frost Bite', 'Shadow Drop', 'Star Burst'];
  const icons = ['⚡', '🌑', '🌟', '🔥', '❄️', '🖤', '💫'];
  const idx = Math.floor(Math.random() * names.length);
  const multiplier = 1.5 + Math.random() * 2;
  const price = Math.floor((Math.random() * 9000 + 1000) / 100) * 100;
  const qty = Math.floor(Math.random() * 20) + 5;
  const duration = (Math.random() * 20 + 10) * 60 * 1000;

  const possibleItems = Object.keys(ITEM_CATALOG);
  const items = [];
  for (let i = 0; i < 10; i++) {
    const itId = possibleItems[Math.floor(Math.random() * possibleItems.length)];
    const cat = ITEM_CATALOG[itId];
    const rar = RARITY[cat.rarity];
    items.push({ id: itId, w: Math.max(1, 15 - rar.tier * 2) });
  }

  const lc = {
    id: 'ltd_' + Date.now(),
    name: names[idx] + ' Edition',
    icon: icons[idx],
    price: price,
    items: items,
    remaining: qty,
    total: qty,
    expires: Date.now() + duration,
    valueMult: multiplier
  };
  limitedCases.push(lc);
  localStorage.setItem('casino_limited_cases', JSON.stringify(limitedCases));
  showToast('🌟 NEW LIMITED CASE: ' + lc.name + '!', true);
}

function renderLimitedCases() {
  const container = document.getElementById('limitedCasesContainer');
  if (!container) return;
  if (limitedCases.length === 0) {
    container.innerHTML = '<div style="text-align:center;color:var(--text2);font-size:12px;padding:20px;">No limited cases available right now. Check back soon!</div>';
    return;
  }
  container.innerHTML = limitedCases.map(lc => {
    const remainMin = Math.max(0, Math.ceil((lc.expires - Date.now()) / 60000));
    return `<div style="background:linear-gradient(135deg,rgba(255,215,0,.08),rgba(255,68,68,.05));border:1px solid rgba(255,215,0,.3);border-radius:12px;padding:14px;text-align:center;">
      <div style="font-size:32px;margin-bottom:4px;">${lc.icon}</div>
      <div style="font-weight:700;color:var(--gold);font-size:13px;">${lc.name}</div>
      <div style="font-size:10px;color:var(--text2);margin:4px 0;">Boosted: ${lc.valueMult.toFixed(1)}× value</div>
      <div style="font-size:10px;color:var(--red);margin-bottom:6px;">⏱️ ${remainMin}m left · ${lc.remaining}/${lc.total} remaining</div>
      <button onclick="openLimitedCase('${lc.id}')" class="action-btn primary" style="padding:6px 14px;font-size:12px;${lc.remaining <= 0 ? 'opacity:0.4;pointer-events:none;' : ''}" ${lc.remaining <= 0 ? 'disabled' : ''}>$${lc.price.toLocaleString()}</button>
    </div>`;
  }).join('');
}

function openLimitedCase(lcId) {
  const lc = limitedCases.find(c => c.id === lcId);
  if (!lc || lc.remaining <= 0 || lc.expires < Date.now()) { showToast('Case no longer available!', false); return; }
  if (balance < lc.price) { showToast('Not enough balance!', false); return; }
  balance -= lc.price;
  updateBalDisplay();
  lc.remaining--;
  localStorage.setItem('casino_limited_cases', JSON.stringify(limitedCases));

  const lucky = getLuckBonus();
  let totalW = lc.items.reduce((s, it) => {
    const cat = ITEM_CATALOG[it.id];
    const rar = RARITY[cat.rarity];

    return s + it.w * (rar.tier >= 3 ? lucky : 1);
  }, 0);
  let rng = Math.random() * totalW;
  let wonItem = lc.items[0];
  for (const it of lc.items) {
    const cat = ITEM_CATALOG[it.id];
    const rar = RARITY[cat.rarity];
    rng -= it.w * (rar.tier >= 3 ? lucky : 1);
    if (rng <= 0) { wonItem = it; break; }
  }

  const cat = ITEM_CATALOG[wonItem.id];
  const rar = RARITY[cat.rarity];
  addToInventory(wonItem.id);
  const val = Math.floor(cat.baseValue * lc.valueMult);

  showToast(`${lc.icon} ${cat.icon} ${cat.name} (${rar.label}) — Worth ~$${val.toLocaleString()}!`, true);
  playClickSound();
  renderLimitedCases();
  window._firebaseSave && firebaseSave();
}

let cryptoPortfolio = JSON.parse(localStorage.getItem('casino_crypto')) || {};

let cryptoPrices = {};
let cryptoHistory = {};
let cryptoInterval = null;

const CRYPTO_COINS = [
  { id: 'BTC', name: 'Bitcoin', icon: '₿', basePrice: 45000, volatility: 0.03 },
  { id: 'ETH', name: 'Ethereum', icon: 'Ξ', basePrice: 2800, volatility: 0.04 },
  { id: 'DOGE', name: 'Dogecoin', icon: '🐕', basePrice: 0.15, volatility: 0.08 },
  { id: 'SOL', name: 'Solana', icon: '◎', basePrice: 120, volatility: 0.05 },
  { id: 'PEPE', name: 'PepeCoin', icon: '🐸', basePrice: 0.001, volatility: 0.12 },
  { id: 'ISLAND', name: 'IslandCoin', icon: '🏝️', basePrice: 5.50, volatility: 0.10 },
];

function initCrypto() {
  if (!cryptoInterval) {

    CRYPTO_COINS.forEach(c => {
      if (!cryptoPrices[c.id]) {
        cryptoPrices[c.id] = c.basePrice * (0.8 + Math.random() * 0.4);
      }
      if (!cryptoHistory[c.id]) {
        cryptoHistory[c.id] = [];

        let p = cryptoPrices[c.id];
        for (let i = 0; i < 30; i++) {
          p *= (1 + (Math.random() - 0.5) * c.volatility);
          cryptoHistory[c.id].push(p);
        }
      }
      if (!cryptoPortfolio[c.id]) {
        cryptoPortfolio[c.id] = { amount: 0, avgBuy: 0, totalInvested: 0 };
      }
    });

    cryptoInterval = setInterval(cryptoTick, 3000);
  }
  renderCrypto();
}

function cryptoTick() {
  CRYPTO_COINS.forEach(c => {
    const change = (Math.random() - 0.48) * c.volatility;
    cryptoPrices[c.id] *= (1 + change);
    cryptoPrices[c.id] = Math.max(c.basePrice * 0.01, cryptoPrices[c.id]);
    cryptoHistory[c.id].push(cryptoPrices[c.id]);
    if (cryptoHistory[c.id].length > 60) cryptoHistory[c.id].shift();
  });

  if (document.querySelector('#cryptoPanel.active')) renderCrypto();
}

function renderCrypto() {
  const panel = document.getElementById('cryptoContent');
  if (!panel) return;

  panel.innerHTML = CRYPTO_COINS.map(c => {
    const price = cryptoPrices[c.id] || c.basePrice;
    const hist = cryptoHistory[c.id] || [];
    const prev = hist.length > 1 ? hist[hist.length - 2] : price;
    const change = prev ? ((price - prev) / prev * 100) : 0;
    const isUp = change >= 0;
    const port = cryptoPortfolio[c.id] || { amount: 0, avgBuy: 0, totalInvested: 0 };
    const holdings = port.amount * price;
    const pnl = port.amount > 0 ? holdings - port.totalInvested : 0;

    const sparkline = cryptoSparkline(hist);

    return `<div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:10px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
        <div style="display:flex;align-items:center;gap:8px;">
          <span style="font-size:20px;">${c.icon}</span>
          <div>
            <div style="font-weight:700;color:var(--text);font-size:14px;">${c.name}</div>
            <div style="font-size:10px;color:var(--text2);">${c.id}</div>
          </div>
        </div>
        <div style="text-align:right;">
          <div style="font-family:'Orbitron';font-size:14px;color:var(--text);font-weight:700;">$${cryptoFormatPrice(price)}</div>
          <div style="font-size:11px;color:${isUp ? 'var(--green)' : 'var(--red)'};">${isUp ? '▲' : '▼'} ${Math.abs(change).toFixed(2)}%</div>
        </div>
      </div>

      ${sparkline}

      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;padding-top:8px;border-top:1px solid var(--border);">
        <div style="font-size:11px;color:var(--text2);">Holdings: ${port.amount.toFixed(6)} ${c.id} ($${cryptoFormatPrice(holdings)}) <span style="color:${pnl >= 0 ? 'var(--green)' : 'var(--red)'};">${pnl >= 0 ? '+' : ''}$${cryptoFormatPrice(pnl)}</span></div>
      </div>
      <div style="display:flex;gap:6px;margin-top:8px;">
        <input type="number" id="cryptoAmt_${c.id}" placeholder="$ amount" min="1" value="100" style="flex:1;padding:6px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:12px;">
        <button onclick="cryptoBuy('${c.id}')" class="action-btn primary" style="padding:6px 14px;font-size:11px;">BUY</button>
        <button onclick="cryptoSell('${c.id}')" class="action-btn danger" style="padding:6px 14px;font-size:11px;">SELL</button>
        <button onclick="cryptoSellAll('${c.id}')" class="action-btn secondary" style="padding:6px 10px;font-size:10px;">SELL ALL</button>
      </div>
    </div>`;
  }).join('');
}

function cryptoSparkline(hist) {
  if (hist.length < 2) return '';
  const w = 200, h = 40;
  const min = Math.min(...hist);
  const max = Math.max(...hist);
  const range = max - min || 1;
  const points = hist.map((v, i) => {
    const x = (i / (hist.length - 1)) * w;
    const y = h - ((v - min) / range) * h;
    return `${x},${y}`;
  }).join(' ');
  const isUp = hist[hist.length - 1] >= hist[0];
  const color = isUp ? '#00e676' : '#ff4444';
  return `<svg width="100%" viewBox="0 0 ${w} ${h}" style="display:block;max-height:40px;"><polyline points="${points}" fill="none" stroke="${color}" stroke-width="1.5" /></svg>`;
}

function cryptoFormatPrice(p) {
  if (Math.abs(p) >= 1) return p.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  if (Math.abs(p) >= 0.01) return p.toFixed(4);
  return p.toFixed(8);
}

function cryptoBuy(coinId) {
  const coin = CRYPTO_COINS.find(c => c.id === coinId);
  if (!coin) return;
  const amtInput = document.getElementById('cryptoAmt_' + coinId);
  const dollars = parseFloat(amtInput.value) || 0;
  if (dollars <= 0 || dollars > balance) { showToast('Invalid amount!', false); return; }

  const price = cryptoPrices[coinId];
  const coinAmount = dollars / price;

  balance -= dollars;
  updateBalDisplay();

  const port = cryptoPortfolio[coinId];
  port.totalInvested += dollars;
  port.amount += coinAmount;
  port.avgBuy = port.totalInvested / port.amount;

  localStorage.setItem('casino_crypto', JSON.stringify(cryptoPortfolio));
  playClickSound();
  showToast(`Bought ${coinAmount.toFixed(6)} ${coinId} for $${dollars.toLocaleString()}`, true);
  renderCrypto();
  window._firebaseSave && firebaseSave();
}

function cryptoSell(coinId) {
  const coin = CRYPTO_COINS.find(c => c.id === coinId);
  if (!coin) return;
  const amtInput = document.getElementById('cryptoAmt_' + coinId);
  const dollars = parseFloat(amtInput.value) || 0;
  if (dollars <= 0) { showToast('Enter a valid amount!', false); return; }
  const price = cryptoPrices[coinId];
  const coinAmount = dollars / price;

  const port = cryptoPortfolio[coinId];
  if (!port || port.amount <= 0) { showToast('No ' + coinId + ' to sell!', false); return; }
  if (coinAmount > port.amount) { showToast('Not enough ' + coinId + '!', false); return; }

  const originalAmount = port.amount;
  port.amount -= coinAmount;
  const sellPortion = coinAmount / originalAmount;
  port.totalInvested = Math.max(0, port.totalInvested * (1 - sellPortion));

  balance += dollars;
  updateBalDisplay();

  localStorage.setItem('casino_crypto', JSON.stringify(cryptoPortfolio));
  playClickSound();
  showToast(`Sold ${coinAmount.toFixed(6)} ${coinId} for $${dollars.toLocaleString()}`, true);
  renderCrypto();
  window._firebaseSave && firebaseSave();
}

function cryptoSellAll(coinId) {
  const port = cryptoPortfolio[coinId];
  if (!port || port.amount <= 0) { showToast('No ' + coinId + ' to sell!', false); return; }
  const price = cryptoPrices[coinId];
  const dollars = port.amount * price;

  balance += dollars;
  updateBalDisplay();
  port.amount = 0;
  port.totalInvested = 0;
  port.avgBuy = 0;

  localStorage.setItem('casino_crypto', JSON.stringify(cryptoPortfolio));
  playClickSound();
  showToast(`Sold all ${coinId} for $${Math.floor(dollars).toLocaleString()}`, true);
  renderCrypto();
  window._firebaseSave && firebaseSave();
}

setTimeout(initLimitedCases, 1000);
</script>

<div id="adminAnnounceBanner">
  <div class="announce-inner">
    <div class="announce-icon">📢</div>
    <div class="announce-text" id="announceText">Announcement here</div>
    <button class="announce-close" onclick="dismissAnnouncement()">✕</button>
  </div>
</div>

<div id="adminPollOverlay">
  <div class="poll-box">
    <div class="poll-title">📊 POLL</div>
    <div class="poll-question" id="pollQuestion">Question?</div>
    <div id="pollOptionsContainer"></div>
    <div class="poll-total" id="pollTotalVotes">0 votes</div>
    <button class="poll-close-btn" onclick="closePollOverlay()">CLOSE</button>
  </div>
</div>

<div id="adminAbuseOverlay">
  <div class="abuse-bg"></div>
  <div class="abuse-vignette"></div>
  <div class="abuse-siren abuse-siren-left"></div>
  <div class="abuse-siren abuse-siren-right"></div>
  <div class="abuse-bar"></div>
  <div class="abuse-corner abuse-corner-tl"></div>
  <div class="abuse-corner abuse-corner-tr"></div>
  <div class="abuse-corner abuse-corner-bl"></div>
  <div class="abuse-corner abuse-corner-br"></div>
  <div class="abuse-danger-stripe abuse-danger-top"></div>
  <div class="abuse-danger-stripe abuse-danger-bottom"></div>
  <div class="abuse-particles" id="abuseParticles"></div>
  <div class="abuse-rings" id="abuseRings"></div>
  <div class="abuse-content" id="abuseContent">
    <div class="abuse-glitch-text" id="abuseGlitchText" data-text="ADMIN ABUSE!!!">ADMIN ABUSE!!!</div>
  </div>
</div>

<div id="adminEventOverlay">
  <div class="event-header">
    <div class="event-title" id="eventTitle">🎉 CASINO EVENT</div>
    <div style="display:flex;gap:8px;align-items:center;">
      <span style="font-size:11px;color:var(--text2);" id="eventOnlineCount"></span>
      <button class="event-close-btn" onclick="leaveEvent()">LEAVE</button>
    </div>
  </div>
  <div class="event-body">
    <div class="event-chat-area">
      <div class="event-chat-msgs" id="eventChatMsgs"></div>
      <div class="event-chat-input-wrap">
        <input class="event-chat-input" id="eventChatInput" placeholder="Type in event chat..." maxlength="200" autocomplete="off">
        <button class="event-chat-send" onclick="sendEventChat()">SEND</button>
      </div>
    </div>
    <div class="event-admin-panel" id="eventAdminPanel" style="display:none;">
      <div class="event-admin-title">⚡ ADMIN CONTROLS</div>
      <div class="event-action-btn" onclick="eventAction('abuse')">
        <div class="ea-icon">⚡</div>
        <div><div class="ea-label" style="color:#ff4444;font-weight:900;">ADMIN ABUSE!!!</div><div class="ea-desc">Dramatic fullscreen abuse animation for everyone</div></div>
      </div>
      <div class="event-action-btn" onclick="eventAction('double')">
        <div class="ea-icon">💰</div>
        <div><div class="ea-label">2X Everyone's Money</div><div class="ea-desc">Double all connected players' balance</div></div>
      </div>
      <div class="event-action-btn" onclick="eventAction('rain50')">
        <div class="ea-icon">🌧️</div>
        <div><div class="ea-label">Money Rain $50</div><div class="ea-desc">Give everyone $50</div></div>
      </div>
      <div class="event-action-btn" onclick="eventAction('rain500')">
        <div class="ea-icon">💸</div>
        <div><div class="ea-label">Money Rain $500</div><div class="ea-desc">Give everyone $500</div></div>
      </div>
      <div class="event-action-btn" onclick="eventAction('rain5000')">
        <div class="ea-icon">🤑</div>
        <div><div class="ea-label">Money Rain $5,000</div><div class="ea-desc">Give everyone $5,000</div></div>
      </div>
      <div class="event-action-btn" onclick="eventAction('rain25000')">
        <div class="ea-icon">💎</div>
        <div><div class="ea-label">Money Rain $25K</div><div class="ea-desc">Give everyone $25,000</div></div>
      </div>
      <div class="event-action-btn" onclick="eventAction('rain100000')">
        <div class="ea-icon">👑</div>
        <div><div class="ea-label">Money Rain $100K</div><div class="ea-desc">Give everyone $100,000</div></div>
      </div>
      <div class="event-action-btn" onclick="eventAction('rain1000000')">
        <div class="ea-icon">🏆</div>
        <div><div class="ea-label">Money Rain $1M</div><div class="ea-desc">Give everyone $1,000,000</div></div>
      </div>
      <div class="event-action-btn" onclick="eventAction('rain10000000')">
        <div class="ea-icon">🌟</div>
        <div><div class="ea-label">Money Rain $10M</div><div class="ea-desc">Give everyone $10,000,000</div></div>
      </div>
      <div class="event-action-btn" onclick="eventAction('rain1000000000')">
        <div class="ea-icon">💫</div>
        <div><div class="ea-label" style="color:#ff44ff;">Money Rain $1B</div><div class="ea-desc">Give everyone $1,000,000,000</div></div>
      </div>
      <div class="event-action-btn" onclick="eventAction('rain1000000000000')">
        <div class="ea-icon">🔮</div>
        <div><div class="ea-label" style="color:#ff00ff;">Money Rain $1T</div><div class="ea-desc">Give everyone $1,000,000,000,000</div></div>
      </div>
      <div class="event-action-btn" onclick="eventAction('rain1000000000000000')">
        <div class="ea-icon">🌌</div>
        <div><div class="ea-label" style="color:#aa00ff;font-weight:900;">Money Rain $1Q</div><div class="ea-desc">Give everyone $1,000,000,000,000,000</div></div>
      </div>
      <div class="event-action-btn" onclick="eventAction('jackpot')">
        <div class="ea-icon">🎰</div>
        <div><div class="ea-label" style="color:#ffd700;">Jackpot Wheel</div><div class="ea-desc">Spin — random amount for everyone ($100-$500K)</div></div>
      </div>
      <div class="event-action-btn" onclick="eventAction('coinflip')">
        <div class="ea-icon">🪙</div>
        <div><div class="ea-label" style="color:#ffaa00;">Coin Flip</div><div class="ea-desc">50/50 — everyone doubles or loses half</div></div>
      </div>
      <div class="event-action-btn" onclick="eventAction('tax')">
        <div class="ea-icon">💀</div>
        <div><div class="ea-label" style="color:#ff6666;">Admin Tax 50%</div><div class="ea-desc">Take half of everyone's money</div></div>
      </div>
      <div class="event-action-btn" onclick="eventAction('fakereset1')">
        <div class="ea-icon">☢️</div>
        <div><div class="ea-label" style="color:#ff0000;font-weight:900;">Fake Reset #1</div><div class="ea-desc">Countdown then JK</div></div>
      </div>
      <div class="event-action-btn" onclick="eventAction('fakereset2')">
        <div class="ea-icon">⚠️</div>
        <div><div class="ea-label" style="color:#ff4400;font-weight:900;">Fake Reset #2</div><div class="ea-desc">"OK actually resetting..." then JK</div></div>
      </div>
      <div class="event-action-btn" onclick="eventAction('fakereset3')">
        <div class="ea-icon">🔌</div>
        <div><div class="ea-label" style="color:#ff6600;font-weight:900;">Fake Reset #3</div><div class="ea-desc">"Server maintenance" shutdown prank</div></div>
      </div>
      <div class="event-action-btn" onclick="eventAction('giveprestige')">
        <div class="ea-icon">👑</div>
        <div><div class="ea-label" style="color:#ffd700;font-weight:900;">Give Prestige +1</div><div class="ea-desc">Give everyone +1 prestige level</div></div>
      </div>
      <div class="event-action-btn" onclick="eventAction('announce')">
        <div class="ea-icon">📢</div>
        <div><div class="ea-label">Quick Announce</div><div class="ea-desc">Flash an announcement to everyone</div></div>
      </div>
      <div class="event-action-btn" onclick="eventAction('poll')">
        <div class="ea-icon">📊</div>
        <div><div class="ea-label">Quick Poll</div><div class="ea-desc">Yes/No poll for everyone</div></div>
      </div>
      <div class="event-action-btn" onclick="eventAction('clickchallenge')">
        <div class="ea-icon">🖱️</div>
        <div><div class="ea-label" style="color:#00ffcc;font-weight:900;">Click Challenge</div><div class="ea-desc">150 clicks in 5 sec = 10x money + items + prestige</div></div>
      </div>
      <div class="event-action-btn" onclick="eventAction('endEvent')" style="border-color:rgba(255,50,50,.3);">
        <div class="ea-icon">🚪</div>
        <div><div class="ea-label" style="color:var(--red);">End Event</div><div class="ea-desc">Close event for everyone</div></div>
      </div>
      <div class="event-status" id="eventStatus">Event is live</div>
    </div>
  </div>
</div>

<script>

let _adminListenersActive = false;
let _adminUnsubs = [];
let _eventChatUnsub = null;
let _currentPollId = null;
let _myPollVote = null;
let _pollDismissedId = null;

function adminIsStaff() {
  const n = (window._currentUsername || '').toLowerCase();
  return ['mojheh','terpez','jiddy'].includes(n);
}

async function adminSendAnnouncement() {
  if (!adminIsStaff()) return;
  const msg = document.getElementById('adminAnnounceInput').value.trim();
  if (!msg) { showToast('Type a message!', false); return; }
  await window._fbSet('casino/admin/announcement', {
    text: msg, time: Date.now(), by: window._currentUsername || 'Admin'
  });
  document.getElementById('adminAnnounceInput').value = '';
  showToast('Announcement sent!', true);
}

function showAnnounceBanner(text) {
  const el = document.getElementById('adminAnnounceBanner');
  document.getElementById('announceText').textContent = text;
  el.style.display = 'block';
  el.style.animation = 'none'; el.offsetHeight; el.style.animation = 'announceBannerSlide .5s ease-out';
  clearTimeout(window._announceDismissTimer);
  window._announceDismissTimer = setTimeout(() => dismissAnnouncement(), 15000);
}

function dismissAnnouncement() {
  document.getElementById('adminAnnounceBanner').style.display = 'none';
  clearTimeout(window._announceDismissTimer);
}

function adminAddPollOption() {
  const container = document.getElementById('adminPollOptions');
  if (container.querySelectorAll('.admin-poll-opt').length >= 6) { showToast('Max 6 options!', false); return; }
  const inp = document.createElement('input');
  inp.type = 'text'; inp.className = 'admin-poll-opt';
  inp.placeholder = 'Option ' + (container.querySelectorAll('.admin-poll-opt').length + 1);
  inp.style.cssText = 'width:100%;padding:6px 10px;background:var(--surface);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:11px;margin-bottom:4px;box-sizing:border-box;';
  container.appendChild(inp);
}

async function adminSendPoll() {
  if (!adminIsStaff()) return;
  const q = document.getElementById('adminPollQuestion').value.trim();
  if (!q) { showToast('Enter a question!', false); return; }
  const opts = [];
  document.querySelectorAll('.admin-poll-opt').forEach(inp => {
    const v = inp.value.trim();
    if (v) opts.push(v);
  });
  if (opts.length < 2) { showToast('Need at least 2 options!', false); return; }
  const pollId = Date.now().toString(36);
  await window._fbSet('casino/admin/poll', {
    id: pollId, question: q, options: opts, votes: {}, status: 'active',
    time: Date.now(), by: window._currentUsername || 'Admin'
  });
  showToast('Poll sent!', true);
}

async function adminEndPoll() {
  if (!adminIsStaff()) return;
  await window._fbUpdate('casino/admin/poll', { status: 'ended' });
  showToast('Poll ended!', true);
}

function showPollOverlay(data) {
  if (!data || !data.question || !data.options) return;
  const pollId = data.id || null;
  const overlay = document.getElementById('adminPollOverlay');
  const isAlreadyVisible = overlay.style.display === 'flex';

  if (_pollDismissedId && _pollDismissedId === pollId && !isAlreadyVisible) return;
  _currentPollId = pollId;
  document.getElementById('pollQuestion').textContent = data.question;
  const container = document.getElementById('pollOptionsContainer');
  container.innerHTML = '';

  const votes = data.votes || {};
  const optCounts = data.options.map(() => 0);
  let totalVotes = 0;
  const myUid = window._currentPlayerId || '';
  _myPollVote = null;
  Object.entries(votes).forEach(([uid, optIdx]) => {
    if (typeof optIdx === 'number' && optIdx >= 0 && optIdx < data.options.length) {
      optCounts[optIdx]++;
      totalVotes++;
      if (uid === myUid) _myPollVote = optIdx;
    }
  });

  const isEnded = data.status === 'ended';
  const showResults = isEnded || _myPollVote !== null;

  data.options.forEach((opt, i) => {
    const div = document.createElement('div');
    div.className = 'poll-option' + (showResults ? ' show-results' : '') + (_myPollVote === i ? ' voted' : '');
    const pct = totalVotes > 0 ? Math.round(optCounts[i] / totalVotes * 100) : 0;
    div.innerHTML =
      '<span class="poll-option-text">' + opt + (_myPollVote === i ? ' ✓' : '') + '</span>' +
      '<div class="poll-option-bar"><div class="poll-option-bar-fill" style="width:' + pct + '%"></div></div>' +
      '<span class="poll-option-pct">' + pct + '% (' + optCounts[i] + ')</span>';
    if (!isEnded && _myPollVote === null) {
      div.onclick = () => voteInPoll(i);
      div.style.cursor = 'pointer';
    }
    container.appendChild(div);
  });

  document.getElementById('pollTotalVotes').textContent = totalVotes + ' vote' + (totalVotes !== 1 ? 's' : '') + (isEnded ? ' — POLL ENDED' : '');
  document.getElementById('adminPollOverlay').style.display = 'flex';
}

async function voteInPoll(optIdx) {
  if (_myPollVote !== null) return;
  const uid = window._currentPlayerId;
  if (!uid) return;
  _myPollVote = optIdx;
  await window._fbUpdate('casino/admin/poll/votes', { [uid]: optIdx });
}

function closePollOverlay() {
  _pollDismissedId = _currentPollId;
  document.getElementById('adminPollOverlay').style.display = 'none';
}

async function adminTriggerAbuse() {
  if (!adminIsStaff()) return;
  await window._fbSet('casino/admin/abuse', {
    time: Date.now(), by: window._currentUsername || 'Admin'
  });
  showToast('ADMIN ABUSE sent!', true);
}

function showAdminAbuse() {
  const el = document.getElementById('adminAbuseOverlay');
  const content = document.getElementById('abuseContent');
  const particleContainer = document.getElementById('abuseParticles');
  const ringsContainer = document.getElementById('abuseRings');
  const glitchText = document.getElementById('abuseGlitchText');
  const dangerTop = el.querySelector('.abuse-danger-top');
  const dangerBottom = el.querySelector('.abuse-danger-bottom');

  el.className = '';
  el.style.display = 'flex';
  el.style.opacity = '1';
  particleContainer.innerHTML = '';
  ringsContainer.innerHTML = '';
  glitchText.style.fontSize = '';
  glitchText.style.letterSpacing = '';
  glitchText.textContent = 'ADMIN ABUSE!!!';
  glitchText.setAttribute('data-text', 'ADMIN ABUSE!!!');
  if (dangerTop) dangerTop.style.opacity = '0';
  if (dangerBottom) dangerBottom.style.opacity = '0';

  function spawnParticles(count) {
    const colors = ['#ff0000','#ff4400','#ff6600','#ffd700','#ff0066','#ff00ff','#00ffff'];
    for (let i = 0; i < count; i++) {
      const p = document.createElement('div');
      p.className = 'abuse-particle';
      const size = 3 + Math.random() * 10;
      const angle = Math.random() * Math.PI * 2;
      const dist = 200 + Math.random() * 800;
      p.style.cssText = 'width:' + size + 'px;height:' + size + 'px;left:50%;top:50%;' +
        '--dx:' + (Math.cos(angle) * dist) + 'px;--dy:' + (Math.sin(angle) * dist) + 'px;' +
        'animation-duration:' + (0.8 + Math.random() * 2) + 's;animation-delay:' + (Math.random() * 0.4) + 's;' +
        'background:' + colors[Math.floor(Math.random() * colors.length)] + ';' +
        'box-shadow:0 0 ' + (4 + Math.random() * 8) + 'px currentColor;';
      particleContainer.appendChild(p);
    }
  }

  function spawnRing(color) {
    const ring = document.createElement('div');
    ring.className = 'abuse-ring';
    ring.style.color = color || ['#ff0000','#ff4400','#ff6600','#ff0066'][Math.floor(Math.random()*4)];
    ring.style.borderColor = ring.style.color;
    ringsContainer.appendChild(ring);
    setTimeout(() => ring.remove(), 1500);
  }

  function spawnInvertFlash() {
    const flash = document.createElement('div');
    flash.className = 'abuse-invert-flash';
    el.appendChild(flash);
    setTimeout(() => flash.remove(), 800);
  }

  spawnParticles(70);
  spawnRing('#ff0000');
  setTimeout(() => spawnRing('#ff4400'), 300);
  setTimeout(() => spawnRing('#ff6600'), 600);

  document.body.style.animation = 'abuseViolentShake .4s ease-in-out 4';
  setTimeout(() => { document.body.style.animation = ''; }, 2000);

  content.style.animation = 'none'; content.offsetHeight;
  content.style.animation = 'abuseViolentShake .4s ease-in-out 4';

  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    for (let i = 0; i < 4; i++) {
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.connect(gain); gain.connect(ctx.destination);
      osc.type = 'sawtooth';
      osc.frequency.setValueAtTime(200, ctx.currentTime + i * 0.5);
      osc.frequency.linearRampToValueAtTime(900, ctx.currentTime + i * 0.5 + 0.25);
      osc.frequency.linearRampToValueAtTime(200, ctx.currentTime + i * 0.5 + 0.5);
      gain.gain.setValueAtTime(0.07, ctx.currentTime + i * 0.5);
      gain.gain.linearRampToValueAtTime(0, ctx.currentTime + i * 0.5 + 0.5);
      osc.start(ctx.currentTime + i * 0.5);
      osc.stop(ctx.currentTime + i * 0.5 + 0.5);
    }
    for (let i = 0; i < 8; i++) {
      setTimeout(() => {
        try { playSound(40 + Math.random() * 250, 'square', 0.06, 0.1); } catch(e) {}
      }, i * 120 + 80);
    }
  } catch(e) {}

  setTimeout(() => {
    el.classList.add('abuse-phase-2');

    if (dangerTop) dangerTop.style.opacity = '1';
    if (dangerBottom) dangerBottom.style.opacity = '1';

    spawnParticles(40);
    spawnRing('#0ff');
    setTimeout(() => spawnRing('#f0f'), 500);

    document.body.style.animation = 'abuseViolentShake .3s ease-in-out 3';
    setTimeout(() => { document.body.style.animation = ''; }, 1200);

    try {
      for (let i = 0; i < 4; i++) {
        setTimeout(() => {
          try { playSound(100 + Math.random() * 300, 'sawtooth', 0.04, 0.08); } catch(e) {}
        }, i * 250);
      }
    } catch(e) {}

  }, 1500);

  setTimeout(() => {
    el.classList.add('abuse-phase-3');

    glitchText.style.fontSize = 'clamp(44px, 13vw, 130px)';
    glitchText.style.letterSpacing = 'clamp(6px, 1.5vw, 16px)';

    spawnInvertFlash();
    setTimeout(() => spawnInvertFlash(), 500);

    spawnParticles(100);
    spawnRing('#fff');
    setTimeout(() => spawnRing('#ff0000'), 200);
    setTimeout(() => spawnRing('#ff4400'), 400);
    setTimeout(() => spawnRing('#ff6600'), 600);

    document.body.style.animation = 'abuseViolentShake .3s ease-in-out 5';
    setTimeout(() => { document.body.style.animation = ''; }, 1800);

    try {
      const ctx2 = new (window.AudioContext || window.webkitAudioContext)();
      const osc = ctx2.createOscillator();
      const gain = ctx2.createGain();
      osc.connect(gain); gain.connect(ctx2.destination);
      osc.type = 'sine';
      osc.frequency.setValueAtTime(80, ctx2.currentTime);
      osc.frequency.exponentialRampToValueAtTime(20, ctx2.currentTime + 0.6);
      gain.gain.setValueAtTime(0.15, ctx2.currentTime);
      gain.gain.linearRampToValueAtTime(0, ctx2.currentTime + 1);
      osc.start(); osc.stop(ctx2.currentTime + 1);

      const osc2 = ctx2.createOscillator();
      const gain2 = ctx2.createGain();
      osc2.connect(gain2); gain2.connect(ctx2.destination);
      osc2.type = 'triangle';
      osc2.frequency.setValueAtTime(40, ctx2.currentTime);
      osc2.frequency.linearRampToValueAtTime(15, ctx2.currentTime + 1.2);
      gain2.gain.setValueAtTime(0.1, ctx2.currentTime);
      gain2.gain.linearRampToValueAtTime(0, ctx2.currentTime + 1.2);
      osc2.start(); osc2.stop(ctx2.currentTime + 1.2);
    } catch(e) {}

  }, 3500);

  setTimeout(() => {
    el.classList.add('abuse-fade');
    glitchText.style.fontSize = '';
    glitchText.style.letterSpacing = '';

    spawnParticles(20);
  }, 5500);

  clearTimeout(window._abuseDismissTimer);
  window._abuseDismissTimer = setTimeout(() => closeAdminAbuse(), 7000);
}

function closeAdminAbuse() {
  const el = document.getElementById('adminAbuseOverlay');
  el.style.display = 'none';
  el.className = '';
  el.style.opacity = '';
  document.body.style.animation = '';
  document.getElementById('abuseParticles').innerHTML = '';
  document.getElementById('abuseRings').innerHTML = '';
  var gt = document.getElementById('abuseGlitchText');
  if (gt) { gt.style.fontSize = ''; gt.style.letterSpacing = ''; }
  clearTimeout(window._abuseDismissTimer);
}

function showMoneyRain(amount) {
  const rain = document.createElement('div');
  rain.className = 'money-rain';
  const emojis = ['💵','💰','🤑','💸','💲','🪙','💎'];
  const count = Math.min(80, 40 + Math.floor(amount / 100));
  for (let i = 0; i < count; i++) {
    const bill = document.createElement('div');
    bill.className = 'money-bill';
    bill.textContent = emojis[Math.floor(Math.random() * emojis.length)];
    bill.style.left = (Math.random() * 100) + 'vw';
    bill.style.setProperty('--rot', (360 + Math.random() * 720) + 'deg');
    bill.style.animationDuration = (2 + Math.random() * 3) + 's';
    bill.style.animationDelay = Math.random() * 2 + 's';
    bill.style.fontSize = (18 + Math.random() * 28) + 'px';
    rain.appendChild(bill);
  }
  document.body.appendChild(rain);

  if (amount > 0) {
    const label = document.createElement('div');
    label.className = 'money-rain-label';
    label.textContent = '+$' + amount.toLocaleString();
    document.body.appendChild(label);
    setTimeout(() => { if (label.parentNode) label.remove(); }, 3500);
  }
  setTimeout(() => { if (rain.parentNode) rain.remove(); }, 6000);
}

function showDoubleMoneyAnimation() {
  const overlay = document.createElement('div');
  overlay.className = 'double-money-overlay';
  overlay.innerHTML = '<div class="double-money-text">2X</div><div class="double-money-sub">EVERYONE\'S MONEY DOUBLED</div>';

  for (let i = 0; i < 3; i++) {
    const ring = document.createElement('div');
    ring.className = 'double-ring';
    ring.style.animationDelay = (i * 0.3) + 's';
    overlay.appendChild(ring);
  }
  document.body.appendChild(overlay);

  document.body.style.animation = 'none';
  document.body.offsetHeight;
  try { playSound(600, 'sine', 0.06, 0.3); } catch(e) {}
  setTimeout(() => { if (overlay.parentNode) overlay.remove(); }, 3500);
}

function showResetAnimation() {
  const overlay = document.createElement('div');
  overlay.className = 'reset-overlay';
  overlay.innerHTML = '<div class="reset-text">☢️ BALANCE RESET ☢️</div>';
  document.body.appendChild(overlay);
  try { playSound(100, 'sawtooth', 0.06, 0.5); } catch(e) {}
  setTimeout(() => { if (overlay.parentNode) overlay.remove(); }, 3000);
}

function showFakeResetAnimation(variant) {
  const overlay = document.createElement('div');
  overlay.className = 'fakereset-overlay';

  if (variant === 2) {

    overlay.innerHTML = '<div class="fakereset-title">OK ACTUALLY RESETTING YOUR MONEY</div><div class="fakereset-countdown" id="fakeResetNum">5</div>';
    document.body.appendChild(overlay);
    document.body.style.animation = 'abuseViolentShake 0.3s ease-in-out infinite';
    try { playSound(150, 'sawtooth', 0.06, 0.4); } catch(e) {}
    const numEl = overlay.querySelector('.fakereset-countdown');
    setTimeout(() => { if (numEl) numEl.textContent = '4'; try { playSound(180, 'sawtooth', 0.06, 0.3); } catch(e) {} }, 1000);
    setTimeout(() => { if (numEl) numEl.textContent = '3'; try { playSound(210, 'sawtooth', 0.06, 0.3); } catch(e) {} }, 2000);
    setTimeout(() => { if (numEl) numEl.textContent = '2'; try { playSound(250, 'sawtooth', 0.06, 0.3); } catch(e) {} }, 3000);
    setTimeout(() => { if (numEl) numEl.textContent = '1'; try { playSound(300, 'sawtooth', 0.08, 0.3); } catch(e) {} }, 4000);
    setTimeout(() => {
      overlay.innerHTML = '<div class="fakereset-title" style="color:#ff4444;">DELETING ALL DATA...</div><div class="fakereset-countdown" style="font-size:clamp(20px,5vw,40px);color:#ff6666;">please wait</div>';
      try { playSound(100, 'square', 0.06, 0.5); } catch(e) {}
    }, 5000);
    setTimeout(() => {
      document.body.style.animation = '';
      overlay.innerHTML = '<div class="fakereset-jk">JK</div><div class="fakereset-sub">relax your money is fine</div>';
      overlay.style.background = 'rgba(0,0,0,.92)';
      try { playSound(600, 'sine', 0.05, 0.2); setTimeout(() => playSound(800, 'sine', 0.06, 0.3), 200); } catch(e) {}
    }, 6500);
    setTimeout(() => { if (overlay.parentNode) overlay.remove(); }, 9500);
  } else if (variant === 3) {

    overlay.innerHTML = '<div class="fakereset-title" style="color:#ff8800;">SERVER MAINTENANCE</div><div class="fakereset-countdown" style="font-size:clamp(14px,3.5vw,24px);color:#ffaa44;">Shutting down in...</div>';
    document.body.appendChild(overlay);
    try { playSound(300, 'sine', 0.04, 0.3); } catch(e) {}
    const numEl = overlay.querySelector('.fakereset-countdown');
    setTimeout(() => { if (numEl) numEl.textContent = 'Saving player data...'; try { playSound(250, 'sine', 0.03, 0.2); } catch(e) {} }, 1500);
    setTimeout(() => { if (numEl) numEl.textContent = 'Clearing sessions...'; }, 3000);
    setTimeout(() => {
      overlay.style.background = '#000';
      overlay.innerHTML = '<div class="fakereset-countdown" style="font-size:clamp(16px,4vw,28px);color:#666;">Connection lost.</div>';
      try { playSound(80, 'sine', 0.05, 0.6); } catch(e) {}
    }, 4500);
    setTimeout(() => {
      overlay.innerHTML = '<div class="fakereset-jk">JK</div><div class="fakereset-sub">server is fine, you got pranked</div>';
      overlay.style.background = 'rgba(0,0,0,.92)';
      try { playSound(600, 'sine', 0.05, 0.2); setTimeout(() => playSound(800, 'sine', 0.06, 0.3), 200); } catch(e) {}
    }, 6000);
    setTimeout(() => { if (overlay.parentNode) overlay.remove(); }, 9000);
  } else {

    overlay.innerHTML = '<div class="fakereset-title">RESETTING ALL BALANCES</div><div class="fakereset-countdown" id="fakeResetNum">3</div>';
    document.body.appendChild(overlay);
    try { playSound(200, 'sawtooth', 0.06, 0.3); } catch(e) {}
    const numEl = overlay.querySelector('.fakereset-countdown');
    document.body.style.animation = 'abuseViolentShake 0.3s ease-in-out infinite';
    setTimeout(() => { if (numEl) numEl.textContent = '2'; try { playSound(250, 'sawtooth', 0.06, 0.3); } catch(e) {} }, 1200);
    setTimeout(() => { if (numEl) numEl.textContent = '1'; try { playSound(300, 'sawtooth', 0.06, 0.3); } catch(e) {} }, 2400);
    setTimeout(() => {
      document.body.style.animation = '';
      overlay.innerHTML = '<div class="fakereset-jk">JK</div><div class="fakereset-sub">your money is safe</div>';
      overlay.style.background = 'rgba(0,0,0,.92)';
      try { playSound(600, 'sine', 0.05, 0.2); setTimeout(() => playSound(800, 'sine', 0.06, 0.3), 200); } catch(e) {}
    }, 3600);
    setTimeout(() => { if (overlay.parentNode) overlay.remove(); }, 6500);
  }
}

function showJackpotAnimation(amount) {
  const overlay = document.createElement('div');
  overlay.className = 'jackpot-overlay';
  overlay.innerHTML = '<div class="jackpot-wheel"></div><div class="jackpot-result">+$' + amount.toLocaleString() + '</div><div class="jackpot-label">JACKPOT!</div>';
  document.body.appendChild(overlay);
  try { playSound(400, 'sine', 0.05, 0.2); setTimeout(() => playSound(600, 'sine', 0.05, 0.2), 200); setTimeout(() => playSound(800, 'sine', 0.06, 0.3), 2800); } catch(e) {}
  setTimeout(() => showMoneyRain(amount), 3000);
  setTimeout(() => { if (overlay.parentNode) overlay.remove(); }, 6500);
}

function showCoinFlipAnimation(win) {
  const overlay = document.createElement('div');
  overlay.className = 'coinflip-overlay';
  overlay.innerHTML = '<div class="coinflip-coin">' + (win ? '👑' : '💀') + '</div>' +
    '<div class="coinflip-result" style="color:' + (win ? '#00ff88' : '#ff4444') + ';">' +
    (win ? '2X DOUBLED!' : '-50% HALVED!') + '</div>';
  document.body.appendChild(overlay);
  try { if (win) { setTimeout(() => playSound(800, 'sine', 0.06, 0.3), 3000); } else { setTimeout(() => playSound(150, 'sawtooth', 0.06, 0.4), 3000); } } catch(e) {}
  if (win) setTimeout(() => showMoneyRain(balance), 3200);
  setTimeout(() => { if (overlay.parentNode) overlay.remove(); }, 6500);
}

function showTaxAnimation(taxed) {
  const overlay = document.createElement('div');
  overlay.className = 'tax-overlay';
  overlay.innerHTML = '<div class="tax-text">\u{1F480} TAXED</div><div class="tax-sub">-$' + taxed.toLocaleString() + '</div>';
  document.body.appendChild(overlay);
  try { playSound(100, 'sawtooth', 0.05, 0.4); } catch(e) {}
  setTimeout(() => { if (overlay.parentNode) overlay.remove(); }, 3500);
}

function showClickChallenge(isAdmin) {
  if (document.querySelector('.clickchallenge-overlay')) return;
  const overlay = document.createElement('div');
  overlay.className = 'clickchallenge-overlay';
  let clickCount = 0;
  let phase = 'countdown';
  let countdownVal = 3;
  const TARGET = 150;
  const TIME_LIMIT = 5000;

  function renderCountdown() {
    overlay.innerHTML = '<div class="cc-explain">🖱️ <strong>CLICK CHALLENGE</strong> 🖱️</div>' +
      '<div class="cc-explain">Get <strong>' + TARGET + ' clicks</strong> in <strong>5 seconds</strong></div>' +
      '<div class="cc-explain">Win: <strong>10x Money</strong> + <strong>Legendary Items</strong> + <strong>+1 Prestige</strong></div>' +
      '<div class="cc-countdown-num">' + countdownVal + '</div>' +
      '<div class="cc-explain" style="margin-top:16px;opacity:.6">Get ready...</div>';
  }
  renderCountdown();
  document.body.appendChild(overlay);

  try { playSound(400, 'sine', 0.04, 0.2); } catch(e) {}

  const cdInterval = setInterval(() => {
    countdownVal--;
    if (countdownVal > 0) {
      renderCountdown();
      try { playSound(400, 'sine', 0.04, 0.2); } catch(e) {}
    } else {
      clearInterval(cdInterval);
      try { playSound(800, 'sine', 0.06, 0.3); } catch(e) {}
      startClickPhase();
    }
  }, 1000);

  function startClickPhase() {
    phase = 'clicking';
    const startTime = Date.now();
    let timerRaf;

    // Build DOM once — only update values each frame
    overlay.innerHTML = '<div class="cc-timer-text" id="ccTimerText">\u23F1\uFE0F 5.00s</div>' +
      '<div class="cc-timer-bar"><div class="cc-timer-fill" id="ccTimerFill" style="width:100%"></div></div>' +
      '<div class="cc-click-area" id="ccClickArea">' +
        '<div class="cc-click-count" id="ccClickCount" style="color:#00ffcc">0</div>' +
        '<div class="cc-click-label">CLICKS</div>' +
      '</div>' +
      '<div class="cc-target" id="ccTargetText">TARGET: ' + TARGET + ' clicks | 0%</div>' +
      '<div style="width:80%;max-width:400px;height:8px;border-radius:4px;background:rgba(255,255,255,.1);margin-top:8px;overflow:hidden;">' +
        '<div id="ccProgressFill" style="height:100%;border-radius:4px;background:#00ffcc;width:0%;transition:width .05s;"></div>' +
      '</div>';

    const timerTextEl = document.getElementById('ccTimerText');
    const timerFillEl = document.getElementById('ccTimerFill');
    const clickCountEl = document.getElementById('ccClickCount');
    const targetTextEl = document.getElementById('ccTargetText');
    const progressFillEl = document.getElementById('ccProgressFill');
    const area = document.getElementById('ccClickArea');

    function updateDisplay() {
      const elapsed = Date.now() - startTime;
      const remaining = Math.max(0, TIME_LIMIT - elapsed);
      const pct = (remaining / TIME_LIMIT) * 100;
      const secs = (remaining / 1000).toFixed(2);
      const progress = Math.min(100, (clickCount / TARGET) * 100);
      const progressColor = progress >= 100 ? '#00ff88' : (progress >= 60 ? '#ffd700' : '#00ffcc');
      timerTextEl.textContent = '\u23F1\uFE0F ' + secs + 's';
      timerFillEl.style.width = pct + '%';
      clickCountEl.textContent = clickCount;
      clickCountEl.style.color = progressColor;
      targetTextEl.textContent = 'TARGET: ' + TARGET + ' clicks | ' + Math.round(progress) + '%';
      progressFillEl.style.width = progress + '%';
      progressFillEl.style.background = progressColor;
    }

    // Bind click handler once — no rebinding needed
    area.onpointerdown = function(e) {
      e.preventDefault();
      if (phase !== 'clicking') return;
      clickCount++;
      try { playSound(600 + Math.random() * 400, 'square', 0.02, 0.05); } catch(e2) {}
      const ripple = document.createElement('div');
      ripple.className = 'cc-ripple';
      ripple.style.left = (e.offsetX || area.offsetWidth/2) + 'px';
      ripple.style.top = (e.offsetY || area.offsetHeight/2) + 'px';
      area.appendChild(ripple);
      setTimeout(() => ripple.remove(), 600);
      updateDisplay();
      if (clickCount >= TARGET) {
        phase = 'won';
        cancelAnimationFrame(timerRaf);
        showClickWin();
      }
    };

    function tickTimer() {
      if (phase !== 'clicking') return;
      const elapsed = Date.now() - startTime;
      if (elapsed >= TIME_LIMIT) {
        phase = 'lost';
        showClickLose();
        return;
      }
      updateDisplay();
      timerRaf = requestAnimationFrame(tickTimer);
    }
    timerRaf = requestAnimationFrame(tickTimer);
  }

  function showClickWin() {
    const prevBal = balance;
    const reward = balance * 9;
    balance += reward;
    updateBalDisplay();
    prestigeLevel += 1;
    if (window._loadPrestige) window._loadPrestige(prestigeLevel);
    const rewardItems = ['infinityGem','etherealCrown','dragonheart','starforgedBlade','voidShard'];
    rewardItems.forEach(id => { if (typeof addToInventory === 'function') addToInventory(id); });
    firebaseSaveNow();
    renderPrestige();

    const particlesDiv = document.createElement('div');
    particlesDiv.className = 'cc-win-particles';
    for (let i = 0; i < 80; i++) {
      const p = document.createElement('div');
      p.className = 'cc-win-particle';
      const colors = ['#00ffcc','#ffd700','#ff44aa','#00ccff','#ff6600','#aa44ff','#00ff88'];
      p.style.background = colors[Math.floor(Math.random() * colors.length)];
      p.style.left = '50%';
      p.style.top = '50%';
      p.style.setProperty('--dx', (Math.random() - 0.5) * 800 + 'px');
      p.style.setProperty('--dy', (Math.random() - 0.5) * 800 + 'px');
      p.style.animationDelay = (Math.random() * 0.5) + 's';
      p.style.width = (4 + Math.random() * 8) + 'px';
      p.style.height = p.style.width;
      particlesDiv.appendChild(p);
    }
    document.body.appendChild(particlesDiv);

    overlay.innerHTML = '<div style="animation:ccWinExplode .6s cubic-bezier(.2,.8,.2,1) both;text-align:center;">' +
      '<div style="font-size:clamp(60px,18vw,140px);filter:drop-shadow(0 0 40px rgba(0,255,204,.8));animation:ccWinShine 1s ease-in-out infinite;">🏆</div>' +
      '<div style="font-family:Orbitron;font-size:clamp(28px,8vw,64px);font-weight:900;color:#00ffcc;text-shadow:0 0 40px rgba(0,255,204,.6),0 0 80px rgba(0,255,204,.3);margin-top:12px;">CHALLENGE COMPLETE!</div>' +
      '<div style="font-family:Orbitron;font-size:clamp(14px,3.5vw,28px);font-weight:700;margin-top:16px;animation:ccRainbow 2s linear infinite;">💰 10x MONEY = +$' + reward.toLocaleString() + '</div>' +
      '<div style="font-family:Orbitron;font-size:clamp(12px,3vw,22px);color:#ffd700;margin-top:10px;">💎 5 Legendary Items Added!</div>' +
      '<div style="font-family:Orbitron;font-size:clamp(12px,3vw,22px);color:#ffd700;margin-top:6px;">👑 Prestige +1 → P' + prestigeLevel + '</div>' +
      '<div style="font-family:Orbitron;font-size:clamp(10px,2vw,14px);color:rgba(255,255,255,.5);margin-top:20px;letter-spacing:2px;">' + clickCount + ' clicks in 5 seconds!</div>' +
    '</div>';

    try {
      playSound(523, 'sine', 0.06, 0.2);
      setTimeout(() => playSound(659, 'sine', 0.06, 0.2), 100);
      setTimeout(() => playSound(784, 'sine', 0.06, 0.2), 200);
      setTimeout(() => playSound(1047, 'sine', 0.08, 0.4), 350);
    } catch(e) {}
    setTimeout(() => {
      if (overlay.parentNode) overlay.remove();
      if (particlesDiv.parentNode) particlesDiv.remove();
    }, 6000);
  }

  function showClickLose() {
    overlay.innerHTML = '<div style="animation:ccLoseFade .5s ease-out both;text-align:center;">' +
      '<div style="font-size:clamp(60px,15vw,120px);opacity:.6;">😔</div>' +
      '<div style="font-family:Orbitron;font-size:clamp(20px,6vw,44px);font-weight:900;color:#ff4444;text-shadow:0 0 30px rgba(255,68,68,.4);margin-top:12px;">CHALLENGE FAILED</div>' +
      '<div style="font-family:Orbitron;font-size:clamp(12px,3vw,20px);color:rgba(255,255,255,.6);margin-top:12px;">' + clickCount + ' / ' + TARGET + ' clicks</div>' +
      '<div style="font-family:Orbitron;font-size:clamp(10px,2vw,14px);color:rgba(255,255,255,.3);margin-top:16px;letter-spacing:2px;">Better luck next time...</div>' +
    '</div>';
    try { playSound(200, 'sawtooth', 0.04, 0.3); } catch(e) {}
    setTimeout(() => { if (overlay.parentNode) overlay.remove(); }, 4000);
  }
}

function showPrestigeAnimation(level) {
  const overlay = document.createElement('div');
  overlay.className = 'prestige-anim-overlay';
  const names = ['Bronze','Silver','Gold','Diamond','Legendary'];
  const name = level <= names.length ? names[level - 1] : 'P' + level;
  overlay.innerHTML = '<div class="prestige-anim-crown">\u{1F451}</div>' +
    '<div class="prestige-anim-text">PRESTIGE UP</div>' +
    '<div class="prestige-anim-level">' + name.toUpperCase() + ' (P' + level + ')</div>';
  document.body.appendChild(overlay);
  try {
    playSound(500, 'sine', 0.05, 0.15);
    setTimeout(() => playSound(700, 'sine', 0.05, 0.15), 150);
    setTimeout(() => playSound(900, 'sine', 0.06, 0.2), 300);
    setTimeout(() => playSound(1200, 'sine', 0.06, 0.3), 500);
  } catch(e) {}
  setTimeout(() => { if (overlay.parentNode) overlay.remove(); }, 4500);
}

async function adminDoubleAll() {
  if (!adminIsStaff()) return;
  if ((window._currentUsername||'').toLowerCase()==='jiddy'){showToast('No access to abuse actions!',false);return;}
  if (!confirm('Double EVERYONE\'s money?')) return;
  await window._fbSet('casino/admin/action', {
    type: 'double', time: Date.now(), by: window._currentUsername || 'Admin'
  });
  balance *= 2; updateBalDisplay(); firebaseSaveNow();
  showDoubleMoneyAnimation();
  showMoneyRain(balance);
  showToast('Doubled everyone\'s money!', true);
}

async function adminRainMoney(amt) {
  if (!adminIsStaff()) return;
  if ((window._currentUsername||'').toLowerCase()==='jiddy'){showToast('No access to abuse actions!',false);return;}
  await window._fbSet('casino/admin/action', {
    type: 'rain', amount: amt, time: Date.now(), by: window._currentUsername || 'Admin'
  });
  balance += amt; updateBalDisplay(); firebaseSaveNow();
  showMoneyRain(amt);
}

async function adminResetAll() {
  if (!adminIsStaff()) return;
  if ((window._currentUsername||'').toLowerCase()==='jiddy'){showToast('No access to abuse actions!',false);return;}
  if (!confirm('RESET everyone\'s balance to $1000? This cannot be undone!')) return;
  if (!confirm('Are you REALLY sure?')) return;

  await window._fbSet('casino/admin/action', {
    type: 'reset', time: Date.now(), by: window._currentUsername || 'Admin'
  });

  balance = 1000; _balMark(); updateBalDisplay(); firebaseSaveNow();
  showResetAnimation();
  showToast('Resetting ALL players (online + offline)...', true);

  try {
    const allPlayers = await window._fbGet('casino/players');
    const players = allPlayers.val();
    if (players) {
      const updates = {};
      Object.keys(players).forEach(uid => {
        updates['players/' + uid + '/balance'] = 1000;
      });
      await window._fbUpdate('casino', updates);
    }

    showToast('All ' + (players ? Object.keys(players).length : 0) + ' players reset to $1,000!', true);
  } catch(e) {
    console.error('Reset all failed:', e);
    showToast('Reset sent to online players. Some offline players may not be reset.', false);
  }
}

async function adminClearChat() {
  if (!adminIsStaff()) return;
  if ((window._currentUsername||'').toLowerCase()==='jiddy'){showToast('No access to abuse actions!',false);return;}
  await window._fbRemove('casino/chat');
  showToast('Chat cleared!', true);
}

async function adminResetPlayer(fullWipe) {
  if (!adminIsStaff()) return;
  const nameInput = document.getElementById('adminResetPlayerName');
  const resultEl = document.getElementById('adminResetPlayerResult');
  const targetName = (nameInput.value || '').trim().toLowerCase();
  if (!targetName) { resultEl.innerHTML = '<span style="color:var(--red);">Enter a username!</span>'; return; }
  const action = fullWipe ? 'FULL WIPE (balance, stats, inventory, achievements)' : 'RESET BALANCE to $1,000';
  if (!confirm('Are you sure you want to ' + action + ' for "' + targetName + '"?')) return;
  resultEl.innerHTML = '<span style="color:var(--gold);">Searching for ' + targetName + '...</span>';
  try {
    const snap = await window._fbGet('casino/players');
    if (!snap.exists()) { resultEl.innerHTML = '<span style="color:var(--red);">No players found.</span>'; return; }
    const players = snap.val();
    let foundUid = null;
    Object.entries(players).forEach(([uid, p]) => {
      if (p.username && p.username.toLowerCase() === targetName) foundUid = uid;
    });
    if (!foundUid) { resultEl.innerHTML = '<span style="color:var(--red);">Player "' + targetName + '" not found!</span>'; return; }
    const updates = {};
    updates['players/' + foundUid + '/balance'] = 1000;
    if (fullWipe) {
      updates['players/' + foundUid + '/stats'] = { totalWagered: 0, totalWon: 0, totalProfit: 0, gamesPlayed: 0, biggestWin: 0 };
      updates['players/' + foundUid + '/gameStats'] = null;
      updates['players/' + foundUid + '/inventory'] = null;
      updates['players/' + foundUid + '/achievements'] = null;
      updates['players/' + foundUid + '/prestige'] = null;
    }
    await window._fbUpdate('casino', updates);

    const lbSnap = await window._fbGet('casino/leaderboards');
    if (lbSnap.exists()) {
      const lbs = lbSnap.val();
      const lbUpdates = {};
      Object.keys(lbs).forEach(cat => {
        if (lbs[cat] && lbs[cat][foundUid]) {
          lbUpdates['leaderboards/' + cat + '/' + foundUid] = null;
        }
      });
      if (Object.keys(lbUpdates).length > 0) await window._fbUpdate('casino', lbUpdates);
    }

    await window._fbSet('casino/admin/playerReset/' + foundUid, {
      balance: 1000, fullWipe: !!fullWipe, time: Date.now(), by: window._currentUsername
    });
    nameInput.value = '';
    const msg = fullWipe ? 'FULL WIPED' : 'Balance reset to $1,000';
    resultEl.innerHTML = '<span style="color:var(--green);">✅ ' + targetName + ' — ' + msg + ' + removed from leaderboards</span>';
    showToast('🎯 ' + targetName + ' has been ' + (fullWipe ? 'fully wiped' : 'reset') + '!', true);
  } catch(e) {
    console.error('Reset player failed:', e);
    resultEl.innerHTML = '<span style="color:var(--red);">Error: ' + e.message + '</span>';
  }
}

let _eventActive = false;
let _lastActionTime = 0;

async function adminStartEvent() {
  if (!adminIsStaff()) return;
  const n = (window._currentUsername || '').toLowerCase();
  if (n === 'jiddy') { showToast('You don\'t have access to admin abuse events!', false); return; }
  const title = prompt('Event name:', 'ADMIN ABUSE EVENT');
  if (title === null) return;
  const eventTitle = title.trim() || 'ADMIN ABUSE EVENT';
  await window._fbRemove('casino/admin/eventChat');
  await window._fbSet('casino/admin/event', {
    title: eventTitle, status: 'active', time: Date.now(),
    by: window._currentUsername || 'Admin'
  });

  await window._fbSet('casino/admin/abuse', {
    time: Date.now(), by: window._currentUsername || 'Admin'
  });
  showToast('Event started!', true);
}

function showEventOverlay(data) {
  if (!data || data.status !== 'active') {
    hideEventOverlay();
    return;
  }
  _eventActive = true;
  document.getElementById('eventTitle').textContent = '⚡ ' + (data.title || 'CASINO EVENT');
  document.getElementById('adminEventOverlay').style.display = 'flex';
  document.getElementById('eventAdminPanel').style.display = adminIsStaff() && (window._currentUsername||'').toLowerCase() !== 'jiddy' ? 'flex' : 'none';
  document.getElementById('eventStatus').textContent = 'Event is live — started by ' + (data.by || 'Admin');
  if (!_eventChatUnsub) {
    _eventChatUnsub = window._fbOnValueLimited('casino/admin/eventChat', 50, snap => {
      renderEventChat(snap.val());
    });
  }
  if (window._currentPlayerId) {
    window._fbSet('casino/admin/eventPresence/' + window._currentPlayerId, {
      name: window._currentUsername || 'anon', time: Date.now()
    });
  }
  const chatInput = document.getElementById('eventChatInput');
  chatInput.onkeydown = (e) => { if (e.key === 'Enter') sendEventChat(); };
}

function hideEventOverlay() {
  _eventActive = false;
  document.getElementById('adminEventOverlay').style.display = 'none';
  if (_eventChatUnsub) { _eventChatUnsub(); _eventChatUnsub = null; }
  if (window._currentPlayerId) {
    window._fbRemove('casino/admin/eventPresence/' + window._currentPlayerId).catch(()=>{});
  }
}

function leaveEvent() { hideEventOverlay(); }

function renderEventChat(msgs) {
  const container = document.getElementById('eventChatMsgs');
  if (!msgs) { container.innerHTML = '<div style="color:var(--text2);text-align:center;padding:40px;font-size:13px;">No messages yet. Say something!</div>'; return; }
  const entries = Object.values(msgs).sort((a, b) => a.time - b.time);
  const wasAtBottom = container.scrollHeight - container.scrollTop - container.clientHeight < 50;
  container.innerHTML = '';
  entries.forEach(m => {
    const div = document.createElement('div');
    div.className = 'event-chat-msg' + (m.isSystem ? ' system-msg' : m.isAdmin ? ' admin-msg' : '');
    const t = new Date(m.time);
    const timeStr = t.getHours().toString().padStart(2,'0') + ':' + t.getMinutes().toString().padStart(2,'0');
    div.innerHTML =
      '<div style="flex:1;"><span class="ecm-user" style="color:' + (m.isSystem ? 'var(--neon)' : m.isAdmin ? 'var(--gold)' : '#88aaff') + ';">' +
      (m.isSystem ? '🔔 ' : m.isAdmin ? '👑 ' : '') + escapeHtml(m.user || 'anon') +
      '</span> <span class="ecm-time">' + timeStr + '</span>' +
      '<div class="ecm-text" style="' + (m.isSystem ? 'color:var(--neon);font-weight:700;' : '') + '">' +
      escapeHtml(m.text || '') + '</div></div>';
    container.appendChild(div);
  });
  if (wasAtBottom) container.scrollTop = container.scrollHeight;
}

function escapeHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

async function sendEventChat() {
  const input = document.getElementById('eventChatInput');
  const text = input.value.trim();
  if (!text) return;
  input.value = '';
  const isAdmin = adminIsStaff();
  const msgKey = Date.now().toString(36) + Math.random().toString(36).slice(2, 6);
  await window._fbSet('casino/admin/eventChat/' + msgKey, {
    user: window._currentUsername || 'anon',
    text: text,
    time: Date.now(),
    isAdmin: isAdmin,
    isSystem: false
  });
}

async function eventAction(type) {
  if (!adminIsStaff()) return;
  const _evtName = (window._currentUsername || '').toLowerCase();
  if (_evtName === 'jiddy') { showToast('You don\'t have access to event actions!', false); return; }
  const now = Date.now();
  if (now - _lastActionTime < 2000) { showToast('Cooldown!', false); return; }
  _lastActionTime = now;

  if (type === 'double') {
    await window._fbSet('casino/admin/action', { type: 'double', time: now, by: window._currentUsername });
    balance *= 2; updateBalDisplay(); firebaseSaveNow();
    showDoubleMoneyAnimation();
    showMoneyRain(balance);
    const mk = now.toString(36) + 'sys';
    await window._fbSet('casino/admin/eventChat/' + mk, {
      user: 'SYSTEM', text: '💰 ' + (window._currentUsername || 'Admin') + ' DOUBLED everyone\'s money!',
      time: now, isAdmin: true, isSystem: true
    });
  }
  else if (type.startsWith('rain')) {
    const rainAmounts = {rain50:50,rain500:500,rain5000:5000,rain25000:25000,rain100000:100000,rain1000000:1000000,rain10000000:10000000,rain1000000000:1000000000,rain1000000000000:1000000000000,rain1000000000000000:1000000000000000};
    const amt = rainAmounts[type] || 50;
    await window._fbSet('casino/admin/action', { type: 'rain', amount: amt, time: now, by: window._currentUsername });
    balance += amt; updateBalDisplay(); firebaseSaveNow();
    showMoneyRain(amt);
    const mk = now.toString(36) + 'sys';
    await window._fbSet('casino/admin/eventChat/' + mk, {
      user: 'SYSTEM', text: '\u{1F327}\uFE0F ' + (window._currentUsername || 'Admin') + ' made it rain $' + amt.toLocaleString() + '!',
      time: now, isAdmin: true, isSystem: true
    });
  }
  else if (type === 'jackpot') {
    const amounts = [100,500,1000,5000,10000,25000,50000,100000,250000,500000];
    const jackpotAmt = amounts[Math.floor(Math.random() * amounts.length)];
    await window._fbSet('casino/admin/action', { type: 'jackpot', amount: jackpotAmt, time: now, by: window._currentUsername });
    balance += jackpotAmt; updateBalDisplay(); firebaseSaveNow();
    showJackpotAnimation(jackpotAmt);
    const mk = now.toString(36) + 'sys';
    await window._fbSet('casino/admin/eventChat/' + mk, {
      user: 'SYSTEM', text: '\u{1F3B0} JACKPOT! ' + (window._currentUsername || 'Admin') + ' spun the wheel \u2014 everyone gets $' + jackpotAmt.toLocaleString() + '!',
      time: now, isAdmin: true, isSystem: true
    });
  }
  else if (type === 'coinflip') {
    const win = Math.random() < 0.5;
    await window._fbSet('casino/admin/action', { type: 'coinflip', win: win, time: now, by: window._currentUsername });
    if (win) { balance *= 2; } else { balance = Math.floor(balance / 2); }
    updateBalDisplay(); firebaseSaveNow();
    showCoinFlipAnimation(win);
    const mk = now.toString(36) + 'sys';
    await window._fbSet('casino/admin/eventChat/' + mk, {
      user: 'SYSTEM', text: '\u{1FA99} COIN FLIP: ' + (win ? '\u2705 HEADS! Everyone DOUBLED!' : '\u274C TAILS! Everyone lost half!'),
      time: now, isAdmin: true, isSystem: true
    });
  }
  else if (type === 'tax') {
    await window._fbSet('casino/admin/action', { type: 'tax', time: now, by: window._currentUsername });
    const taxed = Math.floor(balance / 2);
    balance = Math.floor(balance / 2); updateBalDisplay(); firebaseSaveNow();
    showTaxAnimation(taxed);
    const mk = now.toString(36) + 'sys';
    await window._fbSet('casino/admin/eventChat/' + mk, {
      user: 'SYSTEM', text: '\u{1F480} ADMIN TAX! ' + (window._currentUsername || 'Admin') + ' took 50% of everyone\'s money!',
      time: now, isAdmin: true, isSystem: true
    });
  }
  else if (type === 'abuse') {
    await window._fbSet('casino/admin/abuse', { time: now, by: window._currentUsername });
    const mk = now.toString(36) + 'sys';
    await window._fbSet('casino/admin/eventChat/' + mk, {
      user: 'SYSTEM', text: '⚡ ADMIN ABUSE!!! ⚡',
      time: now, isAdmin: true, isSystem: true
    });
  }
  else if (type === 'fakereset1') {
    await window._fbSet('casino/admin/action', { type: 'fakereset', variant: 1, time: now, by: window._currentUsername });
    showFakeResetAnimation(1);
    const mk = now.toString(36) + 'sys';
    await window._fbSet('casino/admin/eventChat/' + mk, {
      user: 'SYSTEM', text: '☢️ Resetting all balances...',
      time: now, isAdmin: true, isSystem: true
    });
  }
  else if (type === 'fakereset2') {
    await window._fbSet('casino/admin/action', { type: 'fakereset', variant: 2, time: now, by: window._currentUsername });
    showFakeResetAnimation(2);
    const mk = now.toString(36) + 'sys';
    await window._fbSet('casino/admin/eventChat/' + mk, {
      user: 'SYSTEM', text: '⚠️ OK actually resetting everyone\'s money this time...',
      time: now, isAdmin: true, isSystem: true
    });
  }
  else if (type === 'fakereset3') {
    await window._fbSet('casino/admin/action', { type: 'fakereset', variant: 3, time: now, by: window._currentUsername });
    showFakeResetAnimation(3);
    const mk = now.toString(36) + 'sys';
    await window._fbSet('casino/admin/eventChat/' + mk, {
      user: 'SYSTEM', text: '🔌 Server going down for maintenance...',
      time: now, isAdmin: true, isSystem: true
    });
  }
  else if (type === 'giveprestige') {
    await window._fbSet('casino/admin/action', { type: 'giveprestige', time: now, by: window._currentUsername });
    prestigeLevel += 1;
    if (window._loadPrestige) window._loadPrestige(prestigeLevel);
    firebaseSaveNow();
    renderPrestige();
    showPrestigeAnimation(prestigeLevel);
    showToast('Prestige +1! Now P' + prestigeLevel, true);
    const mk = now.toString(36) + 'sys';
    await window._fbSet('casino/admin/eventChat/' + mk, {
      user: 'SYSTEM', text: '👑 ' + (window._currentUsername || 'Admin') + ' gave everyone +1 prestige!',
      time: now, isAdmin: true, isSystem: true
    });
  }
  else if (type === 'clickchallenge') {
    await window._fbSet('casino/admin/action', { type: 'clickchallenge', time: now, by: window._currentUsername });
    showClickChallenge(true);
    const mk = now.toString(36) + 'sys';
    await window._fbSet('casino/admin/eventChat/' + mk, {
      user: 'SYSTEM', text: '🖱️ CLICK CHALLENGE STARTED! 150 clicks in 5 seconds for 10x money + items + prestige!',
      time: now, isAdmin: true, isSystem: true
    });
  }
  else if (type === 'announce') {
    const msg = prompt('Announcement:');
    if (!msg) return;
    await window._fbSet('casino/admin/announcement', { text: msg, time: now, by: window._currentUsername });
    const mk = now.toString(36) + 'sys';
    await window._fbSet('casino/admin/eventChat/' + mk, {
      user: 'SYSTEM', text: '📢 ' + msg,
      time: now, isAdmin: true, isSystem: true
    });
  }
  else if (type === 'poll') {
    const q = prompt('Quick poll question:', 'Who wants free money?');
    if (!q) return;
    const pollId = now.toString(36);
    await window._fbSet('casino/admin/poll', {
      id: pollId, question: q, options: ['Yes','No'], votes: {}, status: 'active', time: now, by: window._currentUsername
    });
    const mk = now.toString(36) + 'sys';
    await window._fbSet('casino/admin/eventChat/' + mk, {
      user: 'SYSTEM', text: '📊 Poll started: ' + q,
      time: now, isAdmin: true, isSystem: true
    });
  }
  else if (type === 'endEvent') {
    if (!confirm('End the event for everyone?')) return;

    hideEventOverlay();
    const mk = now.toString(36) + 'sys';
    await window._fbSet('casino/admin/eventChat/' + mk, {
      user: 'SYSTEM', text: '🚪 Event ended by ' + (window._currentUsername || 'Admin'),
      time: now, isAdmin: true, isSystem: true
    });
    setTimeout(async () => {

      await window._fbRemove('casino/admin/event').catch(()=>{});
      await window._fbRemove('casino/admin/eventPresence').catch(()=>{});
      await window._fbRemove('casino/admin/eventChat').catch(()=>{});

      await window._fbRemove('casino/admin/poll').catch(()=>{});
      await window._fbRemove('casino/admin/announcement').catch(()=>{});
      await window._fbRemove('casino/admin/action').catch(()=>{});
      await window._fbRemove('casino/admin/abuse').catch(()=>{});
    }, 1500);
  }
}

function startAdminListeners() {
  if (_adminListenersActive) return;
  _adminListenersActive = true;

  const _listenerStartTime = Date.now();
  let _firstAnnounceFire = true;
  let _firstPollFire = true;

  _adminUnsubs.push(window._fbOnValue('casino/admin/announcement', snap => {
    const d = snap.val();
    if (!d || !d.text) return;

    if (_firstAnnounceFire) { _firstAnnounceFire = false; return; }

    if (Date.now() - d.time < 30000) {
      showAnnounceBanner(d.text);
    }
  }));

  let _lastPollId = null;
  _adminUnsubs.push(window._fbOnValue('casino/admin/poll', snap => {
    const d = snap.val();
    if (!d || !d.question) return;

    if (_firstPollFire) {
      _firstPollFire = false;

      if (!d.time || d.time < _listenerStartTime - 5000) return;
    }
    if (!d.time || Date.now() - d.time > 300000) return;
    if (d.status === 'active') {
      showPollOverlay(d);
      _lastPollId = d.id;
    } else if (d.status === 'ended' && d.id === _lastPollId) {
      showPollOverlay(d);
    }
  }));

  let _lastAbuseTime = 0;
  let _firstAbuseFire = true;
  _adminUnsubs.push(window._fbOnValue('casino/admin/abuse', snap => {
    const d = snap.val();
    if (!d || !d.time) return;

    if (_firstAbuseFire) { _firstAbuseFire = false; _lastAbuseTime = d.time; return; }
    if (d.time > _lastAbuseTime && Date.now() - d.time < 15000) {
      _lastAbuseTime = d.time;
      showAdminAbuse();
    }
  }));

  let _lastActionProcessed = 0;
  let _firstActionFire = true;
  _adminUnsubs.push(window._fbOnValue('casino/admin/action', snap => {
    const d = snap.val();
    if (!d || !d.time) return;

    if (_firstActionFire) { _firstActionFire = false; _lastActionProcessed = d.time; return; }
    if (d.time <= _lastActionProcessed) return;
    if (Date.now() - d.time > 15000) { _lastActionProcessed = d.time; return; }
    _lastActionProcessed = d.time;

    const isMe = d.by && d.by.toLowerCase() === (window._currentUsername || '').toLowerCase();
    if (isMe) return;

    if (d.type === 'double') {
      balance *= 2; updateBalDisplay(); firebaseSaveNow();
      showDoubleMoneyAnimation();
      showMoneyRain(balance);
      showToast('💰 ' + (d.by || 'Admin') + ' DOUBLED everyone\'s money!', true);
    } else if (d.type === 'rain' && d.amount) {
      balance += d.amount; updateBalDisplay(); firebaseSaveNow();
      showMoneyRain(d.amount);
      showToast('\u{1F327}\uFE0F Money Rain! +$' + d.amount.toLocaleString(), true);
    } else if (d.type === 'jackpot' && d.amount) {
      balance += d.amount; updateBalDisplay(); firebaseSaveNow();
      showJackpotAnimation(d.amount);
      showToast('\u{1F3B0} JACKPOT! +$' + d.amount.toLocaleString(), true);
    } else if (d.type === 'coinflip') {
      if (d.win) { balance *= 2; } else { balance = Math.floor(balance / 2); }
      updateBalDisplay(); firebaseSaveNow();
      showCoinFlipAnimation(d.win);
      showToast(d.win ? '\u{1FA99} Coin Flip: DOUBLED!' : '\u{1FA99} Coin Flip: Lost half!', d.win);
    } else if (d.type === 'tax') {
      const taxed = Math.floor(balance / 2);
      balance = Math.floor(balance / 2); updateBalDisplay(); firebaseSaveNow();
      showTaxAnimation(taxed);
      showToast('\u{1F480} Admin Tax! Lost $' + taxed.toLocaleString(), false);
    } else if (d.type === 'reset') {
      if (window._setResetCooldown) window._setResetCooldown();
      balance = 1000; _balMark(); updateBalDisplay(); firebaseSaveNow();
      showResetAnimation();
      showToast('☢️ All balances have been reset to $1,000', false);
    } else if (d.type === 'fakereset') {
      showFakeResetAnimation(d.variant || 1);
    } else if (d.type === 'giveprestige') {
      prestigeLevel += 1;
      if (window._loadPrestige) window._loadPrestige(prestigeLevel);
      firebaseSaveNow();
      renderPrestige();
      showPrestigeAnimation(prestigeLevel);
      showToast('Prestige +1! Now P' + prestigeLevel, true);
    }
  }));

  if (window._currentPlayerId) {
    let _playerResetFirst = true;
    _adminUnsubs.push(window._fbOnValue('casino/admin/playerReset/' + window._currentPlayerId, snap => {
      const d = snap.val();
      if (!d || !d.time) return;
      if (_playerResetFirst) { _playerResetFirst = false; return; }
      if (Date.now() - d.time > 30000) return;
      if (window._setResetCooldown) window._setResetCooldown();
      balance = d.balance || 1000;
      _balMark();
      updateBalDisplay();
      firebaseSaveNow();
      if (d.fullWipe) {
        playerStats = { totalWagered: 0, totalWon: 0, totalProfit: 0, gamesPlayed: 0, biggestWin: 0 };
        inventory = [];
        prestigeLevel = 0;
      }
      showToast('⚠️ Your account has been reset by an admin.', false);
    }));

    let _playerGiftFirst = true;
    _adminUnsubs.push(window._fbOnValue('casino/admin/playerGift/' + window._currentPlayerId, snap => {
      const d = snap.val();
      if (!d || !d.time) return;
      if (_playerGiftFirst) { _playerGiftFirst = false; return; }
      if (Date.now() - d.time > 30000) return;

      balance = safeNum(d.newBal);
      _balMark();
      updateBalDisplay();
      firebaseSaveNow();
      showToast('🎁 Admin ' + (d.from || 'Admin') + ' gave you $' + formatBalance(d.amount) + '!', true);
      if (typeof spawnParticles === 'function') spawnParticles(window.innerWidth / 2, window.innerHeight / 2, 30);
    }));
  }

  _adminUnsubs.push(window._fbOnValue('casino/admin/event', snap => {
    const d = snap.val();
    if (!d || !d.status || !d.time) { hideEventOverlay(); return; }
    if (d.status === 'active' && Date.now() - d.time < 3600000) {
      showEventOverlay(d);
    } else {
      hideEventOverlay();
    }
  }));

  _adminUnsubs.push(window._fbOnValue('casino/admin/eventPresence', snap => {
    const d = snap.val();
    const count = d ? Object.keys(d).length : 0;
    const el = document.getElementById('eventOnlineCount');
    if (el) el.textContent = count + ' online';
  }));
}

function adminSetSelfBalance() {
  if (!adminIsStaff()) return;
  const val = parseBet(document.getElementById('adminSelfBalance').value);
  if (isNaN(val) || val < 0) { showToast('Invalid amount!', false); return; }
  balance = val; _balMark(); updateBalDisplay(); firebaseSave();
  showToast('Balance set to $' + formatBalance(val), true);
}

(function initAdminListeners() {
  const check = setInterval(() => {
    if (window._fbOnValue && window._currentPlayerId) {
      clearInterval(check);
      startAdminListeners();

    }
  }, 1000);
})();

// Click Challenge listener
(function initClickChallengeListener() {
  var _ccFirstFire = true, _ccLastTime = 0;
  var check = setInterval(function() {
    if (window._fbOnValue && window._currentPlayerId) {
      clearInterval(check);
      window._fbOnValue('casino/admin/action', function(snap) {
        var d = snap.val();
        if (!d || !d.time || d.type !== 'clickchallenge') return;
        if (_ccFirstFire) { _ccFirstFire = false; _ccLastTime = d.time; return; }
        if (d.time <= _ccLastTime) return;
        if (Date.now() - d.time > 15000) { _ccLastTime = d.time; return; }
        _ccLastTime = d.time;
        var isMe = d.by && d.by.toLowerCase() === (window._currentUsername || '').toLowerCase();
        if (isMe) return;
        showClickChallenge(false);
      });
    }
  }, 1000);
})();
</script>

<div id="modBanOverlay">
  <div class="mod-popup">
    <div class="mod-popup-icon">🚫</div>
    <div class="mod-popup-title" style="color:#ff3333;">YOU ARE BANNED</div>
    <div class="mod-popup-reason" id="modBanReason">Violation of community rules.</div>
    <div class="mod-popup-timer" id="modBanTimer"></div>
    <div class="mod-popup-sub">You will be signed out automatically.</div>
  </div>
</div>

<div id="modWarnOverlay">
  <div class="mod-popup">
    <div class="mod-popup-icon">⚠️</div>
    <div class="mod-popup-title" style="color:#ffaa00;">YOU HAVE BEEN WARNED</div>
    <div class="mod-popup-reason" id="modWarnReason">Please follow the rules.</div>
    <label class="mod-warn-check">
      <input type="checkbox" id="modWarnAgree" onchange="document.getElementById('modWarnCloseBtn').disabled=!this.checked;">
      I understand and will follow the rules
    </label>
    <button id="modWarnCloseBtn" disabled onclick="modDismissWarning()" class="action-btn primary" style="padding:10px 24px;font-size:12px;">CLOSE</button>
  </div>
</div>

<div id="modReasonModal">
  <div class="mod-reason-box">
    <div class="mod-reason-title" id="modReasonTitle">SELECT REASON</div>
    <button class="mod-reason-btn" onclick="modPickReason('Spamming')">💬 Spamming</button>
    <button class="mod-reason-btn" onclick="modPickReason('Abusive Language')">🤬 Abusive Language</button>
    <button class="mod-reason-btn" onclick="modPickReason('Disruption')">💥 Disruption</button>
    <button class="mod-reason-btn" onclick="modPickReason('Harassment')">😡 Harassment</button>
    <button class="mod-reason-btn" onclick="modPickReason('Exploiting / Cheating')">🎮 Exploiting / Cheating</button>
    <input type="text" class="mod-reason-input" id="modReasonCustom" placeholder="Or type a custom reason..." maxlength="100">
    <div id="modDurationRow" class="mod-dur-row" style="display:none;">
      <button class="mod-dur-btn" onclick="modPickDuration(60)">1h</button>
      <button class="mod-dur-btn" onclick="modPickDuration(1440)">1d</button>
      <button class="mod-dur-btn active" onclick="modPickDuration(10080)">1w</button>
      <button class="mod-dur-btn" onclick="modPickDuration(43200)">30d</button>
      <button class="mod-dur-btn" onclick="modPickDuration(0)" style="color:var(--red);">PERM</button>
    </div>
    <div style="display:flex;gap:8px;justify-content:center;margin-top:10px;">
      <button class="action-btn primary" onclick="modConfirmReason()" style="padding:8px 20px;font-size:12px;">CONFIRM</button>
      <button class="mod-dur-cancel" onclick="modCancelReason()">Cancel</button>
    </div>
  </div>
</div>

! Everyone lost half!'),
      time: now, isAdmin: true, isSystem: true
    });
  }
  else if (type === 'tax') {
    await window._fbSet('casino/admin/action', { type: 'tax', time: now, by: window._currentUsername });
    const taxed = Math.floor(balance / 2);
    balance = Math.floor(balance / 2); updateBalDisplay(); firebaseSaveNow();
    showTaxAnimation(taxed);
    const mk = now.toString(36) + 'sys';
    await window._fbSet('casino/admin/eventChat/' + mk, {
      user: 'SYSTEM', text: '\u{1F480} ADMIN TAX! ' + (window._currentUsername || 'Admin') + ' took 50% of everyone\'s money!',
      time: now, isAdmin: true, isSystem: true
    });
  }
  else if (type === 'abuse') {
    await window._fbSet('casino/admin/abuse', { time: now, by: window._currentUsername });
    const mk = now.toString(36) + 'sys';
    await window._fbSet('casino/admin/eventChat/' + mk, {
      user: 'SYSTEM', text: '⚡ ADMIN ABUSE!!! ⚡',
      time: now, isAdmin: true, isSystem: true
    });
  }
  else if (type === 'fakereset1') {
    await window._fbSet('casino/admin/action', { type: 'fakereset', variant: 1, time: now, by: window._currentUsername });
    showFakeResetAnimation(1);
    const mk = now.toString(36) + 'sys';
    await window._fbSet('casino/admin/eventChat/' + mk, {
      user: 'SYSTEM', text: '☢️ Resetting all balances...',
      time: now, isAdmin: true, isSystem: true
    });
  }
  else if (type === 'fakereset2') {
    await window._fbSet('casino/admin/action', { type: 'fakereset', variant: 2, time: now, by: window._currentUsername });
    showFakeResetAnimation(2);
    const mk = now.toString(36) + 'sys';
    await window._fbSet('casino/admin/eventChat/' + mk, {
      user: 'SYSTEM', text: '⚠️ OK actually resetting everyone\'s money this time...',
      time: now, isAdmin: true, isSystem: true
    });
  }
  else if (type === 'fakereset3') {
    await window._fbSet('casino/admin/action', { type: 'fakereset', variant: 3, time: now, by: window._currentUsername });
    showFakeResetAnimation(3);
    const mk = now.toString(36) + 'sys';
    await window._fbSet('casino/admin/eventChat/' + mk, {
      user: 'SYSTEM', text: '🔌 Server going down for maintenance...',
      time: now, isAdmin: true, isSystem: true
    });
  }
  else if (type === 'giveprestige') {
    await window._fbSet('casino/admin/action', { type: 'giveprestige', time: now, by: window._currentUsername });
    prestigeLevel += 1;
    if (window._loadPrestige) window._loadPrestige(prestigeLevel);
    firebaseSaveNow();
    renderPrestige();
    showPrestigeAnimation(prestigeLevel);
    showToast('Prestige +1! Now P' + prestigeLevel, true);
    const mk = now.toString(36) + 'sys';
    await window._fbSet('casino/admin/eventChat/' + mk, {
      user: 'SYSTEM', text: '👑 ' + (window._currentUsername || 'Admin') + ' gave everyone +1 prestige!',
      time: now, isAdmin: true, isSystem: true
    });
  }
  else if (type === 'announce') {
    const msg = prompt('Announcement:');
    if (!msg) return;
    await window._fbSet('casino/admin/announcement', { text: msg, time: now, by: window._currentUsername });
    const mk = now.toString(36) + 'sys';
    await window._fbSet('casino/admin/eventChat/' + mk, {
      user: 'SYSTEM', text: '📢 ' + msg,
      time: now, isAdmin: true, isSystem: true
    });
  }
  else if (type === 'poll') {
    const q = prompt('Quick poll question:', 'Who wants free money?');
    if (!q) return;
    const pollId = now.toString(36);
    await window._fbSet('casino/admin/poll', {
      id: pollId, question: q, options: ['Yes','No'], votes: {}, status: 'active', time: now, by: window._currentUsername
    });
    const mk = now.toString(36) + 'sys';
    await window._fbSet('casino/admin/eventChat/' + mk, {
      user: 'SYSTEM', text: '📊 Poll started: ' + q,
      time: now, isAdmin: true, isSystem: true
    });
  }
  else if (type === 'endEvent') {
    if (!confirm('End the event for everyone?')) return;
    // Immediately hide for the admin who ended it
    hideEventOverlay();
    const mk = now.toString(36) + 'sys';
    await window._fbSet('casino/admin/eventChat/' + mk, {
      user: 'SYSTEM', text: '🚪 Event ended by ' + (window._currentUsername || 'Admin'),
      time: now, isAdmin: true, isSystem: true
    });
    setTimeout(async () => {
      // Fully remove event data so new browsers never see it
      await window._fbRemove('casino/admin/event').catch(()=>{});
      await window._fbRemove('casino/admin/eventPresence').catch(()=>{});
      await window._fbRemove('casino/admin/eventChat').catch(()=>{});
      // Clean up stale admin data so new browsers don't see old polls/announcements
      await window._fbRemove('casino/admin/poll').catch(()=>{});
      await window._fbRemove('casino/admin/announcement').catch(()=>{});
      await window._fbRemove('casino/admin/action').catch(()=>{});
      await window._fbRemove('casino/admin/abuse').catch(()=>{});
    }, 1500);
  }
}

// ─── FIREBASE LISTENERS (for ALL users - with fullscreen animations) ───
function startAdminListeners() {
  if (_adminListenersActive) return;
  _adminListenersActive = true;

  // Track when this session's listeners started — ignore any data older than this
  const _listenerStartTime = Date.now();
  let _firstAnnounceFire = true;
  let _firstPollFire = true;

  // Announcement listener
  _adminUnsubs.push(window._fbOnValue('casino/admin/announcement', snap => {
    const d = snap.val();
    if (!d || !d.text) return;
    // Skip the initial fire (stale data from before this session)
    if (_firstAnnounceFire) { _firstAnnounceFire = false; return; }
    // Only show if created recently
    if (Date.now() - d.time < 30000) {
      showAnnounceBanner(d.text);
    }
  }));

  // Poll listener
  let _lastPollId = null;
  _adminUnsubs.push(window._fbOnValue('casino/admin/poll', snap => {
    const d = snap.val();
    if (!d || !d.question) return;
    // Skip the initial fire if the poll is older than this session
    if (_firstPollFire) {
      _firstPollFire = false;
      // Only show on first fire if poll was created AFTER listener started (race condition buffer)
      if (!d.time || d.time < _listenerStartTime - 5000) return;
    }
    if (!d.time || Date.now() - d.time > 300000) return;
    if (d.status === 'active') {
      showPollOverlay(d);
      _lastPollId = d.id;
    } else if (d.status === 'ended' && d.id === _lastPollId) {
      showPollOverlay(d);
    }
  }));

  // Admin abuse listener - triggers dramatic animation for EVERYONE
  let _lastAbuseTime = 0;
  let _firstAbuseFire = true;
  _adminUnsubs.push(window._fbOnValue('casino/admin/abuse', snap => {
    const d = snap.val();
    if (!d || !d.time) return;
    // Skip the initial fire to avoid replaying stale abuse animation on page load
    if (_firstAbuseFire) { _firstAbuseFire = false; _lastAbuseTime = d.time; return; }
    if (d.time > _lastAbuseTime && Date.now() - d.time < 15000) {
      _lastAbuseTime = d.time;
      showAdminAbuse();
    }
  }));

  // Action listener - triggers fullscreen animations for ALL players
  let _lastActionProcessed = 0;
  let _firstActionFire = true;
  _adminUnsubs.push(window._fbOnValue('casino/admin/action', snap => {
    const d = snap.val();
    if (!d || !d.time) return;
    // Skip the initial fire to prevent balance duplication on page load
    if (_firstActionFire) { _firstActionFire = false; _lastActionProcessed = d.time; return; }
    if (d.time <= _lastActionProcessed) return;
    if (Date.now() - d.time > 15000) { _lastActionProcessed = d.time; return; }
    _lastActionProcessed = d.time;
    // Admin already processed their own actions
    const isMe = d.by && d.by.toLowerCase() === (window._currentUsername || '').toLowerCase();
    if (isMe) return;

    if (d.type === 'double') {
      balance *= 2; updateBalDisplay(); firebaseSaveNow();
      showDoubleMoneyAnimation();
      showMoneyRain(balance);
      showToast('💰 ' + (d.by || 'Admin') + ' DOUBLED everyone\'s money!', true);
    } else if (d.type === 'rain' && d.amount) {
      balance += d.amount; updateBalDisplay(); firebaseSaveNow();
      showMoneyRain(d.amount);
      showToast('\u{1F327}\uFE0F Money Rain! +$' + d.amount.toLocaleString(), true);
    } else if (d.type === 'jackpot' && d.amount) {
      balance += d.amount; updateBalDisplay(); firebaseSaveNow();
      showJackpotAnimation(d.amount);
      showToast('\u{1F3B0} JACKPOT! +$' + d.amount.toLocaleString(), true);
    } else if (d.type === 'coinflip') {
      if (d.win) { balance *= 2; } else { balance = Math.floor(balance / 2); }
      updateBalDisplay(); firebaseSaveNow();
      showCoinFlipAnimation(d.win);
      showToast(d.win ? '\u{1FA99} Coin Flip: DOUBLED!' : '\u{1FA99} Coin Flip: Lost half!', d.win);
    } else if (d.type === 'tax') {
      const taxed = Math.floor(balance / 2);
      balance = Math.floor(balance / 2); updateBalDisplay(); firebaseSaveNow();
      showTaxAnimation(taxed);
      showToast('\u{1F480} Admin Tax! Lost $' + taxed.toLocaleString(), false);
    } else if (d.type === 'reset') {
      if (window._setResetCooldown) window._setResetCooldown();
      balance = 1000; _balMark(); updateBalDisplay(); firebaseSaveNow();
      showResetAnimation();
      showToast('☢️ All balances have been reset to $1,000', false);
    } else if (d.type === 'fakereset') {
      showFakeResetAnimation(d.variant || 1);
    } else if (d.type === 'giveprestige') {
      prestigeLevel += 1;
      if (window._loadPrestige) window._loadPrestige(prestigeLevel);
      firebaseSaveNow();
      renderPrestige();
      showPrestigeAnimation(prestigeLevel);
      showToast('Prestige +1! Now P' + prestigeLevel, true);
    }
  }));

  // Targeted player reset listener — if admin resets THIS specific player
  if (window._currentPlayerId) {
    let _playerResetFirst = true;
    _adminUnsubs.push(window._fbOnValue('casino/admin/playerReset/' + window._currentPlayerId, snap => {
      const d = snap.val();
      if (!d || !d.time) return;
      if (_playerResetFirst) { _playerResetFirst = false; return; }
      if (Date.now() - d.time > 30000) return; // ignore old resets
      if (window._setResetCooldown) window._setResetCooldown();
      balance = d.balance || 1000;
      _balMark();
      updateBalDisplay();
      firebaseSaveNow();
      if (d.fullWipe) {
        playerStats = { totalWagered: 0, totalWon: 0, totalProfit: 0, gamesPlayed: 0, biggestWin: 0 };
        inventory = [];
        prestigeLevel = 0;
      }
      showToast('⚠️ Your account has been reset by an admin.', false);
    }));

    // Targeted gift listener — if admin gives THIS player money
    let _playerGiftFirst = true;
    _adminUnsubs.push(window._fbOnValue('casino/admin/playerGift/' + window._currentPlayerId, snap => {
      const d = snap.val();
      if (!d || !d.time) return;
      if (_playerGiftFirst) { _playerGiftFirst = false; return; }
      if (Date.now() - d.time > 30000) return;
      // Set balance to the new value from admin
      balance = safeNum(d.newBal);
      _balMark();
      updateBalDisplay();
      firebaseSaveNow();
      showToast('🎁 Admin ' + (d.from || 'Admin') + ' gave you $' + formatBalance(d.amount) + '!', true);
      if (typeof spawnParticles === 'function') spawnParticles(window.innerWidth / 2, window.innerHeight / 2, 30);
    }));
  }

  // Event listener
  _adminUnsubs.push(window._fbOnValue('casino/admin/event', snap => {
    const d = snap.val();
    if (!d || !d.status || !d.time) { hideEventOverlay(); return; }
    if (d.status === 'active' && Date.now() - d.time < 3600000) {
      showEventOverlay(d);
    } else {
      hideEventOverlay();
    }
  }));

  // Event presence counter
  _adminUnsubs.push(window._fbOnValue('casino/admin/eventPresence', snap => {
    const d = snap.val();
    const count = d ? Object.keys(d).length : 0;
    const el = document.getElementById('eventOnlineCount');
    if (el) el.textContent = count + ' online';
  }));
}

// ─── ADMIN SET SELF BALANCE ───
function adminSetSelfBalance() {
  if (!adminIsStaff()) return;
  const val = parseBet(document.getElementById('adminSelfBalance').value);
  if (isNaN(val) || val < 0) { showToast('Invalid amount!', false); return; }
  balance = val; _balMark(); updateBalDisplay(); firebaseSave();
  showToast('Balance set to $' + formatBalance(val), true);
}

// Start listeners once Firebase is ready
(function initAdminListeners() {
  const check = setInterval(() => {
    if (window._fbOnValue && window._currentPlayerId) {
      clearInterval(check);
      startAdminListeners();
      // DB switch notice is handled by the overlay popup (shown on page load)
    }
  }, 1000);
})();
</script>

<!-- ============ MODERATION OVERLAYS ============ -->
<!-- Ban Popup -->
<div id="modBanOverlay">
  <div class="mod-popup">
    <div class="mod-popup-icon">🚫</div>
    <div class="mod-popup-title" style="color:#ff3333;">YOU ARE BANNED</div>
    <div class="mod-popup-reason" id="modBanReason">Violation of community rules.</div>
    <div class="mod-popup-timer" id="modBanTimer"></div>
    <div class="mod-popup-sub">You will be signed out automatically.</div>
  </div>
</div>

<!-- Warning Popup -->
<div id="modWarnOverlay">
  <div class="mod-popup">
    <div class="mod-popup-icon">⚠️</div>
    <div class="mod-popup-title" style="color:#ffaa00;">YOU HAVE BEEN WARNED</div>
    <div class="mod-popup-reason" id="modWarnReason">Please follow the rules.</div>
    <label class="mod-warn-check">
      <input type="checkbox" id="modWarnAgree" onchange="document.getElementById('modWarnCloseBtn').disabled=!this.checked;">
      I understand and will follow the rules
    </label>
    <button id="modWarnCloseBtn" disabled onclick="modDismissWarning()" class="action-btn primary" style="padding:10px 24px;font-size:12px;">CLOSE</button>
  </div>
</div>

<!-- Reason Modal (shared for ban/mute/warn) -->
<div id="modReasonModal">
  <div class="mod-reason-box">
    <div class="mod-reason-title" id="modReasonTitle">SELECT REASON</div>
    <button class="mod-reason-btn" onclick="modPickReason('Spamming')">💬 Spamming</button>
    <button class="mod-reason-btn" onclick="modPickReason('Abusive Language')">🤬 Abusive Language</button>
    <button class="mod-reason-btn" onclick="modPickReason('Disruption')">💥 Disruption</button>
    <button class="mod-reason-btn" onclick="modPickReason('Harassment')">😡 Harassment</button>
    <button class="mod-reason-btn" onclick="modPickReason('Exploiting / Cheating')">🎮 Exploiting / Cheating</button>
    <input type="text" class="mod-reason-input" id="modReasonCustom" placeholder="Or type a custom reason..." maxlength="100">
    <div id="modDurationRow" class="mod-dur-row" style="display:none;">
      <button class="mod-dur-btn" onclick="modPickDuration(60)">1h</button>
      <button class="mod-dur-btn" onclick="modPickDuration(1440)">1d</button>
      <button class="mod-dur-btn active" onclick="modPickDuration(10080)">1w</button>
      <button class="mod-dur-btn" onclick="modPickDuration(43200)">30d</button>
      <button class="mod-dur-btn" onclick="modPickDuration(0)" style="color:var(--red);">PERM</button>
    </div>
    <div style="display:flex;gap:8px;justify-content:center;margin-top:10px;">
      <button class="action-btn primary" onclick="modConfirmReason()" style="padding:8px 20px;font-size:12px;">CONFIRM</button>
      <button class="mod-dur-cancel" onclick="modCancelReason()">Cancel</button>
    </div>
  </div>
</div>

<!-- Moderation Panel -->
<div id="modPanel">
  <div class="mod-panel-box">
    <div class="mod-panel-header">
      <div class="mod-panel-title">🛡️ MODERATION</div>
      <button class="mod-panel-close" onclick="modClosePanel()">✕ CLOSE</button>
    </div>
    <div class="mod-panel-tabs">
      <div class="mod-panel-tab active" onclick="modSwitchTab('banned')">BANNED</div>
      <div class="mod-panel-tab" onclick="modSwitchTab('muted')">MUTED</div>
      <div class="mod-panel-tab" onclick="modSwitchTab('actions')">ACTIONS</div>
    </div>
    <div class="mod-panel-content" id="modPanelContent">
      <div class="mod-panel-empty">Loading...</div>
    </div>
  </div>
</div>

</body>
</html>
     time: now, isAdmin: true, isSystem: true
    });
  }
  else if (type === 'fakereset3') {
    await window._fbSet('casino/admin/action', { type: 'fakereset', variant: 3, time: now, by: window._currentUsername });
    showFakeResetAnimation(3);
    const mk = now.toString(36) + 'sys';
    await window._fbSet('casino/admin/eventChat/' + mk, {
      user: 'SYSTEM', text: '🔌 Server going down for maintenance...',
      time: now, isAdmin: true, isSystem: true
    });
  }
  else if (type === 'giveprestige') {
    await window._fbSet('casino/admin/action', { type: 'giveprestige', time: now, by: window._currentUsername });
    prestigeLevel += 1;
    if (window._loadPrestige) window._loadPrestige(prestigeLevel);
    firebaseSaveNow();
    renderPrestige();
    showPrestigeAnimation(prestigeLevel);
    showToast('Prestige +1! Now P' + prestigeLevel, true);
    const mk = now.toString(36) + 'sys';
    await window._fbSet('casino/admin/eventChat/' + mk, {
      user: 'SYSTEM', text: '👑 ' + (window._currentUsername || 'Admin') + ' gave everyone +1 prestige!',
      time: now, isAdmin: true, isSystem: true
    });
  }
  else if (type === 'announce') {
    const msg = prompt('Announcement:');
    if (!msg) return;
    await window._fbSet('casino/admin/announcement', { text: msg, time: now, by: window._currentUsername });
    const mk = now.toString(36) + 'sys';
    await window._fbSet('casino/admin/eventChat/' + mk, {
      user: 'SYSTEM', text: '📢 ' + msg,
      time: now, isAdmin: true, isSystem: true
    });
  }
  else if (type === 'poll') {
    const q = prompt('Quick poll question:', 'Who wants free money?');
    if (!q) return;
    const pollId = now.toString(36);
    await window._fbSet('casino/admin/poll', {
      id: pollId, question: q, options: ['Yes','No'], votes: {}, status: 'active', time: now, by: window._currentUsername
    });
    const mk = now.toString(36) + 'sys';
    await window._fbSet('casino/admin/eventChat/' + mk, {
      user: 'SYSTEM', text: '📊 Poll started: ' + q,
      time: now, isAdmin: true, isSystem: true
    });
  }
  else if (type === 'endEvent') {
    if (!confirm('End the event for everyone?')) return;

    hideEventOverlay();
    const mk = now.toString(36) + 'sys';
    await window._fbSet('casino/admin/eventChat/' + mk, {
      user: 'SYSTEM', text: '🚪 Event ended by ' + (window._currentUsername || 'Admin'),
      time: now, isAdmin: true, isSystem: true
    });
    setTimeout(async () => {

      await window._fbRemove('casino/admin/event').catch(()=>{});
      await window._fbRemove('casino/admin/eventPresence').catch(()=>{});
      await window._fbRemove('casino/admin/eventChat').catch(()=>{});

      await window._fbRemove('casino/admin/poll').catch(()=>{});
      await window._fbRemove('casino/admin/announcement').catch(()=>{});
      await window._fbRemove('casino/admin/action').catch(()=>{});
      await window._fbRemove('casino/admin/abuse').catch(()=>{});
    }, 1500);
  }
}

function startAdminListeners() {
  if (_adminListenersActive) return;
  _adminListenersActive = true;

  const _listenerStartTime = Date.now();
  let _firstAnnounceFire = true;
  let _firstPollFire = true;

  _adminUnsubs.push(window._fbOnValue('casino/admin/announcement', snap => {
    const d = snap.val();
    if (!d || !d.text) return;

    if (_firstAnnounceFire) { _firstAnnounceFire = false; return; }

    if (Date.now() - d.time < 30000) {
      showAnnounceBanner(d.text);
    }
  }));

  let _lastPollId = null;
  _adminUnsubs.push(window._fbOnValue('casino/admin/poll', snap => {
    const d = snap.val();
    if (!d || !d.question) return;

    if (_firstPollFire) {
      _firstPollFire = false;

      if (!d.time || d.time < _listenerStartTime - 5000) return;
    }
    if (!d.time || Date.now() - d.time > 300000) return;
    if (d.status === 'active') {
      showPollOverlay(d);
      _lastPollId = d.id;
    } else if (d.status === 'ended' && d.id === _lastPollId) {
      showPollOverlay(d);
    }
  }));

  let _lastAbuseTime = 0;
  let _firstAbuseFire = true;
  _adminUnsubs.push(window._fbOnValue('casino/admin/abuse', snap => {
    const d = snap.val();
    if (!d || !d.time) return;

    if (_firstAbuseFire) { _firstAbuseFire = false; _lastAbuseTime = d.time; return; }
    if (d.time > _lastAbuseTime && Date.now() - d.time < 15000) {
      _lastAbuseTime = d.time;
      showAdminAbuse();
    }
  }));

  let _lastActionProcessed = 0;
  let _firstActionFire = true;
  _adminUnsubs.push(window._fbOnValue('casino/admin/action', snap => {
    const d = snap.val();
    if (!d || !d.time) return;

    if (_firstActionFire) { _firstActionFire = false; _lastActionProcessed = d.time; return; }
    if (d.time <= _lastActionProcessed) return;
    if (Date.now() - d.time > 15000) { _lastActionProcessed = d.time; return; }
    _lastActionProcessed = d.time;

    const isMe = d.by && d.by.toLowerCase() === (window._currentUsername || '').toLowerCase();
    if (isMe) return;

    if (d.type === 'double') {
      balance *= 2; updateBalDisplay(); firebaseSaveNow();
      showDoubleMoneyAnimation();
      showMoneyRain(balance);
      showToast('💰 ' + (d.by || 'Admin') + ' DOUBLED everyone\'s money!', true);
    } else if (d.type === 'rain' && d.amount) {
      balance += d.amount; updateBalDisplay(); firebaseSaveNow();
      showMoneyRain(d.amount);
      showToast('\u{1F327}\uFE0F Money Rain! +$' + d.amount.toLocaleString(), true);
    } else if (d.type === 'jackpot' && d.amount) {
      balance += d.amount; updateBalDisplay(); firebaseSaveNow();
      showJackpotAnimation(d.amount);
      showToast('\u{1F3B0} JACKPOT! +$' + d.amount.toLocaleString(), true);
    } else if (d.type === 'coinflip') {
      if (d.win) { balance *= 2; } else { balance = Math.floor(balance / 2); }
      updateBalDisplay(); firebaseSaveNow();
      showCoinFlipAnimation(d.win);
      showToast(d.win ? '\u{1FA99} Coin Flip: DOUBLED!' : '\u{1FA99} Coin Flip: Lost half!', d.win);
    } else if (d.type === 'tax') {
      const taxed = Math.floor(balance / 2);
      balance = Math.floor(balance / 2); updateBalDisplay(); firebaseSaveNow();
      showTaxAnimation(taxed);
      showToast('\u{1F480} Admin Tax! Lost $' + taxed.toLocaleString(), false);
    } else if (d.type === 'reset') {
      if (window._setResetCooldown) window._setResetCooldown();
      balance = 1000; _balMark(); updateBalDisplay(); firebaseSaveNow();
      showResetAnimation();
      showToast('☢️ All balances have been reset to $1,000', false);
    } else if (d.type === 'fakereset') {
      showFakeResetAnimation(d.variant || 1);
    } else if (d.type === 'giveprestige') {
      prestigeLevel += 1;
      if (window._loadPrestige) window._loadPrestige(prestigeLevel);
      firebaseSaveNow();
      renderPrestige();
      showPrestigeAnimation(prestigeLevel);
      showToast('Prestige +1! Now P' + prestigeLevel, true);
    }
  }));

  if (window._currentPlayerId) {
    let _playerResetFirst = true;
    _adminUnsubs.push(window._fbOnValue('casino/admin/playerReset/' + window._currentPlayerId, snap => {
      const d = snap.val();
      if (!d || !d.time) return;
      if (_playerResetFirst) { _playerResetFirst = false; return; }
      if (Date.now() - d.time > 30000) return;
      if (window._setResetCooldown) window._setResetCooldown();
      balance = d.balance || 1000;
      _balMark();
      updateBalDisplay();
      firebaseSaveNow();
      if (d.fullWipe) {
        playerStats = { totalWagered: 0, totalWon: 0, totalProfit: 0, gamesPlayed: 0, biggestWin: 0 };
        inventory = [];
        prestigeLevel = 0;
      }
      showToast('⚠️ Your account has been reset by an admin.', false);
    }));

    let _playerGiftFirst = true;
    _adminUnsubs.push(window._fbOnValue('casino/admin/playerGift/' + window._currentPlayerId, snap => {
      const d = snap.val();
      if (!d || !d.time) return;
      if (_playerGiftFirst) { _playerGiftFirst = false; return; }
      if (Date.now() - d.time > 30000) return;

      balance = safeNum(d.newBal);
      _balMark();
      updateBalDisplay();
      firebaseSaveNow();
      showToast('🎁 Admin ' + (d.from || 'Admin') + ' gave you $' + formatBalance(d.amount) + '!', true);
      if (typeof spawnParticles === 'function') spawnParticles(window.innerWidth / 2, window.innerHeight / 2, 30);
    }));
  }

  _adminUnsubs.push(window._fbOnValue('casino/admin/event', snap => {
    const d = snap.val();
    if (!d || !d.status || !d.time) { hideEventOverlay(); return; }
    if (d.status === 'active' && Date.now() - d.time < 3600000) {
      showEventOverlay(d);
    } else {
      hideEventOverlay();
    }
  }));

  _adminUnsubs.push(window._fbOnValue('casino/admin/eventPresence', snap => {
    const d = snap.val();
    const count = d ? Object.keys(d).length : 0;
    const el = document.getElementById('eventOnlineCount');
    if (el) el.textContent = count + ' online';
  }));
}

function adminSetSelfBalance() {
  if (!adminIsStaff()) return;
  const val = parseBet(document.getElementById('adminSelfBalance').value);
  if (isNaN(val) || val < 0) { showToast('Invalid amount!', false); return; }
  balance = val; _balMark(); updateBalDisplay(); firebaseSave();
  showToast('Balance set to $' + formatBalance(val), true);
}

(function initAdminListeners() {
  const check = setInterval(() => {
    if (window._fbOnValue && window._currentPlayerId) {
      clearInterval(check);
      startAdminListeners();

    }
  }, 1000);
})();
</script>

<div id="modBanOverlay">
  <div class="mod-popup">
    <div class="mod-popup-icon">🚫</div>
    <div class="mod-popup-title" style="color:#ff3333;">YOU ARE BANNED</div>
    <div class="mod-popup-reason" id="modBanReason">Violation of community rules.</div>
    <div class="mod-popup-timer" id="modBanTimer"></div>
    <div class="mod-popup-sub">You will be signed out automatically.</div>
  </div>
</div>

<div id="modWarnOverlay">
  <div class="mod-popup">
    <div class="mod-popup-icon">⚠️</div>
    <div class="mod-popup-title" style="color:#ffaa00;">YOU HAVE BEEN WARNED</div>
    <div class="mod-popup-reason" id="modWarnReason">Please follow the rules.</div>
    <label class="mod-warn-check">
      <input type="checkbox" id="modWarnAgree" onchange="document.getElementById('modWarnCloseBtn').disabled=!this.checked;">
      I understand and will follow the rules
    </label>
    <button id="modWarnCloseBtn" disabled onclick="modDismissWarning()" class="action-btn primary" style="padding:10px 24px;font-size:12px;">CLOSE</button>
  </div>
</div>

<div id="modReasonModal">
  <div class="mod-reason-box">
    <div class="mod-reason-title" id="modReasonTitle">SELECT REASON</div>
    <button class="mod-reason-btn" onclick="modPickReason('Spamming')">💬 Spamming</button>
    <button class="mod-reason-btn" onclick="modPickReason('Abusive Language')">🤬 Abusive Language</button>
    <button class="mod-reason-btn" onclick="modPickReason('Disruption')">💥 Disruption</button>
    <button class="mod-reason-btn" onclick="modPickReason('Harassment')">😡 Harassment</button>
    <button class="mod-reason-btn" onclick="modPickReason('Exploiting / Cheating')">🎮 Exploiting / Cheating</button>
    <input type="text" class="mod-reason-input" id="modReasonCustom" placeholder="Or type a custom reason..." maxlength="100">
    <div id="modDurationRow" class="mod-dur-row" style="display:none;">
      <button class="mod-dur-btn" onclick="modPickDuration(60)">1h</button>
      <button class="mod-dur-btn" onclick="modPickDuration(1440)">1d</button>
      <button class="mod-dur-btn active" onclick="modPickDuration(10080)">1w</button>
      <button class="mod-dur-btn" onclick="modPickDuration(43200)">30d</button>
      <button class="mod-dur-btn" onclick="modPickDuration(0)" style="color:var(--red);">PERM</button>
    </div>
    <div style="display:flex;gap:8px;justify-content:center;margin-top:10px;">
      <button class="action-btn primary" onclick="modConfirmReason()" style="padding:8px 20px;font-size:12px;">CONFIRM</button>
      <button class="mod-dur-cancel" onclick="modCancelReason()">Cancel</button>
    </div>
  </div>
</div>

! Everyone lost half!'),
      time: now, isAdmin: true, isSystem: true
    });
  }
  else if (type === 'tax') {
    await window._fbSet('casino/admin/action', { type: 'tax', time: now, by: window._currentUsername });
    const taxed = Math.floor(balance / 2);
    balance = Math.floor(balance / 2); updateBalDisplay(); firebaseSaveNow();
    showTaxAnimation(taxed);
    const mk = now.toString(36) + 'sys';
    await window._fbSet('casino/admin/eventChat/' + mk, {
      user: 'SYSTEM', text: '\u{1F480} ADMIN TAX! ' + (window._currentUsername || 'Admin') + ' took 50% of everyone\'s money!',
      time: now, isAdmin: true, isSystem: true
    });
  }
  else if (type === 'abuse') {
    await window._fbSet('casino/admin/abuse', { time: now, by: window._currentUsername });
    const mk = now.toString(36) + 'sys';
    await window._fbSet('casino/admin/eventChat/' + mk, {
      user: 'SYSTEM', text: '⚡ ADMIN ABUSE!!! ⚡',
      time: now, isAdmin: true, isSystem: true
    });
  }
  else if (type === 'fakereset1') {
    await window._fbSet('casino/admin/action', { type: 'fakereset', variant: 1, time: now, by: window._currentUsername });
    showFakeResetAnimation(1);
    const mk = now.toString(36) + 'sys';
    await window._fbSet('casino/admin/eventChat/' + mk, {
      user: 'SYSTEM', text: '☢️ Resetting all balances...',
      time: now, isAdmin: true, isSystem: true
    });
  }
  else if (type === 'fakereset2') {
    await window._fbSet('casino/admin/action', { type: 'fakereset', variant: 2, time: now, by: window._currentUsername });
    showFakeResetAnimation(2);
    const mk = now.toString(36) + 'sys';
    await window._fbSet('casino/admin/eventChat/' + mk, {
      user: 'SYSTEM', text: '⚠️ OK actually resetting everyone\'s money this time...',
      time: now, isAdmin: true, isSystem: true
    });
  }
  else if (type === 'fakereset3') {
    await window._fbSet('casino/admin/action', { type: 'fakereset', variant: 3, time: now, by: window._currentUsername });
    showFakeResetAnimation(3);
    const mk = now.toString(36) + 'sys';
    await window._fbSet('casino/admin/eventChat/' + mk, {
      user: 'SYSTEM', text: '🔌 Server going down for maintenance...',
      time: now, isAdmin: true, isSystem: true
    });
  }
  else if (type === 'giveprestige') {
    await window._fbSet('casino/admin/action', { type: 'giveprestige', time: now, by: window._currentUsername });
    prestigeLevel += 1;
    if (window._loadPrestige) window._loadPrestige(prestigeLevel);
    firebaseSaveNow();
    renderPrestige();
    showPrestigeAnimation(prestigeLevel);
    showToast('Prestige +1! Now P' + prestigeLevel, true);
    const mk = now.toString(36) + 'sys';
    await window._fbSet('casino/admin/eventChat/' + mk, {
      user: 'SYSTEM', text: '👑 ' + (window._currentUsername || 'Admin') + ' gave everyone +1 prestige!',
      time: now, isAdmin: true, isSystem: true
    });
  }
  else if (type === 'announce') {
    const msg = prompt('Announcement:');
    if (!msg) return;
    await window._fbSet('casino/admin/announcement', { text: msg, time: now, by: window._currentUsername });
    const mk = now.toString(36) + 'sys';
    await window._fbSet('casino/admin/eventChat/' + mk, {
      user: 'SYSTEM', text: '📢 ' + msg,
      time: now, isAdmin: true, isSystem: true
    });
  }
  else if (type === 'poll') {
    const q = prompt('Quick poll question:', 'Who wants free money?');
    if (!q) return;
    const pollId = now.toString(36);
    await window._fbSet('casino/admin/poll', {
      id: pollId, question: q, options: ['Yes','No'], votes: {}, status: 'active', time: now, by: window._currentUsername
    });
    const mk = now.toString(36) + 'sys';
    await window._fbSet('casino/admin/eventChat/' + mk, {
      user: 'SYSTEM', text: '📊 Poll started: ' + q,
      time: now, isAdmin: true, isSystem: true
    });
  }
  else if (type === 'endEvent') {
    if (!confirm('End the event for everyone?')) return;
    // Immediately hide for the admin who ended it
    hideEventOverlay();
    const mk = now.toString(36) + 'sys';
    await window._fbSet('casino/admin/eventChat/' + mk, {
      user: 'SYSTEM', text: '🚪 Event ended by ' + (window._currentUsername || 'Admin'),
      time: now, isAdmin: true, isSystem: true
    });
    setTimeout(async () => {
      // Fully remove event data so new browsers never see it
      await window._fbRemove('casino/admin/event').catch(()=>{});
      await window._fbRemove('casino/admin/eventPresence').catch(()=>{});
      await window._fbRemove('casino/admin/eventChat').catch(()=>{});
      // Clean up stale admin data so new browsers don't see old polls/announcements
      await window._fbRemove('casino/admin/poll').catch(()=>{});
      await window._fbRemove('casino/admin/announcement').catch(()=>{});
      await window._fbRemove('casino/admin/action').catch(()=>{});
      await window._fbRemove('casino/admin/abuse').catch(()=>{});
    }, 1500);
  }
}

// ─── FIREBASE LISTENERS (for ALL users - with fullscreen animations) ───
function startAdminListeners() {
  if (_adminListenersActive) return;
  _adminListenersActive = true;

  // Track when this session's listeners started — ignore any data older than this
  const _listenerStartTime = Date.now();
  let _firstAnnounceFire = true;
  let _firstPollFire = true;

  // Announcement listener
  _adminUnsubs.push(window._fbOnValue('casino/admin/announcement', snap => {
    const d = snap.val();
    if (!d || !d.text) return;
    // Skip the initial fire (stale data from before this session)
    if (_firstAnnounceFire) { _firstAnnounceFire = false; return; }
    // Only show if created recently
    if (Date.now() - d.time < 30000) {
      showAnnounceBanner(d.text);
    }
  }));

  // Poll listener
  let _lastPollId = null;
  _adminUnsubs.push(window._fbOnValue('casino/admin/poll', snap => {
    const d = snap.val();
    if (!d || !d.question) return;
    // Skip the initial fire if the poll is older than this session
    if (_firstPollFire) {
      _firstPollFire = false;
      // Only show on first fire if poll was created AFTER listener started (race condition buffer)
      if (!d.time || d.time < _listenerStartTime - 5000) return;
    }
    if (!d.time || Date.now() - d.time > 300000) return;
    if (d.status === 'active') {
      showPollOverlay(d);
      _lastPollId = d.id;
    } else if (d.status === 'ended' && d.id === _lastPollId) {
      showPollOverlay(d);
    }
  }));

  // Admin abuse listener - triggers dramatic animation for EVERYONE
  let _lastAbuseTime = 0;
  let _firstAbuseFire = true;
  _adminUnsubs.push(window._fbOnValue('casino/admin/abuse', snap => {
    const d = snap.val();
    if (!d || !d.time) return;
    // Skip the initial fire to avoid replaying stale abuse animation on page load
    if (_firstAbuseFire) { _firstAbuseFire = false; _lastAbuseTime = d.time; return; }
    if (d.time > _lastAbuseTime && Date.now() - d.time < 15000) {
      _lastAbuseTime = d.time;
      showAdminAbuse();
    }
  }));

  // Action listener - triggers fullscreen animations for ALL players
  let _lastActionProcessed = 0;
  let _firstActionFire = true;
  _adminUnsubs.push(window._fbOnValue('casino/admin/action', snap => {
    const d = snap.val();
    if (!d || !d.time) return;
    // Skip the initial fire to prevent balance duplication on page load
    if (_firstActionFire) { _firstActionFire = false; _lastActionProcessed = d.time; return; }
    if (d.time <= _lastActionProcessed) return;
    if (Date.now() - d.time > 15000) { _lastActionProcessed = d.time; return; }
    _lastActionProcessed = d.time;
    // Admin already processed their own actions
    const isMe = d.by && d.by.toLowerCase() === (window._currentUsername || '').toLowerCase();
    if (isMe) return;

    if (d.type === 'double') {
      balance *= 2; updateBalDisplay(); firebaseSaveNow();
      showDoubleMoneyAnimation();
      showMoneyRain(balance);
      showToast('💰 ' + (d.by || 'Admin') + ' DOUBLED everyone\'s money!', true);
    } else if (d.type === 'rain' && d.amount) {
      balance += d.amount; updateBalDisplay(); firebaseSaveNow();
      showMoneyRain(d.amount);
      showToast('\u{1F327}\uFE0F Money Rain! +$' + d.amount.toLocaleString(), true);
    } else if (d.type === 'jackpot' && d.amount) {
      balance += d.amount; updateBalDisplay(); firebaseSaveNow();
      showJackpotAnimation(d.amount);
      showToast('\u{1F3B0} JACKPOT! +$' + d.amount.toLocaleString(), true);
    } else if (d.type === 'coinflip') {
      if (d.win) { balance *= 2; } else { balance = Math.floor(balance / 2); }
      updateBalDisplay(); firebaseSaveNow();
      showCoinFlipAnimation(d.win);
      showToast(d.win ? '\u{1FA99} Coin Flip: DOUBLED!' : '\u{1FA99} Coin Flip: Lost half!', d.win);
    } else if (d.type === 'tax') {
      const taxed = Math.floor(balance / 2);
      balance = Math.floor(balance / 2); updateBalDisplay(); firebaseSaveNow();
      showTaxAnimation(taxed);
      showToast('\u{1F480} Admin Tax! Lost $' + taxed.toLocaleString(), false);
    } else if (d.type === 'reset') {
      if (window._setResetCooldown) window._setResetCooldown();
      balance = 1000; _balMark(); updateBalDisplay(); firebaseSaveNow();
      showResetAnimation();
      showToast('☢️ All balances have been reset to $1,000', false);
    } else if (d.type === 'fakereset') {
      showFakeResetAnimation(d.variant || 1);
    } else if (d.type === 'giveprestige') {
      prestigeLevel += 1;
      if (window._loadPrestige) window._loadPrestige(prestigeLevel);
      firebaseSaveNow();
      renderPrestige();
      showPrestigeAnimation(prestigeLevel);
      showToast('Prestige +1! Now P' + prestigeLevel, true);
    }
  }));

  // Targeted player reset listener — if admin resets THIS specific player
  if (window._currentPlayerId) {
    let _playerResetFirst = true;
    _adminUnsubs.push(window._fbOnValue('casino/admin/playerReset/' + window._currentPlayerId, snap => {
      const d = snap.val();
      if (!d || !d.time) return;
      if (_playerResetFirst) { _playerResetFirst = false; return; }
      if (Date.now() - d.time > 30000) return; // ignore old resets
      if (window._setResetCooldown) window._setResetCooldown();
      balance = d.balance || 1000;
      _balMark();
      updateBalDisplay();
      firebaseSaveNow();
      if (d.fullWipe) {
        playerStats = { totalWagered: 0, totalWon: 0, totalProfit: 0, gamesPlayed: 0, biggestWin: 0 };
        inventory = [];
        prestigeLevel = 0;
      }
      showToast('⚠️ Your account has been reset by an admin.', false);
    }));

    // Targeted gift listener — if admin gives THIS player money
    let _playerGiftFirst = true;
    _adminUnsubs.push(window._fbOnValue('casino/admin/playerGift/' + window._currentPlayerId, snap => {
      const d = snap.val();
      if (!d || !d.time) return;
      if (_playerGiftFirst) { _playerGiftFirst = false; return; }
      if (Date.now() - d.time > 30000) return;
      // Set balance to the new value from admin
      balance = safeNum(d.newBal);
      _balMark();
      updateBalDisplay();
      firebaseSaveNow();
      showToast('🎁 Admin ' + (d.from || 'Admin') + ' gave you $' + formatBalance(d.amount) + '!', true);
      if (typeof spawnParticles === 'function') spawnParticles(window.innerWidth / 2, window.innerHeight / 2, 30);
    }));
  }

  // Event listener
  _adminUnsubs.push(window._fbOnValue('casino/admin/event', snap => {
    const d = snap.val();
    if (!d || !d.status || !d.time) { hideEventOverlay(); return; }
    if (d.status === 'active' && Date.now() - d.time < 3600000) {
      showEventOverlay(d);
    } else {
      hideEventOverlay();
    }
  }));

  // Event presence counter
  _adminUnsubs.push(window._fbOnValue('casino/admin/eventPresence', snap => {
    const d = snap.val();
    const count = d ? Object.keys(d).length : 0;
    const el = document.getElementById('eventOnlineCount');
    if (el) el.textContent = count + ' online';
  }));
}

// ─── ADMIN SET SELF BALANCE ───
function adminSetSelfBalance() {
  if (!adminIsStaff()) return;
  const val = parseBet(document.getElementById('adminSelfBalance').value);
  if (isNaN(val) || val < 0) { showToast('Invalid amount!', false); return; }
  balance = val; _balMark(); updateBalDisplay(); firebaseSave();
  showToast('Balance set to $' + formatBalance(val), true);
}

// Start listeners once Firebase is ready
(function initAdminListeners() {
  const check = setInterval(() => {
    if (window._fbOnValue && window._currentPlayerId) {
      clearInterval(check);
      startAdminListeners();
      // DB switch notice is handled by the overlay popup (shown on page load)
    }
  }, 1000);
})();
</script>

<!-- ============ MODERATION OVERLAYS ============ -->
<!-- Ban Popup -->
<div id="modBanOverlay">
  <div class="mod-popup">
    <div class="mod-popup-icon">🚫</div>
    <div class="mod-popup-title" style="color:#ff3333;">YOU ARE BANNED</div>
    <div class="mod-popup-reason" id="modBanReason">Violation of community rules.</div>
    <div class="mod-popup-timer" id="modBanTimer"></div>
    <div class="mod-popup-sub">You will be signed out automatically.</div>
  </div>
</div>

<!-- Warning Popup -->
<div id="modWarnOverlay">
  <div class="mod-popup">
    <div class="mod-popup-icon">⚠️</div>
    <div class="mod-popup-title" style="color:#ffaa00;">YOU HAVE BEEN WARNED</div>
    <div class="mod-popup-reason" id="modWarnReason">Please follow the rules.</div>
    <label class="mod-warn-check">
      <input type="checkbox" id="modWarnAgree" onchange="document.getElementById('modWarnCloseBtn').disabled=!this.checked;">
      I understand and will follow the rules
    </label>
    <button id="modWarnCloseBtn" disabled onclick="modDismissWarning()" class="action-btn primary" style="padding:10px 24px;font-size:12px;">CLOSE</button>
  </div>
</div>

<!-- Reason Modal (shared for ban/mute/warn) -->
<div id="modReasonModal">
  <div class="mod-reason-box">
    <div class="mod-reason-title" id="modReasonTitle">SELECT REASON</div>
    <button class="mod-reason-btn" onclick="modPickReason('Spamming')">💬 Spamming</button>
    <button class="mod-reason-btn" onclick="modPickReason('Abusive Language')">🤬 Abusive Language</button>
    <button class="mod-reason-btn" onclick="modPickReason('Disruption')">💥 Disruption</button>
    <button class="mod-reason-btn" onclick="modPickReason('Harassment')">😡 Harassment</button>
    <button class="mod-reason-btn" onclick="modPickReason('Exploiting / Cheating')">🎮 Exploiting / Cheating</button>
    <input type="text" class="mod-reason-input" id="modReasonCustom" placeholder="Or type a custom reason..." maxlength="100">
    <div id="modDurationRow" class="mod-dur-row" style="display:none;">
      <button class="mod-dur-btn" onclick="modPickDuration(60)">1h</button>
      <button class="mod-dur-btn" onclick="modPickDuration(1440)">1d</button>
      <button class="mod-dur-btn active" onclick="modPickDuration(10080)">1w</button>
      <button class="mod-dur-btn" onclick="modPickDuration(43200)">30d</button>
      <button class="mod-dur-btn" onclick="modPickDuration(0)" style="color:var(--red);">PERM</button>
    </div>
    <div style="display:flex;gap:8px;justify-content:center;margin-top:10px;">
      <button class="action-btn primary" onclick="modConfirmReason()" style="padding:8px 20px;font-size:12px;">CONFIRM</button>
      <button class="mod-dur-cancel" onclick="modCancelReason()">Cancel</button>
    </div>
  </div>
</div>

<!-- Moderation Panel -->
<div id="modPanel">
  <div class="mod-panel-box">
    <div class="mod-panel-header">
      <div class="mod-panel-title">🛡️ MODERATION</div>
      <button class="mod-panel-close" onclick="modClosePanel()">✕ CLOSE</button>
    </div>
    <div class="mod-panel-tabs">
      <div class="mod-panel-tab active" onclick="modSwitchTab('banned')">BANNED</div>
      <div class="mod-panel-tab" onclick="modSwitchTab('muted')">MUTED</div>
      <div class="mod-panel-tab" onclick="modSwitchTab('actions')">ACTIONS</div>
    </div>
    <div class="mod-panel-content" id="modPanelContent">
      <div class="mod-panel-empty">Loading...</div>
    </div>
  </div>
</div>

</body>
</html>
