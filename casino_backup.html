<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CASINO ROYALE</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.20.0/matter.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@300;400;600;700&display=swap');
*{margin:0;padding:0;box-sizing:border-box;}
:root{
  --bg:#0a0a1a;--surface:#111128;--surface2:#1a1a3e;--border:#2a2a5e;
  --gold:#ffd700;--neon:#00f0ff;--neon2:#ff00e5;--green:#00ff88;--red:#ff3355;
  --text:#e8e8ff;--text2:#8888aa;
}
html,body{height:100%;overflow:hidden;background:var(--bg);color:var(--text);font-family:'Inter',sans-serif;}

/* Top Nav */
#topNav{position:fixed;top:0;left:0;right:0;height:50px;background:linear-gradient(180deg,#15153a,#0d0d25);
  border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 10px;z-index:1000;gap:2px;}
#topNav .logo{font-family:'Orbitron';font-weight:900;font-size:16px;
  background:linear-gradient(135deg,var(--gold),var(--neon));-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;margin-right:6px;white-space:nowrap;flex-shrink:0;cursor:pointer;}
.nav-cat{position:relative;flex-shrink:0;}
.nav-cat-btn{padding:6px 10px;border:none;border-radius:6px;cursor:pointer;font-size:11px;font-weight:700;
  background:transparent;color:var(--text2);transition:all .2s;font-family:'Inter',sans-serif;white-space:nowrap;display:flex;align-items:center;gap:4px;}
.nav-cat-btn:hover,.nav-cat.open .nav-cat-btn{background:var(--surface2);color:var(--text);}
.nav-cat-btn .cat-icon{font-size:13px;}
.nav-cat-btn .cat-arrow{font-size:8px;opacity:.5;transition:transform .2s;}
.nav-cat.open .cat-arrow{transform:rotate(180deg);}
.nav-cat-btn.has-active{color:var(--neon);}
.nav-dropdown{display:none;position:absolute;top:100%;left:0;min-width:160px;background:linear-gradient(180deg,#1a1a40,#111130);
  border:1px solid var(--border);border-radius:8px;padding:4px;z-index:1001;box-shadow:0 8px 32px rgba(0,0,0,.6);margin-top:4px;}
.nav-cat.open .nav-dropdown{display:block;}
.nav-btn{padding:6px 10px;border:none;border-radius:6px;cursor:pointer;font-size:11px;font-weight:600;
  background:transparent;color:var(--text2);transition:all .15s;font-family:'Inter',sans-serif;white-space:nowrap;display:block;width:100%;text-align:left;}
.nav-btn:hover{background:var(--surface2);color:var(--text);}
.nav-btn.active{background:linear-gradient(135deg,#1a1a5e,#2a1a4e);color:var(--neon);
  box-shadow:0 0 15px rgba(0,240,255,.15);border:1px solid rgba(0,240,255,.3);}
.nav-btn .icon{font-size:13px;margin-right:5px;}
.nav-btn-inline{padding:6px 10px;border:none;border-radius:6px;cursor:pointer;font-size:11px;font-weight:600;
  background:transparent;color:var(--text2);transition:all .15s;font-family:'Inter',sans-serif;white-space:nowrap;flex-shrink:0;}
.nav-btn-inline:hover{background:var(--surface2);color:var(--text);}
.nav-btn-inline.active{background:linear-gradient(135deg,#1a1a5e,#2a1a4e);color:var(--neon);
  box-shadow:0 0 15px rgba(0,240,255,.15);border:1px solid rgba(0,240,255,.3);}
.nav-btn-inline .icon{font-size:13px;margin-right:3px;}
#balanceDisplay{margin-left:auto;display:flex;align-items:center;gap:8px;flex-shrink:0;}
#balanceDisplay .bal{font-family:'Orbitron';font-size:16px;color:var(--gold);text-shadow:0 0 10px rgba(255,215,0,.4);}
#balanceDisplay .add-btn{padding:5px 10px;border:none;border-radius:6px;cursor:pointer;
  background:linear-gradient(135deg,#1a5a1a,#0a3a0a);color:var(--green);font-weight:700;font-size:12px;
  border:1px solid rgba(0,255,136,.3);transition:all .2s;font-family:'Inter',sans-serif;}
#balanceDisplay .add-btn:hover{background:linear-gradient(135deg,#2a7a2a,#1a5a1a);box-shadow:0 0 15px rgba(0,255,136,.2);}
/* How-to-play info boxes */
.htp-box{background:linear-gradient(135deg,rgba(0,240,255,.05),rgba(255,0,229,.03));border:1px solid rgba(0,240,255,.15);
  border-radius:10px;padding:0;margin:6px 0;max-width:420px;overflow:hidden;font-size:12px;line-height:1.5;transition:all .3s;}
.htp-toggle{display:flex;align-items:center;gap:6px;padding:8px 12px;cursor:pointer;color:var(--neon);font-weight:600;font-size:11px;
  font-family:'Orbitron';letter-spacing:1px;background:transparent;border:none;width:100%;text-align:left;}
.htp-toggle:hover{background:rgba(0,240,255,.05);}
.htp-toggle .htp-arrow{transition:transform .2s;font-size:10px;}
.htp-box.open .htp-arrow{transform:rotate(90deg);}
.htp-content{display:none;padding:0 12px 10px 12px;color:var(--text2);}
.htp-box.open .htp-content{display:block;}
.htp-content ul{margin:4px 0 4px 16px;padding:0;}
.htp-content li{margin:2px 0;}
.htp-content strong{color:var(--text);}

/* Game Panels */
.game-panel{position:fixed;top:50px;left:0;right:0;bottom:0;display:none;overflow:hidden;}
.game-panel.active{display:flex;}

/* Shared Controls */
.bet-controls{display:flex;align-items:center;gap:10px;padding:12px 16px;background:var(--surface);
  border-radius:12px;border:1px solid var(--border);}
.bet-input{width:120px;padding:8px 12px;border-radius:8px;border:1px solid var(--border);
  background:var(--bg);color:var(--gold);font-family:'Orbitron';font-size:14px;text-align:right;outline:none;}
.bet-input:focus{border-color:var(--neon);box-shadow:0 0 10px rgba(0,240,255,.2);}
.bet-btn{padding:8px 14px;border:none;border-radius:6px;cursor:pointer;font-weight:700;font-size:12px;
  transition:all .15s;font-family:'Inter',sans-serif;}
.bet-half{background:#2a2a5e;color:var(--text);}
.bet-double{background:#2a2a5e;color:var(--text);}
.bet-half:hover,.bet-double:hover{background:#3a3a7e;}
.action-btn{padding:12px 32px;border:none;border-radius:10px;cursor:pointer;font-weight:700;font-size:15px;
  font-family:'Orbitron';transition:all .2s;text-transform:uppercase;letter-spacing:1px;}
.action-btn.primary{background:linear-gradient(135deg,#00cc66,#009944);color:#fff;
  box-shadow:0 4px 20px rgba(0,204,102,.3);}
.action-btn.primary:hover{transform:translateY(-2px);box-shadow:0 6px 25px rgba(0,204,102,.4);}
.action-btn.primary:active{transform:translateY(0);}
.action-btn:disabled{opacity:.4;cursor:not-allowed;transform:none!important;}
.action-btn.danger{background:linear-gradient(135deg,#cc3355,#991133);color:#fff;
  box-shadow:0 4px 20px rgba(204,51,85,.3);}

/* ============ SLOTS ============ */
#slotsPanel{flex-direction:column;align-items:center;justify-content:center;gap:24px;
  background:radial-gradient(ellipse at center,#15153a 0%,#0a0a1a 70%);}
.slots-machine{position:relative;background:linear-gradient(180deg,#1a1a4e,#111138);
  border-radius:20px;border:2px solid var(--border);padding:30px;
  box-shadow:0 0 60px rgba(0,240,255,.08),inset 0 0 60px rgba(0,0,0,.5);}
.slots-header{text-align:center;font-family:'Orbitron';font-size:28px;font-weight:900;
  background:linear-gradient(135deg,var(--gold),#ff8800);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;
  margin-bottom:20px;text-shadow:0 0 20px rgba(255,215,0,.3);}
.reels-container{display:flex;gap:8px;justify-content:center;margin-bottom:20px;position:relative;}
.reel-window{width:100px;height:280px;overflow:hidden;border-radius:12px;
  background:#08081a;border:2px solid var(--border);position:relative;}
.reel-window::before,.reel-window::after{content:'';position:absolute;left:0;right:0;height:40%;z-index:2;pointer-events:none;}
.reel-window::before{top:0;background:linear-gradient(180deg,rgba(8,8,26,.95),transparent);}
.reel-window::after{bottom:0;background:linear-gradient(0deg,rgba(8,8,26,.95),transparent);}
.reel-strip{display:flex;flex-direction:column;transition:transform .5s cubic-bezier(.2,.8,.3,1);}
.reel-symbol{width:100px;height:93px;display:flex;align-items:center;justify-content:center;font-size:48px;}
.payline-indicator{position:absolute;left:-8px;right:-8px;top:50%;transform:translateY(-50%);
  height:3px;background:var(--gold);box-shadow:0 0 10px var(--gold);z-index:3;border-radius:2px;}
.slots-info{text-align:center;color:var(--text2);font-size:13px;margin-top:8px;}

/* ============ CRASH ============ */
#crashPanel{flex-direction:column;align-items:center;justify-content:center;gap:20px;
  background:radial-gradient(ellipse at bottom,#0a1a2a 0%,#0a0a1a 70%);}
.crash-container{position:relative;width:min(700px,90vw);height:min(400px,50vh);
  background:var(--surface);border-radius:16px;border:1px solid var(--border);overflow:hidden;}
.crash-canvas{width:100%;height:100%;}
.crash-multiplier{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
  font-family:'Orbitron';font-weight:900;font-size:72px;color:#fff;text-shadow:0 0 40px rgba(0,240,255,.5);
  pointer-events:none;transition:color .3s;}
.crash-multiplier.crashed{color:var(--red);text-shadow:0 0 40px rgba(255,51,85,.5);animation:crashShake .3s ease;}
.crash-status{font-family:'Orbitron';font-size:14px;color:var(--text2);text-align:center;}
@keyframes crashShake{0%,100%{transform:translate(-50%,-50%)}25%{transform:translate(-48%,-52%)}75%{transform:translate(-52%,-48%)}}

/* ============ ROULETTE ============ */
#roulettePanel{flex-direction:column;align-items:center;justify-content:center;gap:20px;
  background:radial-gradient(ellipse at center,#1a0a1a 0%,#0a0a1a 70%);}
.roulette-wrapper{position:relative;}
.roulette-canvas{border-radius:50%;box-shadow:0 0 60px rgba(255,0,229,.15),0 0 120px rgba(255,0,229,.05);}
.roulette-pointer{position:absolute;top:-18px;left:50%;transform:translateX(-50%);
  width:0;height:0;border-left:14px solid transparent;border-right:14px solid transparent;
  border-top:24px solid var(--gold);filter:drop-shadow(0 0 8px rgba(255,215,0,.6));z-index:5;}
.roulette-result{font-family:'Orbitron';font-size:24px;font-weight:700;text-align:center;min-height:36px;}
.roulette-bets{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;max-width:500px;}
.roul-bet-btn{padding:10px 20px;border:2px solid var(--border);border-radius:8px;cursor:pointer;
  font-weight:700;font-size:14px;transition:all .2s;background:var(--surface);color:var(--text);font-family:'Inter',sans-serif;}
.roul-bet-btn:hover{border-color:var(--neon);box-shadow:0 0 15px rgba(0,240,255,.15);}
.roul-bet-btn.selected{border-color:var(--neon);background:rgba(0,240,255,.1);color:var(--neon);}
.roul-bet-btn.red-btn{border-color:#cc3333;}
.roul-bet-btn.red-btn.selected{background:rgba(204,51,51,.2);color:#ff5555;border-color:#ff5555;}
.roul-bet-btn.black-btn{border-color:#444;}
.roul-bet-btn.black-btn.selected{background:rgba(255,255,255,.1);color:#fff;border-color:#888;}
.roul-bet-btn.green-btn{border-color:#00aa44;}
.roul-bet-btn.green-btn.selected{background:rgba(0,170,68,.2);color:var(--green);border-color:var(--green);}

/* ============ CASES ============ */
#casesPanel{flex-direction:column;align-items:center;justify-content:center;gap:14px;
  background:radial-gradient(ellipse at top,#1a1a0a 0%,#0a0a1a 70%);overflow-y:auto;padding:70px 16px 20px!important;}
.case-selector{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;}
.case-card{width:120px;padding:12px 8px;border-radius:12px;border:2px solid var(--border);
  background:var(--surface);cursor:pointer;text-align:center;transition:all .2s;}
.case-card:hover{transform:translateY(-4px);border-color:var(--gold);}
.case-card.selected{border-color:var(--gold);box-shadow:0 0 20px rgba(255,215,0,.2);}
.case-card .case-icon{font-size:32px;margin-bottom:4px;}
.case-card .case-name{font-weight:700;font-size:12px;margin-bottom:2px;}
.case-card .case-price{color:var(--gold);font-family:'Orbitron';font-size:11px;}
.case-opener{position:relative;width:min(700px,92vw);height:120px;background:var(--surface);
  border-radius:12px;border:1px solid var(--border);overflow:hidden;}
.case-strip{display:flex;position:absolute;top:0;height:100%;transition:transform 4s cubic-bezier(.08,.82,.17,1);}
.case-item{width:120px;height:120px;display:flex;flex-direction:column;align-items:center;justify-content:center;
  flex-shrink:0;border-right:1px solid var(--border);font-size:11px;font-weight:700;gap:2px;position:relative;}
.case-item .item-icon{font-size:36px;}
.case-item .item-rarity{position:absolute;bottom:0;left:0;right:0;height:3px;}
.case-pointer{position:absolute;top:0;bottom:0;left:50%;transform:translateX(-50%);
  width:3px;background:var(--gold);box-shadow:0 0 10px var(--gold);z-index:5;}
.case-won{font-family:'Orbitron';font-size:18px;font-weight:700;text-align:center;min-height:32px;}
.case-won-detail{font-size:11px;color:var(--text2);text-align:center;}

/* Item Rarity Colors */
.rarity-consumer{color:#b0c3d9!important;}
.rarity-industrial{color:#5e98d9!important;}
.rarity-milspec{color:#4b69ff!important;}
.rarity-restricted{color:#8847ff!important;}
.rarity-classified{color:#d32ce6!important;}
.rarity-covert{color:#eb4b4b!important;}
.rarity-legendary{color:#ffd700!important;}

/* ============ INVENTORY OVERLAY ============ */
#inventoryOverlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.85);
  z-index:2000;display:none;flex-direction:column;align-items:center;padding:20px;overflow-y:auto;}
#inventoryOverlay.show{display:flex;}
.inv-header{display:flex;align-items:center;justify-content:space-between;width:100%;max-width:900px;
  margin-bottom:16px;}
.inv-title{font-family:'Orbitron';font-size:22px;font-weight:900;
  background:linear-gradient(135deg,var(--gold),var(--neon));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.inv-close{padding:8px 20px;border:1px solid var(--border);border-radius:8px;background:var(--surface);
  color:var(--text);cursor:pointer;font-weight:700;font-size:14px;transition:all .2s;}
.inv-close:hover{border-color:var(--red);color:var(--red);}
.inv-tabs{display:flex;gap:8px;margin-bottom:16px;}
.inv-tab{padding:8px 18px;border:1px solid var(--border);border-radius:8px;background:var(--surface);
  color:var(--text2);cursor:pointer;font-weight:600;font-size:13px;transition:all .2s;}
.inv-tab.active{border-color:var(--neon);color:var(--neon);background:rgba(0,240,255,.08);}
.inv-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px;
  width:100%;max-width:900px;}
.inv-item{background:var(--surface);border:1px solid var(--border);border-radius:10px;
  padding:12px;text-align:center;cursor:pointer;transition:all .2s;position:relative;}
.inv-item:hover{border-color:var(--gold);transform:translateY(-2px);}
.inv-item .ii-icon{font-size:32px;margin-bottom:4px;}
.inv-item .ii-name{font-size:11px;font-weight:700;margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.inv-item .ii-value{font-family:'Orbitron';font-size:12px;color:var(--gold);}
.inv-item .ii-demand{font-size:9px;margin-top:2px;}
.inv-item .ii-rarity-bar{position:absolute;bottom:0;left:0;right:0;height:3px;border-radius:0 0 10px 10px;}
.inv-sell-btn{margin-top:6px;padding:4px 12px;border:none;border-radius:4px;font-size:10px;
  font-weight:700;cursor:pointer;background:var(--red);color:#fff;transition:all .15s;}
.inv-sell-btn:hover{background:#ff4466;}
.inv-empty{grid-column:1/-1;text-align:center;padding:40px;color:var(--text2);font-size:14px;}

/* Market stats */
.market-stats{display:flex;gap:16px;align-items:center;justify-content:center;width:100%;max-width:900px;
  margin-bottom:12px;padding:10px;background:var(--surface);border-radius:10px;border:1px solid var(--border);}
.market-stat{text-align:center;}
.market-stat .ms-label{font-size:9px;color:var(--text2);text-transform:uppercase;letter-spacing:1px;}
.market-stat .ms-val{font-family:'Orbitron';font-size:14px;font-weight:700;}

/* ============ PLINKO ============ */
#plinkoPanel{flex-direction:row;background:radial-gradient(ellipse at center,#0a1a2a 0%,#0a0a1a 70%);}
.plinko-sidebar{width:280px;padding:20px;display:flex;flex-direction:column;gap:16px;
  background:var(--surface);border-right:1px solid var(--border);overflow-y:auto;}
.plinko-sidebar label{font-size:13px;font-weight:600;color:var(--text2);margin-bottom:4px;display:block;}
.plinko-sidebar select,.plinko-sidebar input[type="number"]{width:100%;padding:8px 12px;border-radius:8px;
  border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:14px;outline:none;font-family:'Inter',sans-serif;}
.plinko-sidebar select:focus,.plinko-sidebar input:focus{border-color:var(--neon);}
.plinko-main{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative;}
.plinko-canvas-wrap{position:relative;width:760px;max-width:calc(100vw - 320px);height:570px;}
#plinkoCanvas{border-radius:12px;display:block;}
.plinko-bins{display:flex;gap:1%;justify-content:center;margin:4px auto 0;}
.plinko-bin{flex:1;text-align:center;padding:4px 0;border-radius:4px;font-size:11px;font-weight:700;
  color:#111;transition:transform .2s;min-width:0;}
.plinko-bin.bounce{animation:binBounce .3s ease;}
@keyframes binBounce{0%{transform:translateY(0)}50%{transform:translateY(30%)}100%{transform:translateY(0)}}
.plinko-last-wins{position:absolute;right:16px;top:50%;transform:translateY(-50%);
  display:flex;flex-direction:column;gap:0;width:48px;overflow:hidden;border-radius:6px;}
.plinko-last-win{width:48px;height:48px;display:flex;align-items:center;justify-content:center;
  font-size:12px;font-weight:700;color:#111;}

/* ============ PUSH YOUR LUCK ============ */
#luckPanel{flex-direction:column;align-items:center;justify-content:flex-start;gap:0;
  background:#000;padding:0!important;overflow:hidden;}
#luckPanel iframe{width:100%;height:100%;border:none;position:absolute;top:0;left:0;z-index:1;}

/* PYL Lobby Overlay */
.pyl-lobby{position:absolute;top:0;left:0;right:0;bottom:0;z-index:10;
  background:radial-gradient(ellipse at top,#1a0a2e 0%,#0a0a1a 60%,#000 100%);
  display:flex;flex-direction:column;align-items:center;padding:80px 20px 20px;overflow-y:auto;}
.pyl-lobby.hidden{display:none;}
.pyl-title{font-family:'Orbitron';font-size:28px;font-weight:900;text-align:center;
  background:linear-gradient(135deg,#ff6b6b,#ffd93d,#6bcb77,#4d96ff);
  -webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:6px;}
.pyl-subtitle{color:var(--text2);font-size:13px;margin-bottom:24px;text-align:center;}
.pyl-modes{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;
  width:100%;max-width:660px;margin-bottom:20px;}
.pyl-mode{background:var(--surface);border:2px solid var(--border);border-radius:14px;
  padding:18px;cursor:pointer;transition:all .25s;text-align:center;}
.pyl-mode:hover{border-color:var(--neon);transform:translateY(-3px);
  box-shadow:0 8px 30px rgba(0,240,255,.15);}
.pyl-mode .pm-icon{font-size:36px;margin-bottom:6px;}
.pyl-mode .pm-name{font-family:'Orbitron';font-size:14px;font-weight:700;margin-bottom:4px;}
.pyl-mode .pm-desc{font-size:11px;color:var(--text2);line-height:1.4;}
.pyl-mode .pm-badge{display:inline-block;margin-top:6px;padding:3px 10px;border-radius:20px;
  font-size:10px;font-weight:700;background:rgba(0,240,255,.1);color:var(--neon);border:1px solid var(--neon);}

/* PYL Game Overlay */
.pyl-overlay{position:absolute;top:60px;right:10px;z-index:15;display:flex;flex-direction:column;gap:6px;
  pointer-events:none;}
.pyl-overlay.hidden{display:none;}
.pyl-score-card{background:rgba(10,10,26,.9);border:1px solid var(--border);border-radius:10px;
  padding:10px 14px;pointer-events:auto;min-width:160px;}
.pyl-score-card .psc-label{font-size:9px;color:var(--text2);text-transform:uppercase;letter-spacing:1px;}
.pyl-score-card .psc-val{font-family:'Orbitron';font-size:16px;font-weight:700;}
.pyl-back-btn{pointer-events:auto;padding:8px 16px;border:1px solid var(--border);border-radius:8px;
  background:rgba(10,10,26,.9);color:var(--text);cursor:pointer;font-weight:600;font-size:12px;
  transition:all .2s;text-align:center;}
.pyl-back-btn:hover{border-color:var(--red);color:var(--red);}

/* PYL Leaderboard */
.pyl-leaderboard{width:100%;max-width:660px;}
.pyl-lb-title{font-family:'Orbitron';font-size:16px;font-weight:700;color:var(--gold);margin-bottom:10px;}
.pyl-lb-row{display:flex;align-items:center;gap:10px;padding:8px 12px;background:var(--surface);
  border:1px solid var(--border);border-radius:8px;margin-bottom:4px;font-size:13px;}
.pyl-lb-row .lb-rank{font-family:'Orbitron';font-weight:900;width:30px;text-align:center;color:var(--gold);}
.pyl-lb-row .lb-name{flex:1;font-weight:600;}
.pyl-lb-row .lb-score{font-family:'Orbitron';font-weight:700;color:var(--neon);}
.pyl-lb-row .lb-wager{font-size:11px;color:var(--gold);}

/* 1v1 Room */
.pyl-room{width:100%;max-width:500px;background:var(--surface);border:1px solid var(--border);
  border-radius:14px;padding:20px;text-align:center;}
.pyl-room .pr-title{font-family:'Orbitron';font-size:18px;font-weight:700;margin-bottom:12px;}
.pyl-room .pr-code{font-family:'Orbitron';font-size:28px;font-weight:900;color:var(--neon);
  letter-spacing:6px;margin:10px 0;padding:12px;background:rgba(0,240,255,.05);
  border:1px dashed var(--neon);border-radius:8px;}
.pyl-room .pr-status{color:var(--text2);font-size:13px;margin:8px 0;}
.pyl-room .pr-players{display:flex;gap:16px;justify-content:center;margin:12px 0;}
.pyl-room .pr-player{padding:8px 16px;border:1px solid var(--border);border-radius:8px;
  background:rgba(255,255,255,.03);font-weight:600;}
.pyl-room .pr-player.ready{border-color:var(--green);color:var(--green);}
.pyl-vs{font-family:'Orbitron';font-weight:900;font-size:20px;color:var(--red);}

/* ============ STOCKS ============ */
#stocksPanel{flex-direction:column;align-items:center;gap:0;overflow-y:auto;
  padding:70px 16px 20px!important;background:radial-gradient(ellipse at top,#0f1923 0%,#080c10 70%);}
.stock-hero{text-align:center;margin-bottom:6px;}
.stock-hero .sh-ticker{font-family:'Orbitron';font-size:14px;font-weight:700;color:#58a6ff;
  letter-spacing:3px;text-transform:uppercase;}
.stock-hero .sh-price{font-family:'Orbitron';font-size:42px;font-weight:900;color:#e6edf3;
  text-shadow:0 0 30px rgba(88,166,255,.15);margin:4px 0;line-height:1;}
.stock-hero .sh-change{font-size:14px;font-weight:700;}
.stock-hero .sh-change.up{color:#3fb950;}
.stock-hero .sh-change.down{color:#f85149;}
.stock-chart-wrap{width:100%;max-width:600px;height:220px;position:relative;border-radius:12px;
  overflow:hidden;background:#0d1117;border:1px solid #1e2933;margin:8px 0;}
#stockChart{width:100%;height:100%;display:block;}
.stock-portfolio{display:flex;gap:20px;align-items:center;justify-content:center;
  width:100%;max-width:600px;padding:12px 0;}
.stock-portfolio .sp-stat{text-align:center;}
.stock-portfolio .sp-label{font-size:10px;color:#8b949e;text-transform:uppercase;letter-spacing:1px;margin-bottom:2px;}
.stock-portfolio .sp-val{font-family:'Orbitron';font-size:16px;font-weight:700;color:#e6edf3;}
.stock-actions-row{display:flex;gap:10px;align-items:center;justify-content:center;
  width:100%;max-width:600px;margin-top:4px;}
.stock-actions-row .sa-btn{flex:1;padding:14px 8px;border:none;border-radius:12px;cursor:pointer;
  font-weight:900;font-size:15px;font-family:'Orbitron';transition:all .2s;text-transform:uppercase;
  letter-spacing:1px;max-width:180px;}
.sa-buy{background:linear-gradient(180deg,#2ea043,#1a7f37);color:#fff;
  box-shadow:0 4px 20px rgba(46,160,67,.3);}
.sa-buy:hover{transform:translateY(-2px);box-shadow:0 6px 25px rgba(46,160,67,.5);}
.sa-sell{background:linear-gradient(180deg,#f85149,#da3633);color:#fff;
  box-shadow:0 4px 20px rgba(248,81,73,.3);}
.sa-sell:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 6px 25px rgba(248,81,73,.5);}
.sa-sell:disabled{opacity:.25;cursor:not-allowed;transform:none!important;}
.stock-amt-row{display:flex;align-items:center;gap:8px;justify-content:center;margin-top:8px;}
.stock-live-dot{display:inline-block;width:8px;height:8px;border-radius:50%;background:#3fb950;
  animation:stockPulse 1.5s infinite;margin-right:6px;vertical-align:middle;}
@keyframes stockPulse{0%,100%{opacity:1;box-shadow:0 0 4px #3fb950}50%{opacity:.4;box-shadow:0 0 8px #3fb950}}

/* Particles */
#particles{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:9999;}

/* Win Toast */
.win-toast{position:fixed;top:80px;left:50%;transform:translateX(-50%) translateY(-20px);
  background:linear-gradient(135deg,#1a3a1a,#0a2a0a);border:1px solid var(--green);
  border-radius:12px;padding:16px 32px;font-family:'Orbitron';font-size:20px;color:var(--green);
  box-shadow:0 0 30px rgba(0,255,136,.3);opacity:0;transition:all .4s;z-index:10000;pointer-events:none;white-space:nowrap;}
.win-toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
.win-toast.loss{background:linear-gradient(135deg,#3a1a1a,#2a0a0a);border-color:var(--red);color:var(--red);
  box-shadow:0 0 30px rgba(255,51,85,.3);}

/* Responsive */
@media(max-width:768px){
  .plinko-sidebar{width:200px;padding:12px;}
  .slots-machine{padding:16px;}
  .reel-window{width:70px;height:200px;}
  .reel-symbol{width:70px;height:66px;font-size:36px;}
}

/* Scrollbar */
::-webkit-scrollbar{width:6px;}
::-webkit-scrollbar-track{background:var(--bg);}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}

/* ============ LOGIN SCREEN ============ */
#loginScreen{position:fixed;inset:0;z-index:99999;display:flex;align-items:center;justify-content:center;
  background:linear-gradient(135deg,#0a0a2e 0%,#1a0a3e 40%,#0a0a1a 100%);overflow:hidden;}
#loginScreen .login-bg-particles{position:absolute;inset:0;overflow:hidden;pointer-events:none;}
#loginScreen .login-bg-particles div{position:absolute;width:3px;height:3px;background:var(--gold);
  border-radius:50%;animation:loginFloat linear infinite;opacity:.4;}
@keyframes loginFloat{0%{transform:translateY(100vh) scale(0)}50%{opacity:1}100%{transform:translateY(-100px) scale(1);opacity:0;}}
.login-box{position:relative;z-index:1;width:380px;padding:40px 36px;
  background:linear-gradient(180deg,rgba(20,20,60,.95),rgba(12,12,30,.98));
  border:1px solid var(--border);border-radius:20px;
  box-shadow:0 0 80px rgba(255,215,0,.08),0 0 200px rgba(0,240,255,.05);text-align:center;}
.login-logo{font-family:'Orbitron';font-weight:900;font-size:36px;
  background:linear-gradient(135deg,var(--gold),var(--neon));-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;
  margin-bottom:4px;letter-spacing:3px;}
.login-subtitle{font-size:13px;color:var(--text2);margin-bottom:28px;letter-spacing:1px;}
.login-input{width:100%;padding:14px 16px;border-radius:10px;border:1px solid var(--border);
  background:rgba(10,10,30,.8);color:var(--text);font-family:'Inter',sans-serif;font-size:15px;
  outline:none;transition:all .2s;margin-bottom:12px;}
.login-input:focus{border-color:var(--neon);box-shadow:0 0 15px rgba(0,240,255,.15);}
.login-input::placeholder{color:#555;}
.login-btn{width:100%;padding:14px;border:none;border-radius:10px;cursor:pointer;
  font-family:'Orbitron';font-weight:700;font-size:15px;letter-spacing:2px;
  transition:all .25s;margin-top:4px;}
.login-btn.primary{background:linear-gradient(135deg,#ffd700,#ff8c00);color:#0a0a1a;
  box-shadow:0 4px 20px rgba(255,215,0,.3);}
.login-btn.primary:hover{transform:translateY(-2px);box-shadow:0 6px 30px rgba(255,215,0,.5);}
.login-btn.secondary{background:transparent;border:1px solid var(--border);color:var(--text2);margin-top:8px;}
.login-btn.secondary:hover{border-color:var(--neon);color:var(--neon);}
.login-error{color:var(--red);font-size:12px;margin-top:8px;min-height:16px;}
.login-toggle{margin-top:16px;font-size:13px;color:var(--text2);}
.login-toggle a{color:var(--neon);cursor:pointer;text-decoration:none;font-weight:600;}
.login-toggle a:hover{text-decoration:underline;}

/* User display in nav */
.user-info{display:flex;align-items:center;gap:8px;margin-left:8px;}
.user-avatar{width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,var(--neon),var(--neon2));
  display:flex;align-items:center;justify-content:center;font-weight:900;font-size:14px;color:#fff;
  border:2px solid rgba(0,240,255,.3);text-transform:uppercase;}
.user-name{font-family:'Orbitron';font-size:12px;color:var(--neon);font-weight:700;}
.logout-btn{padding:4px 10px;border:1px solid rgba(255,51,85,.3);border-radius:6px;
  background:transparent;color:var(--red);cursor:pointer;font-size:11px;font-weight:600;
  transition:all .2s;font-family:'Inter',sans-serif;}
.logout-btn:hover{background:rgba(255,51,85,.1);border-color:var(--red);}

/* Global Leaderboard Tab */
#leaderboardPanel{flex-direction:column;align-items:center;gap:16px;overflow-y:auto;
  padding:80px 20px 20px;background:radial-gradient(ellipse at top,#1a1a40 0%,#0a0a1a 70%);}
.lb-container{width:100%;max-width:700px;}
.lb-tabs{display:flex;gap:4px;margin-bottom:16px;flex-wrap:wrap;justify-content:center;}
.lb-tab{padding:8px 16px;border:1px solid var(--border);border-radius:8px;background:transparent;
  color:var(--text2);cursor:pointer;font-weight:600;font-size:12px;transition:all .2s;
  font-family:'Inter',sans-serif;}
.lb-tab:hover{border-color:var(--neon);color:var(--text);}
.lb-tab.active{background:linear-gradient(135deg,#1a1a5e,#2a1a4e);color:var(--gold);
  border-color:rgba(255,215,0,.4);box-shadow:0 0 12px rgba(255,215,0,.1);}
.lb-table{width:100%;}
.lb-header-row{display:flex;padding:10px 16px;font-size:11px;font-weight:700;color:var(--text2);
  text-transform:uppercase;letter-spacing:1px;border-bottom:1px solid var(--border);}
.lb-data-row{display:flex;align-items:center;padding:12px 16px;background:var(--surface);
  border:1px solid var(--border);border-radius:10px;margin-bottom:4px;transition:all .2s;}
.lb-data-row:hover{border-color:var(--neon);background:rgba(0,240,255,.03);}
.lb-data-row.me{border-color:var(--gold);background:rgba(255,215,0,.05);}
.lb-col-rank{width:40px;font-family:'Orbitron';font-weight:900;font-size:14px;color:var(--gold);}
.lb-col-name{flex:1;font-weight:600;font-size:14px;}
.lb-col-val{width:120px;text-align:right;font-family:'Orbitron';font-weight:700;font-size:13px;color:var(--neon);}
.lb-col-extra{width:100px;text-align:right;font-size:12px;color:var(--text2);}
.lb-empty{text-align:center;padding:30px;color:var(--text2);font-size:13px;}

/* Daily bonus */
.daily-bonus-btn{padding:6px 12px;border:none;border-radius:6px;cursor:pointer;
  background:linear-gradient(135deg,#ffd700,#ff8c00);color:#0a0a1a;font-weight:800;font-size:12px;
  font-family:'Orbitron';animation:dailyPulse 2s infinite;transition:all .2s;}
.daily-bonus-btn:hover{transform:scale(1.05);}
.daily-bonus-btn:disabled{opacity:.4;animation:none;cursor:not-allowed;transform:none!important;
  background:var(--surface2);color:var(--text2);}
@keyframes dailyPulse{0%,100%{box-shadow:0 0 10px rgba(255,215,0,.3)}50%{box-shadow:0 0 25px rgba(255,215,0,.6)}}

/* ============ BLACKJACK ============ */
#blackjackPanel{flex-direction:column;align-items:center;justify-content:center;gap:14px;background:radial-gradient(ellipse at top,#0a2a0a 0%,#0a0a1a 70%);}
.bj-table{width:min(560px,90vw);min-height:260px;background:linear-gradient(180deg,#0d4a0d,#0a380a);border-radius:18px;border:3px solid #1a6a1a;padding:18px;box-shadow:inset 0 0 40px rgba(0,0,0,.5);}
.bj-area{min-height:85px;display:flex;flex-wrap:wrap;gap:5px;align-items:center;justify-content:center;padding:5px;}
.bj-label{font-family:'Orbitron';font-size:11px;color:rgba(255,255,255,.5);margin-bottom:2px;}
.bj-score{font-family:'Orbitron';font-size:15px;font-weight:700;display:inline;margin-left:6px;}
.bj-card{width:52px;height:74px;border-radius:7px;background:#fff;color:#111;display:inline-flex;flex-direction:column;align-items:center;justify-content:center;font-size:15px;font-weight:900;box-shadow:0 2px 8px rgba(0,0,0,.3);border:1px solid #ddd;}
.bj-card.red{color:#cc2233;}
.bj-card.hidden{background:linear-gradient(135deg,#1a1a8e,#2a1a6e);color:transparent;background-image:repeating-linear-gradient(45deg,transparent,transparent 5px,rgba(255,255,255,.05) 5px,rgba(255,255,255,.05) 10px);}
#bjResult{font-family:'Orbitron';font-size:15px;font-weight:700;min-height:22px;text-align:center;}

/* ============ MINES ============ */
#minesPanel{flex-direction:column;align-items:center;justify-content:center;gap:14px;background:radial-gradient(ellipse at center,#1a1a0a 0%,#0a0a1a 70%);}
.mines-wrap{display:flex;gap:14px;align-items:flex-start;}
.mines-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:4px;}
.mine-cell{width:58px;height:58px;border-radius:8px;border:2px solid var(--border);background:var(--surface);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:24px;transition:all .15s;}
.mine-cell:hover:not(.revealed){background:var(--surface2);border-color:var(--neon);transform:scale(1.05);}
.mine-cell.revealed.safe{background:#0a2a0a;border-color:var(--green);}
.mine-cell.revealed.mine{background:#2a0a0a;border-color:var(--red);}
.mines-side{width:170px;display:flex;flex-direction:column;gap:8px;padding:12px;background:var(--surface);border-radius:10px;border:1px solid var(--border);}
.mines-side label{font-size:11px;color:var(--text2);font-weight:600;}
.mines-side select,.mines-side input{width:100%;padding:6px;border-radius:6px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:12px;}
#minesMultiplier{font-family:'Orbitron';font-size:15px;font-weight:700;text-align:center;}
#minesProfit{font-size:11px;text-align:center;color:var(--text2);}

/* ============ DICE ============ */
#dicePanel{flex-direction:column;align-items:center;justify-content:center;gap:14px;background:radial-gradient(ellipse at top,#1a0a2a 0%,#0a0a1a 70%);}
.dice-roll-display{font-family:'Orbitron';font-size:60px;font-weight:900;min-height:74px;text-shadow:0 0 30px rgba(0,240,255,.4);}
.dice-slider-wrap{width:min(480px,85vw);}
.dice-slider{width:100%;-webkit-appearance:none;appearance:none;height:8px;border-radius:4px;outline:none;}
.dice-slider::-webkit-slider-thumb{-webkit-appearance:none;width:22px;height:22px;border-radius:50%;background:var(--gold);cursor:pointer;box-shadow:0 0 10px rgba(255,215,0,.5);}
.dice-info{display:flex;justify-content:space-between;width:min(480px,85vw);font-size:12px;color:var(--text2);}
.dice-info span{font-family:'Orbitron';font-weight:700;}
.dice-mode-btns{display:flex;gap:6px;}
.dice-mode-btn{padding:5px 12px;border:1px solid var(--border);border-radius:6px;background:var(--surface);color:var(--text2);cursor:pointer;font-weight:700;font-size:11px;transition:all .2s;}
.dice-mode-btn.active{border-color:var(--neon);color:var(--neon);background:rgba(0,240,255,.08);}

/* ============ TOWER ============ */
#towerPanel{flex-direction:column;align-items:center;justify-content:center;gap:10px;background:radial-gradient(ellipse at bottom,#1a1a2e 0%,#0a0a1a 70%);}
.tower-grid{display:flex;flex-direction:column-reverse;gap:3px;padding:8px;background:var(--surface);border-radius:10px;border:1px solid var(--border);}
.tower-row{display:flex;gap:3px;}
.tower-cell{width:66px;height:38px;border-radius:6px;border:2px solid var(--border);background:var(--surface2);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;transition:all .15s;}
.tower-cell:hover:not(.revealed):not(.locked){border-color:var(--neon);}
.tower-cell.revealed.safe{background:#0a2a0a;border-color:var(--green);}
.tower-cell.revealed.trap{background:#2a0a0a;border-color:var(--red);}
.tower-cell.locked{opacity:.3;cursor:default;}
.tower-cell.current-row{border-color:var(--neon);opacity:1;}
#towerInfo{font-family:'Orbitron';font-size:13px;text-align:center;}

/* ============ COIN FLIP ============ */
#coinflipPanel{flex-direction:column;align-items:center;justify-content:center;gap:18px;background:radial-gradient(ellipse at center,#1a1a2e 0%,#0a0a1a 70%);}
.coin{width:120px;height:120px;border-radius:50%;font-size:52px;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#ffd700,#ff8c00);color:#333;box-shadow:0 0 40px rgba(255,215,0,.3);font-weight:900;}
.coin.flip{animation:coinSpin .8s ease-out;}@keyframes coinSpin{0%{transform:rotateY(0)}100%{transform:rotateY(1800deg)}}
.coin-choices{display:flex;gap:10px;}
.coin-choice{padding:10px 24px;border:2px solid var(--border);border-radius:10px;background:var(--surface);color:var(--text);cursor:pointer;font-size:15px;font-weight:700;transition:all .2s;}
.coin-choice:hover{border-color:var(--gold);}
.coin-choice.selected{border-color:var(--gold);background:rgba(255,215,0,.12);color:var(--gold);}
#coinResult{font-family:'Orbitron';font-size:16px;font-weight:700;min-height:24px;}

/* ============ KENO ============ */
#kenoPanel{flex-direction:column;align-items:center;justify-content:center;gap:10px;background:radial-gradient(ellipse at top,#0a1a2a 0%,#0a0a1a 70%);}
.keno-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:3px;}
.keno-num{width:46px;height:38px;border-radius:5px;border:1px solid var(--border);background:var(--surface);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;transition:all .15s;}
.keno-num:hover:not(.drawn){background:var(--surface2);}
.keno-num.selected{background:rgba(0,240,255,.12);border-color:var(--neon);color:var(--neon);}
.keno-num.drawn{border-color:var(--gold);color:var(--gold);}
.keno-num.hit{background:#0a2a0a!important;border-color:var(--green)!important;color:var(--green)!important;}
.keno-num.miss{opacity:.35;}
#kenoInfo{font-size:11px;color:var(--text2);text-align:center;}
#kenoResult{font-family:'Orbitron';font-size:15px;font-weight:700;min-height:22px;text-align:center;}

/* ============ LIMBO ============ */
#limboPanel{flex-direction:column;align-items:center;justify-content:center;gap:18px;background:radial-gradient(ellipse at center,#0a0a2a 0%,#0a0a1a 70%);}
#limboResult{font-family:'Orbitron';font-size:60px;font-weight:900;min-height:74px;transition:color .3s;text-shadow:0 0 30px rgba(0,240,255,.3);}
.limbo-target-wrap{display:flex;align-items:center;gap:10px;}
.limbo-target-wrap label{font-size:12px;color:var(--text2);font-weight:600;}
#limboTarget{width:85px;padding:7px;border-radius:7px;border:1px solid var(--border);background:var(--bg);color:var(--neon);font-family:'Orbitron';font-size:15px;text-align:center;}
#limboPayout{font-size:12px;color:var(--text2);}

/* ============ VIDEO POKER ============ */
#pokerPanel{flex-direction:column;align-items:center;justify-content:center;gap:12px;background:radial-gradient(ellipse at top,#0a1a0a 0%,#0a0a1a 70%);}
.poker-hand{display:flex;gap:6px;justify-content:center;flex-wrap:wrap;}
.poker-card{width:72px;height:100px;border-radius:9px;background:#fff;color:#111;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:17px;font-weight:900;cursor:pointer;transition:all .2s;box-shadow:0 4px 12px rgba(0,0,0,.3);border:2px solid transparent;position:relative;}
.poker-card.red{color:#cc2233;}
.poker-card.held{border-color:var(--gold);transform:translateY(-10px);box-shadow:0 8px 20px rgba(255,215,0,.3);}
.poker-card .held-tag{position:absolute;top:-8px;font-size:8px;font-weight:700;color:var(--gold);font-family:'Orbitron';background:var(--bg);padding:1px 4px;border-radius:3px;border:1px solid var(--gold);}
.poker-paytable{display:grid;grid-template-columns:auto auto;gap:1px 10px;font-size:10px;background:var(--surface);padding:6px 10px;border-radius:7px;border:1px solid var(--border);}
.poker-paytable .pt-h{color:var(--text2);}
.poker-paytable .pt-v{color:var(--gold);font-family:'Orbitron';text-align:right;}
#pokerResult{font-family:'Orbitron';font-size:15px;font-weight:700;min-height:22px;text-align:center;}

/* ============ HORSE RACING ============ */
#horsesPanel{flex-direction:column;align-items:center;justify-content:center;gap:12px;background:radial-gradient(ellipse at bottom,#1a0a0a 0%,#0a0a1a 70%);}
.horse-track{width:min(620px,90vw);background:var(--surface);border-radius:10px;border:1px solid var(--border);padding:10px;}
.horse-lane{display:flex;align-items:center;gap:6px;padding:4px 0;border-bottom:1px solid rgba(255,255,255,.05);}
.horse-lane:last-child{border-bottom:none;}
.horse-name{width:65px;font-size:11px;font-weight:700;}
.horse-bar{flex:1;height:24px;background:var(--bg);border-radius:5px;position:relative;overflow:hidden;}
.horse-progress{height:100%;border-radius:5px;transition:width .3s;position:absolute;left:0;top:0;}
.horse-emoji{position:absolute;right:-2px;top:-3px;font-size:24px;}
.horse-odds{width:44px;text-align:right;font-family:'Orbitron';font-size:10px;color:var(--gold);}
.horse-bets{display:flex;gap:4px;flex-wrap:wrap;justify-content:center;}
.horse-bet{padding:6px 12px;border:1px solid var(--border);border-radius:6px;background:var(--surface);color:var(--text);cursor:pointer;font-weight:700;font-size:11px;transition:all .2s;}
.horse-bet:hover{border-color:var(--neon);}
.horse-bet.selected{border-color:var(--gold);background:rgba(255,215,0,.1);color:var(--gold);}
#horseResult{font-family:'Orbitron';font-size:14px;font-weight:700;min-height:22px;text-align:center;}

/* ============ SCRATCH CARDS ============ */
#scratchPanel{flex-direction:column;align-items:center;justify-content:center;gap:12px;background:radial-gradient(ellipse at center,#1a1a0a 0%,#0a0a1a 70%);}
.scratch-card{width:260px;padding:14px;background:linear-gradient(135deg,#2a2a5e,#1a1a3e);border-radius:12px;border:2px solid var(--gold);box-shadow:0 0 30px rgba(255,215,0,.1);}
.scratch-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:5px;margin-bottom:8px;}
.scratch-cell{height:64px;border-radius:8px;background:linear-gradient(135deg,#666,#999);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:24px;color:transparent;user-select:none;border:1px solid #aaa;transition:all .3s;}
.scratch-cell.revealed{background:var(--surface);border-color:var(--border);color:var(--text);}
#scratchResult{font-family:'Orbitron';font-size:13px;font-weight:700;text-align:center;min-height:20px;}
.scratch-tiers{display:flex;gap:5px;justify-content:center;flex-wrap:wrap;}
.scratch-tier{padding:4px 10px;border:1px solid var(--border);border-radius:6px;font-size:10px;background:var(--surface);cursor:pointer;transition:all .2s;}
.scratch-tier:hover{border-color:var(--gold);}
.scratch-tier.selected{border-color:var(--gold);background:rgba(255,215,0,.1);}

/* ============ WHEEL ============ */
#wheelPanel{flex-direction:column;align-items:center;justify-content:center;gap:12px;background:radial-gradient(ellipse at center,#1a0a2e 0%,#0a0a1a 70%);}
.wheel-wrap{position:relative;}
.wheel-ptr{position:absolute;top:-14px;left:50%;transform:translateX(-50%);width:0;height:0;border-left:11px solid transparent;border-right:11px solid transparent;border-top:20px solid var(--neon);filter:drop-shadow(0 0 6px rgba(0,240,255,.6));z-index:5;}
#wheelResult{font-family:'Orbitron';font-size:18px;font-weight:700;min-height:26px;}

/* ============ BACCARAT ============ */
#baccaratPanel{flex-direction:column;align-items:center;justify-content:center;gap:12px;background:radial-gradient(ellipse at top,#1a0a0a 0%,#0a0a1a 70%);}
.bacc-table{width:min(520px,90vw);background:linear-gradient(180deg,#1a0a0a,#150808);border-radius:16px;border:2px solid #4a2020;padding:18px;}
.bacc-hands{display:flex;justify-content:space-around;gap:16px;}
.bacc-hand{text-align:center;min-width:110px;}
.bacc-hand-label{font-family:'Orbitron';font-size:11px;color:var(--text2);margin-bottom:5px;}
.bacc-hand-score{font-family:'Orbitron';font-size:20px;font-weight:900;margin-top:5px;}
.bacc-cards{display:flex;gap:3px;justify-content:center;min-height:74px;align-items:center;}
.bacc-bets{display:flex;gap:6px;justify-content:center;}
.bacc-bet{padding:9px 18px;border:2px solid var(--border);border-radius:9px;background:var(--surface);color:var(--text);cursor:pointer;font-weight:700;font-size:12px;transition:all .2s;}
.bacc-bet:hover{border-color:var(--neon);}
.bacc-bet.selected{border-color:var(--gold);background:rgba(255,215,0,.1);color:var(--gold);}
#baccResult{font-family:'Orbitron';font-size:15px;font-weight:700;min-height:22px;text-align:center;}

/* ============ HILO ============ */
#hiloPanel{flex-direction:column;align-items:center;justify-content:center;gap:12px;background:radial-gradient(ellipse at center,#0a1a2a 0%,#0a0a1a 70%);}
.hilo-card{width:100px;height:140px;border-radius:12px;background:#fff;color:#111;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:26px;font-weight:900;box-shadow:0 8px 30px rgba(0,0,0,.4);border:2px solid #ddd;}
.hilo-card.red{color:#cc2233;}
.hilo-actions{display:flex;gap:8px;}
.hilo-act-btn{padding:10px 22px;border:none;border-radius:9px;cursor:pointer;font-weight:700;font-size:13px;font-family:'Orbitron';transition:all .2s;}
.hilo-act-btn.higher{background:linear-gradient(135deg,#00cc66,#009944);color:#fff;}
.hilo-act-btn.lower{background:linear-gradient(135deg,#cc3355,#991133);color:#fff;}
.hilo-act-btn.skip-btn{background:var(--surface2);color:var(--text);border:1px solid var(--border);}
#hiloStreak{font-family:'Orbitron';font-size:12px;color:var(--text2);}
#hiloCashout{font-family:'Orbitron';font-size:14px;color:var(--gold);}
.last-results{display:flex;gap:4px;flex-wrap:wrap;justify-content:center;max-width:320px;min-height:18px;}
.result-dot{display:inline-block;padding:2px 6px;border-radius:4px;font-size:10px;font-family:'Orbitron';font-weight:700;color:#fff;animation:dotIn .2s ease;}
@keyframes dotIn{from{opacity:0;transform:scale(.5);}to{opacity:1;transform:scale(1);}}
</style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="loginScreen">
  <div class="login-bg-particles" id="loginParticles"></div>
  <div class="login-box">
    <div class="login-logo">CASINO</div>
    <div class="login-subtitle">ROYALE</div>
    <div id="loginForm">
      <input class="login-input" type="text" id="authUsername" placeholder="Username" autocomplete="username" maxlength="20">
      <input class="login-input" type="password" id="authPassword" placeholder="Password" autocomplete="current-password">
      <button class="login-btn primary" id="authSubmitBtn" onclick="authSubmit()">SIGN IN</button>
      <button class="login-btn secondary" id="authToggleBtn" onclick="authToggleMode()">CREATE ACCOUNT</button>
      <button class="login-btn secondary" style="margin-top:4px;border-color:rgba(255,255,255,0.15);color:rgba(255,255,255,0.4);font-family:'Inter',sans-serif;font-size:13px;letter-spacing:0;" onclick="authGuestMode()">Sign in later</button>
      <div class="login-error" id="authError"></div>
      <div class="login-toggle" id="authToggleText">Don't have an account? <a onclick="authToggleMode()">Sign up</a></div>
    </div>
  </div>
</div>

<!-- Top Navigation -->
<nav id="topNav" style="display:none;">
  <div class="logo" onclick="switchGame('slots',null)">CASINO</div>

  <!-- Category: Popular -->
  <div class="nav-cat" onmouseenter="openCat(this)" onmouseleave="closeCat(this)">
    <button class="nav-cat-btn"><span class="cat-icon">â­</span>Popular<span class="cat-arrow">â–¼</span></button>
    <div class="nav-dropdown">
      <button class="nav-btn active" onclick="switchGame('slots',this)"><span class="icon">ðŸŽ°</span>Slots</button>
      <button class="nav-btn" onclick="switchGame('crash',this)"><span class="icon">ðŸ“ˆ</span>Crash</button>
      <button class="nav-btn" onclick="switchGame('mines',this)"><span class="icon">ðŸ’£</span>Mines</button>
      <button class="nav-btn" onclick="switchGame('plinko',this)"><span class="icon">âš¡</span>Plinko</button>
      <button class="nav-btn" onclick="switchGame('cases',this)"><span class="icon">ðŸ“¦</span>Cases</button>
    </div>
  </div>

  <!-- Category: Card Games -->
  <div class="nav-cat" onmouseenter="openCat(this)" onmouseleave="closeCat(this)">
    <button class="nav-cat-btn"><span class="cat-icon">ðŸƒ</span>Cards<span class="cat-arrow">â–¼</span></button>
    <div class="nav-dropdown">
      <button class="nav-btn" onclick="switchGame('blackjack',this)"><span class="icon">ðŸƒ</span>Blackjack</button>
      <button class="nav-btn" onclick="switchGame('poker',this)"><span class="icon">â™ ï¸</span>Video Poker</button>
      <button class="nav-btn" onclick="switchGame('baccarat',this)"><span class="icon">ðŸŽ´</span>Baccarat</button>
      <button class="nav-btn" onclick="switchGame('hilo',this)"><span class="icon">â†•ï¸</span>Hi-Lo</button>
    </div>
  </div>

  <!-- Category: Table Games -->
  <div class="nav-cat" onmouseenter="openCat(this)" onmouseleave="closeCat(this)">
    <button class="nav-cat-btn"><span class="cat-icon">ðŸŽ¡</span>Table<span class="cat-arrow">â–¼</span></button>
    <div class="nav-dropdown">
      <button class="nav-btn" onclick="switchGame('roulette',this)"><span class="icon">ðŸŽ¡</span>Roulette</button>
      <button class="nav-btn" onclick="switchGame('wheel',this)"><span class="icon">ðŸ’«</span>Wheel</button>
      <button class="nav-btn" onclick="switchGame('keno',this)"><span class="icon">ðŸ”¢</span>Keno</button>
      <button class="nav-btn" onclick="switchGame('horses',this)"><span class="icon">ðŸ‡</span>Horse Racing</button>
    </div>
  </div>

  <!-- Category: Quick Games -->
  <div class="nav-cat" onmouseenter="openCat(this)" onmouseleave="closeCat(this)">
    <button class="nav-cat-btn"><span class="cat-icon">âš¡</span>Quick<span class="cat-arrow">â–¼</span></button>
    <div class="nav-dropdown">
      <button class="nav-btn" onclick="switchGame('dice',this)"><span class="icon">ðŸŽ¯</span>Dice</button>
      <button class="nav-btn" onclick="switchGame('limbo',this)"><span class="icon">ðŸš€</span>Limbo</button>
      <button class="nav-btn" onclick="switchGame('coinflip',this)"><span class="icon">ðŸª™</span>Coin Flip</button>
      <button class="nav-btn" onclick="switchGame('tower',this)"><span class="icon">ðŸ—¼</span>Tower</button>
      <button class="nav-btn" onclick="switchGame('scratch',this)"><span class="icon">ðŸŽ«</span>Scratch Cards</button>
    </div>
  </div>

  <!-- Category: Special -->
  <div class="nav-cat" onmouseenter="openCat(this)" onmouseleave="closeCat(this)">
    <button class="nav-cat-btn"><span class="cat-icon">ðŸ’Ž</span>Special<span class="cat-arrow">â–¼</span></button>
    <div class="nav-dropdown">
      <button class="nav-btn" onclick="switchGame('luck',this)"><span class="icon">ðŸŽ²</span>Push Your Luck</button>
      <button class="nav-btn" onclick="switchGame('stocks',this)"><span class="icon">ðŸ“Š</span>Stocks</button>
    </div>
  </div>

  <!-- Inline buttons for important sections -->
  <button class="nav-btn-inline" onclick="switchGame('leaderboard',this)"><span class="icon">ðŸ†</span>Board</button>
  <button class="nav-btn-inline" onclick="switchGame('profile',this)"><span class="icon">ðŸ‘¤</span>Profile</button>
  <button class="nav-btn-inline" onclick="showInventory()"><span class="icon">ðŸŽ’</span>Inv</button>

  <div id="balanceDisplay">
    <button id="muteBtn" onclick="toggleMute()" style="padding:5px 8px;border:none;border-radius:6px;cursor:pointer;background:var(--surface2);color:var(--text);font-size:13px;transition:all .2s;" title="Toggle Sound">ðŸ”Š</button>
    <button class="daily-bonus-btn" id="dailyBonusBtn" onclick="claimDailyBonus()" style="font-size:11px;padding:4px 10px;">ðŸŽ DAILY</button>
    <div class="bal">$<span id="balText">1000.00</span></div>
    <button class="add-btn" onclick="addMoney(1000)">+ $1000</button>
    <div class="user-info">
      <div class="user-avatar" id="userAvatar">?</div>
      <span class="user-name" id="userNameDisplay">...</span>
      <button class="logout-btn" onclick="authLogout()">â»</button>
    </div>
  </div>
</nav>

<!-- Particles Canvas -->
<canvas id="particles"></canvas>

<!-- Win Toast -->
<div class="win-toast" id="winToast"></div>

<!-- ============ SLOTS ============ -->
<div class="game-panel active" id="slotsPanel">
  <div class="htp-box"><button class="htp-toggle" onclick="htpToggle(this)"><span class="htp-arrow">â–¶</span> HOW TO PLAY</button><div class="htp-content"><ul><li>Set your <strong>bet amount</strong> using the bet controls.</li><li>Press <strong>SPIN</strong> to spin the reels.</li><li>Match <strong>3+ symbols</strong> in a row to win â€” multiplier depends on the symbol.</li><li>Special symbols like ðŸ’Ž and ðŸ‘‘ pay the highest.</li><li>Wins are calculated as <strong>bet Ã— symbol multiplier</strong>.</li></ul></div></div>
  <div class="slots-machine">
    <div class="slots-header">MEGA SLOTS</div>
    <div class="reels-container" id="reelsContainer">
      <div class="payline-indicator"></div>
    </div>
    <div class="slots-info">Match 3+ symbols on the payline to win!</div>
  </div>
  
  <div style="display:flex;align-items:center;gap:16px;margin-top:4px;">
    <div class="bet-controls">
      <span style="color:var(--text2);font-size:13px;font-weight:600;">BET</span>
      <button class="bet-btn bet-half" onclick="adjustBet('slotsBet',0.5)">Â½</button>
      <input class="bet-input" type="number" id="slotsBet" value="10" min="1" title="Bet amount">
      <button class="bet-btn bet-double" onclick="adjustBet('slotsBet',2)">2Ã—</button>
    </div>
    <button class="action-btn primary" id="spinBtn" onclick="spinSlots()">SPIN</button>
  </div>
</div>

<!-- ============ CRASH ============ -->
<div class="game-panel" id="crashPanel">
  <div class="htp-box"><button class="htp-toggle" onclick="htpToggle(this)"><span class="htp-arrow">â–¶</span> HOW TO PLAY</button><div class="htp-content"><ul><li>Set your <strong>bet amount</strong> before the round starts.</li><li>Press <strong>START</strong> â€” the multiplier begins climbing from 1.00Ã—.</li><li>Press <strong>CASH OUT</strong> before the rocket crashes to lock in your win.</li><li>If you don't cash out in time, you <strong>lose your bet</strong>.</li><li>The crash point is random â€” it could crash at 1.01Ã— or go past 100Ã—!</li></ul></div></div>
  <div class="crash-container">
    <canvas class="crash-canvas" id="crashCanvas"></canvas>
    <div class="crash-multiplier" id="crashMultiplier">1.00Ã—</div>
  </div>
  <div class="crash-status" id="crashStatus">Place your bet and start the round</div>
  
  <div style="display:flex;align-items:center;gap:16px;">
    <div class="bet-controls">
      <span style="color:var(--text2);font-size:13px;font-weight:600;">BET</span>
      <button class="bet-btn bet-half" onclick="adjustBet('crashBet',0.5)">Â½</button>
      <input class="bet-input" type="number" id="crashBet" value="10" min="1">
      <button class="bet-btn bet-double" onclick="adjustBet('crashBet',2)">2Ã—</button>
    </div>
    <button class="action-btn primary" id="crashStartBtn" onclick="startCrash()">START</button>
    <button class="action-btn danger" id="cashoutBtn" onclick="cashOut()" style="display:none">CASH OUT</button>
  </div>
</div>

<!-- ============ ROULETTE ============ -->
<div class="game-panel" id="roulettePanel">
  <div class="htp-box"><button class="htp-toggle" onclick="htpToggle(this)"><span class="htp-arrow">â–¶</span> HOW TO PLAY</button><div class="htp-content"><ul><li>Place bets on <strong>numbers, colors, or sections</strong> of the wheel.</li><li>Choose Red (2Ã—), Black (2Ã—), Green (14Ã—), or specific number ranges.</li><li>Press <strong>SPIN</strong> to spin the roulette wheel.</li><li>If the ball lands on your selection, you win <strong>bet Ã— the multiplier</strong>.</li><li>Green (0) is the rarest outcome but pays the most.</li></ul></div></div>
  <div class="roulette-wrapper">
    <div class="roulette-pointer"></div>
    <canvas class="roulette-canvas" id="rouletteCanvas" width="360" height="360"></canvas>
  </div>
  <div class="roulette-result" id="rouletteResult"></div>
  <div class="roulette-bets" id="rouletteBetsDiv">
    <button class="roul-bet-btn red-btn" onclick="selectRoulBet('red',this)">ðŸ”´ Red</button>
    <button class="roul-bet-btn black-btn" onclick="selectRoulBet('black',this)">âš« Black</button>
    <button class="roul-bet-btn green-btn" onclick="selectRoulBet('green',this)">ðŸ’š Green</button>
    <button class="roul-bet-btn" onclick="selectRoulBet('odd',this)">Odd</button>
    <button class="roul-bet-btn" onclick="selectRoulBet('even',this)">Even</button>
    <button class="roul-bet-btn" onclick="selectRoulBet('1-18',this)">1-18</button>
    <button class="roul-bet-btn" onclick="selectRoulBet('19-36',this)">19-36</button>
  </div>
  
  
  <div style="display:flex;align-items:center;gap:16px;">
    <div class="bet-controls">
      <span style="color:var(--text2);font-size:13px;font-weight:600;">BET</span>
      <button class="bet-btn bet-half" onclick="adjustBet('roulBetInput',0.5)">Â½</button>
      <input class="bet-input" type="number" id="roulBetInput" value="10" min="1">
      <button class="bet-btn bet-double" onclick="adjustBet('roulBetInput',2)">2Ã—</button>
    </div>
    <button class="action-btn primary" id="roulSpinBtn" onclick="spinRoulette()">SPIN</button>
  </div>
</div>

<!-- ============ CASES ============ -->
<div class="game-panel" id="casesPanel">
  <div class="htp-box"><button class="htp-toggle" onclick="htpToggle(this)"><span class="htp-arrow">â–¶</span> HOW TO PLAY</button><div class="htp-content"><ul><li>Set your <strong>bet amount</strong> â€” this is the case price.</li><li>Press <strong>OPEN CASE</strong> to reveal a random prize.</li><li>Items range from common (low value) to legendary (huge value).</li><li>Your win is based on the <strong>item rarity</strong> you unbox.</li><li>Legendary items can pay <strong>50Ã— your bet</strong> or more!</li></ul></div></div>
  <div class="case-selector" id="caseSelector"></div>
  <div class="case-opener">
    <div class="case-pointer"></div>
    <div class="case-strip" id="caseStrip"></div>
  </div>
  <div class="case-won" id="caseWon"></div>
  <div class="case-won-detail" id="caseWonDetail"></div>
  
  <button class="action-btn primary" id="openCaseBtn" onclick="openCase()">OPEN CASE</button>
</div>

<!-- ============ PLINKO ============ -->
<div class="game-panel" id="plinkoPanel">
  <div class="htp-box"><button class="htp-toggle" onclick="htpToggle(this)"><span class="htp-arrow">â–¶</span> HOW TO PLAY</button><div class="htp-content"><ul><li>Set your <strong>bet</strong> and choose <strong>risk level</strong> (Low/Medium/High).</li><li>Press <strong>DROP</strong> to release a ball from the top.</li><li>The ball bounces off pegs randomly as it falls down.</li><li>Higher risk = bigger potential wins but also more losing slots.</li><li>The slot the ball lands in determines your <strong>multiplier</strong>.</li></ul></div></div>
  <div class="plinko-sidebar">
    <div style="font-family:'Orbitron';font-size:18px;font-weight:700;color:var(--neon);margin-bottom:8px;">PLINKO</div>
    <div>
      <label>Bet Amount</label>
      <div style="display:flex;gap:6px;">
        <input type="number" id="plinkoBet" value="10" min="1" style="flex:1;">
        <button class="bet-btn bet-half" onclick="adjustBet('plinkoBet',0.5)" style="padding:6px 10px;">Â½</button>
        <button class="bet-btn bet-double" onclick="adjustBet('plinkoBet',2)" style="padding:6px 10px;">2Ã—</button>
      </div>
    </div>
    <div>
      <label>Risk</label>
      <select id="plinkoRisk">
        <option value="LOW">Low</option>
        <option value="MEDIUM" selected>Medium</option>
        <option value="HIGH">High</option>
      </select>
    </div>
    <div>
      <label>Rows</label>
      <select id="plinkoRows">
        <option value="8">8</option><option value="9">9</option><option value="10">10</option>
        <option value="11">11</option><option value="12">12</option><option value="13">13</option>
        <option value="14">14</option><option value="15">15</option><option value="16" selected>16</option>
      </select>
    </div>
    
    
    <button class="action-btn primary" onclick="dropPlinkoBall()" style="width:100%;margin-top:8px;">DROP BALL</button>
    <button class="action-btn primary" id="autoDropBtn" onclick="toggleAutoDrop()" style="width:100%;background:linear-gradient(135deg,#3355cc,#2244aa);box-shadow:0 4px 20px rgba(51,85,204,.3);">AUTO DROP</button>
    <div id="plinkoStats" style="margin-top:auto;font-size:12px;color:var(--text2);">
      <div>Balls dropped: <span id="plinkoDropCount">0</span></div>
      <div>Total profit: <span id="plinkoProfit" style="color:var(--text);">$0.00</span></div>
    </div>
  </div>
  <div class="plinko-main">
    <div class="plinko-canvas-wrap">
      <canvas id="plinkoCanvas"></canvas>
      <div class="plinko-bins" id="plinkoBins"></div>
    </div>
    <div class="plinko-last-wins" id="plinkoLastWins"></div>
  </div>
</div>

<!-- ============ PUSH YOUR LUCK ============ -->
<div class="game-panel" id="luckPanel">
  <div class="htp-box"><button class="htp-toggle" onclick="htpToggle(this)"><span class="htp-arrow">â–¶</span> HOW TO PLAY</button><div class="htp-content"><ul><li>This is a <strong>multiplayer trivia game</strong>!</li><li>Answer questions correctly to earn points and avoid Whammy spaces.</li><li>Press your luck to keep going, or stop to keep your points.</li><li>Landing on a <strong>Whammy</strong> loses all your round points.</li><li>The player with the most points at the end wins!</li></ul></div></div>
  <!-- iframe gets created dynamically when needed -->
    

  <!-- Lobby Overlay -->
  <div class="pyl-lobby" id="pylLobby">
    <div class="pyl-title">PUSH YOUR LUCK</div>
    <div class="pyl-subtitle">Choose your game mode</div>
    

    <div class="pyl-modes">
      <div class="pyl-mode" onclick="pylStartMode('solo')">
        <div class="pm-icon">ðŸŽ²</div>
        <div class="pm-name">FREE PLAY</div>
        <div class="pm-desc">Practice mode. No wagers, just vibes.</div>
      </div>
      <div class="pyl-mode" onclick="pylShowWager('1v1')">
        <div class="pm-icon">âš”ï¸</div>
        <div class="pm-name">1v1 WAGER</div>
        <div class="pm-desc">Create or join a room. Both play, highest score takes the pot.</div>
        <div class="pm-badge">COMPETITIVE</div>
      </div>
      <div class="pyl-mode" onclick="pylShowWager('highstakes')">
        <div class="pm-icon">ðŸ’€</div>
        <div class="pm-name">HIGH STAKES</div>
        <div class="pm-desc">Solo play with massive multiplier wagers. Risk it all.</div>
        <div class="pm-badge">2x â€” 10x PAYOUT</div>
      </div>
      <div class="pyl-mode" onclick="pylStartMode('tournament')">
        <div class="pm-icon">ðŸ†</div>
        <div class="pm-name">TOURNAMENT</div>
        <div class="pm-desc">Compete on the global leaderboard. Top scores win prizes.</div>
        <div class="pm-badge">LEADERBOARD</div>
      </div>
    </div>

    <!-- 1v1 Room UI (hidden by default) -->
    <div class="pyl-room" id="pylRoomUI" style="display:none;">
      <div class="pr-title" id="pylRoomTitle">1v1 WAGER MATCH</div>
      <div style="display:flex;gap:8px;justify-content:center;margin-bottom:12px;">
        <div class="bet-controls">
          <span style="color:var(--text2);font-size:12px;font-weight:600;">WAGER $</span>
          <input class="bet-input" type="number" id="pylWager" value="100" min="10" style="width:80px;">
        </div>
      </div>
      <div style="display:flex;gap:8px;justify-content:center;margin-bottom:12px;">
        <button class="action-btn primary" onclick="pylCreateRoom()" style="font-size:12px;padding:10px 20px;">CREATE ROOM</button>
        <div style="display:flex;gap:4px;">
          <input class="bet-input" type="text" id="pylJoinCode" placeholder="CODE" style="width:70px;text-transform:uppercase;text-align:center;">
          <button class="action-btn primary" onclick="pylJoinRoom()" style="font-size:12px;padding:10px 16px;background:linear-gradient(135deg,#8847ff,#6b2fd9);">JOIN</button>
        </div>
      </div>
      <div class="pr-status" id="pylRoomStatus">Create a room or enter a code to join</div>
      <div class="pr-players" id="pylRoomPlayers"></div>
      <button class="pyl-back-btn" onclick="pylBackToLobby()" style="margin-top:10px;">â† Back to modes</button>
    </div>

    <!-- High Stakes UI -->
    <div class="pyl-room" id="pylHighStakesUI" style="display:none;">
      <div class="pr-title">ðŸ’€ HIGH STAKES</div>
      <div style="color:var(--text2);font-size:12px;margin-bottom:12px;">
        Set your target score. If you hit it, you win BIG. If you don't... you lose it all.
      </div>
      <div style="display:flex;gap:10px;justify-content:center;align-items:center;margin-bottom:12px;flex-wrap:wrap;">
        <div class="bet-controls">
          <span style="color:var(--text2);font-size:11px;font-weight:600;">WAGER $</span>
          <input class="bet-input" type="number" id="pylHSWager" value="500" min="50" style="width:80px;">
        </div>
        <div class="bet-controls">
          <span style="color:var(--text2);font-size:11px;font-weight:600;">TARGET</span>
          <select id="pylHSTarget" style="background:var(--bg);color:var(--text);border:1px solid var(--border);border-radius:6px;padding:6px;font-size:12px;">
            <option value="500" data-mult="2">500 pts (2x)</option>
            <option value="1000" data-mult="3">1000 pts (3x)</option>
            <option value="2000" data-mult="5">2000 pts (5x)</option>
            <option value="5000" data-mult="10">5000 pts (10x)</option>
          </select>
        </div>
      </div>
      <button class="action-btn primary" onclick="pylStartHighStakes()" style="font-size:14px;padding:12px 30px;">
        ðŸ”¥ LOCK IT IN
      </button>
      <button class="pyl-back-btn" onclick="pylBackToLobby()" style="margin-top:10px;">â† Back to modes</button>
    </div>

    <!-- Leaderboard -->
    <div class="pyl-leaderboard" id="pylLeaderboard">
      <div class="pyl-lb-title">ðŸ† TOP SCORES</div>
      <div id="pylLBRows"></div>
    </div>
  </div>

  <!-- In-Game Overlay -->
  <div class="pyl-overlay hidden" id="pylOverlay">
    <div class="pyl-score-card">
      <div class="psc-label" id="pylModeLabel">FREE PLAY</div>
      <div class="psc-val" style="color:var(--neon);" id="pylScoreDisplay">Score: â€”</div>
    </div>
    <div class="pyl-score-card" id="pylOpponentCard" style="display:none;">
      <div class="psc-label">âš”ï¸ <span id="pylOpponentName">OPPONENT</span></div>
      <div class="psc-val" style="color:var(--red);" id="pylOpponentScore">â€”</div>
    </div>
    <div class="pyl-score-card" id="pylWagerCard" style="display:none;">
      <div class="psc-label">WAGER</div>
      <div class="psc-val" style="color:var(--gold);" id="pylWagerDisplay">$0</div>
    </div>
    <button class="pyl-back-btn" onclick="pylEndGame()">END GAME</button>
    <input type="hidden" id="pylScoreInput" value="0">
  </div>
</div>

<!-- ============ STOCKS ============ -->
<div class="game-panel" id="stocksPanel">
  <div class="htp-box"><button class="htp-toggle" onclick="htpToggle(this)"><span class="htp-arrow">â–¶</span> HOW TO PLAY</button><div class="htp-content"><ul><li>View the stock chart and current price trend.</li><li>Choose to <strong>Buy Long</strong> (price goes up) or <strong>Short Sell</strong> (price goes down).</li><li>Set your <strong>bet amount</strong> â€” this is your investment.</li><li>Wait for the stock to move â€” cash out anytime to lock in profit.</li><li>If the stock moves against you too far, you lose your investment.</li></ul></div></div>
  <div class="stock-hero">
    <div class="sh-ticker"><span class="stock-live-dot"></span>$GMBL <span style="color:#8b949e;font-weight:400;">Gamble Corp</span></div>
    <div class="sh-price" id="stockPriceDisplay">$100.00</div>
    <div class="sh-change" id="stockChangeDisplay"></div>
  </div>
  
  <div class="stock-chart-wrap">
    <canvas id="stockChart"></canvas>
  </div>
  <div class="stock-portfolio">
    <div class="sp-stat"><div class="sp-label">Shares</div><div class="sp-val" id="stockShares">0</div></div>
    <div class="sp-stat"><div class="sp-label">Value</div><div class="sp-val" id="stockValue">$0</div></div>
    <div class="sp-stat"><div class="sp-label">P&L</div><div class="sp-val" id="stockPnl" style="color:#8b949e;">$0</div></div>
  </div>
  <div class="stock-actions-row">
    <button class="sa-btn sa-buy" onclick="buyStock('GMBL')">BUY</button>
    <button class="sa-btn sa-sell" id="stockSellBtn" onclick="sellStock('GMBL')" disabled>SELL ALL</button>
  </div>
  <div class="stock-amt-row">
    <div class="bet-controls">
      <span style="color:#8b949e;font-size:12px;font-weight:600;">$</span>
      <button class="bet-btn bet-half" onclick="adjustBet('stockBuyAmt',0.5)">Â½</button>
      <input class="bet-input" type="number" id="stockBuyAmt" value="100" min="1" style="width:80px;">
      <button class="bet-btn bet-double" onclick="adjustBet('stockBuyAmt',2)">2Ã—</button>
    </div>
  </div>
</div>

<!-- ============ BLACKJACK ============ -->
<div class="game-panel" id="blackjackPanel">
  <div class="htp-box"><button class="htp-toggle" onclick="htpToggle(this)"><span class="htp-arrow">â–¶</span> HOW TO PLAY</button><div class="htp-content"><ul><li>Set your <strong>bet</strong> and press <strong>DEAL</strong> to start.</li><li>Try to get your cards as close to <strong>21</strong> as possible without going over.</li><li><strong>HIT</strong> for another card, <strong>STAND</strong> to keep your hand.</li><li>Face cards = 10, Aces = 1 or 11. Beat the dealer to win <strong>2Ã— your bet</strong>.</li><li>Blackjack (Ace + 10-value) pays <strong>2.5Ã— your bet</strong>!</li></ul></div></div>
  <div class="bj-table">
    <div class="bj-label">DEALER <span class="bj-score" id="bjDealerScore">â€”</span></div>
    <div class="bj-area" id="bjDealerCards"></div>
    <hr style="border-color:rgba(255,255,255,.1);margin:8px 0;">
    <div class="bj-label">YOU <span class="bj-score" id="bjPlayerScore">â€”</span></div>
    <div class="bj-area" id="bjPlayerCards"></div>
  </div>
  <div id="bjResult"></div>
  
  <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:center;">
    <div class="bet-controls">
      <span style="color:var(--text2);font-size:12px;font-weight:600;">BET</span>
      <button class="bet-btn bet-half" onclick="adjustBet('bjBet',0.5)">Â½</button>
      <input class="bet-input" type="number" id="bjBet" value="10" min="1">
      <button class="bet-btn bet-double" onclick="adjustBet('bjBet',2)">2Ã—</button>
    </div>
    <button class="action-btn primary" id="bjDealBtn" onclick="bjDeal()">DEAL</button>
    <button class="action-btn primary" id="bjHitBtn" onclick="bjHit()" disabled style="background:linear-gradient(135deg,#3355cc,#2244aa);">HIT</button>
    <button class="action-btn danger" id="bjStandBtn" onclick="bjStand()" disabled>STAND</button>
    <button class="action-btn primary" id="bjDoubleBtn" onclick="bjDouble()" disabled style="background:linear-gradient(135deg,#cc8800,#996600);">2Ã—</button>
  </div>
</div>

<!-- ============ MINES ============ -->
<div class="game-panel" id="minesPanel">
  <div class="htp-box"><button class="htp-toggle" onclick="htpToggle(this)"><span class="htp-arrow">â–¶</span> HOW TO PLAY</button><div class="htp-content"><ul><li>Set your <strong>bet</strong> and choose the <strong>number of mines</strong> (1-24).</li><li>Click tiles to reveal gems ðŸ’Ž â€” each safe tile increases your multiplier.</li><li>Hit a mine ðŸ’£ and you <strong>lose everything</strong>.</li><li>Press <strong>CASH OUT</strong> anytime to collect your current winnings.</li><li>More mines = higher risk but <strong>bigger multipliers</strong> per tile!</li></ul></div></div>
  <div class="mines-wrap">
    <div class="mines-side">
      <div style="font-family:'Orbitron';font-size:14px;font-weight:700;color:var(--neon);">ðŸ’£ MINES</div>
      <label>Bet</label>
      <div style="display:flex;gap:4px;">
        <input type="number" id="minesBet" value="10" min="1" style="flex:1;">
        <button class="bet-btn bet-half" onclick="adjustBet('minesBet',0.5)" style="padding:4px 8px;">Â½</button>
        <button class="bet-btn bet-double" onclick="adjustBet('minesBet',2)" style="padding:4px 8px;">2Ã—</button>
      </div>
      <label>Mines</label>
      <select id="mineCount"><option value="1">1</option><option value="3" selected>3</option><option value="5">5</option><option value="10">10</option><option value="15">15</option><option value="24">24</option></select>
      
      <div id="minesMultiplier">1.00Ã—</div>
      <div id="minesProfit">Next: $0.00</div>
      <button class="action-btn primary" id="minesStartBtn" onclick="minesStart()" style="width:100%;font-size:12px;padding:8px;">START</button>
      <button class="action-btn danger" id="minesCashoutBtn" onclick="minesCashout()" style="width:100%;display:none;font-size:12px;padding:8px;">CASH OUT</button>
    </div>
    <div class="mines-grid" id="minesGrid"></div>
  </div>
</div>

<!-- ============ DICE ============ -->
<div class="game-panel" id="dicePanel">
  <div class="htp-box"><button class="htp-toggle" onclick="htpToggle(this)"><span class="htp-arrow">â–¶</span> HOW TO PLAY</button><div class="htp-content"><ul><li>Choose <strong>Roll Over</strong> or <strong>Roll Under</strong> mode.</li><li>Use the slider to set your <strong>target number</strong> (2-98).</li><li>The closer to the edge, the higher the multiplier but lower the chance.</li><li>Press <strong>ROLL</strong> â€” if the dice result matches your prediction, you win!</li><li>Win chance and multiplier are shown before you roll.</li></ul></div></div>
  <div class="dice-roll-display" id="diceDisplay">â€”</div>
  <div class="dice-mode-btns">
    <button class="dice-mode-btn active" id="diceOverBtn" onclick="diceSetMode('over')">Roll Over</button>
    <button class="dice-mode-btn" id="diceUnderBtn" onclick="diceSetMode('under')">Roll Under</button>
  </div>
  <div class="dice-slider-wrap">
    <input type="range" class="dice-slider" id="diceSlider" min="2" max="98" value="50" oninput="diceUpdateSlider()">
  </div>
  
  <div class="dice-info">
    <span>Target: <span id="diceTarget">50.00</span></span>
    <span>Chance: <span id="diceChance">50.00%</span></span>
    <span>Payout: <span id="dicePayout">1.98Ã—</span></span>
  </div>
  <div style="display:flex;align-items:center;gap:12px;">
    <div class="bet-controls">
      <span style="color:var(--text2);font-size:12px;font-weight:600;">BET</span>
      <button class="bet-btn bet-half" onclick="adjustBet('diceBet',0.5)">Â½</button>
      <input class="bet-input" type="number" id="diceBet" value="10" min="1">
      <button class="bet-btn bet-double" onclick="adjustBet('diceBet',2)">2Ã—</button>
    </div>
    <button class="action-btn primary" onclick="diceRoll()">ROLL</button>
  </div>
  
</div>

<!-- ============ TOWER ============ -->
<div class="game-panel" id="towerPanel">
  <div class="htp-box"><button class="htp-toggle" onclick="htpToggle(this)"><span class="htp-arrow">â–¶</span> HOW TO PLAY</button><div class="htp-content"><ul><li>Set your <strong>bet</strong> and choose <strong>difficulty</strong> (Easy to Insane).</li><li>Each row has safe tiles and trap tiles â€” click a tile to climb.</li><li>Each safe tile increases your <strong>multiplier</strong>.</li><li>Hit a trap ðŸ’€ and you <strong>lose your bet</strong>.</li><li>Press <strong>CASH OUT</strong> anytime to collect. Higher floors = bigger wins!</li></ul></div></div>
  <div id="towerInfo">Pick a difficulty and start climbing!</div>
  
  <div class="tower-grid" id="towerGrid"></div>
  <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:center;">
    <div class="bet-controls">
      <span style="color:var(--text2);font-size:12px;font-weight:600;">BET</span>
      <button class="bet-btn bet-half" onclick="adjustBet('towerBet',0.5)">Â½</button>
      <input class="bet-input" type="number" id="towerBet" value="10" min="1">
      <button class="bet-btn bet-double" onclick="adjustBet('towerBet',2)">2Ã—</button>
    </div>
    <select id="towerDiff" style="padding:7px;border-radius:6px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:12px;">
      <option value="easy">Easy (4 cols)</option><option value="medium" selected>Medium (3 cols)</option><option value="hard">Hard (4 cols, 2 safe)</option><option value="insane">Insane (4 cols, 1 safe)</option>
    </select>
    <button class="action-btn primary" id="towerStartBtn" onclick="towerStart()">START</button>
    <button class="action-btn danger" id="towerCashoutBtn" onclick="towerCashout()" style="display:none;">CASH OUT</button>
  </div>
</div>
<!-- ============ COIN FLIP ============ -->
<div class="game-panel" id="coinflipPanel">
  <div class="htp-box"><button class="htp-toggle" onclick="htpToggle(this)"><span class="htp-arrow">â–¶</span> HOW TO PLAY</button><div class="htp-content"><ul><li>Set your <strong>bet amount</strong>.</li><li>Choose <strong>Heads</strong> or <strong>Tails</strong>.</li><li>The coin flips â€” if it matches your pick, you win <strong>2Ã— your bet</strong>!</li><li>Simple 50/50 odds â€” pure luck!</li><li>Watch the result history strip to spot streaks.</li></ul></div></div>
  <div class="coin" id="coinDisplay">ðŸª™</div>
  <div id="coinResult"></div>
  
  <div class="coin-choices">
    <button class="coin-choice selected" id="coinHeads" onclick="coinSelect('heads')">ðŸ‘‘ Heads</button>
    <button class="coin-choice" id="coinTails" onclick="coinSelect('tails')">ðŸ¦… Tails</button>
  </div>
  <div style="display:flex;align-items:center;gap:12px;">
    <div class="bet-controls">
      <span style="color:var(--text2);font-size:12px;font-weight:600;">BET</span>
      <button class="bet-btn bet-half" onclick="adjustBet('coinBet',0.5)">Â½</button>
      <input class="bet-input" type="number" id="coinBet" value="10" min="1">
      <button class="bet-btn bet-double" onclick="adjustBet('coinBet',2)">2Ã—</button>
    </div>
    <button class="action-btn primary" id="coinFlipBtn" onclick="coinFlip()">FLIP</button>
  </div>
</div>

<!-- ============ KENO ============ -->
<div class="game-panel" id="kenoPanel">
  <div class="htp-box"><button class="htp-toggle" onclick="htpToggle(this)"><span class="htp-arrow">â–¶</span> HOW TO PLAY</button><div class="htp-content"><ul><li>Click to select <strong>1-10 numbers</strong> on the board (1-40).</li><li>Set your <strong>bet</strong> and press <strong>DRAW</strong>.</li><li>10 numbers are drawn randomly â€” matches earn payouts.</li><li>More numbers selected = harder to hit but <strong>bigger payouts</strong>.</li><li>Hitting all your picks pays the <strong>jackpot multiplier</strong>!</li></ul></div></div>
  <div style="font-family:'Orbitron';font-size:16px;font-weight:700;color:var(--gold);">KENO</div>
  <div id="kenoInfo">Pick up to 10 numbers, then draw!</div>
  
  <div class="keno-grid" id="kenoGrid"></div>
  <div id="kenoResult"></div>
  <div style="display:flex;align-items:center;gap:10px;">
    <div class="bet-controls">
      <span style="color:var(--text2);font-size:12px;font-weight:600;">BET</span>
      <button class="bet-btn bet-half" onclick="adjustBet('kenoBet',0.5)">Â½</button>
      <input class="bet-input" type="number" id="kenoBet" value="10" min="1">
      <button class="bet-btn bet-double" onclick="adjustBet('kenoBet',2)">2Ã—</button>
    </div>
    <button class="action-btn primary" id="kenoDrawBtn" onclick="kenoDraw()">DRAW</button>
    <button class="bet-btn" onclick="kenoClear()" style="color:var(--red);">CLEAR</button>
  </div>
  
</div>

<!-- ============ LIMBO ============ -->
<div class="game-panel" id="limboPanel">
  <div class="htp-box"><button class="htp-toggle" onclick="htpToggle(this)"><span class="htp-arrow">â–¶</span> HOW TO PLAY</button><div class="htp-content"><ul><li>Set your <strong>bet</strong> and enter a <strong>target multiplier</strong>.</li><li>Press <strong>GO</strong> â€” the game generates a random multiplier.</li><li>If the result is <strong>â‰¥ your target</strong>, you win at that multiplier!</li><li>Higher targets = lower chance but bigger payouts.</li><li>Minimum target is 1.01Ã— (99% chance), max risk for max reward!</li></ul></div></div>
  <div id="limboResult">â€”</div>
  <div class="limbo-target-wrap">
    <label>Target Ã—</label>
    <input type="number" id="limboTarget" value="2" min="1.01" max="1000" step="0.01">
  </div>
  
  <div id="limboPayout">Win chance: 49.50% â€” Payout: 2.00Ã—</div>
  <div style="display:flex;align-items:center;gap:12px;">
    <div class="bet-controls">
      <span style="color:var(--text2);font-size:12px;font-weight:600;">BET</span>
      <button class="bet-btn bet-half" onclick="adjustBet('limboBet',0.5)">Â½</button>
      <input class="bet-input" type="number" id="limboBet" value="10" min="1">
      <button class="bet-btn bet-double" onclick="adjustBet('limboBet',2)">2Ã—</button>
    </div>
    <button class="action-btn primary" id="limboGoBtn" onclick="limboGo()">BET</button>
  </div>
  <div class="last-results" id="limboHistory"></div>
</div>

<!-- ============ VIDEO POKER ============ -->
<div class="game-panel" id="pokerPanel">
  <div class="htp-box"><button class="htp-toggle" onclick="htpToggle(this)"><span class="htp-arrow">â–¶</span> HOW TO PLAY</button><div class="htp-content"><ul><li>Set your <strong>bet</strong> and press <strong>DEAL</strong> to get 5 cards.</li><li>Click cards to <strong>hold</strong> the ones you want to keep.</li><li>Press <strong>DRAW</strong> to replace un-held cards.</li><li>Your final hand is evaluated â€” <strong>Jacks or Better</strong> wins.</li><li>Royal Flush pays <strong>250Ã—</strong>, Straight Flush pays <strong>50Ã—</strong>!</li></ul></div></div>
  <div class="poker-paytable">
    <span class="pt-h">Royal Flush</span><span class="pt-v">250Ã—</span>
    <span class="pt-h">Straight Flush</span><span class="pt-v">50Ã—</span>
    <span class="pt-h">4 of a Kind</span><span class="pt-v">25Ã—</span>
    <span class="pt-h">Full House</span><span class="pt-v">9Ã—</span>
    <span class="pt-h">Flush</span><span class="pt-v">6Ã—</span>
    <span class="pt-h">Straight</span><span class="pt-v">4Ã—</span>
    <span class="pt-h">3 of a Kind</span><span class="pt-v">3Ã—</span>
    <span class="pt-h">Two Pair</span><span class="pt-v">2Ã—</span>
    <span class="pt-h">Jacks+</span><span class="pt-v">1Ã—</span>
  </div>
  <div class="poker-hand" id="pokerHand"></div>
  <div id="pokerResult"></div>
  <div style="display:flex;align-items:center;gap:10px;">
    <div class="bet-controls">
      <span style="color:var(--text2);font-size:12px;font-weight:600;">BET</span>
      <button class="bet-btn bet-half" onclick="adjustBet('pokerBet',0.5)">Â½</button>
      <input class="bet-input" type="number" id="pokerBet" value="10" min="1">
  
      <button class="bet-btn bet-double" onclick="adjustBet('pokerBet',2)">2Ã—</button>
    </div>
    <button class="action-btn primary" id="pokerDealBtn" onclick="pokerDeal()">DEAL</button>
    <button class="action-btn primary" id="pokerDrawBtn" onclick="pokerDrawCards()" style="display:none;background:linear-gradient(135deg,#cc8800,#996600);">DRAW</button>
  </div>
</div>

<!-- ============ HORSE RACING ============ -->
<div class="game-panel" id="horsesPanel">
  <div class="htp-box"><button class="htp-toggle" onclick="htpToggle(this)"><span class="htp-arrow">â–¶</span> HOW TO PLAY</button><div class="htp-content"><ul><li>Review the <strong>odds</strong> for each horse â€” lower odds = more likely to win.</li><li>Set your <strong>bet</strong> and click a horse to place your wager.</li><li>Watch the race â€” horses run at speeds influenced by their odds.</li><li>If your horse wins, you earn <strong>bet Ã— horse odds</strong>.</li><li>Underdogs pay big but win less often!</li></ul></div></div>
  <div style="font-family:'Orbitron';font-size:16px;font-weight:700;color:var(--gold);">ðŸ‡ HORSE RACING</div>
  
  <div class="horse-track" id="horseTrack"></div>
  <div id="horseResult"></div>
  <div class="horse-bets" id="horseBets"></div>
  <div style="display:flex;align-items:center;gap:12px;">
    <div class="bet-controls">
      <span style="color:var(--text2);font-size:12px;font-weight:600;">BET</span>
      <button class="bet-btn bet-half" onclick="adjustBet('horseBet',0.5)">Â½</button>
      <input class="bet-input" type="number" id="horseBet" value="10" min="1">
      <button class="bet-btn bet-double" onclick="adjustBet('horseBet',2)">2Ã—</button>
    </div>
    <button class="action-btn primary" id="horseRaceBtn" onclick="horseRace()">RACE!</button>
  </div>
</div>

<!-- ============ SCRATCH CARDS ============ -->
<div class="game-panel" id="scratchPanel">
  <div class="htp-box"><button class="htp-toggle" onclick="htpToggle(this)"><span class="htp-arrow">â–¶</span> HOW TO PLAY</button><div class="htp-content"><ul><li>Set your <strong>bet</strong> (card price) and press <strong>BUY CARD</strong>.</li><li>Scratch tiles by clicking them, or press <strong>SCRATCH ALL</strong> to reveal everything.</li><li>Match <strong>3 identical symbols</strong> to win that symbol's prize.</li><li>Match <strong>4 symbols</strong> for an even bigger payout!</li><li>Prizes range from 1Ã— to 50Ã— your bet depending on the symbol.</li></ul></div></div>
  <div style="font-family:'Orbitron';font-size:16px;font-weight:700;color:var(--gold);">ðŸŽ« SCRATCH CARDS</div>
  
  <div class="scratch-tiers">
    <div class="scratch-tier selected" onclick="scratchSelectTier(0,this)">$5 Basic</div>
    <div class="scratch-tier" onclick="scratchSelectTier(1,this)">$25 Silver</div>
    <div class="scratch-tier" onclick="scratchSelectTier(2,this)">$100 Gold</div>
    <div class="scratch-tier" onclick="scratchSelectTier(3,this)">$500 Diamond</div>
  </div>
  <div class="scratch-card"><div class="scratch-grid" id="scratchGrid"></div></div>
  <div id="scratchResult"></div>
  <button class="action-btn primary" id="scratchBuyBtn" onclick="scratchBuy()">BUY CARD â€” $5</button>
  <button class="action-btn primary" id="scratchRevealAllBtn" onclick="scratchRevealAll()" style="display:none;font-size:12px;padding:8px 16px;">SCRATCH ALL</button>
</div>

<!-- ============ WHEEL ============ -->
<div class="game-panel" id="wheelPanel">
  <div class="htp-box"><button class="htp-toggle" onclick="htpToggle(this)"><span class="htp-arrow">â–¶</span> HOW TO PLAY</button><div class="htp-content"><ul><li>Set your <strong>bet amount</strong>.</li><li>Press <strong>SPIN</strong> to spin the wheel.</li><li>The wheel has segments with different <strong>multipliers</strong>.</li><li>Where the wheel stops determines your payout.</li><li>Rare high-value segments can pay <strong>huge multipliers</strong>!</li></ul></div></div>
  <div class="wheel-wrap">
    <div class="wheel-ptr"></div>
    <canvas id="wheelCanvas" width="320" height="320"></canvas>
  </div>
  <div id="wheelResult"></div>
  
  <div style="display:flex;align-items:center;gap:12px;">
    <div class="bet-controls">
      <span style="color:var(--text2);font-size:12px;font-weight:600;">BET</span>
      <button class="bet-btn bet-half" onclick="adjustBet('wheelBet',0.5)">Â½</button>
      <input class="bet-input" type="number" id="wheelBet" value="10" min="1">
      <button class="bet-btn bet-double" onclick="adjustBet('wheelBet',2)">2Ã—</button>
    </div>
    <button class="action-btn primary" id="wheelSpinBtn" onclick="wheelSpin()">SPIN</button>
  </div>
</div>

<!-- ============ BACCARAT ============ -->
<div class="game-panel" id="baccaratPanel">
  <div class="htp-box"><button class="htp-toggle" onclick="htpToggle(this)"><span class="htp-arrow">â–¶</span> HOW TO PLAY</button><div class="htp-content"><ul><li>Choose to bet on <strong>Player</strong>, <strong>Banker</strong>, or <strong>Tie</strong>.</li><li>Set your <strong>bet</strong> and press <strong>DEAL</strong>.</li><li>Cards are dealt automatically â€” closest to <strong>9</strong> wins.</li><li>Player pays <strong>2Ã—</strong>, Banker pays <strong>1.95Ã—</strong>, Tie pays <strong>8Ã—</strong>.</li><li>Face cards and 10s count as 0. Only the last digit of the total matters.</li></ul></div></div>
  <div class="bacc-table">
    <div class="bacc-hands">
      <div class="bacc-hand"><div class="bacc-hand-label">PLAYER</div><div class="bacc-cards" id="baccPlayerCards"></div><div class="bacc-hand-score" id="baccPlayerScore">â€”</div></div>
      <div class="bacc-hand"><div class="bacc-hand-label">BANKER</div><div class="bacc-cards" id="baccBankerCards"></div><div class="bacc-hand-score" id="baccBankerScore">â€”</div></div>
    </div>
  </div>
  <div id="baccResult"></div>
  <div class="last-results" id="baccHistory"></div>
  
  <div class="bacc-bets">
    <button class="bacc-bet" onclick="baccSelect('player',this)">Player (2Ã—)</button>
    <button class="bacc-bet" onclick="baccSelect('tie',this)">Tie (8Ã—)</button>
  <button class="bacc-bet" onclick="baccSelect('banker',this)">Banker (1.95Ã—)</button>
  </div>
  <div style="display:flex;align-items:center;gap:12px;">
    <div class="bet-controls">
      <span style="color:var(--text2);font-size:12px;font-weight:600;">BET</span>
      <button class="bet-btn bet-half" onclick="adjustBet('baccBet',0.5)">Â½</button>
      <input class="bet-input" type="number" id="baccBet" value="10" min="1">
      <button class="bet-btn bet-double" onclick="adjustBet('baccBet',2)">2Ã—</button>
    </div>
    <button class="action-btn primary" onclick="baccDeal()">DEAL</button>
  </div>
</div>

<!-- ============ HILO ============ -->
<div class="game-panel" id="hiloPanel">
  <div class="htp-box"><button class="htp-toggle" onclick="htpToggle(this)"><span class="htp-arrow">â–¶</span> HOW TO PLAY</button><div class="htp-content"><ul><li>Press <strong>START</strong> â€” a card is revealed.</li><li>Guess if the next card will be <strong>Higher</strong> or <strong>Lower</strong>.</li><li>Each correct guess multiplies your winnings â€” the streak continues!</li><li>The probability of each choice is shown on the buttons.</li><li>Press <strong>CASH OUT</strong> anytime to collect, or risk it for more!</li></ul></div></div>
  <div id="hiloStreak">Start a game to begin!</div>
  
  <div class="hilo-card" id="hiloCard" style="color:#888;">?<br>?</div>
  <div id="hiloCashout"></div>
  <div class="hilo-actions">
    <button class="hilo-act-btn higher" onclick="hiloGuess('higher')" id="hiloHigherBtn" disabled>â–² HIGHER</button>
    <button class="hilo-act-btn skip-btn" onclick="hiloGuess('skip')" id="hiloSkipBtn" disabled>= SKIP</button>
    <button class="hilo-act-btn lower" onclick="hiloGuess('lower')" id="hiloLowerBtn" disabled>â–¼ LOWER</button>
  </div>
  <div style="display:flex;align-items:center;gap:10px;">
    <div class="bet-controls">
      <span style="color:var(--text2);font-size:12px;font-weight:600;">BET</span>
      <button class="bet-btn bet-half" onclick="adjustBet('hiloBet',0.5)">Â½</button>
      <input class="bet-input" type="number" id="hiloBet" value="10" min="1">
      <button class="bet-btn bet-double" onclick="adjustBet('hiloBet',2)">2Ã—</button>
    </div>
    <button class="action-btn primary" id="hiloStartBtn" onclick="hiloStart()">START</button>
    <button class="action-btn danger" id="hiloCashoutBtn" onclick="hiloCashout()" style="display:none;">CASH OUT</button>
  </div>
</div>

<!-- ============ LEADERBOARD PANEL ============ -->
<div class="game-panel" id="leaderboardPanel">
  <div class="lb-container">
    <div style="text-align:center;margin-bottom:8px;">
      <span style="font-family:'Orbitron';font-size:24px;font-weight:900;background:linear-gradient(135deg,var(--gold),#ff8800);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">ðŸ† LEADERBOARDS</span>
    </div>
    <div class="lb-tabs">
      <button class="lb-tab active" onclick="switchLB('richest',this)">ðŸ’° Richest</button>
      <button class="lb-tab" onclick="switchLB('slots',this)">ðŸŽ° Slots</button>
      <button class="lb-tab" onclick="switchLB('crash',this)">ðŸ“ˆ Crash</button>
      <button class="lb-tab" onclick="switchLB('roulette',this)">ðŸŽ¡ Roulette</button>
      <button class="lb-tab" onclick="switchLB('cases',this)">ðŸ“¦ Cases</button>
      <button class="lb-tab" onclick="switchLB('plinko',this)">âš¡ Plinko</button>
      <button class="lb-tab" onclick="switchLB('pyl',this)">ðŸŽ² Luck</button>
      <button class="lb-tab" onclick="switchLB('profit',this)">ðŸ“Š Profit</button>
    </div>
    <div class="lb-table" id="lbTable">
      <div class="lb-empty">Loading...</div>
    </div>
  </div>
</div>

<!-- ============ PROFILE PANEL ============ -->
<div class="game-panel" id="profilePanel">
  <div style="max-width:600px;margin:0 auto;padding:20px;">
    <div style="text-align:center;margin-bottom:16px;">
      <div style="font-size:48px;margin-bottom:8px;" id="profileAvatar">ðŸ‘¤</div>
      <div style="font-family:'Orbitron';font-size:22px;font-weight:900;color:var(--gold);letter-spacing:3px;" id="profileName">PLAYER</div>
      <div style="font-size:11px;color:var(--text2);letter-spacing:2px;margin-top:4px;" id="profileJoined"></div>
    </div>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px;">
      <div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:12px;text-align:center;">
        <div style="font-size:10px;color:var(--text2);letter-spacing:2px;">BALANCE</div>
        <div style="font-family:'Orbitron';font-size:18px;color:var(--gold);margin-top:4px;" id="profBalance">$0</div>
      </div>
      <div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:12px;text-align:center;">
        <div style="font-size:10px;color:var(--text2);letter-spacing:2px;">GAMES</div>
        <div style="font-family:'Orbitron';font-size:18px;color:var(--text);margin-top:4px;" id="profGames">0</div>
      </div>
      <div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:12px;text-align:center;">
        <div style="font-size:10px;color:var(--text2);letter-spacing:2px;">PROFIT</div>
        <div style="font-family:'Orbitron';font-size:18px;margin-top:4px;" id="profProfit">$0</div>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:16px;">
      <div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:12px;text-align:center;">
        <div style="font-size:10px;color:var(--text2);letter-spacing:2px;">WAGERED</div>
        <div style="font-family:'Orbitron';font-size:14px;color:var(--text);margin-top:4px;" id="profWagered">$0</div>
      </div>
      <div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:12px;text-align:center;">
        <div style="font-size:10px;color:var(--text2);letter-spacing:2px;">BIGGEST WIN</div>
        <div style="font-family:'Orbitron';font-size:14px;color:var(--green);margin-top:4px;" id="profBiggest">$0</div>
      </div>
    </div>
    <div style="margin-bottom:16px;">
      <div style="font-family:'Orbitron';font-size:13px;color:var(--gold);letter-spacing:2px;margin-bottom:8px;">ðŸ† ACHIEVEMENTS <span id="casinoAchCount" style="color:var(--text2);font-size:10px;"></span></div>
      <div id="casinoAchGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:6px;"></div>
    </div>
    <div style="margin-bottom:16px;">
      <div style="font-family:'Orbitron';font-size:13px;color:var(--gold);letter-spacing:2px;margin-bottom:8px;">ðŸŽ® GAME STATS</div>
      <div id="profGameStats" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:6px;"></div>
    </div>
    <div style="margin-bottom:16px;">
      <div style="font-family:'Orbitron';font-size:13px;color:var(--gold);letter-spacing:2px;margin-bottom:8px;">ðŸ“¦ INVENTORY VALUE</div>
      <div id="profInvValue" style="font-family:'Orbitron';font-size:20px;color:var(--green);">$0</div>
    </div>
  </div>
</div>

<!-- ============ INVENTORY OVERLAY ============ -->
<div id="inventoryOverlay">
  <div class="inv-header">
    <div class="inv-title">INVENTORY</div>
    <div style="display:flex;gap:8px;align-items:center;">
      <div style="font-family:'Orbitron';font-size:14px;color:var(--gold);">Portfolio: $<span id="invTotalValue">0</span></div>
      <button class="inv-close" onclick="hideInventory()">CLOSE</button>
    </div>
  </div>
  <div class="market-stats">
    <div class="market-stat"><div class="ms-label">Items Owned</div><div class="ms-val" id="invCount">0</div></div>
    <div class="market-stat"><div class="ms-label">Rarest Item</div><div class="ms-val" id="invRarest">â€”</div></div>
    <div class="market-stat"><div class="ms-label">Market Trend</div><div class="ms-val" id="invTrend">â€”</div></div>
  </div>
  <div class="inv-tabs">
    <button class="inv-tab active" onclick="filterInventory('all',this)">All</button>
    <button class="inv-tab" onclick="filterInventory('legendary',this)">â˜… Legendary</button>
    <button class="inv-tab" onclick="filterInventory('covert',this)">Covert</button>
    <button class="inv-tab" onclick="filterInventory('classified',this)">Classified</button>
    <button class="inv-tab" onclick="filterInventory('restricted',this)">Restricted</button>
    <button class="inv-tab" onclick="showTradePanel()" style="border-color:rgba(0,230,118,0.3);color:#00e676;">ðŸ”„ Trade</button>
  </div>
  <div class="inv-grid" id="invGrid"></div>
  <!-- Trade Panel (hidden by default) -->
  <div id="tradePanel" style="display:none;padding:16px;background:var(--surface);border:1px solid var(--border);border-radius:10px;margin-top:12px;">
    <div style="font-family:'Orbitron';font-size:14px;color:var(--gold);letter-spacing:2px;margin-bottom:10px;">ðŸ”„ TRADE ITEMS</div>
    <div style="font-size:11px;color:var(--text2);margin-bottom:10px;">Send an item to another player by username.</div>
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
      <input type="text" id="tradeRecipient" placeholder="Recipient username" maxlength="16" autocomplete="off" style="padding:8px 12px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:'Inter',sans-serif;font-size:13px;width:160px;">
      <select id="tradeItemSelect" style="padding:8px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:12px;max-width:200px;"></select>
      <button onclick="sendTrade()" style="padding:8px 16px;background:linear-gradient(135deg,rgba(0,230,118,0.2),rgba(0,230,118,0.1));border:1px solid #00e676;border-radius:6px;color:#00e676;cursor:pointer;font-family:'Orbitron';font-size:11px;letter-spacing:1px;">SEND</button>
    </div>
    <div id="tradeStatus" style="font-size:11px;color:var(--text2);margin-top:8px;"></div>
    <div style="margin-top:12px;">
      <div style="font-size:11px;color:var(--text2);letter-spacing:1px;margin-bottom:6px;">INCOMING TRADES</div>
      <div id="incomingTrades" style="font-size:11px;color:var(--text2);">No pending trades</div>
    </div>
  </div>
</div>

<!-- Firebase -->
<script type="module">
import{initializeApp}from"https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
import{getDatabase,ref,set,get,onValue,push,update,remove,off,onDisconnect}from"https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";
import{getAuth,createUserWithEmailAndPassword,signInWithEmailAndPassword,signOut,onAuthStateChanged}from"https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";

const firebaseConfig={
  apiKey:"AIzaSyAPeiUMVLTEXSMBLMoVN0BP8W94uNQLqbU",
  authDomain:"gamble-2d365.firebaseapp.com",
  databaseURL:"https://gamble-2d365-default-rtdb.firebaseio.com",
  projectId:"gamble-2d365",
  storageBucket:"gamble-2d365.firebasestorage.app",
  messagingSenderId:"542391725781",
  appId:"1:542391725781:web:671a7ae5a835e94fc57c5c",
  measurementId:"G-ZNN0H208VY"
};
const app=initializeApp(firebaseConfig);
const db=getDatabase(app);
const auth=getAuth(app);

// ============ AUTH ============
let currentUser = null;
let currentUsername = '';
let playerId = '';
let playerRef = null;

function usernameToEmail(username) {
  return username.toLowerCase().replace(/[^a-z0-9_]/g,'') + '@casinoroyale.gg';
}

function emailToUsername(email) {
  return email.replace('@casinoroyale.gg','');
}

// Auth submit (sign in or register)
window._authSubmit = async (username, password, isRegister) => {
  const email = usernameToEmail(username);
  if (username.length < 3) throw new Error('Username must be at least 3 characters');
  if (username.length > 16) throw new Error('Username max 16 characters');
  if (!/^[a-zA-Z0-9_]+$/.test(username)) throw new Error('Letters, numbers, and _ only');
  if (password.length < 6) throw new Error('Password must be at least 6 characters');

  if (isRegister) {
    // Check if username is taken
    const nameSnap = await get(ref(db, 'casino/usernames/' + username.toLowerCase()));
    if (nameSnap.exists()) throw new Error('Username already taken');
    const cred = await createUserWithEmailAndPassword(auth, email, password);
    // Reserve username
    await set(ref(db, 'casino/usernames/' + username.toLowerCase()), cred.user.uid);
    // Create player profile
    await set(ref(db, 'casino/players/' + cred.user.uid), {
      username: username,
      balance: 1000,
      created: Date.now(),
      lastPlayed: Date.now(),
      stats: { totalWagered: 0, totalWon: 0, totalProfit: 0, gamesPlayed: 0, biggestWin: 0 },
      gameStats: {
        slots: { played: 0, won: 0, biggestWin: 0 },
        crash: { played: 0, won: 0, biggestMultiplier: 0, biggestWin: 0 },
        roulette: { played: 0, won: 0, biggestWin: 0 },
        cases: { played: 0, opened: 0, bestItem: '' },
        plinko: { played: 0, won: 0, biggestWin: 0 },
        pyl: { played: 0, highScore: 0 }
      },
      dailyBonus: { lastClaimed: 0, streak: 0 }
    });
    return cred.user;
  } else {
    const cred = await signInWithEmailAndPassword(auth, email, password);
    return cred.user;
  }
};

window._authLogout = () => signOut(auth);

// Listen for auth state changes
onAuthStateChanged(auth, async (user) => {
  if (user) {
    currentUser = user;
    playerId = user.uid;
    playerRef = ref(db, 'casino/players/' + playerId);

    // Load username
    const snap = await get(playerRef);
    if (snap.exists()) {
      const data = snap.val();
      currentUsername = data.username || emailToUsername(user.email);
      if (data.balance != null) window.setBalance(data.balance);
      if (data.stocks) window._loadStocks(data.stocks);
      if (data.inventory) window._loadInventory(data.inventory);
      if (data.itemDemand) window._loadDemand(data.itemDemand);
      if (data.stats) window._loadStats(data.stats);
      if (data.gameStats) window._loadGameStats(data.gameStats);
      if (data.dailyBonus) window._loadDailyBonus(data.dailyBonus);
    } else {
      currentUsername = emailToUsername(user.email);
    }

    // Set up session ID for multiplayer
    let pylSessionId = sessionStorage.getItem('pyl_session_id');
    if (!pylSessionId) {
      pylSessionId = playerId + '_' + Math.random().toString(36).substr(2, 4);
      sessionStorage.setItem('pyl_session_id', pylSessionId);
    }
    window._pylPlayerId = pylSessionId;
    window._currentPylSessionId = pylSessionId;
    window._currentUsername = currentUsername;
    window._currentPlayerId = playerId;

    // Show casino, hide login
    window._onAuthReady(currentUsername, playerId);
  } else {
    currentUser = null;
    currentUsername = '';
    playerId = '';
    playerRef = null;
    window._onAuthLoggedOut();
  }
});

// ============ FIREBASE SAVE ============
window._firebaseSave = () => {
  if (!playerRef) return;
  const saveData = {
    username: currentUsername,
    balance: window.getBalance(),
    lastPlayed: Date.now(),
    stocks: window._getStocksData ? window._getStocksData() : null,
    inventory: window._getInventoryData ? window._getInventoryData() : null,
    itemDemand: window._getDemandData ? window._getDemandData() : null,
    stats: window._getStats ? window._getStats() : null,
    gameStats: window._getGameStats ? window._getGameStats() : null,
    dailyBonus: window._getDailyBonus ? window._getDailyBonus() : null,
  };
  // Clean nulls
  Object.keys(saveData).forEach(k => { if (saveData[k] == null) delete saveData[k]; });
  update(playerRef, saveData).catch(() => {});
  // Also update leaderboard entry for "richest"
  if (playerId && currentUsername) {
    set(ref(db, 'casino/leaderboards/richest/' + playerId), {
      name: currentUsername,
      value: window.getBalance(),
      updated: Date.now()
    }).catch(() => {});
  }
};

// ============ GAME STAT RECORDING ============
window._recordGameResult = (game, wagered, won) => {
  if (!playerRef) return;
  const profit = won - wagered;
  // Update global stats
  const statsRef = ref(db, 'casino/players/' + playerId + '/stats');
  get(statsRef).then(snap => {
    const s = snap.exists() ? snap.val() : { totalWagered: 0, totalWon: 0, totalProfit: 0, gamesPlayed: 0, biggestWin: 0 };
    s.totalWagered = (s.totalWagered || 0) + wagered;
    s.totalWon = (s.totalWon || 0) + won;
    s.totalProfit = (s.totalProfit || 0) + profit;
    s.gamesPlayed = (s.gamesPlayed || 0) + 1;
    if (won > (s.biggestWin || 0)) s.biggestWin = won;
    set(statsRef, s);
    // Update game-specific leaderboard
    if (won > 0) {
      set(ref(db, 'casino/leaderboards/' + game + '/' + playerId), {
        name: currentUsername,
        value: won,
        updated: Date.now()
      }).catch(() => {});
    }
    // Update profit leaderboard
    set(ref(db, 'casino/leaderboards/profit/' + playerId), {
      name: currentUsername,
      value: s.totalProfit,
      updated: Date.now()
    }).catch(() => {});
  }).catch(() => {});
};

// ============ LEADERBOARD FETCH ============
window._getLeaderboard = async (category) => {
  try {
    const snap = await get(ref(db, 'casino/leaderboards/' + category));
    if (!snap.exists()) return [];
    const data = snap.val();
    const entries = Object.entries(data).map(([uid, e]) => ({ uid, name: e.name, value: e.value, updated: e.updated }));
    entries.sort((a, b) => b.value - a.value);
    return entries.slice(0, 50);
  } catch { return []; }
};

// ============ DAILY BONUS ============
window._claimDailyBonus = async () => {
  if (!playerRef) return null;
  const bonusRef = ref(db, 'casino/players/' + playerId + '/dailyBonus');
  const snap = await get(bonusRef);
  const now = Date.now();
  const data = snap.exists() ? snap.val() : { lastClaimed: 0, streak: 0 };
  const lastDate = new Date(data.lastClaimed).toDateString();
  const todayDate = new Date(now).toDateString();
  if (lastDate === todayDate) return null; // Already claimed today
  const yesterdayDate = new Date(now - 86400000).toDateString();
  const newStreak = (lastDate === yesterdayDate) ? (data.streak || 0) + 1 : 1;
  const bonus = Math.min(500 + (newStreak - 1) * 100, 2000); // $500 base, +$100/day streak, max $2000
  await set(bonusRef, { lastClaimed: now, streak: newStreak });
  return { amount: bonus, streak: newStreak };
};

// ============ TRADING SYSTEM (Firebase) ============
window._sendTradeOffer = async (recipientUsername, item) => {
  if (!playerId || !currentUsername) return { error: 'Not logged in' };
  // Look up recipient UID
  const nameSnap = await get(ref(db, 'casino/usernames/' + recipientUsername));
  if (!nameSnap.exists()) return { error: 'Player not found' };
  const recipientUid = nameSnap.val();
  if (recipientUid === playerId) return { error: "Can't trade with yourself" };
  // Get item name
  const itemDef = window.ITEMS ? window.ITEMS.find(d => d.id === item.itemId) : null;
  const itemName = itemDef ? itemDef.name : item.itemId;
  // Create trade offer
  const tradeRef = push(ref(db, 'casino/trades/' + recipientUid));
  await set(tradeRef, {
    from: currentUsername,
    fromUid: playerId,
    itemId: item.itemId,
    itemName: itemName,
    timestamp: Date.now()
  });
  return { success: true };
};

window._loadPendingTrades = async () => {
  if (!playerId) return [];
  const snap = await get(ref(db, 'casino/trades/' + playerId));
  if (!snap.exists()) return [];
  const trades = [];
  snap.forEach(child => {
    trades.push({ id: child.key, ...child.val() });
  });
  return trades;
};

window._acceptTradeOffer = async (tradeId) => {
  if (!playerId) return;
  await remove(ref(db, 'casino/trades/' + playerId + '/' + tradeId));
};

// ============ PYL Firebase helpers ============
window._pylCreateRoom = (roomCode, wager) => {
  const sid = window._currentPylSessionId;
  const name = window._currentUsername || sid.slice(-5);
  const roomRef = ref(db, 'casino/pylRooms/' + roomCode);
  return set(roomRef, {
    host: sid,
    wager: wager,
    status: 'waiting',
    created: Date.now(),
    players: { [sid]: { name: name, score: null, ready: true, online: true } }
  }).then(() => {
    const playerOnlineRef = ref(db, 'casino/pylRooms/' + roomCode + '/players/' + sid + '/online');
    onDisconnect(playerOnlineRef).set(false);
    onDisconnect(roomRef).remove();
  });
};

window._pylJoinRoom = async (roomCode) => {
  const sid = window._currentPylSessionId;
  const name = window._currentUsername || sid.slice(-5);
  const roomRef = ref(db, 'casino/pylRooms/' + roomCode);
  const snap = await get(roomRef);
  if (!snap.exists()) return null;
  const data = snap.val();
  if (data.status !== 'waiting') return null;
  if (data.host === sid) return null;
  await update(ref(db, 'casino/pylRooms/' + roomCode + '/players'), {
    [sid]: { name: name, score: null, ready: true, online: true }
  });
  await update(roomRef, { status: 'playing' });
  const playerOnlineRef = ref(db, 'casino/pylRooms/' + roomCode + '/players/' + sid + '/online');
  onDisconnect(playerOnlineRef).set(false);
  onDisconnect(roomRef).cancel();
  return data;
};

window._pylSubmitRoomScore = (roomCode, score) => {
  const sid = window._currentPylSessionId;
  return update(ref(db, 'casino/pylRooms/' + roomCode + '/players/' + sid), { score: score });
};

window._pylListenRoom = (roomCode, callback) => {
  const roomRef = ref(db, 'casino/pylRooms/' + roomCode);
  onValue(roomRef, snap => { callback(snap.val()); });
  return () => off(roomRef);
};

window._pylFinishRoom = (roomCode) => {
  return update(ref(db, 'casino/pylRooms/' + roomCode), { status: 'finished' });
};

window._pylDeleteRoom = (roomCode) => {
  return remove(ref(db, 'casino/pylRooms/' + roomCode));
};

window._pylCancelDisconnect = (roomCode) => {
  const sid = window._currentPylSessionId;
  const playerOnlineRef = ref(db, 'casino/pylRooms/' + roomCode + '/players/' + sid + '/online');
  onDisconnect(playerOnlineRef).cancel();
  const roomRef = ref(db, 'casino/pylRooms/' + roomCode);
  onDisconnect(roomRef).cancel();
};

window._pylMarkOffline = (roomCode) => {
  const sid = window._currentPylSessionId;
  return update(ref(db, 'casino/pylRooms/' + roomCode + '/players/' + sid), { online: false });
};

window._pylWriteChoice = (roomCode, round, choice) => {
  const sid = window._currentPylSessionId;
  return set(ref(db, 'casino/pylRooms/' + roomCode + '/choices/' + round + '/' + sid), choice);
};

let _pylChoiceUnsub = null;
window._pylListenChoice = (roomCode, round, opponentId, callback) => {
  if (_pylChoiceUnsub) { _pylChoiceUnsub(); _pylChoiceUnsub = null; }
  const choiceRef = ref(db, 'casino/pylRooms/' + roomCode + '/choices/' + round + '/' + opponentId);
  onValue(choiceRef, snap => {
    const val = snap.val();
    if (val !== null) {
      callback(val);
      if (_pylChoiceUnsub) { _pylChoiceUnsub(); _pylChoiceUnsub = null; }
    }
  });
  _pylChoiceUnsub = () => off(choiceRef);
};

window._pylGetLeaderboard = async () => {
  const snap = await get(ref(db, 'casino/leaderboards/pyl'));
  if (!snap.exists()) return [];
  const data = snap.val();
  return Object.entries(data).map(([uid, e]) => ({ player: e.name, score: e.value })).sort((a, b) => b.score - a.score).slice(0, 20);
};

window._pylSubmitLeaderboard = (score) => {
  if (!playerId || !currentUsername) return Promise.resolve();
  return set(ref(db, 'casino/leaderboards/pyl/' + playerId), {
    name: currentUsername,
    value: score,
    updated: Date.now()
  });
};
</script>

<script>
// ============ GLOBAL STATE ============
let balance = 1000;
window.getBalance=()=>balance;
window.setBalance=(v)=>{balance=v;updateBalDisplay();};

function updateBalDisplay(){
  const el=document.getElementById('balText');
  el.textContent=balance.toFixed(2);
  el.style.transition='transform .15s';
  el.style.transform='scale(1.15)';
  setTimeout(()=>{el.style.transform='scale(1)';},150);
}

function addMoney(amt){balance+=amt;updateBalDisplay();firebaseSave();}
function firebaseSave(){if(window._firebaseSave)window._firebaseSave();}

// ============ AUTH UI ============
let authIsRegister = false;
let isGuestMode = false;

function authGuestMode() {
  isGuestMode = true;
  let guestId = localStorage.getItem('casino_guest_id');
  if (!guestId) {
    guestId = 'guest_' + Math.random().toString(36).substr(2, 8);
    localStorage.setItem('casino_guest_id', guestId);
  }
  // Load from localStorage
  const savedBal = localStorage.getItem('casino_guest_balance');
  if (savedBal != null) { balance = parseFloat(savedBal); }
  const savedStats = localStorage.getItem('casino_guest_stats');
  if (savedStats) try { playerStats = JSON.parse(savedStats); } catch(e) {}
  const savedGameStats = localStorage.getItem('casino_guest_gameStats');
  if (savedGameStats) try { gameStats = JSON.parse(savedGameStats); } catch(e) {}

  window._currentPlayerId = guestId;
  window._currentUsername = 'Guest';
  window._pylPlayerId = guestId;
  window._currentPylSessionId = guestId;

  // Override save to use localStorage
  window._firebaseSave = () => {
    localStorage.setItem('casino_guest_balance', balance.toString());
    localStorage.setItem('casino_guest_stats', JSON.stringify(playerStats));
    localStorage.setItem('casino_guest_gameStats', JSON.stringify(gameStats));
  };
  // Guests don't write to leaderboards
  window._recordGameResult = () => {};
  window._claimDailyBonus = async () => null;

  window._onAuthReady('Guest', guestId);
}

// Login screen particles
(function initLoginParticles() {
  const c = document.getElementById('loginParticles');
  if (!c) return;
  for (let i = 0; i < 40; i++) {
    const d = document.createElement('div');
    d.style.left = Math.random() * 100 + '%';
    d.style.animationDuration = (3 + Math.random() * 6) + 's';
    d.style.animationDelay = (Math.random() * 5) + 's';
    d.style.width = d.style.height = (2 + Math.random() * 3) + 'px';
    c.appendChild(d);
  }
})();

function authToggleMode() {
  authIsRegister = !authIsRegister;
  document.getElementById('authSubmitBtn').textContent = authIsRegister ? 'CREATE ACCOUNT' : 'SIGN IN';
  document.getElementById('authToggleBtn').textContent = authIsRegister ? 'BACK TO SIGN IN' : 'CREATE ACCOUNT';
  document.getElementById('authToggleText').innerHTML = authIsRegister
    ? 'Already have an account? <a onclick="authToggleMode()">Sign in</a>'
    : 'Don\'t have an account? <a onclick="authToggleMode()">Sign up</a>';
  document.getElementById('authError').textContent = '';
}

async function authSubmit() {
  const username = document.getElementById('authUsername').value.trim();
  const password = document.getElementById('authPassword').value;
  const errEl = document.getElementById('authError');
  const btn = document.getElementById('authSubmitBtn');
  errEl.textContent = '';
  btn.disabled = true;
  btn.textContent = authIsRegister ? 'CREATING...' : 'SIGNING IN...';
  try {
    await window._authSubmit(username, password, authIsRegister);
  } catch (e) {
    let msg = e.message || 'Unknown error';
    if (msg.includes('auth/email-already-in-use')) msg = 'Username already taken';
    else if (msg.includes('auth/invalid-credential') || msg.includes('auth/wrong-password') || msg.includes('auth/user-not-found')) msg = 'Invalid username or password';
    else if (msg.includes('auth/too-many-requests')) msg = 'Too many attempts. Try again later';
    else if (msg.includes('auth/weak-password')) msg = 'Password must be at least 6 characters';
    errEl.textContent = msg;
  }
  btn.disabled = false;
  btn.textContent = authIsRegister ? 'CREATE ACCOUNT' : 'SIGN IN';
}

function authLogout() {
  firebaseSave();
  isGuestMode = false;
  if (window._authLogout) window._authLogout();
  else window._onAuthLoggedOut(); // For guest mode (no Firebase auth to sign out of)
}

// Auth state callbacks (called from module)
window._onAuthReady = function(username, uid) {
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('topNav').style.display = '';
  document.getElementById('userAvatar').textContent = username[0].toUpperCase();
  document.getElementById('userNameDisplay').textContent = username;
  updateBalDisplay();
  checkDailyBonus();
};

window._onAuthLoggedOut = function() {
  if (isGuestMode) return; // Don't show login if in guest mode
  document.getElementById('loginScreen').style.display = '';
  document.getElementById('topNav').style.display = 'none';
  document.querySelectorAll('.game-panel').forEach(p => p.classList.remove('active'));
};

// Enter key on login
document.getElementById('authPassword').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') authSubmit();
});
document.getElementById('authUsername').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') document.getElementById('authPassword').focus();
});

// ============ STATS TRACKING ============
let playerStats = { totalWagered: 0, totalWon: 0, totalProfit: 0, gamesPlayed: 0, biggestWin: 0 };
let gameStats = {
  slots: { played: 0, won: 0, biggestWin: 0 },
  crash: { played: 0, won: 0, biggestMultiplier: 0, biggestWin: 0 },
  roulette: { played: 0, won: 0, biggestWin: 0 },
  cases: { played: 0, opened: 0, bestItem: '' },
  plinko: { played: 0, won: 0, biggestWin: 0 },
  pyl: { played: 0, highScore: 0 },
  blackjack: { played: 0, won: 0, biggestWin: 0 },
  mines: { played: 0, won: 0, biggestWin: 0 },
  dice: { played: 0, won: 0, biggestWin: 0 },
  tower: { played: 0, won: 0, biggestWin: 0 },
  coinflip: { played: 0, won: 0, biggestWin: 0 },
  keno: { played: 0, won: 0, biggestWin: 0 },
  limbo: { played: 0, won: 0, biggestWin: 0 },
  poker: { played: 0, won: 0, biggestWin: 0 },
  horses: { played: 0, won: 0, biggestWin: 0 },
  scratch: { played: 0, won: 0, biggestWin: 0 },
  wheel: { played: 0, won: 0, biggestWin: 0 },
  baccarat: { played: 0, won: 0, biggestWin: 0 },
  hilo: { played: 0, won: 0, biggestWin: 0 }
};
let dailyBonusData = { lastClaimed: 0, streak: 0 };

window._loadStats = (s) => { if (s) playerStats = { ...playerStats, ...s }; };
window._loadGameStats = (gs) => { if (gs) gameStats = { ...gameStats, ...gs }; };
window._loadDailyBonus = (db) => { if (db) dailyBonusData = { ...dailyBonusData, ...db }; checkDailyBonus(); };
window._getStats = () => playerStats;
window._getGameStats = () => gameStats;
window._getDailyBonus = () => dailyBonusData;

function recordGame(game, wagered, won) {
  const profit = won - wagered;
  playerStats.totalWagered += wagered;
  playerStats.totalWon += won;
  playerStats.totalProfit += profit;
  playerStats.gamesPlayed++;
  if (won > playerStats.biggestWin) playerStats.biggestWin = won;
  if (gameStats[game]) {
    gameStats[game].played = (gameStats[game].played || 0) + 1;
    if (won > 0) gameStats[game].won = (gameStats[game].won || 0) + 1;
    if (won > (gameStats[game].biggestWin || 0)) gameStats[game].biggestWin = won;
  }
  if (window._recordGameResult) window._recordGameResult(game, wagered, won);
  firebaseSave();
  // Check achievements after recording
  checkCasinoAchievements(game, wagered, won);
}

function addResultDot(containerId,label,isWin){
  const c=document.getElementById(containerId);if(!c)return;
  const dot=document.createElement('span');dot.className='result-dot';
  dot.style.background=isWin?'var(--green)':'var(--red)';dot.textContent=label;
  c.appendChild(dot);if(c.children.length>20)c.removeChild(c.firstChild);
}

// ============ DAILY BONUS ============
function checkDailyBonus() {
  const btn = document.getElementById('dailyBonusBtn');
  if (!btn) return;
  const lastDate = new Date(dailyBonusData.lastClaimed).toDateString();
  const todayDate = new Date().toDateString();
  if (lastDate === todayDate) {
    btn.disabled = true;
    btn.textContent = 'âœ“ CLAIMED';
  } else {
    btn.disabled = false;
    btn.textContent = 'ðŸŽ DAILY';
  }
}

async function claimDailyBonus() {
  const btn = document.getElementById('dailyBonusBtn');
  btn.disabled = true;
  btn.textContent = '...';
  try {
    const result = await window._claimDailyBonus();
    if (result) {
      addMoney(result.amount);
      dailyBonusData.lastClaimed = Date.now();
      dailyBonusData.streak = result.streak;
      showToast('ðŸŽ Daily Bonus: $' + result.amount + ' (Day ' + result.streak + ' streak!)', true);
      btn.textContent = 'âœ“ CLAIMED';
    } else {
      showToast('Already claimed today!', false);
      btn.textContent = 'âœ“ CLAIMED';
    }
  } catch (e) {
    btn.disabled = false;
    btn.textContent = 'ðŸŽ DAILY';
    showToast('Error claiming bonus', false);
  }
}

// ============ GLOBAL LEADERBOARD ============
let currentLBCategory = 'richest';

function switchLB(category, btn) {
  currentLBCategory = category;
  document.querySelectorAll('.lb-tab').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  loadLeaderboard(category);
}

async function loadLeaderboard(category) {
  const container = document.getElementById('lbTable');
  container.innerHTML = '<div class="lb-empty">Loading...</div>';
  
  if (!window._getLeaderboard) {
    container.innerHTML = '<div class="lb-empty">Not connected</div>';
    return;
  }

  try {
    const entries = await window._getLeaderboard(category);
    if (entries.length === 0) {
      container.innerHTML = '<div class="lb-empty">No entries yet. Start playing to get on the board!</div>';
      return;
    }
const myId = window._currentPlayerId || '';
const labels = {
      richest: { col: 'Balance', fmt: v => '$' + v.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2}) },
      slots: { col: 'Biggest Win', fmt: v => '$' + v.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2}) },
      crash: { col: 'Biggest Win', fmt: v => '$' + v.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2}) },
      roulette: { col: 'Biggest Win', fmt: v => '$' + v.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2}) },
      cases: { col: 'Biggest Win', fmt: v => '$' + v.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2}) },
      plinko: { col: 'Biggest Win', fmt: v => '$' + v.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2}) },
      pyl: { col: 'High Score', fmt: v => v.toLocaleString() + ' pts' },
      profit: { col: 'Total Profit', fmt: v => (v >= 0 ? '+$' : '-$') + Math.abs(v).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2}) },
    };
    const cfg = labels[category] || labels.richest;

    container.innerHTML = entries.map((e, i) => {
      const medal = i === 0 ? 'ðŸ¥‡' : i === 1 ? 'ðŸ¥ˆ' : i === 2 ? 'ðŸ¥‰' : (i + 1) + '.';
      const isMe = e.uid === myId;
      return '<div class="lb-data-row' + (isMe ? ' me' : '') + '">' +
        '<span class="lb-col-rank">' + medal + '</span>' +
        '<span class="lb-col-name">' + e.name + (isMe ? ' (you)' : '') + '</span>' +
        '<span class="lb-col-val">' + cfg.fmt(e.value) + '</span>' +
        '</div>';
    }).join('');
  } catch (e) {
    container.innerHTML = '<div class="lb-empty">Error loading leaderboard</div>';
  }
}


// ============ NAV DROPDOWN HELPERS ============
function openCat(el){el.classList.add('open');}
function closeCat(el){el.classList.remove('open');}
// Close dropdowns if clicking outside
document.addEventListener('click',function(e){if(!e.target.closest('.nav-cat'))document.querySelectorAll('.nav-cat').forEach(c=>c.classList.remove('open'));});
// How-to-play toggle
function htpToggle(el){el.closest('.htp-box').classList.toggle('open');}
function showToast(msg,isWin=true){
  const t=document.getElementById('winToast');
  t.textContent=msg;t.className='win-toast'+(isWin?'':' loss');
  setTimeout(()=>t.classList.add('show'),10);
  setTimeout(()=>t.classList.remove('show'),2500);
}

function switchGame(game,btn){
  document.querySelectorAll('.game-panel').forEach(p=>p.classList.remove('active'));
  document.getElementById(game+'Panel').classList.add('active');
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  if(btn)btn.classList.add('active');
  if(game==='plinko'&&!plinkoInitialized)initPlinko();
  if(game==='roulette'&&!rouletteDrawn)drawRouletteWheel(0);
  if(game==='crash')resizeCrashCanvas();
  if(game==='profile')renderProfile();
  if(game==='stocks')renderStocks();
  if(game==='leaderboard')loadLeaderboard(currentLBCategory);
  if(game==='wheel'&&!wheelDrawn)drawWheel(0);
  if(game==='keno')kenoInit();
  if(game==='horses')horseInit();
  if(game==='mines')minesRenderGrid();
  if(game==='dice')diceUpdateSlider();
  if(game==='luck'){
    let iframe=document.getElementById('pylIframe');
    if(!iframe){
      // Create iframe dynamically so it doesn't interfere before needed
      iframe=document.createElement('iframe');
      iframe.id='pylIframe';
      iframe.allow='autoplay';
      document.getElementById('luckPanel').insertBefore(iframe,document.getElementById('luckPanel').firstChild);
    }
    if(!iframe.src||!iframe.src.includes('push-your-luck')){
      // Delay loading so iframe has real layout dimensions before Phaser inits
      setTimeout(()=>{ iframe.src='push-your-luck/index.html'; }, 300);
    }
    pylLoadLeaderboard();
  }
  firebaseSave(); // Save on every game switch
}

function adjustBet(id,mult){
  const el=document.getElementById(id);
  el.value=Math.max(1,Math.round(parseFloat(el.value||10)*mult));
}

// ============ PARTICLES ============
const pCanvas=document.getElementById('particles');
const pCtx=pCanvas.getContext('2d');
let particles=[];
function resizeParticles(){pCanvas.width=window.innerWidth;pCanvas.height=window.innerHeight;}
resizeParticles();window.addEventListener('resize',resizeParticles);

function spawnParticles(x,y,count=30,colors=['#ffd700','#ff8800','#00f0ff','#ff00e5','#00ff88']){
  for(let i=0;i<count;i++){
    const angle=Math.random()*Math.PI*2;
    const speed=Math.random()*10+3;
    particles.push({x,y,vx:Math.cos(angle)*speed,vy:Math.sin(angle)*speed-3,
      life:1,decay:Math.random()*.015+.008,size:Math.random()*5+2,
      color:colors[Math.floor(Math.random()*colors.length)]});
  }
}
function updateParticles(){
  pCtx.clearRect(0,0,pCanvas.width,pCanvas.height);
  particles=particles.filter(p=>{
    p.x+=p.vx;p.y+=p.vy;p.vy+=.12;p.life-=p.decay;p.vx*=.99;
    if(p.life<=0)return false;
    pCtx.globalAlpha=p.life;pCtx.fillStyle=p.color;
    pCtx.shadowColor=p.color;pCtx.shadowBlur=p.size*2;
    pCtx.beginPath();pCtx.arc(p.x,p.y,p.size*p.life,0,Math.PI*2);pCtx.fill();
    return true;
  });
  pCtx.globalAlpha=1;pCtx.shadowBlur=0;
  requestAnimationFrame(updateParticles);
}
updateParticles();

// ============ SOUND ============
const audioCtx=new(window.AudioContext||window.webkitAudioContext)();
function playSound(freq,type='sine',dur=0.15,vol=0.1){
  try{
    const o=audioCtx.createOscillator();const g=audioCtx.createGain();
    o.connect(g);g.connect(audioCtx.destination);o.type=type;o.frequency.value=freq;
    g.gain.setValueAtTime(vol,audioCtx.currentTime);g.gain.exponentialRampToValueAtTime(.001,audioCtx.currentTime+dur);
    o.start();o.stop(audioCtx.currentTime+dur);
  }catch(e){}
}
function playWinSound(){playSound(523,'sine',.1,.12);setTimeout(()=>playSound(659,'sine',.1,.12),80);
  setTimeout(()=>playSound(784,'sine',.15,.12),160);setTimeout(()=>playSound(1047,'sine',.25,.1),240);}
function playLoseSound(){playSound(200,'sawtooth',.25,.06);setTimeout(()=>playSound(150,'sawtooth',.3,.05),100);}
function playClickSound(){playSound(800,'sine',.04,.06);}

// ============ MUTE TOGGLE ============
let soundMuted = false;
function toggleMute() {
  soundMuted = !soundMuted;
  const btn = document.getElementById('muteBtn');
  btn.textContent = soundMuted ? 'ðŸ”‡' : 'ðŸ”Š';
  btn.style.opacity = soundMuted ? '0.5' : '1';
}
// Wrap playSound with mute check
const _origPlaySound = playSound;
playSound = function(freq, type, dur, vol) {
  if (soundMuted) return;
  _origPlaySound(freq, type, dur, vol);
};

// ============ CASINO ACHIEVEMENTS ============
const CASINO_ACHIEVEMENTS = [
  { id:'first_game', icon:'ðŸŽ®', name:'FIRST SPIN', desc:'Play your first game' },
  { id:'first_win', icon:'ðŸ†', name:'WINNER', desc:'Win your first bet' },
  { id:'high_roller', icon:'ðŸ’°', name:'HIGH ROLLER', desc:'Wager $10,000 total' },
  { id:'whale', icon:'ðŸ‹', name:'WHALE', desc:'Wager $100,000 total' },
  { id:'big_win', icon:'ðŸ’Ž', name:'BIG WIN', desc:'Win $5,000+ in a single bet' },
  { id:'mega_win', icon:'ðŸ‘‘', name:'MEGA WIN', desc:'Win $50,000+ in a single bet' },
  { id:'broke', icon:'ðŸ“‰', name:'ROCK BOTTOM', desc:'Lose all your money (balance $0)' },
  { id:'comeback', icon:'ðŸ”¥', name:'COMEBACK KID', desc:'Go from under $100 to over $10,000' },
  { id:'games_50', icon:'â­', name:'REGULAR', desc:'Play 50 games' },
  { id:'games_500', icon:'ðŸŒŸ', name:'VETERAN', desc:'Play 500 games' },
  { id:'games_5000', icon:'âœ¨', name:'LEGEND', desc:'Play 5,000 games' },
  { id:'slots_pro', icon:'ðŸŽ°', name:'SLOTS PRO', desc:'Win 50 times at Slots' },
  { id:'crash_pro', icon:'ðŸ“ˆ', name:'CRASH MASTER', desc:'Win 50 times at Crash' },
  { id:'diversified', icon:'ðŸŽ¯', name:'DIVERSIFIED', desc:'Play 5+ different games' },
  { id:'collector', icon:'ðŸŽ’', name:'COLLECTOR', desc:'Own 10+ inventory items' },
  { id:'daily_7', icon:'ðŸ“…', name:'DEDICATED', desc:'Claim 7 daily bonuses (streak)' },
  { id:'profit_10k', icon:'ðŸ“Š', name:'PROFITABLE', desc:'Reach $10,000 total profit' },
  { id:'inv_value', icon:'ðŸ’¼', name:'PORTFOLIO', desc:'Inventory worth $10,000+' }
];

function getCasinoAch() {
  try { return JSON.parse(localStorage.getItem('casino_achievements') || '{}'); }
  catch { return {}; }
}
function saveCasinoAch(id) {
  const a = getCasinoAch();
  if (a[id]) return false;
  a[id] = Date.now();
  localStorage.setItem('casino_achievements', JSON.stringify(a));
  return true;
}
function checkCasinoAchievements(game, wagered, won) {
  const newAchs = [];
  function tryAward(id) {
    if (saveCasinoAch(id)) {
      const a = CASINO_ACHIEVEMENTS.find(x => x.id === id);
      if (a) { newAchs.push(a); showAchToast(a); }
    }
  }
  // First game
  tryAward('first_game');
  // First win
  if (won > 0) tryAward('first_win');
  // Big wins
  if (won >= 5000) tryAward('big_win');
  if (won >= 50000) tryAward('mega_win');
  // Wagering milestones
  if (playerStats.totalWagered >= 10000) tryAward('high_roller');
  if (playerStats.totalWagered >= 100000) tryAward('whale');
  // Games played
  if (playerStats.gamesPlayed >= 50) tryAward('games_50');
  if (playerStats.gamesPlayed >= 500) tryAward('games_500');
  if (playerStats.gamesPlayed >= 5000) tryAward('games_5000');
  // Game-specific
  if (gameStats.slots && gameStats.slots.won >= 50) tryAward('slots_pro');
  if (gameStats.crash && gameStats.crash.won >= 50) tryAward('crash_pro');
  // Diversified
  const gamesPlayed = Object.values(gameStats).filter(g => g.played > 0).length;
  if (gamesPlayed >= 5) tryAward('diversified');
  // Broke
  if (balance <= 0) tryAward('broke');
  // Profit
  if (playerStats.totalProfit >= 10000) tryAward('profit_10k');
  // Collector
  if (inventory.length >= 10) tryAward('collector');
  // Inventory value
  if (typeof getInventoryValue === 'function' && getInventoryValue() >= 10000) tryAward('inv_value');
  // Daily streak
  if (dailyBonusData.streak >= 7) tryAward('daily_7');
  // Comeback
  if (balance >= 10000 && (getCasinoAch()['broke'])) tryAward('comeback');
  return newAchs;
}
function showAchToast(ach) {
  showToast(ach.icon + ' Achievement: ' + ach.name + ' â€” ' + ach.desc, true);
}

// ============ PROFILE RENDER ============
function renderProfile() {
  const name = document.getElementById('userNameDisplay').textContent || 'PLAYER';
  document.getElementById('profileName').textContent = name;
  document.getElementById('profileAvatar').textContent = name.charAt(0).toUpperCase();
  document.getElementById('profBalance').textContent = '$' + balance.toFixed(2);
  document.getElementById('profGames').textContent = playerStats.gamesPlayed.toLocaleString();
  const profit = playerStats.totalProfit;
  const profEl = document.getElementById('profProfit');
  profEl.textContent = (profit >= 0 ? '+' : '') + '$' + profit.toFixed(2);
  profEl.style.color = profit >= 0 ? 'var(--green)' : 'var(--red)';
  document.getElementById('profWagered').textContent = '$' + playerStats.totalWagered.toFixed(2);
  document.getElementById('profBiggest').textContent = '$' + playerStats.biggestWin.toFixed(2);
  if (typeof getInventoryValue === 'function') {
    document.getElementById('profInvValue').textContent = '$' + getInventoryValue().toFixed(2);
  }
  // Achievements
  const achs = getCasinoAch();
  const count = Object.keys(achs).length;
  document.getElementById('casinoAchCount').textContent = '(' + count + '/' + CASINO_ACHIEVEMENTS.length + ')';
  document.getElementById('casinoAchGrid').innerHTML = CASINO_ACHIEVEMENTS.map(a => {
    const done = !!achs[a.id];
    return `<div style="display:flex;align-items:center;gap:8px;padding:8px;background:var(--surface);border:1px solid ${done?'var(--gold)':'var(--border)'};border-radius:6px;opacity:${done?1:0.35}">
      <span style="font-size:18px">${a.icon}</span>
      <div style="flex:1;min-width:0"><div style="font-size:11px;font-weight:bold;color:${done?'var(--gold)':'var(--text)'};letter-spacing:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${a.name}</div>
      <div style="font-size:9px;color:var(--text2)">${a.desc}</div></div>
      ${done ? '<span style="color:var(--green)">âœ“</span>' : ''}
    </div>`;
  }).join('');
  // Game stats
  document.getElementById('profGameStats').innerHTML = Object.entries(gameStats).map(([name, s]) => {
    if (!s.played) return '';
    const wr = s.played > 0 ? Math.round((s.won / s.played) * 100) : 0;
    return `<div style="background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:8px;">
      <div style="font-size:10px;color:var(--text2);letter-spacing:1px;text-transform:uppercase">${name}</div>
      <div style="font-size:13px;color:var(--text);margin-top:2px">${s.played} played Â· ${wr}% WR</div>
      <div style="font-size:10px;color:var(--green)">Best: $${(s.biggestWin||0).toFixed(0)}</div>
    </div>`;
  }).filter(Boolean).join('');
}

// ============ TRADING SYSTEM ============
function showTradePanel() {
  const panel = document.getElementById('tradePanel');
  panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
  if (panel.style.display === 'block') {
    populateTradeSelect();
    loadIncomingTrades();
  }
}
function populateTradeSelect() {
  const sel = document.getElementById('tradeItemSelect');
  sel.innerHTML = '<option value="">Select item...</option>';
  inventory.forEach(item => {
    const itemDef = ITEMS ? ITEMS.find(d => d.id === item.itemId) : null;
    const name = itemDef ? itemDef.name : item.itemId;
    const val = typeof getItemMarketValue === 'function' ? getItemMarketValue(item.itemId) : 0;
    sel.innerHTML += `<option value="${item.id}">${name} ($${val.toFixed(0)})</option>`;
  });
}
async function sendTrade() {
  const recipient = document.getElementById('tradeRecipient').value.trim().toLowerCase();
  const invId = parseInt(document.getElementById('tradeItemSelect').value);
  const status = document.getElementById('tradeStatus');
  if (!recipient) { status.textContent = 'Enter a recipient username'; status.style.color = 'var(--red)'; return; }
  if (!invId) { status.textContent = 'Select an item to trade'; status.style.color = 'var(--red)'; return; }
  if (!window._sendTradeOffer) { status.textContent = 'Trading unavailable (not logged in)'; status.style.color = 'var(--red)'; return; }
  status.textContent = 'Sending...';
  status.style.color = 'var(--text2)';
  try {
    const item = inventory.find(x => x.id === invId);
    if (!item) throw new Error('Item not found');
    const result = await window._sendTradeOffer(recipient, item);
    if (result.error) throw new Error(result.error);
    removeFromInventory(invId);
    renderInventory();
    populateTradeSelect();
    status.textContent = 'Item sent to ' + recipient + '!';
    status.style.color = 'var(--green)';
    showToast('ðŸ“¦ Item sent to ' + recipient, true);
    firebaseSave();
  } catch (e) {
    status.textContent = e.message || 'Trade failed';
    status.style.color = 'var(--red)';
  }
}
async function loadIncomingTrades() {
  const div = document.getElementById('incomingTrades');
  if (!window._loadPendingTrades) { div.textContent = 'Login to see trades'; return; }
  try {
    const trades = await window._loadPendingTrades();
    if (!trades || trades.length === 0) { div.textContent = 'No pending trades'; return; }
    div.innerHTML = trades.map(t => `<div style="display:flex;align-items:center;gap:8px;padding:6px;border-bottom:1px solid var(--border);">
      <span>ðŸ“¦ ${t.itemName} from <strong>${t.from}</strong></span>
      <button onclick="acceptTrade('${t.id}','${t.itemId}')" style="padding:4px 10px;border:1px solid var(--green);background:transparent;color:var(--green);border-radius:4px;cursor:pointer;font-size:10px;">ACCEPT</button>
    </div>`).join('');
  } catch (e) {
    div.textContent = 'Error loading trades';
  }
}
async function acceptTrade(tradeId, itemId) {
  if (!window._acceptTradeOffer) return;
  try {
    await window._acceptTradeOffer(tradeId);
    addToInventory(itemId);
    renderInventory();
    loadIncomingTrades();
    showToast('ðŸ“¦ Trade accepted!', true);
    firebaseSave();
  } catch (e) {
    showToast('Error accepting trade', false);
  }
}

// ============ SLOTS ============
const SYMBOLS=['ðŸ’','ðŸ‹','ðŸ””','ðŸ’Ž','7ï¸âƒ£','ðŸ€','â­','ðŸ‘‘'];
const SYMBOL_VALUES={'ðŸ‘‘':50,'7ï¸âƒ£':25,'ðŸ’Ž':15,'â­':10,'ðŸ””':8,'ðŸ€':6,'ðŸ‹':4,'ðŸ’':3};
const REEL_COUNT=5;
const SYM_H=93;
const VISIBLE=3;
let slotsSpinning=false;

function initSlots(){
  const container=document.getElementById('reelsContainer');
  for(let r=0;r<REEL_COUNT;r++){
    const win=document.createElement('div');win.className='reel-window';
    const strip=document.createElement('div');strip.className='reel-strip';strip.id='reel'+r;
    for(let i=0;i<60;i++){
      const sym=document.createElement('div');sym.className='reel-symbol';
      sym.textContent=SYMBOLS[Math.floor(Math.random()*SYMBOLS.length)];
      strip.appendChild(sym);
    }
    win.appendChild(strip);container.appendChild(win);
    strip.style.transform='translateY(-'+(28*SYM_H)+'px)';
  }
}

function spinSlots(){
  if(slotsSpinning)return;
  const bet=parseFloat(document.getElementById('slotsBet').value)||10;
  if(bet>balance){showToast('Not enough balance!',false);return;}
  if(bet<=0)return;
  slotsSpinning=true;balance-=bet;updateBalDisplay();
  document.getElementById('spinBtn').disabled=true;
  playClickSound();

  // Determine results
  const results=[];
  for(let r=0;r<REEL_COUNT;r++) results.push(SYMBOLS[Math.floor(Math.random()*SYMBOLS.length)]);

  for(let r=0;r<REEL_COUNT;r++){
    const strip=document.getElementById('reel'+r);
    const children=strip.children;
    // Randomize all symbols
    for(let i=0;i<children.length;i++){
      children[i].textContent=SYMBOLS[Math.floor(Math.random()*SYMBOLS.length)];
    }
    // Place result at target position (center of view = index 1 of visible 3)
    const targetIdx=42+r*2;
    children[targetIdx].textContent=results[r];

    setTimeout(()=>{
      // Reset to top
      strip.style.transition='none';
      strip.style.transform='translateY(0px)';
      void strip.offsetWidth;
      // Animate to target
      strip.style.transition='transform '+(1.2+r*0.25)+'s cubic-bezier(.15,.72,.12,1)';
      strip.style.transform='translateY(-'+((targetIdx-1)*SYM_H)+'px)';
      playSound(300+r*50,'square',.04,.03);
    },r*120);
  }

  const totalDuration=1200+REEL_COUNT*250+300;
  setTimeout(()=>{
    // Count matches
    const counts={};
    results.forEach(s=>{counts[s]=(counts[s]||0)+1;});
    let maxCount=0,maxSym='';
    for(const[s,c]of Object.entries(counts)){if(c>maxCount){maxCount=c;maxSym=s;}}

    let winAmount=0;
    if(maxCount>=3){
      const mult=SYMBOL_VALUES[maxSym]||3;
      if(maxCount===3)winAmount=bet*mult*0.5;
      else if(maxCount===4)winAmount=bet*mult*2;
      else winAmount=bet*mult*10;
      winAmount=Math.round(winAmount*100)/100;
    }

    if(winAmount>0){
      balance+=winAmount;updateBalDisplay();
      showToast('WIN $'+winAmount.toFixed(2)+'!');
      playWinSound();
      const rect=document.querySelector('.slots-machine').getBoundingClientRect();
      spawnParticles(rect.left+rect.width/2,rect.top+rect.height/2,40+winAmount/10);
    }else{
      showToast('-$'+bet.toFixed(2),false);
      playLoseSound();
    }

    recordGame('slots', bet, winAmount);
    firebaseSave();
    slotsSpinning=false;
    document.getElementById('spinBtn').disabled=false;

    // Reset strips for next spin
    setTimeout(()=>{
      for(let r=0;r<REEL_COUNT;r++){
        const strip=document.getElementById('reel'+r);
        for(let i=0;i<strip.children.length;i++){
          strip.children[i].textContent=SYMBOLS[Math.floor(Math.random()*SYMBOLS.length)];
        }
        strip.style.transition='none';
        strip.style.transform='translateY(-'+(28*SYM_H)+'px)';
      }
    },400);
  },totalDuration);
}

// ============ CRASH ============
let crashRunning=false,crashBetAmount=0,crashCashedOut=false;
let crashMultVal=1,crashPoint=0,crashStartTime=0,crashHistory=[];

function resizeCrashCanvas(){
  const c=document.getElementById('crashCanvas');
  if(!c)return;
  c.width=c.offsetWidth*2;c.height=c.offsetHeight*2;
  if(!crashRunning)drawCrashGraph();
}

function drawCrashGraph(){
  const c=document.getElementById('crashCanvas');if(!c)return;
  const ctx=c.getContext('2d');
  const w=c.width,h=c.height;
  ctx.clearRect(0,0,w,h);

  // Grid lines
  ctx.strokeStyle='rgba(255,255,255,.04)';ctx.lineWidth=1;
  for(let i=1;i<10;i++){
    const y=h*(1-i/10);
    ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(w,y);ctx.stroke();
  }

  if(crashHistory.length<2)return;

  const maxMult=Math.max(...crashHistory.map(p=>p.m),2);

  // Gradient fill
  ctx.beginPath();
  crashHistory.forEach((p,i)=>{
    const x=(i/(crashHistory.length-1||1))*w;
    const y=h-((p.m-1)/Math.max(maxMult-1,.1))*(h*0.82)-h*0.06;
    if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);
  });
  const lastX=w,lastY=h-((crashHistory[crashHistory.length-1].m-1)/Math.max(maxMult-1,.1))*(h*0.82)-h*0.06;
  ctx.lineTo(lastX,h);ctx.lineTo(0,h);ctx.closePath();
  const grad=ctx.createLinearGradient(0,0,0,h);
  const col=crashRunning&&!crashCashedOut?'0,240,255':(crashCashedOut?'0,255,136':'255,51,85');
  grad.addColorStop(0,'rgba('+col+',.2)');grad.addColorStop(1,'rgba('+col+',0)');
  ctx.fillStyle=grad;ctx.fill();

  // Line
  ctx.beginPath();
  const lineColor=crashRunning&&!crashCashedOut?'#00f0ff':(crashCashedOut?'#00ff88':'#ff3355');
  ctx.strokeStyle=lineColor;ctx.lineWidth=4;ctx.shadowColor=lineColor;ctx.shadowBlur=12;
  crashHistory.forEach((p,i)=>{
    const x=(i/(crashHistory.length-1||1))*w;
    const y=h-((p.m-1)/Math.max(maxMult-1,.1))*(h*0.82)-h*0.06;
    if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);
  });
  ctx.stroke();
  ctx.shadowBlur=0;

  // Dot at end
  if(crashHistory.length>1){
    const lp=crashHistory[crashHistory.length-1];
    const dx=(1)*w;
    const dy=h-((lp.m-1)/Math.max(maxMult-1,.1))*(h*0.82)-h*0.06;
    ctx.beginPath();ctx.arc(dx,dy,6,0,Math.PI*2);ctx.fillStyle=lineColor;ctx.fill();
    ctx.beginPath();ctx.arc(dx,dy,10,0,Math.PI*2);ctx.strokeStyle=lineColor;ctx.lineWidth=2;
    ctx.globalAlpha=.4;ctx.stroke();ctx.globalAlpha=1;
  }
}

function startCrash(){
  if(crashRunning)return;
  const bet=parseFloat(document.getElementById('crashBet').value)||10;
  if(bet>balance){showToast('Not enough balance!',false);return;}
  if(bet<=0)return;

  crashBetAmount=bet;balance-=bet;updateBalDisplay();
  crashCashedOut=false;crashRunning=true;
  crashMultVal=1;crashHistory=[{t:0,m:1}];
  // House edge ~4%
  crashPoint=1+(0.96/(1-Math.random()))-0.96;
  if(crashPoint<1.02)crashPoint=1.02;

  document.getElementById('crashStartBtn').style.display='none';
  document.getElementById('cashoutBtn').style.display='';
  document.getElementById('crashStatus').textContent='Multiplier rising...';
  document.getElementById('crashMultiplier').className='crash-multiplier';

  crashStartTime=performance.now();
  playClickSound();
  animateCrash();
}

function animateCrash(){
  if(!crashRunning)return;
  const elapsed=(performance.now()-crashStartTime)/1000;
  crashMultVal=Math.pow(Math.E,0.06*elapsed*elapsed+0.04*elapsed);
  crashMultVal=Math.round(crashMultVal*100)/100;
  if(crashMultVal<1)crashMultVal=1;
  crashHistory.push({t:elapsed,m:crashMultVal});
  if(crashHistory.length>500)crashHistory.splice(0,crashHistory.length-500);

  document.getElementById('crashMultiplier').textContent=crashMultVal.toFixed(2)+'Ã—';
  drawCrashGraph();

  if(crashMultVal>=crashPoint){
    crashRunning=false;
    document.getElementById('crashMultiplier').textContent=crashPoint.toFixed(2)+'Ã—';
    document.getElementById('crashMultiplier').className='crash-multiplier crashed';
    document.getElementById('crashStatus').textContent='CRASHED at '+crashPoint.toFixed(2)+'Ã—';
    document.getElementById('crashStartBtn').style.display='';
    document.getElementById('cashoutBtn').style.display='none';

    if(!crashCashedOut){
      showToast('CRASHED! -$'+crashBetAmount.toFixed(2),false);playLoseSound();
      recordGame('crash', crashBetAmount, 0);
    }
    firebaseSave();drawCrashGraph();return;
  }
  requestAnimationFrame(animateCrash);
}

function cashOut(){
  if(!crashRunning||crashCashedOut)return;
  crashCashedOut=true;
  const winnings=crashBetAmount*crashMultVal;
  balance+=winnings;updateBalDisplay();
  crashRunning=false;

  document.getElementById('crashStatus').textContent='Cashed out at '+crashMultVal.toFixed(2)+'Ã— â€” Won $'+winnings.toFixed(2);
  document.getElementById('crashStartBtn').style.display='';
  document.getElementById('cashoutBtn').style.display='none';

  showToast('WIN $'+winnings.toFixed(2)+'!');
  playWinSound();
  spawnParticles(window.innerWidth/2,window.innerHeight/2,40);
  recordGame('crash', crashBetAmount, winnings);
  if (crashMultVal > (gameStats.crash.biggestMultiplier || 0)) gameStats.crash.biggestMultiplier = crashMultVal;
  firebaseSave();drawCrashGraph();
}

// ============ ROULETTE ============
const ROUL_NUMS=[0,32,15,19,4,21,2,25,17,34,6,27,13,36,11,30,8,23,10,5,24,16,33,1,20,14,31,9,22,18,29,7,28,12,35,3,26];
const RED_NUMS=new Set([1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36]);
let rouletteSpinning=false,rouletteAngle=0,selectedRoulBet=null,rouletteDrawn=false;

function selectRoulBet(type,btn){
  selectedRoulBet=type;playClickSound();
  document.querySelectorAll('.roul-bet-btn').forEach(b=>b.classList.remove('selected'));
  if(btn)btn.classList.add('selected');
}

function drawRouletteWheel(angle){
  rouletteDrawn=true;
  const c=document.getElementById('rouletteCanvas');const ctx=c.getContext('2d');
  const cx=c.width/2,cy=c.height/2,r=c.width/2-10;
  ctx.clearRect(0,0,c.width,c.height);

  const n=ROUL_NUMS.length;
  const sliceAngle=Math.PI*2/n;

  ROUL_NUMS.forEach((num,i)=>{
    const start=angle+i*sliceAngle;const end=start+sliceAngle;
    ctx.beginPath();ctx.moveTo(cx,cy);ctx.arc(cx,cy,r,start,end);ctx.closePath();
    if(num===0)ctx.fillStyle='#00884a';
    else if(RED_NUMS.has(num))ctx.fillStyle='#cc2233';
    else ctx.fillStyle='#1a1a1a';
    ctx.fill();
    ctx.strokeStyle='rgba(255,255,255,.15)';ctx.lineWidth=1;ctx.stroke();

    // Number
    const ta=start+sliceAngle/2;
    const tx=cx+Math.cos(ta)*(r*0.78);const ty=cy+Math.sin(ta)*(r*0.78);
    ctx.save();ctx.translate(tx,ty);ctx.rotate(ta+Math.PI/2);
    ctx.fillStyle='#fff';ctx.font='bold 11px Inter';ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.fillText(num.toString(),0,0);ctx.restore();
  });

  // Inner ring
  ctx.beginPath();ctx.arc(cx,cy,r*0.15,0,Math.PI*2);
  const cg=ctx.createRadialGradient(cx,cy,0,cx,cy,r*0.15);
  cg.addColorStop(0,'#2a2a5e');cg.addColorStop(1,'#15153a');
  ctx.fillStyle=cg;ctx.fill();
  ctx.strokeStyle='rgba(255,215,0,.5)';ctx.lineWidth=2;ctx.stroke();

  // Outer ring
  ctx.beginPath();ctx.arc(cx,cy,r+3,0,Math.PI*2);
  ctx.strokeStyle='rgba(255,215,0,.25)';ctx.lineWidth=5;ctx.stroke();
  ctx.beginPath();ctx.arc(cx,cy,r-1,0,Math.PI*2);
  ctx.strokeStyle='rgba(255,215,0,.15)';ctx.lineWidth=1;ctx.stroke();
}

function spinRoulette(){
  if(rouletteSpinning)return;
  if(!selectedRoulBet){showToast('Select a bet type first!',false);return;}
  const bet=parseFloat(document.getElementById('roulBetInput').value)||10;
  if(bet>balance){showToast('Not enough balance!',false);return;}
  if(bet<=0)return;

  rouletteSpinning=true;balance-=bet;updateBalDisplay();
  document.getElementById('roulSpinBtn').disabled=true;
  document.getElementById('rouletteResult').textContent='';
  playClickSound();

  const n=ROUL_NUMS.length;
  const winIdx=Math.floor(Math.random()*n);
  const winNum=ROUL_NUMS[winIdx];
  const sliceAngle=Math.PI*2/n;

  // Target: winning slice at top (angle = -PI/2)
  const targetCenter=winIdx*sliceAngle+sliceAngle/2;
  const targetAngle=-Math.PI/2-targetCenter+Math.PI*2*(6+Math.random()*3);
  const startAngle=rouletteAngle;
  const totalRot=targetAngle-startAngle;

  const duration=4500;const st=performance.now();
  let lastTickAngle=startAngle;

  function animWheel(now){
    const elapsed=now-st;const prog=Math.min(elapsed/duration,1);
    const eased=1-Math.pow(1-prog,4);
    const cur=startAngle+totalRot*eased;
    drawRouletteWheel(cur);

    // Tick sound when passing slot boundaries
    const angleDiff=Math.abs(cur-lastTickAngle);
    if(angleDiff>sliceAngle){
      lastTickAngle=cur;
      if(prog<0.85)playSound(400+Math.random()*200,'sine',.02,.025);
    }

    if(prog<1){requestAnimationFrame(animWheel);}
    else{
      rouletteAngle=cur%(Math.PI*2);
      rouletteSpinning=false;
      document.getElementById('roulSpinBtn').disabled=false;

      const isRed=RED_NUMS.has(winNum);const isGreen=winNum===0;
      const colorLabel=isGreen?'ðŸ’š Green':(isRed?'ðŸ”´ Red':'âš« Black');
      const colorCSS=isGreen?'var(--green)':(isRed?'#ff5555':'#ccc');
      document.getElementById('rouletteResult').innerHTML=
        '<span style="color:'+colorCSS+'">'+winNum+' â€” '+colorLabel+'</span>';

      let won=false;
      if(selectedRoulBet==='red'&&isRed)won=true;
      if(selectedRoulBet==='black'&&!isRed&&!isGreen)won=true;
      if(selectedRoulBet==='green'&&isGreen)won=true;
      if(selectedRoulBet==='odd'&&winNum>0&&winNum%2===1)won=true;
      if(selectedRoulBet==='even'&&winNum>0&&winNum%2===0)won=true;
      if(selectedRoulBet==='1-18'&&winNum>=1&&winNum<=18)won=true;
      if(selectedRoulBet==='19-36'&&winNum>=19&&winNum<=36)won=true;

      if(won){
        const payout=selectedRoulBet==='green'?bet*36:bet*2;
        balance+=payout;updateBalDisplay();
        showToast('WIN $'+payout.toFixed(2)+'!');playWinSound();
        const rect=document.getElementById('rouletteCanvas').getBoundingClientRect();
        spawnParticles(rect.left+rect.width/2,rect.top+rect.height/2,40);
        recordGame('roulette', bet, payout);
      }else{
        showToast('-$'+bet.toFixed(2),false);playLoseSound();
        recordGame('roulette', bet, 0);
      }
      firebaseSave();
    }
  }
  requestAnimationFrame(animWheel);
}

// ============ CASES (CSGO-STYLE) ============
const RARITY={
  consumer:  {label:'Consumer Grade', color:'#b0c3d9',cls:'rarity-consumer',  tier:0},
  industrial:{label:'Industrial Grade',color:'#5e98d9',cls:'rarity-industrial',tier:1},
  milspec:   {label:'Mil-Spec',       color:'#4b69ff',cls:'rarity-milspec',   tier:2},
  restricted:{label:'Restricted',     color:'#8847ff',cls:'rarity-restricted',tier:3},
  classified:{label:'Classified',     color:'#d32ce6',cls:'rarity-classified',tier:4},
  covert:    {label:'Covert',         color:'#eb4b4b',cls:'rarity-covert',    tier:5},
  legendary: {label:'â˜… Legendary',    color:'#ffd700',cls:'rarity-legendary', tier:6},
};

// Full item catalog â€” each item is a unique collectible
const ITEM_CATALOG={
  // Consumer Grade
  rustedCoin:      {id:'rustedCoin',      name:'Rusted Coin',        icon:'ðŸª™', rarity:'consumer',  baseValue:8},
  brokenCompass:   {id:'brokenCompass',   name:'Broken Compass',     icon:'ðŸ§­', rarity:'consumer',  baseValue:12},
  driftwood:       {id:'driftwood',       name:'Driftwood Charm',    icon:'ðŸªµ', rarity:'consumer',  baseValue:6},
  seaGlass:        {id:'seaGlass',        name:'Sea Glass',          icon:'ðŸ’ ', rarity:'consumer',  baseValue:10},
  coconutShell:    {id:'coconutShell',    name:'Coconut Shell',      icon:'ðŸ¥¥', rarity:'consumer',  baseValue:5},
  // Industrial Grade
  bronzeMedallion: {id:'bronzeMedallion', name:'Bronze Medallion',   icon:'ðŸ…', rarity:'industrial',baseValue:25},
  pearlFragment:   {id:'pearlFragment',   name:'Pearl Fragment',     icon:'âšª', rarity:'industrial',baseValue:35},
  corkedBottle:    {id:'corkedBottle',    name:'Message in a Bottle',icon:'ðŸ¾', rarity:'industrial',baseValue:30},
  ancientKey:      {id:'ancientKey',      name:'Ancient Key',        icon:'ðŸ—ï¸', rarity:'industrial',baseValue:40},
  ironAnchor:      {id:'ironAnchor',      name:'Iron Anchor',        icon:'âš“', rarity:'industrial',baseValue:28},
  // Mil-Spec
  silverDagger:    {id:'silverDagger',    name:'Silver Dagger',      icon:'ðŸ—¡ï¸', rarity:'milspec',   baseValue:75},
  jadeMask:        {id:'jadeMask',        name:'Jade Mask',          icon:'ðŸŽ­', rarity:'milspec',   baseValue:100},
  crystalSkull:    {id:'crystalSkull',    name:'Crystal Skull',      icon:'ðŸ’€', rarity:'milspec',   baseValue:120},
  enchantedMap:    {id:'enchantedMap',    name:'Enchanted Map',      icon:'ðŸ—ºï¸', rarity:'milspec',   baseValue:90},
  obsidianArrow:   {id:'obsidianArrow',   name:'Obsidian Arrow',     icon:'ðŸ¹', rarity:'milspec',   baseValue:85},
  // Restricted
  goldenIdol:      {id:'goldenIdol',      name:'Golden Idol',        icon:'ðŸ—¿', rarity:'restricted',baseValue:250},
  sapphireRing:    {id:'sapphireRing',    name:'Sapphire Ring',      icon:'ðŸ’', rarity:'restricted',baseValue:350},
  dragonScale:     {id:'dragonScale',     name:'Dragon Scale',       icon:'ðŸ‰', rarity:'restricted',baseValue:300},
  phoenixFeather:  {id:'phoenixFeather',  name:'Phoenix Feather',    icon:'ðŸª¶', rarity:'restricted',baseValue:280},
  moonstone:       {id:'moonstone',       name:'Moonstone Amulet',   icon:'ðŸŒ™', rarity:'restricted',baseValue:320},
  // Classified
  voidOrb:         {id:'voidOrb',         name:'Void Orb',           icon:'ðŸ”®', rarity:'classified',baseValue:800},
  sunforgedBlade:  {id:'sunforgedBlade',  name:'Sunforged Blade',    icon:'âš”ï¸', rarity:'classified',baseValue:1200},
  krakenTooth:     {id:'krakenTooth',     name:'Kraken Tooth',       icon:'ðŸ¦·', rarity:'classified',baseValue:1000},
  starChart:       {id:'starChart',       name:'Star Chart',         icon:'âœ¨', rarity:'classified',baseValue:900},
  // Covert
  bloodDiamond:    {id:'bloodDiamond',    name:'Blood Diamond',      icon:'â™¦ï¸', rarity:'covert',    baseValue:3000},
  poseidonTrident: {id:'poseidonTrident', name:"Poseidon's Trident", icon:'ðŸ”±', rarity:'covert',    baseValue:4500},
  eternityCrown:   {id:'eternityCrown',   name:'Eternity Crown',     icon:'ðŸ‘‘', rarity:'covert',    baseValue:5000},
  // Legendary (â˜…)
  islandHeart:     {id:'islandHeart',     name:'Heart of the Island',icon:'â¤ï¸â€ðŸ”¥',rarity:'legendary', baseValue:15000},
  worldEater:      {id:'worldEater',      name:'World Eater Blade',  icon:'ðŸŒ€', rarity:'legendary', baseValue:25000},
  infinityGem:     {id:'infinityGem',     name:'Infinity Gem',       icon:'ðŸ’Ž', rarity:'legendary', baseValue:50000},
};

// Cases with weighted item pools
const CASES=[
  {name:'Flotsam',icon:'ðŸ“¦',price:50,items:[
    {id:'rustedCoin',w:30},{id:'brokenCompass',w:25},{id:'driftwood',w:28},{id:'seaGlass',w:22},{id:'coconutShell',w:30},
    {id:'bronzeMedallion',w:10},{id:'pearlFragment',w:8},{id:'corkedBottle',w:9},
    {id:'silverDagger',w:3},{id:'jadeMask',w:2},
    {id:'goldenIdol',w:.5},
  ]},
  {name:'Shipwreck',icon:'ðŸš¢',price:200,items:[
    {id:'bronzeMedallion',w:22},{id:'pearlFragment',w:20},{id:'corkedBottle',w:18},{id:'ancientKey',w:16},{id:'ironAnchor',w:18},
    {id:'silverDagger',w:10},{id:'jadeMask',w:8},{id:'crystalSkull',w:6},{id:'enchantedMap',w:7},{id:'obsidianArrow',w:9},
    {id:'goldenIdol',w:3},{id:'sapphireRing',w:2},{id:'dragonScale',w:2.5},
    {id:'voidOrb',w:.6},{id:'krakenTooth',w:.4},
  ]},
  {name:'Treasure',icon:'ðŸ’°',price:750,items:[
    {id:'silverDagger',w:14},{id:'jadeMask',w:12},{id:'crystalSkull',w:10},{id:'enchantedMap',w:11},{id:'obsidianArrow',w:13},
    {id:'goldenIdol',w:9},{id:'sapphireRing',w:7},{id:'dragonScale',w:8},{id:'phoenixFeather',w:7},{id:'moonstone',w:6},
    {id:'voidOrb',w:4},{id:'sunforgedBlade',w:3},{id:'krakenTooth',w:3.5},{id:'starChart',w:3},
    {id:'bloodDiamond',w:1.2},{id:'poseidonTrident',w:.6},
    {id:'islandHeart',w:.08},
  ]},
  {name:'Mythic',icon:'ðŸ›ï¸',price:2500,items:[
    {id:'goldenIdol',w:12},{id:'sapphireRing',w:10},{id:'dragonScale',w:11},{id:'phoenixFeather',w:10},{id:'moonstone',w:9},
    {id:'voidOrb',w:8},{id:'sunforgedBlade',w:6},{id:'krakenTooth',w:7},{id:'starChart',w:7},
    {id:'bloodDiamond',w:4},{id:'poseidonTrident',w:3},{id:'eternityCrown',w:2.5},
    {id:'islandHeart',w:.5},{id:'worldEater',w:.3},{id:'infinityGem',w:.08},
  ]},
  {name:'Forbidden',icon:'ðŸ”¥',price:10000,items:[
    {id:'voidOrb',w:10},{id:'sunforgedBlade',w:9},{id:'krakenTooth',w:10},{id:'starChart',w:9},
    {id:'bloodDiamond',w:8},{id:'poseidonTrident',w:6},{id:'eternityCrown',w:5},
    {id:'islandHeart',w:2.5},{id:'worldEater',w:1.8},{id:'infinityGem',w:.7},
  ]},
];

// Demand / Market Price system â€” simulated demand multiplier per item
let itemDemand={};
function initDemand(){
  Object.keys(ITEM_CATALOG).forEach(id=>{
    if(!itemDemand[id]) itemDemand[id]={mult:1,velocity:0,supply:0};
  });
}
function getItemMarketValue(id){
  const cat=ITEM_CATALOG[id]; if(!cat)return 0;
  const d=itemDemand[id]||{mult:1};
  return Math.round(cat.baseValue*d.mult);
}
function tickDemand(){
  // Simulate organic demand shifts
  Object.keys(itemDemand).forEach(id=>{
    const d=itemDemand[id];
    // Random walk + mean reversion
    d.velocity+=(Math.random()-.5)*.04;
    d.velocity*=.92; // damping
    d.velocity+=(1-d.mult)*.008; // mean revert
    // Rarer items = more volatile
    const cat=ITEM_CATALOG[id];
    const vol=cat?1+RARITY[cat.rarity].tier*.15:1;
    d.mult=Math.max(.3,Math.min(3,d.mult+d.velocity*vol));
  });
}
setInterval(tickDemand,5000);

// Player inventory
let inventory=[]; // [{id,itemId,acquiredAt,acquiredPrice}]
let invIdCounter=Date.now();

function addToInventory(itemId){
  const val=getItemMarketValue(itemId);
  inventory.push({id:++invIdCounter,itemId,acquiredAt:Date.now(),acquiredPrice:val});
  // Increase supply => slightly lower demand
  const d=itemDemand[itemId];
  if(d){d.supply++;d.mult=Math.max(.3,d.mult-.02);}
}
function removeFromInventory(invId){
  const idx=inventory.findIndex(x=>x.id===invId);
  if(idx!==-1){
    const item=inventory[idx];
    const d=itemDemand[item.itemId];
    if(d){d.supply=Math.max(0,d.supply-1);d.mult=Math.min(3,d.mult+.015);}
    inventory.splice(idx,1);
  }
}
function getInventoryValue(){
  return inventory.reduce((s,x)=>s+getItemMarketValue(x.itemId),0);
}

let selectedCase=0,caseOpening=false;

function initCases(){
  initDemand();
  const sel=document.getElementById('caseSelector');
  CASES.forEach((c,i)=>{
    const card=document.createElement('div');
    card.className='case-card'+(i===0?' selected':'');
    card.innerHTML='<div class="case-icon">'+c.icon+'</div><div class="case-name">'+c.name+'</div><div class="case-price">$'+c.price.toLocaleString()+'</div>';
    card.onclick=()=>{selectedCase=i;document.querySelectorAll('.case-card').forEach(x=>x.classList.remove('selected'));card.classList.add('selected');playClickSound();};
    sel.appendChild(card);
  });
}

function pickWeighted(items){
  const total=items.reduce((s,i)=>s+i.w,0);
  let r=Math.random()*total;
  for(const item of items){r-=item.w;if(r<=0)return item;}
  return items[items.length-1];
}

function hexToRgb(h){
  if(!h||h[0]!=='#')return'200,200,200';
  const n=parseInt(h.slice(1),16);
  return((n>>16)&255)+','+((n>>8)&255)+','+(n&255);
}

function openCase(){
  if(caseOpening)return;
  const c=CASES[selectedCase];
  if(c.price>balance){showToast('Not enough balance!',false);return;}
  caseOpening=true;balance-=c.price;updateBalDisplay();
  document.getElementById('openCaseBtn').disabled=true;
  document.getElementById('caseWon').textContent='';
  document.getElementById('caseWonDetail').textContent='';
  playClickSound();

  const strip=document.getElementById('caseStrip');
  strip.innerHTML='';strip.style.transition='none';strip.style.transform='translateX(0)';

  const winRef=pickWeighted(c.items);
  const winCat=ITEM_CATALOG[winRef.id];
  const winRarity=RARITY[winCat.rarity];
  const winPos=35;
  const totalItems=50;

  for(let i=0;i<totalItems;i++){
    const ref=i===winPos?winRef:c.items[Math.floor(Math.random()*c.items.length)];
    const cat=ITEM_CATALOG[ref.id];
    const rar=RARITY[cat.rarity];
    const el=document.createElement('div');el.className='case-item';
    el.style.borderColor=rar.color;
    el.style.background='linear-gradient(180deg,rgba('+hexToRgb(rar.color)+',.15),transparent)';
    el.innerHTML='<div class="item-icon">'+cat.icon+'</div><div class="'+rar.cls+'" style="font-size:10px;">'+cat.name+'</div>'
      +'<div class="item-rarity" style="background:'+rar.color+';"></div>';
    strip.appendChild(el);
  }

  requestAnimationFrame(()=>{requestAnimationFrame(()=>{
    const openerW=strip.parentElement.offsetWidth;
    const offset=winPos*120-openerW/2+60+(Math.random()*60-30);
    strip.style.transition='transform 4s cubic-bezier(.08,.82,.17,1)';
    strip.style.transform='translateX(-'+offset+'px)';
  })});

  let ticks=0;
  const tickI=setInterval(()=>{
    playSound(500+Math.random()*400,'sine',.025,.03);ticks++;
    if(ticks>45)clearInterval(tickI);
  },70);

  setTimeout(()=>{
    clearInterval(tickI);caseOpening=false;
    document.getElementById('openCaseBtn').disabled=false;

    // Add to inventory instead of cash!
    addToInventory(winRef.id);
    const mktVal=getItemMarketValue(winRef.id);
    const profit=mktVal-c.price;
    const isW=profit>=0;

    document.getElementById('caseWon').innerHTML=
      '<span class="'+winRarity.cls+'">'+winCat.icon+' '+winCat.name+'</span>';
    document.getElementById('caseWonDetail').innerHTML=
      '<span style="color:'+winRarity.color+'">'+winRarity.label+'</span> â€” Market Value: <span style="color:var(--gold)">$'+mktVal.toLocaleString()+'</span>'
      +' <span style="color:'+(isW?'var(--green)':'var(--red)')+'">('+(isW?'+':'')+('$'+profit.toLocaleString())+')</span>';

    if(winRarity.tier>=5){
      showToast('ðŸ”¥ '+winRarity.label+': '+winCat.name+'!');playWinSound();
      spawnParticles(window.innerWidth/2,window.innerHeight/2,80+winRarity.tier*30);
    }else if(winRarity.tier>=3){
      showToast(winCat.icon+' '+winCat.name+'!');playWinSound();
      spawnParticles(window.innerWidth/2,window.innerHeight/2,30);
    }else{
      showToast(winCat.name+' added to inventory',isW);
      if(!isW)playLoseSound(); else playWinSound();
    }
    recordGame('cases', c.price, mktVal);
    firebaseSave();
  },4300);
}

// ============ INVENTORY ============
function showInventory(){playClickSound();document.getElementById('inventoryOverlay').classList.add('show');renderInventory();}
function hideInventory(){document.getElementById('inventoryOverlay').classList.remove('show');}
let invFilter='all';

function filterInventory(f,btn){
  invFilter=f;
  document.querySelectorAll('.inv-tab').forEach(t=>t.classList.remove('active'));
  if(btn)btn.classList.add('active');
  renderInventory();
}

function renderInventory(){
  const grid=document.getElementById('invGrid');
  grid.innerHTML='';
  const totalVal=getInventoryValue();
  document.getElementById('invTotalValue').textContent=totalVal.toLocaleString();
  document.getElementById('invCount').textContent=inventory.length;

  // Find rarest
  let rarestTier=-1,rarestName='â€”';
  inventory.forEach(x=>{
    const cat=ITEM_CATALOG[x.itemId];
    const t=RARITY[cat.rarity].tier;
    if(t>rarestTier){rarestTier=t;rarestName=cat.icon+' '+cat.name;}
  });
  document.getElementById('invRarest').textContent=rarestName;

  // Market trend
  const trends=Object.values(itemDemand).map(d=>d.velocity);
  const avg=trends.length?trends.reduce((a,b)=>a+b,0)/trends.length:0;
  document.getElementById('invTrend').innerHTML=avg>0.005?'<span style="color:var(--green)">ðŸ“ˆ Bullish</span>'
    :avg<-0.005?'<span style="color:var(--red)">ðŸ“‰ Bearish</span>':'<span style="color:var(--text2)">âž¡ï¸ Stable</span>';

  let filtered=inventory;
  if(invFilter!=='all'){
    filtered=inventory.filter(x=>ITEM_CATALOG[x.itemId].rarity===invFilter);
  }

  // Sort by rarity desc then value desc
  filtered.sort((a,b)=>{
    const ra=RARITY[ITEM_CATALOG[a.itemId].rarity].tier;
    const rb=RARITY[ITEM_CATALOG[b.itemId].rarity].tier;
    if(rb!==ra)return rb-ra;
    return getItemMarketValue(b.itemId)-getItemMarketValue(a.itemId);
  });

  if(filtered.length===0){
    grid.innerHTML='<div class="inv-empty">No items'+(invFilter!=='all'?' of this rarity':'')+'. Open some cases!</div>';
    return;
  }

  filtered.forEach(inv=>{
    const cat=ITEM_CATALOG[inv.itemId];
    const rar=RARITY[cat.rarity];
    const val=getItemMarketValue(inv.itemId);
    const pnl=val-inv.acquiredPrice;
    const pnlPct=inv.acquiredPrice>0?((pnl/inv.acquiredPrice)*100).toFixed(1):0;
    const d=itemDemand[inv.itemId]||{mult:1};

    const el=document.createElement('div');el.className='inv-item';
    el.innerHTML=
      '<div class="ii-icon">'+cat.icon+'</div>'
      +'<div class="ii-name '+rar.cls+'">'+cat.name+'</div>'
      +'<div class="ii-value">$'+val.toLocaleString()+'</div>'
      +'<div class="ii-demand" style="color:'+(pnl>=0?'var(--green)':'var(--red)')+'">'+
        (pnl>=0?'â–²':'â–¼')+' '+(pnl>=0?'+':'')+pnlPct+'% | x'+d.mult.toFixed(2)+'</div>'
      +'<button class="inv-sell-btn" data-inv="'+inv.id+'">SELL $'+val.toLocaleString()+'</button>'
      +'<div class="ii-rarity-bar" style="background:'+rar.color+';"></div>';
    grid.appendChild(el);
  });

  // Attach sell handlers
  grid.querySelectorAll('.inv-sell-btn').forEach(btn=>{
    btn.onclick=(e)=>{
      e.stopPropagation();
      const invId=parseInt(btn.dataset.inv);
      const inv=inventory.find(x=>x.id===invId);
      if(!inv)return;
      const val=getItemMarketValue(inv.itemId);
      const cat=ITEM_CATALOG[inv.itemId];
      balance+=val;updateBalDisplay();
      removeFromInventory(invId);
      showToast('Sold '+cat.name+' for $'+val.toLocaleString()+'!');
      playWinSound();renderInventory();firebaseSave();
    };
  });
}

// Inventory / Demand data persistence accessors
window._getInventoryData=()=>inventory;
window._loadInventory=(data)=>{if(Array.isArray(data)){inventory=data;invIdCounter=inventory.reduce((m,x)=>Math.max(m,x.id||0),Date.now());}};
window._getDemandData=()=>itemDemand;
window._loadDemand=(data)=>{if(data&&typeof data==='object'){Object.assign(itemDemand,data);}};

// ============ PLINKO ============
const PLINKO_PAYOUTS={
  8:{LOW:[5.6,2.1,1.1,1,.5,1,1.1,2.1,5.6],MEDIUM:[13,3,1.3,.7,.4,.7,1.3,3,13],HIGH:[29,4,1.5,.3,.2,.3,1.5,4,29]},
  9:{LOW:[5.6,2,1.6,1,.7,.7,1,1.6,2,5.6],MEDIUM:[18,4,1.7,.9,.5,.5,.9,1.7,4,18],HIGH:[43,7,2,.6,.2,.2,.6,2,7,43]},
  10:{LOW:[8.9,3,1.4,1.1,1,.5,1,1.1,1.4,3,8.9],MEDIUM:[22,5,2,1.4,.6,.4,.6,1.4,2,5,22],HIGH:[76,10,3,.9,.3,.2,.3,.9,3,10,76]},
  11:{LOW:[8.4,3,1.9,1.3,1,.7,.7,1,1.3,1.9,3,8.4],MEDIUM:[24,6,3,1.8,.7,.5,.5,.7,1.8,3,6,24],HIGH:[120,14,5.2,1.4,.4,.2,.2,.4,1.4,5.2,14,120]},
  12:{LOW:[10,3,1.6,1.4,1.1,1,.5,1,1.1,1.4,1.6,3,10],MEDIUM:[33,11,4,2,1.1,.6,.3,.6,1.1,2,4,11,33],HIGH:[170,24,8.1,2,.7,.2,.2,.2,.7,2,8.1,24,170]},
  13:{LOW:[8.1,4,3,1.9,1.2,.9,.7,.7,.9,1.2,1.9,3,4,8.1],MEDIUM:[43,13,6,3,1.3,.7,.4,.4,.7,1.3,3,6,13,43],HIGH:[260,37,11,4,1,.2,.2,.2,.2,1,4,11,37,260]},
  14:{LOW:[7.1,4,1.9,1.4,1.3,1.1,1,.5,1,1.1,1.3,1.4,1.9,4,7.1],MEDIUM:[58,15,7,4,1.9,1,.5,.2,.5,1,1.9,4,7,15,58],HIGH:[420,56,18,5,1.9,.3,.2,.2,.2,.3,1.9,5,18,56,420]},
  15:{LOW:[15,8,3,2,1.5,1.1,1,.7,.7,1,1.1,1.5,2,3,8,15],MEDIUM:[88,18,11,5,3,1.3,.5,.3,.3,.5,1.3,3,5,11,18,88],HIGH:[620,83,27,8,3,.5,.2,.2,.2,.2,.5,3,8,27,83,620]},
  16:{LOW:[16,9,2,1.4,1.4,1.2,1.1,1,.5,1,1.1,1.2,1.4,1.4,2,9,16],MEDIUM:[110,41,10,5,3,1.5,1,.5,.3,.5,1,1.5,3,5,10,41,110],HIGH:[1000,130,26,9,4,2,.2,.2,.2,.2,.2,2,4,9,26,130,1000]}
};
const BALL_FRICTIONS={8:.0395,9:.041,10:.038,11:.0355,12:.0414,13:.0437,14:.0401,15:.0418,16:.0364};

let plinkoInitialized=false,plinkoMatterEngine=null,plinkoMatterRender=null,plinkoMatterRunner=null;
let plinkoPins=[],plinkoWalls=[],plinkoSensor=null,plinkoBallBets={};
let plinkoDropCount=0,plinkoTotalProfit=0,plinkoLastWinsList=[];
let autoDropInterval=null,autoDropping=false;
let plinkoRowCount=16,plinkoRiskLevel='MEDIUM';
let plinkoLastRowXCoords=[];

const PW=760,PH=570,PPX=52,PPT=36,PPB=28;
const PIN_CAT=0x0001,BALL_CAT=0x0002;

function initPlinko(){
  if(plinkoInitialized)return;plinkoInitialized=true;
  const canvas=document.getElementById('plinkoCanvas');
  canvas.width=PW;canvas.height=PH;

  const engine=Matter.Engine.create({timing:{timeScale:1}});
  const render=Matter.Render.create({engine,canvas,options:{width:PW,height:PH,background:'#0f1728',wireframes:false}});
  const runner=Matter.Runner.create();
  plinkoMatterEngine=engine;plinkoMatterRender=render;plinkoMatterRunner=runner;

  plinkoSensor=Matter.Bodies.rectangle(PW/2,PH,PW,10,{isSensor:true,isStatic:true,render:{visible:false}});
  Matter.Composite.add(engine.world,[plinkoSensor]);

  Matter.Events.on(engine,'collisionStart',({pairs})=>{
    pairs.forEach(({bodyA,bodyB})=>{
      if(bodyA===plinkoSensor)handlePlinkoHit(bodyB);
      else if(bodyB===plinkoSensor)handlePlinkoHit(bodyA);
    });
  });

  // Pin collision glow + sound
  Matter.Events.on(engine,'collisionStart',({pairs})=>{
    pairs.forEach(({bodyA,bodyB})=>{
      const pin=(bodyA.collisionFilter.category===PIN_CAT)?bodyA:
                (bodyB.collisionFilter.category===PIN_CAT)?bodyB:null;
      if(pin){
        pin.render.fillStyle='#00f0ff';
        setTimeout(()=>{pin.render.fillStyle='#ffffff';},80);
        const pitch=350+(pin.position.x/PW)*300+(pin.position.y/PH)*80;
        playSound(pitch,'sine',.02,.008);
      }
    });
  });

  placePlinkoPins();
  updatePlinkoBins();
  Matter.Render.run(render);
  Matter.Runner.run(runner,engine);

  // Ball glow trail
  Matter.Events.on(render,'afterRender',()=>{
    const ctx=render.context;
    Matter.Composite.allBodies(engine.world).forEach(body=>{
      if(body.collisionFilter.category===BALL_CAT){
        const {x,y}=body.position;const r=body.circleRadius||6;
        ctx.save();
        const grd=ctx.createRadialGradient(x,y,r*.5,x,y,r*3);
        grd.addColorStop(0,'rgba(255,80,80,0.25)');grd.addColorStop(1,'rgba(255,40,40,0)');
        ctx.fillStyle=grd;ctx.beginPath();ctx.arc(x,y,r*3,0,Math.PI*2);ctx.fill();
        ctx.restore();
      }
    });
  });

  // Cleanup balls that fall off-screen or get stuck
  setInterval(()=>{
    Matter.Composite.allBodies(engine.world).forEach(body=>{
      if(body.collisionFilter.category===BALL_CAT&&(body.position.y>PH+60||body.position.x<-20||body.position.x>PW+20)){
        Matter.Composite.remove(engine.world,body);
        delete plinkoBallBets[body.id];
      }
    });
  },2000);

  document.getElementById('plinkoRows').addEventListener('change',e=>{
    plinkoRowCount=parseInt(e.target.value);
    removeAllPlinkoBalls();placePlinkoPins();updatePlinkoBins();
  });
  document.getElementById('plinkoRisk').addEventListener('change',e=>{
    plinkoRiskLevel=e.target.value;updatePlinkoBins();
  });
}

function getPinDistX(){return(PW-PPX*2)/(3+plinkoRowCount-1-1);}
function getPinR(){return(24-plinkoRowCount)/2;}

function placePlinkoPins(){
  if(plinkoPins.length)Matter.Composite.remove(plinkoMatterEngine.world,plinkoPins);
  if(plinkoWalls.length)Matter.Composite.remove(plinkoMatterEngine.world,plinkoWalls);
  plinkoPins=[];plinkoWalls=[];plinkoLastRowXCoords=[];

  const pinDist=getPinDistX();const pinR=getPinR();

  for(let row=0;row<plinkoRowCount;row++){
    const rowY=PPT+((PH-PPT-PPB)/(plinkoRowCount-1))*row;
    const rowPadX=PPX+((plinkoRowCount-1-row)*pinDist)/2;
    const cols=3+row;
    for(let col=0;col<cols;col++){
      const colX=cols>1?rowPadX+((PW-rowPadX*2)/(cols-1))*col:PW/2;
      const pin=Matter.Bodies.circle(colX,rowY,pinR,{
        isStatic:true,render:{fillStyle:'#ffffff'},
        collisionFilter:{category:PIN_CAT,mask:BALL_CAT}
      });
      plinkoPins.push(pin);
      if(row===plinkoRowCount-1)plinkoLastRowXCoords.push(colX);
    }
  }
  Matter.Composite.add(plinkoMatterEngine.world,plinkoPins);

  // Walls
  if(plinkoLastRowXCoords.length>1){
    const firstPinX=plinkoPins[0].position.x;
    const wallAngle=Math.atan2(firstPinX-plinkoLastRowXCoords[0],PH-PPT-PPB);
    const wallX=firstPinX-(firstPinX-plinkoLastRowXCoords[0])/2-pinDist*0.25;

    const lw=Matter.Bodies.rectangle(wallX,PH/2,10,PH,{isStatic:true,angle:wallAngle,render:{visible:false}});
    const rw=Matter.Bodies.rectangle(PW-wallX,PH/2,10,PH,{isStatic:true,angle:-wallAngle,render:{visible:false}});
    plinkoWalls=[lw,rw];
    Matter.Composite.add(plinkoMatterEngine.world,plinkoWalls);
  }
}

function updatePlinkoBins(){
  const binsEl=document.getElementById('plinkoBins');
  const payouts=PLINKO_PAYOUTS[plinkoRowCount][plinkoRiskLevel];
  const count=payouts.length;
  binsEl.innerHTML='';

  // Reference colors: edges rgb(255,0,63) â†’ center rgb(255,192,0)
  // Shadow:           edges rgb(166,0,4)  â†’ center rgb(171,121,0)
  const half=Math.ceil(count/2);
  function lerpC(a,b,t){return Math.round(a+(b-a)*t);}
  function binBg(i){
    const t2=Math.abs(i-(count-1)/2)/((count-1)/2);// 0=center 1=edge
    return'rgb('+lerpC(255,255,t2)+','+lerpC(192,0,t2)+','+lerpC(0,63,t2)+')';
  }
  function binSh(i){
    const t2=Math.abs(i-(count-1)/2)/((count-1)/2);
    return'rgb('+lerpC(171,166,t2)+','+lerpC(121,0,t2)+','+lerpC(0,4,t2)+')';
  }
  for(let i=0;i<count;i++){
    const bin=document.createElement('div');bin.className='plinko-bin';
    bin.style.background=binBg(i);
    bin.style.boxShadow='0 3px 0 '+binSh(i);
    bin.textContent=payouts[i]+'Ã—';
    bin.id='plinkoBin'+i;
    binsEl.appendChild(bin);
  }

  if(plinkoLastRowXCoords.length>1){
    const first=plinkoLastRowXCoords[0],last=plinkoLastRowXCoords[plinkoLastRowXCoords.length-1];
    const pct=((last-first)/PW)*100;
    binsEl.style.width=pct+'%';
  }
}

function handlePlinkoHit(ball){
  if(!plinkoLastRowXCoords.length)return;
  const coords=plinkoLastRowXCoords;
  const ballX=ball.position.x;// capture before removal
  // Find which bin the ball landed in
  let binIndex=-1;
  for(let i=coords.length-1;i>=0;i--){
    if(coords[i]<ballX){binIndex=i;break;}
  }

  // Clean up ball
  Matter.Composite.remove(plinkoMatterEngine.world,ball);
  const betAmt=plinkoBallBets[ball.id]||0;
  delete plinkoBallBets[ball.id];

  if(binIndex<0||binIndex>=coords.length-1)return;
  // Landing thud sound
  playSound(180+(binIndex/(coords.length-1))*120,'triangle',.06,.04);

  const payouts=PLINKO_PAYOUTS[plinkoRowCount][plinkoRiskLevel];
  const multiplier=payouts[binIndex];
  const payout=betAmt*multiplier;
  const profit=payout-betAmt;

  balance+=payout;
  plinkoTotalProfit+=profit;
  plinkoDropCount++;
  updateBalDisplay();

  document.getElementById('plinkoDropCount').textContent=plinkoDropCount;
  const profitEl=document.getElementById('plinkoProfit');
  profitEl.textContent='$'+(plinkoTotalProfit>=0?'+':'')+plinkoTotalProfit.toFixed(2);
  profitEl.style.color=plinkoTotalProfit>=0?'var(--green)':'var(--red)';

  // Bin bounce
  const binEl=document.getElementById('plinkoBin'+binIndex);
  if(binEl){binEl.classList.remove('bounce');void binEl.offsetWidth;binEl.classList.add('bounce');}

  // Last wins display
  plinkoLastWinsList.push({multiplier,binIndex});
  if(plinkoLastWinsList.length>4)plinkoLastWinsList.shift();
  renderPlinkoLastWins();

  // Effects
  if(multiplier>=10){
    playWinSound();
    const rect=document.getElementById('plinkoCanvas').getBoundingClientRect();
    const bx=rect.left+rect.width*(ballX/PW);
    const by=rect.top+rect.height;
    spawnParticles(bx,by,20+Math.min(multiplier,100));
    showToast(multiplier+'Ã— â€” $'+payout.toFixed(2)+'!');
  }else if(multiplier>=3){
    playSound(600,'sine',.08,.08);
  }else{
    playSound(300,'sine',.04,.04);
  }
  recordGame('plinko', betAmt, payout);
  firebaseSave();
}

function renderPlinkoLastWins(){
  const container=document.getElementById('plinkoLastWins');
  container.innerHTML='';
  const payouts=PLINKO_PAYOUTS[plinkoRowCount][plinkoRiskLevel];
  const count=payouts.length;

  [...plinkoLastWinsList].reverse().forEach(w=>{
    const t=Math.abs(w.binIndex-(count-1)/2)/((count-1)/2);
    const el=document.createElement('div');el.className='plinko-last-win';
    el.style.background='rgb('+Math.round(255)+','+Math.round(192-192*t)+','+Math.round(63*t)+')';
    el.textContent=w.multiplier+'Ã—';
    container.appendChild(el);
  });
}

function removeAllPlinkoBalls(){
  if(!plinkoMatterEngine)return;
  Matter.Composite.allBodies(plinkoMatterEngine.world).forEach(body=>{
    if(body.collisionFilter.category===BALL_CAT)Matter.Composite.remove(plinkoMatterEngine.world,body);
  });
  plinkoBallBets={};
}

function dropPlinkoBall(){
  if(!plinkoInitialized)initPlinko();
  const bet=parseFloat(document.getElementById('plinkoBet').value)||10;
  if(bet>balance){showToast('Not enough balance!',false);if(autoDropping)toggleAutoDrop();return;}
  if(bet<=0)return;

  balance-=bet;updateBalDisplay();
  playSound(500,'sine',.04,.05);

  const pinDist=getPinDistX();
  const ballR=getPinR()*2;
  const offsetRange=pinDist*0.8;

  const ball=Matter.Bodies.circle(
    PW/2+(Math.random()-.5)*offsetRange*2, 0, ballR,
    {restitution:0.8,friction:0.5,frictionAir:BALL_FRICTIONS[plinkoRowCount],
      collisionFilter:{category:BALL_CAT,mask:PIN_CAT},
      render:{fillStyle:'#ff0000'}}
  );
  Matter.Composite.add(plinkoMatterEngine.world,ball);
  plinkoBallBets[ball.id]=bet;
}

function toggleAutoDrop(){
  if(autoDropping){
    clearInterval(autoDropInterval);autoDropInterval=null;autoDropping=false;
    document.getElementById('autoDropBtn').textContent='AUTO DROP';
    document.getElementById('autoDropBtn').style.background='linear-gradient(135deg,#3355cc,#2244aa)';
  }else{
    autoDropping=true;
    document.getElementById('autoDropBtn').textContent='STOP AUTO';
    document.getElementById('autoDropBtn').style.background='linear-gradient(135deg,#cc3355,#991133)';
    autoDropInterval=setInterval(()=>{
      const bet=parseFloat(document.getElementById('plinkoBet').value)||10;
      if(bet>balance){toggleAutoDrop();return;}
      dropPlinkoBall();
    },250);
  }
}

// ============ PUSH YOUR LUCK (Multiplayer Modes) ============
let pylCurrentMode = null; // 'solo','1v1','highstakes','tournament'
let pylRoomCode = null;
let pylRoomUnsub = null; // Firebase listener cleanup
let pylWagerAmount = 0;
let pylHSTarget = 500;
let pylHSMultiplier = 2;
let pylGameActive = false;
let pylOpponentId = null; // Track opponent session ID for 1v1 choice relay

// Listen for score messages from the PYL iframe
window.addEventListener('message', function(evt) {
  if (evt.data && evt.data.type === 'pylScore' && pylGameActive) {
    const score = evt.data.score || 0;
    document.getElementById('pylScoreDisplay').textContent = 'Score: ' + score;
    document.getElementById('pylScoreInput').value = score;
    // Auto-submit for all modes
    pylSubmitScore();
  }
  // 1v1 choice relay: player made a choice in the iframe â€” write to Firebase and listen for opponent
  if (evt.data && evt.data.type === 'pylChoice' && pylCurrentMode === '1v1' && pylRoomCode && pylOpponentId) {
    const round = evt.data.round;
    const choice = evt.data.choice;
    // Write our choice to Firebase
    if (window._pylWriteChoice) {
      window._pylWriteChoice(pylRoomCode, round, choice);
    }
    // Listen for opponent's choice for this round
    if (window._pylListenChoice) {
      window._pylListenChoice(pylRoomCode, round, pylOpponentId, function(opChoice) {
        // Relay opponent's choice back to the iframe
        const iframe = document.getElementById('pylIframe');
        if (iframe && iframe.contentWindow) {
          iframe.contentWindow.postMessage({ type: 'pylOpponentChoice', choice: opChoice, round: round }, '*');
        }
      });
    }
  }
});

function pylStartMode(mode) {
  pylCurrentMode = mode;
  playClickSound();

  if (mode === 'solo') {
    pylHideLobby();
    pylShowOverlay('FREE PLAY', 0);
    pylGameActive = true;
  } else if (mode === 'tournament') {
    pylHideLobby();
    pylShowOverlay('ðŸ† TOURNAMENT', 0);
    pylGameActive = true;
    pylLoadLeaderboard();
  }
}

function pylShowWager(mode) {
  playClickSound();
  pylCurrentMode = mode;

  // Hide mode cards
  document.querySelector('.pyl-modes').style.display = 'none';
  document.getElementById('pylLeaderboard').style.display = 'none';

  if (mode === '1v1') {
    document.getElementById('pylRoomUI').style.display = 'block';
    document.getElementById('pylHighStakesUI').style.display = 'none';
    document.getElementById('pylRoomStatus').textContent = 'Create a room or enter a code to join';
    document.getElementById('pylRoomPlayers').innerHTML = '';
  } else if (mode === 'highstakes') {
    document.getElementById('pylHighStakesUI').style.display = 'block';
    document.getElementById('pylRoomUI').style.display = 'none';
  }
}

function pylBackToLobby() {
  playClickSound();
  // Clean up any room listener
  if (pylRoomUnsub) { pylRoomUnsub(); pylRoomUnsub = null; }
  if (pylRoomCode && pylCurrentMode === '1v1') {
    // Cancel our onDisconnect handlers since we're leaving cleanly
    if (window._pylCancelDisconnect) window._pylCancelDisconnect(pylRoomCode);
    // Mark ourselves offline and delete room
    if (window._pylDeleteRoom) window._pylDeleteRoom(pylRoomCode);
    // Reset iframe so next game doesn't carry stale 1v1 config
    const iframe = document.getElementById('pylIframe');
    if (iframe) iframe.src = '';
  }
  pylRoomCode = null;
  pylCurrentMode = null;
  pylGameActive = false;
  pylOpponentId = null;
  _pylDisconnectHandled = false;

  // Show lobby, hide everything else
  document.querySelector('.pyl-modes').style.display = '';
  document.getElementById('pylRoomUI').style.display = 'none';
  document.getElementById('pylHighStakesUI').style.display = 'none';
  document.getElementById('pylLobby').style.display = '';
  document.getElementById('pylOverlay').classList.add('hidden');
  document.getElementById('pylLeaderboard').style.display = '';
  pylLoadLeaderboard();
}

function pylHideLobby(opponentName, roomCode) {
  document.getElementById('pylLobby').style.display = 'none';
  // Ensure the game iframe exists and is loaded
  let iframe = document.getElementById('pylIframe');
  if (!iframe) {
    iframe = document.createElement('iframe');
    iframe.id = 'pylIframe';
    iframe.allow = 'autoplay';
    const panel = document.getElementById('luckPanel');
    panel.insertBefore(iframe, panel.firstChild);
  }
  // Build URL with 1v1 hash if opponent name provided
  let url = 'push-your-luck/index.html';
  if (opponentName) {
    url += '?t=' + Date.now() + '#1v1=' + encodeURIComponent(opponentName) + '&room=' + (roomCode || 'default');
  }
  // Always force reload for 1v1 so PYL_1V1 is picked up fresh; also reload for non-1v1 if coming from a 1v1 game
  if (opponentName || !iframe.src || !iframe.src.includes('push-your-luck') || iframe.src.includes('#1v1=')) {
    iframe.src = url;
  }
}

function pylShowOverlay(label, wager) {
  const overlay = document.getElementById('pylOverlay');
  overlay.classList.remove('hidden');
  document.getElementById('pylModeLabel').textContent = label;
  document.getElementById('pylScoreDisplay').textContent = 'Score: â€”';
  document.getElementById('pylScoreInput').value = '';

  if (wager > 0) {
    document.getElementById('pylWagerCard').style.display = '';
    document.getElementById('pylWagerDisplay').textContent = '$' + wager.toLocaleString();
  } else {
    document.getElementById('pylWagerCard').style.display = 'none';
  }

  document.getElementById('pylOpponentCard').style.display = 'none';
}

// ---- 1v1 ROOM ----
function generateRoomCode() {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let code = '';
  for (let i = 0; i < 5; i++) code += chars[Math.floor(Math.random() * chars.length)];
  return code;
}

function pylCreateRoom() {
  const wager = parseFloat(document.getElementById('pylWager').value) || 100;
  if (wager > balance) { showToast('Not enough balance!', false); return; }
  if (wager < 10) { showToast('Minimum wager is $10', false); return; }

  pylWagerAmount = wager;
  pylRoomCode = generateRoomCode();
  playClickSound();

  document.getElementById('pylRoomStatus').innerHTML =
    'Room: <span style="color:var(--neon);font-size:18px;letter-spacing:3px;">' + pylRoomCode + '</span><br>' +
    '<span style="color:var(--text2);font-size:11px;">Share this code with your opponent</span>';
  document.getElementById('pylRoomPlayers').innerHTML =
    '<div style="color:var(--green);margin:4px 0;">âœ“ You (host) â€” $' + wager + ' wager</div>' +
    '<div style="color:var(--text2);margin:4px 0;">â³ Waiting for opponent...</div>';

  // Create room in Firebase
  if (window._pylCreateRoom) {
    window._pylCreateRoom(pylRoomCode, wager).then(() => {
      // Listen for opponent joining
      let pylGameStarted = false;
      pylRoomUnsub = window._pylListenRoom(pylRoomCode, (data) => {
        if (!data || pylGameStarted) return;
        const players = data.players || {};
        const playerKeys = Object.keys(players);

        if (playerKeys.length >= 2) {
          pylGameStarted = true;
          showToast('âš”ï¸ Opponent joined! Game on!');
          playWinSound();
          balance -= pylWagerAmount;
          updateBalDisplay();
          const opId = playerKeys.find(k => k !== window._pylPlayerId);
          const opData = opId ? players[opId] : null;
          const opName = opData && opData.name ? opData.name : (opId ? opId.slice(-5) : 'Opponent');
          pylOpponentId = opId;

          pylHideLobby(opName, pylRoomCode);
          document.getElementById('pylRoomUI').style.display = 'none';
          pylShowOverlay('âš”ï¸ 1v1 WAGER â€” $' + (pylWagerAmount * 2), pylWagerAmount);
          document.getElementById('pylOpponentCard').style.display = '';
          document.getElementById('pylOpponentName').textContent = opName;
          document.getElementById('pylOpponentScore').textContent = 'Playing...';
          pylGameActive = true;

          // Listen for opponent score + disconnect
          pylRoomUnsub = window._pylListenRoom(pylRoomCode, (roomData) => {
            if (!roomData) {
              // Room was deleted â€” opponent disconnected
              pylHandleOpponentDisconnect();
              return;
            }
            const ps = roomData.players || {};
            if (opId && ps[opId]) {
              if (ps[opId].score != null) {
                document.getElementById('pylOpponentScore').textContent = ps[opId].score + ' pts';
              }
              if (ps[opId].online === false && pylGameActive) {
                pylHandleOpponentDisconnect();
              }
            }
          });
        }
      });
    });
  }
}

function pylJoinRoom() {
  const code = (document.getElementById('pylJoinCode').value || '').toUpperCase().trim();
  if (!code) { showToast('Enter a room code!', false); return; }

  playClickSound();
  document.getElementById('pylRoomStatus').textContent = 'Joining...';

  if (window._pylJoinRoom) {
    window._pylJoinRoom(code).then(data => {
      if (!data) {
        showToast('Room not found or already started!', false);
        document.getElementById('pylRoomStatus').textContent = 'Room not found. Try again.';
        return;
      }

      pylRoomCode = code;
      pylWagerAmount = data.wager || 100;

      if (pylWagerAmount > balance) {
        showToast('Not enough balance for $' + pylWagerAmount + ' wager!', false);
        document.getElementById('pylRoomStatus').textContent = 'Insufficient balance.';
        return;
      }

      balance -= pylWagerAmount;
      updateBalDisplay();

      showToast('âš”ï¸ Joined! Game on!');
      playWinSound();
      const players = data.players || {};
      const opId = Object.keys(players).find(k => k !== window._pylPlayerId);
      const opData = opId ? players[opId] : null;
      const opName = opData && opData.name ? opData.name : (opId ? opId.slice(-5) : 'Opponent');
      pylOpponentId = opId;

      pylHideLobby(opName, pylRoomCode);
      document.getElementById('pylRoomUI').style.display = 'none';
      pylShowOverlay('âš”ï¸ 1v1 WAGER â€” $' + (pylWagerAmount * 2), pylWagerAmount);
      document.getElementById('pylOpponentCard').style.display = '';
      document.getElementById('pylOpponentName').textContent = opName;
      document.getElementById('pylOpponentScore').textContent = 'Playing...';
      pylGameActive = true;

      // Listen for opponent score + disconnect
      pylRoomUnsub = window._pylListenRoom(pylRoomCode, (roomData) => {
        if (!roomData) {
          // Room was deleted â€” opponent disconnected
          pylHandleOpponentDisconnect();
          return;
        }
        const ps = roomData.players || {};
        if (opId && ps[opId]) {
          if (ps[opId].score != null) {
            document.getElementById('pylOpponentScore').textContent = ps[opId].score + ' pts';
          }
          if (ps[opId].online === false && pylGameActive) {
            pylHandleOpponentDisconnect();
          }
        }
      });
    });
  }
}

// ---- HIGH STAKES ----
function pylStartHighStakes() {
  const wager = parseFloat(document.getElementById('pylHSWager').value) || 500;
  if (wager > balance) { showToast('Not enough balance!', false); return; }
  if (wager < 50) { showToast('Minimum wager is $50', false); return; }

  const sel = document.getElementById('pylHSTarget');
  pylHSTarget = parseInt(sel.value);
  pylHSMultiplier = parseFloat(sel.options[sel.selectedIndex].dataset.mult);
  pylWagerAmount = wager;

  balance -= wager;
  updateBalDisplay();
  playClickSound();

  pylHideLobby();
  document.getElementById('pylHighStakesUI').style.display = 'none';
  pylShowOverlay('ðŸ’€ HIGH STAKES â€” ' + pylHSTarget + 'pts for ' + pylHSMultiplier + 'x', wager);
  pylGameActive = true;

  showToast('ðŸ’€ Hit ' + pylHSTarget + ' pts to win $' + (wager * pylHSMultiplier).toLocaleString() + '!');
}

// ---- SCORE SUBMISSION ----
function pylSubmitScore() {
  const scoreInput = document.getElementById('pylScoreInput');
  const score = parseInt(scoreInput.value);
  if (isNaN(score) || score < 0) { showToast('Enter a valid score!', false); return; }

  playClickSound();
  document.getElementById('pylScoreDisplay').textContent = 'Score: ' + score;
  scoreInput.value = '';
  pylGameActive = false;

  // Track PYL stats
  if (gameStats.pyl) {
    gameStats.pyl.played = (gameStats.pyl.played || 0) + 1;
    if (score > (gameStats.pyl.highScore || 0)) gameStats.pyl.highScore = score;
  }

  if (pylCurrentMode === 'solo') {
    showToast('Free play score: ' + score + ' pts!');
  }

  else if (pylCurrentMode === '1v1') {
    // Submit score to Firebase
    if (window._pylSubmitRoomScore && pylRoomCode) {
      window._pylSubmitRoomScore(pylRoomCode, score).then(() => {
        document.getElementById('pylScoreDisplay').textContent = 'Your Score: ' + score + ' â€” Waiting for opponent...';

        // Check if opponent already submitted
        const checkResult = () => {
          if (pylRoomUnsub) pylRoomUnsub();
          pylRoomUnsub = window._pylListenRoom(pylRoomCode, (data) => {
            if (!data) {
              // Room deleted â€” opponent disconnected while we were waiting
              if (!_pylDisconnectHandled) {
                _pylDisconnectHandled = true;
                pylGameActive = false;
                const pot = pylWagerAmount * 2;
                balance += pot;
                updateBalDisplay();
                showToast('âš”ï¸ Opponent disconnected â€” YOU WIN! +$' + pot.toLocaleString() + '!');
                playWinSound();
                document.getElementById('pylScoreDisplay').innerHTML =
                  '<span style="color:var(--green);">âš”ï¸ OPPONENT DISCONNECTED</span> â€” You win $' + pot.toLocaleString() + '!';
                document.getElementById('pylOpponentScore').textContent = 'DISCONNECTED';
                if (pylRoomUnsub) { pylRoomUnsub(); pylRoomUnsub = null; }
                firebaseSave();
                setTimeout(() => pylBackToLobby(), 4000);
              }
              return;
            }
            const ps = data.players || {};
            const myScore = score;
            const opId = Object.keys(ps).find(k => k !== window._pylPlayerId);

            // Check if opponent disconnected
            if (opId && ps[opId] && ps[opId].online === false && ps[opId].score == null) {
              if (!_pylDisconnectHandled) {
                _pylDisconnectHandled = true;
                pylGameActive = false;
                if (pylRoomUnsub) { pylRoomUnsub(); pylRoomUnsub = null; }
                const pot = pylWagerAmount * 2;
                balance += pot;
                updateBalDisplay();
                showToast('âš”ï¸ Opponent disconnected â€” YOU WIN! +$' + pot.toLocaleString() + '!');
                playWinSound();
                document.getElementById('pylScoreDisplay').innerHTML =
                  '<span style="color:var(--green);">âš”ï¸ OPPONENT DISCONNECTED</span> â€” You win $' + pot.toLocaleString() + '!';
                document.getElementById('pylOpponentScore').textContent = 'DISCONNECTED';
                firebaseSave();
                setTimeout(() => { if (window._pylDeleteRoom) window._pylDeleteRoom(pylRoomCode); pylRoomCode = null; }, 4000);
              }
              return;
            }

            if (opId && ps[opId] && ps[opId].score != null) {
              const opScore = ps[opId].score;
              document.getElementById('pylOpponentScore').textContent = opScore + ' pts';

              if (pylRoomUnsub) { pylRoomUnsub(); pylRoomUnsub = null; }

              const pot = pylWagerAmount * 2;
              if (myScore > opScore) {
                balance += pot;
                updateBalDisplay();
                showToast('ðŸ† YOU WIN! +$' + pot.toLocaleString() + '!');
                playWinSound();
                spawnParticles(window.innerWidth / 2, window.innerHeight / 2, 60);
                document.getElementById('pylScoreDisplay').innerHTML =
                  '<span style="color:var(--green);">ðŸ† YOU WIN!</span> ' + myScore + ' vs ' + opScore + ' â€” +$' + pot.toLocaleString();
              } else if (myScore < opScore) {
                showToast('ðŸ’€ You lost! -$' + pylWagerAmount, false);
                playLoseSound();
                document.getElementById('pylScoreDisplay').innerHTML =
                  '<span style="color:var(--red);">ðŸ’€ YOU LOSE</span> ' + myScore + ' vs ' + opScore;
              } else {
                balance += pylWagerAmount; // refund on tie
                updateBalDisplay();
                showToast('ðŸ¤ Tie! Wager refunded.');
                document.getElementById('pylScoreDisplay').innerHTML =
                  '<span style="color:var(--gold);">ðŸ¤ TIE</span> ' + myScore + ' vs ' + opScore + ' â€” Refunded';
              }

              // Clean up room after a delay
              setTimeout(() => { if (window._pylDeleteRoom) window._pylDeleteRoom(pylRoomCode); pylRoomCode = null; }, 5000);
              firebaseSave();
            }
          });
        };
        checkResult();
      });
    }
  }

  else if (pylCurrentMode === 'highstakes') {
    if (score >= pylHSTarget) {
      const payout = pylWagerAmount * pylHSMultiplier;
      balance += payout;
      updateBalDisplay();
      showToast('ðŸ”¥ HIGH STAKES WIN! +$' + payout.toLocaleString() + '!');
      playWinSound();
      spawnParticles(window.innerWidth / 2, window.innerHeight / 2, 80);
      document.getElementById('pylScoreDisplay').innerHTML =
        '<span style="color:var(--green);">ðŸ”¥ ' + pylHSMultiplier + 'x WIN!</span> ' + score + '/' + pylHSTarget +
        ' pts â€” +$' + payout.toLocaleString();
    } else {
      showToast('ðŸ’€ Didn\'t hit target! -$' + pylWagerAmount, false);
      playLoseSound();
      document.getElementById('pylScoreDisplay').innerHTML =
        '<span style="color:var(--red);">ðŸ’€ MISS</span> ' + score + '/' + pylHSTarget +
        ' pts â€” Lost $' + pylWagerAmount.toLocaleString();
    }
    firebaseSave();
  }

  else if (pylCurrentMode === 'tournament') {
    if (window._pylSubmitLeaderboard) {
      window._pylSubmitLeaderboard(score).then(() => {
        showToast('ðŸ† Score submitted to leaderboard: ' + score + ' pts!');
        pylLoadLeaderboard();
      });
    }
    firebaseSave();
  }
}

let _pylDisconnectHandled = false;

function pylHandleOpponentDisconnect() {
  if (_pylDisconnectHandled || !pylGameActive) return;
  _pylDisconnectHandled = true;

  // Opponent disconnected â€” refund wager, auto-win
  if (pylRoomUnsub) { pylRoomUnsub(); pylRoomUnsub = null; }
  pylGameActive = false;

  const pot = pylWagerAmount * 2;
  balance += pot;
  updateBalDisplay();
  firebaseSave();

  showToast('âš”ï¸ Opponent disconnected â€” YOU WIN! +$' + pot.toLocaleString() + '!');
  playWinSound();
  spawnParticles(window.innerWidth / 2, window.innerHeight / 2, 40);

  document.getElementById('pylScoreDisplay').innerHTML =
    '<span style="color:var(--green);">âš”ï¸ OPPONENT DISCONNECTED</span> â€” You win $' + pot.toLocaleString() + '!';
  document.getElementById('pylOpponentScore').textContent = 'DISCONNECTED';

  // Clean up the room
  if (pylRoomCode && window._pylDeleteRoom) {
    window._pylDeleteRoom(pylRoomCode);
  }

  // Auto return to lobby after 4 seconds
  setTimeout(() => {
    pylBackToLobby();
  }, 4000);
}

function pylEndGame() {
  playClickSound();

  // If 1v1 with no score submitted, forfeit
  if (pylCurrentMode === '1v1' && pylGameActive && pylRoomCode) {
    showToast('Forfeited wager: -$' + pylWagerAmount, false);
    playLoseSound();
    if (window._pylSubmitRoomScore) window._pylSubmitRoomScore(pylRoomCode, 0);
    // Mark ourselves offline so opponent detects the disconnect
    if (window._pylMarkOffline) window._pylMarkOffline(pylRoomCode);
  }

  pylGameActive = false;
  _pylDisconnectHandled = false;
  if (pylRoomUnsub) { pylRoomUnsub(); pylRoomUnsub = null; }
  pylBackToLobby();
}

// ---- LEADERBOARD ----
function pylLoadLeaderboard() {
  const container = document.getElementById('pylLBRows');
  if (!container) return;

  if (window._pylGetLeaderboard) {
    window._pylGetLeaderboard().then(entries => {
      if (entries.length === 0) {
        container.innerHTML = '<div style="color:var(--text2);padding:8px;text-align:center;font-size:12px;">No scores yet. Be the first!</div>';
        return;
      }
      container.innerHTML = entries.map((e, i) => {
        const medal = i === 0 ? 'ðŸ¥‡' : i === 1 ? 'ðŸ¥ˆ' : i === 2 ? 'ðŸ¥‰' : (i + 1) + '.';
        const isMe = e.player === (window._currentUsername || '');
        return '<div class="pyl-lb-row' + (isMe ? ' me' : '') + '">' +
          '<span class="lb-rank">' + medal + '</span>' +
          '<span class="lb-name">' + e.player + (isMe ? ' (you)' : '') + '</span>' +
          '<span class="lb-score">' + e.score.toLocaleString() + ' pts</span>' +
          '</div>';
      }).join('');
    }).catch(() => {
      container.innerHTML = '<div style="color:var(--text2);padding:8px;text-align:center;font-size:12px;">Could not load leaderboard</div>';
    });
  }
}

// ============ STOCKS (Deterministic Time-Based Market) ============
// Prices are deterministic based on real time â€” every 3-second "tick" since
// epoch produces the same price no matter when you compute it. The market
// truly runs 24/7 whether the page is open or not.

// -- Seeded PRNG (Mulberry32) --
function mulberry32(seed) {
  let t = (seed >>> 0) + 0x6D2B79F5;
  t = Math.imul(t ^ (t >>> 15), t | 1);
  t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
  return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
}
function hashTicker(str) {
  let h = 5381;
  for (let i = 0; i < str.length; i++) h = ((h << 5) + h) + str.charCodeAt(i);
  return h >>> 0;
}

const STOCK_DEFS = [
  { ticker: 'GMBL', name: 'Gamble Corp', basePrice: 100, volatility: 0.025, drift: 0.00012 },
];

// Tick epoch: Jan 1 2025 00:00 UTC â€” all ticks counted from here
const TICK_EPOCH = new Date('2025-01-01T00:00:00Z').getTime();
const TICK_MS = 3000; // 3 seconds per tick

function getCurrentTick() {
  return Math.floor((Date.now() - TICK_EPOCH) / TICK_MS);
}

// Get deterministic price change for a stock at a specific tick
function getTickRandom(tickerHash, tickNum) {
  return mulberry32(tickerHash ^ (tickNum * 2654435761));
}

let stockPrices = {};       // ticker -> current price
let stockHoldings = {};     // ticker -> { shares, totalCost }
let stockPriceHistory = {}; // ticker -> [last 100 prices]
let stocksInitialized = false;
let stockTickInterval = null;
let lastComputedTick = 0;   // global: the tick number we've computed up to

function initStocks() {
  if (stocksInitialized) return;
  stocksInitialized = true;

  // Set initial prices = base prices at tick 0
  STOCK_DEFS.forEach(s => {
    if (!stockPrices[s.ticker]) stockPrices[s.ticker] = s.basePrice;
    if (!stockPriceHistory[s.ticker]) stockPriceHistory[s.ticker] = [];
  });

  // If no saved state, compute from tick 0 to now
  if (lastComputedTick === 0) {
    // For fresh start, begin from 200 ticks ago so chart has data
    const now = getCurrentTick();
    lastComputedTick = Math.max(0, now - 500);
    // Reset to base prices for a clean computation
    STOCK_DEFS.forEach(s => { stockPrices[s.ticker] = s.basePrice; });
    advanceToTick(now);
  } else {
    // Advance from saved state to current time
    advanceToTick(getCurrentTick());
  }

  // Live tick every 3 seconds
  startStockTicker();
}

function advanceToTick(targetTick) {
  if (targetTick <= lastComputedTick) return;

  const startTick = lastComputedTick;
  // Record old prices for offline message
  const oldPrices = {};
  STOCK_DEFS.forEach(s => { oldPrices[s.ticker] = stockPrices[s.ticker]; });

  for (let t = startTick + 1; t <= targetTick; t++) {
    STOCK_DEFS.forEach(s => {
      const h = hashTicker(s.ticker);
      const r = getTickRandom(h, t); // deterministic 0..1
      const price = stockPrices[s.ticker];
      const change = price * s.volatility * (r * 2 - 1);
      const reversion = (s.basePrice - price) * 0.0015;
      const driftAmt = price * s.drift;
      let newPrice = price + change + reversion + driftAmt;
      newPrice = Math.max(s.basePrice * 0.05, newPrice); // floor at 5% of base
      stockPrices[s.ticker] = Math.round(newPrice * 10000) / 10000;
    });

    // Record history every ~5 ticks (or always for last 500)
    const remaining = targetTick - t;
    if (remaining < 500 || t % 5 === 0) {
      STOCK_DEFS.forEach(s => {
        const hist = stockPriceHistory[s.ticker];
        hist.push(stockPrices[s.ticker]);
        if (hist.length > 500) hist.shift();
      });
    }
  }

  const ticksAdvanced = targetTick - startTick;
  lastComputedTick = targetTick;

  // Show offline catchup message if significant
  if (ticksAdvanced > 10) {
    const elapsed = ticksAdvanced * TICK_MS;
    const mins = Math.floor(elapsed / 60000);
    const hours = Math.floor(mins / 60);
    const days = Math.floor(hours / 24);
    let timeStr = '';
    if (days > 0) timeStr = days + 'd ' + (hours % 24) + 'h';
    else if (hours > 0) timeStr = hours + 'h ' + (mins % 60) + 'm';
    else timeStr = mins + 'm';

    // Show price changes
    let biggestMove = '', biggestPct = 0;
    STOCK_DEFS.forEach(s => {
      const pct = Math.abs((stockPrices[s.ticker] - oldPrices[s.ticker]) / oldPrices[s.ticker] * 100);
      if (pct > biggestPct) { biggestPct = pct; biggestMove = s.ticker; }
    });
    const moveDir = stockPrices[biggestMove] > oldPrices[biggestMove] ? 'ðŸ“ˆ' : 'ðŸ“‰';
    const msg = moveDir + ' ' + biggestMove + ' moved ' + biggestPct.toFixed(1) + '% while you were away';

    setTimeout(() => { showToast(msg, biggestPct > 0); }, 500);
  }
}

function startStockTicker() {
  if (stockTickInterval) return;
  stockTickInterval = setInterval(() => {
    const now = getCurrentTick();
    if (now > lastComputedTick) {
      advanceToTick(now);
      if (document.querySelector('#stocksPanel.active')) renderStocks();
      // Auto-save periodically to keep tick state fresh
    }
  }, 1000); // check every second for smoother updates
}

function buyStock(ticker) {
  const amt = parseFloat(document.getElementById('stockBuyAmt').value) || 100;
  if (amt > balance) { showToast('Not enough balance!', false); return; }
  if (amt <= 0) return;

  const price = stockPrices[ticker];
  const shares = amt / price;

  balance -= amt;
  updateBalDisplay();

  if (!stockHoldings[ticker]) {
    stockHoldings[ticker] = { shares: 0, totalCost: 0 };
  }
  stockHoldings[ticker].shares += shares;
  stockHoldings[ticker].totalCost += amt;

  playClickSound();
  showToast('Bought ' + shares.toFixed(4) + ' ' + ticker + ' @ $' + formatStockPrice(price));
  renderStocks();
  firebaseSave();
}

function sellStock(ticker) {
  if (!stockHoldings[ticker] || stockHoldings[ticker].shares <= 0) return;

  const holding = stockHoldings[ticker];
  const price = stockPrices[ticker];
  const value = holding.shares * price;
  const profit = value - holding.totalCost;

  balance += value;
  updateBalDisplay();

  if (profit >= 0) {
    showToast('Sold ' + ticker + ' +$' + profit.toFixed(2) + '!');
    playWinSound();
    spawnParticles(window.innerWidth / 2, window.innerHeight / 2, 20 + Math.min(profit / 10, 60));
  } else {
    showToast('Sold ' + ticker + ' -$' + Math.abs(profit).toFixed(2), false);
    playLoseSound();
  }

  delete stockHoldings[ticker];
  renderStocks();
  firebaseSave();
}

function renderStocks() {
  if (!stocksInitialized) initStocks();

  const s = STOCK_DEFS[0]; // single stock
  const price = stockPrices[s.ticker];
  const hist = stockPriceHistory[s.ticker] || [price];
  const prev = hist.length > 1 ? hist[hist.length - 2] : price;
  const isUp = price >= prev;
  const changePct = prev ? ((price - prev) / prev * 100).toFixed(2) : '0.00';
  const holding = stockHoldings[s.ticker];
  const hasHolding = holding && holding.shares > 0;

  // Update hero
  document.getElementById('stockPriceDisplay').textContent = '$' + formatStockPrice(price);
  const changeEl = document.getElementById('stockChangeDisplay');
  // Show change from first recorded price for a bigger number
  const firstPrice = hist[0] || price;
  const totalChangePct = ((price - firstPrice) / firstPrice * 100).toFixed(2);
  const tickChangePct = changePct;
  changeEl.innerHTML = (isUp ? 'â–²' : 'â–¼') + ' ' + tickChangePct + '% <span style="color:#8b949e;font-size:12px;">tick</span> &nbsp; ' +
    (price >= firstPrice ? 'â–²' : 'â–¼') + ' ' + totalChangePct + '% <span style="color:#8b949e;font-size:12px;">session</span>';
  changeEl.className = 'sh-change ' + (isUp ? 'up' : 'down');

  // Update bottom bar
  if (hasHolding) {
    const curVal = holding.shares * price;
    const pnl = curVal - holding.totalCost;
    document.getElementById('stockShares').textContent = holding.shares.toFixed(4);
    document.getElementById('stockValue').textContent = '$' + curVal.toFixed(2);
    const pnlEl = document.getElementById('stockPnl');
    pnlEl.textContent = (pnl >= 0 ? '+' : '') + '$' + pnl.toFixed(2);
    pnlEl.style.color = pnl >= 0 ? '#3fb950' : '#f85149';
  } else {
    document.getElementById('stockShares').textContent = '0';
    document.getElementById('stockValue').textContent = '$0';
    const pnlEl = document.getElementById('stockPnl');
    pnlEl.textContent = '$0';
    pnlEl.style.color = '#8b949e';
  }
  document.getElementById('stockSellBtn').disabled = !hasHolding;

  // Draw the BIG chart
  drawStockChart(hist);
}

function drawStockChart(hist) {
  const canvas = document.getElementById('stockChart');
  const wrap = canvas.parentElement;
  const dpr = window.devicePixelRatio || 1;
  canvas.width = wrap.clientWidth * dpr;
  canvas.height = wrap.clientHeight * dpr;
  canvas.style.width = wrap.clientWidth + 'px';
  canvas.style.height = wrap.clientHeight + 'px';
  const ctx = canvas.getContext('2d');
  ctx.scale(dpr, dpr);
  const W = wrap.clientWidth;
  const H = wrap.clientHeight;

  ctx.clearRect(0, 0, W, H);

  if (hist.length < 2) return;

  const pMin = Math.min(...hist);
  const pMax = Math.max(...hist);
  const pRange = pMax - pMin || 1;
  const pad = { top: 12, bottom: 20, left: 50, right: 12 };
  const cW = W - pad.left - pad.right;
  const cH = H - pad.top - pad.bottom;

  // Grid lines + price labels
  const gridLines = 4;
  ctx.strokeStyle = '#1e2933';
  ctx.lineWidth = 1;
  ctx.fillStyle = '#8b949e';
  ctx.font = '11px Orbitron, monospace';
  ctx.textAlign = 'right';
  for (let i = 0; i <= gridLines; i++) {
    const y = pad.top + (cH / gridLines) * i;
    const priceAtLine = pMax - (pRange / gridLines) * i;
    ctx.beginPath();
    ctx.moveTo(pad.left, y);
    ctx.lineTo(W - pad.right, y);
    ctx.stroke();
    ctx.fillText('$' + formatStockPrice(priceAtLine), pad.left - 6, y + 4);
  }

  // Build points
  const points = [];
  for (let i = 0; i < hist.length; i++) {
    const x = pad.left + (i / (hist.length - 1)) * cW;
    const y = pad.top + (1 - (hist[i] - pMin) / pRange) * cH;
    points.push({ x, y });
  }

  const isUpOverall = hist[hist.length - 1] >= hist[0];
  const lineColor = isUpOverall ? '#3fb950' : '#f85149';
  const fillColor = isUpOverall ? 'rgba(63,185,80,' : 'rgba(248,81,73,';

  // Gradient fill under line
  const grad = ctx.createLinearGradient(0, pad.top, 0, H - pad.bottom);
  grad.addColorStop(0, fillColor + '0.35)');
  grad.addColorStop(1, fillColor + '0.0)');

  ctx.beginPath();
  ctx.moveTo(points[0].x, H - pad.bottom);
  points.forEach(p => ctx.lineTo(p.x, p.y));
  ctx.lineTo(points[points.length - 1].x, H - pad.bottom);
  ctx.closePath();
  ctx.fillStyle = grad;
  ctx.fill();

  // Line
  ctx.beginPath();
  points.forEach((p, i) => i === 0 ? ctx.moveTo(p.x, p.y) : ctx.lineTo(p.x, p.y));
  ctx.strokeStyle = lineColor;
  ctx.lineWidth = 2;
  ctx.lineJoin = 'round';
  ctx.stroke();

  // Current price dot (pulsing)
  const last = points[points.length - 1];
  ctx.beginPath();
  ctx.arc(last.x, last.y, 5, 0, Math.PI * 2);
  ctx.fillStyle = lineColor;
  ctx.fill();
  ctx.beginPath();
  ctx.arc(last.x, last.y, 8, 0, Math.PI * 2);
  ctx.strokeStyle = lineColor;
  ctx.lineWidth = 1.5;
  ctx.globalAlpha = 0.4;
  ctx.stroke();
  ctx.globalAlpha = 1;
}

function formatStockPrice(p) {
  if (p >= 1000) return p.toFixed(0);
  if (p >= 1) return p.toFixed(2);
  return p.toFixed(4);
}

// Save/Load stocks to/from Firebase
window._getStocksData = () => {
  if (!stocksInitialized && Object.keys(stockHoldings).length === 0) return null;
  return {
    prices: stockPrices,
    holdings: stockHoldings,
    lastTick: lastComputedTick // save the tick NUMBER, not timestamp
  };
};

window._loadStocks = (data) => {
  if (!data) return;

  // Restore prices from saved state
  if (data.prices) {
    stockPrices = data.prices;
    STOCK_DEFS.forEach(s => {
      if (!stockPrices[s.ticker]) stockPrices[s.ticker] = s.basePrice;
      stockPriceHistory[s.ticker] = [stockPrices[s.ticker]];
    });
  }

  // Restore holdings
  if (data.holdings) stockHoldings = data.holdings;

  // Restore tick position â€” then advanceToTick will deterministically
  // compute all ticks that happened while offline
  if (data.lastTick) {
    lastComputedTick = data.lastTick;
  }

  stocksInitialized = true;

  // Advance to current real time (deterministic catchup)
  advanceToTick(getCurrentTick());

  // Start live ticker
  startStockTicker();
};

// ============ CARD UTILS ============
const CARD_SUITS=['â™ ','â™¥','â™¦','â™£'];const CARD_RANKS=['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
function newDeck(){let d=[];CARD_SUITS.forEach(s=>CARD_RANKS.forEach(r=>d.push({r,s})));for(let i=d.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[d[i],d[j]]=[d[j],d[i]];}return d;}
function cardNumVal(c){if(c.r==='A')return 11;if('KQJ'.includes(c.r))return 10;return parseInt(c.r);}
function cardIsRed(c){return c.s==='â™¥'||c.s==='â™¦';}
function renderCard(c,hidden){if(hidden)return'<div class="bj-card hidden">?</div>';return'<div class="bj-card'+(cardIsRed(c)?' red':'')+'">'+c.r+'<br>'+c.s+'</div>';}
function cardRankIdx(c){return CARD_RANKS.indexOf(c.r);}

// ============ BLACKJACK ============
let bjDeck=[],bjPlayer=[],bjDealer=[],bjBetAmt=0,bjActive=false;
function bjHandVal(h){let v=0,a=0;h.forEach(c=>{v+=cardNumVal(c);if(c.r==='A')a++;});while(v>21&&a>0){v-=10;a--;}return v;}
function bjDeal(){
  if(bjActive)return;const bet=parseFloat(document.getElementById('bjBet').value)||10;
  if(bet>balance){showToast('Not enough!',false);return;}if(bet<=0)return;
  bjBetAmt=bet;balance-=bet;updateBalDisplay();bjDeck=newDeck();bjPlayer=[bjDeck.pop(),bjDeck.pop()];bjDealer=[bjDeck.pop(),bjDeck.pop()];bjActive=true;bjRender();
  document.getElementById('bjResult').textContent='';
  if(bjHandVal(bjPlayer)===21)bjStand();playClickSound();
}
function bjHit(){if(!bjActive)return;bjPlayer.push(bjDeck.pop());if(bjHandVal(bjPlayer)>21){bjActive=false;bjRender();bjFinish();}else if(bjHandVal(bjPlayer)===21)bjStand();else bjRender();}
function bjStand(){if(!bjActive)return;while(bjHandVal(bjDealer)<17)bjDealer.push(bjDeck.pop());bjActive=false;bjRender();bjFinish();}
function bjDouble(){if(!bjActive||bjPlayer.length!==2)return;if(bjBetAmt>balance){showToast('Not enough!',false);return;}balance-=bjBetAmt;bjBetAmt*=2;updateBalDisplay();bjPlayer.push(bjDeck.pop());while(bjHandVal(bjDealer)<17)bjDealer.push(bjDeck.pop());bjActive=false;bjRender();bjFinish();}
function bjFinish(){
  const pv=bjHandVal(bjPlayer),dv=bjHandVal(bjDealer);let w=0,msg='';
  if(pv>21){msg='BUST!';showToast('-$'+bjBetAmt.toFixed(2),false);playLoseSound();}
  else if(dv>21||pv>dv){w=bjBetAmt*2;msg='WIN +$'+w.toFixed(2);balance+=w;updateBalDisplay();showToast('+$'+w.toFixed(2));playWinSound();spawnParticles(window.innerWidth/2,window.innerHeight/2,30);}
  else if(pv===dv){w=bjBetAmt;msg='PUSH';balance+=w;updateBalDisplay();showToast('Push');}
  else{msg='LOSE';showToast('-$'+bjBetAmt.toFixed(2),false);playLoseSound();}
  const r=document.getElementById('bjResult');r.textContent=msg;r.style.color=w>bjBetAmt?'var(--green)':w===bjBetAmt?'var(--gold)':'var(--red)';
  recordGame('blackjack',bjBetAmt,w);
}
function bjRender(){const s=!bjActive;document.getElementById('bjDealerCards').innerHTML=bjDealer.map((c,i)=>renderCard(c,!s&&i===1)).join('');document.getElementById('bjPlayerCards').innerHTML=bjPlayer.map(c=>renderCard(c)).join('');document.getElementById('bjDealerScore').textContent=s?bjHandVal(bjDealer):'?';document.getElementById('bjPlayerScore').textContent=bjHandVal(bjPlayer);document.getElementById('bjHitBtn').disabled=!bjActive;document.getElementById('bjStandBtn').disabled=!bjActive;document.getElementById('bjDoubleBtn').disabled=!bjActive||bjPlayer.length!==2;document.getElementById('bjDealBtn').disabled=bjActive;}

// ============ MINES ============
let minesBoard=[],minesRevealed=0,minesBetAmt=0,minesActive=false,minesCount=3;
function minesMultiplier(){const t=25,m=minesCount,r=minesRevealed;if(r===0)return 1;let mult=1;for(let i=0;i<r;i++)mult*=(t-m-i)>0?(t-i)/(t-m-i):t;return Math.round(mult*97)/100;}
function minesStart(){
  if(minesActive)return;const bet=parseFloat(document.getElementById('minesBet').value)||10;minesCount=parseInt(document.getElementById('mineCount').value);
  if(bet>balance){showToast('Not enough!',false);return;}
  minesBetAmt=bet;balance-=bet;updateBalDisplay();minesActive=true;minesRevealed=0;
  minesBoard=Array(25).fill(false);const pos=[];while(pos.length<minesCount){const p=Math.floor(Math.random()*25);if(!pos.includes(p))pos.push(p);}
  pos.forEach(p=>minesBoard[p]=true);minesRenderGrid();
  document.getElementById('minesStartBtn').style.display='none';document.getElementById('minesCashoutBtn').style.display='';
  document.getElementById('minesMultiplier').textContent='1.00Ã—';document.getElementById('minesProfit').textContent='Next: $'+minesBetAmt.toFixed(2);playClickSound();
}
function minesCashout(){if(!minesActive||minesRevealed===0)return;const payout=minesBetAmt*minesMultiplier();balance+=payout;updateBalDisplay();
  showToast('+$'+payout.toFixed(2));playWinSound();spawnParticles(window.innerWidth/2,window.innerHeight/2,30);
  minesActive=false;minesRevealAll();document.getElementById('minesStartBtn').style.display='';document.getElementById('minesCashoutBtn').style.display='none';
  recordGame('mines',minesBetAmt,payout);
}
function minesClick(i){if(!minesActive)return;const cells=document.querySelectorAll('.mine-cell');if(cells[i].classList.contains('revealed'))return;
  if(minesBoard[i]){cells[i].classList.add('revealed','mine');cells[i].textContent='ðŸ’£';minesActive=false;
    showToast('-$'+minesBetAmt.toFixed(2),false);playLoseSound();minesRevealAll();
    document.getElementById('minesStartBtn').style.display='';document.getElementById('minesCashoutBtn').style.display='none';recordGame('mines',minesBetAmt,0);
  }else{cells[i].classList.add('revealed','safe');cells[i].textContent='ðŸ’Ž';minesRevealed++;playSound(600+minesRevealed*40,'sine',.06,.06);
    const m=minesMultiplier();document.getElementById('minesMultiplier').textContent=m.toFixed(2)+'Ã—';
    document.getElementById('minesProfit').textContent='Cash out: $'+(minesBetAmt*m).toFixed(2);if(minesRevealed===25-minesCount)minesCashout();
  }
}
function minesRevealAll(){const cells=document.querySelectorAll('.mine-cell');minesBoard.forEach((isMine,i)=>{if(!cells[i].classList.contains('revealed')){cells[i].classList.add('revealed',isMine?'mine':'safe');cells[i].textContent=isMine?'ðŸ’£':'ðŸ’Ž';}});}
function minesRenderGrid(){const g=document.getElementById('minesGrid');g.innerHTML='';for(let i=0;i<25;i++){const c=document.createElement('div');c.className='mine-cell';c.onclick=(()=>{const idx=i;return()=>minesClick(idx);})();g.appendChild(c);}}

// ============ DICE ============
let diceMode='over';
function diceSetMode(m){diceMode=m;document.getElementById('diceOverBtn').className='dice-mode-btn'+(m==='over'?' active':'');document.getElementById('diceUnderBtn').className='dice-mode-btn'+(m==='under'?' active':'');diceUpdateSlider();}
function diceUpdateSlider(){const v=parseFloat(document.getElementById('diceSlider').value);const chance=diceMode==='over'?(100-v):v;const payout=chance>0?Math.floor(99/chance*100)/100:0;document.getElementById('diceTarget').textContent=v.toFixed(2);document.getElementById('diceChance').textContent=chance.toFixed(2)+'%';document.getElementById('dicePayout').textContent=payout.toFixed(2)+'Ã—';
  const sl=document.getElementById('diceSlider');sl.style.background='linear-gradient(90deg,'+(diceMode==='over'?'var(--red)':'var(--green)')+' 0%,'+(diceMode==='over'?'var(--red)':'var(--green)')+' '+v+'%,'+(diceMode==='over'?'var(--green)':'var(--red)')+' '+v+'%,'+(diceMode==='over'?'var(--green)':'var(--red)')+' 100%)';}
function diceRoll(){const bet=parseFloat(document.getElementById('diceBet').value)||10;if(bet>balance){showToast('Not enough!',false);return;}if(bet<=0)return;
  balance-=bet;updateBalDisplay();const target=parseFloat(document.getElementById('diceSlider').value);const chance=diceMode==='over'?(100-target):target;const payout=chance>0?Math.floor(99/chance*100)/100:0;
  const roll=Math.random()*100;const won=diceMode==='over'?roll>target:roll<target;const display=document.getElementById('diceDisplay');
  display.textContent=roll.toFixed(2);display.style.color=won?'var(--green)':'var(--red)';
  if(won){const w=bet*payout;balance+=w;updateBalDisplay();showToast('+$'+w.toFixed(2));playWinSound();spawnParticles(window.innerWidth/2,window.innerHeight/2,25);recordGame('dice',bet,w);}
  else{showToast('-$'+bet.toFixed(2),false);playLoseSound();recordGame('dice',bet,0);}playClickSound();
}

// ============ TOWER ============
let towerBoard=[],towerRow=0,towerBetAmt=0,towerActive=false,towerCols=3,towerRows=8,towerSafePerRow=2;
function towerMultiplier(){if(towerRow===0)return 1;let m=1;for(let i=0;i<towerRow;i++)m*=towerCols/towerSafePerRow;return Math.round(m*97)/100;}
function towerStart(){
  if(towerActive)return;const bet=parseFloat(document.getElementById('towerBet').value)||10;if(bet>balance){showToast('Not enough!',false);return;}
  const diff=document.getElementById('towerDiff').value;
  if(diff==='easy'){towerCols=4;towerSafePerRow=3;}else if(diff==='medium'){towerCols=3;towerSafePerRow=2;}else if(diff==='hard'){towerCols=4;towerSafePerRow=2;}else{towerCols=4;towerSafePerRow=1;}
  towerBetAmt=bet;balance-=bet;updateBalDisplay();towerActive=true;towerRow=0;towerRows=8;
  towerBoard=[];for(let r=0;r<towerRows;r++){const row=Array(towerCols).fill(true);const traps=towerCols-towerSafePerRow;const trapPos=[];while(trapPos.length<traps){const p=Math.floor(Math.random()*towerCols);if(!trapPos.includes(p))trapPos.push(p);}trapPos.forEach(p=>row[p]=false);towerBoard.push(row);}
  towerRender();document.getElementById('towerStartBtn').style.display='none';document.getElementById('towerCashoutBtn').style.display='';
  document.getElementById('towerInfo').innerHTML='Floor <span style="color:var(--neon)">1</span> â€” Pick a tile!';playClickSound();
}
function towerCashout(){if(!towerActive||towerRow===0)return;const p=towerBetAmt*towerMultiplier();balance+=p;updateBalDisplay();
  showToast('+$'+p.toFixed(2));playWinSound();spawnParticles(window.innerWidth/2,window.innerHeight/2,30);
  towerActive=false;towerRevealAll();document.getElementById('towerStartBtn').style.display='';document.getElementById('towerCashoutBtn').style.display='none';
  document.getElementById('towerInfo').textContent='Cashed out at '+towerMultiplier().toFixed(2)+'Ã— â€” $'+p.toFixed(2);recordGame('tower',towerBetAmt,p);
}
function towerClick(r,c){if(!towerActive||r!==towerRow)return;
  const rowEl=document.querySelectorAll('.tower-row')[towerRows-1-r];
  if(towerBoard[r][c]){towerRow++;rowEl.children[c].classList.add('revealed','safe');rowEl.children[c].textContent='âœ…';
    playSound(400+towerRow*60,'sine',.08,.06);const m=towerMultiplier();
    document.getElementById('towerInfo').innerHTML='Floor <span style="color:var(--neon)">'+(towerRow+1)+'</span> â€” '+m.toFixed(2)+'Ã— ($'+(towerBetAmt*m).toFixed(2)+')';
    if(towerRow>=towerRows)towerCashout();else towerRender();
  }else{rowEl.children[c].classList.add('revealed','trap');rowEl.children[c].textContent='ðŸ’€';
    towerActive=false;showToast('-$'+towerBetAmt.toFixed(2),false);playLoseSound();towerRevealAll();
    document.getElementById('towerStartBtn').style.display='';document.getElementById('towerCashoutBtn').style.display='none';
    document.getElementById('towerInfo').textContent='Hit a trap! Lost $'+towerBetAmt.toFixed(2);recordGame('tower',towerBetAmt,0);
  }
}
function towerRevealAll(){document.querySelectorAll('.tower-row').forEach((row,ri)=>{const actualRow=towerRows-1-ri;[...row.children].forEach((c,ci)=>{if(!c.classList.contains('revealed')){c.classList.add('revealed',towerBoard[actualRow][ci]?'safe':'trap');c.textContent=towerBoard[actualRow][ci]?'âœ…':'ðŸ’€';}});});}
function towerRender(){const g=document.getElementById('towerGrid');g.innerHTML='';for(let r=towerRows-1;r>=0;r--){const row=document.createElement('div');row.className='tower-row';for(let c=0;c<towerCols;c++){const cell=document.createElement('div');cell.className='tower-cell';if(r===towerRow&&towerActive)cell.classList.add('current-row');else if(r>towerRow)cell.classList.add('locked');cell.onclick=(()=>{const rr=r,cc=c;return()=>towerClick(rr,cc);})();row.appendChild(cell);}g.appendChild(row);}}

// ============ COIN FLIP ============
let coinChoice='heads',coinFlipping=false;
function coinSelect(c){coinChoice=c;document.getElementById('coinHeads').className='coin-choice'+(c==='heads'?' selected':'');document.getElementById('coinTails').className='coin-choice'+(c==='tails'?' selected':'');playClickSound();}
function coinFlip(){if(coinFlipping)return;const bet=parseFloat(document.getElementById('coinBet').value)||10;if(bet>balance){showToast('Not enough!',false);return;}
  coinFlipping=true;balance-=bet;updateBalDisplay();document.getElementById('coinFlipBtn').disabled=true;document.getElementById('coinResult').textContent='';
  const coin=document.getElementById('coinDisplay');coin.classList.remove('flip');void coin.offsetWidth;coin.classList.add('flip');playClickSound();
  const result=Math.random()<0.5?'heads':'tails';
  setTimeout(()=>{coin.textContent=result==='heads'?'ðŸ‘‘':'ðŸ¦…';const won=result===coinChoice;
    if(won){const w=bet*1.96;balance+=w;updateBalDisplay();showToast('+$'+w.toFixed(2));playWinSound();spawnParticles(window.innerWidth/2,window.innerHeight/2,25);
      document.getElementById('coinResult').innerHTML='<span style="color:var(--green)">'+result.toUpperCase()+' â€” WIN!</span>';recordGame('coinflip',bet,w);}
    else{showToast('-$'+bet.toFixed(2),false);playLoseSound();document.getElementById('coinResult').innerHTML='<span style="color:var(--red)">'+result.toUpperCase()+' â€” LOSE</span>';recordGame('coinflip',bet,0);}
    coinFlipping=false;document.getElementById('coinFlipBtn').disabled=false;},800);
}

// ============ KENO ============
let kenoSelected=new Set(),kenoPlaying=false;
const KENO_PAYOUTS={1:[0,2.5],2:[0,1,5],3:[0,0,2,25],4:[0,0,1,5,50],5:[0,0,.5,3,15,100],6:[0,0,0,2,5,30,200],7:[0,0,0,1,3,10,50,400],8:[0,0,0,.5,2,8,25,100,500],9:[0,0,0,0,1,5,15,50,200,1000],10:[0,0,0,0,.5,3,10,25,100,500,2000]};
function kenoInit(){const g=document.getElementById('kenoGrid');if(!g)return;g.innerHTML='';for(let i=1;i<=40;i++){const c=document.createElement('div');c.className='keno-num';c.textContent=i;c.onclick=(()=>{const n=i;return()=>kenoToggle(n);})();g.appendChild(c);}}
function kenoToggle(n){if(kenoPlaying)return;const cells=document.querySelectorAll('.keno-num');if(kenoSelected.has(n)){kenoSelected.delete(n);cells[n-1].classList.remove('selected');}else{if(kenoSelected.size>=10){showToast('Max 10!',false);return;}kenoSelected.add(n);cells[n-1].classList.add('selected');}document.getElementById('kenoInfo').textContent=kenoSelected.size+'/10 selected';playClickSound();}
function kenoClear(){if(kenoPlaying)return;kenoSelected.clear();document.querySelectorAll('.keno-num').forEach(c=>{c.className='keno-num';});document.getElementById('kenoInfo').textContent='Pick up to 10 numbers';document.getElementById('kenoResult').textContent='';}
function kenoDraw(){if(kenoPlaying||kenoSelected.size===0)return;const bet=parseFloat(document.getElementById('kenoBet').value)||10;if(bet>balance){showToast('Not enough!',false);return;}
  kenoPlaying=true;balance-=bet;updateBalDisplay();document.getElementById('kenoDrawBtn').disabled=true;
  const drawn=new Set();while(drawn.size<10){drawn.add(Math.floor(Math.random()*40)+1);}
  const cells=document.querySelectorAll('.keno-num');let hits=0;const drawnArr=[...drawn];let idx=0;
  const revealInterval=setInterval(()=>{if(idx>=drawnArr.length){clearInterval(revealInterval);
    const picks=kenoSelected.size;const payTable=KENO_PAYOUTS[picks];const mult=payTable&&payTable[hits]?payTable[hits]:0;const payout=bet*mult;
    cells.forEach((c,i)=>{if(!drawn.has(i+1)&&!kenoSelected.has(i+1))c.classList.add('miss');});
    if(payout>0){balance+=payout;updateBalDisplay();showToast(hits+' hits! +$'+payout.toFixed(2));playWinSound();spawnParticles(window.innerWidth/2,window.innerHeight/2,20+hits*10);
      document.getElementById('kenoResult').innerHTML='<span style="color:var(--green)">'+hits+' HITS â€” '+mult+'Ã— â€” +$'+payout.toFixed(2)+'</span>';}
    else{showToast(hits+' hits â€” no win',false);playLoseSound();document.getElementById('kenoResult').innerHTML='<span style="color:var(--red)">'+hits+' hits â€” no win</span>';}
    recordGame('keno',bet,payout);kenoPlaying=false;document.getElementById('kenoDrawBtn').disabled=false;return;}
    const n=drawnArr[idx];cells[n-1].classList.add('drawn');if(kenoSelected.has(n)){cells[n-1].classList.add('hit');hits++;playSound(600+hits*80,'sine',.06,.06);}else{playSound(300,'sine',.03,.02);}idx++;
  },200);
}

// ============ LIMBO ============
let limboRolling=false;
function limboUpdateInfo(){const t=parseFloat(document.getElementById('limboTarget').value)||2;const chance=Math.min(99,(99/t));document.getElementById('limboPayout').textContent='Win chance: '+chance.toFixed(2)+'% â€” Payout: '+t.toFixed(2)+'Ã—';}
function limboGo(){if(limboRolling)return;const bet=parseFloat(document.getElementById('limboBet').value)||10;const target=parseFloat(document.getElementById('limboTarget').value)||2;
  if(bet>balance){showToast('Not enough!',false);return;}if(target<1.01){showToast('Min target 1.01Ã—',false);return;}
  limboRolling=true;balance-=bet;updateBalDisplay();document.getElementById('limboGoBtn').disabled=true;
  const result=0.99/(1-Math.random());const display=document.getElementById('limboResult');const limboBar=document.getElementById('limboBar');
  let cur=1;const step=Math.max(0.01,(result-1)/20);
  const anim=setInterval(()=>{cur+=step;if(cur>=result){cur=result;clearInterval(anim);
    display.textContent=Math.max(1,result).toFixed(2)+'Ã—';const won=result>=target;
    display.style.color=won?'var(--green)':'var(--red)';
    if(limboBar){const pct=Math.min(100,(result/Math.max(target,2))*100);limboBar.style.width=pct+'%';limboBar.style.background=won?'var(--green)':'var(--red)';limboBar.style.boxShadow=won?'0 0 15px var(--green)':'0 0 15px var(--red)';}
    if(won){const w=bet*target;balance+=w;updateBalDisplay();showToast('+$'+w.toFixed(2));playWinSound();spawnParticles(window.innerWidth/2,window.innerHeight/2,25);recordGame('limbo',bet,w);addResultDot('limboHistory',target.toFixed(1)+'Ã—',true);}
    else{showToast('-$'+bet.toFixed(2),false);playLoseSound();recordGame('limbo',bet,0);addResultDot('limboHistory',result.toFixed(1)+'Ã—',false);}
    limboRolling=false;document.getElementById('limboGoBtn').disabled=false;}
  else{display.textContent=cur.toFixed(2)+'Ã—';display.style.color='var(--neon)';if(limboBar){const pct=Math.min(100,(cur/Math.max(target,2))*100);limboBar.style.width=pct+'%';limboBar.style.background=cur>=target?'var(--green)':'var(--neon)';limboBar.style.transition='width 0.05s';}playSound(400+cur*30,'sine',.02,.015);}},50);
}

// ============ VIDEO POKER ============
let pokerDeckArr=[],pokerHandArr=[],pokerHeld=[],pokerBetAmt=0,pokerPhase='idle';
function pokerDeal(){
  if(pokerPhase==='hold'){pokerDrawCards();return;}
  const bet=parseFloat(document.getElementById('pokerBet').value)||10;if(bet>balance){showToast('Not enough!',false);return;}
  pokerBetAmt=bet;balance-=bet;updateBalDisplay();pokerDeckArr=newDeck();pokerHandArr=[];pokerHeld=Array(5).fill(false);
  for(let i=0;i<5;i++)pokerHandArr.push(pokerDeckArr.pop());pokerPhase='hold';pokerRender();
  document.getElementById('pokerDealBtn').textContent='DRAW';document.getElementById('pokerResult').textContent='Click cards to hold, then DRAW';playClickSound();
}
function pokerDrawCards(){for(let i=0;i<5;i++){if(!pokerHeld[i])pokerHandArr[i]=pokerDeckArr.pop();}pokerPhase='done';pokerRender();
  const result=pokerEvaluate();const mult=result.mult;const payout=pokerBetAmt*mult;
  if(payout>0){balance+=payout;updateBalDisplay();showToast(result.name+' +$'+payout.toFixed(2));playWinSound();spawnParticles(window.innerWidth/2,window.innerHeight/2,20+mult*5);
    document.getElementById('pokerResult').innerHTML='<span style="color:var(--green)">'+result.name+' â€” '+mult+'Ã— â€” +$'+payout.toFixed(2)+'</span>';}
  else{showToast('No win',false);playLoseSound();document.getElementById('pokerResult').innerHTML='<span style="color:var(--red)">No winning hand</span>';}
  recordGame('poker',pokerBetAmt,payout);document.getElementById('pokerDealBtn').textContent='DEAL';pokerPhase='idle';
}
function pokerToggleHold(i){if(pokerPhase!=='hold')return;pokerHeld[i]=!pokerHeld[i];pokerRender();playClickSound();}
function pokerRender(){const h=document.getElementById('pokerHand');h.innerHTML='';pokerHandArr.forEach((c,i)=>{const el=document.createElement('div');el.className='poker-card'+(cardIsRed(c)?' red':'')+(pokerHeld[i]?' held':'');el.innerHTML=c.r+'<div class="card-suit" style="font-size:24px;margin-top:4px;">'+c.s+'</div>'+(pokerHeld[i]?'<div class="held-tag">HELD</div>':'');el.onclick=()=>pokerToggleHold(i);el.style.opacity='0';el.style.transform='translateY(20px) scale(0.8)';el.style.transition='all 0.3s ease '+(i*0.08)+'s';h.appendChild(el);requestAnimationFrame(()=>{el.style.opacity='1';el.style.transform=pokerHeld[i]?'translateY(-10px) scale(1)':'translateY(0) scale(1)';});});}
function pokerEvaluate(){const h=pokerHandArr;const ranks=h.map(c=>cardRankIdx(c)).sort((a,b)=>a-b);const suits=h.map(c=>c.s);
  const isFlush=suits.every(s=>s===suits[0]);const counts={};ranks.forEach(r=>{counts[r]=(counts[r]||0)+1;});const vals=Object.values(counts).sort((a,b)=>b-a);
  const isStraight=(ranks[4]-ranks[0]===4&&new Set(ranks).size===5)||(JSON.stringify(ranks)==='[0,9,10,11,12]');
  const isRoyal=isStraight&&isFlush&&ranks[0]===0&&ranks[1]===9;
  if(isRoyal)return{name:'Royal Flush',mult:250};if(isStraight&&isFlush)return{name:'Straight Flush',mult:50};
  if(vals[0]===4)return{name:'Four of a Kind',mult:25};if(vals[0]===3&&vals[1]===2)return{name:'Full House',mult:9};
  if(isFlush)return{name:'Flush',mult:6};if(isStraight)return{name:'Straight',mult:4};
  if(vals[0]===3)return{name:'Three of a Kind',mult:3};if(vals[0]===2&&vals[1]===2)return{name:'Two Pair',mult:2};
  if(vals[0]===2){const pairRank=parseInt(Object.keys(counts).find(k=>counts[k]===2));if(pairRank>=10||pairRank===0)return{name:'Jacks or Better',mult:1};}
  return{name:'No Win',mult:0};
}
function scratchRevealAll(){if(!scratchActive)return;const cells=document.querySelectorAll('.scratch-cell');let delay=0;cells.forEach((c,i)=>{if(!c.classList.contains('revealed')){setTimeout(()=>scratchReveal(i),delay);delay+=80;}});}

// ============ HORSE RACING ============
const HORSES=[{name:'Thunder',emoji:'ðŸŽ',color:'#ff4444'},{name:'Lightning',emoji:'ðŸ‡',color:'#ffaa00'},{name:'Shadow',emoji:'ðŸ´',color:'#8844ff'},{name:'Spirit',emoji:'ðŸ¦„',color:'#44aaff'},{name:'Blaze',emoji:'ðŸŽ',color:'#44ff44'}];
let horseSelected=-1,horseRacing=false;
function horseInit(){const t=document.getElementById('horseTrack');const b=document.getElementById('horseBets');if(!t||!b)return;t.innerHTML='';b.innerHTML='';
  HORSES.forEach((h,i)=>{t.innerHTML+='<div class="horse-lane"><div class="horse-name" style="color:'+h.color+'">'+h.emoji+' '+h.name+'</div><div class="horse-bar"><div class="horse-progress" id="hp'+i+'" style="width:0%;background:'+h.color+';opacity:.6;"></div><div class="horse-emoji" id="he'+i+'" style="left:0%;">'+h.emoji+'</div></div><div class="horse-odds" id="ho'+i+'"></div></div>';
    b.innerHTML+='<button class="horse-bet" onclick="horseSelect('+i+',this)">'+h.emoji+' '+h.name+'</button>';});horseSetOdds();}
function horseSetOdds(){HORSES.forEach((_,i)=>{const o=(1.5+Math.random()*4).toFixed(1);document.getElementById('ho'+i).textContent=o+'Ã—';document.getElementById('ho'+i).dataset.odds=o;});}
function horseSelect(i,btn){horseSelected=i;document.querySelectorAll('.horse-bet').forEach(b=>b.classList.remove('selected'));if(btn)btn.classList.add('selected');playClickSound();}
function horseRace(){if(horseRacing||horseSelected<0){if(horseSelected<0)showToast('Pick a horse!',false);return;}
  const bet=parseFloat(document.getElementById('horseBet').value)||10;if(bet>balance){showToast('Not enough!',false);return;}
  horseRacing=true;balance-=bet;updateBalDisplay();document.getElementById('horseRaceBtn').disabled=true;document.getElementById('horseResult').textContent='';
  const progress=HORSES.map(()=>0);playClickSound();
  const raceInterval=setInterval(()=>{let winner=-1;HORSES.forEach((_,i)=>{progress[i]+=Math.random()*3+0.5;if(progress[i]>=100){progress[i]=100;if(winner<0)winner=i;}
    document.getElementById('hp'+i).style.width=progress[i]+'%';document.getElementById('he'+i).style.left=Math.min(progress[i],95)+'%';});
    if(winner>=0){clearInterval(raceInterval);horseRacing=false;document.getElementById('horseRaceBtn').disabled=false;
      const odds=parseFloat(document.getElementById('ho'+horseSelected).dataset.odds);
      if(winner===horseSelected){const w=bet*odds;balance+=w;updateBalDisplay();showToast(HORSES[winner].emoji+' '+HORSES[winner].name+' wins! +$'+w.toFixed(2));playWinSound();
        spawnParticles(window.innerWidth/2,window.innerHeight/2,40);document.getElementById('horseResult').innerHTML='<span style="color:var(--green)">'+HORSES[winner].name+' WINS! +$'+w.toFixed(2)+'</span>';recordGame('horses',bet,w);}
      else{showToast(HORSES[winner].name+' wins',false);playLoseSound();document.getElementById('horseResult').innerHTML='<span style="color:var(--red)">'+HORSES[winner].name+' wins</span>';recordGame('horses',bet,0);}
      setTimeout(()=>{HORSES.forEach((_,i)=>{document.getElementById('hp'+i).style.width='0%';document.getElementById('he'+i).style.left='0%';});horseSetOdds();},2000);}
  },60);
}

// ============ SCRATCH CARDS ============
const SCRATCH_TIERS=[{name:'Basic',price:5,symbols:['ðŸ’','ðŸ‹','ðŸ””','ðŸ’Ž','7ï¸âƒ£','â­'],maxWin:50},{name:'Silver',price:25,symbols:['ðŸ’Ž','7ï¸âƒ£','â­','ðŸ‘‘','ðŸ’°','ðŸ†'],maxWin:500},{name:'Gold',price:100,symbols:['ðŸ‘‘','ðŸ’°','ðŸ†','ðŸ’Ž','ðŸ”¥','ðŸŒŸ'],maxWin:5000},{name:'Diamond',price:500,symbols:['ðŸ’Ž','ðŸ‘‘','ðŸ”¥','ðŸŒŸ','ðŸ’€','ðŸŒ€'],maxWin:50000}];
let scratchTier=0,scratchCells=[],scratchRevealed=0,scratchActive=false;
function scratchSelectTier(t,btn){scratchTier=t;document.querySelectorAll('.scratch-tier').forEach(b=>b.classList.remove('selected'));if(btn)btn.classList.add('selected');document.getElementById('scratchBuyBtn').textContent='BUY CARD â€” $'+SCRATCH_TIERS[t].price;playClickSound();}
function scratchBuy(){if(scratchActive)return;const tier=SCRATCH_TIERS[scratchTier];if(tier.price>balance){showToast('Not enough!',false);return;}
  balance-=tier.price;updateBalDisplay();scratchActive=true;scratchRevealed=0;scratchCells=[];
  const winSym=tier.symbols[Math.floor(Math.random()*tier.symbols.length)];
  const r=Math.random();let winCount=0;if(r<0.25)winCount=3;else if(r<0.35)winCount=2;
  for(let i=0;i<9;i++){if(i<winCount)scratchCells.push(winSym);else scratchCells.push(tier.symbols[Math.floor(Math.random()*tier.symbols.length)]);}
  for(let i=scratchCells.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[scratchCells[i],scratchCells[j]]=[scratchCells[j],scratchCells[i]];}
  document.getElementById('scratchResult').textContent='';const g=document.getElementById('scratchGrid');g.innerHTML='';
  scratchCells.forEach((_,i)=>{const c=document.createElement('div');c.className='scratch-cell';c.textContent='?';c.onclick=()=>scratchReveal(i);g.appendChild(c);});document.getElementById('scratchRevealAllBtn').style.display='inline-block';playClickSound();
}
function scratchReveal(i){if(!scratchActive)return;const cells=document.querySelectorAll('.scratch-cell');if(cells[i].classList.contains('revealed'))return;
  cells[i].classList.add('revealed');cells[i].textContent=scratchCells[i];scratchRevealed++;playSound(500+Math.random()*200,'sine',.04,.03);
  if(scratchRevealed===9){scratchActive=false;document.getElementById('scratchRevealAllBtn').style.display='none';const tier=SCRATCH_TIERS[scratchTier];const counts={};scratchCells.forEach(s=>{counts[s]=(counts[s]||0)+1;});
    let maxC=0;Object.values(counts).forEach(c=>{if(c>maxC)maxC=c;});let payout=0;
    if(maxC>=3){payout=tier.price*(maxC===3?3:maxC===4?10:50);payout=Math.min(payout,tier.maxWin);}
    if(payout>0){balance+=payout;updateBalDisplay();showToast(maxC+' matches! +$'+payout.toFixed(2));playWinSound();spawnParticles(window.innerWidth/2,window.innerHeight/2,30);
      document.getElementById('scratchResult').innerHTML='<span style="color:var(--green)">'+maxC+' MATCHES â€” +$'+payout+'!</span>';recordGame('scratch',tier.price,payout);}
    else{showToast('No matches',false);playLoseSound();document.getElementById('scratchResult').innerHTML='<span style="color:var(--red)">No matches</span>';recordGame('scratch',tier.price,0);}
  }
}

// ============ WHEEL OF FORTUNE ============
const WHEEL_SEGMENTS=[{label:'0Ã—',mult:0,color:'#333',weight:3},{label:'0.5Ã—',mult:0.5,color:'#444',weight:5},{label:'1Ã—',mult:1,color:'#555',weight:6},{label:'1.5Ã—',mult:1.5,color:'#1a5a1a',weight:5},{label:'2Ã—',mult:2,color:'#2a7a2a',weight:4},{label:'3Ã—',mult:3,color:'#1a1a8e',weight:3},{label:'5Ã—',mult:5,color:'#6b2fd9',weight:2},{label:'10Ã—',mult:10,color:'#cc2233',weight:1},{label:'50Ã—',mult:50,color:'#ffd700',weight:0.3}];
let wheelAngle=0,wheelSpinning=false,wheelDrawn=false;
function drawWheel(angle){wheelDrawn=true;const c=document.getElementById('wheelCanvas');if(!c)return;const ctx=c.getContext('2d');const cx=c.width/2,cy=c.height/2,r=c.width/2-8;ctx.clearRect(0,0,c.width,c.height);
  const totalW=WHEEL_SEGMENTS.reduce((s,seg)=>s+seg.weight,0);let curAngle=angle;
  WHEEL_SEGMENTS.forEach(seg=>{const sliceAngle=(seg.weight/totalW)*Math.PI*2;ctx.beginPath();ctx.moveTo(cx,cy);ctx.arc(cx,cy,r,curAngle,curAngle+sliceAngle);ctx.closePath();ctx.fillStyle=seg.color;ctx.fill();ctx.strokeStyle='rgba(255,255,255,.15)';ctx.lineWidth=2;ctx.stroke();
    const ta=curAngle+sliceAngle/2;const tx=cx+Math.cos(ta)*(r*.7);const ty=cy+Math.sin(ta)*(r*.7);ctx.save();ctx.translate(tx,ty);ctx.rotate(ta+Math.PI/2);ctx.fillStyle='#fff';ctx.font='bold 13px Orbitron';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(seg.label,0,0);ctx.restore();curAngle+=sliceAngle;});
  ctx.beginPath();ctx.arc(cx,cy,r*.12,0,Math.PI*2);ctx.fillStyle='#1a1a3e';ctx.fill();ctx.strokeStyle='rgba(255,215,0,.4)';ctx.lineWidth=2;ctx.stroke();
  ctx.beginPath();ctx.arc(cx,cy,r+2,0,Math.PI*2);ctx.strokeStyle='rgba(255,215,0,.2)';ctx.lineWidth=4;ctx.stroke();
}
function wheelSpin(){if(wheelSpinning)return;const bet=parseFloat(document.getElementById('wheelBet').value)||10;if(bet>balance){showToast('Not enough!',false);return;}
  wheelSpinning=true;balance-=bet;updateBalDisplay();document.getElementById('wheelSpinBtn').disabled=true;document.getElementById('wheelResult').textContent='';playClickSound();
  const totalW=WHEEL_SEGMENTS.reduce((s,seg)=>s+seg.weight,0);let rnd=Math.random()*totalW,winIdx=0;
  for(let i=0;i<WHEEL_SEGMENTS.length;i++){rnd-=WHEEL_SEGMENTS[i].weight;if(rnd<=0){winIdx=i;break;}}const seg=WHEEL_SEGMENTS[winIdx];
  let cumAngle=0;for(let i=0;i<winIdx;i++){cumAngle+=(WHEEL_SEGMENTS[i].weight/totalW)*Math.PI*2;}cumAngle+=(seg.weight/totalW)*Math.PI;
  const targetAngle=-Math.PI/2-cumAngle+Math.PI*2*(5+Math.random()*3);const startAngle=wheelAngle;const totalRot=targetAngle-startAngle;
  const dur=3500;const st=performance.now();
  let lastTickAngle=startAngle;const tickSize=(WHEEL_SEGMENTS[0].weight/totalW)*Math.PI*2;
  function anim(now){const elapsed=now-st;const prog=Math.min(elapsed/dur,1);const eased=1-Math.pow(1-prog,4);const cur=startAngle+totalRot*eased;drawWheel(cur);
    if(Math.abs(cur-lastTickAngle)>tickSize){lastTickAngle=cur;playSound(600+Math.random()*200,'sine',.015,.01);}
    if(prog<1)requestAnimationFrame(anim);
    else{wheelAngle=cur%(Math.PI*2);wheelSpinning=false;document.getElementById('wheelSpinBtn').disabled=false;
      const payout=bet*seg.mult;
      if(payout>0){balance+=payout;updateBalDisplay();showToast(seg.label+' +$'+payout.toFixed(2));if(seg.mult>=2)playWinSound();else playClickSound();
        if(seg.mult>=5)spawnParticles(window.innerWidth/2,window.innerHeight/2,30+seg.mult*5);
        document.getElementById('wheelResult').innerHTML='<span style="color:var(--green)">'+seg.label+' â€” +$'+payout.toFixed(2)+'</span>';recordGame('wheel',bet,payout);}
      else{showToast(seg.label,false);playLoseSound();document.getElementById('wheelResult').innerHTML='<span style="color:var(--red)">'+seg.label+'</span>';recordGame('wheel',bet,0);}
    }
  }requestAnimationFrame(anim);
}

// ============ BACCARAT ============
let baccBetType=null;
function baccSelect(type,btn){baccBetType=type;document.querySelectorAll('.bacc-bet').forEach(b=>b.classList.remove('selected'));if(btn)btn.classList.add('selected');playClickSound();}
function baccCardVal(c){const v=cardNumVal(c);return v>=10?0:v===11?1:v;}
function baccHandTotal(hand){return hand.reduce((s,c)=>s+baccCardVal(c),0)%10;}
function baccDeal(){if(!baccBetType){showToast('Select bet!',false);return;}const bet=parseFloat(document.getElementById('baccBet').value)||10;if(bet>balance){showToast('Not enough!',false);return;}
  balance-=bet;updateBalDisplay();const deck=newDeck();const player=[deck.pop(),deck.pop()],banker=[deck.pop(),deck.pop()];
  let pScore=baccHandTotal(player),bScore=baccHandTotal(banker);
  if(pScore<8&&bScore<8){let pThird=null;
    if(pScore<=5){pThird=deck.pop();player.push(pThird);pScore=baccHandTotal(player);}
    if(!pThird){if(bScore<=5)banker.push(deck.pop());}
    else{const pTV=baccCardVal(pThird);
      if(bScore<=2)banker.push(deck.pop());
      else if(bScore===3&&pTV!==8)banker.push(deck.pop());
      else if(bScore===4&&[2,3,4,5,6,7].includes(pTV))banker.push(deck.pop());
      else if(bScore===5&&[4,5,6,7].includes(pTV))banker.push(deck.pop());
      else if(bScore===6&&[6,7].includes(pTV))banker.push(deck.pop());
    }
  }
  pScore=baccHandTotal(player);bScore=baccHandTotal(banker);
  document.getElementById('baccPlayerCards').innerHTML='';
  document.getElementById('baccBankerCards').innerHTML='';
  document.getElementById('baccPlayerScore').textContent='?';
  document.getElementById('baccBankerScore').textContent='?';
  document.getElementById('baccResult').innerHTML='<span style="color:var(--text2)">Dealing...</span>';
  const allCards=[];
  allCards.push({side:'player',card:player[0]});allCards.push({side:'banker',card:banker[0]});
  allCards.push({side:'player',card:player[1]});allCards.push({side:'banker',card:banker[1]});
  if(player.length>2)allCards.push({side:'player',card:player[2]});
  if(banker.length>2)allCards.push({side:'banker',card:banker[2]});
  let ci=0;
  const dealInterval=setInterval(()=>{
    if(ci>=allCards.length){clearInterval(dealInterval);
      document.getElementById('baccPlayerScore').textContent=pScore;
      document.getElementById('baccBankerScore').textContent=bScore;
      let winner=pScore>bScore?'player':bScore>pScore?'banker':'tie';let payout=0;
      if(winner===baccBetType){if(baccBetType==='player')payout=bet*2;else if(baccBetType==='banker')payout=bet*1.95;else payout=bet*8;}
      else if(winner==='tie'&&baccBetType!=='tie'){payout=bet;}
      setTimeout(()=>{
        if(payout>bet){balance+=payout;updateBalDisplay();showToast((winner==='tie'?'TIE':winner.toUpperCase())+' +$'+(payout-bet).toFixed(2));playWinSound();
          spawnParticles(window.innerWidth/2,window.innerHeight/2,25);document.getElementById('baccResult').innerHTML='<span style="color:var(--green)">'+winner.toUpperCase()+' WINS! +$'+payout.toFixed(2)+'</span>';recordGame('baccarat',bet,payout);addResultDot('baccHistory',winner[0].toUpperCase(),true);}
        else if(payout===bet){balance+=payout;updateBalDisplay();showToast('Push');document.getElementById('baccResult').innerHTML='<span style="color:var(--gold)">PUSH</span>';recordGame('baccarat',bet,bet);addResultDot('baccHistory','T',true);}
        else{showToast('-$'+bet.toFixed(2),false);playLoseSound();document.getElementById('baccResult').innerHTML='<span style="color:var(--red)">'+winner.toUpperCase()+' WINS</span>';recordGame('baccarat',bet,0);addResultDot('baccHistory',winner[0].toUpperCase(),false);}
      },400);
      return;
    }
    const {side,card}=allCards[ci];
    const container=document.getElementById(side==='player'?'baccPlayerCards':'baccBankerCards');
    const el=document.createElement('div');el.innerHTML=renderCard(card);const cardEl=el.firstChild;
    cardEl.style.opacity='0';cardEl.style.transform='translateY(-20px)';cardEl.style.transition='all 0.3s ease';
    container.appendChild(cardEl);
    requestAnimationFrame(()=>{cardEl.style.opacity='1';cardEl.style.transform='translateY(0)';});
    playSound(300+ci*80,'sine',.03,.02);ci++;
  },450);
  playClickSound();
}

// ============ HILO ============
let hiloDeck=[],hiloCard=null,hiloStreakCount=0,hiloBetAmt=0,hiloActive=false;
function hiloMultiplier(){if(hiloStreakCount===0)return 1;let m=1;for(let i=0;i<hiloStreakCount;i++)m*=1.88;return Math.round(m*100)/100;}
function hiloStart(){if(hiloActive)return;const bet=parseFloat(document.getElementById('hiloBet').value)||10;if(bet>balance){showToast('Not enough!',false);return;}
  hiloBetAmt=bet;balance-=bet;updateBalDisplay();hiloActive=true;hiloStreakCount=0;hiloDeck=newDeck();hiloCard=hiloDeck.pop();hiloRender();
  document.getElementById('hiloStartBtn').style.display='none';document.getElementById('hiloCashoutBtn').style.display='';playClickSound();
}
function hiloCashout(){if(!hiloActive||hiloStreakCount===0)return;const p=hiloBetAmt*hiloMultiplier();balance+=p;updateBalDisplay();
  showToast('+$'+p.toFixed(2));playWinSound();spawnParticles(window.innerWidth/2,window.innerHeight/2,25);hiloActive=false;
  document.getElementById('hiloStartBtn').style.display='';document.getElementById('hiloCashoutBtn').style.display='none';
  document.getElementById('hiloStreak').textContent='Cashed out '+hiloMultiplier().toFixed(2)+'Ã— â€” $'+p.toFixed(2);recordGame('hilo',hiloBetAmt,p);
}
function hiloGuess(guess){if(!hiloActive)return;if(hiloDeck.length<2)hiloDeck=newDeck();
  const next=hiloDeck.pop();const curRank=cardRankIdx(hiloCard),nextRank=cardRankIdx(next);
  let correct=false;
  if(guess==='higher')correct=nextRank>curRank;else if(guess==='lower')correct=nextRank<curRank;else correct=nextRank===curRank;
  hiloCard=next;
  if(correct){hiloStreakCount++;playSound(500+hiloStreakCount*60,'sine',.08,.06);hiloRender();}
  else{hiloActive=false;hiloRender();showToast('-$'+hiloBetAmt.toFixed(2),false);playLoseSound();
    document.getElementById('hiloStartBtn').style.display='';document.getElementById('hiloCashoutBtn').style.display='none';
    document.getElementById('hiloStreak').innerHTML='<span style="color:var(--red)">WRONG!</span> Card was '+next.r+next.s;recordGame('hilo',hiloBetAmt,0);
  }
}
function hiloRender(){const c=hiloCard;document.getElementById('hiloCard').className='hilo-card'+(cardIsRed(c)?' red':'');document.getElementById('hiloCard').innerHTML=c.r+'<br>'+c.s;
  document.getElementById('hiloHigherBtn').disabled=!hiloActive;document.getElementById('hiloLowerBtn').disabled=!hiloActive;document.getElementById('hiloSkipBtn').disabled=!hiloActive;
  if(hiloActive){const m=hiloMultiplier();document.getElementById('hiloStreak').textContent='Streak: '+hiloStreakCount+' â€” '+m.toFixed(2)+'Ã—';
    document.getElementById('hiloCashout').textContent=hiloStreakCount>0?'Cash out: $'+(hiloBetAmt*m).toFixed(2):'';}
}

// ============ INIT ============
window.addEventListener('load',()=>{
  initSlots();
  initCases();
  resizeCrashCanvas();
  initStocks();
  minesRenderGrid();
  diceUpdateSlider();
  kenoInit();
  horseInit();
  drawWheel(0);
  document.getElementById('limboTarget').addEventListener('input',limboUpdateInfo);
  window.addEventListener('resize',()=>{resizeCrashCanvas();resizeParticles();});
  setInterval(firebaseSave,30000);
});

// Save on page close/refresh
window.addEventListener('beforeunload',()=>{ firebaseSave(); });
window.addEventListener('visibilitychange',()=>{ if(document.hidden) firebaseSave(); });

// Handle keyboard shortcuts
document.addEventListener('keydown',e=>{
  if(e.code==='Space'){
    e.preventDefault();
    const panel=document.querySelector('.game-panel.active');
    if(panel.id==='slotsPanel')spinSlots();
    else if(panel.id==='crashPanel'){if(crashRunning)cashOut();else startCrash();}
    else if(panel.id==='roulettePanel')spinRoulette();
    else if(panel.id==='casesPanel')openCase();
    else if(panel.id==='plinkoPanel')dropPlinkoBall();
    else if(panel.id==='blackjackPanel'){if(bjActive)bjHit();else bjDeal();}
    else if(panel.id==='minesPanel'){if(minesActive)minesCashout();else minesStart();}
    else if(panel.id==='dicePanel')diceRoll();
    else if(panel.id==='towerPanel'){if(towerActive)towerCashout();else towerStart();}
    else if(panel.id==='coinflipPanel')coinFlip();
    else if(panel.id==='kenoPanel')kenoDraw();
    else if(panel.id==='limboPanel')limboGo();
    else if(panel.id==='pokerPanel')pokerDeal();
    else if(panel.id==='horsesPanel')horseRace();
    else if(panel.id==='wheelPanel')wheelSpin();
    else if(panel.id==='baccaratPanel')baccDeal();
    else if(panel.id==='hiloPanel'){if(hiloActive)hiloCashout();else hiloStart();}
  }
});
</script>
</body>
</html>
